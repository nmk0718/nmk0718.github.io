<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>kk&#39;s Blog</title>
  
  
  <link href="https://nmk0718.github.io/atom.xml" rel="self"/>
  
  <link href="https://nmk0718.github.io/"/>
  <updated>2025-03-03T09:44:19.545Z</updated>
  <id>https://nmk0718.github.io/</id>
  
  <author>
    <name>kk</name>
    
  </author>
  
  <follow_challenge>
    <feedId>111612695395408896</feedId>
    <userId>110199199215347712</userId>
  </follow_challenge>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>è·å–å®¢æˆ·ç«¯çœŸå®IP</title>
    <link href="https://nmk0718.github.io/2025/02/27/%E8%8E%B7%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9C%9F%E5%AE%9EIP/"/>
    <id>https://nmk0718.github.io/2025/02/27/%E8%8E%B7%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9C%9F%E5%AE%9EIP/</id>
    <published>2025-02-27T09:32:00.000Z</published>
    <updated>2025-03-03T09:44:19.545Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨è®¿é—®ç½‘ç«™æ—¶ï¼Œä¼šæœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼è®¿é—®åˆ°å®é™…çš„åç«¯æœåŠ¡ï¼Œå¯å¿½ç•¥WAFï¼Œæœ¬æ–‡ä¸»è¦è®²è§£å¦‚ä½•æŠŠçœŸå®IPè½¬å‘ç»™åç«¯</p><ul><li>DNS &gt; WAF &gt; CLB &gt; Ingress &gt; backend-service</li><li>DNS &gt; WAF &gt; CLB &gt; Nginx &gt; backend-service</li><li>DNS &gt; WAF &gt; CLB &gt; backend-service</li></ul><h4 id="Nginx-Ingress"><a href="#Nginx-Ingress" class="headerlink" title="Nginx Ingress"></a>Nginx Ingress</h4><p>åœ¨ Kubernetes ä¸­ï¼Œåº”ç”¨é€šè¿‡ Nginx Ingress æ¥æ”¶è¯·æ±‚ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼å¯ä»¥è·å–åˆ°å®¢æˆ·ç«¯çš„çœŸå® IP</p><ol><li><p>ä¿®æ”¹ Nginx Ingress çš„ ConfigMap</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-configuration</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">use-forwarded-headers:</span> <span class="string">"true"</span>  <span class="comment"># å¯ç”¨ use-forwarded-headers</span></span><br><span class="line">  <span class="attr">compute-full-forwarded-for:</span> <span class="string">"true"</span>  <span class="comment"># å¯ç”¨ compute-full-forwarded-for</span></span><br></pre></td></tr></table></figure><p>è¯¦è§£ï¼š<br><code>use-forwarded-headers</code>ï¼šNginx Ingress ä¼šä¿¡ä»» X-Forwarded-For å’Œ X-Forwarded-Proto å¤´éƒ¨ï¼Œå°†å®ƒä»¬ä¼ é€’ç»™åç«¯æœåŠ¡ã€‚<br><code>compute-full-forwarded-for</code>ï¼šNginx Ingress ä¼šå°†å®¢æˆ·ç«¯çš„çœŸå® IP ä¿¡æ¯å®Œæ•´åœ°è®°å½•åœ¨ X-Forwarded-For å¤´éƒ¨ä¸­ã€‚</p><image src="https://qcloudimg.tencent-cloud.cn/image/document/7d017fe973aec9ad1f75659a3784db4e.jpeg"></image></li><li><p>é€šè¿‡ Service èµ„æºçš„é…ç½®é€‰é¡¹ä¿ç•™å®¢æˆ·ç«¯æº IP<br>ä¿®æ”¹Nginx Ingress Controller çš„ Service</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">externalTrafficPolicy:</span> <span class="string">Local</span></span><br></pre></td></tr></table></figure><p>è¯¦è§£<br><code>Cluster</code>ï¼šè¡¨ç¤ºéšè—å®¢æˆ·ç«¯æº IPï¼ŒLoadBalancer å’Œ NodePort ç±»å‹æœåŠ¡æµé‡å¯èƒ½ä¼šè¢«è½¬å‘åˆ°å…¶ä»–èŠ‚ç‚¹çš„ Podsã€‚<br><code>Local</code>ï¼šè¡¨ç¤ºä¿ç•™å®¢æˆ·ç«¯æº IP å¹¶é¿å… LoadBalancer å’Œ NodePort ç±»å‹çš„æœåŠ¡æµé‡è½¬å‘åˆ°å…¶ä»–èŠ‚ç‚¹çš„ Podsã€‚<br>âš ï¸Localçš„ç¼ºç‚¹ï¼šä¼šå­˜åœ¨æ½œåœ¨çš„ Podsï¼ˆEndpointsï¼‰æµé‡è´Ÿè½½ä¸å‡è¡¡é£é™©ã€‚<br><a href="https://kubernetes.io/zh/docs/tasks/access-application-cluster/create-external-load-balancer/" target="_blank" rel="noopener">https://kubernetes.io/zh/docs/tasks/access-application-cluster/create-external-load-balancer/</a></p><p>é…ç½®ç”Ÿæ•ˆåï¼Œåœ¨åç«¯è·å– HTTP Header ä¸­çš„ X-Forwarded-For æˆ– X-Real-IP å­—æ®µå€¼å¾—åˆ°å®¢æˆ·ç«¯çœŸå®æº IPã€‚</p></li></ol><image src="https://qcloudimg.tencent-cloud.cn/image/document/302d5e26fc4a6d492a232b36d7034870.jpeg"><h4 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h4><p>å¢åŠ http_realip_moduleæ¨¡å—ï¼Œé‡æ–°ç¼–è¯‘nginx</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> nginx-1.17.0</span><br><span class="line">./configure --prefix=/path/server/nginx --with-http_realip_module</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><p>vi /etc/nginx/nginx.conf</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">log_format</span> main <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></span><br><span class="line">                <span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line">                <span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#è‹¥ä»£ç†çš„å›æºIPæ¯”è¾ƒåˆ†æ•£ï¼Œæˆ–ä¸æ¸…æ¥šä»£ç†å›æºIPæ—¶ï¼Œå¯ä»¥å†™æˆ0.0.0.0/0ï¼Œä»£è¡¨æ‰€æœ‰è¯·æ±‚éƒ½ä»XFFä¸­è·å–æºIP</span></span><br><span class="line">    <span class="attribute">set_real_ip_from</span> <span class="number">10.0.0.0</span>/<span class="number">8</span>;  <span class="comment"># å‡è®¾ CLB çš„ IP æ®µæ˜¯ 10.0.0.0/8</span></span><br><span class="line">    <span class="attribute">real_ip_recursive</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">real_ip_header</span> X-Forwarded-For;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span> your_domain;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> / &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">            <span class="comment">#æŠŠX-Forwarded-For å’Œ X-Real-IP å­—æ®µè½¬å‘ç»™åç«¯</span></span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="CLB"><a href="#CLB" class="headerlink" title="CLB"></a>CLB</h4><p>ä½¿ç”¨äº‘å¹³å°ä¸­çš„ CLB ç›´é€š Pod çš„è½¬å‘åŠŸèƒ½ï¼ˆCLB é€ä¼ è½¬å‘ï¼Œå¹¶ç»•è¿‡ Kubernetes Service æµé‡è½¬å‘ï¼‰ï¼Œåç«¯ Pods æ”¶åˆ°çš„è¯·æ±‚çš„æº IP å³ä¸ºå®¢æˆ·ç«¯çœŸå®æº IP<br>æ­¤æ–¹å¼é€‚ç”¨äºå››å±‚åŠä¸ƒå±‚æœåŠ¡çš„è½¬å‘åœºæ™¯<br><image src="https://qcloudimg.tencent-cloud.cn/image/document/99f01ebf33d7a1ca525b9695395d7f8a.jpeg"></image></p><p><del>åºŸå¼ƒæ–¹æ¡ˆ,ä½¿ç”¨åä¸ç”Ÿæ•ˆ</del></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress</span><br><span class="line">  annotations:</span><br><span class="line">    # å¯ç”¨ X-Forwarded-* è¯·æ±‚å¤´çš„å¤„ç†</span><br><span class="line">    nginx.ingress.kubernetes.io/use-forwarded-headers: &quot;true&quot;</span><br><span class="line">    # æŒ‡å®šä» X-Forwarded-For è¯·æ±‚å¤´ä¸­è·å–çœŸå® IP</span><br><span class="line">    nginx.ingress.kubernetes.io/real-ip-header: &quot;X-Forwarded-For&quot;</span><br><span class="line">    # å°†è¯·æ±‚å¤´ä¸­çš„ IP è®¾ç½®ä¸ºå®¢æˆ·ç«¯çš„çœŸå® IP</span><br><span class="line">    nginx.ingress.kubernetes.io/set-real-ip-header: &quot;true&quot;</span><br></pre></td></tr></table></figure><h4 id="è¸©å‘è®°å½•ï¼š"><a href="#è¸©å‘è®°å½•ï¼š" class="headerlink" title="è¸©å‘è®°å½•ï¼š"></a>è¸©å‘è®°å½•ï¼š</h4><p>æŸ¥çœ‹åˆ°log_formatæœ‰å¯ç”¨ï¼Œaccess_log è¢«æ³¨é‡Šæ‰äº†ï¼Œä½†ä»ç„¶æœ‰æ—¥å¿—è¾“å‡ºï¼Œæ—¥å¿—ä¸€ç›´æ‰“å°ä¸å‡ºæ¥çœŸå®IP<br>åŸå› ï¼š<br>Nginx é»˜è®¤ä¼šç”Ÿæˆ access.log æ–‡ä»¶ï¼Œå³ä½¿åœ¨é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰æ˜¾å¼æŒ‡å®š access_log æŒ‡ä»¤ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒNginx ä¼šå°†è®¿é—®æ—¥å¿—å†™å…¥ logs/access.log æ–‡ä»¶ã€‚<br>å¦‚æœä½ åœ¨é…ç½®æ–‡ä»¶ä¸­æ³¨é‡Šæ‰äº† access_log æŒ‡ä»¤ï¼Œä½†æ²¡æœ‰å®Œå…¨ç¦ç”¨æ—¥å¿—è®°å½•ï¼ŒNginx ä»ç„¶ä¼šä½¿ç”¨é»˜è®¤é…ç½®ç”Ÿæˆæ—¥å¿—ã€‚<br>è§£å†³æ–¹æ¡ˆï¼š<br>æŠŠaccess.logå¼€å¯ï¼Œé‡æ–°reloadå³å¯</p><p>å‚è€ƒæ–‡æ¡£ï¼š<br><a href="https://cloud.tencent.com/document/product/214/3728" target="_blank" rel="noopener">https://cloud.tencent.com/document/product/214/3728</a><br><a href="https://cloud.tencent.com/document/product/457/48949" target="_blank" rel="noopener">https://cloud.tencent.com/document/product/457/48949</a></p></image>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;åœ¨è®¿é—®ç½‘ç«™æ—¶ï¼Œä¼šæœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼è®¿é—®åˆ°å®é™…çš„åç«¯æœåŠ¡ï¼Œå¯å¿½ç•¥WAFï¼Œæœ¬æ–‡ä¸»è¦è®²è§£å¦‚ä½•æŠŠçœŸå®IPè½¬å‘ç»™åç«¯&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;DNS &amp;gt; WAF &amp;gt; CLB &amp;gt; Ingress &amp;gt; backend-service&lt;/li&gt;
&lt;li&gt;DNS &amp;gt</summary>
      
    
    
    
    
    <category term="k8s" scheme="https://nmk0718.github.io/tag/k8s/"/>
    
  </entry>
  
  <entry>
    <title>OpenTelemetry</title>
    <link href="https://nmk0718.github.io/2025/01/14/OpenTelemetry/"/>
    <id>https://nmk0718.github.io/2025/01/14/OpenTelemetry/</id>
    <published>2025-01-14T03:09:00.000Z</published>
    <updated>2025-02-10T04:01:00.674Z</updated>
    
    <content type="html"><![CDATA[<p>OpenTelemetryï¼ˆç®€ç§°OTelï¼‰æ˜¯ä¸€ä¸ªå¼€æºå¯è§‚æµ‹æ€§æ¡†æ¶ï¼Œç”¨äºä»ªè¡¨åŒ–ã€ç”Ÿæˆã€æ”¶é›†å’Œå¯¼å‡ºè¯¸å¦‚è·Ÿè¸ªã€åº¦é‡ã€æ—¥å¿—ç­‰é¥æµ‹æ•°æ®<br><image src="https://opentelemetry.io/docs/collector/img/otel-collector.svg" alt="Collector"></image></p><p>éƒ¨ç½²å‚è€ƒæ–‡æ¡£ï¼š<br><a href="https://opentelemetry.io/zh/docs" target="_blank" rel="noopener">https://opentelemetry.io/zh/docs</a><br><a href="https://www.zhihu.com/question/545762884/answer/3323681028" target="_blank" rel="noopener">https://www.zhihu.com/question/545762884/answer/3323681028</a></p><h3 id="Instrumentation"><a href="#Instrumentation" class="headerlink" title="Instrumentation"></a>Instrumentation</h3><p>Instrumentation æ˜¯ OpenTelemetry ä¸­ç”¨äºå¯¹åº”ç”¨ç¨‹åºè¿›è¡Œç›‘æ§å’Œæ•°æ®æ”¶é›†ã€‚å®ƒåŒ…æ‹¬æ‰‹åŠ¨ä»ªè¡¨åŒ–ï¼ˆManual Instrumentationï¼‰å’Œè‡ªåŠ¨ä»ªè¡¨åŒ–ï¼ˆAutomatic Instrumentationï¼‰ä¸¤ç§æ–¹å¼ã€‚é€šè¿‡ Instrumentationï¼Œå¼€å‘äººå‘˜å¯ä»¥å°†åº”ç”¨ç¨‹åºçš„è¿è¡Œæ•°æ®ï¼ˆå¦‚è¿½è¸ªã€æŒ‡æ ‡ã€æ—¥å¿—ï¼‰æ”¶é›†å¹¶å‘é€åˆ°åç«¯ç³»ç»Ÿè¿›è¡Œåˆ†æå’Œå¯è§†åŒ–ã€‚</p><ol><li>æ‰‹åŠ¨ä»ªè¡¨åŒ–ï¼š<ul><li>å¼€å‘è€…é€šè¿‡åœ¨ä»£ç ä¸­æ˜¾å¼åœ°æ·»åŠ  OpenTelemetry API è°ƒç”¨ï¼Œæ¥åˆ›å»ºå’Œç®¡ç†è¿½è¸ªã€æŒ‡æ ‡ç­‰é¥æµ‹æ•°æ®ã€‚</li><li>å¯ä»¥å¯¹åº”ç”¨ç¨‹åºçš„ç‰¹å®šéƒ¨åˆ†è¿›è¡Œè¯¦ç»†çš„ç›‘æ§å’Œåˆ†æï¼Œè·å–æ›´æ·±å…¥çš„æ€§èƒ½å’Œè¡Œä¸ºä¿¡æ¯ã€‚</li><li>åœ¨å…³é”®çš„ä¸šåŠ¡é€»è¾‘å¤„æ‰‹åŠ¨åˆ›å»º span æ¥è®°å½•æ“ä½œçš„å¼€å§‹å’Œç»“æŸæ—¶é—´ï¼Œä»è€Œç²¾ç¡®åœ°ç›‘æ§ç‰¹å®šä»£ç æ®µçš„æ‰§è¡Œæƒ…å†µã€‚</li></ul></li><li>è‡ªåŠ¨ä»ªè¡¨åŒ–ï¼š<ul><li>æ— éœ€ä¿®æ”¹åº”ç”¨ç¨‹åºæºä»£ç ï¼Œé€šè¿‡ç‰¹å®šçš„æœºåˆ¶ï¼ˆå¦‚å­—èŠ‚ç æ³¨å…¥ã€ä»£ç†ç­‰ï¼‰è‡ªåŠ¨å¯¹åº”ç”¨ç¨‹åºä¸­çš„å„ç§åº“ã€æ¡†æ¶ç­‰è¿›è¡Œç›‘æ§ï¼Œæ”¶é›†é¥æµ‹æ•°æ®ã€‚</li><li>å‡å°‘æ‰‹åŠ¨æ·»åŠ ç›‘æ§ä»£ç çš„å·¥ä½œé‡ï¼Œå¿«é€Ÿä¸ºåº”ç”¨ç¨‹åºæ·»åŠ åŸºæœ¬çš„ç›‘æ§èƒ½åŠ›ã€‚ä¾‹å¦‚ï¼ŒOpenTelemetry çš„ Java è‡ªåŠ¨ä»ªè¡¨åŒ–å¯ä»¥é€šè¿‡ä¸€ä¸ª agent è‡ªåŠ¨æ”¶é›†æ—¥å¿—ã€æŒ‡æ ‡ã€trace å¹¶ä¸ŠæŠ¥ã€‚</li></ul></li></ol><h3 id="Collector"><a href="#Collector" class="headerlink" title="Collector"></a>Collector</h3><p>Collector æ˜¯ä¸€ä¸ªå¼€æºçš„ã€å¯æ‰©å±•çš„ä»£ç†ï¼Œç”¨äºæ¥æ”¶ã€å¤„ç†å’Œå¯¼å‡ºé¥æµ‹æ•°æ®ï¼ˆå¦‚ tracesã€metrics å’Œ logsï¼‰ã€‚å®ƒæä¾›äº†ä¸€ç§å‚å•†ä¸­ç«‹çš„æ–¹å¼æ¥æ”¶é›†ã€å¤„ç†å’Œå¯¼å‡ºé¥æµ‹æ•°æ®ï¼Œæ¶ˆé™¤äº†è¿è¡Œã€æ“ä½œå’Œç»´æŠ¤å¤šä¸ªä»£ç†/æ”¶é›†å™¨çš„éœ€è¦ã€‚</p><h4 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h4><p>åœ¨ä¸ä¿®æ”¹åº”ç”¨ç¨‹åºä»£ç çš„æƒ…å†µä¸‹ï¼Œæ”¶é›†å’Œå¤„ç†é¥æµ‹æ•°æ®ã€‚</p><ol><li>Agentï¼š<ul><li>éƒ¨ç½²æ–¹å¼ï¼šæ¯ä¸ªå®¢æˆ·ç«¯SDKæˆ–ä¸‹æ¸¸é‡‡é›†å™¨éƒ½é…ç½®ä¸€ä¸ªcollectorã€‚æ”¶é›†å™¨å®ä¾‹ä¸åº”ç”¨ç¨‹åºåœ¨åŒä¸€ä¸»æœºä¸Šè¿è¡Œï¼Œä¾‹å¦‚sidecaræˆ–è€…daemonsetæ–¹å¼ã€‚</li><li>å·¥ä½œæ–¹å¼ï¼šåº”ç”¨ç¨‹åºä¸­çš„SDKä»¥OTLPåè®®å‘é€é¥æµ‹æ•°æ®ç»™collectorã€‚ç„¶åcollectorå¤„ç†é¥æµ‹æ•°æ®å¹¶å¯¹æ¥åˆ°å¯è§‚æµ‹æ€§åç«¯ã€‚<image src="https://opentelemetry.io/zh/docs/collector/img/otel-agent-sdk.svg" alt="Agentå½¢æ€"></image></li></ul></li><li>Gatewayï¼š<ul><li>éƒ¨ç½²æ–¹å¼ï¼šä½¿ç”¨å¼€ç®±å³ç”¨çš„è´Ÿè½½å‡è¡¡å™¨ï¼ˆæ¯”å¦‚nginxï¼‰åœ¨otel-collectorä¹‹é—´åˆ†é…è´Ÿè½½ã€‚</li><li>å·¥ä½œæ–¹å¼ï¼šåº”ç”¨ç¨‹åºä¸­çš„SDKä»¥OTLPåè®®å‘é€é¥æµ‹æ•°æ®ç»™è´Ÿè½½å‡è¡¡å™¨ï¼Œè´Ÿè½½å‡è¡¡å™¨æ ¹æ®ç®—æ³•é€‰æ‹©å…¶ä¸­ä¸€ä¸ªcollectorå®ä¾‹è¿›è¡Œå¤„ç†å¹¶å¯¹æ¥åˆ°å¯è§‚æµ‹æ€§åç«¯<image src="https://opentelemetry.io/zh/docs/collector/img/otel-gateway-sdk.svg" alt="Gatewayå½¢æ€"></image></li></ul></li></ol><h4 id="Pipeline-components"><a href="#Pipeline-components" class="headerlink" title="Pipeline components"></a>Pipeline components</h4><ul><li><p>receiverï¼šè´Ÿè´£æŒ‰ç…§å¯¹åº”çš„åè®®æ ¼å¼ç›‘å¬æ¥æ”¶é¥æµ‹æ•°æ®ï¼Œå¹¶æŠŠæ•°æ®è½¬ç»™ä¸€ä¸ªæˆ–è€…å¤šä¸ªprocessorã€‚</p></li><li><p>processorï¼šè´Ÿè´£åšé¥æµ‹æ•°æ®åŠ å·¥å¤„ç†ï¼Œå¦‚ä¸¢å¼ƒæ•°æ®ï¼Œå¢åŠ ä¿¡æ¯ï¼Œè½¬æ‰¹å¤„ç†ç­‰ï¼Œå¹¶æŠŠæ•°æ®ä¼ é€’ç»™ä¸‹ä¸€ä¸ªprocessoræˆ–è€…ä¼ é€’ç»™ä¸€ä¸ªæˆ–å¤šä¸ªexporterã€‚</p></li><li><p>exporterï¼šè´Ÿè´£æŠŠæ•°æ®å¾€ä¸‹ä¸€ä¸ªæ¥æ”¶ç«¯å‘é€ï¼ˆä¸€èˆ¬æ˜¯é¥æµ‹åç«¯ï¼‰ï¼Œexporterå¯ä»¥å®šä¹‰åŒæ—¶ä»å¤šä¸ªä¸åŒçš„processorä¸­è·å–é¥æµ‹æ•°æ®ã€‚</p></li></ul><p>Collector é™¤äº†æä¾›è®©é¥æµ‹æ•°æ®æ”¶é›†ä¸ä¸šåŠ¡é€»è¾‘å¤„ç†æ­£äº¤çš„èƒ½åŠ›ï¼Œè¿˜å……å½“äº†é¥æµ‹æ•°æ®å¯¹æ¥é¥æµ‹åç«¯çš„é€‚é…å™¨ã€‚Collectorå¯ä»¥æ¥æ”¶ Otlpã€Zipkinã€Jaegerç­‰ä»»æ„æ ¼å¼çš„æ•°æ®ï¼Œç„¶åä»¥ Otlpã€Zipkinã€Jaegerç­‰ä»»æ„æ ¼å¼çš„æ•°æ®è½¬å‘å‡ºå»ã€‚è¿™ä¸€åˆ‡åªå–å†³äºä½ éœ€è¦è¾“å…¥æˆ–è¾“å‡ºçš„æ ¼å¼æ˜¯å¦æœ‰å¯¹åº”çš„ receiver å’Œ exporter å®ç°</p><h3 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h3><h4 id="Jaeger"><a href="#Jaeger" class="headerlink" title="Jaeger"></a>Jaeger</h4><p>ä¸ºäº†ä¾¿äºæ¼”ç¤ºè¿™é‡Œä½¿ç”¨  jaegertracing/all-in-one é•œåƒæ¥éƒ¨ç½² Jaegerï¼Œè¿™ä¸ªé•œåƒåŒ…å«äº† Jaeger æ”¶é›†å™¨ã€å†…å­˜å­˜å‚¨ã€æŸ¥è¯¢æœåŠ¡å’Œ UI ç­‰ç»„ä»¶ï¼Œéå¸¸é€‚åˆå¼€å‘å’Œæµ‹è¯•ä½¿ç”¨ã€‚é€šè¿‡ç¯å¢ƒå˜é‡ <code>COLLECTOR_OTLP_ENABLED</code> å¯åŠ¨å¯¹ OTLPï¼ˆOpenTelemetry Protocolï¼‰ çš„æ”¯æŒã€‚</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="bullet">-</span> <span class="string">&lt;&lt;EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jaeger</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">jaeger</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">jaeger</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jaeger</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">jaegertracing/all-in-one:latest</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">COLLECTOR_OTLP_ENABLED</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"true"</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">16686</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">14268</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jaeger</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">jaeger</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ui</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">16686</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">16686</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">collector</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">14268</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">14268</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">4318</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">4318</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grpc</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">4317</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">4317</span>      </span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h4 id="â€‹â€‹OpenTelemetry-Operator"><a href="#â€‹â€‹OpenTelemetry-Operator" class="headerlink" title="â€‹â€‹OpenTelemetry Operator"></a>â€‹â€‹OpenTelemetry Operator</h4><p>OpenTelemetry Operatorç”¨äºç®¡ç†OpenTelemetry æ”¶é›†å™¨(OpenTelemetry Collectors)å’Œå·¥ä½œè´Ÿè½½çš„è‡ªåŠ¨æ£€æµ‹(auto-instrumentation)<br>å®‰è£…OpenTelemetry Operator</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm repo add open-telemetry https://open-telemetry.github.io/opentelemetry-helm-charts</span><br><span class="line"></span><br><span class="line">helm install opentelemetry-operator open-telemetry/opentelemetry-operator \</span><br><span class="line">  --<span class="built_in">set</span> <span class="string">"manager.collectorImage.repository=otel/opentelemetry-collector-k8s"</span> \</span><br><span class="line">  --<span class="built_in">set</span> admissionWebhooks.certManager.enabled=<span class="literal">false</span> \</span><br><span class="line">  --<span class="built_in">set</span> admissionWebhooks.autoGenerateCert.enabled=<span class="literal">true</span></span><br></pre></td></tr></table></figure><ul><li><code>otel/opentelemetry-collector-k8s</code>ä¸“é—¨ä¸ºKubernetesç¯å¢ƒä¼˜åŒ–çš„ï¼ŒåŒ…å«äº†åœ¨Kubernetesä¸­è¿è¡Œæ‰€éœ€çš„åŸºæœ¬åŠŸèƒ½å’Œæ’ä»¶ã€‚</li><li><code>opentelemetry-collector-contrib</code>åŒ…å«äº†å¤§é‡çš„æ‰©å±•åŠŸèƒ½å’Œå®éªŒæ€§ç»„ä»¶ã€‚è¿™äº›ç»„ä»¶åŒ…æ‹¬å„ç§æ¥æ”¶å™¨ã€å¤„ç†å™¨ã€å¯¼å‡ºå™¨ä»¥åŠæ‰©å±•åŠŸèƒ½ï¼Œæ—¨åœ¨æä¾›æ›´å¹¿æ³›çš„é¥æµ‹æ•°æ®å¤„ç†èƒ½åŠ›<br>å¯ä»¥çœ‹åˆ°å¯¹åº”çš„ Pod å·²ç»æ­£å¸¸è¿è¡Œï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ  ~ kubectl --namespace default get pods -l <span class="string">"app.kubernetes.io/name=opentelemetry-operator"</span></span><br><span class="line">NAME                                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">opentelemetry-operator-f78f45ffc-sgns7   2/2     Running   0          2m44s</span><br></pre></td></tr></table></figure></li></ul><p>è¿˜ä¼šè‡ªåŠ¨ä¸ºæˆ‘ä»¬æ·»åŠ OpenTelemetry ç›¸å…³çš„ CRDï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ  ~ kubectl get crd |grep opentelemetry</span><br><span class="line">instrumentations.opentelemetry.io                    2025-01-14T07:32:04Z</span><br><span class="line">opampbridges.opentelemetry.io                        2025-01-14T07:32:04Z</span><br><span class="line">opentelemetrycollectors.opentelemetry.io             2025-01-14T07:32:04Z</span><br></pre></td></tr></table></figure><h4 id="OpenTelemetry-Collector"><a href="#OpenTelemetry-Collector" class="headerlink" title="OpenTelemetry Collector"></a>OpenTelemetry Collector</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="bullet">-</span> <span class="string">&lt;&lt;EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">opentelemetry.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">OpenTelemetryCollector</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">otel</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">config:</span> <span class="string">|</span></span><br><span class="line">    <span class="attr">receivers:</span></span><br><span class="line">      <span class="attr">otlp:</span></span><br><span class="line">        <span class="attr">protocols:</span></span><br><span class="line">          <span class="attr">grpc:</span></span><br><span class="line">          <span class="attr">http:</span></span><br><span class="line">    <span class="attr">processors:</span></span><br><span class="line">      <span class="attr">memory_limiter:</span></span><br><span class="line">        <span class="attr">check_interval:</span> <span class="string">1s</span></span><br><span class="line">        <span class="attr">limit_percentage:</span> <span class="number">75</span></span><br><span class="line">        <span class="attr">spike_limit_percentage:</span> <span class="number">15</span></span><br><span class="line">      <span class="attr">batch:</span></span><br><span class="line">        <span class="attr">send_batch_size:</span> <span class="number">10000</span></span><br><span class="line">        <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">exporters:</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">otlp/jaeger:</span></span><br><span class="line">        <span class="attr">endpoint:</span> <span class="string">"jaeger.default:4317"</span></span><br><span class="line">        <span class="attr">tls:</span></span><br><span class="line">          <span class="attr">insecure:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">pipelines:</span></span><br><span class="line">        <span class="attr">traces:</span></span><br><span class="line">          <span class="attr">receivers:</span> <span class="string">[otlp]</span></span><br><span class="line">          <span class="attr">processors:</span> <span class="string">[]</span></span><br><span class="line">          <span class="attr">exporters:</span> <span class="string">[debug,otlp/jaeger]</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>åˆ›å»º CR OpenTelemetryCollector åï¼ŒOtel Operator ä¼šåˆ›å»ºä¸€ä¸ª deployment å’Œ å¤šä¸ª serviceã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ  ~</span><br><span class="line">kubectl get deployment,service -l app.kubernetes.io/component=opentelemetry-collector</span><br><span class="line"></span><br><span class="line">NAME                             READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/otel-collector   1/1     1            1           3m37s</span><br><span class="line"></span><br><span class="line">NAME                                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE</span><br><span class="line">service/otel-collector              ClusterIP   10.111.0.124     &lt;none&gt;        4317/TCP,4318/TCP   3m36s</span><br><span class="line">service/otel-collector-headless     ClusterIP   None             &lt;none&gt;        4317/TCP,4318/TCP   3m36s</span><br><span class="line">service/otel-collector-monitoring   ClusterIP   10.111.151.111   &lt;none&gt;        8888/TCP            3m36s</span><br></pre></td></tr></table></figure><h4 id="Auto-instrumentation"><a href="#Auto-instrumentation" class="headerlink" title="Auto-instrumentation"></a>Auto-instrumentation</h4><p>åˆ›å»ºä¸€ä¸ªJava æœåŠ¡çš„åŸºæœ¬æ£€æµ‹èµ„æº</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="bullet">-</span> <span class="string">&lt;&lt;EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">opentelemetry.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Instrumentation</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">instrumentation-sample</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">propagators:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tracecontext</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">baggage</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">b3</span></span><br><span class="line">  <span class="attr">sampler:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">parentbased_traceidratio</span></span><br><span class="line">    <span class="attr">argument:</span> <span class="string">"1"</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_EXPORTER_OTLP_ENDPOINT</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">otel-collector.default:4318</span></span><br><span class="line">  <span class="attr">java:</span>    </span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_EXPORTER_OTLP_ENDPOINT</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">http://otel-collector.default:4317</span>   </span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>â€‹Instrumentationâ€‹â€‹ ç”±ä»¥ä¸‹å±æ€§ç»„æˆï¼š<br><code>â€‹â€‹exporter.endpointâ€‹</code>â€‹ -ï¼ˆå¯é€‰ï¼‰å°†é¥æµ‹æ•°æ®å‘é€åˆ° OTLP æ ¼å¼çš„åœ°å€ã€‚<br><code>â€‹â€‹propagators</code>â€‹â€‹ - ä½¿æ‰€æœ‰æ•°æ®æºèƒ½å¤Ÿå…±äº«åº•å±‚ä¸Šä¸‹æ–‡æœºåˆ¶ï¼Œç”¨äºåœ¨äº‹åŠ¡çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­å­˜å‚¨çŠ¶æ€å’Œè®¿é—®æ•°æ®ã€‚<br>â€‹<code>â€‹sampler</code>â€‹â€‹â€‹ - é€šè¿‡å‡å°‘æ”¶é›†å’Œå‘é€åˆ°åç«¯çš„è·Ÿè¸ªæ ·æœ¬æ•°é‡æ¥å¼•å…¥çš„å™ªéŸ³å’Œå¼€é”€çš„æœºåˆ¶ã€‚ OpenTelemetry æä¾›ä¸¤ç§ç±»å‹ï¼šâ€‹â€‹StaticSamplerâ€‹â€‹â€‹ å’Œ â€‹TraceIDRatioBasedâ€‹â€‹ã€‚<br>è¯­è¨€å±æ€§ï¼Œå³â€‹â€‹javaâ€‹â€‹â€‹ã€â€‹â€‹nodejsâ€‹â€‹â€‹ã€â€‹â€‹pythonâ€‹â€‹â€‹ å’Œâ€‹â€‹dotnetâ€‹â€‹ - æ ¹æ® pod æ³¨è§£ä¸­è®¾ç½®çš„è¯­è¨€ï¼Œä½¿ç”¨è‡ªåŠ¨æ’æ¡©çš„è‡ªå®šä¹‰é•œåƒ</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œè‡ªåŠ¨æ£€æµ‹ Java æœåŠ¡çš„ Instrumentation èµ„æºä¸åè®®otlpä¸€èµ·ä½¿ç”¨http/protobufã€‚è¿™æ„å‘³ç€é…ç½®çš„ç«¯ç‚¹å¿…é¡»èƒ½å¤Ÿé€šè¿‡httpæœ‰æ•ˆprotobufè´Ÿè½½æ¥æ”¶ OTLPã€‚å› æ­¤ï¼Œç¤ºä¾‹ä½¿ç”¨otel-collector.default:4318ï¼Œå®ƒè¿æ¥åˆ° httpä¸Šä¸€æ­¥ä¸­åˆ›å»ºçš„ Collector çš„ otlpreceiver çš„ç«¯å£ã€‚</p><p>åˆ›å»ºjavaç¤ºä¾‹åº”ç”¨</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="bullet">-</span> <span class="string">&lt;&lt;EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-sample</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">java-sample</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">java-sample</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="comment">#spec.template.metadata.annotationsç‰¹å®šäºè¯­è¨€çš„æ³¨è§£æ¥å®Œæˆè‡ªåŠ¨æ£€æµ‹</span></span><br><span class="line">        <span class="attr">instrumentation.opentelemetry.io/inject-java:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">java-sample</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">pinakispecial/spring-boot-rest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>å¯ç”¨æ³¨è§£ï¼š<br>â€‹<code>â€‹true</code>â€‹â€‹ - ä»å‘½åç©ºé—´æ³¨å…¥å’ŒåŸ‹ç‚¹èµ„æºã€‚<br>â€‹<code>â€‹my-instrumentationâ€‹â€‹</code>â€‹ - å½“å‰å‘½åç©ºé—´ä¸­æ³¨å…¥â€‹â€‹Instrumentationâ€‹â€‹ CR å®ä¾‹çš„åç§°ã€‚<br>â€‹<code>â€‹my-other-namespace/my-instrumentation</code>â€‹â€‹â€‹ - å¦ä¸€ä¸ªå‘½åç©ºé—´ä¸­â€‹â€‹Instrumentationâ€‹â€‹ CR å®ä¾‹çš„åç§°å’Œå‘½åç©ºé—´ã€‚<br><code>â€‹â€‹false</code>â€‹â€‹ -ä¸æ³¨å…¥ã€‚</p><p>å¯ä»¥çœ‹åˆ° Otel Operator å‘ Pod ä¸­æ³¨å…¥äº†ä¸€ä¸ª otel çš„åˆå§‹åŒ–å®¹å™¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ  ~ kubectl get pod java-sample-6f688ffb4f-gq95j -o jsonpath=<span class="string">'&#123;.spec.initContainers[*].image&#125; &#123;.spec.containers[*].image&#125;'</span></span><br><span class="line">ghcr.io/open-telemetry/opentelemetry-operator/autoinstrumentation-java:1.33.6 pinakispecial/spring-boot-rest%</span><br></pre></td></tr></table></figure><p>ä»¥åŠåœ¨ java å®¹å™¨ä¸­æ³¨å…¥äº†ä¸€ç³»åˆ—çš„ç¯å¢ƒå˜é‡è¿›è¡Œé…ç½®</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_NODE_IP</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">status.hostIP</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_POD_IP</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_EXPORTER_OTLP_ENDPOINT</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">http://otel-collector.default:4317</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_TOOL_OPTIONS</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">' -javaagent:/otel-auto-instrumentation-java/javaagent.jar'</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_SERVICE_NAME</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">java-sample</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_RESOURCE_ATTRIBUTES_POD_NAME</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_RESOURCE_ATTRIBUTES_NODE_NAME</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_PROPAGATORS</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">tracecontext,baggage,b3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_TRACES_SAMPLER</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">parentbased_traceidratio</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_TRACES_SAMPLER_ARG</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">"1"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_RESOURCE_ATTRIBUTES</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">k8s.container.name=java-sample,k8s.deployment.name=java-sample,k8s.namespace.name=default,k8s.node.name=$(OTEL_RESOURCE_ATTRIBUTES_NODE_NAME),k8s.pod.name=$(OTEL_RESOURCE_ATTRIBUTES_POD_NAME),k8s.replicaset.name=java-sample-6f688ffb4f,service.instance.id=default.$(OTEL_RESOURCE_ATTRIBUTES_POD_NAME).java-sample</span></span><br></pre></td></tr></table></figure><p>è¯·æ±‚æœåŠ¡æ¥å£</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#å¼€æ”¾JavaæœåŠ¡çš„ç«¯å£è®¿é—®</span></span><br><span class="line">âœ  ~ kubectl port-forward java-sample-6f688ffb4f-gq95j 8080:8080</span><br><span class="line">Forwarding from 127.0.0.1:8080 -&gt; 8080</span><br><span class="line">Forwarding from [::1]:8080 -&gt; 8080</span><br><span class="line"><span class="comment">#è¯·æ±‚æ¥å£</span></span><br><span class="line">âœ  ~ curl localhost:8080</span><br><span class="line">OK%</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¼€æ”¾Jaeger UIçš„ç«¯å£è®¿é—®</span></span><br><span class="line">âœ  ~ kubectl port-forward svc/jaeger 16686:16686</span><br><span class="line">Forwarding from 127.0.0.1:16686 -&gt; 16686</span><br><span class="line">Forwarding from [::1]:16686 -&gt; 16686</span><br></pre></td></tr></table></figure><p>è®¿é—® Jaeger UI æŸ¥çœ‹è®¿é—®çš„é“¾è·¯ä¿¡æ¯<br><img src="https://nmk0718.github.io/image/JaegerUI.png" alt="Jaeger UI"></p><h4 id="æ¥å…¥prometheus"><a href="#æ¥å…¥prometheus" class="headerlink" title="æ¥å…¥prometheus"></a>æ¥å…¥prometheus</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">helm repo add prometheus-community https://prometheus-community.github.io/helm-charts</span><br><span class="line"></span><br><span class="line">helm show values  prometheus-community/prometheus &gt; values.yaml</span><br><span class="line"></span><br><span class="line">helm install prometheus prometheus-community/prometheus -f values.yaml</span><br><span class="line"></span><br><span class="line">kubectl port-forward svc/prometheus-server 9090:80</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">opentelemetry.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">OpenTelemetryCollector</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">otel-prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">config:</span> <span class="string">|</span></span><br><span class="line">    <span class="attr">receivers:</span></span><br><span class="line">      <span class="attr">otlp:</span></span><br><span class="line">        <span class="attr">protocols:</span></span><br><span class="line">          <span class="attr">grpc:</span></span><br><span class="line">          <span class="attr">http:</span></span><br><span class="line">    <span class="attr">processors:</span></span><br><span class="line">      <span class="attr">memory_limiter:</span></span><br><span class="line">        <span class="attr">check_interval:</span> <span class="string">1s</span></span><br><span class="line">        <span class="attr">limit_percentage:</span> <span class="number">75</span></span><br><span class="line">        <span class="attr">spike_limit_percentage:</span> <span class="number">15</span></span><br><span class="line">      <span class="attr">batch:</span></span><br><span class="line">        <span class="attr">send_batch_size:</span> <span class="number">10000</span></span><br><span class="line">        <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">    <span class="attr">exporters:</span></span><br><span class="line">      <span class="attr">prometheus:</span></span><br><span class="line">        <span class="attr">endpoint:</span> <span class="string">"localhost:9090"</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">pipelines:</span></span><br><span class="line">        <span class="attr">metrics:</span></span><br><span class="line">          <span class="attr">receivers:</span> <span class="string">[otlp]</span></span><br><span class="line">          <span class="attr">processors:</span> <span class="string">[memory_limiter,</span> <span class="string">batch]</span></span><br><span class="line">          <span class="attr">exporters:</span> <span class="string">[prometheus]</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;OpenTelemetryï¼ˆç®€ç§°OTelï¼‰æ˜¯ä¸€ä¸ªå¼€æºå¯è§‚æµ‹æ€§æ¡†æ¶ï¼Œç”¨äºä»ªè¡¨åŒ–ã€ç”Ÿæˆã€æ”¶é›†å’Œå¯¼å‡ºè¯¸å¦‚è·Ÿè¸ªã€åº¦é‡ã€æ—¥å¿—ç­‰é¥æµ‹æ•°æ®&lt;br&gt;&lt;image src=&quot;https://opentelemetry.io/docs/collector/img/otel-collector.</summary>
      
    
    
    
    
    <category term="k8s" scheme="https://nmk0718.github.io/tag/k8s/"/>
    
    <category term="OpenTelemetry" scheme="https://nmk0718.github.io/tag/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>Tampermonkeyå±è”½è…¾è®¯äº‘å¹¿å‘Š</title>
    <link href="https://nmk0718.github.io/2025/01/04/Tampermonkey%E5%B1%8F%E8%94%BD%E8%85%BE%E8%AE%AF%E4%BA%91%E5%B9%BF%E5%91%8A/"/>
    <id>https://nmk0718.github.io/2025/01/04/Tampermonkey%E5%B1%8F%E8%94%BD%E8%85%BE%E8%AE%AF%E4%BA%91%E5%B9%BF%E5%91%8A/</id>
    <published>2025-01-04T03:00:00.000Z</published>
    <updated>2025-02-10T04:00:59.767Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä½¿ç”¨è…¾è®¯äº‘æ§åˆ¶å°è¿‡ç¨‹ä¸­é‡åˆ°å¾ˆå¤šå¹¿å‘Šï¼Œæ¯æ¬¡ç‚¹xåè¿˜ä¼šå¼¹ğŸ¤®ï¼Œå½±å“é¡µé¢å±•ç¤ºã€‚é€šè¿‡æ²¹çŒ´è„šæœ¬è¿›è¡Œè¿‡æ»¤å¹¿å‘Š<br>è…¾è®¯äº‘åŸé¡µé¢<br><img src="https://nmk0718.github.io/image/tencent_ads_cvm.png"><br><img src="https://nmk0718.github.io/image/tencent_ads_cdn.png"><br>é€šè¿‡kimiè¿›è¡Œç¼–å†™è„šæœ¬ï¼Œä¸€å¼€å§‹æƒ³å¯¹æ¥å£ç›´æ¥æ‹¦æˆªï¼Œä½†æ˜¯é…ç½®åä¸ç”Ÿæ•ˆï¼Œåç»­é€šè¿‡é¡µé¢éšè—å…ƒç´ å®ç°<br>é€šè¿‡F12æ£€æŸ¥å…ƒç´ æŸ¥çœ‹å¹¿å‘Šå¯¹åº”çš„å…ƒç´ <br><img src="https://nmk0718.github.io/image/check_web_element.png"><br>è®©kimié€šè¿‡å…ƒç´ è¿›è¡Œéšè—ï¼Œç¼–å†™æ²¹çŒ´è„šæœ¬ï¼Œæœ€ç»ˆè„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ==UserScript==</span></span><br><span class="line"><span class="comment">// @name         å±è”½ç‰¹å®šé¡µé¢çš„å¹¿å‘Šå’Œæç¤º</span></span><br><span class="line"><span class="comment">// @namespace    http://tampermonkey.net/</span></span><br><span class="line"><span class="comment">// @version      0.1</span></span><br><span class="line"><span class="comment">// @description  å±è”½ç‰¹å®šé¡µé¢çš„å¹¿å‘Šå’Œæç¤º</span></span><br><span class="line"><span class="comment">// @author       Kimi</span></span><br><span class="line"><span class="comment">// @match        https://console.cloud.tencent.com/*</span></span><br><span class="line"><span class="comment">// @grant        none</span></span><br><span class="line"><span class="comment">// @run-at       document-body</span></span><br><span class="line"><span class="comment">// ==/UserScript==</span></span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="meta">    'use strict'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥éšè—å…ƒç´ </span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">hideElements</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> currentUrl = <span class="built_in">window</span>.location.href;</span><br><span class="line">        <span class="comment">// éšè—å…·æœ‰ data-sid="opc-ads" å±æ€§çš„ ins å…ƒç´ </span></span><br><span class="line">        <span class="keyword">const</span> ads = <span class="built_in">document</span>.querySelectorAll(<span class="string">'ins[data-sid="opc-ads"]'</span>);</span><br><span class="line">        ads.forEach(<span class="function"><span class="params">ad</span> =&gt;</span> &#123;</span><br><span class="line">            ad.style.display = <span class="string">'none'</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// éšè—æ‰€æœ‰ä»¥ app- å¼€å¤´å¹¶åŒ…å« alert çš„ div å…ƒç´ </span></span><br><span class="line">        <span class="keyword">const</span> alerts = <span class="built_in">document</span>.querySelectorAll(<span class="string">'div[class^="app-"][class*="alert"]'</span>);</span><br><span class="line">        alerts.forEach(<span class="function"><span class="params">alert</span> =&gt;</span> &#123;</span><br><span class="line">            alert.style.display = <span class="string">'none'</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (currentUrl.includes(<span class="string">'/cvm/instance/index?rid=1'</span>)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// éšè—å…·æœ‰ class="app-cvm-alert" çš„ div å…ƒç´ </span></span><br><span class="line">            <span class="keyword">const</span> alerts = <span class="built_in">document</span>.querySelectorAll(<span class="string">'div.app-cvm-alert'</span>);</span><br><span class="line">            alerts.forEach(<span class="function"><span class="params">alert</span> =&gt;</span> &#123;</span><br><span class="line">                alert.style.display = <span class="string">'none'</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currentUrl.includes(<span class="string">'/cdn'</span>)) &#123;</span><br><span class="line">            <span class="comment">// éšè—å…·æœ‰ class="streams-to-eo-ads-bar" çš„ div å…ƒç´ </span></span><br><span class="line">            <span class="keyword">const</span> adsBar = <span class="built_in">document</span>.querySelector(<span class="string">'div.streams-to-eo-ads-bar'</span>);</span><br><span class="line">            <span class="keyword">if</span> (adsBar) &#123;</span><br><span class="line">                adsBar.style.display = <span class="string">'none'</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// éšè—å…·æœ‰ class="streams-to-eo-ads-content" çš„ div å…ƒç´ </span></span><br><span class="line">            <span class="keyword">const</span> adsContent = <span class="built_in">document</span>.querySelector(<span class="string">'div.streams-to-eo-ads-content'</span>);</span><br><span class="line">            <span class="keyword">if</span> (adsContent) &#123;</span><br><span class="line">                adsContent.style.display = <span class="string">'none'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹æ£€æŸ¥</span></span><br><span class="line">    hideElements();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ MutationObserver ç›‘æ§ DOM å˜åŒ–</span></span><br><span class="line">    <span class="keyword">const</span> observer = <span class="keyword">new</span> MutationObserver(<span class="function">(<span class="params">mutations</span>) =&gt;</span> &#123;</span><br><span class="line">        mutations.forEach(<span class="function">(<span class="params">mutation</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (mutation.addedNodes) &#123;</span><br><span class="line">                mutation.addedNodes.forEach(<span class="function">(<span class="params">node</span>) =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (node.nodeType === <span class="number">1</span>) &#123;</span><br><span class="line">                        hideElements();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é…ç½®è§‚å¯Ÿå™¨é€‰é¡¹</span></span><br><span class="line">    <span class="keyword">const</span> config = &#123;</span><br><span class="line">        childList: <span class="literal">true</span>,</span><br><span class="line">        subtree: <span class="literal">true</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼€å§‹è§‚å¯Ÿæ•´ä¸ªæ–‡æ¡£</span></span><br><span class="line">    observer.observe(<span class="built_in">document</span>.body, config);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><p>å¼€å¯æ²¹çŒ´æ’ä»¶åï¼Œé‡æ–°è®¿é—®è…¾è®¯äº‘æ§åˆ¶å°ï¼Œå¯çœ‹åˆ°å±è”½åæ•ˆæœå›¾<br><img src="https://nmk0718.github.io/image/tencent_cvm.png"><br><img src="https://nmk0718.github.io/image/tencent_cdn.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;åœ¨ä½¿ç”¨è…¾è®¯äº‘æ§åˆ¶å°è¿‡ç¨‹ä¸­é‡åˆ°å¾ˆå¤šå¹¿å‘Šï¼Œæ¯æ¬¡ç‚¹xåè¿˜ä¼šå¼¹ğŸ¤®ï¼Œå½±å“é¡µé¢å±•ç¤ºã€‚é€šè¿‡æ²¹çŒ´è„šæœ¬è¿›è¡Œè¿‡æ»¤å¹¿å‘Š&lt;br&gt;è…¾è®¯äº‘åŸé¡µé¢&lt;br&gt;&lt;img src=&quot;https://nmk0718.github.io/image/tencent_ads_cvm.png&quot;&gt;&lt;br&gt;&lt;img sr</summary>
      
    
    
    
    
    <category term="windows" scheme="https://nmk0718.github.io/tag/windows/"/>
    
  </entry>
  
  <entry>
    <title>iterm2</title>
    <link href="https://nmk0718.github.io/2025/01/03/iterm2/"/>
    <id>https://nmk0718.github.io/2025/01/03/iterm2/</id>
    <published>2025-01-03T03:37:00.000Z</published>
    <updated>2025-02-10T04:00:59.747Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h3><ol><li><p>iterm2â€”&gt;Preferencesâ€”&gt;Profilesï¼Œé…ç½®ä¸€ä¸ªæ–°çš„profile</p><img src="https://nmk0718.github.io/image/jumpserver_profile.png"></li><li><p>iterm2â€”&gt;Windowâ€”&gt;Password Managerï¼ŒAccountNameåªæ˜¯æç¤ºï¼ŒPasswordé…ç½®æ­£ç¡®å³å¯</p><img src="https://nmk0718.github.io/image/jumpserver_password.png"></li><li><p>å¯¹åº”Profilesé‡Œé¢çš„Advancedé€‰é¡¹ï¼Œæ‰¾åˆ°Triggersï¼Œç‚¹å‡»Edit</p><img src="https://nmk0718.github.io/image/jumpserver_triggers.png">é…ç½®è§¦å‘æ‰“å¼€Password Manager<img src="https://nmk0718.github.io/image/jumpserver_open_password.png"></li><li><p>é…ç½®SSHä¼šè¯å¤åˆ¶ã€ä¼šè¯ä¿æŒ<br>åœ¨~/.ssh/configæ–‡ä»¶é‡Œæ·»åŠ å‡ è¡Œé…ç½®å³å¯ã€‚</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¼šè¯å¤åˆ¶ç›¸å…³é…ç½®</span></span><br><span class="line">Host *</span><br><span class="line">ControlMaster auto</span><br><span class="line">ControlPath ~/.ssh/%r@%h:%p.socket</span><br><span class="line"></span><br><span class="line">ControlPersist yes</span><br><span class="line">ServerAliveInterval 10 <span class="comment"># æ¯éš”10så‘ä¸€æ¬¡å¿ƒè·³</span></span><br><span class="line">ServerAliveCountMax 3  <span class="comment"># ä¸‰æ¬¡å¿ƒè·³æ²¡å“åº”åˆ™å…³é—­è¿æ¥</span></span><br></pre></td></tr></table></figure></li><li><p><code>command + o</code>é€‰æ‹©æœåŠ¡å™¨è¿æ¥ï¼Œé…ç½®è‡ªåŠ¨å…³é—­çª—å£</p><img src="https://nmk0718.github.io/image/closewindow.png"></li></ol><p>å‚è€ƒæ–‡æ¡£ï¼š<a href="https://blog.csdn.net/weixin_52777294/article/details/112410350" target="_blank" rel="noopener">https://blog.csdn.net/weixin_52777294/article/details/112410350</a></p><h3 id="rzsz"><a href="#rzsz" class="headerlink" title="rzsz"></a>rzsz</h3><ol><li><p>åœ¨macä¸Šå®‰è£…lrzsz</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">brew install lrzsz</span><br></pre></td></tr></table></figure></li><li><p>å°†iterm2-send-zmodem.shå’Œiterm2-recv-zmodem.shè„šæœ¬ä¿å­˜åœ¨/usr/local/bin/<br>iterm2-recv-zmodem.sh</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Author: Matt Mastracci (matthew@mastracci.com)</span></span><br><span class="line"><span class="comment"># AppleScript from http://stackoverflow.com/questions/4309087/cancel-button-on-osascript-in-a-bash-script</span></span><br><span class="line"><span class="comment"># licensed under cc-wiki with attribution required </span></span><br><span class="line"><span class="comment"># Remainder of script public domain</span></span><br><span class="line"></span><br><span class="line">osascript -e <span class="string">'tell application "iTerm2" to version'</span> &gt; /dev/null 2&gt;&amp;1 &amp;&amp; NAME=iTerm2 || NAME=iTerm</span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$NAME</span> = <span class="string">"iTerm"</span> ]]; <span class="keyword">then</span></span><br><span class="line">FILE=$(osascript -e <span class="string">'tell application "iTerm" to activate'</span> -e <span class="string">'tell application "iTerm" to set thefile to choose folder with prompt "Choose a folder to place received files in"'</span> -e <span class="string">"do shell script (\"echo \"&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\"\")"</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">FILE=$(osascript -e <span class="string">'tell application "iTerm2" to activate'</span> -e <span class="string">'tell application "iTerm2" to set thefile to choose folder with prompt "Choose a folder to place received files in"'</span> -e <span class="string">"do shell script (\"echo \"&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\"\")"</span>)</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$FILE</span> = <span class="string">""</span> ]]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> Cancelled.</span><br><span class="line"><span class="comment"># Send ZModem cancel</span></span><br><span class="line"><span class="built_in">echo</span> -e \\x18\\x18\\x18\\x18\\x18</span><br><span class="line">sleep 1</span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> \<span class="comment"># Cancelled transfer</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">cd</span> <span class="string">"<span class="variable">$FILE</span>"</span></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/rz --rename --escape --binary --bufsize 4096 </span><br><span class="line">sleep 1</span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> \<span class="comment"># Sent \-\&gt; $FILE</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p> iterm2-send-zmodem.sh</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Author: Matt Mastracci (matthew@mastracci.com)</span></span><br><span class="line"><span class="comment"># AppleScript from http://stackoverflow.com/questions/4309087/cancel-button-on-osascript-in-a-bash-script</span></span><br><span class="line"><span class="comment"># licensed under cc-wiki with attribution required </span></span><br><span class="line"><span class="comment"># Remainder of script public domain</span></span><br><span class="line"></span><br><span class="line">osascript -e <span class="string">'tell application "iTerm2" to version'</span> &gt; /dev/null 2&gt;&amp;1 &amp;&amp; NAME=iTerm2 || NAME=iTerm</span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$NAME</span> = <span class="string">"iTerm"</span> ]]; <span class="keyword">then</span></span><br><span class="line">FILE=$(osascript -e <span class="string">'tell application "iTerm" to activate'</span> -e <span class="string">'tell application "iTerm" to set thefile to choose file with prompt "Choose a file to send"'</span> -e <span class="string">"do shell script (\"echo \"&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\"\")"</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">FILE=$(osascript -e <span class="string">'tell application "iTerm2" to activate'</span> -e <span class="string">'tell application "iTerm2" to set thefile to choose file with prompt "Choose a file to send"'</span> -e <span class="string">"do shell script (\"echo \"&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\"\")"</span>)</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$FILE</span> = <span class="string">""</span> ]]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> Cancelled.</span><br><span class="line"><span class="comment"># Send ZModem cancel</span></span><br><span class="line"><span class="built_in">echo</span> -e \\x18\\x18\\x18\\x18\\x18</span><br><span class="line">sleep 1</span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> \<span class="comment"># Cancelled transfer</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/sz <span class="string">"<span class="variable">$FILE</span>"</span> --escape --binary --bufsize 4096</span><br><span class="line">sleep 1</span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> \<span class="comment"># Received "$FILE"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></li><li><p>åœ¨ iTerm 2 ä¸­è®¾ç½®è§¦å‘å™¨<br>Setting &gt;&gt; Profiles &gt;&gt; è‡ªå®šä¹‰çš„Profile &gt;&gt; Advanced &gt;&gt; Tiggers &gt;&gt; Edit</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Regular expression: rz waiting to receive.\*\*B0100</span><br><span class="line">Action: Run Silent Coprocess</span><br><span class="line">Parameters: /usr/local/bin/iterm2-send-zmodem.sh</span><br><span class="line">Instant: checked</span><br><span class="line">Enabled: checked</span><br><span class="line"></span><br><span class="line">Regular expression: \*\*B00000000000000</span><br><span class="line">Action: Run Silent Coprocess</span><br><span class="line">Parameters: /usr/local/bin/iterm2-recv-zmodem.sh</span><br><span class="line">Instant: checked</span><br><span class="line">Enabled: checked</span><br></pre></td></tr></table></figure></li></ol><p>åœ¨æ§åˆ¶å°è¾“å…¥rzï¼Œé€‰æ‹©æœ¬åœ°æœºå™¨ä¸Šè¦å‘é€çš„æ–‡ä»¶ï¼Œå³å¯ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨,sz filenameï¼Œåœ¨æœ¬åœ°æœºå™¨ä¸Šé€‰æ‹©è¦æ¥æ”¶çš„æ–‡ä»¶å¤¹ï¼Œå³å¯ä¸‹è½½åˆ°æœ¬åœ°<br>å‚è€ƒæ–‡æ¡£ï¼š<a href="https://github.com/robberphex/iTerm2-zmodem" target="_blank" rel="noopener">https://github.com/robberphex/iTerm2-zmodem</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;ssh&quot;&gt;&lt;a href=&quot;#ssh&quot; class=&quot;headerlink&quot; title=&quot;ssh&quot;&gt;&lt;/a&gt;ssh&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;iterm2â€”&amp;gt;Preferencesâ€”&amp;gt;Profilesï¼Œé…ç½®ä¸€ä¸ªæ–°çš„profile&lt;/p&gt;
&lt;im</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Windowsçƒ­ç‚¹å…±äº«5Ghz</title>
    <link href="https://nmk0718.github.io/2024/12/24/Windows%E7%83%AD%E7%82%B9%E5%85%B1%E4%BA%AB5Ghz/"/>
    <id>https://nmk0718.github.io/2024/12/24/Windows%E7%83%AD%E7%82%B9%E5%85%B1%E4%BA%AB5Ghz/</id>
    <published>2024-12-24T05:34:00.000Z</published>
    <updated>2025-02-10T04:00:59.703Z</updated>
    
    <content type="html"><![CDATA[<p>èƒŒæ™¯ï¼š</p><ul><li>åŠå…¬ç”µè„‘è¿æ¥officeç½‘ç»œå…±äº«çƒ­ç‚¹ï¼Œè‡ªå¸¦MacBook Proè¿æ¥çƒ­ç‚¹å†…ç½‘åŠå…¬ï¼Œå®ç°ç›´æ¥è®¿é—®å†…ç½‘ä¹Ÿä¸è¢«ç›‘æ§ã€‚é‡åˆ°çš„é—®é¢˜ä¸ºè¿æ¥å…±äº«çƒ­ç‚¹åchromeè®¿é—®é¡µé¢å¾ˆæ…¢.</li></ul><p>è§£å†³æ–¹æ¡ˆ:</p><ul><li>MacBook ProæŒ‰ä½optioné”®,ç‚¹å‡»å³ä¸Šè§’wifiæŒ‰é’®,å¯çœ‹åˆ°ä¸º2.4Ghzé¢‘ç‡</li><li>Windowsæ‰“å¼€è®¾å¤‡ç®¡ç†å™¨,æ‰¾åˆ°wifiçš„è®¾å¤‡ï¼Œå³é”®å±æ€§,æ›´æ”¹ä¸º5Ghz<img src="https://nmk0718.github.io/image/change5g.jpg"></li><li>çƒ­ç‚¹å…±äº«,ç¼–è¾‘é¢‘ç‡,æ”¹ä¸º5Ghz,æ‰“å¼€çƒ­ç‚¹<img src="https://nmk0718.github.io/image/frequency.jpg"></li><li>MacBook Proè¿æ¥å,æ‰“å¼€é¡µé¢å¾ˆå¿«,æŸ¥çœ‹é¢‘ç‡<img src="https://nmk0718.github.io/image/wifi5Ghz.png"></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;èƒŒæ™¯ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åŠå…¬ç”µè„‘è¿æ¥officeç½‘ç»œå…±äº«çƒ­ç‚¹ï¼Œè‡ªå¸¦MacBook Proè¿æ¥çƒ­ç‚¹å†…ç½‘åŠå…¬ï¼Œå®ç°ç›´æ¥è®¿é—®å†…ç½‘ä¹Ÿä¸è¢«ç›‘æ§ã€‚é‡åˆ°çš„é—®é¢˜ä¸ºè¿æ¥å…±äº«çƒ­ç‚¹åchromeè®¿é—®é¡µé¢å¾ˆæ…¢.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è§£å†³æ–¹æ¡ˆ:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;MacBo</summary>
      
    
    
    
    
    <category term="windows" scheme="https://nmk0718.github.io/tag/windows/"/>
    
  </entry>
  
  <entry>
    <title>dockerå®¹å™¨ç›‘æ§</title>
    <link href="https://nmk0718.github.io/2024/11/26/docker%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7/"/>
    <id>https://nmk0718.github.io/2024/11/26/docker%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7/</id>
    <published>2024-11-26T07:45:00.000Z</published>
    <updated>2024-12-27T06:07:20.063Z</updated>
    
    <content type="html"><![CDATA[<h3 id="èƒŒæ™¯ä¿¡æ¯ï¼š"><a href="#èƒŒæ™¯ä¿¡æ¯ï¼š" class="headerlink" title="èƒŒæ™¯ä¿¡æ¯ï¼š"></a>èƒŒæ™¯ä¿¡æ¯ï¼š</h3><blockquote><p>åœ¨ç°ä»£ä¼ä¸šè¿è¥ä¸­ï¼ŒPrometheus å·²è¢«å¹¿æ³›éƒ¨ç½²ç”¨äºç›‘æ§ Kubernetes é›†ç¾¤ã€ä¸­é—´ä»¶ä»¥åŠæœåŠ¡å™¨ï¼Œä»¥å®ç°å¿«é€Ÿçš„é—®é¢˜å®šä½å’Œé¢„è­¦ã€‚å°½ç®¡ Prometheus ä¸ cAdvisor ç»“åˆä½¿ç”¨å¯ä»¥æ”¶é›†ä¸€å°æœºå™¨ä¸Šæ‰€æœ‰è¿è¡Œçš„å®¹å™¨ä¿¡æ¯ï¼Œå¯¹èŠ‚ç‚¹æœºå™¨ä¸Šçš„ CPU ä½¿ç”¨æƒ…å†µã€å†…å­˜ä½¿ç”¨æƒ…å†µã€ç½‘ç»œååé‡åŠæ–‡ä»¶ç³»ç»Ÿä½¿ç”¨æƒ…å†µè¿›è¡Œå®æ—¶ç›‘æ§å’Œæ€§èƒ½æ•°æ®é‡‡é›†ï¼Œä½†è¿™ç§ç›‘æ§æ–¹å¼å­˜åœ¨ä¸€å®šçš„å±€é™æ€§ã€‚åœ¨ç›‘æ§å•ä¸ªä¸»æœºå†…è¿è¡Œå®¹å™¨çš„æœåŠ¡å¥åº·çŠ¶æ€æ–¹é¢å­˜åœ¨ä¸è¶³ã€‚è¿™ç§å±€é™æ€§å¯èƒ½å¯¼è‡´åœ¨æœåŠ¡å‡ºç°æ•…éšœæ—¶æ— æ³•åŠæ—¶æ„ŸçŸ¥ï¼Œå½±å“æœåŠ¡çš„è¿ç»­æ€§å’Œç¨³å®šæ€§</p></blockquote><h3 id="ç›®çš„"><a href="#ç›®çš„" class="headerlink" title="ç›®çš„:"></a>ç›®çš„:</h3><blockquote><p>æœ‰æ•ˆåœ°ç›‘æ§ä¸»æœºå†…è¿è¡Œçš„ Docker å®¹å™¨è¿è¡ŒçŠ¶æ€ï¼Œå»ºç«‹ä¸€ä¸ªå…¨é¢çš„ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿï¼Œé¢„é˜²æœåŠ¡ä¸­æ–­ï¼Œç¡®ä¿æœåŠ¡çš„é«˜å¯ç”¨æ€§å’Œä¸šåŠ¡è¿ç»­æ€§</p></blockquote><h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ:"></a>è§£å†³æ–¹æ¡ˆ:</h3><p>ç¼–å†™GOè„šæœ¬ä½¿ç”¨Docker Engine APIçš„/statsç«¯ç‚¹æ¥è·å–è·å–CPU,å†…å­˜,å®¹å™¨è¿è¡ŒçŠ¶æ€,è¿›ç¨‹æ•°ã€‚ç»“åˆ nvidia_gpu_exporter æ”¶é›† GPU æŒ‡æ ‡ï¼Œå¹¶é€šè¿‡ VictoriaMetrics å’Œ Grafana å®ç°ç›‘æ§ä¸å‘Šè­¦ï¼ˆå› æœ‰çš„å®¹å™¨å†…éœ€è¦æ‰‹åŠ¨æ¿€æ´»ç¯å¢ƒåï¼Œå¯åŠ¨æœåŠ¡ï¼Œæ‰€ä»¥åªç›‘æ§å®¹å™¨çŠ¶æ€ä¸èƒ½ç¡®ä¿å®¹å™¨å­˜æ´»ï¼Œå¯åŠ¨æœåŠ¡ä¸æ˜¯ä¸»è¿›ç¨‹å®¹å™¨ä¸ä¼šæŒ‚æ‰ï¼Œé‡‡ç”¨è¿›ç¨‹çš„æ–¹å¼æ›´åˆç†ï¼‰<br>åºŸå¼ƒæ–¹æ¡ˆ:é€šè¿‡cAdvisorçš„container_processesæŒ‡æ ‡è·å–è¿›ç¨‹æ•°é‡è¿›è¡Œç›‘æ§ï¼Œä½†æ˜¯å‘ç°æ‰‹åŠ¨å®‰è£…çš„æ²¡æœ‰è¯¥æŒ‡æ ‡ï¼Œk8sçš„kubeletæ˜¯æœ‰è¯¥æŒ‡æ ‡çš„ã€‚</p><h4 id="éƒ¨ç½²Docker-process-exporter"><a href="#éƒ¨ç½²Docker-process-exporter" class="headerlink" title="éƒ¨ç½²Docker_process_exporter"></a>éƒ¨ç½²Docker_process_exporter</h4><p>æœºå™¨ipå’Œdockerç‰ˆæœ¬ï¼š<br>10.1.16.250 Version: 24.0.7</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#æŠŠè„šæœ¬ä¸Šä¼ åˆ°æœåŠ¡å™¨ä¸Šæ‰§è¡Œ</span></span><br><span class="line">root@VM-ubuntu:~<span class="comment"># rz</span></span><br><span class="line">root@VM-ubuntu:~<span class="comment"># chmod +x Docker_process_exporter_v24.0.7</span></span><br><span class="line">root@VM-ubuntu:~<span class="comment"># nohup ./Docker_process_exporter_v24.0.7  &amp;</span></span><br></pre></td></tr></table></figure><h4 id="é‡‡é›†çš„æŒ‡æ ‡æ ¼å¼"><a href="#é‡‡é›†çš„æŒ‡æ ‡æ ¼å¼" class="headerlink" title="é‡‡é›†çš„æŒ‡æ ‡æ ¼å¼"></a>é‡‡é›†çš„æŒ‡æ ‡æ ¼å¼</h4><p>ä½¿ç”¨curl <a href="http://localhost:9190/metrics" target="_blank" rel="noopener">http://localhost:9190/metrics</a> å¯ä»¥çœ‹åˆ°å½“å‰é‡‡é›†çš„æŒ‡æ ‡</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#cpuä½¿ç”¨ç‡</span></span><br><span class="line">docker_container_cpu_usage&#123;</span><br><span class="line">    containerId=<span class="string">"142b0b391a1862f101623ba4739afa7e2dd45254fef4344fdf1d37cc2adde3e0"</span>, </span><br><span class="line">    containerName=<span class="string">"ailabel"</span>, </span><br><span class="line">    image=<span class="string">"ailabel:v1.9.5"</span>, </span><br><span class="line">    instance=<span class="string">"10.1.16.250:9190"</span>, </span><br><span class="line">    job=<span class="string">"go-process-exporter"</span>, </span><br><span class="line">    status=<span class="string">"running"</span>, </span><br><span class="line">    vmagent_ha=<span class="string">"victoria-metrics/vmagent-ha"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#å†…å­˜ä½¿ç”¨ç‡</span></span><br><span class="line">docker_container_mem_usage&#123;</span><br><span class="line">    containerId=<span class="string">"142b0b391a1862f101623ba4739afa7e2dd45254fef4344fdf1d37cc2adde3e0"</span>, </span><br><span class="line">    containerName=<span class="string">"ailabel"</span>, </span><br><span class="line">    image=<span class="string">"ailabel:v1.9.5"</span>, </span><br><span class="line">    instance=<span class="string">"10.1.16.250:9190"</span>, </span><br><span class="line">    job=<span class="string">"go-process-exporter"</span>, </span><br><span class="line">    status=<span class="string">"running"</span>, </span><br><span class="line">    vmagent_ha=<span class="string">"victoria-metrics/vmagent-ha"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç£ç›˜ä½¿ç”¨ç‡</span></span><br><span class="line">docker_instance_disk_usage&#123;</span><br><span class="line">    device=<span class="string">"/dev/vda1"</span>, </span><br><span class="line">    instance=<span class="string">"10.1.16.250:9190"</span>, </span><br><span class="line">    job=<span class="string">"go-process-exporter"</span>, </span><br><span class="line">    mountPath=<span class="string">"/"</span>, </span><br><span class="line">    vmagent_ha=<span class="string">"victoria-metrics/vmagent-ha"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#å®¹å™¨è¿è¡ŒçŠ¶æ€</span></span><br><span class="line">docker_container_info&#123;</span><br><span class="line">    containerId=<span class="string">"142b0b391a1862f101623ba4739afa7e2dd45254fef4344fdf1d37cc2adde3e0"</span>, </span><br><span class="line">    containerName=<span class="string">"ailabel"</span>, </span><br><span class="line">    image=<span class="string">"ailabel:v1.9.5"</span>, </span><br><span class="line">    instance=<span class="string">"10.1.16.250:9190"</span>, </span><br><span class="line">    job=<span class="string">"go-process-exporter"</span>,</span><br><span class="line">    status=<span class="string">"running"</span>, </span><br><span class="line">    vmagent_ha=<span class="string">"victoria-metrics/vmagent-ha"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#å®¹å™¨è¿›ç¨‹ä¿¡æ¯</span></span><br><span class="line">docker_container_process_info&#123;</span><br><span class="line">    <span class="built_in">command</span>=<span class="string">"python OpenPCDet/tools/predict_openpcdet_produce.py"</span> </span><br><span class="line">    containerId=<span class="string">"142b0b391a1862f101623ba4739afa7e2dd45254fef4344fdf1d37cc2adde3e0"</span>, </span><br><span class="line">    containerName=<span class="string">"ailabel"</span>, </span><br><span class="line">    image=<span class="string">"ailabel:v1.9.5"</span>, </span><br><span class="line">    instance=<span class="string">"10.1.16.250:9190"</span>, </span><br><span class="line">    job=<span class="string">"go-process-exporter"</span>, </span><br><span class="line">    pid=<span class="string">"14781"</span>, </span><br><span class="line">    vmagent_ha=<span class="string">"victoria-metrics/vmagent-ha"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="é…ç½®é‡‡é›†"><a href="#é…ç½®é‡‡é›†" class="headerlink" title="é…ç½®é‡‡é›†"></a>é…ç½®é‡‡é›†</h4><p>æ–°å»ºjob,æŠŠéœ€è¦ç›‘æ§çš„ä¸»æœºå’Œé‡‡é›†é—´éš”å¡«å†™è¿›å»</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">root@VM-victoria-metrics:~#</span> <span class="string">vi</span> <span class="string">/data/victoria-metrics/vmagent-victoriametrics.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">go-process-exporter</span></span><br><span class="line">      <span class="attr">scrape_interval:</span> <span class="string">15s</span></span><br><span class="line">      <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">['10.1.7.151:9190','10.1.7.67:9190','10.1.16.154:9190','10.1.16.250:9190']</span></span><br></pre></td></tr></table></figure><p>åŠ è½½é…ç½®æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@VM-victoria-metrics:~<span class="comment"># kubectl apply -f vmagent-victoriametrics.yaml -n victoria-metrics</span></span><br><span class="line">vmagent.operator.victoriametrics.com/vmagent-ha unchanged</span><br></pre></td></tr></table></figure><p>éªŒè¯æ˜¯å¦é‡‡é›†</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ä½¿ç”¨victoriametricsçš„vmuié¡µé¢è¿›è¡ŒæŸ¥è¯¢</span><br><span class="line">http://&lt;vmselect&gt;:8481/select/&lt;accountID&gt;/vmui/</span><br><span class="line"></span><br><span class="line">æˆ–è€…ä½¿ç”¨grafanaçš„Exploreè¿›è¡ŒæŸ¥è¯¢</span><br></pre></td></tr></table></figure><h4 id="é…ç½®å›¾è¡¨"><a href="#é…ç½®å›¾è¡¨" class="headerlink" title="é…ç½®å›¾è¡¨"></a>é…ç½®å›¾è¡¨</h4><ul><li><p>é…ç½®å˜é‡<br>é€šè¿‡CVMå˜é‡æ¥è¿‡æ»¤ç›‘æ§çš„æœºå™¨,ContainerNameå˜é‡æ¥è¿‡æ»¤æœºå™¨å†…è¿è¡Œçš„å®¹å™¨<br><br><img src="\image\grafana-cvm.png"><br></p><img src="\image\grafana-containername.png"></li><li><p>é…ç½®é¢æ¿<br>CPUä½¿ç”¨ç‡</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker_container_cpu_usage&#123;instance=<span class="string">"<span class="variable">$CVM</span>:9190"</span>,status=<span class="string">"running"</span>,containerName=<span class="string">"<span class="variable">$ContainerName</span>"</span>&#125;</span><br></pre></td></tr></table></figure><p>  å†…å­˜ä½¿ç”¨ç‡</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker_container_mem_usage&#123;instance=<span class="string">"<span class="variable">$CVM</span>:9190"</span>,status=<span class="string">"running"</span>,containerName=<span class="string">"<span class="variable">$ContainerName</span>"</span>&#125;</span><br></pre></td></tr></table></figure><p>  ç£ç›˜ä½¿ç”¨ç‡</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sum(docker_instance_disk_usage&#123;instance=<span class="string">"<span class="variable">$CVM</span>:9190"</span>&#125;) by (device,mountPath)</span><br></pre></td></tr></table></figure><p>  GPU</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#GPUæ¸©åº¦</span></span><br><span class="line">nvidia_smi_temperature_gpu&#123;instance=<span class="string">"<span class="variable">$CVM</span>:9835"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#GPUæ˜¾å­˜ä½¿ç”¨é‡</span></span><br><span class="line">nvidia_smi_memory_used_bytes&#123;instance=<span class="string">"<span class="variable">$CVM</span>:9835"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#GPUæ˜¾å­˜æ€»é‡</span></span><br><span class="line">nvidia_smi_memory_total_bytes&#123;instance=<span class="string">"<span class="variable">$CVM</span>:9835"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#GPUä½¿ç”¨ç‡</span></span><br><span class="line">(nvidia_smi_memory_used_bytes&#123;instance=<span class="string">"<span class="variable">$CVM</span>:9835"</span>&#125; / nvidia_smi_memory_total_bytes&#123;instance=<span class="string">"<span class="variable">$CVM</span>:9835"</span>&#125;)* 100</span><br></pre></td></tr></table></figure><p>  å®¹å™¨å¼‚å¸¸è¿è¡ŒçŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#é€€å‡ºçŠ¶æ€çš„å®¹å™¨æ¡æ•°</span></span><br><span class="line">count(docker_container_info&#123;instance=<span class="string">"<span class="variable">$CVM</span>:9190"</span>,status=<span class="string">"exited"</span>&#125;) by (status)</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿è¡Œä¸­çŠ¶æ€çš„å®¹å™¨æ¡æ•°</span></span><br><span class="line">count(docker_container_info&#123;instance=<span class="string">"<span class="variable">$CVM</span>:9190"</span>,status=<span class="string">"running"</span>&#125;) by (status)</span><br></pre></td></tr></table></figure><p>  å®¹å™¨è¿è¡Œè¿›ç¨‹æ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#å®¹å™¨å†…å¯åŠ¨çš„å‘½ä»¤+pid+å®¹å™¨åç§°</span></span><br><span class="line">count(docker_container_process_info&#123;instance=<span class="string">"<span class="variable">$CVM</span>:9190"</span>,containerName=<span class="string">"<span class="variable">$ContainerName</span>"</span>&#125;) by (<span class="built_in">command</span>,pid,containerName)</span><br></pre></td></tr></table></figure></li></ul><h3 id="æœ€ç»ˆæ•ˆæœå›¾ï¼š"><a href="#æœ€ç»ˆæ•ˆæœå›¾ï¼š" class="headerlink" title="æœ€ç»ˆæ•ˆæœå›¾ï¼š"></a>æœ€ç»ˆæ•ˆæœå›¾ï¼š</h3><img src="\image\grafana.png">]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;èƒŒæ™¯ä¿¡æ¯ï¼š&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯ä¿¡æ¯ï¼š&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯ä¿¡æ¯ï¼š&quot;&gt;&lt;/a&gt;èƒŒæ™¯ä¿¡æ¯ï¼š&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;åœ¨ç°ä»£ä¼ä¸šè¿è¥ä¸­ï¼ŒPrometheus å·²è¢«å¹¿æ³›éƒ¨ç½²ç”¨äºç›‘æ§ Kubernetes é›†ç¾¤ã€</summary>
      
    
    
    
    
    <category term="docker" scheme="https://nmk0718.github.io/tag/docker/"/>
    
  </entry>
  
  <entry>
    <title>VictoriaMetrics</title>
    <link href="https://nmk0718.github.io/2024/11/25/VictoriaMetrics/"/>
    <id>https://nmk0718.github.io/2024/11/25/VictoriaMetrics/</id>
    <published>2024-11-25T08:30:00.000Z</published>
    <updated>2025-02-10T04:00:59.812Z</updated>
    
    <content type="html"><![CDATA[<p>VictoriaMetrics æ˜¯ä¸€æ¬¾å¿«é€Ÿã€ç»æµé«˜æ•ˆä¸”å¯æ‰©å±•çš„æ—¶é—´åºåˆ—æ•°æ®åº“ã€‚å¯ç”¨ä½œ Prometheus çš„é•¿æœŸè¿œç¨‹å­˜å‚¨ã€‚å¦‚æœæå–ç‡ä½äºæ¯ç§’â€‹â€‹ä¸€ç™¾ä¸‡ä¸ªæ•°æ®ç‚¹ï¼Œå»ºè®®ä½¿ç”¨å•èŠ‚ç‚¹ç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯é›†ç¾¤ç‰ˆæœ¬ã€‚</p><p>VictoriaMetricsé›†ç¾¤ç”±ä»¥ä¸‹æœåŠ¡ç»„æˆï¼š</p><ul><li><code>vmstorage</code> å­˜å‚¨åŸå§‹æ•°æ®å¹¶è¿”å›ç»™å®šæ ‡ç­¾è¿‡æ»¤å™¨åœ¨ç»™å®šæ—¶é—´èŒƒå›´å†…çš„æŸ¥è¯¢æ•°æ®</li><li><code>vminsert</code> æ¥å—é‡‡é›†çš„æ•°æ®ï¼Œå¹¶æ ¹æ®æŒ‡æ ‡åç§°åŠå…¶æ‰€æœ‰æ ‡ç­¾çš„ä¸€è‡´æ€§å“ˆå¸Œï¼Œå°†å…¶ä¼ æ’­åˆ° vmstorage èŠ‚ç‚¹ä¹‹é—´</li><li><code>vmselect</code> é€šè¿‡ä»æ‰€æœ‰é…ç½®çš„ vmstorage èŠ‚ç‚¹è·å–æ‰€éœ€æ•°æ®æ¥æ‰§è¡Œä¼ å…¥æŸ¥è¯¢</li><li><code>vmalert</code> è´Ÿè´£å‘Šè­¦ï¼Œå’Œ Prometheus ä¸€æ ·æ”¯æŒçºªå½•ã€å‘Šè­¦ä¸¤ç§è§„åˆ™é…ç½®ä¸å‘é€å‘Šè­¦é€šçŸ¥ï¼Œå…è®¸åœ¨æ³¨è§£ä¸­ä½¿ç”¨ Go æ¨¡æ¿æ¥æ ¼å¼åŒ–æ•°æ®ã€è¿­ä»£æˆ–æ‰§è¡Œè¡¨è¾¾å¼ï¼Œæ”¯æŒè·¨ç§Ÿæˆ·å‘é€è­¦æŠ¥å’Œè®°å½•è§„åˆ™</li><li><code>vmagent</code> è´Ÿè´£æ•°æ®é‡‡é›†ï¼Œé‡æ–°æ ‡è®°å’Œè¿‡æ»¤æ”¶é›†åˆ°çš„æŒ‡æ ‡ï¼Œå¹¶é€šè¿‡ Prometheus åè®®æˆ–é€šè¿‡ VictoriaMetrics åè®®å°†å®ƒä»¬å­˜å‚¨åœ¨ VictoriaMetrics æˆ–ä»»ä½•å…¶ä»–å­˜å‚¨ç³»ç»Ÿä¸­ã€‚<img src="https://docs.victoriametrics.com/Cluster-VictoriaMetrics_cluster-scheme.webp"></li></ul><p>éƒ¨ç½²å‚è€ƒæ–‡æ¡£ï¼š<br><a href="https://docs.victoriametrics.com/helm/victoriametrics-operator/" target="_blank" rel="noopener">https://docs.victoriametrics.com/helm/victoriametrics-operator/</a><br><a href="https://docs.victoriametrics.com/cluster-victoriametrics/" target="_blank" rel="noopener">https://docs.victoriametrics.com/cluster-victoriametrics/</a><br><a href="https://zhuanlan.zhihu.com/p/715516533" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/715516533</a></p><p>âš ï¸æœ¬æ–‡æ¡£ä¸­çš„æ“ä½œå‡åœ¨æœ¬åœ°è¿›è¡Œï¼Œå¦‚éœ€ç”Ÿäº§éƒ¨ç½²ï¼Œè¯·æŠŠport-forwardè½¬æ¢ä¸ºingressè½¬å‘ï¼Œvmclusterè°ƒæ•´åˆé€‚çš„é…ç½®.</p><h2 id="VictoriaMetrics-Helm-å­˜å‚¨åº“"><a href="#VictoriaMetrics-Helm-å­˜å‚¨åº“" class="headerlink" title="VictoriaMetrics Helm å­˜å‚¨åº“"></a>VictoriaMetrics Helm å­˜å‚¨åº“</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#helmæ·»åŠ repo</span></span><br><span class="line">âœ  ~ helm repo add vm https://victoriametrics.github.io/helm-charts/</span><br><span class="line"><span class="string">"vm"</span> has been added to your repositories</span><br><span class="line"></span><br><span class="line"><span class="comment">#helmæ›´æ–°repo</span></span><br><span class="line">âœ  ~ helm repo update</span><br><span class="line">Hang tight <span class="keyword">while</span> we grab the latest from your chart repositories...</span><br><span class="line">...Successfully got an update from the <span class="string">"aliyun"</span> chart repository</span><br><span class="line">...Successfully got an update from the <span class="string">"vm"</span> chart repository</span><br><span class="line">Update Complete. âˆHappy Helming!âˆ</span><br><span class="line"></span><br><span class="line"><span class="comment">#helmæŸ¥çœ‹ç›¸å…³æœåŠ¡å’Œç‰ˆæœ¬</span></span><br><span class="line">âœ  ~ helm search repo vm/</span><br><span class="line">NAME                           CHART VERSIONAPP VERSIONDESCRIPTION</span><br><span class="line">vm/victoria-logs-single        0.8.2        v1.0.0     Victoria Logs Single version - high-performance...</span><br><span class="line">vm/victoria-metrics-agent      0.14.9       v1.106.1   Victoria Metrics Agent - collects metrics from ...</span><br><span class="line">vm/victoria-metrics-alert      0.12.6       v1.106.1   Victoria Metrics Alert - executes a list of giv...</span><br><span class="line">vm/victoria-metrics-anomaly    1.6.7        v1.18.4    Victoria Metrics Anomaly Detection - a service ...</span><br><span class="line">vm/victoria-metrics-auth       0.7.7        v1.106.1   Victoria Metrics Auth - is a simple auth proxy ...</span><br><span class="line">vm/victoria-metrics-cluster    0.14.12      v1.106.1   Victoria Metrics Cluster version - high-perform...</span><br><span class="line">vm/victoria-metrics-common     0.0.31                  Victoria Metrics Common - contains shared templ...</span><br><span class="line">vm/victoria-metrics-distributed0.5.0        v1.106.1   A Helm chart <span class="keyword">for</span> Running VMCluster on Multiple ...</span><br><span class="line">vm/victoria-metrics-gateway    0.5.7        v1.106.1   Victoria Metrics Gateway - Auth &amp; Rate-Limittin...</span><br><span class="line">vm/victoria-metrics-k8s-stack  0.28.4       v1.106.1   Kubernetes monitoring on VictoriaMetrics stack....</span><br><span class="line">vm/victoria-metrics-operator   0.38.0       v0.49.1    Victoria Metrics Operator</span><br><span class="line">vm/victoria-metrics-single     0.12.7       v1.106.1   Victoria Metrics Single version - high-performa...</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…-VictoriaMetrics-Operator"><a href="#å®‰è£…-VictoriaMetrics-Operator" class="headerlink" title="å®‰è£… VictoriaMetrics-Operator"></a>å®‰è£… VictoriaMetrics-Operator</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#ä½¿ç”¨å‘½ä»¤å®‰è£…</span></span><br><span class="line">âœ  ~ helm install vmo vm/victoria-metrics-operator</span><br><span class="line">NAME: vmo</span><br><span class="line">LAST DEPLOYED: Tue Dec 24 14:38:21 2024</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">victoria-metrics-operator has been installed. Check its status by running:</span><br><span class="line">  kubectl --namespace default get pods -l <span class="string">"app.kubernetes.io/instance=vmo"</span></span><br><span class="line"></span><br><span class="line">Get more information on https://github.com/VictoriaMetrics/helm-charts/tree/master/charts/victoria-metrics-operator.</span><br><span class="line">See <span class="string">"Getting started guide for VM Operator"</span> on https://docs.victoriametrics.com/guides/getting-started-with-vm-operator</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹podçŠ¶æ€</span></span><br><span class="line">âœ  ~ kubectl get pods -A | grep <span class="string">'vmo'</span></span><br><span class="line">default       vmo-victoria-metrics-operator-54bf97548f-fj8j7   1/1     Running   0             1m</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…VictoriaMetrics-Cluster"><a href="#å®‰è£…VictoriaMetrics-Cluster" class="headerlink" title="å®‰è£…VictoriaMetrics Cluster"></a>å®‰è£…VictoriaMetrics Cluster</h2><p>Operator ä¼šæ ¹æ®æˆ‘ä»¬çš„å®šä¹‰å»éƒ¨ç½²é›†ç¾¤,å¯ä»¥é€šè¿‡ kubectl explain VMCluster.spec æ¥æŸ¥çœ‹å¯¹è±¡å¯é…ç½®çš„å±æ€§</p><h4 id="vmcluster-yaml"><a href="#vmcluster-yaml" class="headerlink" title="vmcluster.yaml"></a>vmcluster.yaml</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">operator.victoriametrics.com/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VMCluster</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vmcluster</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">victoria-metrics</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment">#æ•°æ®ä¿ç•™çš„æ—¶é•¿,é»˜è®¤ä¿ç•™æœŸä¸º 1 ä¸ªæœˆï¼Œ é»˜è®¤å•ä½ä¸º m(æœˆ)ï¼Œæ”¯æŒçš„å•ä½æœ‰ h (hour), d (day), w (week), y (year)</span></span><br><span class="line">  <span class="attr">retentionPeriod:</span> <span class="string">"1w"</span></span><br><span class="line">  <span class="comment">#å¼€å¯å‰¯æœ¬ï¼Œå¹¶æ§åˆ¶å‰¯æœ¬æ•°é‡ï¼Œä¼šå¾€å¤šä¸ªvmstorageæ’å…¥åŒä¸€ä»½æ ·æœ¬æ•°æ®</span></span><br><span class="line">  <span class="comment">#replicationFactor: 2</span></span><br><span class="line">  <span class="attr">vmstorage:</span></span><br><span class="line">    <span class="comment">#å‰¯æœ¬æ•°</span></span><br><span class="line">    <span class="attr">replicaCount:</span> <span class="number">2</span></span><br><span class="line">    <span class="comment">#æ•°æ®æŒä¹…åŒ–</span></span><br><span class="line">    <span class="attr">storageDataPath:</span> <span class="string">/vm-data</span></span><br><span class="line">    <span class="attr">storage:</span></span><br><span class="line">      <span class="attr">volumeClaimTemplate:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">storageClassName:</span> <span class="string">cbs</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line">    <span class="comment">#èµ„æºå¤§å°</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">"0.5"</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">500Mi</span></span><br><span class="line">  <span class="attr">vmselect:</span></span><br><span class="line">    <span class="attr">replicaCount:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">cacheMountPath:</span> <span class="string">"/select-cache"</span></span><br><span class="line">    <span class="attr">storage:</span></span><br><span class="line">      <span class="attr">volumeClaimTemplate:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">storageClassName:</span> <span class="string">cbs</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">storage:</span> <span class="string">"2Gi"</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">"0.3"</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">"300Mi"</span></span><br><span class="line">  <span class="attr">vminsert:</span></span><br><span class="line">    <span class="attr">replicaCount:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure><p><code>æ³¨æ„</code>ï¼š</p><ul><li>å¼€å¯replicationFactorï¼Œvmagentä¼šäº§ç”ŸreplicationFactorä»½å†—ä½™æ•°æ®ï¼Œéœ€è¦dedup.minScrapeIntervalå‚æ•°ï¼Œæ¥å»é™¤é‡å¤æ•°æ®ã€‚</li><li>å¼€å¯æˆ–ä¿®æ”¹replicationFactor,å¯èƒ½é€ æˆæ•°æ®éƒ¨åˆ†ä¸¢å¤±ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#æ ¹æ®è‡ªå®šä¹‰çš„é…ç½®è¿›è¡Œå®‰è£…</span></span><br><span class="line">âœ  ~ kubectl apply -f vmcluster.yaml</span><br><span class="line">vmcluster.operator.victoriametrics.com/vmcluster created</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹æ˜¯å¦æ­£å¸¸å¯åŠ¨</span></span><br><span class="line">âœ  ~ kubectl get pods</span><br><span class="line">NAME                                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">vminsert-vmcluster-8587774678-2xxt6              1/1     Running   0          12s</span><br><span class="line">vminsert-vmcluster-8587774678-mplrr              1/1     Running   0          12s</span><br><span class="line">vmo-victoria-metrics-operator-5d4ff4d8f4-gk4gj   1/1     Running   0          3m58s</span><br><span class="line">vmselect-vmcluster-0                             1/1     Running   0          17s</span><br><span class="line">vmselect-vmcluster-1                             1/1     Running   0          17s</span><br><span class="line">vmstorage-vmcluster-0                            1/1     Running   0          23s</span><br><span class="line">vmstorage-vmcluster-1                            1/1     Running   0          23s</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ä¿¡æ¯</span></span><br><span class="line">âœ  ~ kubectl get vmclusters</span><br><span class="line">NAME        INSERT COUNT   STORAGE COUNT   SELECT COUNT   AGE   STATUS</span><br><span class="line">vmcluster   2              2               2              63s   operational</span><br><span class="line"></span><br><span class="line"><span class="comment">#è·å–vminsertæœåŠ¡å</span></span><br><span class="line">âœ  ~ kubectl get svc | grep vminsert</span><br><span class="line">vminsert-vmcluster              ClusterIP   10.105.160.47    &lt;none&gt;        8480/TCP                     6m49s</span><br></pre></td></tr></table></figure><h3 id="vmagent-yaml"><a href="#vmagent-yaml" class="headerlink" title="vmagent.yaml"></a>vmagent.yaml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">operator.victoriametrics.com/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VMAgent</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vmagent</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceScrapeNamespaceSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">podScrapeNamespaceSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">podScrapeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">serviceScrapeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">nodeScrapeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">nodeScrapeNamespaceSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">staticScrapeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">staticScrapeNamespaceSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">replicaCount:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">remoteWrite:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">"http://vminsert-vmcluster.default.svc.cluster.local:8480/insert/0/prometheus/api/v1/write"</span></span><br></pre></td></tr></table></figure><blockquote><p>VMAgentçš„<code>remoteWrite.url</code> ç”±ä»¥ä¸‹éƒ¨åˆ†ç»„æˆï¼š</p><ul><li>â€œservice_name.VMCluster_namespace.svc.kubernetes_cluster_domainâ€<br>åœ¨ä¾‹å­ä¸­ï¼Œå®ƒæ˜¯vminsert-vmcluster.default.svc.cluster.local</li></ul></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#æ ¹æ®è‡ªå®šä¹‰çš„é…ç½®è¿›è¡Œå®‰è£…</span></span><br><span class="line">âœ  ~ kubectl apply -f vmagent.yaml</span><br><span class="line">vmagent.operator.victoriametrics.com/vmagent created</span><br><span class="line"></span><br><span class="line"><span class="comment">#é…ç½®æœ¬åœ°ç«¯å£è½¬å‘è®¿é—®(ç”Ÿäº§ç¯å¢ƒå¯ä½¿ç”¨ingressæˆ–nodeportè½¬å‘è®¿é—®)</span></span><br><span class="line">âœ  ~ kubectl port-forward svc/vmagent-vmagent 8429:8429</span><br><span class="line">Forwarding from 127.0.0.1:8429 -&gt; 8429</span><br><span class="line">Forwarding from [::1]:8429 -&gt; 8429</span><br><span class="line">Handling connection <span class="keyword">for</span> 8429</span><br><span class="line">Handling connection <span class="keyword">for</span> 8429</span><br></pre></td></tr></table></figure><p>åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€<a href="http://127.0.0.1:8429/targets" target="_blank" rel="noopener">http://127.0.0.1:8429/targets</a> æŸ¥çœ‹VMAgentæ˜¯å¦ä» K8s é›†ç¾¤æ”¶é›†æŒ‡æ ‡</p><img src="https://docs.victoriametrics.com/guides/getting-started-with-vm-operator/vmcluster.webp"><h2 id="éªŒè¯-VictoriaMetrics-Cluster"><a href="#éªŒè¯-VictoriaMetrics-Cluster" class="headerlink" title="éªŒè¯ VictoriaMetrics Cluster"></a>éªŒè¯ VictoriaMetrics Cluster</h2><p>è·å–vmselectæœåŠ¡å</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">âœ  ~ kubectl get svc | grep vmselect</span><br><span class="line">vmselect-vmcluster              ClusterIP   None             &lt;none&gt;        8481/TCP                     31m</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…Grafana"><a href="#å®‰è£…Grafana" class="headerlink" title="å®‰è£…Grafana"></a>å®‰è£…Grafana</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">|</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">grafana</span> <span class="string">grafana/grafana</span> <span class="string">-f</span> <span class="bullet">-</span></span><br><span class="line">  <span class="attr">datasources:</span></span><br><span class="line">    <span class="attr">datasources.yaml:</span></span><br><span class="line">      <span class="attr">apiVersion:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">datasources:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">victoriametrics</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">prometheus</span></span><br><span class="line">          <span class="attr">orgId:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">url:</span> <span class="string">http://vmselect-vmcluster.default.svc.cluster.local:8481/select/0/prometheus/</span></span><br><span class="line">          <span class="attr">access:</span> <span class="string">proxy</span></span><br><span class="line">          <span class="attr">isDefault:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">updateIntervalSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">editable:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">dashboardProviders:</span></span><br><span class="line">   <span class="attr">dashboardproviders.yaml:</span></span><br><span class="line">     <span class="attr">apiVersion:</span> <span class="number">1</span></span><br><span class="line">     <span class="attr">providers:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">'default'</span></span><br><span class="line">       <span class="attr">orgId:</span> <span class="number">1</span></span><br><span class="line">       <span class="attr">folder:</span> <span class="string">''</span></span><br><span class="line">       <span class="attr">type:</span> <span class="string">file</span></span><br><span class="line">       <span class="attr">disableDeletion:</span> <span class="literal">true</span></span><br><span class="line">       <span class="attr">editable:</span> <span class="literal">true</span></span><br><span class="line">       <span class="attr">options:</span></span><br><span class="line">         <span class="attr">path:</span> <span class="string">/var/lib/grafana/dashboards/default</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">dashboards:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">victoriametrics:</span></span><br><span class="line">        <span class="attr">gnetId:</span> <span class="number">11176</span></span><br><span class="line">        <span class="attr">revision:</span> <span class="number">18</span></span><br><span class="line">        <span class="attr">datasource:</span> <span class="string">victoriametrics</span></span><br><span class="line">      <span class="attr">vmagent:</span></span><br><span class="line">        <span class="attr">gnetId:</span> <span class="number">12683</span></span><br><span class="line">        <span class="attr">revision:</span> <span class="number">7</span></span><br><span class="line">        <span class="attr">datasource:</span> <span class="string">victoriametrics</span></span><br><span class="line">      <span class="attr">kubernetes:</span></span><br><span class="line">        <span class="attr">gnetId:</span> <span class="number">14205</span></span><br><span class="line">        <span class="attr">revision:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">datasource:</span> <span class="string">victoriametrics</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h2 id="æµè§ˆå™¨éªŒè¯"><a href="#æµè§ˆå™¨éªŒè¯" class="headerlink" title="æµè§ˆå™¨éªŒè¯"></a>æµè§ˆå™¨éªŒè¯</h2><h3 id="grafana"><a href="#grafana" class="headerlink" title="grafana"></a>grafana</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#æŸ¥çœ‹adminå¯†ç </span></span><br><span class="line">âœ  ~ kubectl get secret --namespace default grafana -o jsonpath=<span class="string">"&#123;.data.admin-password&#125;"</span> | base64 --decode ; <span class="built_in">echo</span></span><br><span class="line">wVj5Rdl1BuPClRy5qgxrztsaoE8v0e4m05DU1cUW</span><br><span class="line"><span class="comment">#è½¬å‘é…ç½®æœ¬åœ°ç«¯å£è½¬å‘è®¿é—®</span></span><br><span class="line">âœ  ~ <span class="built_in">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span class="string">"app.kubernetes.io/name=grafana,app.kubernetes.io/instance=grafana"</span> -o jsonpath=<span class="string">"&#123;.items[0].metadata.name&#125;"</span>)</span><br><span class="line">âœ  ~ kubectl --namespace default port-forward <span class="variable">$POD_NAME</span> 3000</span><br><span class="line">Forwarding from 127.0.0.1:3000 -&gt; 3000</span><br><span class="line">Forwarding from [::1]:3000 -&gt; 3000</span><br></pre></td></tr></table></figure><p>è®¿é—®:<code>http://localhost:3000</code><br><img src="https://docs.victoriametrics.com/guides/getting-started-with-vm-operator/vmcluster-grafana1.webp"><br><img src="https://docs.victoriametrics.com/guides/getting-started-with-vm-operator/vmcluster-grafana2.webp"></p><h3 id="vmui"><a href="#vmui" class="headerlink" title="vmui"></a>vmui</h3><p>VictoriaMetrics Clusteræä¾›äº†ç”¨äºæŸ¥è¯¢æ•…éšœæ’é™¤å’Œæ¢ç´¢çš„ UI</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">âœ  ~ kubectl port-forward svc/vmselect-vmcluster 8481:8481</span><br><span class="line">Forwarding from 127.0.0.1:8481 -&gt; 8481</span><br><span class="line">Forwarding from [::1]:8481 -&gt; 8481</span><br></pre></td></tr></table></figure><p>è®¿é—®:<code>http://localhost:8481/select/0/vmui/</code><br><img src="https://nmk0718.github.io/image/vmui.png"></p><h2 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h2><h3 id="ç›‘æ§jvm"><a href="#ç›‘æ§jvm" class="headerlink" title="ç›‘æ§jvm"></a>ç›‘æ§jvm</h3><h4 id="åœ¨dceé›†ç¾¤åˆ›å»ºå‘½åç©ºé—´"><a href="#åœ¨dceé›†ç¾¤åˆ›å»ºå‘½åç©ºé—´" class="headerlink" title="åœ¨dceé›†ç¾¤åˆ›å»ºå‘½åç©ºé—´"></a>åœ¨dceé›†ç¾¤åˆ›å»ºå‘½åç©ºé—´</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#åˆ›å»ºmonitorçš„å‘½åç©ºé—´</span></span><br><span class="line">âœ  ~ kubectl create ns monitor</span><br><span class="line">namespace/monitor created</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹k8sç‰ˆæœ¬</span></span><br><span class="line">âœ  ~ kubectl version --short</span><br><span class="line">Flag --short has been deprecated, and will be removed <span class="keyword">in</span> the future. The --short output will become the default.</span><br><span class="line">Client Version: v1.24.0</span><br><span class="line">Kustomize Version: v4.5.4</span><br><span class="line">Server Version: v1.18.20</span><br><span class="line">WARNING: version difference between client (1.24) and server (1.18) exceeds the supported minor version skew of +/-1</span><br></pre></td></tr></table></figure><h4 id="åœ¨monitorå‘½åç©ºé—´ä¸­åˆ›å»ºserviceaccountï¼š"><a href="#åœ¨monitorå‘½åç©ºé—´ä¸­åˆ›å»ºserviceaccountï¼š" class="headerlink" title="åœ¨monitorå‘½åç©ºé—´ä¸­åˆ›å»ºserviceaccountï¼š"></a>åœ¨monitorå‘½åç©ºé—´ä¸­åˆ›å»ºserviceaccountï¼š</h4><p>ServiceAccount.yaml</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">k8s</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">kube-prometheus</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">1.18</span><span class="number">.20</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºsecret-ä¼šè‡ªåŠ¨åˆ›å»ºtoken"><a href="#åˆ›å»ºsecret-ä¼šè‡ªåŠ¨åˆ›å»ºtoken" class="headerlink" title="åˆ›å»ºsecret,ä¼šè‡ªåŠ¨åˆ›å»ºtoken"></a>åˆ›å»ºsecret,ä¼šè‡ªåŠ¨åˆ›å»ºtoken</h4><p>ï¼ˆk8såœ¨1.24ç‰ˆæœ¬ååˆ›å»ºserviceaccountä¸ä¼šè‡ªåŠ¨åˆ›å»ºç»‘å®šsecretï¼Œéœ€è¦äº‹å…ˆåˆ›å»ºsecretæ¥ç»‘å®šåˆ°serviceaccountï¼‰<br>Secret.yaml</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/service-account.name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-k8s-secret</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/service-account-token</span></span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºcluster-role"><a href="#åˆ›å»ºcluster-role" class="headerlink" title="åˆ›å»ºcluster role"></a>åˆ›å»ºcluster role</h4><p>ClusterRole.yaml</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">k8s</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">kube-prometheus</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">1.18</span><span class="number">.20</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/metrics</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="comment">#- endpointslices  å¯¹äºéœ€è¦å¤„ç†æ•°åƒç”šè‡³æ•°ä¸‡ä¸ªç«¯ç‚¹çš„å¤§å‹æœåŠ¡ï¼Œä½¿ç”¨EndpointSliceå¯ä»¥æä¾›æ›´å¥½çš„æ€§èƒ½å’Œå¯æ‰©å±•æ€§</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br></pre></td></tr></table></figure><h4 id="æˆæƒç»™serviceaccount"><a href="#æˆæƒç»™serviceaccount" class="headerlink" title="æˆæƒç»™serviceaccount"></a>æˆæƒç»™serviceaccount</h4><p>ClusterRoleBinding.yaml</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">k8s</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">kube-prometheus</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">1.18</span><span class="number">.20</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br></pre></td></tr></table></figure><h4 id="åœ¨vmé›†ç¾¤ä¸­åˆ›å»ºå¥½dceé›†ç¾¤çš„comfigmapå¹¶éƒ¨ç½²"><a href="#åœ¨vmé›†ç¾¤ä¸­åˆ›å»ºå¥½dceé›†ç¾¤çš„comfigmapå¹¶éƒ¨ç½²" class="headerlink" title="åœ¨vmé›†ç¾¤ä¸­åˆ›å»ºå¥½dceé›†ç¾¤çš„comfigmapå¹¶éƒ¨ç½²"></a>åœ¨vmé›†ç¾¤ä¸­åˆ›å»ºå¥½dceé›†ç¾¤çš„comfigmapå¹¶éƒ¨ç½²</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#æŸ¥çœ‹prometheus-k8s-secretä¸­çš„token</span></span><br><span class="line">âœ  ~ kubectl get secret prometheus-k8s-secret -n monitor -o yaml | grep token</span><br><span class="line">  token: ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNkltUnVibTFSYUVkbVdtTlBUR2hzZHpVd1dEZE9UVWhhZFdKdlJVZHpaMDV2Y1hOcmFqTnNTM1ZVYUhNaWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUp0YjI1cGRHOXlJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbkJ5YjIxbGRHaGxkWE10YXpoekxYTmxZM0psZENJc0ltdDFZbVZ5Ym1WMFpYTXVhVzh2YzJWeWRtbGpaV0ZqWTI5MWJuUXZjMlZ5ZG1salpTMWhZMk52ZFc1MExtNWhiV1VpT2lKd2NtOXRaWFJvWlhWekxXczRjeUlzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJak5rTWpJd01qQm1MVEZsTXpjdE5EaGxaQzFpTVRkbExUazVOMlEwWVRSbVpUUTVOU0lzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwdGIyNXBkRzl5T25CeWIyMWxkR2hsZFhNdGF6aHpJbjAuaVFGRjI3N3U5MGEtODR4aGR0dXVPeUdvWWdZRGpTNWJOQkhEVm1lSUZ3blVqMy1zY3U1RkJfTjhjYVc3d1JhUXNjaDN6Tk0tbWwwSVZUbXRSNjVFREZxVTNiRV85SGlKS1R1UlFfb2NUTVRjQUJKT3I5YnotY19IMFNsSlJlSUN6dlVlM0M1SUxhV2JERkJSRGxfVlRKTXBhVjMxZTlacXN6YTVMRGE5MkJDYldoaldzd2tOR1pSOUppeFVwTW1Mb2dKZFN2Nm0wcjFxelQwU2NjeEw2STRSa2JEUkhDZ1p5ZlhKc1Y3T1d5cmdoT0dwX2FJYTdJUHItbC00dEV0cGhoTFd4MjJMTWFFOW5odkJCZ2dHUVR4a2VDcEY1MWRjSzAtQ3phTjNWV1htckNHajJyT1BzTXdzaVdsOHJ3bk1BdmhYdmVaSGRCVFYwT2dQYkVkWXF3</span><br><span class="line">      &#123;<span class="string">"apiVersion"</span>:<span class="string">"v1"</span>,<span class="string">"kind"</span>:<span class="string">"Secret"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;<span class="string">"kubernetes.io/service-account.name"</span>:<span class="string">"prometheus-k8s"</span>&#125;,<span class="string">"name"</span>:<span class="string">"prometheus-k8s-secret"</span>,<span class="string">"namespace"</span>:<span class="string">"monitor"</span>&#125;,<span class="string">"type"</span>:<span class="string">"kubernetes.io/service-account-token"</span>&#125;</span><br><span class="line"><span class="built_in">type</span>: kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¯¹tokenè¿›è¡Œbase64è§£å¯†</span></span><br><span class="line">âœ  ~ <span class="built_in">echo</span> <span class="string">"ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNkltUnVibTFSYUVkbVdtTlBUR2hzZHpVd1dEZE9UVWhhZFdKdlJVZHpaMDV2Y1hOcmFqTnNTM1ZVYUhNaWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUp0YjI1cGRHOXlJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbkJ5YjIxbGRHaGxkWE10YXpoekxYTmxZM0psZENJc0ltdDFZbVZ5Ym1WMFpYTXVhVzh2YzJWeWRtbGpaV0ZqWTI5MWJuUXZjMlZ5ZG1salpTMWhZMk52ZFc1MExtNWhiV1VpT2lKd2NtOXRaWFJvWlhWekxXczRjeUlzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJak5rTWpJd01qQm1MVEZsTXpjdE5EaGxaQzFpTVRkbExUazVOMlEwWVRSbVpUUTVOU0lzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwdGIyNXBkRzl5T25CeWIyMWxkR2hsZFhNdGF6aHpJbjAuaVFGRjI3N3U5MGEtODR4aGR0dXVPeUdvWWdZRGpTNWJOQkhEVm1lSUZ3blVqMy1zY3U1RkJfTjhjYVc3d1JhUXNjaDN6Tk0tbWwwSVZUbXRSNjVFREZxVTNiRV85SGlKS1R1UlFfb2NUTVRjQUJKT3I5YnotY19IMFNsSlJlSUN6dlVlM0M1SUxhV2JERkJSRGxfVlRKTXBhVjMxZTlacXN6YTVMRGE5MkJDYldoaldzd2tOR1pSOUppeFVwTW1Mb2dKZFN2Nm0wcjFxelQwU2NjeEw2STRSa2JEUkhDZ1p5ZlhKc1Y3T1d5cmdoT0dwX2FJYTdJUHItbC00dEV0cGhoTFd4MjJMTWFFOW5odkJCZ2dHUVR4a2VDcEY1MWRjSzAtQ3phTjNWV1htckNHajJyT1BzTXdzaVdsOHJ3bk1BdmhYdmVaSGRCVFYwT2dQYkVkWXF3"</span> |base64 --decode</span><br></pre></td></tr></table></figure><p>æŠŠä¸Šé¢base64 è§£å¯†åæ–‡ä»¶å†™åœ¨å¦‚ä¸‹ tokené‡Œ<br>dce-token-configmap.yaml</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">token:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">eyJhbGciOiJSUzI1NiIsImtpZCI6ImRubm1RaEdmWmNPTGhsdzUwWDdOTUhadWJvRUdzZ05vcXNrajNsS3VUaHMifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJtb25pdG9yIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6InByb21ldGhldXMtazhzLXNlY3JldCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJwcm9tZXRoZXVzLWs4cyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjNkMjIwMjBmLTFlMzctNDhlZC1iMTdlLTk5N2Q0YTRmZTQ5NSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDptb25pdG9yOnByb21ldGhldXMtazhzIn0.iQFF277u90a-84xhdtuuOyGoYgYDjS5bNBHDVmeIFwnUj3-scu5FB_N8caW7wRaQsch3zNM-ml0IVTmtR65EDFqU3bE_9HiJKTuRQ_ocTMTcABJOr9bz-c_H0SlJReICzvUe3C5ILaWbDFBRDl_VTJMpaV31e9Zqsza5LDa92BCbWhjWswkNGZR9JixUpMmLogJdSv6m0r1qzT0SccxL6I4RkbDRHCgZyfXJsV7OWyrghOGp_aIa7IPr-l-4tEtphhLWx22LMaE9nhvBBggGQTxkeCpF51dcK0-CzaN3VWXmrCGj2rOPsMwsiWl8rwnMAvhXveZHdBTV0OgPbEdYqw</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dce-token-configmap</span></span><br></pre></td></tr></table></figure><p>éƒ¨ç½²dce-token-configmap </p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ  ~ kubectl apply -f dce-token-configmap.yaml</span><br><span class="line">configmap/dce-token-configmap created</span><br></pre></td></tr></table></figure><h4 id="åœ¨vmagent-yamlæ–‡ä»¶é…ç½®é‡‡é›†æŒ‡æ ‡ç­–ç•¥"><a href="#åœ¨vmagent-yamlæ–‡ä»¶é…ç½®é‡‡é›†æŒ‡æ ‡ç­–ç•¥" class="headerlink" title="åœ¨vmagent.yamlæ–‡ä»¶é…ç½®é‡‡é›†æŒ‡æ ‡ç­–ç•¥"></a>åœ¨vmagent.yamlæ–‡ä»¶é…ç½®é‡‡é›†æŒ‡æ ‡ç­–ç•¥</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">operator.victoriametrics.com/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VMAgent</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vmagent</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment">#æŠ“å–æŒ‡æ ‡çš„æ—¶é—´é—´éš”</span></span><br><span class="line">  <span class="attr">scrapeInterval:</span> <span class="string">20s</span></span><br><span class="line">  <span class="comment">#vmagentå‰¯æœ¬æ•°é‡</span></span><br><span class="line">  <span class="attr">replicaCount:</span> <span class="number">1</span></span><br><span class="line">  <span class="comment">#èµ„æºå¤§å°</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="number">4</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">8Gi</span></span><br><span class="line">    <span class="attr">limits:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="number">4</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">8Gi</span></span><br><span class="line">  <span class="comment">#æŒ‚è½½dce-token</span></span><br><span class="line">  <span class="attr">volumeMounts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/dce-token/</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dce-token</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">dce-token-configmap</span> </span><br><span class="line">    <span class="attr">name:</span> <span class="string">dce-token</span></span><br><span class="line">  <span class="comment">#è¿œç¨‹å†™å…¥</span></span><br><span class="line">  <span class="attr">remoteWrite:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">"http://vminsert-vmcluster.default.svc.cluster.local:8480/insert/0/prometheus/api/v1/write"</span></span><br><span class="line">  <span class="attr">inlineScrapeConfig:</span> <span class="string">|</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">dce-jvm-exporter</span></span><br><span class="line">      <span class="comment">#æ˜¯å¦å°Šé‡æŒ‡æ ‡çš„æ—¶é—´æˆ³</span></span><br><span class="line">      <span class="attr">honor_timestamps:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment">#æŠ“å–æŒ‡æ ‡çš„æ—¶é—´é—´éš”</span></span><br><span class="line">      <span class="attr">scrape_interval:</span> <span class="string">20s</span></span><br><span class="line">      <span class="comment">#æŠ“å–æŒ‡æ ‡çš„è¶…æ—¶æ—¶é—´</span></span><br><span class="line">      <span class="attr">scrape_timeout:</span> <span class="string">30s</span></span><br><span class="line">      <span class="comment">#æŠ“å–çš„æŒ‡æ ‡è·¯å¾„</span></span><br><span class="line">      <span class="attr">metrics_path:</span> <span class="string">/actuator/prometheus</span></span><br><span class="line">      <span class="comment">#æŠ“å–åè®®</span></span><br><span class="line">      <span class="attr">scheme:</span> <span class="string">http</span></span><br><span class="line">      <span class="comment">#æŒ‡å®šè®¤è¯çš„ç”¨æˆ·åå’Œå¯†ç </span></span><br><span class="line">      <span class="attr">basic_auth:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">'actuator'</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">'actuator%2@nmk!@#'</span></span><br><span class="line">      <span class="comment">#è·³è¿‡ TLS è¯ä¹¦éªŒè¯</span></span><br><span class="line">      <span class="attr">tls_config:</span></span><br><span class="line">        <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="comment">#Kubernetes API æœåŠ¡å™¨åœ°å€</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">api_server:</span> <span class="string">https://10.30.150.11:16443</span></span><br><span class="line">        <span class="comment">#æŒ‡å®šè¦å‘ç°çš„èµ„æºç±»å‹(endpointsï¼Œserviceï¼Œpodï¼Œnodeï¼Œingress)</span></span><br><span class="line">        <span class="attr">role:</span> <span class="string">pod</span></span><br><span class="line">        <span class="comment">#é…ç½®è®¿é—® Kubernetes API çš„è®¤è¯å’Œ TLS è®¾ç½®</span></span><br><span class="line">        <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/dce-token/token</span></span><br><span class="line">        <span class="attr">tls_config:</span></span><br><span class="line">          <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span></span><br><span class="line">          <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">"true"</span></span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">          <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_pod_annotation_prometheus_io_path]</span></span><br><span class="line">          <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__address__,</span> <span class="string">__meta_kubernetes_pod_annotation_prometheus_io_port]</span></span><br><span class="line">          <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1:$2</span></span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">__meta_kubernetes_pod_label_(.+)</span></span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">          <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_namespace]</span></span><br><span class="line">          <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">(.*)</span></span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_pod_name]</span></span><br><span class="line">          <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">(.*)</span></span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">kubernetes_pod_name</span></span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span></span><br></pre></td></tr></table></figure><p>relabel_configs: è¿‡æ»¤å’Œé‡å†™ç›®æ ‡æ ‡ç­¾</p><ol><li>source_labels: æŒ‡å®šç”¨äºåŒ¹é…çš„æºæ ‡ç­¾åˆ—è¡¨</li><li>separator: æŒ‡å®šåˆ†éš”ç¬¦</li><li>regex: ç”¨äºåŒ¹é… source_labels æå–çš„å€¼çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œé»˜è®¤ä¸ºåŒ¹é…ä»»æ„å€¼ï¼ˆ.*ï¼‰</li><li>replacement: ç”¨äºæ›¿æ¢æ“ä½œçš„å€¼</li><li>actionï¼šå®šä¹‰äº†å¯¹æ ‡ç­¾çš„å¤„ç†æ–¹å¼ï¼ŒåŒ…æ‹¬ï¼š<ul><li>replaceï¼šæ ¹æ® regex åŒ¹é… source_labels çš„å€¼ï¼Œå¹¶å°†å…¶å†™å…¥ target_label</li><li>keepï¼šä»…ä¿ç•™åŒ¹é… regex çš„æ ‡ç­¾ï¼Œå…¶ä½™çš„å°†è¢«ä¸¢å¼ƒ</li><li>dropï¼šä¸¢å¼ƒåŒ¹é… regex çš„æ ‡ç­¾ï¼Œä¿ç•™å…¶ä½™çš„</li><li>labelmapï¼šæ ¹æ® regex åŒ¹é… Target å®ä¾‹æ‰€æœ‰æ ‡ç­¾çš„åç§°ï¼Œå¹¶ä»¥åŒ¹é…åˆ°çš„å†…å®¹ä¸ºæ–°çš„æ ‡ç­¾åç§°ï¼Œå…¶å€¼ä½œä¸ºæ–°æ ‡ç­¾çš„å€¼</li><li>labeldropï¼šç§»é™¤åŒ¹é… regex è§„åˆ™çš„æ ‡ç­¾</li><li>labelkeepï¼šç§»é™¤ä¸åŒ¹é… regex è§„åˆ™çš„æ ‡ç­¾ï¼Œä¿ç•™åŒ¹é…çš„</li></ul></li></ol><p>è¦ç›‘æ§çš„Pod ä¸­éœ€è¦æœ‰ä»¥ä¸‹æ³¨è§£æ‰èƒ½æ­£å¸¸é‡‡é›†</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">annotations:</span><br><span class="line">        prometheus.io/path: /actuator/prometheus</span><br><span class="line">        prometheus.io/port: &quot;20001&quot;</span><br><span class="line">        prometheus.io/scrape: &quot;true&quot;</span><br></pre></td></tr></table></figure><h4 id="åŠ è½½é…ç½®æ–‡ä»¶ï¼š"><a href="#åŠ è½½é…ç½®æ–‡ä»¶ï¼š" class="headerlink" title="åŠ è½½é…ç½®æ–‡ä»¶ï¼š"></a>åŠ è½½é…ç½®æ–‡ä»¶ï¼š</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ  ~ kubectl apply -f vmagent.yaml</span><br><span class="line">vmagent.operator.victoriametrics.com/vmagent configured</span><br></pre></td></tr></table></figure><h4 id="vmagentæŸ¥çœ‹é…ç½®æ˜¯å¦ç”Ÿæ•ˆï¼š"><a href="#vmagentæŸ¥çœ‹é…ç½®æ˜¯å¦ç”Ÿæ•ˆï¼š" class="headerlink" title="vmagentæŸ¥çœ‹é…ç½®æ˜¯å¦ç”Ÿæ•ˆï¼š"></a>vmagentæŸ¥çœ‹é…ç½®æ˜¯å¦ç”Ÿæ•ˆï¼š</h4><img src="https://nmk0718.github.io/image/vmagent-jvm.jpg"><h4 id="GrafanaæŸ¥çœ‹é¢æ¿"><a href="#GrafanaæŸ¥çœ‹é¢æ¿" class="headerlink" title="GrafanaæŸ¥çœ‹é¢æ¿"></a>GrafanaæŸ¥çœ‹é¢æ¿</h4><p>æ‰“å¼€Grafana,åœ¨Dashboardsä¸­importé¢æ¿ID:4701<br><img src="https://nmk0718.github.io/image/vm-jvm.png"></p><h3 id="ç›‘æ§k8sé›†ç¾¤çŠ¶æ€"><a href="#ç›‘æ§k8sé›†ç¾¤çŠ¶æ€" class="headerlink" title="ç›‘æ§k8sé›†ç¾¤çŠ¶æ€"></a>ç›‘æ§k8sé›†ç¾¤çŠ¶æ€</h3><h4 id="kube-state-metrics"><a href="#kube-state-metrics" class="headerlink" title="kube-state-metrics"></a>kube-state-metrics</h4><p>é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬ï¼Œè¿›è¡Œå®‰è£…éƒ¨ç½²<br><a href="https://github.com/kubernetes/kube-state-metrics" target="_blank" rel="noopener">https://github.com/kubernetes/kube-state-metrics</a></p><p>é‡‡é›†å¤–éƒ¨é›†ç¾¤éœ€è¦æŠŠkube-state-metricsçš„serviceæ”¹ä¸ºNodePort</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- job_name: dce-kube-state-metrics</span><br><span class="line">  honor_timestamps: true</span><br><span class="line">  scrape_interval: 15s</span><br><span class="line">  metrics_path: &apos;/metrics&apos;</span><br><span class="line">  scheme: http</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets: [&apos;10.30.150.1:33987&apos;]</span><br><span class="line">  #æŒ‡æ ‡è¿‡å¤§æ—¶å¯ä½¿ç”¨</span><br><span class="line">  params:</span><br><span class="line">  max_scrape_size: 33554432</span><br></pre></td></tr></table></figure><h4 id="cAdvisor"><a href="#cAdvisor" class="headerlink" title="cAdvisor"></a>cAdvisor</h4><p>âš ï¸å¿…é¡»è¦ä¸¤ä¸ªbearer_token_fileï¼Œä¸€ä¸ªè®¤è¯apiserverï¼Œä¸€ä¸ªé€šè¿‡apiserverè¿›è¡ŒcAdvisoré‡‡é›†æŒ‡æ ‡</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- job_name: dce-cadvisor</span><br><span class="line">  metrics_path: /metrics</span><br><span class="line">  scheme: https</span><br><span class="line">  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/dce-token/token</span><br><span class="line">  tls_config:</span><br><span class="line">    insecure_skip_verify: true</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - api_server: https://10.30.150.11:16443</span><br><span class="line">    role: node</span><br><span class="line">    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/dce-token/token</span><br><span class="line">    tls_config:</span><br><span class="line">      insecure_skip_verify: true</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_node_label_(.*)</span><br><span class="line">  - target_label: __address__</span><br><span class="line">    action: replace</span><br><span class="line">    regex: (.*)</span><br><span class="line">    source_labels: [&quot;__address__&quot;]</span><br><span class="line">    replacement: 10.30.150.11:16443</span><br><span class="line">  - source_labels: [__meta_kubernetes_node_name]</span><br><span class="line">    regex: (.*)</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: __metrics_path__</span><br><span class="line">    replacement: /api/v1/nodes/$&#123;1&#125;/proxy/metrics/cadvisor</span><br><span class="line">  metric_relabel_configs:</span><br><span class="line">  - source_labels: [instance]</span><br><span class="line">    separator: ;</span><br><span class="line">    regex: (.+)</span><br><span class="line">    target_label: node</span><br><span class="line">    replacement: $1</span><br><span class="line">    action: replace</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹å¤§ç›˜<br>æ‰“å¼€Grafana,åœ¨Dashboardsä¸­importé¢æ¿ID:13105<br><img src="https://nmk0718.github.io/image/vm-k8s.png"></p><h4 id="Node-Exporter"><a href="#Node-Exporter" class="headerlink" title="Node-Exporter"></a>Node-Exporter</h4><p>é›†ç¾¤å†…éƒ¨å¯é€šè¿‡VMNodeScrapeèµ„æºå¯¹è±¡è¿›è¡Œé…ç½®,è¯¥èµ„æºå¯¹è±¡ä¸æ”¯æŒapiserverå‚æ•°ï¼Œæ‰€ä»¥æ— æ³•é‡‡é›†å¤–éƒ¨é›†ç¾¤çš„ä¿¡æ¯<br>VMNodeScrape.yaml</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">operator.victoriametrics.com/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VMNodeScrape</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/metrics</span></span><br><span class="line">  <span class="attr">port:</span> <span class="string">"9111"</span> <span class="comment"># æŒ‡å®š node-exporter çš„ç«¯å£</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">15s</span></span><br><span class="line">  <span class="comment"># relabelConfigsï¼š  # relabelé…ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰</span></span><br><span class="line">  <span class="comment"># selector:  # è¿‡æ»¤èŠ‚ç‚¹ï¼ˆå¦‚æœéœ€è¦ï¼‰'</span></span><br></pre></td></tr></table></figure><p>é›†ç¾¤å¤–éƒ¨é€šè¿‡Vmagentè¿›è¡Œé‡‡é›†<br>âš ï¸é€šè¿‡node-exporterçš„serviceæ”¹ä¸ºnodeportè¿›è¡Œé‡‡é›†åªæœ‰ä¸€å°å®ä¾‹æ•°æ®ï¼Œæ‰€ä»¥æ”¹ä¸ºå¤štargetsé‡‡é›†</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- job_name: dce-node-exporter</span><br><span class="line">      honor_timestamps: true</span><br><span class="line">      scrape_interval: 15s</span><br><span class="line">      metrics_path: &apos;/metrics&apos;</span><br><span class="line">      scheme: http</span><br><span class="line">      static_configs:</span><br><span class="line">      - targets: [&apos;10.30.150.1:12921&apos;,&apos;10.30.150.2:12921&apos;,&apos;10.30.150.3:12921&apos;,&apos;10.30.150.4:12921&apos;,&apos;10.30.150.5:12921&apos;,&apos;10.30.150.6:12921&apos;,&apos;10.30.150.8:12921&apos;,&apos;10.30.150.9:12921&apos;,&apos;10.30.150.10:12921&apos;]</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹å¤§ç›˜<br>æ‰“å¼€Grafana,åœ¨Dashboardsä¸­importé¢æ¿ID:16098<br><img src="https://nmk0718.github.io/image/vm-nodeexporter.png"></p><h3 id="Vmalert"><a href="#Vmalert" class="headerlink" title="Vmalert"></a>Vmalert</h3><p>vmalertåœ¨å†…å­˜ä¸­ä¿å­˜è­¦æŠ¥çŠ¶æ€ã€‚é‡æ–°å¯åŠ¨è¯¥vmalertè¿›ç¨‹å°†é‡ç½®å†…å­˜ä¸­æ‰€æœ‰æ´»åŠ¨è­¦æŠ¥çš„çŠ¶æ€ã€‚ä¸ºé˜²æ­¢vmalertåœ¨é‡æ–°å¯åŠ¨æ—¶ä¸¢å¤±,é€šè¿‡<code>-remote.write.url</code>å’Œ<code>-remote.read.url</code>å°†å…¶é…ç½®ä¸ºå°†çŠ¶æ€æŒä¹…ä¿å­˜åˆ°è¿œç¨‹æ•°æ®åº“</p><h4 id="å®‰è£…vmalertå’Œalert-manager"><a href="#å®‰è£…vmalertå’Œalert-manager" class="headerlink" title="å®‰è£…vmalertå’Œalert manager"></a>å®‰è£…vmalertå’Œalert manager</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">|</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">vma</span> <span class="string">vm/victoria-metrics-alert</span> <span class="string">-f</span> <span class="bullet">-</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">datasource:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">http://vmselect-vmcluster.default.svc:8481/select/0/prometheus</span></span><br><span class="line">    <span class="attr">remote:</span></span><br><span class="line">      <span class="attr">write:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">http://vminsert-vmcluster.default.svc:8480/insert/0/prometheus</span></span><br><span class="line">      <span class="attr">read:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">http://vmselect-vmcluster.default.svc:8481/select/0/prometheus</span></span><br><span class="line">      <span class="attr">notifier:</span></span><br><span class="line">        <span class="attr">alertmanager:</span></span><br><span class="line">          <span class="attr">url:</span> <span class="string">http://vma-victoria-metrics-alert-alertmanager.default.svc:9093</span></span><br><span class="line">  <span class="attr">alertmanager:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h4 id="é…ç½®alert-manager"><a href="#é…ç½®alert-manager" class="headerlink" title="é…ç½®alert manager"></a>é…ç½®alert manager</h4><p>kubectl edit configmap vma-victoria-metrics-alert-alertmanager-config</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">global:</span><br><span class="line">  smtp_smarthost: &apos;smtp.qq.com:465&apos;</span><br><span class="line">  smtp_from: &apos;2977358239@qq.com&apos;</span><br><span class="line">  smtp_auth_username: &apos;2977358239@qq.com&apos;</span><br><span class="line">  smtp_auth_password: &apos;jgigqzrlhycddhcf&apos; # è¿™é‡Œæ˜¯é‚®ç®±çš„æˆæƒå¯†ç ï¼Œä¸æ˜¯ç™»å½•å¯†ç </span><br><span class="line">  smtp_require_tls: false</span><br><span class="line">templates:</span><br><span class="line">  - &apos;/alertmanager/template/*.tmpl&apos;</span><br><span class="line">route:</span><br><span class="line">  group_by: [&apos;severity&apos;, &apos;source&apos;]</span><br><span class="line">  group_wait: 30s</span><br><span class="line">  group_interval: 5m</span><br><span class="line">  repeat_interval: 10m</span><br><span class="line">  receiver: email</span><br><span class="line">receivers:</span><br><span class="line">- name: &apos;email&apos;</span><br><span class="line">  email_configs:</span><br><span class="line">  - to: &apos;nimingkun@ruqimobility.com&apos;</span><br><span class="line">    send_resolved: true</span><br></pre></td></tr></table></figure><h4 id="é…ç½®vmalert"><a href="#é…ç½®vmalert" class="headerlink" title="é…ç½®vmalert"></a>é…ç½®vmalert</h4><p>kubectl edit configmap vma-victoria-metrics-alert-server-alert-rules-config</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">groups:</span><br><span class="line">- name: record</span><br><span class="line">  rules:</span><br><span class="line">  - record: job:node_memory_MemFree_bytes:percent  # è®°å½•è§„åˆ™åç§°</span><br><span class="line">    expr: 100 - (100 * node_memory_MemFree_bytes / node_memory_MemTotal_bytes)</span><br><span class="line">- name: node</span><br><span class="line">  rules:  # å…·ä½“çš„æŠ¥è­¦è§„åˆ™</span><br><span class="line">  - alert: NodeMemoryUsage  # æŠ¥è­¦è§„åˆ™çš„åç§°</span><br><span class="line">    expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100 &gt; 30</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      source: node</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Node &#123;&#123;$labels.instance&#125;&#125; High Memory usage detected&quot;</span><br><span class="line">      description: &quot;&#123;&#123;$labels.instance&#125;&#125;: Memory usage is above 30% (current value is: &#123;&#123; $value &#125;&#125;)&quot;</span><br></pre></td></tr></table></figure><p>recordè§„åˆ™å•ç‹¬ä½¿ç”¨ï¼Œä¸èƒ½ä¸alertè§„åˆ™æ··åˆï¼Œrecordè§„åˆ™ä¸éœ€è¦alertã€forã€labelså’Œannotationså­—æ®µ<br>record è®°å½•è§„åˆ™çš„ä¸»è¦ä½œç”¨æ˜¯å°†ä¸€ä¸ªç»™å®šçš„è¡¨è¾¾å¼çš„ç»“æœä¿å­˜ä¸ºä¸€ä¸ªæ–°çš„æ—¶é—´åºåˆ—ï¼Œè¿™æ ·å¯ä»¥åœ¨Grafanaç­‰å¯è§†åŒ–å·¥å…·ä¸­ç›´æ¥ä½¿ç”¨è¿™äº›æ•°æ®ï¼Œè€Œä¸éœ€è¦æ¯æ¬¡éƒ½é‡æ–°è®¡ç®—è¡¨è¾¾å¼ã€‚</p><h4 id="alerté¡µé¢æŸ¥çœ‹æ˜¯å¦æ­£å¸¸"><a href="#alerté¡µé¢æŸ¥çœ‹æ˜¯å¦æ­£å¸¸" class="headerlink" title="alerté¡µé¢æŸ¥çœ‹æ˜¯å¦æ­£å¸¸"></a>alerté¡µé¢æŸ¥çœ‹æ˜¯å¦æ­£å¸¸</h4><p>kubectl port-forward svc/vma-victoria-metrics-alert-server 8880:8880</p><p>æŸ¥çœ‹æ‰€æœ‰çš„ Groups<br><img src="https://nmk0718.github.io/image/vmalert_group.png"><br>æŸ¥çœ‹æŠ¥è­¦è§„åˆ™åˆ—è¡¨çš„çŠ¶æ€<br><img src="https://nmk0718.github.io/image/vmalert_state.png"><br>æŸ¥çœ‹æŠ¥è­¦è§„åˆ™çš„è¯¦ç»†ä¿¡æ¯<br><img src="https://nmk0718.github.io/image/vmalert_details.png"><br>æŸ¥çœ‹é‚®ç®±(âš ï¸éœ€ç¡®ä¿å‘ä»¶é‚®ç®±çš„éªŒè¯ç æ­£ç¡®)<br><img src="https://nmk0718.github.io/image/alertmanager_mail.png"></p><p>æˆ‘ä»¬æ·»åŠ çš„è®°å½•è§„åˆ™ä¼šé€šè¿‡ remote write ä¼ é€’ç»™ vminsert ä¿ç•™ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ vmselect æŸ¥è¯¢åˆ°<br><img src="https://nmk0718.github.io/image/vmui_select_record.png"></p><h4 id="æ’æŸ¥è¿‡æ»¤æŸäº›æŠ“å–æŒ‡æ ‡è¿‡é•¿å¯¼è‡´å¡ä¸»é—®é¢˜"><a href="#æ’æŸ¥è¿‡æ»¤æŸäº›æŠ“å–æŒ‡æ ‡è¿‡é•¿å¯¼è‡´å¡ä¸»é—®é¢˜" class="headerlink" title="æ’æŸ¥è¿‡æ»¤æŸäº›æŠ“å–æŒ‡æ ‡è¿‡é•¿å¯¼è‡´å¡ä¸»é—®é¢˜"></a>æ’æŸ¥è¿‡æ»¤æŸäº›æŠ“å–æŒ‡æ ‡è¿‡é•¿å¯¼è‡´å¡ä¸»é—®é¢˜</h4><p>å…ˆå»æŸ¥çœ‹vmstorage-vmcluster  vmstorageç»„ä»¶çš„æ—¥å¿—ï¼Œæ‰¾åˆ°é‚£æ¡æŒ‡æ ‡å½±å“äº†<br>è¿‡æ»¤customeræœåŠ¡çš„æŒ‡æ ‡æ”¶é›†ï¼Œåœ¨ç›¸åº”çš„jobé‡‡é›†ä»»åŠ¡ä¸‹æ·»åŠ å¦‚ä¸‹é…ç½®å³å¯</p><ul><li>source_labels: [__meta_kubernetes_pod_label_ruqi_app]<br>action: drop<br>regex: travel-platform-customerservice</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;VictoriaMetrics æ˜¯ä¸€æ¬¾å¿«é€Ÿã€ç»æµé«˜æ•ˆä¸”å¯æ‰©å±•çš„æ—¶é—´åºåˆ—æ•°æ®åº“ã€‚å¯ç”¨ä½œ Prometheus çš„é•¿æœŸè¿œç¨‹å­˜å‚¨ã€‚å¦‚æœæå–ç‡ä½äºæ¯ç§’â€‹â€‹ä¸€ç™¾ä¸‡ä¸ªæ•°æ®ç‚¹ï¼Œå»ºè®®ä½¿ç”¨å•èŠ‚ç‚¹ç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯é›†ç¾¤ç‰ˆæœ¬ã€‚&lt;/p&gt;
&lt;p&gt;VictoriaMetricsé›†ç¾¤ç”±ä»¥ä¸‹æœåŠ¡ç»„æˆï¼š&lt;/p&gt;
</summary>
      
    
    
    
    
    <category term="k8s" scheme="https://nmk0718.github.io/tag/k8s/"/>
    
    <category term="VictoriaMetrics" scheme="https://nmk0718.github.io/tag/VictoriaMetrics/"/>
    
  </entry>
  
  <entry>
    <title>nginx-ingressé…ç½®</title>
    <link href="https://nmk0718.github.io/2024/11/18/nginx-ingress%E9%85%8D%E7%BD%AE%E8%B7%A8%E5%9F%9F/"/>
    <id>https://nmk0718.github.io/2024/11/18/nginx-ingress%E9%85%8D%E7%BD%AE%E8%B7%A8%E5%9F%9F/</id>
    <published>2024-11-18T03:46:00.000Z</published>
    <updated>2024-11-18T07:42:57.730Z</updated>
    
    <content type="html"><![CDATA[<h4 id="é…ç½®å¾®ä¿¡å°ç¨‹åºæˆ–å…¬ä¼—å·è®¤è¯"><a href="#é…ç½®å¾®ä¿¡å°ç¨‹åºæˆ–å…¬ä¼—å·è®¤è¯" class="headerlink" title="é…ç½®å¾®ä¿¡å°ç¨‹åºæˆ–å…¬ä¼—å·è®¤è¯"></a>é…ç½®å¾®ä¿¡å°ç¨‹åºæˆ–å…¬ä¼—å·è®¤è¯</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/configuration-snippet:</span> <span class="string">|</span></span><br><span class="line">      <span class="string">location</span> <span class="string">/MP_verify_CwtbVLWfGpMDmrcy.txt</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">add_header</span> <span class="string">Content-Type</span> <span class="string">text/plain;</span></span><br><span class="line">        <span class="string">return</span> <span class="number">200</span> <span class="string">"CwtbVLWfGpMDmrcy"</span><span class="string">;</span></span><br><span class="line">      <span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="è·¨åŸŸé…ç½®"><a href="#è·¨åŸŸé…ç½®" class="headerlink" title="è·¨åŸŸé…ç½®"></a>è·¨åŸŸé…ç½®</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/cors-allow-credentials:</span> <span class="string">'true'</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/cors-allow-headers:</span> <span class="string">&gt;-</span></span><br><span class="line">      <span class="string">DNT,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,X-Forwarded-For,X-CustomHeader,X-Token</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/cors-allow-methods:</span> <span class="string">GET,</span> <span class="string">PUT,</span> <span class="string">POST,</span> <span class="string">DELETE,</span> <span class="string">PATCH,</span> <span class="string">OPTIONS</span></span><br><span class="line">    <span class="comment">#å¦‚æœcors-allow-originä¸èƒ½ä¸º*ï¼Œå¯å†™æ­»ä¸ºå¯¹åº”çš„åŸŸåï¼Œä¹Ÿå¯ä½¿ç”¨ä¸‹é¢çš„æ–¹æ¡ˆ</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/cors-allow-origin:</span> <span class="string">'*'</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/cors-expose-headers:</span> <span class="string">Version,</span> <span class="string">X-CustomResponseHeader</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/enable-cors:</span> <span class="string">'true'</span></span><br></pre></td></tr></table></figure><p>æˆ–</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/server-snippet:</span> <span class="string">&gt;</span></span><br><span class="line">      <span class="string">if</span> <span class="string">($http_origin</span> <span class="string">=</span> <span class="string">''</span><span class="string">)&#123;</span></span><br><span class="line">            <span class="string">set</span> <span class="string">$http_origin</span> <span class="string">"*"</span><span class="string">;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">      <span class="string">add_header</span> <span class="string">Access-Control-Allow-Origin</span> <span class="string">$http_origin;</span></span><br><span class="line"></span><br><span class="line">      <span class="string">add_header</span> <span class="string">'Access-Control-Allow-Credentials'</span> <span class="string">'true'</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line">      <span class="string">add_header</span> <span class="string">'Access-Control-Allow-Headers'</span></span><br><span class="line">      <span class="string">DNT,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,X-Forwarded-For,X-CustomHeader,X-Token;</span></span><br><span class="line"></span><br><span class="line">      <span class="string">add_header</span> <span class="string">'Access-Control-Allow-Methods'</span> <span class="string">'GET, PUT, POST, DELETE,PATCH,OPTIONS'</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line">      <span class="string">add_header</span> <span class="string">'Access-Control-Expose-Headers'</span> <span class="string">'Version,X-CustomResponseHeader'</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line">      <span class="string">proxy_hide_header</span> <span class="string">'Access-Control-Allow-Origin'</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line">      <span class="string">proxy_hide_header</span> <span class="string">'Access-Control-Allow-Credentials'</span><span class="string">;</span></span><br></pre></td></tr></table></figure><h4 id="å¸¸ç”¨é…ç½®"><a href="#å¸¸ç”¨é…ç½®" class="headerlink" title="å¸¸ç”¨é…ç½®"></a>å¸¸ç”¨é…ç½®</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">annotations:</span>    </span><br><span class="line">    <span class="comment">#httpè¯·æ±‚ä¸ä¼šé‡å®šå‘åˆ°https</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/proxy-body-size:</span> <span class="string">10m</span></span><br><span class="line">    <span class="comment">#è¯·æ±‚å…è®¸çš„æœ€å¤§è¯·æ±‚ä½“å¤§å°</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">'false'</span></span><br><span class="line">    <span class="comment">#ä½¿ç”¨é»˜è®¤çš„åç«¯è¿”å›å¤´</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/configuration-snippet:</span> <span class="string">proxy_hide_header</span> <span class="string">none;</span></span><br><span class="line">    <span class="comment">#é…ç½®è¶…æ—¶ç­‰ä¿¡æ¯</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/server-snippet:</span> <span class="string">|</span> </span><br><span class="line">      <span class="string">client_body_timeout</span> <span class="string">120s;</span></span><br><span class="line">      <span class="string">client_max_body_size</span> <span class="string">1024M;</span></span><br><span class="line">      <span class="string">client_header_buffer_size</span> <span class="string">10k;</span></span><br><span class="line">      <span class="string">proxy_request_buffering</span> <span class="string">off;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;é…ç½®å¾®ä¿¡å°ç¨‹åºæˆ–å…¬ä¼—å·è®¤è¯&quot;&gt;&lt;a href=&quot;#é…ç½®å¾®ä¿¡å°ç¨‹åºæˆ–å…¬ä¼—å·è®¤è¯&quot; class=&quot;headerlink&quot; title=&quot;é…ç½®å¾®ä¿¡å°ç¨‹åºæˆ–å…¬ä¼—å·è®¤è¯&quot;&gt;&lt;/a&gt;é…ç½®å¾®ä¿¡å°ç¨‹åºæˆ–å…¬ä¼—å·è®¤è¯&lt;/h4&gt;&lt;figure class=&quot;highlight yaml</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>é™åˆ¶ç›´è¿podè®¿é—®</title>
    <link href="https://nmk0718.github.io/2024/10/24/%E9%99%90%E5%88%B6%E7%9B%B4%E8%BF%9Epod%E8%AE%BF%E9%97%AE/"/>
    <id>https://nmk0718.github.io/2024/10/24/%E9%99%90%E5%88%B6%E7%9B%B4%E8%BF%9Epod%E8%AE%BF%E9%97%AE/</id>
    <published>2024-10-24T03:30:00.000Z</published>
    <updated>2024-10-24T05:42:28.544Z</updated>
    
    <content type="html"><![CDATA[<p>é—®é¢˜ï¼šå› å…¬å¸é€šè¿‡ä¸“çº¿ä¸è…¾è®¯äº‘æ‰“é€šï¼Œå¯¼è‡´æœ¬åœ°åŠå…¬ç½‘ç»œèƒ½ç›´è¿é›†ç¾¤å†…çš„pod ipå’Œportè¿›è¡Œè®¿é—®</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><h4 id="ä½¿ç”¨NetworkPolicyé™åˆ¶"><a href="#ä½¿ç”¨NetworkPolicyé™åˆ¶" class="headerlink" title="ä½¿ç”¨NetworkPolicyé™åˆ¶"></a>ä½¿ç”¨NetworkPolicyé™åˆ¶</h4><p>è¿›å…¥tke&gt;ç»„ä»¶ç®¡ç†&gt;æ–°å»º&gt;å‹¾é€‰NetworkPolicyç»„ä»¶ï¼Œè¿›è¡Œä¿å­˜ï¼Œä½¿ç”¨yamlæ–‡ä»¶åˆ›å»ºé™åˆ¶ç­–ç•¥</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: NetworkPolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: test-network-policy</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  podSelector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      app: test-app #æœåŠ¡çš„æ ‡ç­¾</span><br><span class="line">  policyTypes:</span><br><span class="line">  - Ingress</span><br><span class="line">  ingress:</span><br><span class="line">  - from:</span><br><span class="line">    - ipBlock:</span><br><span class="line">        cidr: 10.3.0.0/16 #å…è®¸ç½‘æ®µè®¿é—®</span><br><span class="line">        except:</span><br><span class="line">        - 10.80.0.0/16 #ä¸å…è®¸ç½‘æ®µè®¿é—®</span><br><span class="line">    ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 4000</span><br></pre></td></tr></table></figure><p>âš ï¸å¦‚æœæ²¡æœ‰é…ç½®ç»„ä»¶ï¼Œåˆ›å»ºyamlæ˜¯ä¸ç”Ÿæ•ˆçš„<br>å…·ä½“å‚è€ƒ<br><a href="https://cloud.tencent.com/document/product/457/19793" target="_blank" rel="noopener">https://cloud.tencent.com/document/product/457/19793</a></p><h4 id="ç»™VPC-CNIç»‘å®šå®‰å…¨ç»„"><a href="#ç»™VPC-CNIç»‘å®šå®‰å…¨ç»„" class="headerlink" title="ç»™VPC-CNIç»‘å®šå®‰å…¨ç»„"></a>ç»™VPC-CNIç»‘å®šå®‰å…¨ç»„</h4><p>è¿›å…¥tke&gt;ç»„ä»¶ç®¡ç†&gt;eniipamdçš„å³ä¾§æ›´æ–°é…ç½®&gt;å‹¾é€‰å®‰å…¨ç»„ï¼Œé…ç½®å®‰å…¨ç»„å³å¯<br><a href="https://cloud.tencent.com/document/product/457/50360" target="_blank" rel="noopener">https://cloud.tencent.com/document/product/457/50360</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;é—®é¢˜ï¼šå› å…¬å¸é€šè¿‡ä¸“çº¿ä¸è…¾è®¯äº‘æ‰“é€šï¼Œå¯¼è‡´æœ¬åœ°åŠå…¬ç½‘ç»œèƒ½ç›´è¿é›†ç¾¤å†…çš„pod ipå’Œportè¿›è¡Œè®¿é—®&lt;/p&gt;
&lt;p&gt;è§£å†³æ–¹æ¡ˆï¼š&lt;/p&gt;
&lt;h4 id=&quot;ä½¿ç”¨NetworkPolicyé™åˆ¶&quot;&gt;&lt;a href=&quot;#ä½¿ç”¨NetworkPolicyé™åˆ¶&quot; class=&quot;headerlin</summary>
      
    
    
    
    
    <category term="k8s" scheme="https://nmk0718.github.io/tag/k8s/"/>
    
  </entry>
  
  <entry>
    <title>Adhell3 é˜»æ­¢å¹¿å‘Šï¼ˆä¸‰æ˜Ÿï¼‰</title>
    <link href="https://nmk0718.github.io/2024/09/29/Adhell3/"/>
    <id>https://nmk0718.github.io/2024/09/29/Adhell3/</id>
    <published>2024-09-29T05:35:00.000Z</published>
    <updated>2024-09-29T06:53:17.011Z</updated>
    
    <content type="html"><![CDATA[<h4 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h4><ol><li>éœ€è¦å…ˆå¯¹ä¸‰æ˜Ÿæ‰‹æœºè¿›è¡Œadbæˆæƒå¯åŠ¨é»‘åŸŸ</li><li>NotifyRDS-Add-on-Samsung.apk,Adhell3.apk,ä¸‰æ˜Ÿæ‰‹æœº</li></ol><p>âš ï¸æœ¬æ–‡å°è¯•å‚è€ƒé“¾æ¥ä¸­çš„ç‚¼å¦–å£¶æ–¹æ¡ˆæ— æ³•æ¿€æ´»Adhell3,ä»…åˆ—å‡ºå®‰å…¨æ–‡ä»¶å¤¹çš„æ¿€æ´»æ­¥éª¤</p><h4 id="æ¿€æ´»"><a href="#æ¿€æ´»" class="headerlink" title="æ¿€æ´»"></a>æ¿€æ´»</h4><ol><li><p>å¯ç”¨ klms agent</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#é»‘åŸŸå†…è¿è¡Œå‘½ä»¤</span><br><span class="line">pm enable com.samsung.klmsagent</span><br></pre></td></tr></table></figure></li><li><p>å®‰è£…NotifyRDS-Add-on-Samsung</p></li><li><p>æ‰‹æœºè®¾ç½®ä¸­å¼€å¯å®‰å…¨æ–‡ä»¶å¤¹ï¼ŒæŠŠNotifyRDS-Add-on-Samsungå®‰è£…åˆ°å®‰å…¨æ–‡ä»¶å¤¹ä¸­<br>å®‰å…¨æ–‡ä»¶å¤¹ï¼šå³ä¸Šè§’åŠ å·â€”â€”æ·»åŠ NotifyRDS-Add-on-Samsung</p></li><li><p>å¸è½½æ‰‹æœºè‡ªèº«å®‰è£…çš„NotifyRDS-Add-on-Samsung<br>æ‰‹æœºè®¾ç½®å†…æœç´¢ <code>è®¾å¤‡ç®¡ç†åº”ç”¨ç¨‹åº</code> å¯¹ç¬¬ä¸€ä¸ªNotifyRDS-Add-on-Samsungè¿›è¡Œå–æ¶ˆæ¿€æ´»å’Œå¸è½½</p></li><li><p>ç¦ç”¨ klms agent</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#é»‘åŸŸå†…è¿è¡Œå‘½ä»¤</span><br><span class="line">pm disable-user com.samsung.klmsagent</span><br></pre></td></tr></table></figure></li><li><p>å¸è½½å®‰å…¨æ–‡ä»¶å¤¹ä¸­çš„NotifyRDS-Add-on-Samsung<br>å®‰å…¨æ–‡ä»¶å¤¹ï¼šå³ä¸Šè§’ä¸‰ä¸ªç‚¹â€”â€”è®¾ç½®â€”â€”æ›´å¤šè®¾ç½®â€”â€”å¸è½½ï¼Œã€å–æ¶ˆã€‘å°†åª’ä½“æ–‡ä»¶ç§»å‡ºå®‰å…¨æ–‡ä»¶</p></li><li><p>å®‰è£… Adhell<br>å…ˆå®‰è£…Adhell3åˆ°æ‰‹æœºå†…<br>é»‘åŸŸå†…è¿è¡Œå‘½ä»¤</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pm enable com.samsung.klmsagent</span><br></pre></td></tr></table></figure></li></ol><p>æ‰‹æœºè®¾ç½®å†…æœç´¢ <code>è®¾å¤‡ç®¡ç†åº”ç”¨ç¨‹åº</code> å¯¹Adhell3è¿›è¡Œæ¿€æ´»<br>å¯åŠ¨Adhell3å³å¯</p><h4 id="é…ç½®ä½œç”¨åŸŸ"><a href="#é…ç½®ä½œç”¨åŸŸ" class="headerlink" title="é…ç½®ä½œç”¨åŸŸ"></a>é…ç½®ä½œç”¨åŸŸ</h4><p>åœ¨ä½œç”¨åŸŸçš„è®¢é˜…æºä¸­é…ç½®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https://raw.githubusercontent.com/VeleSila/yhosts/master/hosts</span><br><span class="line">https://raw.githubusercontent.com/AdAway/adaway.github.io/master/hosts.txt</span><br><span class="line">https://hblock.molinero.dev/hosts</span><br></pre></td></tr></table></figure><p>åœ¨ä½œç”¨åŸŸçš„ç™½åå•ä¸­é…ç½®</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">errnewlog.umeng.com</span><br><span class="line">errlog.umeng.com</span><br><span class="line">beacon.qq.com</span><br><span class="line">ssl.google-analytics.com</span><br><span class="line">loggw.alipay.com.cn</span><br><span class="line">dataflow.biliapi.com</span><br></pre></td></tr></table></figure><p>åœ¨ä¸»é¡µå¯ç”¨ä½œç”¨åŸŸå³å¯</p><p>å‚è€ƒæ–‡æ¡£:<br><a href="https://zhuanlan.zhihu.com/p/670139739" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/670139739</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;å‡†å¤‡å·¥ä½œ&quot;&gt;&lt;a href=&quot;#å‡†å¤‡å·¥ä½œ&quot; class=&quot;headerlink&quot; title=&quot;å‡†å¤‡å·¥ä½œ&quot;&gt;&lt;/a&gt;å‡†å¤‡å·¥ä½œ&lt;/h4&gt;&lt;ol&gt;
&lt;li&gt;éœ€è¦å…ˆå¯¹ä¸‰æ˜Ÿæ‰‹æœºè¿›è¡Œadbæˆæƒå¯åŠ¨é»‘åŸŸ&lt;/li&gt;
&lt;li&gt;NotifyRDS-Add-on-Samsung.ap</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>è…¾è®¯äº‘åªæˆæƒç”¨æˆ·tkeç™»é™†å®¹å™¨æƒé™</title>
    <link href="https://nmk0718.github.io/2024/09/23/%E8%85%BE%E8%AE%AF%E4%BA%91%E5%8F%AA%E6%8E%88%E6%9D%83%E7%94%A8%E6%88%B7tke%E7%99%BB%E9%99%86%E5%AE%B9%E5%99%A8%E6%9D%83%E9%99%90/"/>
    <id>https://nmk0718.github.io/2024/09/23/%E8%85%BE%E8%AE%AF%E4%BA%91%E5%8F%AA%E6%8E%88%E6%9D%83%E7%94%A8%E6%88%B7tke%E7%99%BB%E9%99%86%E5%AE%B9%E5%99%A8%E6%9D%83%E9%99%90/</id>
    <published>2024-09-23T08:00:00.000Z</published>
    <updated>2025-02-10T02:38:37.772Z</updated>
    
    <content type="html"><![CDATA[<h3 id="æˆæƒåªè¯»æƒé™"><a href="#æˆæƒåªè¯»æƒé™" class="headerlink" title="æˆæƒåªè¯»æƒé™"></a>æˆæƒåªè¯»æƒé™</h3><h4 id="é€‰æ‹©ç­–ç•¥ç”Ÿæˆå™¨"><a href="#é€‰æ‹©ç­–ç•¥ç”Ÿæˆå™¨" class="headerlink" title="é€‰æ‹©ç­–ç•¥ç”Ÿæˆå™¨"></a>é€‰æ‹©ç­–ç•¥ç”Ÿæˆå™¨</h4><img src="\image\RBAC-create.png"><h4 id="é€‰æ‹©è¦æˆæƒçš„è´¦å·"><a href="#é€‰æ‹©è¦æˆæƒçš„è´¦å·" class="headerlink" title="é€‰æ‹©è¦æˆæƒçš„è´¦å·"></a>é€‰æ‹©è¦æˆæƒçš„è´¦å·</h4><img src="\image\RBAC-auth-user.png"><h4 id="æˆæƒåªè¯»æƒé™-1"><a href="#æˆæƒåªè¯»æƒé™-1" class="headerlink" title="æˆæƒåªè¯»æƒé™"></a>æˆæƒåªè¯»æƒé™</h4><img src="\image\RBAC-auth.png"><h3 id="æˆæƒå®¹å™¨ç™»å½•æƒé™"><a href="#æˆæƒå®¹å™¨ç™»å½•æƒé™" class="headerlink" title="æˆæƒå®¹å™¨ç™»å½•æƒé™"></a>æˆæƒå®¹å™¨ç™»å½•æƒé™</h3><h4 id="åˆ›å»ºClusterRole"><a href="#åˆ›å»ºClusterRole" class="headerlink" title="åˆ›å»ºClusterRole"></a>åˆ›å»ºClusterRole</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">cloud.tencent.com/tke-rbac-generated:</span> <span class="string">"true"</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tke:pod-exec</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods/attach</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods/exec</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºRoleBingingæˆæƒç»™ç”¨æˆ·"><a href="#åˆ›å»ºRoleBingingæˆæƒç»™ç”¨æˆ·" class="headerlink" title="åˆ›å»ºRoleBingingæˆæƒç»™ç”¨æˆ·"></a>åˆ›å»ºRoleBingingæˆæƒç»™ç”¨æˆ·</h4><p>å¤åˆ¶åªè¯»æƒé™ä¸­çš„ç›¸å…³ä¿¡æ¯<br><img src="\image\ClusterRoleBinding-yaml.png"></p><p>å¯¹è´¦å·è¿›è¡Œæˆæƒå®¹å™¨ç™»å½•æƒé™</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">cloud.tencent.com/tke-account-nickname:</span> <span class="string">nmk</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">cloud.tencent.com/tke-account:</span> <span class="string">"100023199976"</span></span><br><span class="line">  <span class="attr">name:</span> <span class="number">100023199976</span><span class="string">-Role-pod-exec</span>    </span><br><span class="line">  <span class="comment">#namespace: no-critical-service #å¡«å†™namespaceä¸ºé’ˆå¯¹æŸä¸ªå‘½ä»¤ç©ºé—´</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tke:pod-exec</span>    <span class="comment">#æŒ‡å®šåˆšåˆ›å»ºçš„ClusterRole</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="number">100023199976</span><span class="number">-1682220970</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;æˆæƒåªè¯»æƒé™&quot;&gt;&lt;a href=&quot;#æˆæƒåªè¯»æƒé™&quot; class=&quot;headerlink&quot; title=&quot;æˆæƒåªè¯»æƒé™&quot;&gt;&lt;/a&gt;æˆæƒåªè¯»æƒé™&lt;/h3&gt;&lt;h4 id=&quot;é€‰æ‹©ç­–ç•¥ç”Ÿæˆå™¨&quot;&gt;&lt;a href=&quot;#é€‰æ‹©ç­–ç•¥ç”Ÿæˆå™¨&quot; class=&quot;headerlink&quot; ti</summary>
      
    
    
    
    
    <category term="k8s" scheme="https://nmk0718.github.io/tag/k8s/"/>
    
  </entry>
  
  <entry>
    <title>arthas</title>
    <link href="https://nmk0718.github.io/2024/09/05/arthas/"/>
    <id>https://nmk0718.github.io/2024/09/05/arthas/</id>
    <published>2024-09-05T03:30:00.000Z</published>
    <updated>2024-09-23T08:42:39.656Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸‹è½½</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@platform-green-5d77977ffc-nw8dm:/<span class="comment"># curl -O https://arthas.aliyun.com/arthas-boot.jar</span></span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100  138k  100  138k    0     0   367k      0 --:--:-- --:--:-- --:--:--  367k</span><br></pre></td></tr></table></figure><p>å¯åŠ¨</p><p>å¯åŠ¨åæŒ‰1ï¼Œ1ä¸ºè¿›ç¨‹ID</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@platform-green-5d77977ffc-nw8dm:/<span class="comment"># java -jar arthas-boot.jar</span></span><br><span class="line">[INFO] JAVA_HOME: /usr/<span class="built_in">local</span>/openjdk-11</span><br><span class="line">[INFO] arthas-boot version: 3.7.2</span><br><span class="line">[INFO] Found existing java process, please choose one and input the serial number of the process, eg : 1. Then hit ENTER.</span><br><span class="line">* [1]: 1 platform-0.5.6-SNAPSHOT.jar</span><br><span class="line">1</span><br><span class="line">[INFO] Start download arthas from remote server: https://arthas.aliyun.com/download/3.7.2?mirror=aliyun</span><br><span class="line">[INFO] Download arthas success.</span><br><span class="line">[INFO] arthas home: /root/.arthas/lib/3.7.2/arthas</span><br><span class="line">[INFO] Try to attach process 1</span><br><span class="line">Picked up JAVA_TOOL_OPTIONS: </span><br><span class="line">[INFO] Attach process 1 success.</span><br><span class="line">[INFO] arthas-client connect 127.0.0.1 3658</span><br><span class="line">  ,---.  ,------. ,--------.,--.  ,--.  ,---.   ,---.                           </span><br><span class="line"> /  O  \ |  .--. <span class="string">''</span>--.  .--<span class="string">'|  '</span>--<span class="string">'  | /  O  \ '</span>   .-<span class="string">'                          </span></span><br><span class="line"><span class="string">|  .-.  ||  '</span>--<span class="string">'.'</span>   |  |   |  .--.  ||  .-.  |`.  `-.                          </span><br><span class="line">|  | |  ||  |\  \    |  |   |  |  |  ||  | |  |.-<span class="string">'    |                         </span></span><br><span class="line"><span class="string">`--'</span> `--<span class="string">'`--'</span> <span class="string">'--'</span>   `--<span class="string">'   `--'</span>  `--<span class="string">'`--'</span> `--<span class="string">'`-----'</span>                          </span><br><span class="line"></span><br><span class="line">wiki       https://arthas.aliyun.com/doc                                        </span><br><span class="line">tutorials  https://arthas.aliyun.com/doc/arthas-tutorials.html                  </span><br><span class="line">version    3.7.2                                                                </span><br><span class="line">main_class                                                                      </span><br><span class="line">pid        1                                                                    </span><br><span class="line">time       2024-09-05 11:31:56</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹å†…å­˜ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[arthas@1]$ memory</span><br><span class="line">Memory                                                                    used                    total                    max                     usage                    </span><br><span class="line">heap                                                                      2819M                   10240M                   10240M                  27.54%                   </span><br><span class="line">g1_eden_space                                                             816M                    6220M                    -1                      13.12%                   </span><br><span class="line">g1_old_gen                                                                1771M                   3788M                    10240M                  17.30%                   </span><br><span class="line">g1_survivor_space                                                         232M                    232M                     -1                      100.00%                  </span><br><span class="line">nonheap                                                                   349M                    367M                     1256M                   27.85%                   </span><br><span class="line">codeheap_<span class="string">'non-nmethods'</span>                                                   1M                      2M                       5M                      31.82%                   </span><br><span class="line">metaspace                                                                 204M                    215M                     512M                    39.98%                   </span><br><span class="line">codeheap_<span class="string">'profiled_nmethods'</span>                                              65M                     67M                      117M                    56.26%                   </span><br><span class="line">compressed_class_space                                                    23M                     27M                      504M                    4.62%                    </span><br><span class="line">codeheap_<span class="string">'non-profiled_nmethods'</span>                                          54M                     54M                      117M                    46.12%                   </span><br><span class="line">mapped                                                                    0K                      0K                       -                       0.00%                    </span><br><span class="line">direct                                                                    69M                     69M                      -                       100.00%</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ä¸‹è½½&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;root@platform-green-5d77977ffc-nw8dm:/&lt;span cla</summary>
      
    
    
    
    
    <category term="arthas" scheme="https://nmk0718.github.io/tag/arthas/"/>
    
  </entry>
  
  <entry>
    <title>hexoæ›´æ¢å­—ä½“</title>
    <link href="https://nmk0718.github.io/2024/08/27/hexo%E6%9B%B4%E6%8D%A2%E5%AD%97%E4%BD%93/"/>
    <id>https://nmk0718.github.io/2024/08/27/hexo%E6%9B%B4%E6%8D%A2%E5%AD%97%E4%BD%93/</id>
    <published>2024-08-27T03:30:00.000Z</published>
    <updated>2024-09-20T03:00:25.793Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ä¸‹è½½å­—ä½“"><a href="#ä¸‹è½½å­—ä½“" class="headerlink" title="ä¸‹è½½å­—ä½“"></a>ä¸‹è½½å­—ä½“</h3><p>å¼€æºå­—ä½“</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https://github.com/fontworks-fonts/Klee/tree/master/fonts/ttf</span><br></pre></td></tr></table></figure><p>ä¸‹è½½åæ ¼å¼è½¬æ¢ </p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https://www.fontsquirrel.com/tools/webfont-generator</span><br></pre></td></tr></table></figure><p>å‚è€ƒæ–‡æ¡£ï¼š<br><a href="https://blog.csdn.net/qq_30997503/article/details/109551074" target="_blank" rel="noopener">https://blog.csdn.net/qq_30997503/article/details/109551074</a></p><p>ä¸‹è½½åå¤åˆ¶åˆ° hexoé¡¹ç›®çš„themes/nmk_hexo/source/fontsä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">âœ ~ tree  Klee_One</span><br><span class="line">Klee_One</span><br><span class="line">â”œâ”€â”€ kleeone-regular-webfont.eot</span><br><span class="line">â”œâ”€â”€ kleeone-regular-webfont.svg</span><br><span class="line">â”œâ”€â”€ kleeone-regular-webfont.ttf</span><br><span class="line">â”œâ”€â”€ kleeone-regular-webfont.woff</span><br><span class="line">â””â”€â”€ kleeone-regular-webfont.woff2</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹themes/nmk_hexo/source/css/font.stylçš„é…ç½®ä¸º</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@font-face &#123;</span><br><span class="line">    font-family: &apos;klee_oneregular&apos;;</span><br><span class="line">    src: url(&apos;../fonts/Klee_One/kleeone-regular-webfont.eot&apos;);</span><br><span class="line">    src: url(&apos;../fonts/Klee_One/kleeone-regular-webfont.eot?#iefix&apos;) format(&apos;embedded-opentype&apos;),</span><br><span class="line">         url(&apos;../fonts/Klee_One/kleeone-regular-webfont.woff2&apos;) format(&apos;woff2&apos;),</span><br><span class="line">         url(&apos;../fonts/Klee_One/kleeone-regular-webfont.woff&apos;) format(&apos;woff&apos;),</span><br><span class="line">         url(&apos;../fonts/Klee_One/kleeone-regular-webfont.ttf&apos;) format(&apos;truetype&apos;),</span><br><span class="line">         url(&apos;../fonts/Klee_One/kleeone-regular-webfont.svg#klee_oneregular&apos;) format(&apos;svg&apos;);</span><br><span class="line">    font-weight 300;</span><br><span class="line">    font-style: normal;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$font-family = klee_oneregular</span><br></pre></td></tr></table></figure><p>æˆ–è€…ç›´æ¥ä½¿ç”¨ç³»ç»Ÿçš„</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$font-family = Helvetica Neue, Helvetica, PingFang SC, Hiragino Sans GB, Microsoft YaHei, Arial, sans-serif</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;ä¸‹è½½å­—ä½“&quot;&gt;&lt;a href=&quot;#ä¸‹è½½å­—ä½“&quot; class=&quot;headerlink&quot; title=&quot;ä¸‹è½½å­—ä½“&quot;&gt;&lt;/a&gt;ä¸‹è½½å­—ä½“&lt;/h3&gt;&lt;p&gt;å¼€æºå­—ä½“&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=</summary>
      
    
    
    
    
    <category term="hexo" scheme="https://nmk0718.github.io/tag/hexo/"/>
    
  </entry>
  
  <entry>
    <title>helm</title>
    <link href="https://nmk0718.github.io/2024/08/23/helm/"/>
    <id>https://nmk0718.github.io/2024/08/23/helm/</id>
    <published>2024-08-23T08:29:00.000Z</published>
    <updated>2024-11-29T06:44:26.887Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å®‰è£…helm"><a href="#å®‰è£…helm" class="headerlink" title="å®‰è£…helm"></a>å®‰è£…helm</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># macä¸‹è½½</span></span><br><span class="line">wget https://get.helm.sh/helm-v3.14.3-darwin-amd64.tar.gz</span><br><span class="line"><span class="comment"># linuxä¸‹è½½</span></span><br><span class="line">wget https://get.helm.sh/helm-v3.14.3-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">tar zxvf helm-v3.14.3-darwin-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">sudo mv darwin-amd64/helm /usr/<span class="built_in">local</span>/bin/helm</span><br><span class="line"></span><br><span class="line">helm version</span><br><span class="line">version.BuildInfo&#123;Version:<span class="string">"v3.14.3"</span>, GitCommit:<span class="string">"f03cc04caaa8f6d7c3e67cf918929150cf6f3f12"</span>, GitTreeState:<span class="string">"clean"</span>,GoVersion:<span class="string">"go1.21.7"</span>&#125;</span><br></pre></td></tr></table></figure><p>macéœ€è¦å» <code>ç³»ç»Ÿè®¾ç½®&gt;éšç§ä¸å®‰å…¨æ€§&gt;å®‰å…¨æ€§</code> å…è®¸helmè¿è¡Œ</p><h3 id="helmå‘½ä»¤"><a href="#helmå‘½ä»¤" class="headerlink" title="helmå‘½ä»¤"></a>helmå‘½ä»¤</h3><h4 id="helm-create"><a href="#helm-create" class="headerlink" title="helm create"></a>helm create</h4><p>è¯¥å‘½ä»¤ç”¨äºåˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ Helm Chartã€‚Helm Chart æ˜¯ Kubernetes åº”ç”¨çš„åŒ…ï¼ŒåŒ…å«äº†è¿è¡Œåº”ç”¨æ‰€éœ€çš„æ‰€æœ‰èµ„æºå®šä¹‰ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm create nmk-app</span><br><span class="line">âœ ~ tree nmk-app</span><br><span class="line">nmk-app</span><br><span class="line">â”œâ”€â”€ Chart.yaml</span><br><span class="line">â”œâ”€â”€ charts</span><br><span class="line">â”œâ”€â”€ templates</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ NOTES.txt</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ _helpers.tpl</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ deployment.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ hpa.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ ingress.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ service.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ serviceaccount.yaml</span><br><span class="line">â”‚Â Â  â””â”€â”€ tests</span><br><span class="line">â”‚Â Â      â””â”€â”€ <span class="built_in">test</span>-connection.yaml</span><br><span class="line">â””â”€â”€ values.yaml</span><br></pre></td></tr></table></figure><h4 id="helm-install"><a href="#helm-install" class="headerlink" title="helm install"></a>helm install</h4><p>ç”¨äºå°† Helm Chart å®‰è£…åˆ° Kubernetes é›†ç¾¤ä¸­ã€‚å®ƒä¼šåˆ›å»ºæ‰€æœ‰å®šä¹‰åœ¨ Chart ä¸­çš„èµ„æºã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ ~ helm install nmk-app nmk-app</span><br><span class="line">NAME: nmk-app</span><br><span class="line">LAST DEPLOYED: Mon Aug 23 16:06:14 2024</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br></pre></td></tr></table></figure><h4 id="helm-upgrade"><a href="#helm-upgrade" class="headerlink" title="helm upgrade"></a>helm upgrade</h4><p>ç”¨äºå‡çº§å·²å®‰è£…çš„ Helm Chart åˆ°æ–°ç‰ˆæœ¬ã€‚å¯ä»¥ä¿®æ”¹ Chart çš„é…ç½®å’Œèµ„æºã€‚</p><p>å°†å·²æœ‰çš„ release å‡çº§åˆ°ä¸€ä¸ªæ–°ç‰ˆæœ¬çš„ chart</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ ~ helm upgrade nmk-app nmk-app</span><br><span class="line">Release <span class="string">"nmk-app"</span> has been upgraded. Happy Helming!</span><br><span class="line">NAME: nmk-app</span><br><span class="line">LAST DEPLOYED: Mon Aug 26 16:07:57 2024</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 2</span><br><span class="line">TEST SUITE: None</span><br></pre></td></tr></table></figure><h4 id="helm-rollback"><a href="#helm-rollback" class="headerlink" title="helm rollback"></a>helm rollback</h4><p>å½“ Helm Chart å‡çº§åå‡ºç°é—®é¢˜æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¯¥å‘½ä»¤å›æ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ ~ helm rollback nmk-app 1</span><br><span class="line">Rollback was a success! Happy Helming!</span><br><span class="line">âœ ~ kubectl get pod  -n tke-docker-test -l app=nmk-app</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE</span><br><span class="line">nmk-app   1/1     Running   0          8m49s</span><br></pre></td></tr></table></figure><h4 id="helm-lint"><a href="#helm-lint" class="headerlink" title="helm lint"></a>helm lint</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ ~ helm lint nmk-app</span><br><span class="line">==&gt; Linting nmk-app</span><br><span class="line">[INFO] Chart.yaml: icon is recommended</span><br><span class="line"></span><br><span class="line">1 chart(s) linted, 0 chart(s) failed</span><br><span class="line"><span class="comment">#å¯¹1ä¸ªchartè¿›è¡Œäº†lintingï¼ˆä»£ç å®¡æŸ¥ï¼‰ï¼Œå¹¶ä¸”åœ¨å®¡æŸ¥è¿‡ç¨‹ä¸­æ²¡æœ‰å‘ç°ä»»ä½•å¤±è´¥çš„é—®é¢˜</span></span><br></pre></td></tr></table></figure><h4 id="helm-show"><a href="#helm-show" class="headerlink" title="helm show"></a>helm show</h4><p>ç”¨äºæŸ¥çœ‹ Helm Chart çš„å†…å®¹ï¼ŒåŒ…æ‹¬æ¨¡æ¿ã€é…ç½®æ–‡ä»¶å’Œå…¶ä»–èµ„æºçš„å®šä¹‰ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">æ˜¾ç¤ºChartçš„ä¿¡æ¯å’Œå…ƒæ•°æ®</span><br><span class="line"></span><br><span class="line">âœ ~ helm show chart nmk-app</span><br><span class="line">apiVersion: v2</span><br><span class="line">appVersion: 1.16.0</span><br><span class="line">description: A Helm chart <span class="keyword">for</span> Kubernetes</span><br><span class="line">name: nmk-app</span><br><span class="line"><span class="built_in">type</span>: application</span><br><span class="line">version: 0.1.0</span><br></pre></td></tr></table></figure><h4 id="helm-uninstall"><a href="#helm-uninstall" class="headerlink" title="helm uninstall"></a>helm uninstall</h4><p>ç§»é™¤å·²å®‰è£…çš„ Helm Chartã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ ~ helm uninstall nmk-app</span><br><span class="line">release <span class="string">"nmk-app"</span> uninstalled</span><br></pre></td></tr></table></figure><h4 id="helm-pull"><a href="#helm-pull" class="headerlink" title="helm pull"></a>helm pull</h4><p>ä»è¿œç¨‹ä»“åº“ä¸‹è½½æˆ–æ‹‰å–ä¸€ä¸ª Helm Chart åˆ°æœ¬åœ°ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ ~ helm repo add stable https://charts.helm.sh/stable</span><br><span class="line">âœ ~ helm pull stable/mysql --version 1.6.9</span><br><span class="line">å¸¸ç”¨å‚æ•°ï¼š</span><br><span class="line"></span><br><span class="line">--versionï¼šå…è®¸æŒ‡å®šä¸€ä¸ªç‰ˆæœ¬çº¦æŸï¼Œç”¨äºä¸‹è½½ç‰¹å®šç‰ˆæœ¬çš„ Helm å›¾è¡¨ã€‚é»˜è®¤ä½¿ç”¨latestç‰ˆæœ¬ï¼›</span><br><span class="line">--untarï¼šä¸‹è½½Chartåæ˜¯å¦è‡ªåŠ¨è§£å‹ç¼©ã€‚å¦‚æœè®¾ç½®ä¸º<span class="literal">true</span>ï¼Œåˆ™Helmä¼šåœ¨ä¸‹è½½åè‡ªåŠ¨è§£å‹ç¼©</span><br><span class="line">--untardirï¼šæŒ‡å®šå›¾è¡¨æå–åˆ°çš„ç›®å½•ï¼›</span><br><span class="line">--repoï¼šæŒ‡å®šä»ä¸­ä¸‹è½½å›¾è¡¨çš„å­˜å‚¨åº“çš„ URLï¼›</span><br><span class="line">--usernameå’Œ--passwordï¼šæä¾›è®¿é—®ç§äººå­˜å‚¨åº“çš„å‡­è¯ï¼›</span><br><span class="line">--verifyï¼šå¯ä»¥åœ¨ä½¿ç”¨å›¾è¡¨ä¹‹å‰å¯¹å…¶è¿›è¡ŒéªŒè¯ï¼Œç¡®ä¿å›¾è¡¨çš„å®Œæ•´æ€§å’Œå®‰å…¨æ€§ã€‚</span><br></pre></td></tr></table></figure><h3 id="åˆ¶ä½œhelm-chart"><a href="#åˆ¶ä½œhelm-chart" class="headerlink" title="åˆ¶ä½œhelm chart"></a>åˆ¶ä½œhelm chart</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm create nmk-app</span><br><span class="line">âœ  Downloads tree nmk-app</span><br><span class="line">nmk-test</span><br><span class="line">â”œâ”€â”€ Chart.yaml</span><br><span class="line">â”œâ”€â”€ charts</span><br><span class="line">â”œâ”€â”€ templates</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ NOTES.txt</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ _helpers.tpl</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ deployment.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ hpa.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ ingress.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ service.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ serviceaccount.yaml</span><br><span class="line">â”‚Â Â  â””â”€â”€ tests</span><br><span class="line">â”‚Â Â      â””â”€â”€ <span class="built_in">test</span>-connection.yaml</span><br><span class="line">â””â”€â”€ values.yaml</span><br></pre></td></tr></table></figure><p>åˆ é™¤æ²¡ç”¨çš„é…ç½®æ–‡ä»¶ï¼Œåªä¿ç•™ä»¥ä¸‹æ–‡ä»¶</p><h4 id="deployment-yaml"><a href="#deployment-yaml" class="headerlink" title="deployment.yaml"></a>deployment.yaml</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.appname</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.namespace</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.appname</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.appname</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.appname</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.imagepullsecrets</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.appname</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.env.javaoptions</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">"<span class="template-variable">&#123;&#123; .Values.image.repository &#125;&#125;</span><span class="template-variable">&#123;&#123; .Values.appname &#125;&#125;</span>:<span class="template-variable">&#123;&#123; .Values.image.tag &#125;&#125;</span>"</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.image.pullPolicy</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">lifecycle:</span></span><br><span class="line">            <span class="attr">preStop:</span></span><br><span class="line">              <span class="attr">exec:</span></span><br><span class="line">                <span class="attr">command:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">20s</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/actuator/</span></span><br><span class="line">              <span class="attr">port:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.service.port</span> <span class="string">&#125;&#125;</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">15</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">startupProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/actuator/</span></span><br><span class="line">              <span class="attr">port:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.service.port</span> <span class="string">&#125;&#125;</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.resource.limitCpu</span> <span class="string">&#125;&#125;</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.resource.limitMemory</span> <span class="string">&#125;&#125;</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.resource.requestCpu</span> <span class="string">&#125;&#125;</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.resource.requestMemory</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><h4 id="service-yaml"><a href="#service-yaml" class="headerlink" title="service.yaml"></a>service.yaml</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.appname</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.namespace</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.service.type</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.service.port</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.service.port</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.appname</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.appname</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br></pre></td></tr></table></figure><h4 id="ingress-yaml"><a href="#ingress-yaml" class="headerlink" title="ingress.yaml"></a>ingress.yaml</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">.Values.ingress.enabled</span> <span class="string">-&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">$fullName</span> <span class="string">:=</span> <span class="string">.Values.appName</span> <span class="string">-&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">$svcPort</span> <span class="string">:=</span> <span class="string">.Values.service.port</span> <span class="string">-&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">and</span> <span class="string">.Values.ingress.className</span> <span class="string">(not</span> <span class="string">(semverCompare</span> <span class="string">"&gt;=1.18-0"</span> <span class="string">.Capabilities.KubeVersion.GitVersion))</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">not</span> <span class="string">(hasKey</span> <span class="string">.Values.ingress.annotations</span> <span class="string">"kubernetes.io/ingress.class"</span><span class="string">)</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">$_</span> <span class="string">:=</span> <span class="string">set</span> <span class="string">.Values.ingress.annotations</span> <span class="string">"kubernetes.io/ingress.class"</span> <span class="string">.Values.ingress.className&#125;&#125;</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">semverCompare</span> <span class="string">"&gt;=1.19-0"</span> <span class="string">.Capabilities.KubeVersion.GitVersion</span> <span class="string">-&#125;&#125;</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">else</span> <span class="string">if</span> <span class="string">semverCompare</span> <span class="string">"&gt;=1.14-0"</span> <span class="string">.Capabilities.KubeVersion.GitVersion</span> <span class="string">-&#125;&#125;</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">else</span> <span class="string">-&#125;&#125;</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&#123;&#123;</span> <span class="string">$fullName</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.namespace</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">and</span> <span class="string">.Values.ingress.className</span> <span class="string">(semverCompare</span> <span class="string">"&gt;=1.18-0"</span> <span class="string">.Capabilities.KubeVersion.GitVersion)</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.ingress.className</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">.Values.ingress.tls</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">    <span class="string">&#123;&#123;-</span> <span class="string">range</span> <span class="string">.Values.ingress.tls</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">        <span class="string">&#123;&#123;-</span> <span class="string">range</span> <span class="string">.hosts</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#123;&#123;</span> <span class="string">.</span> <span class="string">|</span> <span class="string">quote</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">&#123;&#123;</span> <span class="string">.secretName</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="string">&#123;&#123;-</span> <span class="string">range</span> <span class="string">.Values.ingress.hosts</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">&#123;&#123;</span> <span class="string">.host</span> <span class="string">|</span> <span class="string">quote</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="string">&#123;&#123;-</span> <span class="string">range</span> <span class="string">.paths</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&#123;&#123;</span> <span class="string">.path</span> <span class="string">&#125;&#125;</span></span><br><span class="line">            <span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">and</span> <span class="string">.pathType</span> <span class="string">(semverCompare</span> <span class="string">"&gt;=1.18-0"</span> <span class="string">$.Capabilities.KubeVersion.GitVersion)</span> <span class="string">&#125;&#125;</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">&#123;&#123;</span> <span class="string">.pathType</span> <span class="string">&#125;&#125;</span></span><br><span class="line">            <span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">semverCompare</span> <span class="string">"&gt;=1.19-0"</span> <span class="string">$.Capabilities.KubeVersion.GitVersion</span> <span class="string">&#125;&#125;</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">&#123;&#123;</span> <span class="string">$fullName</span> <span class="string">&#125;&#125;</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="string">&#123;&#123;</span> <span class="string">$svcPort</span> <span class="string">&#125;&#125;</span></span><br><span class="line">              <span class="string">&#123;&#123;-</span> <span class="string">else</span> <span class="string">&#125;&#125;</span></span><br><span class="line">              <span class="attr">serviceName:</span> <span class="string">&#123;&#123;</span> <span class="string">$fullName</span> <span class="string">&#125;&#125;</span></span><br><span class="line">              <span class="attr">servicePort:</span> <span class="string">&#123;&#123;</span> <span class="string">$svcPort</span> <span class="string">&#125;&#125;</span></span><br><span class="line">              <span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><h4 id="values-yaml"><a href="#values-yaml" class="headerlink" title="values.yaml"></a>values.yaml</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">appname:</span> <span class="string">nmk-app</span></span><br><span class="line"></span><br><span class="line"><span class="attr">namespace:</span> <span class="string">tke-docker-test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">replicaCount:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">image:</span></span><br><span class="line">  <span class="attr">repository:</span> <span class="string">helm-hub.com/nmk/</span></span><br><span class="line">  <span class="attr">pullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">tag:</span> <span class="string">app-20240806110148</span></span><br><span class="line"></span><br><span class="line"><span class="attr">imagepullsecrets:</span> <span class="string">qcloudregistrykey</span></span><br><span class="line"></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="attr">javaoptions:</span> <span class="string">-Xms2g</span> <span class="string">-Xmx2g</span> <span class="string">-XX:MetaspaceSize=512M</span> <span class="string">-XX:MaxMetaspaceSize=512M</span> <span class="string">-Dspring.profiles.active=test</span> <span class="string">-Dspring.cloud.consul.enabled=false</span> <span class="string">-Dtsf.discovery.ribbon.enabled=false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">resource:</span></span><br><span class="line">  <span class="attr">limitCpu:</span> <span class="string">'2'</span></span><br><span class="line">  <span class="attr">limitMemory:</span> <span class="string">2Gi</span></span><br><span class="line">  <span class="attr">requestCpu:</span> <span class="string">'1'</span></span><br><span class="line">  <span class="attr">requestMemory:</span> <span class="string">1Gi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">ingress:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">className:</span> <span class="string">"nginx"</span></span><br><span class="line">  <span class="attr">annotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="comment">#kubernetes.io/ingress.class: nginx</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">nmk.com</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">          <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">  <span class="attr">tls:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">secretName:</span> <span class="string">ssl-2024</span></span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">nmk.com</span></span><br></pre></td></tr></table></figure><h4 id="Chart-yaml"><a href="#Chart-yaml" class="headerlink" title="Chart.yaml"></a>Chart.yaml</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">nmk-app</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">A</span> <span class="string">Helm</span> <span class="string">chart</span> <span class="string">for</span> <span class="string">Kubernetes</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">application</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br><span class="line"><span class="attr">appVersion:</span> <span class="string">"1.16.0"</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…åæŸ¥çœ‹"><a href="#å®‰è£…åæŸ¥çœ‹" class="headerlink" title="å®‰è£…åæŸ¥çœ‹"></a>å®‰è£…åæŸ¥çœ‹</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ ~ Downloads helm list</span><br><span class="line">nmk-app        default  1       2024-08-26 16:06:14.735267 +0800 CST   deployednmk-app-0.1.0 1.16.0</span><br><span class="line"></span><br><span class="line">âœ ~ Downloads kubectl get pods -n tke-docker-test</span><br><span class="line">nmk-app-6fdc57bd55-gx6mn                                    1/1     Running            0          117s</span><br><span class="line"></span><br><span class="line">âœ ~ Downloads kubectl get service -n tke-docker-test</span><br><span class="line">nmk-app                                    ClusterIP      172.31.159.244   &lt;none&gt;         8080/TCP                        4m14s</span><br><span class="line"></span><br><span class="line">âœ ~ Downloads kubectl get ingress -n tke-docker-test</span><br><span class="line">nmk-app                                 nginx    nmk.com                          10.30.150.3   80, 443   4m24s</span><br></pre></td></tr></table></figure><p>å¯ä½¿ç”¨ä»¥ä¸‹å‚æ•°æŒ‡å®šå˜é‡è¿›è¡Œå¤šåº”ç”¨éƒ¨ç½²ä½¿ç”¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">--<span class="built_in">set</span> appName=demo --<span class="built_in">set</span> version=v1.1</span><br></pre></td></tr></table></figure><p>å‚è€ƒæ–‡çŒ®ï¼š<br><a href="https://blog.csdn.net/dhf880913/article/details/138125561" target="_blank" rel="noopener">https://blog.csdn.net/dhf880913/article/details/138125561</a><br><a href="https://blog.csdn.net/zhuganlai168/article/details/131483308" target="_blank" rel="noopener">https://blog.csdn.net/zhuganlai168/article/details/131483308</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;å®‰è£…helm&quot;&gt;&lt;a href=&quot;#å®‰è£…helm&quot; class=&quot;headerlink&quot; title=&quot;å®‰è£…helm&quot;&gt;&lt;/a&gt;å®‰è£…helm&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code</summary>
      
    
    
    
    
    <category term="helm" scheme="https://nmk0718.github.io/tag/helm/"/>
    
  </entry>
  
  <entry>
    <title>å®¹å™¨å†…å®‰è£…åŸºç¡€å·¥å…·</title>
    <link href="https://nmk0718.github.io/2024/07/22/%E5%AE%B9%E5%99%A8%E5%86%85%E5%AE%89%E8%A3%85%E5%9F%BA%E7%A1%80%E5%B7%A5%E5%85%B7/"/>
    <id>https://nmk0718.github.io/2024/07/22/%E5%AE%B9%E5%99%A8%E5%86%85%E5%AE%89%E8%A3%85%E5%9F%BA%E7%A1%80%E5%B7%A5%E5%85%B7/</id>
    <published>2024-07-22T06:25:00.000Z</published>
    <updated>2025-02-18T07:04:37.187Z</updated>
    
    <content type="html"><![CDATA[<p>ä½¿ç”¨openjdk:8å’Œopenjdk:11ä½œä¸ºåŸºç¡€é•œåƒæ„å»ºä¸šåŠ¡é•œåƒï¼Œä½†æ˜¯ä½¿ç”¨ä¸­å‘ç°é•œåƒé‡Œé¢æ²¡æœ‰pingã€telnetç­‰åŸºç¡€å‘½ä»¤</p><h3 id="åœ¨å®¹å™¨ä¸­ä½¿ç”¨"><a href="#åœ¨å®¹å™¨ä¸­ä½¿ç”¨" class="headerlink" title="åœ¨å®¹å™¨ä¸­ä½¿ç”¨:"></a>åœ¨å®¹å™¨ä¸­ä½¿ç”¨:</h3><h4 id="å°†æºæ›´æ¢ä¸ºæ¸…åæº"><a href="#å°†æºæ›´æ¢ä¸ºæ¸…åæº" class="headerlink" title="å°†æºæ›´æ¢ä¸ºæ¸…åæº"></a>å°†æºæ›´æ¢ä¸ºæ¸…åæº</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &gt; /etc/apt/sources.list &lt;&lt; EOF</span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye main contrib non-free</span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-updates main contrib non-free</span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-backports main contrib non-free</span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/debian-security bullseye-security main contrib non-free</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="å®‰è£…è½¯ä»¶"><a href="#å®‰è£…è½¯ä»¶" class="headerlink" title="å®‰è£…è½¯ä»¶"></a>å®‰è£…è½¯ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apt-get clean</span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y curl telnet vim iputils-ping net-tools</span><br><span class="line"><span class="comment">#å®‰è£…mysql</span></span><br><span class="line">apt install -y default-mysql-client</span><br></pre></td></tr></table></figure><h4 id="Dockerfileä¸­ä½¿ç”¨"><a href="#Dockerfileä¸­ä½¿ç”¨" class="headerlink" title="Dockerfileä¸­ä½¿ç”¨:"></a>Dockerfileä¸­ä½¿ç”¨:</h4><figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye main contrib non-free"</span> &gt;/etc/apt/sources.list </span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-updates main contrib non-free"</span> &gt;&gt;/etc/apt/sources.list </span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-backports main contrib non-free"</span> &gt;&gt;/etc/apt/sources.list </span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"deb https://mirrors.tuna.tsinghua.edu.cn/debian-security bullseye-security main contrib non-free"</span> &gt;&gt;/etc/apt/sources.list</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash">  apt-get clean</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash">  apt-get update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash">  apt-get install -y curl telnet vim iputils-ping net-tools</span></span><br></pre></td></tr></table></figure><h3 id="alpineå®‰è£…telnetã€curlç­‰å‘½ä»¤"><a href="#alpineå®‰è£…telnetã€curlç­‰å‘½ä»¤" class="headerlink" title="alpineå®‰è£…telnetã€curlç­‰å‘½ä»¤"></a>alpineå®‰è£…telnetã€curlç­‰å‘½ä»¤</h3><p>å¾ˆå¤šé•œåƒæ˜¯ä½¿ç”¨alpineä½œä¸ºåŸºç¡€é•œåƒï¼Œä½“ç§¯å°ï¼Œä½†aplineç²¾ç®€äº†å¾ˆå¤šåŸºç¡€ç»„ä»¶å› æ­¤è°ƒè¯•èµ·æ¥å¾ˆéº»çƒ¦ï¼Œä¸‹æ–¹æ€»ç»“äº†å¸¸ç”¨çš„alpineç»„ä»¶å®‰è£…æ–¹æ³•ï¼š</p><table><thead><tr><th align="center">åŠŸèƒ½</th><th align="center">å‘½ä»¤</th><th align="center">å¤‡æ³¨</th></tr></thead><tbody><tr><td align="center">é•œåƒåŠ é€Ÿ</td><td align="center">sed -i â€˜s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/gâ€™ /etc/apk/repositories</td><td align="center">å°†åŸè£…çš„alpineåº“æ›¿æ¢æˆå›½å†…çš„ustcåº“</td></tr><tr><td align="center">apkåº“æ›´æ–°</td><td align="center">apk update</td><td align="center"></td></tr><tr><td align="center">å®‰è£…curl</td><td align="center">apk add curl</td><td align="center"></td></tr><tr><td align="center">å®‰è£…telnet</td><td align="center">apk add busybox-extras</td><td align="center"></td></tr><tr><td align="center">å·æ‡’Nåˆ1</td><td align="center">sed -i â€˜s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/gâ€™ /etc/apk/repositories &amp;&amp; apk update &amp;&amp; apk add curl &amp;&amp; apk add busybox-extras</td><td align="center"></td></tr></tbody></table>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ä½¿ç”¨openjdk:8å’Œopenjdk:11ä½œä¸ºåŸºç¡€é•œåƒæ„å»ºä¸šåŠ¡é•œåƒï¼Œä½†æ˜¯ä½¿ç”¨ä¸­å‘ç°é•œåƒé‡Œé¢æ²¡æœ‰pingã€telnetç­‰åŸºç¡€å‘½ä»¤&lt;/p&gt;
&lt;h3 id=&quot;åœ¨å®¹å™¨ä¸­ä½¿ç”¨&quot;&gt;&lt;a href=&quot;#åœ¨å®¹å™¨ä¸­ä½¿ç”¨&quot; class=&quot;headerlink&quot; title=&quot;åœ¨å®¹å™¨ä¸­ä½¿ç”¨:&quot;</summary>
      
    
    
    
    
    <category term="k8s" scheme="https://nmk0718.github.io/tag/k8s/"/>
    
    <category term="docker" scheme="https://nmk0718.github.io/tag/docker/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntuå®‰è£…Dockerå’ŒGPUé©±åŠ¨</title>
    <link href="https://nmk0718.github.io/2023/12/05/Ubuntu%E5%AE%89%E8%A3%85Docker%E5%92%8CGPU%E9%A9%B1%E5%8A%A8/"/>
    <id>https://nmk0718.github.io/2023/12/05/Ubuntu%E5%AE%89%E8%A3%85Docker%E5%92%8CGPU%E9%A9%B1%E5%8A%A8/</id>
    <published>2023-12-05T07:30:00.000Z</published>
    <updated>2024-11-29T06:41:49.378Z</updated>
    
    <content type="html"><![CDATA[<h4 id="å®‰è£…ä¾èµ–"><a href="#å®‰è£…ä¾èµ–" class="headerlink" title="å®‰è£…ä¾èµ–"></a>å®‰è£…ä¾èµ–</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get install     ca-certificates     curl     gnupg     lsb-release -y</span><br><span class="line">sudo mkdir -p /etc/apt/keyrings</span><br></pre></td></tr></table></figure><h4 id="æ·»åŠ å®˜æ–¹GPGå¯†é’¥ï¼š"><a href="#æ·»åŠ å®˜æ–¹GPGå¯†é’¥ï¼š" class="headerlink" title="æ·»åŠ å®˜æ–¹GPGå¯†é’¥ï¼š"></a>æ·»åŠ å®˜æ–¹GPGå¯†é’¥ï¼š</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</span><br></pre></td></tr></table></figure><h4 id="æ·»åŠ Dockerçš„ç¨³å®šç‰ˆæœ¬ä»“åº“ï¼š"><a href="#æ·»åŠ Dockerçš„ç¨³å®šç‰ˆæœ¬ä»“åº“ï¼š" class="headerlink" title="æ·»åŠ Dockerçš„ç¨³å®šç‰ˆæœ¬ä»“åº“ï¼š"></a>æ·»åŠ Dockerçš„ç¨³å®šç‰ˆæœ¬ä»“åº“ï¼š</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo add-apt-repository &quot;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable&quot;</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºç”¨æˆ·"><a href="#åˆ›å»ºç”¨æˆ·" class="headerlink" title="åˆ›å»ºç”¨æˆ·"></a>åˆ›å»ºç”¨æˆ·</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo useradd docker</span><br><span class="line">sudo usermod -aG docker $USER</span><br></pre></td></tr></table></figure><h4 id="å®‰è£…Docker"><a href="#å®‰è£…Docker" class="headerlink" title="å®‰è£…Docker"></a>å®‰è£…Docker</h4><p>è…¾è®¯äº‘ä½¿ç”¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install docker.io -y</span><br></pre></td></tr></table></figure><h4 id="æŒ‚è½½ç£ç›˜"><a href="#æŒ‚è½½ç£ç›˜" class="headerlink" title="æŒ‚è½½ç£ç›˜"></a>æŒ‚è½½ç£ç›˜</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@ubuntu:/var/lib# fdisk -l</span><br><span class="line"></span><br><span class="line">Disk /dev/vda: 50 GiB, 53687091200 bytes, 104857600 sectors</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disklabel type: gpt</span><br><span class="line">Disk identifier: 884D39AE-2030-4231-B486-520515A9ADD7</span><br><span class="line"></span><br><span class="line">Device     Start       End   Sectors Size Type</span><br><span class="line">/dev/vda1   2048      4095      2048   1M BIOS boot</span><br><span class="line">/dev/vda2   4096 104857566 104853471  50G Linux filesystem</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk /dev/vdb: 200 GiB, 214748364800 bytes, 419430400 sectors</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">root@ubuntu:/var/lib# fdisk /dev/vdb</span><br><span class="line"></span><br><span class="line">Welcome to fdisk (util-linux 2.34).</span><br><span class="line">Changes will remain in memory only, until you decide to write them.</span><br><span class="line">Be careful before using the write command.</span><br><span class="line"></span><br><span class="line">Device does not contain a recognized partition table.</span><br><span class="line">Created a new DOS disklabel with disk identifier 0x1c765732.</span><br><span class="line"></span><br><span class="line">Command (m for help): `p`</span><br><span class="line">Disk /dev/vdb: 200 GiB, 214748364800 bytes, 419430400 sectors</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disklabel type: dos</span><br><span class="line">Disk identifier: 0x1c765732</span><br><span class="line"></span><br><span class="line">Command (m for help): `n`</span><br><span class="line">Partition type</span><br><span class="line">   p   primary (0 primary, 0 extended, 4 free)</span><br><span class="line">   e   extended (container for logical partitions)</span><br><span class="line">Select (default p): `p`</span><br><span class="line">Partition number (1-4, default 1):</span><br><span class="line">First sector (2048-419430399, default 2048):</span><br><span class="line">Last sector, +/-sectors or +/-size&#123;K,M,G,T,P&#125; (2048-419430399, default 419430399):</span><br><span class="line"></span><br><span class="line">Created a new partition 1 of type &apos;Linux&apos; and of size 200 GiB.</span><br><span class="line"></span><br><span class="line">Command (m for help): `w`</span><br><span class="line">The partition table has been altered.</span><br><span class="line">Calling ioctl() to re-read partition table.</span><br><span class="line">Syncing disks.</span><br><span class="line"></span><br><span class="line">root@ubuntu:/var/lib# mkfs.ext4 /dev/vdb1</span><br><span class="line">mke2fs 1.45.5 (07-Jan-2020)</span><br><span class="line">Creating filesystem with 52428544 4k blocks and 13107200 inodes</span><br><span class="line">Filesystem UUID: a75b2a51-daa1-4d05-a6ee-0871fb0cf059</span><br><span class="line">Superblock backups stored on blocks:</span><br><span class="line">32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208,</span><br><span class="line">4096000, 7962624, 11239424, 20480000, 23887872</span><br><span class="line"></span><br><span class="line">Allocating group tables: done</span><br><span class="line">Writing inode tables: done</span><br><span class="line">Creating journal (262144 blocks): done</span><br><span class="line">Writing superblocks and filesystem accounting information: done</span><br><span class="line"></span><br><span class="line">root@ubuntu:/var/lib# mkdir /data</span><br><span class="line">root@ubuntu:/# mount /dev/vdb1 /data</span><br><span class="line">root@ubuntu:/# df -h</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">udev             16G     0   16G   0% /dev</span><br><span class="line">tmpfs           3.1G  808K  3.1G   1% /run</span><br><span class="line">/dev/vda2        50G   19G   29G  39% /</span><br><span class="line">tmpfs            16G   24K   16G   1% /dev/shm</span><br><span class="line">tmpfs           5.0M     0  5.0M   0% /run/lock</span><br><span class="line">tmpfs            16G     0   16G   0% /sys/fs/cgroup</span><br><span class="line">tmpfs           3.1G     0  3.1G   0% /run/user/1000</span><br><span class="line">/dev/vdb1       196G   28K  186G   1% /data</span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹å­˜å‚¨è·¯å¾„"><a href="#ä¿®æ”¹å­˜å‚¨è·¯å¾„" class="headerlink" title="ä¿®æ”¹å­˜å‚¨è·¯å¾„"></a>ä¿®æ”¹å­˜å‚¨è·¯å¾„</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#Dockerçš„é•œåƒéœ€åœ¨å¤§é‡çš„å­˜å‚¨ç©ºé—´ï¼Œé»˜è®¤çš„å­˜å‚¨è·¯å¾„åœ¨ /var/lib/docker, å¯ä»¥æŒ‰å®é™…éœ€æ±‚ä¿®æ”¹å­˜å‚¨è·¯å¾„ã€‚</span><br><span class="line">#åœæ­¢docker</span><br><span class="line">systemctl stop docker</span><br><span class="line">#ç§»åŠ¨ç›®å½•åˆ°æ–°è·¯å¾„</span><br><span class="line">sudo mv /var/lib/docker /data/docker</span><br><span class="line">#åšä¸ªè½¯é“¾æ¥</span><br><span class="line">ln -s /data/docker /var/lib/docker </span><br><span class="line">#å¯åŠ¨docker</span><br><span class="line">systemctl start docker</span><br></pre></td></tr></table></figure><h4 id="å®‰è£…GPUé©±åŠ¨"><a href="#å®‰è£…GPUé©±åŠ¨" class="headerlink" title="å®‰è£…GPUé©±åŠ¨"></a>å®‰è£…GPUé©±åŠ¨</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">distribution=$(. /etc/os-release;echo $ID$VERSION_ID)</span><br><span class="line">curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -</span><br><span class="line">curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list</span><br><span class="line">sudo apt-get update &amp;&amp; sudo apt-get install -y nvidia-container-toolkit</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><h4 id="éªŒè¯é©±åŠ¨"><a href="#éªŒè¯é©±åŠ¨" class="headerlink" title="éªŒè¯é©±åŠ¨"></a>éªŒè¯é©±åŠ¨</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo nvidia-smi</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;å®‰è£…ä¾èµ–&quot;&gt;&lt;a href=&quot;#å®‰è£…ä¾èµ–&quot; class=&quot;headerlink&quot; title=&quot;å®‰è£…ä¾èµ–&quot;&gt;&lt;/a&gt;å®‰è£…ä¾èµ–&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;</summary>
      
    
    
    
    
    <category term="ubuntu" scheme="https://nmk0718.github.io/tag/ubuntu/"/>
    
    <category term="docker" scheme="https://nmk0718.github.io/tag/docker/"/>
    
  </entry>
  
  <entry>
    <title>corednsåŸŸåè§£æ</title>
    <link href="https://nmk0718.github.io/2023/10/12/coredns%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90/"/>
    <id>https://nmk0718.github.io/2023/10/12/coredns%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90/</id>
    <published>2023-10-12T10:20:00.000Z</published>
    <updated>2024-11-29T06:42:53.041Z</updated>
    
    <content type="html"><![CDATA[<p>ç¼–è¾‘corednsçš„é…ç½®æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl edit configmap coredns -n kube-system</span><br></pre></td></tr></table></figure><p>å¢åŠ è§£æ</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">hosts</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="string">nacos.com</span></span><br><span class="line">        <span class="string">fallthrough</span></span><br><span class="line">        <span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹ä¸ºç¤ºä¾‹</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">coredns</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">selfLink:</span> <span class="string">/api/v1/namespaces/kube-system/configmaps/coredns</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">afe82210-48ab-4e74-a190-7d401a8af49a</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">'240420099'</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">'2022-09-29T03:44:33Z'</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">forward_config:</span> <span class="string">''</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">Corefile:</span> <span class="string">|-</span></span><br><span class="line">    <span class="string">.:53</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">errors</span></span><br><span class="line">        <span class="string">health</span></span><br><span class="line">        <span class="string">ready</span></span><br><span class="line">        <span class="string">hosts</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="string">nacos.com</span></span><br><span class="line">        <span class="string">fallthrough</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">        <span class="string">kubernetes</span> <span class="string">cluster.local</span> <span class="string">in-addr.arpa</span> <span class="string">ip6.arpa</span> <span class="string">&#123;</span></span><br><span class="line">           <span class="string">pods</span> <span class="string">insecure</span></span><br><span class="line">           <span class="string">upstream</span></span><br><span class="line">           <span class="string">fallthrough</span> <span class="string">in-addr.arpa</span> <span class="string">ip6.arpa</span></span><br><span class="line">           <span class="string">ttl</span> <span class="number">30</span></span><br><span class="line">        <span class="string">&#125;</span>      </span><br><span class="line">       <span class="string">prometheus</span> <span class="string">:9153</span></span><br><span class="line">        <span class="string">log</span> <span class="string">.</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="string">class</span> <span class="string">all</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">        <span class="string">cache</span> <span class="number">30</span></span><br><span class="line">        <span class="string">loop</span></span><br><span class="line">        <span class="string">reload</span></span><br><span class="line">        <span class="string">loadbalance</span></span><br><span class="line">        <span class="string">forward</span> <span class="string">.</span> <span class="string">/etc/resolv.conf</span></span><br><span class="line">    <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ç¼–è¾‘corednsçš„é…ç½®æ–‡ä»¶&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl edit configmap coredns -n k</summary>
      
    
    
    
    
    <category term="k8s" scheme="https://nmk0718.github.io/tag/k8s/"/>
    
  </entry>
  
  <entry>
    <title>istio</title>
    <link href="https://nmk0718.github.io/2022/08/11/istio/"/>
    <id>https://nmk0718.github.io/2022/08/11/istio/</id>
    <published>2022-08-11T06:43:00.000Z</published>
    <updated>2024-11-29T06:44:33.324Z</updated>
    
    <content type="html"><![CDATA[<p>å®‰è£… Istio</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@master-01 ~]# istioctl install --set profile=demo -y</span><br><span class="line">âœ” Istio core installed</span><br><span class="line">âœ” Istiod installed</span><br><span class="line">âœ” Egress gateways installed</span><br><span class="line">âœ” Ingress gateways installed</span><br><span class="line">âœ” Installation complete</span><br></pre></td></tr></table></figure><p>åˆ›å»ºå‘½åç©ºé—´</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@master-01 ~]# kubectl create ns tnmk</span><br><span class="line">namespace/tnmk created</span><br></pre></td></tr></table></figure><p>Istio é»˜è®¤<a href="https://istio.io/latest/zh/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection" target="_blank" rel="noopener">è‡ªåŠ¨æ³¨å…¥ Sidecar</a>. ä¸º tnmk å‘½åç©ºé—´æ‰“ä¸Šæ ‡ç­¾ <code>istio-injection=enabled</code>ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@master-01 ~]# kubectl label namespace tnmk istio-injection=enabled</span><br><span class="line">namespace/tnmk labeled</span><br></pre></td></tr></table></figure><p><a href="https://raw.githubusercontent.com/istio/istio/release-1.14/samples/bookinfo/platform/kube/bookinfo.yaml" target="_blank" rel="noopener">bookinfo.yaml</a></p><p>ä½¿ç”¨ <code>kubectl</code> éƒ¨ç½²åº”ç”¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@master-01 ~]# kubectl apply -f bookinfo.yaml -n tnmk</span><br><span class="line">service/details created</span><br><span class="line">serviceaccount/bookinfo-details created</span><br><span class="line">deployment.apps/details-v1 created</span><br><span class="line">service/ratings created</span><br><span class="line">serviceaccount/bookinfo-ratings created</span><br><span class="line">deployment.apps/ratings-v1 created</span><br><span class="line">service/reviews created</span><br><span class="line">serviceaccount/bookinfo-reviews created</span><br><span class="line">deployment.apps/reviews-v1 created</span><br><span class="line">deployment.apps/reviews-v2 created</span><br><span class="line">deployment.apps/reviews-v3 created</span><br><span class="line">service/productpage created</span><br><span class="line">serviceaccount/bookinfo-productpage created</span><br><span class="line">deployment.apps/productpage-v1 created</span><br></pre></td></tr></table></figure><p>ç¡®è®¤æ‰€æœ‰çš„æœåŠ¡å’Œ Pod éƒ½å·²ç»å¯åŠ¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@master-01 ~]# kubectl get services -n tnmk</span><br><span class="line">NAME          TYPE        CLUSTER-IP        EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">details       ClusterIP   172.101.98.173    &lt;none&gt;        9080/TCP   112s</span><br><span class="line">productpage   ClusterIP   172.101.139.235   &lt;none&gt;        9080/TCP   112s</span><br><span class="line">ratings       ClusterIP   172.101.24.172    &lt;none&gt;        9080/TCP   112s</span><br><span class="line">reviews       ClusterIP   172.101.40.212    &lt;none&gt;        9080/TCP   112s</span><br><span class="line">[root@master-01 ~]# kubectl get pods -n tnmk</span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">details-v1-7d88846999-hggx9       2/2     Running   0          3m23s</span><br><span class="line">productpage-v1-7795568889-tqjrv   2/2     Running   0          3m23s</span><br><span class="line">ratings-v1-754f9c4975-tqrqj       2/2     Running   0          3m23s</span><br><span class="line">reviews-v1-55b668fc65-nns2c       2/2     Running   0          3m23s</span><br><span class="line">reviews-v2-858f99c99-l8vv5        2/2     Running   0          3m23s</span><br><span class="line">reviews-v3-7886dd86b9-wpkkl       2/2     Running   0          3m23s</span><br></pre></td></tr></table></figure><p>è¦ç¡®è®¤ Bookinfo åº”ç”¨æ˜¯å¦æ­£åœ¨è¿è¡Œï¼Œè¯·åœ¨æŸä¸ª Pod ä¸­ç”¨ <code>curl</code> å‘½ä»¤å¯¹åº”ç”¨å‘é€è¯·æ±‚ï¼Œä¾‹å¦‚ <code>ratings</code>ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@master-01 ~]# kubectl exec -it -n tnmk $(kubectl get pod -l app=ratings -n tnmk -o jsonpath=&apos;&#123;.items[0].metadata.name&#125;&apos;) -c ratings -- curl productpage:9080/productpage | grep -o &quot;&lt;title&gt;.*&lt;/title&gt;&quot;</span><br><span class="line">&lt;title&gt;Simple Bookstore App&lt;/title&gt;</span><br></pre></td></tr></table></figure><p>ä¸ºåº”ç”¨ç¨‹åºå®šä¹‰ Ingress ç½‘å…³</p><p><a href="https://raw.githubusercontent.com/istio/istio/release-1.14/samples/bookinfo/networking/bookinfo-gateway.yaml" target="_blank" rel="noopener">bookinfo-gateway.yaml</a></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@master-01 ~]# kubectl apply -f bookinfo-gateway.yaml -n tnmk</span><br><span class="line">gateway.networking.istio.io/bookinfo-gateway created</span><br><span class="line">virtualservice.networking.istio.io/bookinfo created</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è§„åˆ™</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl get VirtualService -A</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å®‰è£… Istio&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[root@master-01 ~]# istioctl install --s</summary>
      
    
    
    
    
    <category term="istio" scheme="https://nmk0718.github.io/tag/istio/"/>
    
  </entry>
  
  <entry>
    <title>verdaccio</title>
    <link href="https://nmk0718.github.io/2022/06/20/verdaccio/"/>
    <id>https://nmk0718.github.io/2022/06/20/verdaccio/</id>
    <published>2022-06-20T11:20:00.000Z</published>
    <updated>2025-02-10T04:00:59.682Z</updated>
    
    <content type="html"><![CDATA[<p>yumæŒ‡å®šnodeç‰ˆæœ¬</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl --silent --location https://rpm.nodesource.com/setup_12.x | sudo bash -</span><br></pre></td></tr></table></figure><p>å®‰è£…node</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum -y install nodejs</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹nodeç‰ˆæœ¬</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">node -v</span><br></pre></td></tr></table></figure><p>å…¨å±€å®‰è£…verdaccio</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install verdaccio -g</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ç‰ˆæœ¬å·</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">verdaccio  -v</span><br></pre></td></tr></table></figure><p>å¤åˆ¶ä¸¤ä¸ªé…ç½®æ–‡ä»¶åˆ°/root/.config/ä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">config.yaml  htpasswd</span><br></pre></td></tr></table></figure><p>æ‹·è´ç§æœåº“çš„åŒ…åˆ°æœåŠ¡å™¨çš„/dataä¸‹ è§£å‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tar zxvf /data/npm-storage.tar</span><br></pre></td></tr></table></figure><p>å¯åŠ¨</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">verdaccio</span><br><span class="line"></span><br><span class="line"> info --- Creating default config file in /root/.config/verdaccio/config.yaml</span><br><span class="line"> warn --- config file  - /root/.config/verdaccio/config.yaml</span><br><span class="line">(node:1835) Warning: Verdaccio doesn't need superuser privileges. don't run it under root</span><br><span class="line">(node:1835) Warning: Verdaccio doesn't need superuser privileges. don't run it under root</span><br><span class="line"> warn --- "crypt" algorithm is deprecated consider switch to "bcrypt". Read more: https://github.com/verdaccio/monorepo/pull/580</span><br><span class="line"> info --- plugin successfully loaded: verdaccio-htpasswd</span><br><span class="line"> info --- plugin successfully loaded: verdaccio-audit</span><br><span class="line"> warn --- http address - http://localhost:4873/ - verdaccio/5.13.0</span><br></pre></td></tr></table></figure><p>è®¿é—®é¡µé¢</p><img src="https://nmk0718.github.io/image/image-20220620192826502.png"><p>æ³¨å†ŒæˆæœåŠ¡</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> vi /etc/systemd/system/verdaccio.service</span><br><span class="line"> </span><br><span class="line">[Unit]</span><br><span class="line">Description=Verdaccio lightweight npm proxy registry</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">Restart=on-failure</span><br><span class="line">#User=root</span><br><span class="line">ExecStart=/usr/bin/verdaccio --config /root/.config/verdaccio/config.yaml</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>é‡æ–°åŠ è½½,é…ç½®å¼€æœºå¯åŠ¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable verdaccio.service</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æœåŠ¡å¯åŠ¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl start verdaccio.service</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;yumæŒ‡å®šnodeç‰ˆæœ¬&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;curl --silent --location https://rpm.</summary>
      
    
    
    
    
    <category term="verdaccio" scheme="https://nmk0718.github.io/tag/verdaccio/"/>
    
  </entry>
  
  <entry>
    <title>KubernetesæŸ¥çœ‹podå…³è”çš„pvc</title>
    <link href="https://nmk0718.github.io/2022/06/13/Kubernetes%E6%9F%A5%E7%9C%8Bpod%E5%85%B3%E8%81%94%E7%9A%84pvc/"/>
    <id>https://nmk0718.github.io/2022/06/13/Kubernetes%E6%9F%A5%E7%9C%8Bpod%E5%85%B3%E8%81%94%E7%9A%84pvc/</id>
    <published>2022-06-13T09:20:00.000Z</published>
    <updated>2025-01-05T15:55:13.020Z</updated>
    
    <content type="html"><![CDATA[<h3 id="kubernetes-æŸ¥çœ‹å“ªäº›-pod-æ­£åœ¨ä½¿ç”¨-pvc"><a href="#kubernetes-æŸ¥çœ‹å“ªäº›-pod-æ­£åœ¨ä½¿ç”¨-pvc" class="headerlink" title="kubernetes æŸ¥çœ‹å“ªäº› pod æ­£åœ¨ä½¿ç”¨ pvc"></a>kubernetes æŸ¥çœ‹å“ªäº› pod æ­£åœ¨ä½¿ç”¨ pvc</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s ~]<span class="comment"># cat pvc-pod.sh</span></span><br><span class="line">kubectl get pods --all-namespaces -o=json | jq -c <span class="string">'.items[] | &#123;name: .metadata.name, namespace: .metadata.namespace, claimName:.spec.volumes[] | select( has ("persistentVolumeClaim") ).persistentVolumeClaim.claimName &#125;'</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s ~]# sh pvc-pod.sh</span><br><span class="line">&#123;&quot;name&quot;:&quot;archery-mysql-master-0&quot;,&quot;namespace&quot;:&quot;archery&quot;,&quot;claimName&quot;:&quot;data-archery-mysql-master-0&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;clash-d59b74867-rlj7j&quot;,&quot;namespace&quot;:&quot;default&quot;,&quot;claimName&quot;:&quot;ruleset-cache&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;sonarqube-postgresql-postgresql-0&quot;,&quot;namespace&quot;:&quot;default&quot;,&quot;claimName&quot;:&quot;data-sonarqube-postgresql-postgresql-0&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;sonarqube-sonarqube-7b548fdb4f-45ww8&quot;,&quot;namespace&quot;:&quot;default&quot;,&quot;claimName&quot;:&quot;sonarqube-sonarqube&quot;&#125;</span><br></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹k8sé›†ç¾¤æœ‰å“ªäº›åœ¨ä½¿ç”¨çš„ç«¯å£å¯¹åº”çš„æœåŠ¡"><a href="#æŸ¥çœ‹k8sé›†ç¾¤æœ‰å“ªäº›åœ¨ä½¿ç”¨çš„ç«¯å£å¯¹åº”çš„æœåŠ¡" class="headerlink" title="æŸ¥çœ‹k8sé›†ç¾¤æœ‰å“ªäº›åœ¨ä½¿ç”¨çš„ç«¯å£å¯¹åº”çš„æœåŠ¡"></a>æŸ¥çœ‹k8sé›†ç¾¤æœ‰å“ªäº›åœ¨ä½¿ç”¨çš„ç«¯å£å¯¹åº”çš„æœåŠ¡</h3><p>å¯¼å‡ºæ‰€æœ‰svcåˆ°æ–‡æœ¬</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl get svc --all-namespaces &gt;svc.txt</span><br></pre></td></tr></table></figure><p>è¿‡æ»¤nodeportæ˜¾ç¤º</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">grep NodePort svc.txt</span><br></pre></td></tr></table></figure><p>é€šè¿‡NodePortå¯çŸ¥é“æ˜ å°„çš„æœåŠ¡</p><h4 id="ç¼©å‡æ‰€æœ‰ç©ºé—´çš„podå‰¯æœ¬æ•°ä¸º0"><a href="#ç¼©å‡æ‰€æœ‰ç©ºé—´çš„podå‰¯æœ¬æ•°ä¸º0" class="headerlink" title="ç¼©å‡æ‰€æœ‰ç©ºé—´çš„podå‰¯æœ¬æ•°ä¸º0"></a>ç¼©å‡æ‰€æœ‰ç©ºé—´çš„podå‰¯æœ¬æ•°ä¸º0</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl get ns -o name | awk &apos;&#123;print $1&#125;&apos; |awk -F &apos;/&apos; &apos;&#123;print $2&#125;&apos; &gt;ns.txt</span><br></pre></td></tr></table></figure><h4 id="ç¼©å‡æ‰€æœ‰ç©ºé—´çš„deploymentå‰¯æœ¬æ•°ä¸º0"><a href="#ç¼©å‡æ‰€æœ‰ç©ºé—´çš„deploymentå‰¯æœ¬æ•°ä¸º0" class="headerlink" title="ç¼©å‡æ‰€æœ‰ç©ºé—´çš„deploymentå‰¯æœ¬æ•°ä¸º0"></a>ç¼©å‡æ‰€æœ‰ç©ºé—´çš„deploymentå‰¯æœ¬æ•°ä¸º0</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat start.sh</span><br><span class="line"></span><br><span class="line">while read line</span><br><span class="line"></span><br><span class="line">do</span><br><span class="line"></span><br><span class="line">echo $line</span><br><span class="line">kubectl scale --replicas=0 $(kubectl get deploy -o name -n $line) -n $line</span><br><span class="line"></span><br><span class="line">done &lt; ns.txt</span><br></pre></td></tr></table></figure><p>./start.sh</p><h3 id="ç¼©å‡æ‰€æœ‰ç©ºé—´çš„statefulsetså‰¯æœ¬æ•°ä¸º0"><a href="#ç¼©å‡æ‰€æœ‰ç©ºé—´çš„statefulsetså‰¯æœ¬æ•°ä¸º0" class="headerlink" title="ç¼©å‡æ‰€æœ‰ç©ºé—´çš„statefulsetså‰¯æœ¬æ•°ä¸º0"></a>ç¼©å‡æ‰€æœ‰ç©ºé—´çš„statefulsetså‰¯æœ¬æ•°ä¸º0</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat start.sh</span><br><span class="line"></span><br><span class="line">while read line</span><br><span class="line"></span><br><span class="line">do</span><br><span class="line"></span><br><span class="line">echo $line</span><br><span class="line">kubectl scale --replicas=0 $(kubectl get statefulsets -o name -n $line) -n $line</span><br><span class="line"></span><br><span class="line">done &lt; ns.txt</span><br></pre></td></tr></table></figure><p>./start.sh</p><p><a href="https://www.e-learn.cn/topic/3816776" target="_blank" rel="noopener">https://www.e-learn.cn/topic/3816776</a></p><p>ä½¿ç”¨<code>kubectl delete jobs --all</code>å¯ä»¥åˆ é™¤å½“å‰namespacesä¸‹æ‰€æœ‰çš„job</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;kubernetes-æŸ¥çœ‹å“ªäº›-pod-æ­£åœ¨ä½¿ç”¨-pvc&quot;&gt;&lt;a href=&quot;#kubernetes-æŸ¥çœ‹å“ªäº›-pod-æ­£åœ¨ä½¿ç”¨-pvc&quot; class=&quot;headerlink&quot; title=&quot;kubernetes æŸ¥çœ‹å“ªäº› pod æ­£åœ¨ä½¿ç”¨ pvc&quot;&gt;&lt;/a&gt;ku</summary>
      
    
    
    
    
    <category term="k8s" scheme="https://nmk0718.github.io/tag/k8s/"/>
    
  </entry>
  
  <entry>
    <title>Flutterä¸­ä½¿ç”¨SetStateæ— æ•ˆ</title>
    <link href="https://nmk0718.github.io/2022/03/08/flutter%E6%9B%B4%E6%96%B0%E7%8A%B6%E6%80%81%E6%97%A0%E6%95%88/"/>
    <id>https://nmk0718.github.io/2022/03/08/flutter%E6%9B%B4%E6%96%B0%E7%8A%B6%E6%80%81%E6%97%A0%E6%95%88/</id>
    <published>2022-03-08T06:21:48.575Z</published>
    <updated>2022-03-08T06:21:48.575Z</updated>
    
    <content type="html"><![CDATA[<h3 id="åœ¨Flutterä¸­ä½¿ç”¨SetStateæ— æ•ˆï¼Ÿå¯èƒ½æ˜¯å¿½ç•¥äº†è¿™ä¸ªï¼"><a href="#åœ¨Flutterä¸­ä½¿ç”¨SetStateæ— æ•ˆï¼Ÿå¯èƒ½æ˜¯å¿½ç•¥äº†è¿™ä¸ªï¼" class="headerlink" title="åœ¨Flutterä¸­ä½¿ç”¨SetStateæ— æ•ˆï¼Ÿå¯èƒ½æ˜¯å¿½ç•¥äº†è¿™ä¸ªï¼"></a>åœ¨Flutterä¸­ä½¿ç”¨SetStateæ— æ•ˆï¼Ÿå¯èƒ½æ˜¯å¿½ç•¥äº†è¿™ä¸ªï¼</h3><p>é—®é¢˜ï¼šåœ¨æŸä¸ªç»„ä»¶ä¸­è°ƒç”¨setState()æ–¹æ³•æ›´æ–°è¯¥ç»„ä»¶çŠ¶æ€ï¼Œç»“æœæ˜¯æ— æ³•åšåˆ°æ›´æ–°æ•ˆæœï¼Œç»„ä»¶ä»ç„¶ç»´æŒåŸçŠ¶ã€‚<br>ä¸‹é¢æˆ‘ä»¬ç”¨ä»£ç ç¤ºä¾‹è¿˜åŸé—®é¢˜åœºæ™¯ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class _MyHomePageState extends State&lt;MyHomePage&gt; &#123;</span><br><span class="line">  bool isChecked = false;</span><br><span class="line"></span><br><span class="line">  showTestDialog() &#123;</span><br><span class="line">    showDialog(</span><br><span class="line">      context: context,</span><br><span class="line">      builder: (BuildContext context) &#123;</span><br><span class="line">        return SimpleDialog(title: Text(&quot;æµ‹è¯•å¯¹è¯æ¡†æ ‡é¢˜&quot;), children: &lt;Widget&gt;[</span><br><span class="line">          Row(children: &lt;Widget&gt;[</span><br><span class="line">            Checkbox(</span><br><span class="line">                value: this.isChecked,</span><br><span class="line">                onChanged: (bool val) &#123;</span><br><span class="line">                  setState(() &#123;</span><br><span class="line">                    this.isChecked = !this.isChecked;</span><br><span class="line">                  &#125;);</span><br><span class="line">                  debugPrint(this.isChecked.toString());</span><br><span class="line">                &#125;),</span><br><span class="line">            Text(&quot;æµ‹è¯•å¤é€‰æ¡†&quot;)</span><br><span class="line">          ])</span><br><span class="line">        ]);</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    return Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(widget.title),</span><br><span class="line">      ),</span><br><span class="line">      body: Center(</span><br><span class="line">          child: RaisedButton(</span><br><span class="line">        child: Text(&quot;ç‚¹å‡»å‡ºç°å¼¹çª—&quot;),</span><br><span class="line">        onPressed: () &#123;</span><br><span class="line">          showTestDialog();</span><br><span class="line">        &#125;,</span><br><span class="line">      )),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†çªå‡ºé—®é¢˜ç‚¹ï¼Œå‡å°‘ä¸å¿…è¦çš„å¹²æ‰°ï¼Œæˆ‘ç®€åŒ–äº†åŸæœ‰ä»£ç å†…å®¹ã€‚é€šè¿‡é˜…è¯»ä¸Šè¿°ä»£ç ï¼Œæˆ‘ä»¬å¾—çŸ¥æ•´ä¸ªDemoçš„ç•Œé¢æœ‰ä¸€ä¸ªæŒ‰é’®æ„æˆï¼Œå½“æŒ‰é’®è¢«ç‚¹å‡»æ—¶ï¼ŒshowTestDialog()æ–¹æ³•è¢«æ‰§è¡Œã€‚ç•Œé¢å°†æ˜¾ç¤ºä¸€ä¸ªå°çª—å£ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªå¤é€‰æ¡†ã€‚<br>æˆ‘ä»¬è¦å®ç°çš„æ•ˆæœå½“ç„¶æ˜¯ç”¨æˆ·ç‚¹å‡»å¤é€‰æ¡†çš„æ—¶å€™ï¼Œæ”¹å˜å¤é€‰æ¡†çš„çŠ¶æ€ã€‚å› æ­¤ï¼Œåœ¨å¤é€‰æ¡†çš„onChanged()æ–¹æ³•ä¸­æ”¹å˜äº†å†³å®šå¤é€‰æ¡†çŠ¶æ€çš„å¸ƒå°”å€¼ï¼Œå¹¶setState()ã€‚<br>ç„¶è€ŒçœŸå®çš„è¿è¡Œç»“æœå¹¶éåƒé¢„æœŸé‚£æ ·äº§ç”Ÿæ•ˆæœã€‚<br>ç©¶å…¶åŸå› ï¼Œæˆ‘ä»¬è¿˜éœ€ä»setState()è¯´èµ·ã€‚<br>é¡¾åæ€ä¹‰ï¼ŒsetState()è¦æ±‚å…¶ä½œç”¨å¯¹è±¡å¿…é¡»æ˜¯ä¸€ä¸ªæœ‰çŠ¶æ€çš„ç»„ä»¶ã€‚å¦‚æœä½œç”¨å¯¹è±¡æœ¬èº«æ— çŠ¶æ€ï¼Œé‚£ä¹ˆsetState()å°†æ— æ³•èµ·ä½œç”¨ã€‚<br>å› æ­¤ï¼Œæˆ‘ä»¬æ‰¾åˆ°åŸå› ï¼šSimpleDialog()ä¸­çš„å­ç»„ä»¶é»˜è®¤æ˜¯æ— çŠ¶æ€çš„ã€‚<br>æ¥ä¸‹æ¥çš„è§£å†³åŠæ³•å°±ç®€å•äº†ï¼Œåªéœ€è¦åœ¨SimpleDialogç»„ä»¶å¤–éƒ¨â€œå¥—â€ä¸€ä¸ªStatefulBuilderç»„ä»¶å³å¯ã€‚å‚è€ƒä¸‹é¢çš„ä»£ç ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class _MyHomePageState extends State&lt;MyHomePage&gt; &#123;</span><br><span class="line">  bool isChecked = false;</span><br><span class="line"></span><br><span class="line">  showTestDialog() &#123;</span><br><span class="line">    showDialog(</span><br><span class="line">      context: context,</span><br><span class="line">      builder: (BuildContext context) &#123;</span><br><span class="line">        return StatefulBuilder(</span><br><span class="line">          builder:</span><br><span class="line">              (BuildContext context, void Function(void Function()) setState) &#123;</span><br><span class="line">            return SimpleDialog(title: Text(&quot;æµ‹è¯•å¯¹è¯æ¡†æ ‡é¢˜&quot;), children: &lt;Widget&gt;[</span><br><span class="line">              Row(children: &lt;Widget&gt;[</span><br><span class="line">                Checkbox(</span><br><span class="line">                    value: this.isChecked,</span><br><span class="line">                    onChanged: (bool val) &#123;</span><br><span class="line">                      setState(() &#123;</span><br><span class="line">                        this.isChecked = !this.isChecked;</span><br><span class="line">                      &#125;);</span><br><span class="line">                      debugPrint(this.isChecked.toString());</span><br><span class="line">                    &#125;),</span><br><span class="line">                Text(&quot;æµ‹è¯•å¤é€‰æ¡†&quot;)</span><br><span class="line">              ])</span><br><span class="line">            ]);</span><br><span class="line">          &#125;,</span><br><span class="line">        );</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    return Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(widget.title),</span><br><span class="line">      ),</span><br><span class="line">      body: Center(</span><br><span class="line">          child: RaisedButton(</span><br><span class="line">        child: Text(&quot;ç‚¹å‡»å‡ºç°å¼¹çª—&quot;),</span><br><span class="line">        onPressed: () &#123;</span><br><span class="line">          showTestDialog();</span><br><span class="line">        &#125;,</span><br><span class="line">      )),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†æ¬¡è¿è¡Œï¼Œå¯¹è¯æ¡†ä¸­çš„å¤é€‰æ¡†å¯ä»¥æ­£å¸¸å“åº”ã€‚è‡³æ­¤ï¼Œé—®é¢˜è§£å†³ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š<a href="https://juejin.cn/post/6844904195531735048" target="_blank" rel="noopener">https://juejin.cn/post/6844904195531735048</a>  </p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;åœ¨Flutterä¸­ä½¿ç”¨SetStateæ— æ•ˆï¼Ÿå¯èƒ½æ˜¯å¿½ç•¥äº†è¿™ä¸ªï¼&quot;&gt;&lt;a href=&quot;#åœ¨Flutterä¸­ä½¿ç”¨SetStateæ— æ•ˆï¼Ÿå¯èƒ½æ˜¯å¿½ç•¥äº†è¿™ä¸ªï¼&quot; class=&quot;headerlink&quot; title=&quot;åœ¨Flutterä¸­ä½¿ç”¨SetStateæ— æ•ˆï¼Ÿå¯èƒ½æ˜¯å¿½ç•¥äº†è¿™ä¸ª</summary>
      
    
    
    
    
    <category term="flutter" scheme="https://nmk0718.github.io/tag/flutter/"/>
    
  </entry>
  
  <entry>
    <title>Flutterè‡ªå®šä¹‰Tabbarçš„é•¿åº¦</title>
    <link href="https://nmk0718.github.io/2022/03/08/flutter%E8%87%AA%E5%AE%9A%E4%B9%89Tabbar%E7%9A%84%E9%97%AE%E9%A2%98/"/>
    <id>https://nmk0718.github.io/2022/03/08/flutter%E8%87%AA%E5%AE%9A%E4%B9%89Tabbar%E7%9A%84%E9%97%AE%E9%A2%98/</id>
    <published>2022-03-08T06:21:20.805Z</published>
    <updated>2024-09-20T02:23:09.885Z</updated>
    
    <content type="html"><![CDATA[<p>æ•ˆæœ:ç”¨æˆ·å¯è‡ªå®šä¹‰Tabbarçš„é•¿åº¦å’Œæ’åº,é€šè¿‡æ»‘åŠ¨æˆ–ç‚¹å‡»Tabbarè¿›è¡Œè¯·æ±‚æ¥å£æ¸²æŸ“ä¸åŒçš„é¡µé¢</p><p>é—®é¢˜:è®©ç”¨æˆ·è‡ªå®šä¹‰Tabbarçš„é•¿åº¦,å½“ç”¨æˆ·åˆ é™¤Tabbarçš„ä¸€é¡¹æ—¶å‡ºç°æŠ¥é”™</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Controller&apos;s length property (5) does not match the number of tabs (4) prese</span><br></pre></td></tr></table></figure><p>ä»£ç ä¸º:</p><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">TabController tabController;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@override</span>  </span><br><span class="line"><span class="keyword">void</span> initState() &#123;  </span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> implement initState  </span></span><br><span class="line">  <span class="keyword">super</span>.initState(); </span><br><span class="line"> tabController = TabController(  </span><br><span class="line">      length: websiteList.length, vsync: <span class="keyword">this</span>);  </span><br><span class="line">  tabController..addListener(() &#123;  </span><br><span class="line">    <span class="keyword">if</span>(tabController.indexIsChanging)&#123;  </span><br><span class="line">      <span class="built_in">print</span>(tabController.index.toString());  </span><br><span class="line">    &#125;  </span><br><span class="line">  &#125;);  </span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@override</span>  </span><br><span class="line">Widget build(BuildContext context) &#123;  </span><br><span class="line">  <span class="keyword">return</span> Scaffold(  </span><br><span class="line">      appBar: AppBar(  </span><br><span class="line">        bottom: TabBar(  </span><br><span class="line">              indicatorColor: Color(<span class="number">0xFFFE1483</span>),  </span><br><span class="line">              labelColor: Color(<span class="number">0xFFFE1483</span>),  </span><br><span class="line">              controller: tabController,  </span><br><span class="line">              unselectedLabelColor: Colors.black54,  </span><br><span class="line">              isScrollable: <span class="keyword">true</span>,  </span><br><span class="line">              indicatorSize: TabBarIndicatorSize.label,  </span><br><span class="line">              tabs: TabList()),  </span><br><span class="line">        ),</span><br><span class="line">      body: TabBarView(  </span><br><span class="line">        controller: tabController,  </span><br><span class="line">        children: CardList(),  </span><br><span class="line">      ),);</span><br></pre></td></tr></table></figure><p>initState(){}åªåˆå§‹åŒ–ä¸€æ¬¡,å½“ç”¨æˆ·åˆ é™¤websiteListä¸­çš„å€¼æ—¶,websiteList.lengthå‘ç”Ÿå˜åŒ–,ç”¨æˆ·å†æ¬¡è¿›å…¥è¯¥ç•Œé¢å°±ä¼šå‡ºç°æŠ¥é”™<br>è§£å†³:</p><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="meta">@override</span>  </span><br><span class="line"><span class="keyword">void</span> initState() &#123;  </span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> implement initState  </span></span><br><span class="line">  <span class="keyword">super</span>.initState();  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@override</span>  </span><br><span class="line">Widget build(BuildContext context) &#123;  </span><br><span class="line">  <span class="keyword">return</span> DefaultTabController(  </span><br><span class="line">    length: websiteList.length,  </span><br><span class="line">    child: Builder(  </span><br><span class="line">      builder: (BuildContext context)&#123;  </span><br><span class="line">        <span class="keyword">final</span> TabController tabController = DefaultTabController.of(context);  </span><br><span class="line">        tabController.addListener(() &#123;   </span><br><span class="line"> <span class="keyword">if</span> (tabController.index.toDouble() ==  </span><br><span class="line">                tabController.animation.value) &#123;  </span><br><span class="line">              <span class="built_in">print</span>(tabController.index.toString());  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;);  </span><br><span class="line">        <span class="keyword">return</span> Scaffold(  </span><br><span class="line">          appBar: AppBar(  </span><br><span class="line">            elevation: <span class="number">2</span>,  </span><br><span class="line">            bottom: TabBar(  </span><br><span class="line">                  indicatorColor: Color(<span class="number">0xFFFE1483</span>),  </span><br><span class="line">                  labelColor: Color(<span class="number">0xFFFE1483</span>),  </span><br><span class="line">                  unselectedLabelColor: Colors.black54,  </span><br><span class="line">                  isScrollable: <span class="keyword">true</span>,  </span><br><span class="line">                  indicatorSize: TabBarIndicatorSize.label,  </span><br><span class="line">                  tabs: TabList()),  </span><br><span class="line">            ),  </span><br><span class="line">          body: TabBarView(  </span><br><span class="line">            children: CardList(),  </span><br><span class="line">          ),  </span><br><span class="line">        );  </span><br><span class="line">      &#125;,  </span><br><span class="line">    )  </span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>é€šè¿‡DefaultTabControllerè§£å†³å› websiteListå‘ç”Ÿå˜åŒ–å‡ºç°çš„é—®é¢˜,é€šè¿‡Builder()è¿›è¡Œç›‘å¬ç”¨æˆ·æ˜¯å¦ç‚¹å‡»å’Œæ»‘åŠ¨tabbar,å³å¯è§£å†³é—®é¢˜</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æ•ˆæœ:ç”¨æˆ·å¯è‡ªå®šä¹‰Tabbarçš„é•¿åº¦å’Œæ’åº,é€šè¿‡æ»‘åŠ¨æˆ–ç‚¹å‡»Tabbarè¿›è¡Œè¯·æ±‚æ¥å£æ¸²æŸ“ä¸åŒçš„é¡µé¢&lt;/p&gt;
&lt;p&gt;é—®é¢˜:è®©ç”¨æˆ·è‡ªå®šä¹‰Tabbarçš„é•¿åº¦,å½“ç”¨æˆ·åˆ é™¤Tabbarçš„ä¸€é¡¹æ—¶å‡ºç°æŠ¥é”™&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table</summary>
      
    
    
    
    
    <category term="flutter" scheme="https://nmk0718.github.io/tag/flutter/"/>
    
  </entry>
  
  <entry>
    <title>adbå¸è½½ç³»ç»Ÿè‡ªå¸¦è½¯ä»¶</title>
    <link href="https://nmk0718.github.io/2022/01/18/ADB%E5%8D%B8%E8%BD%BD%E7%B3%BB%E7%BB%9F%E8%87%AA%E5%B8%A6%E8%BD%AF%E4%BB%B6/"/>
    <id>https://nmk0718.github.io/2022/01/18/ADB%E5%8D%B8%E8%BD%BD%E7%B3%BB%E7%BB%9F%E8%87%AA%E5%B8%A6%E8%BD%AF%E4%BB%B6/</id>
    <published>2022-01-18T09:42:00.000Z</published>
    <updated>2025-02-10T04:00:59.681Z</updated>
    
    <content type="html"><![CDATA[<p>ADB</p><p>æ‰‹æœºç«¯é€šè¿‡å¤šæ¬¡ç‚¹å‡»ç‰ˆæœ¬å·å¼€å¯å¼€å‘è€…é€‰é¡¹,å‹¾é€‰USBè°ƒè¯•</p><img src="https://nmk0718.github.io/image/Screenshot_20210910-175528.png" style="zoom:50%;"><p>ä½¿ç”¨æ‰‹æœºæ•°æ®çº¿è¿æ¥ç”µè„‘,æ­¤æ—¶æ‰‹æœºä¼šæç¤ºæ˜¯å¦å…è®¸USBè°ƒè¯•,å…è®¸å³å¯</p><p>ç”µè„‘ç«¯ä¸‹è½½platform-tools</p><p><a href="https://developer.android.google.cn/studio/releases/platform-tools" target="_blank" rel="noopener">https://developer.android.google.cn/studio/releases/platform-tools</a></p><img src="https://nmk0718.github.io/image/image-20210910175440529.png" style="zoom:50%;"><p>è§£å‹ä¸‹è½½çš„å‹ç¼©åŒ…,è¿›å…¥platform-toolsç›®å½•,åœ¨åœ°å€æ è¾“å…¥adb,ç¡®è®¤</p><img src="https://nmk0718.github.io/image/image-20210910175755437.png" style="zoom:50%;"><p>æŸ¥çœ‹å½“å‰è¿æ¥è®¾å¤‡ï¼š</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">adb devices</span><br></pre></td></tr></table></figure><p>å¦‚æœå‘ç°å¤šä¸ªè®¾å¤‡ï¼š</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">adb devices -s è®¾å¤‡å</span><br></pre></td></tr></table></figure><p>å¸è½½è½¯ä»¶</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">adb shell</span><br><span class="line"></span><br><span class="line">pm uninstall</span><br><span class="line">pm uninstall -k --user <span class="number">0</span> è½¯ä»¶åŒ…å</span><br></pre></td></tr></table></figure><p>å»é™¤wifiæ„Ÿå¹å·</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">åˆ é™¤å˜é‡ï¼šï¼ˆåˆ é™¤ä»¥åé»˜è®¤å¯ç”¨ï¼‰</span><br><span class="line">adb shell settings delete global captive_portal_mode</span><br><span class="line">å…³é—­æ£€æµ‹ï¼š</span><br><span class="line">adb shell settings put global captive_portal_mode 0</span><br><span class="line">æŸ¥çœ‹å½“å‰çŠ¶æ€ï¼š</span><br><span class="line">adb shell settings get global captive_portal_mode</span><br><span class="line">æœåŠ¡å™¨åœ°å€ç›¸å…³ï¼ˆåŒ7.1.1ï¼‰ï¼š</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">åˆ é™¤ï¼ˆåˆ é™¤é»˜è®¤ç”¨HTTPSï¼‰</span><br><span class="line">adb shell settings delete global captive_portal_https_url</span><br><span class="line">adb shell settings delete global captive_portal_http_url</span><br><span class="line">åˆ†åˆ«ä¿®æ”¹ä¸¤ä¸ªåœ°å€</span><br><span class="line">adb shell settings put global captive_portal_http_url http://captive.v2ex.co/generate_204</span><br><span class="line">adb shell settings put global captive_portal_https_url https://captive.v2ex.co/generate_204</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ADB&lt;/p&gt;
&lt;p&gt;æ‰‹æœºç«¯é€šè¿‡å¤šæ¬¡ç‚¹å‡»ç‰ˆæœ¬å·å¼€å¯å¼€å‘è€…é€‰é¡¹,å‹¾é€‰USBè°ƒè¯•&lt;/p&gt;
&lt;img src=&quot;https://nmk0718.github.io/image/Screenshot_20210910-175528.png&quot; style=&quot;zoom:50%;&quot;&gt;

</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>goproxy</title>
    <link href="https://nmk0718.github.io/2022/01/10/goproxy/"/>
    <id>https://nmk0718.github.io/2022/01/10/goproxy/</id>
    <published>2022-01-10T08:56:35.000Z</published>
    <updated>2024-09-29T07:06:41.525Z</updated>
    
    <content type="html"><![CDATA[<h3 id="goproxy"><a href="#goproxy" class="headerlink" title="goproxy"></a>goproxy</h3><p>GoProxyæ˜¯ä¸€æ¬¾è½»é‡çº§ã€åŠŸèƒ½å¼ºå¤§ã€é«˜æ€§èƒ½çš„httpä»£ç†ã€httpsä»£ç†ã€socks5ä»£ç†ã€å†…ç½‘ç©¿é€ä»£ç†æœåŠ¡å™¨ã€ssä»£ç†ã€æ¸¸æˆç›¾ã€æ¸¸æˆä»£ç†ï¼Œæ”¯æŒAPIä»£ç†è®¤è¯ã€‚websockeä»£ç†ã€tcpä»£ç†ã€udpä»£ç†ã€socketä»£ç†ã€é«˜é˜²æœåŠ¡å™¨ã€‚æ”¯æŒæ­£å‘ä»£ç†ã€åå‘ä»£ç†ã€é€æ˜ä»£ç†ã€TCPå†…ç½‘ç©¿é€ã€UDPå†…ç½‘ç©¿é€ã€HTTPå†…ç½‘ç©¿é€ã€HTTPSå†…ç½‘ç©¿é€ã€httpsä»£ç†è´Ÿè½½å‡è¡¡ã€httpä»£ç†è´Ÿè½½å‡è¡¡ã€socks5ä»£ç†è´Ÿè½½å‡è¡¡ã€socketä»£ç†è´Ÿè½½å‡è¡¡ã€ssä»£ç†è´Ÿè½½å‡è¡¡ã€TCP/UDPç«¯å£æ˜ å°„ã€SSHä¸­è½¬ã€TLSåŠ å¯†ä¼ è¾“ã€åè®®è½¬æ¢ã€é˜²æ±¡æŸ“DNSä»£ç†ï¼Œé™é€Ÿï¼Œé™è¿æ¥æ•°ã€‚</p><ul><li><a href="https://github.com/snail007/goproxy/releases" target="_blank" rel="noopener">ä¸‹è½½åœ°å€</a><h4 id="windowså¼€å¯ä»£ç†"><a href="#windowså¼€å¯ä»£ç†" class="headerlink" title="windowså¼€å¯ä»£ç†"></a>windowså¼€å¯ä»£ç†</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">C:\Users\admin&gt;cd Desktop\proxy-windows-amd64</span><br><span class="line"></span><br><span class="line">C:\Users\admin\Desktop\proxy-windows-amd64&gt;proxy.exe http -t tcp -p &quot;:7002&quot;</span><br><span class="line"></span><br><span class="line">proxy free version 8.6  by snail , email : arraykeys@gmail.com</span><br><span class="line">2022/01/12 10:12:13 tcp http(s) proxy on [::]:7002</span><br></pre></td></tr></table></figure></li></ul><h4 id="linuxæœåŠ¡å™¨é…ç½®å…¨å±€ä»£ç†"><a href="#linuxæœåŠ¡å™¨é…ç½®å…¨å±€ä»£ç†" class="headerlink" title="linuxæœåŠ¡å™¨é…ç½®å…¨å±€ä»£ç†"></a>linuxæœåŠ¡å™¨é…ç½®å…¨å±€ä»£ç†</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@centos ~]# vi /etc/profile</span><br><span class="line"><span class="meta">#</span><span class="bash"> åœ¨æœ€åé¢åŠ å…¥ä»¥ä¸‹é…ç½®</span></span><br><span class="line"></span><br><span class="line">http_proxy=192.168.10.117:7002 </span><br><span class="line">https_proxy=192.168.10.117:7002</span><br><span class="line">ftp_proxy=192.168.10.117:7002</span><br><span class="line"><span class="meta">#</span><span class="bash"> æŒ‡å®šä»£ç†æ‰€åœ¨çš„ipå’Œport</span></span><br><span class="line">export http_proxy https_proxy ftp_proxy no_proxy</span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆ†åˆ«æŒ‡å®šhttpã€httpsã€ftpåè®®ä½¿ç”¨çš„ä»£ç†æœåŠ¡å™¨åœ°å€</span></span><br><span class="line"></span><br><span class="line">no_proxy=*.abc.com,192.168.20.*,192.168.50.*,*.local,localhost,127.0.0.1  # è®¿é—®å±€åŸŸç½‘åœ°å€ï¼ˆip/ç½‘æ®µï¼‰æ—¶ä¸ä½¿ç”¨ä»£ç†ï¼Œå¯ä»¥ç”¨é€—å·åˆ†éš”å¤šä¸ª&gt;åœ°å€</span><br><span class="line"></span><br><span class="line">[root@centos ~]# source /etc/profile</span><br></pre></td></tr></table></figure><p>æµ‹è¯•æ˜¯å¦èµ°ä»£ç†</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@centos ~]# curl https://myip.ipip.net/</span><br><span class="line">å½“å‰ IPï¼š119.130.113.243  æ¥è‡ªäºï¼šä¸­å›½ å¹¿ä¸œ å¹¿å·  ç”µä¿¡</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æ˜¯å¦ä½¿ç”¨ä»£ç†</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">C:\Users\admin\Desktop\proxy-windows-amd64&gt;proxy.exe http -t tcp -p &quot;:7002&quot;</span><br><span class="line"></span><br><span class="line">proxy free version 8.6  by snail , email : arraykeys@gmail.com</span><br><span class="line">2022/01/12 10:12:13 tcp http(s) proxy on [::]:7002</span><br><span class="line">2022/01/12 10:46:48 CONNECT:myip.ipip.net:443</span><br><span class="line">2022/01/12 10:46:48 use parent : false, myip.ipip.net:443</span><br><span class="line">2022/01/12 10:46:48 conn 192.168.50.54:45768 - 116.211.155.164:443 connected [myip.ipip.net:443]</span><br><span class="line">2022/01/12 10:46:48 conn 192.168.50.54:45768 - 116.211.155.164:443 released [myip.ipip.net:443]</span><br></pre></td></tr></table></figure><h4 id="JAVAé…ç½®ä»£ç†"><a href="#JAVAé…ç½®ä»£ç†" class="headerlink" title="JAVAé…ç½®ä»£ç†"></a>JAVAé…ç½®ä»£ç†</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># JVMä¸­åŠ å…¥ä»¥ä¸‹é…ç½®</span></span><br><span class="line"></span><br><span class="line">-Dhttp.proxyHost=192.168.10.117 -Dhttp.proxyPort=7002 -Dhttps.proxyHost=192.168.10.117 -Dhttps.proxyPort=7002 -Dhttp.nonProxyHosts=<span class="string">'localhost|127.0.0.1|192.168.20.*|192.168.50.*'</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;goproxy&quot;&gt;&lt;a href=&quot;#goproxy&quot; class=&quot;headerlink&quot; title=&quot;goproxy&quot;&gt;&lt;/a&gt;goproxy&lt;/h3&gt;&lt;p&gt;GoProxyæ˜¯ä¸€æ¬¾è½»é‡çº§ã€åŠŸèƒ½å¼ºå¤§ã€é«˜æ€§èƒ½çš„httpä»£ç†ã€httpsä»£ç†ã€socks5ä»£ç†ã€å†…ç½‘ç©¿</summary>
      
    
    
    
    
    <category term="proxy" scheme="https://nmk0718.github.io/tag/proxy/"/>
    
  </entry>
  
  <entry>
    <title>ç”Ÿäº§å‘Šè­¦</title>
    <link href="https://nmk0718.github.io/2021/11/02/%E7%94%9F%E4%BA%A7%E5%91%8A%E8%AD%A6/"/>
    <id>https://nmk0718.github.io/2021/11/02/%E7%94%9F%E4%BA%A7%E5%91%8A%E8%AD%A6/</id>
    <published>2021-11-02T10:10:00.000Z</published>
    <updated>2025-02-10T04:00:59.747Z</updated>
    
    <content type="html"><![CDATA[<p>æ–°å¢æŠ¥è­¦è”ç³»äºº</p><img src="https://nmk0718.github.io/image/image-20211102142732840.png"><p>é…ç½®æŠ¥è­¦è”ç³»äºº</p><img src="https://nmk0718.github.io/image/image-20211102142749711.png"><p>è·å–Webhookåœ°å€:</p><p>é’‰é’‰ç¾¤èŠ&gt;ç¾¤è®¾ç½®&gt;æ™ºèƒ½ç¾¤åŠ©æ‰‹&gt;æ·»åŠ è‡ªå®šä¹‰æœºå™¨äºº</p><img src="https://nmk0718.github.io/image/image-20211102143103962.png"><p>æŠŠWebhookå¤åˆ¶ä¸‹æ¥,ç²˜è´´åˆ°æŠ¥è­¦è”ç³»äººå¤„,é…ç½®é’‰é’‰æœºå™¨äººæ¥å—çš„æ¶ˆæ¯,åŒ…å«æœ‰è‡ªå®šä¹‰çš„å…³é”®è¯è¯¥é’‰é’‰æœºå™¨äººæ‰èƒ½å‘Šè­¦</p><img src="https://nmk0718.github.io/image/image-20211102143149384.png"><p>æ·»åŠ æ–°å»ºçš„æŠ¥è­¦è”ç³»äººåˆ°æŠ¥è­¦è”ç³»ç»„é‡Œ</p><img src="https://nmk0718.github.io/image/image-20211102143358722.png"><p>å¼€å¯å·²ä½¿ç”¨æœåŠ¡çš„ä¸€é”®å‘Šè­¦</p><img src="https://nmk0718.github.io/image/image-20211102143552738.png"><p>æ·»åŠ å‘Šè­¦è§„åˆ™</p><img src="https://nmk0718.github.io/image/image-20211102144026183.png"><p>åˆ›å»ºç«™ç‚¹ç›‘æ§</p><img src="https://nmk0718.github.io/image/image-20211102144614290.png"><p>æ·»åŠ ç›‘æ§åœ°å€</p><img src="https://nmk0718.github.io/image/image-20211102144708411.png"><p>é€‰æ‹©é»˜è®¤æ¢æµ‹ç‚¹</p><img src="https://nmk0718.github.io/image/image-20211102144729537.png"><p>æ·»åŠ çŠ¶æ€ç ç›‘æ§</p><img src="https://nmk0718.github.io/image/image-20211102144849168.png"><p>é€‰æ‹©é€šçŸ¥è”ç³»äºº</p><img src="https://nmk0718.github.io/image/image-20211102144907626.png"><p>æ·»åŠ äº‹ä»¶æŠ¥è­¦è§„åˆ™</p><img src="https://nmk0718.github.io/image/image-20211102145059404.png"><p>å› èŠ‚çº¦å¼€æ”¯,æš‚æ—¶ä½¿ç”¨çš„å…è´¹ç‰ˆ,è¿™é‡Œä¸ä»‹ç»æ—¥å¿—ç›‘æ§</p><p>æ·»åŠ å®¹å™¨ç›‘æ§</p><img src="https://nmk0718.github.io/image/image-20211102145557851.png"><p>åˆ›å»ºæŠ¥è­¦è§„åˆ™</p><img src="https://nmk0718.github.io/image/image-20211102145848290.png"><p>kubernetesé›†ç¾¤æŠ¥è­¦</p><img src="https://nmk0718.github.io/image/image-20211102150127881.png"><p>å¼€å¯äº‹ä»¶å‘Šè­¦</p><img src="https://nmk0718.github.io/image/image-20211102150323136.png"><p>ç‚¹å‡»ç¼–è¾‘,æ›´æ”¹å‘Šè­¦ç­–ç•¥,æ–°å¢è¡ŒåŠ¨ç­–ç•¥</p><img src="https://nmk0718.github.io/image/image-20211102164419525.png"><p>é…ç½®é’‰é’‰å’ŒçŸ­ä¿¡å‘Šè­¦çš„é€šçŸ¥å†…å®¹å’Œé€šçŸ¥äººå‘˜,å¯è‡ªå®šä¹‰å†…å®¹æ¨¡æ¿é…ç½®é€šçŸ¥çš„æ¶ˆæ¯æ ·å¼</p><img src="https://nmk0718.github.io/image/image-20211102164508877.png"><p>é’‰é’‰çš„Webhookéœ€è¦è¿›è¡Œæ–°å»ºåœ¨å‘Šè­¦ç®¡ç†&gt;Webhookç»§æ‰¿ä¸­æ–°å¢é…ç½®</p><img src="https://nmk0718.github.io/image/image-20211102164717899.png"><p>æŸ¥è¯¢æœåŠ¡æŠ¥é”™çš„æ—¥å¿—é€šè¿‡æ—¥å¿—ç›‘æ§è¿›è¡Œå‘Šè­¦</p><img src="https://nmk0718.github.io/image/image-20211102171254181.png"><p>é…ç½®æ¯15åˆ†é’Ÿç›‘æ§æ—¥å¿—,å¦‚æœæ—¥å¿—ä¸­æœ‰è¯¥æ•°æ®ä¼šè¿›è¡Œå‘Šè­¦</p><img src="https://nmk0718.github.io/image/image-20211102171409665.png"><p>å¯åœ¨å‘Šè­¦çœ‹åˆ°åˆ›å»ºçš„å‘Šè­¦,è¯¥å‘Šè­¦çš„æ‰§è¡ŒçŠ¶æ€,æ˜¯å¦è§¦å‘é€šçŸ¥</p><img src="https://nmk0718.github.io/image/image-20211102171609247.png">]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æ–°å¢æŠ¥è­¦è”ç³»äºº&lt;/p&gt;
&lt;img src=&quot;https://nmk0718.github.io/image/image-20211102142732840.png&quot;&gt;

&lt;p&gt;é…ç½®æŠ¥è­¦è”ç³»äºº&lt;/p&gt;
&lt;img src=&quot;https://nmk0718.github.io/i</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>sqlå®¡æ ¸</title>
    <link href="https://nmk0718.github.io/2021/10/19/sql%E5%AE%A1%E6%A0%B8/"/>
    <id>https://nmk0718.github.io/2021/10/19/sql%E5%AE%A1%E6%A0%B8/</id>
    <published>2021-10-19T07:58:00.000Z</published>
    <updated>2025-02-10T04:00:59.747Z</updated>
    
    <content type="html"><![CDATA[<h2 id="SQLå®¡æ ¸"><a href="#SQLå®¡æ ¸" class="headerlink" title="SQLå®¡æ ¸"></a>SQLå®¡æ ¸</h2><p>Archeyæ›´å…¨é¢,æ”¯æŒå¤šç§ç±»æ•°æ®åº“,ä½†æ˜¯ä½¿ç”¨è¿‡ç¨‹ä¸­å»ºè¡¨è¯­å¥æœªèƒ½é€šè¿‡æäº¤SQLå®¡æ ¸,ç•¥æœ‰ä¸è¶³</p><p>Yearningåªæ”¯æŒmysqlæ•°æ®åº“ åŠŸèƒ½ç›¸å¯¹æ¯”è¾ƒå…¨é¢,ä½†ä¸æ”¯æŒå…¶å®ƒæ•°æ®åº“.</p><h3 id="Archery"><a href="#Archery" class="headerlink" title="Archery"></a>Archery</h3><p>Archeryæ˜¯<a href="https://github.com/jly8866/archer" target="_blank" rel="noopener">archer</a>çš„åˆ†æ”¯é¡¹ç›®ï¼Œå®šä½äºSQLå®¡æ ¸æŸ¥è¯¢å¹³å°ï¼Œæ—¨åœ¨æå‡DBAçš„å·¥ä½œæ•ˆç‡ï¼Œæ”¯æŒå¤šæ•°æ®åº“çš„SQLä¸Šçº¿å’ŒæŸ¥è¯¢ï¼ŒåŒæ—¶æ”¯æŒä¸°å¯Œçš„MySQLè¿ç»´åŠŸèƒ½ï¼Œæ‰€æœ‰åŠŸèƒ½éƒ½å…¼å®¹æ‰‹æœºç«¯æ“ä½œ</p><p>ç›¸å…³æ–‡æ¡£å¯æŸ¥çœ‹<a href="https://archerydms.com/" target="_blank" rel="noopener">https://archerydms.com/</a></p><h4 id="åŠŸèƒ½æ¸…å•"><a href="#åŠŸèƒ½æ¸…å•" class="headerlink" title="åŠŸèƒ½æ¸…å•"></a>åŠŸèƒ½æ¸…å•</h4><table><thead><tr><th></th><th>æŸ¥è¯¢</th><th>å®¡æ ¸</th><th>æ‰§è¡Œ</th><th>å¤‡ä»½</th><th>æ•°æ®å­—å…¸</th><th>æ…¢æ—¥å¿—</th><th>ä¼šè¯ç®¡ç†</th><th>è´¦å·ç®¡ç†</th><th>å‚æ•°ç®¡ç†</th><th>æ•°æ®å½’æ¡£</th></tr></thead><tbody><tr><td>MySQL</td><td>âˆš</td><td>âˆš</td><td>âˆš</td><td>âˆš</td><td>âˆš</td><td>âˆš</td><td>âˆš</td><td>âˆš</td><td>âˆš</td><td>âˆš</td></tr><tr><td>MsSQL</td><td>âˆš</td><td>Ã—</td><td>âˆš</td><td>Ã—</td><td>Ã—</td><td>Ã—</td><td>Ã—</td><td>Ã—</td><td>Ã—</td><td>Ã—</td></tr><tr><td>Redis</td><td>âˆš</td><td>Ã—</td><td>âˆš</td><td>Ã—</td><td>Ã—</td><td>Ã—</td><td>Ã—</td><td>Ã—</td><td>Ã—</td><td>Ã—</td></tr><tr><td>PgSQL</td><td>âˆš</td><td>Ã—</td><td>âˆš</td><td>Ã—</td><td>Ã—</td><td>Ã—</td><td>Ã—</td><td>Ã—</td><td>Ã—</td><td>Ã—</td></tr><tr><td>Oracle</td><td>âˆš</td><td>Ã—</td><td>âˆš</td><td>âœ”ï¸</td><td>Ã—</td><td>Ã—</td><td>Ã—</td><td>Ã—</td><td>Ã—</td><td>Ã—</td></tr><tr><td>MongoDB</td><td>âˆš</td><td>âˆš</td><td>âˆš</td><td>Ã—</td><td>Ã—</td><td>Ã—</td><td>Ã—</td><td>Ã—</td><td>Ã—</td><td>Ã—</td></tr></tbody></table><p>ä¸‹è½½æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https://github.com/hhyo/archery/releases/</span><br></pre></td></tr></table></figure><p>è§£å‹Archery-1.8.1.zip,è¿›å…¥src/docker-compose</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#å¯åŠ¨</span><br><span class="line">docker-compose -f docker-compose.yml up -d</span><br><span class="line"></span><br><span class="line">#è¡¨ç»“æ„åˆå§‹åŒ–</span><br><span class="line">docker exec -ti archery /bin/bash</span><br><span class="line">cd /opt/archery</span><br><span class="line">source /opt/venv4archery/bin/activate</span><br><span class="line">python3 manage.py makemigrations sql  </span><br><span class="line">python3 manage.py migrate</span><br><span class="line"></span><br><span class="line">#æ•°æ®åˆå§‹åŒ–</span><br><span class="line">python3 manage.py dbshell&lt;sql/fixtures/auth_group.sql</span><br><span class="line">python3 manage.py dbshell&lt;src/init_sql/mysql_slow_query_review.sql</span><br><span class="line"></span><br><span class="line">#åˆ›å»ºç®¡ç†ç”¨æˆ·</span><br><span class="line">python3 manage.py createsuperuser</span><br><span class="line"></span><br><span class="line">#é‡å¯æœåŠ¡</span><br><span class="line">docker restart archery</span><br><span class="line"></span><br><span class="line">#æ—¥å¿—æŸ¥çœ‹å’Œé—®é¢˜æ’æŸ¥</span><br><span class="line">docker logs archery -f --tail=10</span><br><span class="line">logs/archery.log</span><br></pre></td></tr></table></figure><h4 id="è®¿é—®"><a href="#è®¿é—®" class="headerlink" title="è®¿é—®"></a>è®¿é—®</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:9123/</span><br></pre></td></tr></table></figure><h4 id="ç®¡ç†åå°"><a href="#ç®¡ç†åå°" class="headerlink" title="ç®¡ç†åå°"></a>ç®¡ç†åå°</h4><img src="https://nmk0718.github.io/image/image-20211018170733013.png"><h5 id="SQLå·¥å•"><a href="#SQLå·¥å•" class="headerlink" title="SQLå·¥å•"></a>SQLå·¥å•</h5><img src="https://nmk0718.github.io/image/image-20211019152901342.png"><h5 id="å®ä¾‹æ ‡ç­¾"><a href="#å®ä¾‹æ ‡ç­¾" class="headerlink" title="å®ä¾‹æ ‡ç­¾"></a>å®ä¾‹æ ‡ç­¾</h5><img src="https://nmk0718.github.io/image/image-20211019152940335.png"><h5 id="èµ„æºç»„"><a href="#èµ„æºç»„" class="headerlink" title="èµ„æºç»„"></a>èµ„æºç»„</h5><p>é…ç½®é’‰é’‰webhookåœ°å€</p><img src="https://nmk0718.github.io/image/image-20211019153118639.png"><h5 id="ç»„"><a href="#ç»„" class="headerlink" title="ç»„"></a>ç»„</h5><p>DBAæŒæœ‰æ‰€æœ‰æƒé™,ç ”å‘æŒæœ‰å„èœå•æƒé™+æäº¤æŸ¥çœ‹å·¥å•ç­‰æƒé™,ä¸ç»™äºˆåˆ é™¤ç­‰æƒé™</p><img src="https://nmk0718.github.io/image/image-20211019153734553.png"><h5 id="æ·»åŠ å®ä¾‹æ•°æ®åº“"><a href="#æ·»åŠ å®ä¾‹æ•°æ®åº“" class="headerlink" title="æ·»åŠ å®ä¾‹æ•°æ®åº“"></a>æ·»åŠ å®ä¾‹æ•°æ®åº“</h5><p>é…ç½®ç”¨å¯¹åº”æ•°æ®åº“ç±»å‹å’Œè´¦å·å¯†ç </p><img src="https://nmk0718.github.io/image/image-20211019153002684.png"><p>ç»‘å®šå¯¹åº”çš„èµ„æºç»„å’Œå®ä¾‹æ ‡ç­¾</p><img src="https://nmk0718.github.io/image/image-20211019153227623.png"><h5 id="å·¥ä½œæµå®¡æ‰¹åˆ—è¡¨"><a href="#å·¥ä½œæµå®¡æ‰¹åˆ—è¡¨" class="headerlink" title="å·¥ä½œæµå®¡æ‰¹åˆ—è¡¨"></a>å·¥ä½œæµå®¡æ‰¹åˆ—è¡¨</h5><img src="https://nmk0718.github.io/image/image-20211019153303927.png"><h5 id="å·¥ä½œæµæ—¥å¿—"><a href="#å·¥ä½œæµæ—¥å¿—" class="headerlink" title="å·¥ä½œæµæ—¥å¿—"></a>å·¥ä½œæµæ—¥å¿—</h5><img src="https://nmk0718.github.io/image/image-20211019153351803.png"><h5 id="SQLæŸ¥è¯¢æ—¥å¿—"><a href="#SQLæŸ¥è¯¢æ—¥å¿—" class="headerlink" title="SQLæŸ¥è¯¢æ—¥å¿—"></a>SQLæŸ¥è¯¢æ—¥å¿—</h5><img src="https://nmk0718.github.io/image/image-20211019153423219.png"><h5 id="ç”¨æˆ·ç®¡ç†"><a href="#ç”¨æˆ·ç®¡ç†" class="headerlink" title="ç”¨æˆ·ç®¡ç†"></a>ç”¨æˆ·ç®¡ç†</h5><img src="https://nmk0718.github.io/image/image-20211019153447362.png"><p>é…ç½®ç”¨æˆ·æƒé™</p><img src="https://nmk0718.github.io/image/image-20211019153526237.png"><h4 id="SQLä¸Šçº¿"><a href="#SQLä¸Šçº¿" class="headerlink" title="SQLä¸Šçº¿"></a>SQLä¸Šçº¿</h4><p>æäº¤è¦ä¸Šçº¿çš„è„šæœ¬</p><img src="https://nmk0718.github.io/image/image-20211018171429300.png"><p>æ”¯æŒ10Må†…SQLæ–‡ä»¶å¯¼å…¥,ä¸Šçº¿å•åç§°(å¿…å¡«),é€‰æ‹©å¯¹åº”çš„èµ„æºç»„,å¯¹åº”çš„æ•°æ®åº“,å¯¹åº”çš„è¡¨,sqlæäº¤å‰éœ€è¦è¿›è¡Œä¸€æ¬¡SQLæ£€æµ‹,æ£€æµ‹é€šè¿‡åæ‰èƒ½è¿›è¡ŒSQLæäº¤</p><img src="https://nmk0718.github.io/image/image-20211018171816343.png"><p>SQLæ£€æµ‹ä¸é€šè¿‡çš„æƒ…å†µ,æ•°æ®åº“ä¸­æ²¡æœ‰idä¸º3çš„æ•°æ®,ç›´æ¥è¿›è¡Œæ›´æ–°nameä¼šè¿›è¡ŒæŠ¥é”™,å¹¶æç¤º</p><img src="https://nmk0718.github.io/image/image-20211018172052899.png"><p>å®¡æ ¸çŠ¶æ€:error,warning,pass,å½“å®¡æ ¸çŠ¶æ€å¤„äºerroræ—¶æ‰§è¡Œä¼šæœ‰é”™è¯¯,å½“å®¡æ ¸çŠ¶æ€ä¸ºwarningæ—¶,é€‚å½“æ—¶æƒ…å†µè€Œå®šæ˜¯å¦ç»§ç»­æäº¤,å®¡æ ¸çŠ¶æ€ä¸ºpassæ—¶,é€šè¿‡sqlæ£€æµ‹ </p><p>æäº¤åå¯çœ‹åˆ°å·¥å•çŠ¶æ€,å®¡æ ¸æµç¨‹æœ‰è°å®¡æ‰¹,å·¥å•çš„å®¡æ‰¹æ—¥å¿—å’Œæäº¤çš„å®Œæ•´SQLå†…å®¹,ä¹Ÿå¯æ”¹ä¸ºå®šæ—¶æ‰§è¡Œå’Œç»ˆæ­¢æµç¨‹</p><img src="https://nmk0718.github.io/image/image-20211018173051844.png"><p>å·¥å•æ‰§è¡Œå®Œæˆåå¯çœ‹åˆ°å·¥å•çŠ¶æ€æ˜¯å¦æ‰§è¡Œå®Œæ¯•,å½±å“è¡Œæ•°,æ‰§è¡Œè€—æ—¶,è‡ªåŠ¨ç”Ÿæˆçš„å›æ»šSQL</p><img src="https://nmk0718.github.io/image/image-20211018173826642.png"><p>æŸ¥çœ‹å›æ»šSQL,ä¹Ÿå¯ç›´æ¥æäº¤å›æ»šè¯·æ±‚</p><img src="https://nmk0718.github.io/image/image-20211018173955618.png"><p>æäº¤äººå¯ç›´æ¥åœ¨SQLä¸Šçº¿ä¸­æŸ¥çœ‹æ“ä½œæ—¥å¿—</p><img src="https://nmk0718.github.io/image/image-20211018174134029.png"><p>å¯æ ¹æ®å·¥å•çŠ¶æ€,æ•°æ®åº“å®ä¾‹,èµ„æºç»„è¿›è¡Œè¿‡æ»¤æäº¤çš„å·¥å•,ä¹Ÿå¯è¿›è¡Œå¯¼å‡ºå½“å‰é¡µé¢ä¸­çš„è¡¨æ ¼æ•°æ®</p><img src="https://nmk0718.github.io/image/image-20211018174418244.png"><h4 id="SQLæŸ¥è¯¢"><a href="#SQLæŸ¥è¯¢" class="headerlink" title="SQLæŸ¥è¯¢"></a>SQLæŸ¥è¯¢</h4><h5 id="åœ¨çº¿æŸ¥è¯¢"><a href="#åœ¨çº¿æŸ¥è¯¢" class="headerlink" title="åœ¨çº¿æŸ¥è¯¢"></a>åœ¨çº¿æŸ¥è¯¢</h5><p>æŸ¥è¯¢å†å²,è¡¨ç»“æ„,æ‰§è¡Œç»“æœ,è¿”å›è¡Œæ•°,å¯¼å‡ºæ•°æ®</p><img src="https://nmk0718.github.io/image/image-20211018174825785.png"><h5 id="æ•°æ®å­—å…¸"><a href="#æ•°æ®å­—å…¸" class="headerlink" title="æ•°æ®å­—å…¸"></a>æ•°æ®å­—å…¸</h5><p>å¯æŸ¥çœ‹å¯¼å‡ºæ•°æ®åº“å®ä¾‹å¯¹åº”çš„æ•°æ®å­—å…¸(è¯¥åŠŸèƒ½ä»…æ”¯æŒmysql)</p><img src="https://nmk0718.github.io/image/image-20211018175148172.png"><h5 id="æƒé™ç®¡ç†"><a href="#æƒé™ç®¡ç†" class="headerlink" title="æƒé™ç®¡ç†"></a>æƒé™ç®¡ç†</h5><p>å¼€å‘å¯ç”³è¯·è¯¥è´¦å·çœ‹ä¸åˆ°çš„è¡¨æˆ–åº“æƒé™</p><img src="https://nmk0718.github.io/image/image-20211018180204780.png"><h4 id="SQLä¼˜åŒ–"><a href="#SQLä¼˜åŒ–" class="headerlink" title="SQLä¼˜åŒ–"></a>SQLä¼˜åŒ–</h4><h5 id="SQLä¼˜åŒ–å»ºè®®"><a href="#SQLä¼˜åŒ–å»ºè®®" class="headerlink" title="SQLä¼˜åŒ–å»ºè®®"></a>SQLä¼˜åŒ–å»ºè®®</h5><p>å¯é€šè¿‡ä¸‰ç§å·¥å…·è¿›è¡ŒSQLè¯­å¥åˆ†æè¿›è¡Œæä¾›ä¼˜åŒ–å»ºè®®(è¯¥åŠŸèƒ½ä»…æ”¯æŒmysql)</p><img src="https://nmk0718.github.io/image/image-20211019144055657.png"><h5 id="æ…¢æ—¥å¿—æŸ¥è¯¢"><a href="#æ…¢æ—¥å¿—æŸ¥è¯¢" class="headerlink" title="æ…¢æ—¥å¿—æŸ¥è¯¢"></a>æ…¢æ—¥å¿—æŸ¥è¯¢</h5><img src="https://nmk0718.github.io/image/image-20211019144304751.png"><h4 id="å®ä¾‹ç®¡ç†"><a href="#å®ä¾‹ç®¡ç†" class="headerlink" title="å®ä¾‹ç®¡ç†"></a>å®ä¾‹ç®¡ç†</h4><h5 id="å®ä¾‹åˆ—è¡¨"><a href="#å®ä¾‹åˆ—è¡¨" class="headerlink" title="å®ä¾‹åˆ—è¡¨"></a>å®ä¾‹åˆ—è¡¨</h5><p><strong>æµ‹è¯•:</strong>å¯è¿›è¡Œå¯¹æ•°æ®åº“è¿›è¡Œæµ‹è¯•è¿æ¥</p><p><strong>Binlogæ¸…ç†:</strong>å¯ä»¥å¯¹Mysqlè¿›è¡Œbinlogæ¸…ç†</p><img src="https://nmk0718.github.io/image/image-20211019144620159.png"><p>ç‚¹å‡»è“è‰²å®ä¾‹åç§°,å¯è¿›è¡Œç¼–è¾‘</p><img src="https://nmk0718.github.io/image/image-20211019150124460.png"><h5 id="å›è¯ç®¡ç†"><a href="#å›è¯ç®¡ç†" class="headerlink" title="å›è¯ç®¡ç†"></a>å›è¯ç®¡ç†</h5><p>å¯æŸ¥çœ‹å’Œç»ˆæ­¢è¿æ¥çš„è¿›ç¨‹çŠ¶æ€,TOPè¡¨ç©ºé—´å’Œäº‹åŠ¡ä¿¡æ¯,é”ä¿¡æ¯</p><img src="https://nmk0718.github.io/image/image-20211019150223553.png"><h5 id="è´¦å·ç®¡ç†"><a href="#è´¦å·ç®¡ç†" class="headerlink" title="è´¦å·ç®¡ç†"></a>è´¦å·ç®¡ç†</h5><p>åˆ›å»º,ç¼–è¾‘,æˆæƒ,æ”¹å¯†,åˆ é™¤è´¦å·(è¯¥åŠŸèƒ½ä»…æ”¯æŒmysql)</p><img src="https://nmk0718.github.io/image/image-20211019150437462.png"><h4 id="ç³»ç»Ÿç®¡ç†"><a href="#ç³»ç»Ÿç®¡ç†" class="headerlink" title="ç³»ç»Ÿç®¡ç†"></a>ç³»ç»Ÿç®¡ç†</h4><h5 id="é…ç½®é¡¹ç®¡ç†"><a href="#é…ç½®é¡¹ç®¡ç†" class="headerlink" title="é…ç½®é¡¹ç®¡ç†"></a>é…ç½®é¡¹ç®¡ç†</h5><img src="https://nmk0718.github.io/image/image-20211019150748831.png"><p>é…ç½®SQLAdvisorå’Œé’‰é’‰æœºå™¨äººé€šçŸ¥</p><img src="https://nmk0718.github.io/image/image-20211019151158633.png"><p>é…ç½®å·¥å•å®¡æ‰¹æµé…ç½®</p><img src="https://nmk0718.github.io/image/image-20211019151532376.png"><h5 id="èµ„æºç»„ç®¡ç†"><a href="#èµ„æºç»„ç®¡ç†" class="headerlink" title="èµ„æºç»„ç®¡ç†"></a>èµ„æºç»„ç®¡ç†</h5><p>é…ç½®å¯¹åº”ç¯å¢ƒçš„èµ„æºç»„,å…³è”ç”¨æˆ·å’Œå®ä¾‹æ•°æ®åº“ä¸èµ„æºç»„ç»‘å®š</p><img src="https://nmk0718.github.io/image/image-20211019151611510.png"><h3 id="Yearning"><a href="#Yearning" class="headerlink" title="Yearning"></a>Yearning</h3><p>å®˜æ–¹æ–‡æ¡£:<a href="https://guide.yearning.io/install.html" target="_blank" rel="noopener">https://guide.yearning.io/install.html</a></p><p>é¦–å…ˆå®‰è£…myql5.7,å¯å‚è€ƒmysqlæ–‡æ¡£è¿›è¡Œå®‰è£…</p><h4 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h4><p>åˆ›å»ºYearningæ•°æ®åº“å¹¶æŒ‡å®šå­—ç¬¦é›†</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">create database Yearning default character set utf8mb4;</span><br></pre></td></tr></table></figure><p>ä¸‹è½½åœ°å€:<a href="https://github.com/cookieY/Yearning/releases/" target="_blank" rel="noopener">https://github.com/cookieY/Yearning/releases/</a></p><p>ä¸‹è½½</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https://github.com/cookieY/Yearning/releases/download/v2.2.0/Yearning-2.2.0.linux-amd64.zip</span><br></pre></td></tr></table></figure><p>è§£å‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tar zxvf Yearning-2.2.0.linux-amd64.zip</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹é…ç½®æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi conf.toml</span><br><span class="line">[Mysql]</span><br><span class="line">Db = &quot;Yearning&quot;</span><br><span class="line">Host = &quot;127.0.0.1&quot;</span><br><span class="line">Port = &quot;3306&quot;</span><br><span class="line">Password = &quot;xxxx&quot;</span><br><span class="line">User = &quot;root&quot;</span><br><span class="line"></span><br><span class="line">[General]   #æ•°æ®åº“åŠ è§£å¯†keyï¼Œåªå¯æ›´æ”¹ä¸€æ¬¡ã€‚</span><br><span class="line">SecretKey = &quot;dbcjqheupqjsuwsm&quot;</span><br></pre></td></tr></table></figure><p>åˆå§‹åŒ–æ•°æ®ç»“æ„</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">./Yearning -m</span><br></pre></td></tr></table></figure><p>é»˜è®¤å¯åŠ¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">./Yearning -s</span><br></pre></td></tr></table></figure><p>å‚æ•°å¯åŠ¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">./Yearning -s -b &quot;172.27.80.35&quot; -p &quot;8000&quot;</span><br></pre></td></tr></table></figure><p>æ‰“å¼€æµè§ˆå™¨ <a href="http://127.0.0.1:8000" target="_blank" rel="noopener">http://127.0.0.1:8000</a></p><p>é»˜è®¤å¯†ç ï¼šadmin/Yearning_admin</p><p>Yearning æ‰§è¡ŒæˆåŠŸåæ˜¾ç¤ºå›æ»šè¯­å¥ éœ€è¦mysqlå¼€å¯binlog,è¯·æŸ¥çœ‹mysqlæ–‡æ¡£å¼€å¯binlog</p><h4 id="Yearningç®¡ç†"><a href="#Yearningç®¡ç†" class="headerlink" title="Yearningç®¡ç†"></a>Yearningç®¡ç†</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ç”¨æˆ·æœ‰ä¸‰ä¸ªæƒé™:guest,admin,perform.</span><br><span class="line">ä½¿ç”¨è€…:æ™®é€šæƒé™,å¯æäº¤å·¥å•è¿›è¡ŒæŸ¥è¯¢å’Œä¿®æ”¹,æ²¡æœ‰ä¿®æ”¹æƒé™</span><br><span class="line">ç®¡ç†å‘˜:å®¡æ ¸äºº,å¯æäº¤å·¥å•è¿›è¡ŒæŸ¥è¯¢å’Œä¿®æ”¹,æœ‰å®¡æ‰¹æƒé™ä½†æ— ä¿®æ”¹æƒé™</span><br><span class="line">æ‰§è¡Œäºº:å¯æäº¤å·¥å•è¿›è¡ŒæŸ¥è¯¢å’Œä¿®æ”¹,æœ‰å®¡æ‰¹æƒé™æœ‰ä¿®æ”¹æƒé™</span><br><span class="line">ä¸€èˆ¬è®¾ç½®å¼€å‘ä¸ºä½¿ç”¨è€…,ç»„é•¿ä¸ºç®¡ç†å‘˜,æ‰§è¡Œäººä¸ºDBAæˆ–è¿ç»´</span><br><span class="line">æ•°æ®åº“æŒ‰è§„èŒƒå¡«å†™å³å¯</span><br><span class="line"></span><br><span class="line">æƒé™ç»„</span><br><span class="line">å¼€å‘ç»„æƒé™ç»„,å…è®¸DDL,DML,æ•°æ®æŸ¥è¯¢,ä¸Šçº§å®¡æ ¸äººé€‰æ‹©å¼€å‘ç»„é•¿(å¯¹åº”ç®¡ç†å‘˜æƒé™),å…³é—­ç”¨æˆ·ç®¡ç†æƒé™å’Œæ•°æ®åº“ç®¡ç†æƒé™</span><br><span class="line">å¼€å‘ç»„é•¿æƒé™ç»„,å…è®¸DDL,DML,æ•°æ®æŸ¥è¯¢,ä¸Šçº§å®¡æ ¸äººé€‰æ‹©DBAæˆ–è¿ç»´(å¯¹åº”æ‰§è¡Œäººæƒé™),å…³é—­ç”¨æˆ·ç®¡ç†æƒé™å’Œæ•°æ®åº“ç®¡ç†æƒé™</span><br><span class="line">æ‰§è¡Œäººæƒé™ç»„,å…è®¸DDL,DML,æ•°æ®æŸ¥è¯¢,ä¸Šçº§å®¡æ ¸äººé€‰æ‹©admin(å¯¹åº”è¶…çº§ç®¡ç†å‘˜æƒé™),å…è®¸ç”¨æˆ·ç®¡ç†æƒé™å’Œæ•°æ®åº“ç®¡ç†æƒé™</span><br><span class="line"></span><br><span class="line">ç”¨æˆ·æƒé™,é…ç½®ç”¨æˆ·å½’å±æ‰€åœ¨æƒé™ç»„å³å¯</span><br><span class="line"></span><br><span class="line">è®¾ç½®</span><br><span class="line">Yearningæ”¯æŒwebhookå’Œé‚®ä»¶æ¨é€æ¶ˆæ¯</span><br><span class="line">å¯é…ç½®é’‰é’‰æœºå™¨äººçš„apiæˆ–é‚®ç®±</span><br><span class="line"></span><br><span class="line">è¿›é˜¶è®¾ç½®</span><br><span class="line">è‡ªå®šä¹‰ç¯å¢ƒå¯æ›´æ”¹é»˜è®¤çš„ç¯å¢ƒå,ç”¨æ¥åŒºåˆ†prodå’Œdev</span><br><span class="line">å¼€å¯å¤šçº§å®¡æ ¸,å¼€å¯æ³¨å†Œ ä¿å­˜</span><br><span class="line"></span><br><span class="line">å®¡æ ¸è§„åˆ™</span><br><span class="line">å¯å®šä¹‰sqlè¯­å¥çš„è§„èŒƒ æŒ‰ç…§å®é™…æƒ…å†µè€Œå®š</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;SQLå®¡æ ¸&quot;&gt;&lt;a href=&quot;#SQLå®¡æ ¸&quot; class=&quot;headerlink&quot; title=&quot;SQLå®¡æ ¸&quot;&gt;&lt;/a&gt;SQLå®¡æ ¸&lt;/h2&gt;&lt;p&gt;Archeyæ›´å…¨é¢,æ”¯æŒå¤šç§ç±»æ•°æ®åº“,ä½†æ˜¯ä½¿ç”¨è¿‡ç¨‹ä¸­å»ºè¡¨è¯­å¥æœªèƒ½é€šè¿‡æäº¤SQLå®¡æ ¸,ç•¥æœ‰ä¸è¶³&lt;/p&gt;
&lt;p&gt;Year</summary>
      
    
    
    
    
    <category term="mysql" scheme="https://nmk0718.github.io/tag/mysql/"/>
    
  </entry>
  
  <entry>
    <title>æµ‹è¯•é¡¹ç›®ä¼˜åŒ–</title>
    <link href="https://nmk0718.github.io/2021/09/08/%E6%B5%8B%E8%AF%95JVM%E8%B0%83%E4%BC%98/"/>
    <id>https://nmk0718.github.io/2021/09/08/%E6%B5%8B%E8%AF%95JVM%E8%B0%83%E4%BC%98/</id>
    <published>2021-09-08T09:42:00.000Z</published>
    <updated>2025-02-10T04:00:59.770Z</updated>
    
    <content type="html"><![CDATA[<h4 id="æµ‹è¯•é¡¹ç›®ä¼˜åŒ–"><a href="#æµ‹è¯•é¡¹ç›®ä¼˜åŒ–" class="headerlink" title="æµ‹è¯•é¡¹ç›®ä¼˜åŒ–"></a>æµ‹è¯•é¡¹ç›®ä¼˜åŒ–</h4><p>æœªä¼˜åŒ–å¯åŠ¨nhospitalé¡¹ç›®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -jar -Xms1024m -Xmx2048m nhospital-service-1.0.0-SNAPSHOT.jar --spring.profiles.active=test</span><br></pre></td></tr></table></figure><p>ä¼˜åŒ–å‰çš„å†…å­˜ç›‘æ§,å†…å­˜ä½¿ç”¨åœ¨1.7G-1.8Gå·¦å³</p><img src="https://nmk0718.github.io/image/image-20210908173406276.png"><p>ä½¿ç”¨JAVAè‡ªå¸¦çš„VisualVMè¿›è¡Œç›‘æ§</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">javaå®‰è£…ç›®å½•çš„binä¸­</span><br><span class="line">C:\Program Files\Java\jdk1.8.0_181\bin\jvisualvm.exe</span><br></pre></td></tr></table></figure><p>Java VisualVMé»˜è®¤æ²¡æœ‰å®‰è£…Visual GCæ’ä»¶ï¼Œéœ€è¦æ‰‹åŠ¨å®‰è£…ï¼Œç‚¹å‡»èœå•æ  å·¥å…·-&gt;æ’ä»¶ å®‰è£…Visual GC,å®‰è£…å®Œæˆåé‡å¯Java VisualVMï¼ŒVisual GCç•Œé¢è‡ªåŠ¨æ‰“å¼€ï¼Œå³å¯çœ‹åˆ°JVMä¸­å †å†…å­˜çš„åˆ†ä»£æƒ…å†µ</p><img src="https://nmk0718.github.io/image/image-20210908165014278.png"><p>GraphsåŒºåŸŸï¼šå†…å­˜ä½¿ç”¨è¯¦ç»†ä»‹ç»</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Compile Time(ç¼–è¯‘æ—¶é—´)ï¼š15365 compiles è¡¨ç¤ºç¼–è¯‘æ€»æ•°ï¼Œ1m29.699sè¡¨ç¤ºç¼–è¯‘ç´¯è®¡æ—¶é—´ã€‚ä¸€ä¸ªè„‰å†²è¡¨ç¤ºä¸€æ¬¡JITç¼–è¯‘ï¼Œçª„è„‰å†²è¡¨ç¤ºæŒç»­æ—¶é—´çŸ­ï¼Œå®½è„‰å†²è¡¨ç¤ºæŒç»­æ—¶é—´é•¿ã€‚</span><br><span class="line"></span><br><span class="line">Class Loader Time(ç±»åŠ è½½æ—¶é—´): 17201 loadedè¡¨ç¤ºåŠ è½½ç±»æ•°é‡, 100 unloadedè¡¨ç¤ºå¸è½½çš„ç±»æ•°é‡ï¼Œ18.196sè¡¨ç¤ºç±»åŠ è½½èŠ±è´¹çš„æ—¶é—´</span><br><span class="line"></span><br><span class="line">GC Time(GC Time)ï¼š67collectionsè¡¨ç¤ºåƒåœ¾æ”¶é›†çš„æ€»æ¬¡æ•°ï¼Œ1.118sè¡¨ç¤ºåƒåœ¾æ”¶é›†èŠ±è´¹çš„æ—¶é—´ï¼Œlast causeè¡¨ç¤ºæœ€è¿‘åƒåœ¾æ”¶é›†çš„åŸå› </span><br><span class="line"></span><br><span class="line">Eden Space(Eden åŒº)ï¼šæ‹¬å·å†…çš„681.500Mè¡¨ç¤ºæœ€å¤§å®¹é‡ï¼Œ637.500Mè¡¨ç¤ºå½“å‰å®¹é‡ï¼Œåé¢çš„145.561Mè¡¨ç¤ºå½“å‰ä½¿ç”¨æƒ…å†µï¼Œ63collectionsè¡¨ç¤ºåƒåœ¾æ”¶é›†æ¬¡æ•°ï¼Œ517.821msè¡¨ç¤ºåƒåœ¾æ”¶é›†èŠ±è´¹æ—¶é—´</span><br><span class="line"></span><br><span class="line">Survivor 0/Survivor 1(S0å’ŒS1åŒº)ï¼šæ‹¬å·å†…çš„227.500Mè¡¨ç¤ºæœ€å¤§å®¹é‡ï¼Œ14.500Mè¡¨ç¤ºå½“å‰å®¹é‡ï¼Œä¹‹åçš„å€¼æ˜¯å½“å‰ä½¿ç”¨æƒ…å†µ</span><br><span class="line"></span><br><span class="line">Old Gen(è€å¹´ä»£)ï¼šæ‹¬å·å†…çš„1.333Gè¡¨ç¤ºæœ€å¤§å®¹é‡ï¼Œ728.000Mè¡¨ç¤ºå½“å‰å®¹é‡ï¼Œä¹‹åçš„150.812Mè¡¨ç¤ºå½“å‰ä½¿ç”¨æƒ…å†µï¼Œ4collectionsè¡¨ç¤ºåƒåœ¾æ”¶é›†æ¬¡æ•° ï¼Œ600.392msè¡¨ç¤ºåƒåœ¾æ”¶é›†èŠ±è´¹æ—¶é—´</span><br><span class="line"></span><br><span class="line">Perm Gen(æ°¸ä¹…ä»£)ï¼šæ‹¬å·å†…çš„1.086Gè¡¨ç¤ºæœ€å¤§å®¹é‡ï¼Œ106.039Mè¡¨ç¤ºå½“å‰å®¹é‡ï¼Œä¹‹åçš„103.775Mè¡¨ç¤ºå½“å‰ä½¿ç”¨æƒ…å†µ</span><br></pre></td></tr></table></figure><p> æŸ¥çœ‹å¾—çŸ¥Spacesç©ºé—´çš„Old(è€å¹´ä»£)ä½¿ç”¨å†…å­˜è¾ƒå¤§,ä½†Oldçš„æœ€å¤§å†…å­˜å’ŒEdenæœ€å¤§å†…å­˜å¾ˆå¤§,æ— æ³•è§¦å‘GCåƒåœ¾å›æ”¶,</p><p>è®¾ç½®æ–°ç”Ÿä»£çš„æœ€å¤§å†…å­˜ä¸º512M,è®©æ–°ç”Ÿä»£æ›´å¿«è§¦å‘åƒåœ¾å›æ”¶,æ›´å¿«çš„ä¸¢åˆ°è€å¹´ä»£è§¦å‘è€å¹´ä»£åƒåœ¾å›æ”¶</p><p>ä½¿ç”¨æ–°é…ç½®å¯åŠ¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -jar -Xms1024m -Xmx2048m -Xss256k -Xmn512m -XX:SurvivorRatio=6 -Dhttp.proxyHostWx=219.128.77.86 -Dhttp.proxyPortWx=7002 nhospital-service-1.0.0-SNAPSHOT.jar --spring.profiles.active=test</span><br></pre></td></tr></table></figure><p>å¯åŠ¨åå¯çœ‹åˆ°ç›‘æ§ä¸­çš„å†…å­˜ä½¿ç”¨,å¹³ç¨³åœ¨1.07Gå·¦å³</p><img src="https://nmk0718.github.io/image/image-20210908173250449.png"><h4 id="JVMåƒåœ¾å›æ”¶åŸç†"><a href="#JVMåƒåœ¾å›æ”¶åŸç†" class="headerlink" title="JVMåƒåœ¾å›æ”¶åŸç†:"></a>JVMåƒåœ¾å›æ”¶åŸç†:</h4><p><strong>ç¬¬ä¸€ç§æƒ…å†µ</strong></p><ul><li><p>é¡¹ç›®åˆ›å»ºçš„æ–°å¯¹è±¡ä¼šå…ˆè¿›å…¥æ–°ç”Ÿä»£è¿›è¡Œå­˜å‚¨,ç­‰è¾¾åˆ°æ–°ç”Ÿä»£æœ€å¤§å€¼æ—¶,è¿˜åœ¨ä½¿ç”¨å°±è¿›å…¥S0æˆ–S1,å¦‚æœªä½¿ç”¨è¿›è¡Œé‡Šæ”¾,</p></li><li><p>S0è¾¾åˆ°æœ€å¤§å€¼å,æœªä½¿ç”¨é‡Šæ”¾å¯¹è±¡,åˆ°è¾¾æœ€å¤§å€¼åè¿›å»S1,</p></li><li><p>S1æœªä½¿ç”¨é‡Šæ”¾å¯¹è±¡,åˆ°è¾¾æœ€å¤§å€¼åè¿›å»S0</p></li><li><p>S0-S1äº’ç›¸äº¤æ›¿15æ¬¡å æœªé‡Šæ”¾å¯¹è±¡ä¼šè¿›å…¥è€å¹´ä»£</p></li><li><p>è€å¹´ä»£åˆ°è¾¾æœ€å¤§å€¼æ—¶æ‰ä¼šé‡Šæ”¾å¯¹è±¡,åœ¨åˆ°è¾¾æœ€å¤§å€¼ä¹‹å‰ä¸€ç›´å­˜åœ¨</p></li></ul><p><strong>ç¬¬äºŒç§æƒ…å†µ</strong></p><ul><li><p>é¡¹ç›®åˆ›å»ºçš„æ–°å¯¹è±¡ä¼šå…ˆè¿›å…¥æ–°ç”Ÿä»£è¿›è¡Œå­˜å‚¨,ç­‰è¾¾åˆ°æ–°ç”Ÿä»£æœ€å¤§å€¼æ—¶,è¿˜åœ¨ä½¿ç”¨å°±è¿›å…¥S0æˆ–S1,å¦‚æœå¯¹è±¡çš„å¤§å°è¶…è¿‡S0æˆ–S1å¤§å°,å°†ç›´æ¥ä¸¢å…¥è€å¹´ä»£</p></li><li><p>è€å¹´ä»£åˆ°è¾¾æœ€å¤§å€¼æ—¶æ‰ä¼šé‡Šæ”¾å¯¹è±¡,åœ¨åˆ°è¾¾æœ€å¤§å€¼ä¹‹å‰ä¸€ç›´å­˜åœ¨</p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;æµ‹è¯•é¡¹ç›®ä¼˜åŒ–&quot;&gt;&lt;a href=&quot;#æµ‹è¯•é¡¹ç›®ä¼˜åŒ–&quot; class=&quot;headerlink&quot; title=&quot;æµ‹è¯•é¡¹ç›®ä¼˜åŒ–&quot;&gt;&lt;/a&gt;æµ‹è¯•é¡¹ç›®ä¼˜åŒ–&lt;/h4&gt;&lt;p&gt;æœªä¼˜åŒ–å¯åŠ¨nhospitalé¡¹ç›®&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>çº¿ä¸Šé—®é¢˜</title>
    <link href="https://nmk0718.github.io/2021/06/07/%E6%8E%92%E6%9F%A5%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98/"/>
    <id>https://nmk0718.github.io/2021/06/07/%E6%8E%92%E6%9F%A5%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98/</id>
    <published>2021-06-07T08:29:00.000Z</published>
    <updated>2025-02-10T04:00:59.680Z</updated>
    
    <content type="html"><![CDATA[<h3 id="appåå°æŒ‚æ‰é—®é¢˜æ±‡æ€»"><a href="#appåå°æŒ‚æ‰é—®é¢˜æ±‡æ€»" class="headerlink" title="appåå°æŒ‚æ‰é—®é¢˜æ±‡æ€»"></a>appåå°æŒ‚æ‰é—®é¢˜æ±‡æ€»</h3><p>æŠ¥é”™:</p><p>æ•°æ®åº“è¿æ¥æ± ä¸å¯ç”¨</p><p><img src="file://E:%5Cnginx%5Cfile%5Cimages%5Cimage-20210607160838699.png?lastModify=1623400858" alt="image-20210607160838699"></p><p>æŸ¥è¯¢æŠ¥é”™ä¿¡æ¯HikariPool-1 -Connection is not available, request timed out after ms.å¾—åˆ°ç»“æœ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">è¿æ¥æ± é‡Œçš„è¿æ¥ä¸å¤Ÿç”¨äº†ï¼Œå› ä¸ºåœ¨ç­‰å¾…è¿æ¥æ‰€ä»¥è¶…æ—¶äº†</span><br></pre></td></tr></table></figure><p>éœ€è¦å¢åŠ ä»¥ä¸‹ä»£ç åˆ°é¡¹ç›®åç«¯é…ç½®æ–‡ä»¶ä¸­</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">#å®¢æˆ·ç«¯ç­‰å¾…è¿æ¥æ± è¿æ¥çš„æœ€å¤§æ¯«ç§’æ•°</span><br><span class="line">datasource.connection-timeout=<span class="number">60000</span></span><br><span class="line">#å…è®¸è¿æ¥åœ¨è¿æ¥æ± ä¸­ç©ºé—²çš„æœ€é•¿æ—¶é—´(ä»¥æ¯«ç§’ä¸ºå•ä½)</span><br><span class="line">datasource.idle-timeout=<span class="number">60000</span></span><br><span class="line">#è¿æ¥å°†è¢«æµ‹è¯•æ´»åŠ¨çš„æœ€å¤§æ—¶é—´é‡</span><br><span class="line">datasource.validation-timeout=<span class="number">3000</span></span><br><span class="line">#æ± ä¸­è¿æ¥å…³é—­åçš„æœ€é•¿ç”Ÿå‘½å‘¨æœŸ</span><br><span class="line">datasource.max-lifetime=<span class="number">60000</span></span><br><span class="line">#æœ€å¤§æ± å¤§å°</span><br><span class="line">datasource.maximum-pool-size=<span class="number">30</span></span><br><span class="line">#è¿æ¥æ± ä¸­ç»´æŠ¤çš„æœ€å°ç©ºé—²è¿æ¥æ•°</span><br><span class="line">datasource.minimum-idle=<span class="number">10</span></span><br></pre></td></tr></table></figure><p>CPUçªç„¶é£™é«˜</p><p><img src="file://E:%5Cnginx%5Cfile%5Cimages%5Cimage-20210607161415217.png?lastModify=1623400843" alt="image-20210607161415217"></p><p>é€šè¿‡topæŸ¥çœ‹CPUæœ€é«˜çš„è¿›ç¨‹</p><p>![image-20210611165054632](E:\nginx\file\images\image-20210611165054632.pngâ€ /&gt;</p><p>æ‰¾å‡ºè¯¥è¿›ç¨‹å†…æœ€è€—è´¹CPUçš„çº¿ç¨‹ï¼Œå¯ä»¥ä½¿ç”¨ps -Lfp pidæˆ–è€…ps -mp pid -o THREAD, tid, timeæˆ–è€…top -Hp pid</p><p>![image-20210611165544735](E:\nginx\file\images\image-20210611165544735.pngâ€ /&gt;</p><p>CPUæ—¶é—´é•¿çš„æ˜¯çº¿ç¨‹IDä¸º19758å’Œ22477çš„çº¿ç¨‹ï¼Œç”¨å‘½ä»¤è½¬æ¢ä¸ºåå…­è¿›åˆ¶å€¼</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@app-service ~]# printf "%x\n" 19758</span><br><span class="line">4d2e</span><br><span class="line">[root@app-service ~]# printf "%x\n" 22477</span><br><span class="line">57cd</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨jstackè¾“å‡ºè¿›ç¨‹19712çš„å †æ ˆä¿¡æ¯ï¼Œç„¶åæ ¹æ®çº¿ç¨‹IDçš„åå…­è¿›åˆ¶å€¼grep</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@app-service ~]<span class="comment"># jstack 19712|grep 4d2e</span></span><br><span class="line"><span class="string">"lettuce-epollEventLoop-4-1"</span> <span class="comment">#16 daemon prio=5 os_prio=0 cpu=196205389.54ms elapsed=325181.90s tid=0x00007feaf4f17000 nid=0x4d2e runnable  [0x00007fea945ec000]</span></span><br><span class="line">[root@app-service ~]<span class="comment"># jstack 19712|grep 57cd</span></span><br><span class="line"><span class="string">"lettuce-epollEventLoop-4-2"</span> <span class="comment">#113 daemon prio=5 os_prio=0 cpu=76704837.74ms elapsed=320312.36s tid=0x00007feabc03e800 nid=0x57cd runnable  [0x00007fea947ee000]</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡æŸ¥è¯¢lettuce-epollEventLoop-4-1å¾—çŸ¥æ˜¯rediså‡ºç°çš„é—®é¢˜</p><p>é€šè¿‡RedisDesktopManagerå¯çœ‹åˆ°redisä¸­db7è¿æ¥æ•°è¿‡å¤§</p><p>![image-20210611170043128](E:\nginx\file\images\image-20210611170043128.pngâ€ /&gt;</p><p>éœ€è¦åœ¨ç”Ÿäº§çš„é…ç½®ä¸­è¿æ¥æ± ä¿¡æ¯</p><figure class="highlight"><table><tr><td class="code"><pre><span class="line">#è¿æ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥</span><br><span class="line">#spring.redis.lettuce.pool.max-idle=5</span><br><span class="line">#è¿æ¥æ± æœ€å¤§è¿æ¥æ•°</span><br><span class="line">#spring.redis.lettuce.pool.max-active=8</span><br><span class="line">#è¿æ¥æ± ä¸­çš„æœ€å°ç©ºé—²è¿æ¥</span><br><span class="line">#spring.redis.lettuce.pool.min-idle=1</span><br></pre></td></tr></table></figure><p>å‚è€ƒé“¾æ¥:<a href="https://blog.csdn.net/weixin_42228950/article/details/111059352" target="_blank" rel="noopener">https://blog.csdn.net/weixin_42228950/article/details/111059352</a></p><p>â€‹                <a href="https://blog.csdn.net/m0_38110132/article/details/79652962" target="_blank" rel="noopener">https://blog.csdn.net/m0_38110132/article/details/79652962</a></p><p>â€‹                <a href="https://blog.csdn.net/yu0_zhang0/article/details/103863447" target="_blank" rel="noopener">https://blog.csdn.net/yu0_zhang0/article/details/103863447</a></p><p>é—®é¢˜:åœ¨5.31å·15:41å’Œ6.4å·20:30å‡ºç°ç”Ÿäº§çš„appåå°æ— æ³•è¿›è¡Œæ“ä½œ.</p><p>æ’æŸ¥å¼‚å¸¸ç‚¹:</p><ul><li><p>æ ¹æ®åç«¯é¡¹ç›®æ—¥å¿—å¯ä»¥çœ‹å‡ºæ˜¯è¿æ¥æ± ä¸å¯ç”¨,è¿æ¥è¶…æ—¶å¯¼è‡´</p><p>![image-20210607160838699](E:\nginx\file\images\image-20210607160838699.pngâ€ /&gt;</p></li><li><p>äº‘ç›‘æ§å¯çœ‹åˆ°ç”Ÿäº§æœåŠ¡å™¨CPUåœ¨5.29å·ä¸Šçº¿ç‰ˆæœ¬åé£™å‡</p><p>![image-20210607161415217](E:\nginx\file\images\image-20210607161415217.pngâ€ /&gt;</p></li></ul><p>è§£å†³æ–¹æ¡ˆ:</p><p>1.å¢åŠ ä»¥ä¸‹ä»£ç åˆ°é¡¹ç›®åç«¯é…ç½®æ–‡ä»¶ä¸­(å·²ç»åŠ åœ¨æµ‹è¯•,ç­‰ä¸‹æ¬¡ç‰ˆæœ¬ä¸€èµ·ä¸Šçº¿åˆ°ç”Ÿäº§,çœ‹æ˜¯å¦å‡ºç°æŠ¥é”™)</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">#å®¢æˆ·ç«¯ç­‰å¾…è¿æ¥æ± è¿æ¥çš„æœ€å¤§æ¯«ç§’æ•°</span><br><span class="line">datasource.connection-timeout=<span class="number">60000</span></span><br><span class="line">#å…è®¸è¿æ¥åœ¨è¿æ¥æ± ä¸­ç©ºé—²çš„æœ€é•¿æ—¶é—´(ä»¥æ¯«ç§’ä¸ºå•ä½)</span><br><span class="line">datasource.idle-timeout=<span class="number">60000</span></span><br><span class="line">#è¿æ¥å°†è¢«æµ‹è¯•æ´»åŠ¨çš„æœ€å¤§æ—¶é—´é‡</span><br><span class="line">datasource.validation-timeout=<span class="number">3000</span></span><br><span class="line">#æ± ä¸­è¿æ¥å…³é—­åçš„æœ€é•¿ç”Ÿå‘½å‘¨æœŸ</span><br><span class="line">datasource.max-lifetime=<span class="number">60000</span></span><br><span class="line">#æœ€å¤§æ± å¤§å°</span><br><span class="line">datasource.maximum-pool-size=<span class="number">30</span></span><br><span class="line">#è¿æ¥æ± ä¸­ç»´æŠ¤çš„æœ€å°ç©ºé—²è¿æ¥æ•°</span><br><span class="line">datasource.minimum-idle=<span class="number">10</span></span><br></pre></td></tr></table></figure><p>2.äº‘æœåŠ¡å™¨CPUé£™å‡å¯èƒ½ä¸ºä¸Šæ¬¡ç‰ˆæœ¬ä»£ç ä¸­çš„æœ‰æ•ˆæ—¶é—´é—®é¢˜,åœ¨6.08å·ç‰ˆæœ¬ç”Ÿäº§ä¸Šçº¿ä¸­è§£å†³</p><p>3.é¡¹ç›®ä¸èƒ½è®¿é—®åæ²¡æœ‰å³åˆ»å‘Šè­¦,å› ä¸ºè¯¥æœåŠ¡æ²¡æœ‰åœæ­¢è¿è¡Œ,ä½†æ˜¯å†…éƒ¨å·²ç»è¿æ¥è¶…æ—¶,æ— æ³•å“åº”ã€‚é’ˆå¯¹æ­¤æƒ…å†µæ–°å¢ç›‘æ§å‘Šè­¦,è¯¥å‘Šè­¦ä¸ºç›‘æ§æ—¥å¿—æŠ¥é”™åå‘Šè­¦,æ—¶é—´é—´éš”ä¸º10åˆ†é’Ÿ,é€šè¿‡æ‰‹æœºçŸ­ä¿¡,é‚®ç®±,é’‰é’‰æœºå™¨äººæŠ¥è­¦</p><p>![image-20210607162109471](E:\nginx\file\images\image-20210607162109471.pngâ€ /&gt;</p><h3 id="é’‰é’‰æ”¶åˆ°å®¹å™¨OOMå‘Šè­¦"><a href="#é’‰é’‰æ”¶åˆ°å®¹å™¨OOMå‘Šè­¦" class="headerlink" title="é’‰é’‰æ”¶åˆ°å®¹å™¨OOMå‘Šè­¦"></a>é’‰é’‰æ”¶åˆ°å®¹å™¨OOMå‘Šè­¦</h3><img src="https://nmk0718.github.io/image/dingdingalert.png"><p>è¿›å…¥åˆ°ç›‘æ§ä¸­æŸ¥çœ‹CPUå’Œå†…å­˜å‡æ­£å¸¸</p><img src="https://nmk0718.github.io/image/alimonitor.png"><p>æŸ¥çœ‹nhospitalå®¹å™¨å¯¹åº”çš„çš„CPUå’Œå†…å­˜,CPUè¾¾åˆ°80%ä½†æ²¡è¶…è¿‡é™åˆ¶å€¼</p><img src="https://nmk0718.github.io/image/contianercpu.png"><p>å†…å­˜åœ¨1.8Gæ—¶è¿›è¡Œé‡å¯å®¹å™¨(åˆ†é…å†…å­˜ä¸º2.2G)</p><img src="https://nmk0718.github.io/image/containermem.png"><p>æŸ¥çœ‹è¯¥èŠ‚ç‚¹å¯¹åº”çš„/var/log/messageå¾—çŸ¥å®¹å™¨è¢«OOMæ€æ‰è¿›ç¨‹</p><img src="https://nmk0718.github.io/image/systemlog.png"> <p><strong>OOM:</strong></p><p>å¦‚æœèŠ‚ç‚¹åœ¨ kubelet å›æ”¶å†…å­˜ä¹‹å‰ç»å†äº†ç³»ç»Ÿ OOMï¼ˆå†…å­˜ä¸è¶³ï¼‰äº‹ä»¶ï¼Œå®ƒå°†åŸºäº <a href="https://lwn.net/Articles/391222/" target="_blank" rel="noopener">oom-killer</a> åšå‡ºå“åº”ã€‚</p><p>kubelet åŸºäº pod çš„ service è´¨é‡ä¸ºæ¯ä¸ªå®¹å™¨è®¾ç½®ä¸€ä¸ª oom_score_adj å€¼ã€‚</p><table><thead><tr><th>Service è´¨é‡</th><th>oom_score_adj</th></tr></thead><tbody><tr><td>Guaranteed</td><td>-998</td></tr><tr><td>BestEffort</td><td>1000</td></tr><tr><td>Burstable</td><td>min(max(2,  1000 - (1000 * memoryRequestBytes) / machineMemoryCapacityBytes), 999)</td></tr></tbody></table><p>å¦‚æœ kubelet åœ¨èŠ‚ç‚¹ç»å†ç³»ç»Ÿ OOM ä¹‹å‰æ— æ³•å›æ”¶å†…å­˜ï¼Œoom_killer å°†åŸºäºå®ƒåœ¨èŠ‚ç‚¹ä¸Š ä½¿ç”¨çš„å†…å­˜ç™¾åˆ†æ¯”ç®—å‡ºä¸€ä¸ª oom_scoreï¼Œå¹¶åŠ ä¸Š oom_score_adj å¾—åˆ°å®¹å™¨çš„æœ‰æ•ˆ oom_scoreï¼Œç„¶åç»“æŸå¾—åˆ†æœ€é«˜çš„å®¹å™¨ã€‚</p><p>é¢„æœŸçš„è¡Œä¸ºåº”è¯¥æ˜¯æ‹¥æœ‰æœ€ä½æœåŠ¡è´¨é‡å¹¶æ¶ˆè€—å’Œè°ƒåº¦è¯·æ±‚ç›¸å…³å†…å­˜é‡æœ€å¤šçš„å®¹å™¨ç¬¬ä¸€ä¸ªè¢«ç»“æŸï¼Œä»¥å›æ”¶å†…å­˜ã€‚</p><p>å’Œ pod é©±é€ä¸åŒï¼Œå¦‚æœä¸€ä¸ª Pod çš„å®¹å™¨æ˜¯è¢« OOM ç»“æŸçš„ï¼ŒåŸºäºå…¶ RestartPolicyï¼Œ å®ƒå¯èƒ½ä¼šè¢« kubelet é‡æ–°å¯åŠ¨</p><p><strong>QoSç±»å‹ï¼š</strong><br> Guranteed:<br> ã€€æ¯ä¸ªå®¹å™¨çš„CPUï¼ŒRAMèµ„æºéƒ½è®¾ç½®äº†ç›¸åŒå€¼çš„requests å’Œ limitså±æ€§ã€‚<br> ã€€ç®€å•è¯´ï¼š cpu.limits = cpu.requests<br> ã€€ã€€ã€€ã€€ã€€memory.limits = memory.requests<br> ã€€è¿™ç±»Podçš„è¿è¡Œä¼˜å…ˆçº§æœ€é«˜ï¼Œä½†å‡¡è¿™æ ·é…ç½®äº†cpuå’Œå†…å­˜çš„limitså’Œrequestsï¼Œå®ƒä¼šè‡ªåŠ¨è¢«å½’ä¸ºæ­¤ç±»ã€‚<br> ã€€Burstable:<br> ã€€ã€€ã€€æ¯ä¸ªå®¹å™¨è‡³å°‘å®šä¹‰äº†CPUï¼ŒRAMçš„requestså±æ€§ï¼Œè¿™é‡Œè¯´æ¯ä¸ªå®¹å™¨æ˜¯æŒ‡ï¼šä¸€ä¸ªPodä¸­å¯ä»¥è¿è¡Œå¤šä¸ªå®¹å™¨ã€‚<br> ã€€ã€€ã€€é‚£ä¹ˆè¿™ç±»å®¹å™¨å°±ä¼šè¢«è‡ªåŠ¨å½’ä¸ºburstableï¼Œè€Œæ­¤ç±»å°±å±äºä¸­ç­‰ä¼˜å…ˆçº§ã€‚<br> ã€€BestEffort:<br> ã€€ã€€ã€€æ²¡æœ‰ä¸€ä¸ªå®¹å™¨è®¾ç½®äº†requests æˆ– limitsï¼Œåˆ™ä¼šå½’ä¸ºæ­¤ç±»ï¼Œè€Œæ­¤ç±»åˆ«æ˜¯æœ€ä½ä¼˜å…ˆçº§ã€‚</p><p> <strong>QoSç±»å‹çš„ä½œç”¨ï¼š</strong><br> ã€€Nodeä¸Šä¼šè¿è¡Œå¾ˆå¤šPodï¼Œå½“è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œå‘ç°Nodeä¸Šçš„èµ„æºç´§å¼ äº†ï¼Œè¿™æ—¶K8så°±ä¼šæ ¹æ®QoSç±»åˆ«æ¥é€‰æ‹©Killæ‰ä¸€éƒ¨åˆ†Podï¼Œé‚£äº›ä¼šå…ˆè¢«Killæ‰ï¼Ÿ<br> ã€€å½“ç„¶å°±æ˜¯ä¼˜å…ˆçº§æœ€ä½çš„ï¼Œä¹Ÿå°±æ˜¯BestEffortï¼Œè‹¥BestEffortè¢«Killå®Œäº†ï¼Œè¿˜æ˜¯ç´§å¼ ï¼Œæ¥ä¸‹æ¥å°±æ˜¯Killä¸­ç­‰ä¼˜å…ˆçº§çš„ï¼Œå³Burstableï¼Œä¾æ¬¡ç±»æ¨ã€‚</p><p> ã€€è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼ŒBestEffortå› ä¸ºæ²¡æœ‰è®¾ç½®requestså’Œlimitsï¼Œå¯æ ¹æ®è°å ç”¨èµ„æºæœ€å¤šï¼Œå°±killè°ï¼Œä½†Burstableè®¾ç½®äº†requestså’Œlimitsï¼Œå®ƒçš„killæ ‡å‡†æ˜¯ä»€ä¹ˆï¼Ÿ<br> ã€€è‹¥æŒ‰ç…§è°å èµ„æºå¤škillè°ï¼Œé‚£é‡åˆ°è¿™æ ·çš„é—®é¢˜ï¼Œæ€ä¹ˆé€‰æ‹©ï¼Ÿ<br> ã€€ã€€ã€€PodA: å¯åŠ¨æ—¶è®¾ç½®äº†memory.request=512M , memory.limits=1G<br> ã€€ã€€ã€€PodB: è®¾ç½®ä¸º: memory.requests=1G, memory.limits=2G</p><p> ã€€ã€€ã€€PodA: è¿è¡Œäº†ä¸€æ®µæ—¶é—´åï¼Œå ç”¨äº†500Mäº†ï¼Œå®ƒå¯èƒ½è¿˜æœ‰ç»§ç»­ç”³è¯·å†…å­˜ã€‚<br> ã€€ã€€ã€€PodB: å®ƒåˆ™å ç”¨äº†512Må†…å­˜äº†ï¼Œä½†å®ƒå¯èƒ½ä¹Ÿè¿˜éœ€è¦ç”³è¯·å†…å­˜ã€‚<br> ã€€ã€€ã€€æƒ³æƒ³ï¼Œç°åœ¨Nodeèµ„æºç´§å¼ äº†ï¼Œä¼šå…ˆkillè°ï¼Ÿ<br> ã€€ã€€ã€€å…¶å®ï¼Œä¼šä¼˜å…ˆkill PodA ï¼Œ ä¸ºå•¥ï¼Ÿ<br> ã€€ã€€ã€€å› ä¸ºå®ƒå¯åŠ¨æ—¶ï¼Œè¯´è‡ªå·±éœ€è¦512Må†…å­˜å°±å¤Ÿäº†ï¼Œä½†ä½ ç°åœ¨è¿™ä¹ˆç§¯æçš„ç”³è¯·å†…å­˜ï¼Œéƒ½å¿«æŠŠä½ éœ€æ±‚çš„å†…å­˜åƒå®Œäº†ï¼Œåªèƒ½è¯´æ˜ä½ å¤ªæ¿€è¿›äº†ï¼Œå› æ­¤ä¼šå…ˆkillã€‚<br> ã€€ã€€ã€€è€ŒPodBï¼Œå¯åŠ¨æ—¶éœ€è¦1Gï¼Œä½†ç›®å‰æ‰ç”¨äº†1åŠï¼Œè¯´æ˜å®ƒæ¯”è¾ƒæ¸©å’Œï¼Œå› æ­¤ä¸ä¼šå…ˆkillå®ƒã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p><p>æŒ‚æ‰çš„nhospitalå®¹å™¨çš„èµ„æºé…ç½®ä¸ºï¼š</p><p>cpu.request=0.1m cpu.limit=0.9m  memory.request=512M memory.limits=2248M</p><p>æ•…nhospitalå®¹å™¨çš„Qosç±»å‹ä¸ºBurstable,è‹¥è¯¥å®¹å™¨æ¯”è¾ƒæ¿€è¿›ä½¿ç”¨å†…å­˜å®¹æ˜“è¢«kill</p><p>ä¿®æ”¹nhospitalå®¹å™¨çš„èµ„æºé…ç½®ä¸ºï¼š</p><p>cpu.request=0.1m cpu.limit=0.9m memory.request=2248M memory.limits=2248M</p><p>å½“pod å†…å­˜è¶…è¿‡limitæ—¶ï¼Œä¼šè¢«oomã€‚</p><p>å½“cpuè¶…è¿‡limitæ—¶ï¼Œä¸ä¼šè¢«killï¼Œä½†æ˜¯ä¼šé™åˆ¶ä¸è¶…è¿‡limitå€¼ã€‚</p><p>æ‰€ä»¥åªä¿®æ”¹memoryçš„requestè·Ÿlimitä¿æŒä¸€è‡´å³å¯</p><p>è¿™æ ·nhospitalå®¹å™¨çš„Qosç±»å‹å°±å˜ä¸ºäº†Guranteed,åˆ†å€¼æœ€ä½ä¸ä¼šè¢«kill</p><p>å½“å‰èŠ‚ç‚¹æ± ä¸­çš„èŠ‚ç‚¹å†…å­˜ä½¿ç”¨é‡éƒ½åœ¨73-78%,å½“å…¶ä»–æœåŠ¡å†…å­˜å¢é•¿è¿‡é«˜æƒ…å†µä¸‹ä¼šå¯¼è‡´ä¼šå…ˆoomæƒ…å†µ,å¯è¿›è¡Œå†…å­˜æ‰©å®¹è¿›è¡Œé¿å…OOMå‘ç”Ÿ</p><img src="https://nmk0718.github.io/image/node.png"><h3 id="ä»£ç è·å–ä¸åˆ°å®¢æˆ·ç«¯çœŸå®ip"><a href="#ä»£ç è·å–ä¸åˆ°å®¢æˆ·ç«¯çœŸå®ip" class="headerlink" title="ä»£ç è·å–ä¸åˆ°å®¢æˆ·ç«¯çœŸå®ip"></a>ä»£ç è·å–ä¸åˆ°å®¢æˆ·ç«¯çœŸå®ip</h3><p>æ’æŸ¥ä¸€:</p><figure class="highlight"><table><tr><td class="code"><pre><span class="line">æŸ¥çœ‹nginxæœåŠ¡å™¨é…ç½®è½¬å‘æ˜¯å¦æ­£ç¡®</span><br><span class="line"><span class="attribute">proxy_set_header</span>   Host    <span class="variable">$host</span>;</span><br><span class="line"><span class="attribute">proxy_set_header</span>   X-Real-IP   <span class="variable">$remote_addr</span>;</span><br><span class="line"><span class="attribute">proxy_set_header</span>   X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line"><span class="attribute">proxy_set_header</span>   X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line"></span><br><span class="line">æŸ¥çœ‹å¾—çŸ¥æ­£ç¡®æ— è¯¯</span><br></pre></td></tr></table></figure><p>æ’æŸ¥äºŒï¼š</p><figure class="highlight"><table><tr><td class="code"><pre><span class="line">æŸ¥çœ‹k8sä¸­çš„ingressè½¬å‘æ˜¯å¦æ­£ç¡®</span><br><span class="line"><span class="attribute">proxy_set_header</span> Host                   <span class="variable">$best_http_host</span>;</span><br><span class="line"><span class="attribute">proxy_set_header</span> X-Real-IP              <span class="variable">$remote_addr</span>;</span><br><span class="line"><span class="attribute">proxy_set_header</span> X-Forwarded-For        <span class="variable">$remote_addr</span>;</span><br><span class="line"><span class="attribute">proxy_set_header</span> X-Forwarded-Proto      <span class="variable">$pass_access_scheme</span>;</span><br><span class="line"></span><br><span class="line">å¯¹æ¯”åå‘ç°æœ‰å·®å¼‚</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹proxy_set_header X-Forwarded-For        $remote_addr;ä¸­çš„$remote_addrä¸º $proxy_add_x_forwarded_for;</p><p>å†æ¬¡è¿›è¡Œè·å–å®¢æˆ·ç«¯çœŸå®ip,è·å–æ­£å¸¸</p><h3 id="2021å¹´9æœˆ18å·å‡ºç°å®•æœºé—®é¢˜æ±‡æ€»"><a href="#2021å¹´9æœˆ18å·å‡ºç°å®•æœºé—®é¢˜æ±‡æ€»" class="headerlink" title="2021å¹´9æœˆ18å·å‡ºç°å®•æœºé—®é¢˜æ±‡æ€»"></a>2021å¹´9æœˆ18å·å‡ºç°å®•æœºé—®é¢˜æ±‡æ€»</h3><ol><li>åœ¨10:43åˆ†å·¦å³å‡ºç°appç™»å½•ä¸ä¸Šé—®é¢˜,æŸ¥çœ‹é¡¹ç›®æŠ¥é”™æ—¥å¿—</li></ol><p>Exception in thread â€œThread-38â€ org.springframework.jdbc.BadSqlGrammarException: Error selecting key or setting result to parameter object. Cause: org.postgresql.util.PSQLException: é”™è¯¯: è¯­æ³•é”™è¯¯ åœ¨ â€œPostgreSQLâ€ æˆ–é™„è¿‘çš„<br>  Position: 1<br> ; bad SQL grammar []; nested exception is org.postgresql.util.PSQLException: é”™è¯¯: è¯­æ³•é”™è¯¯ åœ¨ â€œPostgreSQLâ€ æˆ–é™„è¿‘çš„<br>  Position: 1</p><p>æ˜¯ç”±ä¸Šè¿°æŠ¥é”™å¯¼è‡´é¡¹ç›®æŒ‚æ‰,æ‰¾åˆ°è¯¥æ¥å£è´Ÿè´£äºº,è¿›è¡Œä¿®æ”¹.é‡æ–°æäº¤ä»£ç å,è¿›è¡Œé‡æ–°å‘å¸ƒ</p><p>å†æ¬¡è§‚å¯Ÿç›‘æ§å¾—çŸ¥å†æ¬¡å®•æœº</p><img src="https://nmk0718.github.io/image/20210918monitor.png"><p>æŸ¥çœ‹æ—¥å¿—æœªæœ‰æŠ¥é”™,CPUå’Œå†…å­˜æº¢å‡º.åˆæ”¶åˆ°éƒ½å¸‚å¤§åŒ»ç”Ÿä¹Ÿå‡ºç°å®•æœºé—®é¢˜,åŠ å¤§é¡¹ç›®èŠ‚ç‚¹è§‚å¯Ÿæ˜¯å¦å®•æœºè¿˜æ˜¯å‡ºç°é—®é¢˜</p><p>é€šè¿‡nginxæŸ¥çœ‹è¯·æ±‚çš„ipå’ŒURL é€šè¿‡è®¿é—®åœ°å€è¿›è¡Œåˆ†æ</p><img src="https://nmk0718.github.io/image/20210918sls.png"><table><thead><tr><th>å‰4ä¸ªè¯·æ±‚æœ€å¤šçš„åœ°å€ä¸º:</th><th>ä¸šåŠ¡</th></tr></thead><tbody><tr><td>/zuul/live-app/ext/video/getRandomProduct</td><td>é¦–é¡µæ¨èè§†é¢‘</td></tr><tr><td>/zuul/live-app/ext/video/article/recommended</td><td>é¦–é¡µæ¨èæ–‡ç« </td></tr><tr><td>/doctor-api/v1_0/user/logoutForLj</td><td>ç”¨æˆ·é€€å‡ºç™»å½•</td></tr><tr><td>/zuul/live-app/ext/app/saveChannel</td><td>ä¸ŠæŠ¥æ¸ é“</td></tr></tbody></table><p>æŸ¥çœ‹å¾—çŸ¥ç”¨æˆ·é€€å‡ºç™»å½•æ¥å£çš„è¯·æ±‚æ¬¡æ•°ä¸º25600æ¬¡,ä¸Šä¼ æ¸ é“æ¥å£çš„è¯·æ±‚æ¬¡æ•°ä¸º21474æ¬¡</p><p>å¾—å‡ºç»“è®º:</p><p>ç”¨æˆ·é€€å‡ºç™»å½•æ¥å£å¯¼è‡´æœåŠ¡å®•æœº,ä½¿ç”¨æˆ·æ— æ³•è®¿é—®éƒ½å¸‚å¤§åŒ»ç”Ÿ,ä¸ŠæŠ¥æ¸ é“æ¥å£å¯¼è‡´æ¥å£å‡ºç°æ— æ³•è®¿é—®é—®é¢˜</p><p>ååŠ©å¼€å‘æŸ¥è¯¢ä»£ç é—®é¢˜,æ‰¾åˆ°é—®é¢˜åŸå› ,ç”¨æˆ·é€€å‡ºç™»å½•æ¥å£ä¸€ç›´åœ¨æ­»å¾ªç¯è¯·æ±‚æœåŠ¡å™¨,å¯¼è‡´æœåŠ¡ä¸€ç›´é‡å¯.ä¸ŠæŠ¥æ¸ é“æ¥å£å› ä¿®æ”¹appç™»å½•ä¸ä¸Šæ—¶å‡ºç°äº†502,ä¹Ÿä¼šä¸€ç›´è¯·æ±‚æœåŠ¡å™¨.å¼€å‘è¿›è¡Œé‡æ–°ä¿®å¤ä»£ç é—®é¢˜å,é‡æ–°æ‰“å‡ºappåŒ….å†æ— é—®é¢˜å‡ºç°</p><p><strong>åç»­</strong></p><p>è¯¥é—®é¢˜ä¸ºä»£ç é—®é¢˜,éƒ½æ˜¯æ­£å¸¸çš„è¯·æ±‚,ä½†æ˜¯å‡ºç°äº†æ­»å¾ªç¯,åŠ å¤§æœåŠ¡å™¨èŠ‚ç‚¹å’Œå†…å­˜æ— æ³•é¿å…è¯¥æƒ…å†µå‘ç”Ÿ,åªèƒ½é€šè¿‡æ’æŸ¥ä»£ç ä¸­çš„é—®é¢˜æ¥è§£å†³.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;appåå°æŒ‚æ‰é—®é¢˜æ±‡æ€»&quot;&gt;&lt;a href=&quot;#appåå°æŒ‚æ‰é—®é¢˜æ±‡æ€»&quot; class=&quot;headerlink&quot; title=&quot;appåå°æŒ‚æ‰é—®é¢˜æ±‡æ€»&quot;&gt;&lt;/a&gt;appåå°æŒ‚æ‰é—®é¢˜æ±‡æ€»&lt;/h3&gt;&lt;p&gt;æŠ¥é”™:&lt;/p&gt;
&lt;p&gt;æ•°æ®åº“è¿æ¥æ± ä¸å¯ç”¨&lt;/p&gt;
&lt;p&gt;&lt;img s</summary>
      
    
    
    
    
    <category term="mysql" scheme="https://nmk0718.github.io/tag/mysql/"/>
    
  </entry>
  
  <entry>
    <title>Skywalking</title>
    <link href="https://nmk0718.github.io/2021/03/27/skywalking/"/>
    <id>https://nmk0718.github.io/2021/03/27/skywalking/</id>
    <published>2021-03-27T07:25:00.000Z</published>
    <updated>2024-11-29T06:45:25.617Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸‹è½½skywalking</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https://mirror.bit.edu.cn/apache/skywalking/8.0.0/apache-skywalking-apm-es7-8.0.0.tar.gz</span><br></pre></td></tr></table></figure><p>è§£å‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tar zxvf apache-skywalking-apm-es7-8.0.0.tar.gz</span><br></pre></td></tr></table></figure><p><strong>collectoré…ç½®</strong></p><p>vi apache-skywalking-apm-bin-es7/config/application.yml </p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">core:</span><br><span class="line">  selector: $&#123;SW_CORE:default&#125;</span><br><span class="line">  default:</span><br><span class="line">    # Mixed: Receive agent data, Level 1 aggregate, Level 2 aggregate</span><br><span class="line">    # Receiver: Receive agent data, Level 1 aggregate</span><br><span class="line">    # Aggregator: Level 2 aggregate</span><br><span class="line">    role: $&#123;SW_CORE_ROLE:Mixed&#125; # Mixed/Receiver/Aggregator</span><br><span class="line">    </span><br><span class="line">    # rest æœåŠ¡åœ°å€å’Œç«¯å£</span><br><span class="line">    restHost: $&#123;SW_CORE_REST_HOST:0.0.0.0&#125;</span><br><span class="line">    #ä¸webAppçš„12800å¯¹åº”</span><br><span class="line">    restPort: $&#123;SW_CORE_REST_PORT:12800&#125;</span><br><span class="line">    restContextPath: $&#123;SW_CORE_REST_CONTEXT_PATH:/&#125;</span><br><span class="line">    </span><br><span class="line">    # gRPC æœåŠ¡åœ°å€å’Œç«¯å£</span><br><span class="line">    gRPCHost: $&#123;SW_CORE_GRPC_HOST:0.0.0.0&#125;</span><br><span class="line">    #ä¸agentç«¯11800å¯¹åº”</span><br><span class="line">    gRPCPort: $&#123;SW_CORE_GRPC_PORT:11800&#125;</span><br><span class="line">   </span><br><span class="line">storage:</span><br><span class="line">#æ›´æ”¹é»˜è®¤ä¸ºelasticsearch7</span><br><span class="line">  selector: $&#123;SW_STORAGE:elasticsearch7&#125;</span><br><span class="line">  elasticsearch7:</span><br><span class="line">  #nameSpaceä¸esçš„åç§°ä¿æŒä¸€è‡´</span><br><span class="line">    nameSpace: gzlp-elasticsearch</span><br><span class="line">  #esé›†ç¾¤èŠ‚ç‚¹</span><br><span class="line">    clusterNodes: 172.17.53.225:9100,172.17.53.226:9101,172.17.53.227:9102</span><br><span class="line">    protocol: $&#123;SW_STORAGE_ES_HTTP_PROTOCOL:&quot;http&quot;&#125;</span><br><span class="line">    trustStorePath: $&#123;SW_STORAGE_ES_SSL_JKS_PATH:&quot;&quot;&#125;</span><br><span class="line">    trustStorePass: $&#123;SW_STORAGE_ES_SSL_JKS_PASS:&quot;&quot;&#125;</span><br><span class="line">    dayStep: $&#123;SW_STORAGE_DAY_STEP:1&#125;</span><br><span class="line">    user: $&#123;SW_ES_USER:&quot;&quot;&#125;</span><br><span class="line">    password: $&#123;SW_ES_PASSWORD:&quot;&quot;&#125;</span><br></pre></td></tr></table></figure><p><strong>webApp é…ç½®</strong></p><p>vi apache-skywalking-apm-bin-es7/webapp/webapp.yml</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server:</span><br><span class="line">#webè®¿é—®ç«¯å£</span><br><span class="line">  port: 8070</span><br><span class="line"></span><br><span class="line">collector:</span><br><span class="line">  path: /graphql</span><br><span class="line">  ribbon:</span><br><span class="line">    ReadTimeout: 10000</span><br><span class="line">    # Point to all backend&apos;s restHost:restPort, split by ,</span><br><span class="line">    #ä¸application.ymlä¸­çš„restPortç›¸å¯¹åº”</span><br><span class="line">    listOfServers: 127.0.0.1:12800</span><br></pre></td></tr></table></figure><p>å¯åŠ¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">./bin/oapService.sh</span><br><span class="line"></span><br><span class="line">./bin/webappService.sh</span><br></pre></td></tr></table></figure><p><strong>Agent é…ç½®</strong></p><p>vi apache-skywalking-apm-bin-es7/agent/config/agent.config</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># è®¾ç½®Agentå‘½åç©ºé—´ï¼Œå®ƒç”¨æ¥éš”ç¦»è¿½è¸ªå’Œç›‘æ§æ•°æ®ï¼Œå½“ä¸¤ä¸ªåº”ç”¨ä½¿ç”¨ä¸åŒçš„åç§°ç©ºé—´æ—¶ï¼Œè·¨è¿›ç¨‹ä¼ æ’­é“¾ä¼šä¸­æ–­ã€‚</span><br><span class="line">agent.namespace=$&#123;SW_AGENT_NAMESPACE:default-namespace&#125;</span><br><span class="line"> </span><br><span class="line"># è®¾ç½®æœåŠ¡åç§°ï¼Œä¼šåœ¨ Skywalking UI ä¸Šæ˜¾ç¤ºçš„åç§°</span><br><span class="line">agent.service_name=$&#123;SW_AGENT_NAME:Your_ApplicationName&#125;</span><br><span class="line"> </span><br><span class="line"># æ¯ 3ç§’é‡‡é›†çš„æ ·æœ¬è·Ÿè¸ªæ¯”ä¾‹ï¼Œå¦‚æœæ˜¯è´Ÿæ•°åˆ™è¡¨ç¤º 100%é‡‡é›†</span><br><span class="line">agent.sample_n_per_3_secs=$&#123;SW_AGENT_SAMPLE:-1&#125;</span><br><span class="line"> </span><br><span class="line"># å¯ç”¨ Debug ï¼Œå¦‚æœä¸º true åˆ™å°†æŠŠæ‰€æœ‰æ£€æµ‹åˆ°çš„ç±»æ–‡ä»¶ä¿å­˜åœ¨&quot;/debug&quot;æ–‡ä»¶å¤¹ä¸­</span><br><span class="line"># agent.is_open_debugging_classÂ =Â $&#123;SW_AGENT_OPEN_DEBUG:true&#125;</span><br><span class="line"> </span><br><span class="line"># åç«¯çš„ collector ç«¯å£åŠåœ°å€</span><br><span class="line">collector.backend_service=$&#123;SW_AGENT_COLLECTOR_BACKEND_SERVICES:192.168.2.215:11800&#125;</span><br><span class="line"> </span><br><span class="line"># æ—¥å¿—çº§åˆ«</span><br><span class="line">logging.level=$&#123;SW_LOGGING_LEVEL:DEBUG&#125;</span><br></pre></td></tr></table></figure><p>æŠŠapache-skywalking-apm-bin-es7/agent ç›®å½•ï¼Œæ‹·è´åˆ°åº”ç”¨æ‰€åœ¨çš„æœåŠ¡å™¨ä¸Šã€‚</p><p>å¯åŠ¨åº”ç”¨æ—¶</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#namespaceå’Œservice_nameæ”¹ä¸ºå¯¹åº”çš„æœåŠ¡ç¯å¢ƒå’Œåç§°</span><br><span class="line"></span><br><span class="line">java -jar -Dskywalking.agent.namespace=prod -Dskywalking.agent.service_name=prod-servicename -javaagent:/home/skywalking/agent/skywalking-agent.jar $JARFILE --spring.profiles.active=$ACTIVE  &gt;&gt; $LOG &amp;</span><br></pre></td></tr></table></figure><p>skywalkingé¡µé¢ä½¿ç”¨<br><strong>ä»ªè¡¨ç›˜</strong><br><img src="\image\5f1f90c77116a.png"><br><strong>æ‹“æ‰‘å›¾</strong><br>æ ¹æ®æœåŠ¡è°ƒç”¨è‡ªåŠ¨è¿˜åŸåº”ç”¨æ‹“æ‰‘å›¾ï¼Œè¿çº¿ä¼šæ ¹æ®è¯·æ±‚å…³ç³»åŠ¨æ€æµåŠ¨<br><img src="\image\5f1f938b359cb.png"><br><strong>è¿½è¸ª</strong><br>æŸ¥çœ‹å…·ä½“urlçš„è€—æ—¶åŸå› <br><img src="\image\/5f1f961c4b7e3.png"><br>çº¢è‰²çš„urlå¯ä»¥æŸ¥çœ‹æ—¥å¿—è¯¦æƒ…<br><img src="\image\5f1f96a3248b7.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ä¸‹è½½skywalking&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;wget https://mirror.bit.edu.cn/apach</summary>
      
    
    
    
    
    <category term="Skywalking" scheme="https://nmk0718.github.io/tag/Skywalking/"/>
    
  </entry>
  
  <entry>
    <title>GitLab</title>
    <link href="https://nmk0718.github.io/2021/03/27/gitlab/"/>
    <id>https://nmk0718.github.io/2021/03/27/gitlab/</id>
    <published>2021-03-27T07:23:00.000Z</published>
    <updated>2025-02-10T04:00:59.681Z</updated>
    
    <content type="html"><![CDATA[<h3 id="GitLab-CI-CD"><a href="#GitLab-CI-CD" class="headerlink" title="GitLab CI/CD"></a>GitLab CI/CD</h3><h4 id="ä½¿ç”¨dockerä¸‹è½½gitlabé•œåƒ"><a href="#ä½¿ç”¨dockerä¸‹è½½gitlabé•œåƒ" class="headerlink" title="ä½¿ç”¨dockerä¸‹è½½gitlabé•œåƒ"></a>ä½¿ç”¨dockerä¸‹è½½gitlabé•œåƒ</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker pull gitlab/gitlab-ce</span><br></pre></td></tr></table></figure><h4 id="æ£€æŸ¥é•œåƒä¸‹è½½æ˜¯å¦æˆåŠŸ"><a href="#æ£€æŸ¥é•œåƒä¸‹è½½æ˜¯å¦æˆåŠŸ" class="headerlink" title="æ£€æŸ¥é•œåƒä¸‹è½½æ˜¯å¦æˆåŠŸ"></a>æ£€æŸ¥é•œåƒä¸‹è½½æ˜¯å¦æˆåŠŸ</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@public ~]# docker images</span><br><span class="line">REPOSITORY                                TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">gitlab/gitlab-ce                          latest              85ef0c92d667        3 days ago          1.98GB</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºæ•°æ®å­˜å‚¨ç›®å½•"><a href="#åˆ›å»ºæ•°æ®å­˜å‚¨ç›®å½•" class="headerlink" title="åˆ›å»ºæ•°æ®å­˜å‚¨ç›®å½•"></a>åˆ›å»ºæ•°æ®å­˜å‚¨ç›®å½•</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@public ~]# mkdir -p /opt/gitlab/data</span><br><span class="line">[root@public ~]# mkdir /opt/gitlab/logs</span><br><span class="line">[root@public ~]# mkdir /opt/gitlab/config</span><br></pre></td></tr></table></figure><h4 id="å¯åŠ¨gitlab"><a href="#å¯åŠ¨gitlab" class="headerlink" title="å¯åŠ¨gitlab"></a>å¯åŠ¨gitlab</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@public gitlab]# docker run --detach \</span><br><span class="line">       --hostname 192.168.229.8 \</span><br><span class="line">       --publish 8443:443 --publish 9080:80 --publish 2222:22 \</span><br><span class="line">       --name gitlab \</span><br><span class="line">       --restart always \</span><br><span class="line">       --privileged=true \</span><br><span class="line">       --volume /file/gitlab/config:/etc/gitlab \</span><br><span class="line">   --volume /file/gitlab/logs:/var/log/gitlab \</span><br><span class="line">       --volume /file/gitlab/data:/var/opt/gitlab \</span><br><span class="line">      docker.io/gitlab/gitlab-ce:latest</span><br></pre></td></tr></table></figure><p><strong>gitlabå¦‚ä½¿ç”¨å•å°æœåŠ¡å™¨å¯ä½¿ç”¨é»˜è®¤é…ç½®,è‹¥è·Ÿåˆ«çš„æœåŠ¡æ”¾ä¸€èµ·ä¼šå‡ºç°gitlabå ç”¨å†…å­˜è¿‡å¤šé—®é¢˜</strong></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi /file/gitlab/config/gitlab.rb</span><br><span class="line"></span><br><span class="line">#å»æ‰ä¸‹é¢çš„æ³¨é‡Š</span><br><span class="line"></span><br><span class="line">unicorn[&apos;worker_processes&apos;] = 2</span><br><span class="line"></span><br><span class="line">#ä¹‹åæ‰§è¡Œ</span><br><span class="line"></span><br><span class="line">docker exec -it gitlab gitlab-ctl reconfigure</span><br><span class="line"></span><br><span class="line">docker exec -it gitlab gitlab-ctl restart</span><br></pre></td></tr></table></figure><p>gitlabåˆå§‹ç”¨æˆ·åå¯†ç </p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@deployment /]# cat /opt/gitlab/config/initial_root_password </span><br><span class="line"># WARNING: This value is valid only in the following conditions</span><br><span class="line">#          1. If provided manually (either via `GITLAB_ROOT_PASSWORD` environment variable or via `gitlab_rails[&apos;initial_root_password&apos;]` setting in `gitlab.rb`, it was provided before database was seeded for the first time (usually, the first reconfigure run).</span><br><span class="line">#          2. Password hasn&apos;t been changed manually, either via UI or via command line.</span><br><span class="line">#</span><br><span class="line">#          If the password shown here doesn&apos;t work, you must reset the admin password following https://docs.gitlab.com/ee/security/reset_user_password.html#reset-your-root-password.</span><br><span class="line"></span><br><span class="line">Password: GHztfkIk0eg4qdTTNn5owN+7jK3ojlUHLrXMibB5Pj8=</span><br><span class="line"></span><br><span class="line"># NOTE: This file will be automatically deleted in the first reconfigure run after 24 hours.</span><br></pre></td></tr></table></figure><h4 id="å®‰è£…GitLab-Runner"><a href="#å®‰è£…GitLab-Runner" class="headerlink" title="å®‰è£…GitLab Runner"></a>å®‰è£…GitLab Runner</h4><p>ä¸‹è½½å¹¶å®‰è£…äºŒè¿›åˆ¶æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># Download the binary for your system</span><br><span class="line">curl -L --output /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64</span><br><span class="line"></span><br><span class="line"># Give it permissions to execute</span><br><span class="line">chmod +x /usr/local/bin/gitlab-runner</span><br><span class="line"></span><br><span class="line"># Create a GitLab CI user</span><br><span class="line">useradd --comment &apos;GitLab Runner&apos; --create-home gitlab-runner --shell /bin/bash</span><br><span class="line"></span><br><span class="line"># Install and run as service</span><br><span class="line">gitlab-runner install --user=gitlab-runner --working-directory=/home/gitlab-runner</span><br><span class="line">gitlab-runner start</span><br></pre></td></tr></table></figure><h4 id="æ³¨å†Œrunnerçš„å‘½ä»¤"><a href="#æ³¨å†Œrunnerçš„å‘½ä»¤" class="headerlink" title="æ³¨å†Œrunnerçš„å‘½ä»¤"></a>æ³¨å†Œrunnerçš„å‘½ä»¤</h4><p>æ³¨å†Œçš„åœ°å€è¦å¡«å†™ä¸ºip+port.ä¸è¦ä½¿ç”¨webé¡µé¢å±•ç¤ºçš„<a href="http://ip//" target="_blank" rel="noopener">http://ip//</a> å¦åˆ™æ³¨å†Œå¤±è´¥</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@deployment /]# gitlab-runner register</span><br><span class="line">Runtime platform                                    arch=amd64 os=linux pid=86642 revision=58ba2b95 version=14.2.0</span><br><span class="line">Running in system-mode.                            </span><br><span class="line">                                                   </span><br><span class="line">Enter the GitLab instance URL (for example, https://gitlab.com/):</span><br><span class="line">http://192.168.50.52:9090/</span><br><span class="line">Enter the registration token:</span><br><span class="line">cZ8xxddc9zciAHAsJpqB</span><br><span class="line">Enter a description for the runner:</span><br><span class="line">[deployment]: test</span><br><span class="line">Enter tags for the runner (comma-separated):</span><br><span class="line">test</span><br><span class="line">Registering runner... succeeded                     runner=cZ8xxddc</span><br><span class="line">Enter an executor: docker, docker-ssh, parallels, shell, virtualbox, kubernetes, custom, ssh, docker+machine, docker-ssh+machine:</span><br><span class="line">shell</span><br><span class="line">Runner registered successfully. Feel free to start it, but if it&apos;s running already the config should be automatically reloaded!</span><br></pre></td></tr></table></figure><p>Runnerè¿æ¥</p><p>ä¸è¦æŠŠRunnerå’Œgitlabéƒ¨ç½²åœ¨ä¸€å°æœºå™¨ ä¸ç„¶ä¼šä¸€ç›´æ˜¾ç¤ºæœªè¿æ¥</p><img src="https://nmk0718.github.io/image/image-20210830152258004.png"><p>Runnerçš„æ„å»ºç›®å½•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/home/gitlab-runner/builds/ymVX6kY7/0/</span><br></pre></td></tr></table></figure><p>Runnerçš„æ³¨å†Œåçš„é…ç½®æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/etc/gitlab-runner/config.toml</span><br></pre></td></tr></table></figure><p>GitLab-CI.yml</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">variables:</span><br><span class="line">  GIT_STRATEGY: clone</span><br><span class="line"></span><br><span class="line">before_script:</span><br><span class="line">  - pwd</span><br><span class="line">  </span><br><span class="line">stages:</span><br><span class="line">  - build</span><br><span class="line">  - deploy</span><br><span class="line">  </span><br><span class="line">build-job:</span><br><span class="line">  stage: build</span><br><span class="line">  tags:</span><br><span class="line">    - nimingkun</span><br><span class="line">  only:</span><br><span class="line">    - release</span><br><span class="line">  script:</span><br><span class="line">    - mvn clean install -Dmaven.test.skip=true</span><br><span class="line">    - cp ymall/target/ymall-0.0.1-SNAPSHOT.jar  dockerfile/</span><br><span class="line">    - cd dockerfile &amp;&amp; sh build.sh ymall</span><br><span class="line">  artifacts:</span><br><span class="line">    paths:</span><br><span class="line">      - ymall/target/ymall-0.0.1-SNAPSHOT.jar</span><br><span class="line"></span><br><span class="line">deploy-job:</span><br><span class="line">  stage: deploy</span><br><span class="line">  tags:</span><br><span class="line">    - nimingkun</span><br><span class="line">  only:</span><br><span class="line">    - release</span><br><span class="line">  script:</span><br><span class="line">    - sh CD.sh</span><br></pre></td></tr></table></figure><p>ä¼šå‡ºç°æŠ¥é”™,å› ä¸ºgitç‰ˆæœ¬å‘ŠçŸ¥çš„é”™è¯¯</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">fatal: git fetch-pack: expected shallow list</span><br><span class="line">fatal: The remote end hung up unexpectedly</span><br></pre></td></tr></table></figure><p>è§£å†³æ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install  http://opensource.wandisco.com/centos/7/git/x86_64/wandisco-git-release-7-2.noarch.rpm</span><br><span class="line">yum update git</span><br></pre></td></tr></table></figure><p>CIä¸­å‡ºç°æ‰“åŒ…é•œåƒé”™è¯¯</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Post http://%2Fvar%2Frun%2Fdocker.sock/v1.24/build?buildargs=%7B%7D&amp;cachefrom=%5B%5D&amp;cgroupparent=&amp;cpuperiod=0&amp;cpuquota=0&amp;cpusetcpus=&amp;cpusetmems=&amp;cpushares=0&amp;dockerfile=Dockerfile&amp;labels=%7B%7D&amp;memory=0&amp;memswap=0&amp;networkmode=default&amp;rm=1&amp;shmsize=0&amp;t=192.168.50.52%3A8551%2Fymall%3Alatest&amp;target=&amp;ulimits=null&amp;version=1: dial unix /var/run/docker.sock: connect: permission denied</span><br></pre></td></tr></table></figure><p>åŸå› :</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ä½¿ç”¨rootè´¦æˆ·ç›´æ¥yumå®‰è£…dockerï¼Œç„¶åservice docker startå¯åŠ¨dockeræœåŠ¡ã€‚Gitlab-CIé»˜è®¤ä»¥gitlab-runnerç”¨æˆ·æ‰§è¡Œï¼Œå› æ­¤å¯¹/var/run/docker.sockæ— è®¿é—®æƒé™ï¼Œæ— æ³•ä¸docker daemoné€šä¿¡</span><br></pre></td></tr></table></figure><p>è§£å†³æ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">groupadd -r docker</span><br><span class="line">useradd -g docker -r docker -p &apos;password&apos;</span><br><span class="line"></span><br><span class="line">usermod -aG docker gitlab-runner</span><br><span class="line"></span><br><span class="line">service docker stop</span><br><span class="line">su docker </span><br><span class="line">sudo service docker start</span><br></pre></td></tr></table></figure><p>æˆ‘è¿™é‡Œä»…ä¸ºæµ‹è¯•GitLab-CI,æ•…ç›´æ¥æ·»åŠ dockeråˆ°gitlab-runnerç»„</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">usermod -aG  docker gitlab-runner</span><br></pre></td></tr></table></figure><p>æ‹‰å–Gitä»“åº“æ—¶æŠ¥é”™</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Initialized empty Git repository in /private/var/folders/g5/8twmk1xj481_6btvppyw5j4h0000gp/T/.tmpNYVg6H/.git/</span><br><span class="line">hint: Using &apos;master&apos; as the name for the initial branch. This default branch name</span><br><span class="line">hint: is subject to change. To configure the initial branch name to use in all</span><br><span class="line">hint: of your new repositories, which will suppress this warning, call:</span><br><span class="line">hint: </span><br><span class="line">hint:   git config --global init.defaultBranch &lt;name&gt;</span><br><span class="line">hint: </span><br><span class="line">hint: Names commonly chosen instead of &apos;master&apos; are &apos;main&apos;, &apos;trunk&apos; and</span><br><span class="line">hint: &apos;development&apos;. The just-created branch can be renamed via this command:</span><br><span class="line">hint: </span><br><span class="line">hint:   git branch -m &lt;name&gt;</span><br></pre></td></tr></table></figure><p>è§£å†³æ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git config --global init.defaultBranch master</span><br></pre></td></tr></table></figure><h4 id="GitLab-CI-æ–‡ä»¶è¯¦è§£"><a href="#GitLab-CI-æ–‡ä»¶è¯¦è§£" class="headerlink" title="GitLab-CI æ–‡ä»¶è¯¦è§£"></a>GitLab-CI æ–‡ä»¶è¯¦è§£</h4><table><thead><tr><th>å…³é”®å­—</th><th>æ˜¯å¦å¿…é¡»</th><th>æè¿°</th></tr></thead><tbody><tr><td>variables</td><td>éå¿…é¡»</td><td>åœ¨jobçº§åˆ«ä¸Šå®šä¹‰çš„å˜é‡</td></tr><tr><td>before_script</td><td>éå¿…é¡»</td><td>æå‰æ‰§è¡Œçš„è„šæœ¬</td></tr><tr><td>stages</td><td>å¿…é¡»</td><td>æŒ‡å®šä¸€ç»„jobåœ¨ä¸åŒåœºæ™¯é˜¶æ®µæ‰§è¡Œã€‚åœ¨ç›¸åŒ<strong>stage</strong>ä¸‹çš„job(ä»»åŠ¡)å°†ä¼šè¢«<strong>å¹¶è¡Œçš„</strong>æ‰§è¡Œ</td></tr><tr><td>job-name</td><td>å¿…é¡»</td><td>æµæ°´çº¿çš„ä»»åŠ¡çš„åç§°</td></tr><tr><td>stage</td><td>å¿…é¡»</td><td>ä¸stageså†…çš„åœºæ™¯é˜¶æ®µå¯¹åº”</td></tr><tr><td>tags</td><td>éå¿…é¡»</td><td>å®šä¹‰äº†å“ªäº›runneré€‚ç”¨è¯¥job</td></tr><tr><td>only</td><td>éå¿…é¡»</td><td>å®šä¹‰å“ªäº›gitå¼•ç”¨ï¼ˆåˆ†æ”¯ï¼‰é€‚ç”¨è¯¥job</td></tr><tr><td>except</td><td>éå¿…é¡»</td><td>å®šä¹‰äº†å“ªäº›gitå¼•ç”¨(åˆ†æ”¯)ä¸é€‚ç”¨è¯¥job</td></tr><tr><td>script</td><td>å¿…é¡»</td><td>å®šä¹‰Runneréœ€è¦æ‰§è¡Œçš„è„šæœ¬æˆ–å‘½ä»¤</td></tr><tr><td>artifacts</td><td>éå¿…é¡»</td><td>äº§ç‰©,é€šè¿‡pathsæŒ‡å®šæ–‡ä»¶å,å¯åœ¨gitlabé¡µé¢ä¸‹è½½æ”¹äº§ç‰©</td></tr><tr><td>after_script</td><td>éå¿…é¡»</td><td>åæ‰§è¡Œçš„è„šæœ¬</td></tr><tr><td>environment</td><td>éå¿…é¡»</td><td>å®šä¹‰è®©jobå®Œæˆéƒ¨ç½²çš„ç¯å¢ƒåç§°</td></tr></tbody></table><p><strong>only</strong>å’Œ<strong>except</strong>ä¸¤ä¸ªå‚æ•°è¯´æ˜äº†jobä»€ä¹ˆæ—¶å€™å°†ä¼šè¢«åˆ›å»º:</p><ol><li><strong>only</strong>å®šä¹‰äº†jobéœ€è¦æ‰§è¡Œçš„æ‰€åœ¨åˆ†æ”¯æˆ–è€…æ ‡ç­¾</li><li><strong>except</strong>å®šä¹‰äº†jobä¸ä¼šæ‰§è¡Œçš„æ‰€åœ¨åˆ†æ”¯æˆ–è€…æ ‡ç­¾</li></ol><p>ä»¥ä¸‹æ˜¯è¿™ä¸¤ä¸ªå‚æ•°çš„å‡ æ¡ç”¨æ³•è§„åˆ™ï¼š</p><ol><li><strong>only</strong>å’Œ<strong>except</strong>å¦‚æœéƒ½å­˜åœ¨åœ¨ä¸€ä¸ªjobå£°æ˜ä¸­ï¼Œåˆ™æ‰€éœ€å¼•ç”¨å°†ä¼šè¢«<strong>only</strong>å’Œ<strong>except</strong>æ‰€å®šä¹‰çš„åˆ†æ”¯è¿‡æ»¤.</li><li><strong>only</strong>å’Œ<strong>except</strong>å…è®¸ä½¿ç”¨æ­£åˆ™</li><li><strong>only</strong>å’Œ<strong>except</strong>å…è®¸ä½¿ç”¨æŒ‡å®šä»“åº“åœ°å€ï¼Œä½†æ˜¯ä¸forksä»“åº“</li></ol><p>æ­¤å¤–ï¼Œ<strong>only</strong>å’Œ<strong>except</strong>å…è®¸ä½¿ç”¨ä»¥ä¸‹ä¸€äº›ç‰¹æ®Šå…³é”®å­—ï¼š</p><table><thead><tr><th align="center">å€¼</th><th align="center">æè¿°</th></tr></thead><tbody><tr><td align="center">branches</td><td align="center">å½“ä¸€ä¸ªåˆ†æ”¯è¢«pushä¸Šæ¥</td></tr><tr><td align="center">tags</td><td align="center">å½“ä¸€ä¸ªæ‰“äº†tagçš„åˆ†æ”¯è¢«pushä¸Šæ¥</td></tr><tr><td align="center">api</td><td align="center">å½“ä¸€ä¸ªpiplineè¢«piplines apiæ‰€è§¦å‘è°ƒèµ·ï¼Œè¯¦è§<a href="https://link.segmentfault.com/?url=https%3A%2F%2Fdocs.gitlab.com%2Fce%2Fapi%2Fpipelines.html" target="_blank" rel="noopener">piplines api</a></td></tr><tr><td align="center">external</td><td align="center">å½“ä½¿ç”¨äº†GitLabä»¥å¤–çš„CIæœåŠ¡</td></tr><tr><td align="center">pipelines</td><td align="center">é’ˆå¯¹å¤šé¡¹ç›®è§¦å‘å™¨è€Œè¨€ï¼Œå½“ä½¿ç”¨CI_JOB_TOKENå¹¶ä½¿ç”¨gitlabæ‰€æä¾›çš„apiåˆ›å»ºå¤šä¸ªpipelinesçš„æ—¶å€™</td></tr><tr><td align="center">pushes</td><td align="center">å½“pipelineè¢«ç”¨æˆ·çš„git pushæ“ä½œæ‰€è§¦å‘çš„æ—¶å€™</td></tr><tr><td align="center">schedules</td><td align="center">é’ˆå¯¹é¢„å®šå¥½çš„piplineè€Œè¨€ï¼ˆæ¯æ—¥æ„å»ºä¸€ç±»~ï¼Œå…·ä½“è¯·çœ‹<a href="https://link.segmentfault.com/?url=https%3A%2F%2Fdocs.gitlab.com%2Fce%2Fuser%2Fproject%2Fpipelines%2Fschedules.html" target="_blank" rel="noopener">é“¾æ¥</a>ï¼‰</td></tr><tr><td align="center">triggers</td><td align="center">ç”¨tokenåˆ›å»ºpiplinesçš„æ—¶å€™</td></tr><tr><td align="center">web</td><td align="center">åœ¨GitLabé¡µé¢ä¸ŠPipelinesæ ‡ç­¾é¡µä¸‹ï¼Œä½ æŒ‰äº†<strong>run pipline</strong>çš„æ—¶å€™</td></tr></tbody></table><p>ä¸‹é¢çš„ä¾‹å­ï¼Œ<strong>job</strong>å°†ä¼šåªåœ¨<strong>issue-</strong>å¼€å¤´çš„refsä¸‹æ‰§è¡Œï¼Œåä¹‹åˆ™å…¶ä»–æ‰€æœ‰åˆ†æ”¯è¢«è·³è¿‡ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">job:</span><br><span class="line">  <span class="comment"># use regexp</span></span><br><span class="line">  only:</span><br><span class="line">    - /^issue-.*$/</span><br><span class="line">  <span class="comment"># use special keyword</span></span><br><span class="line">  except:</span><br><span class="line">    - branches</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<strong>job</strong>åªä¼šåœ¨æ‰“äº†tagçš„åˆ†æ”¯ï¼Œæˆ–è€…è¢«apiæ‰€è§¦å‘ï¼Œæˆ–è€…æ¯æ—¥æ„å»ºä»»åŠ¡ä¸Šè¿è¡Œï¼Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">job:</span><br><span class="line">  <span class="comment"># use special keywords</span></span><br><span class="line">  only:</span><br><span class="line">    - tags</span><br><span class="line">    - triggers</span><br><span class="line">    - schedules</span><br></pre></td></tr></table></figure><p>Git Strategyï¼ˆgitç­–ç•¥ï¼‰</p><p>ä½ å¯ä»¥é€šè¿‡åœ¨å…¨å±€å˜é‡è®¾ç½®ä½ç½®æˆ–è€…jobå±€éƒ¨å˜é‡è®¾ç½®ä½ç½®æ¥è®¾ç½®<strong>GIT_STRATEGY</strong>ç”¨ä»¥è·å–åº”ç”¨æœ€è¿‘æ›´æ–°çš„ä»£ç ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤çš„é¡¹ç›®è®¾ç½®å°†ä¼šè¢«ä½¿ç”¨ã€‚</p><p>è¯¥é€‰é¡¹æœ‰ä¸‰ä¸ªå¯èƒ½çš„å€¼ï¼šclone,fetchå’Œnone</p><p>cloneæ˜¯æœ€æ…¢çš„é€‰é¡¹ï¼Œå¦‚æœè®¾ç½®è¯¥å€¼ï¼Œæ¯ä¸ªjobå°†ä¼šéƒ½å…‹éš†ä¸€éä»“åº“ï¼Œç¡®ä¿é¡¹ç›®å·¥ä½œç©ºé—´æ€»æ˜¯åŸå§‹çš„æ­£ç¡®çš„ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">variables:</span><br><span class="line">  GIT_STRATEGY: <span class="built_in">clone</span></span><br></pre></td></tr></table></figure><p>fetchæ˜¯æ›´å¿«çš„æ“ä½œé€‰é¡¹ï¼Œå› ä¸ºä»–é‡ç”¨äº†é¡¹ç›®çš„å·¥ä½œç©ºé—´ï¼ˆå¦‚æœæ²¡æœ‰çš„è¯ï¼Œä¼šå»cloneï¼‰, git cleanç”¨äºæ’¤é”€ä¸Šä¸€ä¸ªjobçš„ä»»ä½•æ“ä½œï¼Œgit fetchæ˜¯ç”¨æ¥é‡æ–°è·å–ä¸Šä¸€ä¸ªjobè¿è¡Œåˆ°å½“å‰jobäº§ç”Ÿçš„commit</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">variables:</span><br><span class="line">  GIT_STRATEGY: fetch</span><br></pre></td></tr></table></figure><p>noneä¹ŸåŒæ ·é‡ç”¨äº†é¡¹ç›®ç©ºé—´ï¼ˆä½†æ˜¯ä»–ä¼šè·³è¿‡æ‰€æœ‰gitæ“ä½œï¼ŒåŒ…æ‹¬å¦‚æœå­˜åœ¨çš„gitlab runnerçš„é¢„å…‹éš†è„šæœ¬ï¼‰ã€‚å…¶ä¸»è¦ç”¨äºåªæ˜¯ä¸ºäº†æ“ä½œartifactsçš„jobä¸Šï¼ˆä¾‹å¦‚depolyéƒ¨ç½²è¡Œä¸ºï¼‰ã€‚æ­¤æ—¶Gitä»“åº“çš„æ•°æ®å¯èƒ½æ˜¯å­˜åœ¨çš„ï¼Œä½†å®ƒä¸€å®šä¸æ˜¯æœ€æ–°çš„ã€‚æ‰€ä»¥åœ¨è®¾ç½®äº†noneçš„jobé‡Œä½ åº”è¯¥ä¾èµ–ä»cacheæˆ–è€…artifactsæ¥çš„æ•°æ®ï¼Œè€Œä¸æ˜¯ä»“åº“æ•°æ®ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">variables:</span><br><span class="line">  GIT_STRATEGY: none</span><br></pre></td></tr></table></figure><p>Shallow cloning (æµ…å…‹éš†)</p><p>æŠ“å–æˆ–è€…å…‹éš†æœ€æ–°ä¸‰æ¡commits:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">variables:</span><br><span class="line">  GIT_DEPTH: <span class="string">"3"</span></span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æµæ°´çº¿é˜¶æ®µå®Œæˆæƒ…å†µ</p><img src="https://nmk0718.github.io/image/image-20210830152017883.png"><p>æŸ¥çœ‹æ¯ä¸ªé˜¶æ®µçš„è¿è¡Œæ—¥å¿—</p><img src="https://nmk0718.github.io/image/image-20210830152103621.png"><p>ä¸‹è½½ymlä¸­å®šä¹‰çš„äº§ç‰©</p><img src="https://nmk0718.github.io/image/image-20210830152157654.png"><p>åç»­å¯æ·±å…¥äº†è§£ gitlabé›†æˆKubernetes,Prometheuså’ŒGrafana.å¯åœ¨gitlabæŸ¥çœ‹éƒ¨ç½²æƒ…å†µ,æŸ¥çœ‹Kubernetesæ—¥å¿—,å®¡æ ¸æ˜¯å¦å‘å¸ƒç­‰æ“ä½œ</p><h4 id="å¤‡ä»½gitlab"><a href="#å¤‡ä»½gitlab" class="headerlink" title="å¤‡ä»½gitlab"></a>å¤‡ä»½gitlab</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@iZ2zeaxvb40ng4w24tpogoZ file]# crontab -l</span><br><span class="line">0 0 */3 * * sh /file/backup.sh</span><br><span class="line"></span><br><span class="line">[root@iZ2zeaxvb40ng4w24tpogoZ file]# cat /file/gitlab/push_aliyun.sh   </span><br><span class="line">docker commit -m &quot;gitlab&quot; 5f36554b62b3 registry-vpc.cn-beijing.aliyuncs.com/lepeng/gitlab:`date +%F`</span><br><span class="line">docker push registry-vpc.cn-beijing.aliyuncs.com/lepeng/gitlab:`date +%F`</span><br><span class="line"></span><br><span class="line">[root@iZ2zeaxvb40ng4w24tpogoZ file]# cat /file/backup.sh</span><br><span class="line">cd /file/</span><br><span class="line">tar zcvf gitlabconfig`date +%F`.tar config</span><br><span class="line">tar zcvf gitlabdata`date +%F`.tar data</span><br><span class="line">mv *.tar /data1/gitlab/backup/</span><br></pre></td></tr></table></figure><h4 id="gitlabé…ç½®ldap"><a href="#gitlabé…ç½®ldap" class="headerlink" title="gitlabé…ç½®ldap"></a>gitlabé…ç½®ldap</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim /file/config/gitlab.rb</span><br><span class="line">gitlab_rails[&apos;ldap_enabled&apos;] = true</span><br><span class="line">gitlab_rails[&apos;ldap_servers&apos;] = YAML.load &lt;&lt;-&apos;EOS&apos;</span><br><span class="line">   main: # &apos;main&apos; is the GitLab &apos;provider ID&apos; of this LDAP server</span><br><span class="line">     label: &apos;LDAP&apos;</span><br><span class="line">     host: &apos;39.107.142.154&apos;</span><br><span class="line">     port: 389</span><br><span class="line">     uid: &apos;cn&apos;</span><br><span class="line">     bind_dn: &apos;cn=admin,dc=gzlplink,dc=com&apos;</span><br><span class="line">     password: &apos;Lpldap123456&apos;</span><br><span class="line">     encryption: &apos;plain&apos; # &quot;start_tls&quot; or &quot;simple_tls&quot; or &quot;plain&quot;</span><br><span class="line">     verify_certificates: true</span><br><span class="line">     active_directory: true</span><br><span class="line">     #é‚®ç®± ç”¨æˆ·åå‡å¯ç™»å½•</span><br><span class="line">     allow_username_or_email_login: true</span><br><span class="line">     lowercase_usernames: false</span><br><span class="line">     #ä¸å…è®¸ç”¨æˆ·æ³¨å†Œ</span><br><span class="line">     block_auto_created_users: false</span><br><span class="line">     base: &apos;ou=ç ”å‘éƒ¨,cn=admin,dc=gzlplink,dc=com&apos;</span><br><span class="line">     user_filter: &apos;&apos;</span><br><span class="line">     attributes:</span><br><span class="line">       username: [&apos;cn&apos;]</span><br><span class="line">       email:    [&apos;mail&apos;]</span><br><span class="line">       name:     &apos;description&apos;</span><br><span class="line">       first_name: &apos;givenName&apos;</span><br><span class="line">       last_name:  &apos;sn&apos;</span><br><span class="line">EOS</span><br></pre></td></tr></table></figure><ul><li><code>host</code> å’Œ <code>port</code> æ˜¯ LDAP æœåŠ¡çš„ä¸»æœºåœ°å€åŠç«¯å£</li><li><code>bind_dn</code> å’Œ <code>password</code> æ˜¯ä¸€ä¸ªç®¡ç† LDAP çš„ dn åŠå¯†ç </li><li><code>base</code> è¡¨ç¤º LDAP å°†ä»¥è¯¥ dn ä¸º èŠ‚ç‚¹ï¼Œå‘ä¸‹æŸ¥æ‰¾ç”¨æˆ·</li><li><code>user_filter</code> è¡¨ç¤ºä»¥æŸç§è¿‡æ»¤æ¡ä»¶ç­›é€‰ç”¨æˆ·ï¼Œæ¯”å¦‚å‡è®¾æˆ‘ä»¬åªå¸Œæœ›æ‰€å±ç»„ä¸º Developers çš„ç”¨æˆ·æ¥è®¿é—® GitLabï¼Œåˆ™å¯ä»¥åœ¨è¿™é‡Œè®¾ç½® <code>(memberOf=cn=Developers,cn=Groups,dc=xinhua,dc=org)</code></li><li><code>attributes</code> è¡¨ç¤º GitLab ä¸­çš„å­—æ®µä¸ LDAP ä¸­å“ªäº›å­—æ®µå¯ä»¥ç›¸äº’å¯¹åº”ï¼Œæ¯”å¦‚å¯ä»¥ç”¨ LDAP ä¸­çš„ <code>uid</code> æ¥ä½œä¸º GitLab ç”¨æˆ·å</li></ul><p>é…ç½®ä¿®æ”¹å®Œæˆä¹‹åï¼Œè¿è¡Œä¸‹é¢å‘½ä»¤é‡å¯ GitLab æœåŠ¡ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure><img src="\image\20180726164123668.png"><p><strong>å¼€å¯ HTTPS</strong></p><p>GitLab é»˜è®¤æ²¡æœ‰å¼€å¯ HTTPSï¼Œå¦‚æœéœ€è¦å¼€å¯çš„è¯ï¼Œéœ€è¦æŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤æ‰§è¡Œï¼š</p><p>é¦–å…ˆï¼Œåœ¨é…ç½®æ–‡ä»¶ <code>/etc/gitlab/gitlab.rb</code> ä¸­å°†ä¸‹é¢ä¸€è¡Œä¸­çš„åè®®ç”± HTTP æ”¹æˆ HTTPSï¼Œå¹¶è®¾ç½®ä» HTTP åˆ° HTTPS çš„é‡å®šå‘ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">external_url &quot;https://gitlab.example.com&quot;</span><br><span class="line"></span><br><span class="line"># Redirect HTTP requests to HTTPS</span><br><span class="line">nginx[&apos;redirect_http_to_https&apos;] = true</span><br></pre></td></tr></table></figure><p>ç„¶ååˆ›å»ºä¸€ä¸ª SSL ç›®å½•ï¼Œå¹¶å°†ç½‘ç«™è¯ä¹¦å¯¼å…¥è¿›å»ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># mkdir -p /etc/gitlab/ssl</span><br><span class="line"># chmod 700 /etc/gitlab/ssl</span><br><span class="line"># cp gitlab.xinhua.io.key gitlab.xinhua.io.crt /etc/gitlab/ssl/</span><br></pre></td></tr></table></figure><p>æ³¨æ„ä¸Šé¢çš„è¯ä¹¦å¿…é¡»ä»¥é…ç½®ä¸­çš„åŸŸåï¼ˆå¦‚æœ¬æ–‡ä¸­çš„ <code>gitlab.xinhua.io</code>ï¼‰ä¸ºå…¶æ–‡ä»¶åã€‚</p><p>æœ€åå†æ‰§è¡Œ <code>gitlab-ctl reconfigure</code> å‘½ä»¤ï¼Œå³å¯é€šè¿‡ HTTPS æ–¹å¼è®¿é—® GitLab äº†</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;GitLab-CI-CD&quot;&gt;&lt;a href=&quot;#GitLab-CI-CD&quot; class=&quot;headerlink&quot; title=&quot;GitLab CI/CD&quot;&gt;&lt;/a&gt;GitLab CI/CD&lt;/h3&gt;&lt;h4 id=&quot;ä½¿ç”¨dockerä¸‹è½½gitlabé•œåƒ&quot;&gt;&lt;a hr</summary>
      
    
    
    
    
    <category term="GitLab" scheme="https://nmk0718.github.io/tag/GitLab/"/>
    
  </entry>
  
  <entry>
    <title>æ•°æ®åº“å¤‡ä»½ä¸æ¢å¤</title>
    <link href="https://nmk0718.github.io/2021/03/27/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/"/>
    <id>https://nmk0718.github.io/2021/03/27/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/</id>
    <published>2021-03-27T07:20:00.000Z</published>
    <updated>2024-11-29T06:42:44.615Z</updated>
    
    <content type="html"><![CDATA[<h4 id="å¤‡ä»½Mysql"><a href="#å¤‡ä»½Mysql" class="headerlink" title="å¤‡ä»½Mysql"></a>å¤‡ä»½Mysql</h4><p>åˆ›å»ºå¤‡ä»½æ–‡ä»¶å¤¹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir -p /data/mysqlbackup/</span><br></pre></td></tr></table></figure><p>åˆ›å»ºå¤‡ä»½çš„è„šæœ¬</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@prod-ghospital mysqlbackup]# cat backup.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line">mysqldump -upraise -pAf9Ed1Bb827b.4@9eB=&#123;9c4f --all-databases &gt;/data/mysqlbackup/praise-`date &quot;+%y-%m-%d&quot;`.sql</span><br><span class="line">mysqldump -umessage -p4666dd3a@79.d24=9cD&#123;b382 --all-databases &gt;/data/mysqlbackup/message-`date &quot;+%y-%m-%d&quot;`.sql</span><br><span class="line">mysqldump -uvideo -pDd0&#123;A9e2026c=94d13b@.62f --all-databases &gt;/data/mysqlbackup/video-`date &quot;+%y-%m-%d&quot;`.sql</span><br><span class="line">mysqldump --single-transaction -unethospital -p97@9EbeA7.=1Fb04&#123;e87998d --all-databases &gt;/data/mysqlbackup/nethospital-`date &quot;+%y-%m-%d&quot;`.sql</span><br><span class="line">mysqldump -uhospunion -p76984a&#125;74aE964e69b4Ce31,.ff&#123;2f02 --all-databases &gt;/data/mysqlbackup/hospunion-`date &quot;+%y-%m-%d&quot;`.sql</span><br><span class="line">find /data/mysqlbackup -type f -name &quot;*.sql&quot; -mtime +7 -exec rm -rf &#123;&#125; \;</span><br></pre></td></tr></table></figure><p>åŠ å…¥å®šæ—¶ä»»åŠ¡</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@prod-ghospital mysqlbackup]# crontab -l</span><br><span class="line">*/10 1 * * * /bin/sh /data/mysqlbackup/backup.sh</span><br></pre></td></tr></table></figure><p>å¤‡ä»½å…¬ä¼—å·æ•°æ®åº“</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysqldump -ucdh -pCDH360lj#com2019 -h139.159.192.185 --all-databases &gt;/home/mysql.sql</span><br></pre></td></tr></table></figure><h4 id="å¤‡ä»½Postgresql"><a href="#å¤‡ä»½Postgresql" class="headerlink" title="å¤‡ä»½Postgresql"></a>å¤‡ä»½Postgresql</h4><p>æ›´æ”¹ä¸ºpostgresç”¨æˆ·</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">su postgres</span><br></pre></td></tr></table></figure><p>åˆ›å»ºå¤‡ä»½æ–‡ä»¶å¤¹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bash-4.2$ cd /var/lib/pgsql/</span><br><span class="line">bash-4.2$ mkdir -p postgres/backups</span><br></pre></td></tr></table></figure><p>åˆ›å»ºå¤‡ä»½è„šæœ¬</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bash-4.2$ cat backup.sh </span><br><span class="line">pg_dumpall &gt; ~/postgres/backups/pgbackup-`date &quot;+%Y-%m-%d&quot;`.bak</span><br><span class="line">find ~/postgres/backups/ -type f -name &quot;*.bak&quot; -mtime +7 -exec rm -rf &#123;&#125; \;</span><br></pre></td></tr></table></figure><p>åŠ å…¥å®šæ—¶ä»»åŠ¡</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bash-4.2$ crontab -l</span><br><span class="line">*/10 1 * * * /bin/sh ~/postgres/backups/backup.sh</span><br></pre></td></tr></table></figure><h4 id="å¤‡ä»½sqlserver"><a href="#å¤‡ä»½sqlserver" class="headerlink" title="å¤‡ä»½sqlserver"></a>å¤‡ä»½sqlserver</h4><p><strong>linuxå¤‡ä»½</strong></p><p>å®‰è£…sqlcmd</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl https://packages.microsoft.com/config/rhel/8/prod.repo &gt; /etc/yum.repos.d/msprod.repo</span><br><span class="line">sudo yum install mssql-tools unixODBC-devel</span><br><span class="line">echo &apos;export PATH=&quot;$PATH:/opt/mssql-tools/bin&quot;&apos; &gt;&gt; ~/.bash_profile</span><br><span class="line">echo &apos;export PATH=&quot;$PATH:/opt/mssql-tools/bin&quot;&apos; &gt;&gt; ~/.bashrc</span><br><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure><p>å¤‡ä»½</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#åˆ›å»ºæ•°æ®åº“å¤‡ä»½æ–‡ä»¶å¤¹ </span><br><span class="line">mkdir -p /data/sqlserverbackup</span><br><span class="line">#ç»™mussqlæˆäºˆ/data/sqlserverbackupæ–‡ä»¶å¤¹çš„æƒé™ </span><br><span class="line">chown -R mssql:mssql /data/sqlserverbackup </span><br><span class="line">#ç™»å½•æ•°æ®åº“ </span><br><span class="line">sqlcmd -S 127.0.0.1 -U sa</span><br><span class="line">#å¤‡ä»½æ•°æ®åº“åˆ°æŒ‡å®šè·¯å¾„</span><br><span class="line">1&gt; backup database appauth to disk=&apos;/data/sqlserverbackup/appauth.bak&apos; </span><br><span class="line">2&gt; go</span><br></pre></td></tr></table></figure><p><strong>windowså¤‡ä»½</strong></p><p>windowsä»»åŠ¡è®¡åˆ’å®šæ—¶å¤‡ä»½sqlserveræ•°æ®åº“</p><p>åœ¨Eç›˜ä¸‹æ–°å»ºæ–‡ä»¶å¤¹DBbackupï¼Œåœ¨DBbackupä¸‹åˆ›å»ºä¸€ä¸ªsqlçš„å¤‡ä»½è„šæœ¬ï¼Œæ–‡ä»¶å‘½åä¸ºdbback.sql</p><p>sqlè„šæœ¬å¦‚ä¸‹:(DBnameå°±æ˜¯ä½ æ‰€éœ€è¦å¤‡ä»½çš„æ•°æ®åº“å)</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GO</span><br><span class="line"></span><br><span class="line">DECLARE</span><br><span class="line"></span><br><span class="line">@backuptime varchar(20)</span><br><span class="line"></span><br><span class="line">DECLARE</span><br><span class="line"></span><br><span class="line">@filename varchar(100)</span><br><span class="line"></span><br><span class="line">select @backuptime=(convert(varchar(8),getdate(),112)+replace(convert(varchar(5),getdate(),114),&apos;:&apos;,&apos; &apos;))</span><br><span class="line"></span><br><span class="line">select @filename=&apos;E:\DBbackup\db_&apos;+@backuptime+&apos;.bak&apos;</span><br><span class="line"></span><br><span class="line">backup database DBname to disk=@filename</span><br></pre></td></tr></table></figure><p>å†™ä¸€ä¸ªæ‰¹å¤„ç†æ–‡ä»¶æ‰§è¡Œsqlè¯­å¥ï¼š</p><p>ä¾‹å¦‚ï¼šbackup_database.bat</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.batæ–‡ä»¶å†…å®¹ä¸ºï¼šsqlcmd -S . -i E:\DBbackup\dbback.sql</span><br></pre></td></tr></table></figure><p>.batæ–‡ä»¶å†…çš„è¯­å¥å¯ä»¥åœ¨cmdæ§åˆ¶å°æ‰§è¡Œæµ‹è¯•æ˜¯å¦æ­£ç¡®ï¼›</p><p>å¯ä»¥ä½¿ç”¨winraråŠ å…¥ç¯å¢ƒå˜é‡è¿›è¡Œå‹ç¼©</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">set date_str=%date:~,4%%date:~5,2%%date:~8,2%</span><br><span class="line">set time_hh=%time:~0,2%</span><br><span class="line">if /i %time_hh% LSS 10 (set time_hh=0%time:~1,1%)</span><br><span class="line">set data_time_str=%date:~,4%%date:~5,2%%date:~8,2%_%time_hh%%time:~3,2%%time:~6,2%</span><br><span class="line">rar a db_%data_time_str%.rar -m5 -s -r *.bak</span><br></pre></td></tr></table></figure><p>åœ¨windows-æ§åˆ¶é¢æ¿-ç®¡ç†å·¥å…·ä¸‹ï¼Œæ‰“å¼€ä»»åŠ¡è®¡åˆ’ï¼Œåˆ›å»ºåŸºæœ¬ä»»åŠ¡ï¼Œè¾“å…¥ä»»åŠ¡åç§°æè¿°ã€è®¾ç½®å¤‡ä»½æ—¶é—´ã€é€‰æ‹©å¯åŠ¨ç¨‹åºã€‚éœ€è¦æ³¨æ„çš„æ˜¯åœ¨èµ·å§‹äºé€‰é¡¹é‡Œè¾“å…¥ç¨‹åºæ‰§è¡Œè·¯å¾„ï¼Œå®Œæˆã€‚</p><img src="\image\bat.png" alt="bat" style="zoom: 50%;"><p>åˆ é™¤å¤§äº7å¤©çš„å¤‡ä»½</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">delete.bat</span><br><span class="line"></span><br><span class="line">@echo off&amp;setlocal enabledelayedexpansion</span><br><span class="line">pushd E:\DBbackup</span><br><span class="line">set n=0</span><br><span class="line">for /f &quot;delims=&quot; %%a in (&apos;dir /a-d-h /b /o-d shop_lepeng*.rar&apos;) do (</span><br><span class="line">if !n! geq 7  del &quot;%%~a&quot;</span><br><span class="line">set /a n+=1 </span><br><span class="line">)</span><br><span class="line">popd</span><br></pre></td></tr></table></figure><h4 id="å¤‡ä»½mongodb"><a href="#å¤‡ä»½mongodb" class="headerlink" title="å¤‡ä»½mongodb"></a>å¤‡ä»½mongodb</h4><p>å¤‡ä»½å‘½ä»¤æ ¼å¼</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mongodump -h IP --port ç«¯å£ -u ç”¨æˆ·å -p å¯†ç  -d æ•°æ®åº“ -o æ–‡ä»¶</span><br></pre></td></tr></table></figure><p>æ— å¯†ç å¤‡ä»½</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@database data]# mongodump -h 192.168.50.51 -d B2BMall -o /data/mongodbbackup/mongodbbackup-`date &quot;+%Y-%m-%d&quot;`</span><br><span class="line">2020-12-23T15:01:09.747+0800    writing B2BMall.VLoginToken to </span><br><span class="line">2020-12-23T15:01:09.747+0800    writing B2BMall.SmallProgramUserAccount to </span><br><span class="line">2020-12-23T15:01:09.748+0800    writing B2BMall.VLoginAccount to </span><br><span class="line">2020-12-23T15:01:09.759+0800    done dumping B2BMall.VLoginToken (3324 documents)</span><br><span class="line">2020-12-23T15:01:09.759+0800    done dumping B2BMall.SmallProgramUserAccount (18 documents)</span><br><span class="line">2020-12-23T15:01:09.761+0800    done dumping B2BMall.VLoginAccount (0 documents)</span><br><span class="line">[root@database mongodbbackup]# ll mongodbbackup-2020-12-23/B2BMall/</span><br><span class="line">SmallProgramUserAccount.bson           VLoginAccount.bson                     VLoginToken.bson                       </span><br><span class="line">SmallProgramUserAccount.metadata.json  VLoginAccount.metadata.json            VLoginToken.metadata.json</span><br></pre></td></tr></table></figure><h4 id="æ¢å¤Mysql"><a href="#æ¢å¤Mysql" class="headerlink" title="æ¢å¤Mysql"></a>æ¢å¤Mysql</h4><p>å®‰è£…mysql</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https://repo.mysql.com/mysql80-community-release-el7-3.noarch.rpm</span><br><span class="line">rpm -ivh mysql80-community-release-el7-3.noarch.rpm</span><br><span class="line">yum-config-manager --disable mysql80-community</span><br><span class="line">yum-config-manager --enable mysql57-community</span><br><span class="line">#å¦‚ä¸èƒ½ä½¿ç”¨ä½¿ç”¨yum-config-managerè¯·ä½¿ç”¨yum -y install yum-utils</span><br><span class="line">yum install mysql-community-server</span><br><span class="line">yum -y install mysql-devel</span><br></pre></td></tr></table></figure><p>å¯åŠ¨mysql</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@dev-database ~]# systemctl start mysqld</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ä¸´æ—¶å¯†ç </p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@dev-database ~]# grep &quot;temporary password&quot; /var/log/mysqld.log</span><br><span class="line">2020-10-27T08:30:11.011852Z 1 [Note] A temporary password is generated for root@localhost: iEOu+Tz47m-)</span><br></pre></td></tr></table></figure><p>ç™»å½•mysql</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@dev-database ~]# mysql -u root -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 5</span><br><span class="line">Server version: 5.7.32</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; ALTER USER USER() IDENTIFIED BY &apos;Liangjian@360&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; grant all privileges on *.* to &apos;root&apos;@&apos;%&apos; identified by &apos;Liangjian@360&apos;;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure><p>åˆ›å»ºç”¨æˆ·</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE USER &apos;hospitalTest&apos;@&apos;%&apos; IDENTIFIED BY &apos;Liangjian123360@8899&apos;;</span><br></pre></td></tr></table></figure><p>æˆæƒ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GRANT ALL ON *.* TO &apos;hospitalTest&apos;@&apos;%&apos;;</span><br></pre></td></tr></table></figure><p>æ¢å¤æ•°æ®åº“</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql -uhospitalTest -pLiangjian123360@8899</span><br><span class="line">CREATE DATABASE hospunion;</span><br><span class="line">use hospunion;</span><br><span class="line">source /home/hospunion-20-10-27.sql</span><br></pre></td></tr></table></figure><h5 id="æ¢å¤å•ä¸ªåº“"><a href="#æ¢å¤å•ä¸ªåº“" class="headerlink" title="æ¢å¤å•ä¸ªåº“"></a>æ¢å¤å•ä¸ªåº“</h5><p>æ–¹æ³•ä¸€:</p><p>ä»å…¨å¤‡ä¸­ç›´æ¥å¯¼å…¥å•ä¸ªåº“ </p><p>æ ¼å¼ï¼šmysql -uç”¨æˆ· -på¯†ç  å•ä¸ªæ•°æ®åº“å  â€“one-database &lt; å…¨å¤‡çš„sqlæ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql -uroot -p&apos;nmk@0718&apos;  test  -o  &lt; databases-2022-07-08.sql</span><br></pre></td></tr></table></figure><p>æ–¹æ³•äºŒ:</p><p>ä»å…¨å¤‡ä¸­ç›´æ¥å¯¼å‡ºåº“æ•°æ®åˆ°æ–°çš„sqlæ–‡ä»¶</p><p>æ ¼å¼ï¼šsed -n â€˜/^â€“ Current Database: <code>è¡¨å</code>/,/^â€“ Current Database: `/pâ€™  å…¨å¤‡sqlæ–‡ä»¶ &gt; æ–°sqlæ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sed -n &apos;/^-- Current Database: `test`/,/^-- Current Database: `/p&apos; databases-2022-07-08.sql &gt; test.sql</span><br></pre></td></tr></table></figure><p>å°†æå–å‡ºçš„æ–°çš„sqlæ•°æ®å¯¼å…¥æ•°æ®åº“</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql -uroot -p&apos;nmk@0718&apos;  &lt; test.sql</span><br></pre></td></tr></table></figure><h5 id="æ¢å¤å•ä¸ªè¡¨"><a href="#æ¢å¤å•ä¸ªè¡¨" class="headerlink" title="æ¢å¤å•ä¸ªè¡¨"></a>æ¢å¤å•ä¸ªè¡¨</h5><p>æ–¹æ³•ä¸€:</p><p>ä»å…¨å¤‡ä»½ä¸­å¯¼å‡ºè¯¥è¡¨çš„å»ºè¡¨è¯­å¥åˆ°æ–°çš„sqlæ–‡ä»¶ä¸­</p><p>æ ¼å¼ï¼šsed -eâ€™/./{H;$!d;}â€™ -e â€˜x;/CREATE TABLE <code>è¡¨å</code>/!d;qâ€™  å…¨å¤‡sqlæ–‡ä»¶ &gt; æ–°sqlæ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sed -e&apos;/./&#123;H;$!d;&#125;&apos; -e &apos;x;/CREATE TABLE `test`/!d;q&apos; databases-2022-07-08.sql &gt; test.sql</span><br></pre></td></tr></table></figure><p>ä»å…¨å¤‡ä»½ä¸­å¯¼å‡ºè¯¥è¡¨çš„insert intoè¯­å¥è¿½åŠ åˆ°ä¸Šä¸€ä¸ªsqlæ–‡ä»¶ä¸­</p><p>æ ¼å¼ï¼šgrep -i â€˜INSERT INTO <code>è¡¨å</code>â€˜  å…¨å¤‡sqlæ–‡ä»¶ &gt;&gt; å«å»ºè¡¨è¯­å¥çš„sqlæ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">grep -i &apos;INSERT INTO `test`&apos; databases-2022-07-08.sql &gt;&gt; test.sql</span><br></pre></td></tr></table></figure><p>å¯¼å…¥åˆ°å¯¹åº”çš„åº“ä¸­</p><p>æ ¼å¼ï¼š<br>use å¯¹åº”çš„åº“åï¼›<br>source å¯¼å‡ºçš„sqlæ–‡ä»¶ï¼›</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">use test;</span><br><span class="line">source /root/test.sql;</span><br></pre></td></tr></table></figure><p>mysqlé—®é¢˜</p><p><strong>ERROR 1805 (HY000): Column count of mysql.user is wrong. Expected 45, found 43. The table is probabl</strong></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; create user &apos;turn123&apos;@&apos;localhost&apos; identified by &apos;abc123&apos;; </span><br><span class="line">ERROR 1805 (HY000): Column count of mysql.user is wrong. Expected 45, found 43. The table is probably corrupted</span><br></pre></td></tr></table></figure><p>è§£å†³</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/usr/bin/mysql_upgrade -uroot -p -S /var/lib/mysql/mysql.sock</span><br><span class="line">ä¸èƒ½æœ¬åœ°ç™»å½•ä½¿ç”¨/usr/bin/mysql_upgrade -S /var/lib/mysql/mysql.sock</span><br></pre></td></tr></table></figure><h4 id="æ¢å¤Postgresql"><a href="#æ¢å¤Postgresql" class="headerlink" title="æ¢å¤Postgresql"></a>æ¢å¤Postgresql</h4><p>å®‰è£…postgresql</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm</span><br><span class="line">yum install -y postgresql12-server</span><br><span class="line">/usr/pgsql-12/bin/postgresql-12-setup initdb</span><br><span class="line">systemctl enable postgresql-12</span><br><span class="line">systemctl start postgresql-12</span><br></pre></td></tr></table></figure><p>åˆ‡æ¢è‡³postgresç”¨æˆ·</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">su postgres</span><br></pre></td></tr></table></figure><p>è¿æ¥æ•°æ®åº“</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">psql</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å¯†ç </p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">postgres=# ALTER ROLE postgres WITH PASSWORD &apos;Liangjian@360&apos;;</span><br><span class="line">ALTER ROLE</span><br></pre></td></tr></table></figure><p>å°†è®¤è¯æ–¹å¼ä¿®æ”¹ä¸ºå¯†ç è®¤è¯ï¼Œæ‰“å¼€</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/var/lib/pgsql/12/data/pg_hba.conf</span><br><span class="line"></span><br><span class="line">æ›´æ”¹ä¸ºä»¥ä¸‹é…ç½®</span><br><span class="line"># TYPE  DATABASE        USER            ADDRESS                 METHOD</span><br><span class="line"></span><br><span class="line"># &quot;local&quot; is for Unix domain socket connections only</span><br><span class="line">local   all             all                                     peer</span><br><span class="line"># IPv4 local connections:</span><br><span class="line">host    all             all             127.0.0.1/32            ident</span><br><span class="line"># IPv6 local connections:</span><br><span class="line">host    all             all             ::1/128                 ident</span><br><span class="line"># Allow replication connections from localhost, by a user with the</span><br><span class="line"># replication privilege.</span><br><span class="line">#local   replication     all                                     peer</span><br><span class="line">#host    replication     all             127.0.0.1/32            ident</span><br><span class="line">#host    replication     all             ::1/128                 ident</span><br><span class="line">host    all             all             0.0.0.0/0              md5</span><br></pre></td></tr></table></figure><p>å¼€æ”¾è¿œç¨‹è¿æ¥</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/var/lib/pgsql/12/data/postgresql.conf </span><br><span class="line"></span><br><span class="line">åŠ å…¥ä»¥ä¸‹é…ç½®</span><br><span class="line">listen_addresses = &apos;*&apos;</span><br></pre></td></tr></table></figure><p>é‡è½½é…ç½®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">postgres=# SELECT pg_reload_conf();</span><br><span class="line"> pg_reload_conf </span><br><span class="line">----------------</span><br><span class="line"> t</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><p>è¿æ¥æ•°æ®åº“</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">psql -U postgres -W</span><br></pre></td></tr></table></figure><p>åˆ›å»ºæ•°æ®åº“</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">createdb dbname</span><br></pre></td></tr></table></figure><p>åˆ é™¤æ•°æ®åº“</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dropdb dbname</span><br></pre></td></tr></table></figure><p>æ¢å¤æ•°æ®åº“</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">psql -U postgres -f pgbackup-2020-10-27.bak</span><br></pre></td></tr></table></figure><p>æ•°æ®åº“æ¢å¤å®Œ,postgresè¿œç¨‹è¿æ¥å¯†ç ä¼šé»˜è®¤å˜ä¸ºç”Ÿäº§æ•°æ®åº“å¯†ç ,éœ€è¦æ‰‹åŠ¨è¿›è¡Œä¿®æ”¹æ‰å¯è¿œç¨‹è¿æ¥,æœ¬åœ°è¿æ¥å¯†ç ä¸å˜</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">alter user postgres with password &apos;Liangjian@360&apos;;</span><br></pre></td></tr></table></figure><h4 id="æ¢å¤sqlserver"><a href="#æ¢å¤sqlserver" class="headerlink" title="æ¢å¤sqlserver"></a>æ¢å¤sqlserver</h4><p>ä¸‹è½½sql serverçš„æºï¼Œä¾¿äºé€šè¿‡yumå‘½ä»¤æ¥å®‰è£…</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@dev-database home]# curl https://packages.microsoft.com/config/rhel/7/mssql-server-2017.repo &gt; /etc/yum.repos.d/mssql-server.repo</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100   232  100   232    0     0    153      0  0:00:01  0:00:01 --:--:--   153</span><br><span class="line">[root@dev-database home]# cat /etc/yum.repos.d/mssql-server.repo</span><br><span class="line">[packages-microsoft-com-mssql-server-2017]</span><br><span class="line">name=packages-microsoft-com-mssql-server-2017</span><br><span class="line">baseurl=https://packages.microsoft.com/rhel/7/mssql-server-2017/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://packages.microsoft.com/keys/microsoft.asc</span><br></pre></td></tr></table></figure><p>å®‰è£…</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install -y mssql-server</span><br></pre></td></tr></table></figure><p>é…ç½®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@dev-database home]# /opt/mssql/bin/mssql-conf setup</span><br><span class="line">Choose an edition of SQL Server:</span><br><span class="line">  1) Evaluation (free, no production use rights, 180-day limit)</span><br><span class="line">  2) Developer (free, no production use rights)</span><br><span class="line">  3) Express (free)</span><br><span class="line">  4) Web (PAID)</span><br><span class="line">  5) Standard (PAID)</span><br><span class="line">  6) Enterprise (PAID)</span><br><span class="line">  7) Enterprise Core (PAID)</span><br><span class="line">  8) I bought a license through a retail sales channel and have a product key to enter.</span><br><span class="line"></span><br><span class="line">Details about editions can be found at</span><br><span class="line">https://go.microsoft.com/fwlink/?LinkId=852748&amp;clcid=0x409</span><br><span class="line"></span><br><span class="line">Use of PAID editions of this software requires separate licensing through a</span><br><span class="line">Microsoft Volume Licensing program.</span><br><span class="line">By choosing a PAID edition, you are verifying that you have the appropriate</span><br><span class="line">number of licenses in place to install and run this software.</span><br><span class="line"></span><br><span class="line">Enter your edition(1-8): 2</span><br><span class="line">The license terms for this product can be found in</span><br><span class="line">/usr/share/doc/mssql-server or downloaded from:</span><br><span class="line">https://go.microsoft.com/fwlink/?LinkId=855862&amp;clcid=0x409</span><br><span class="line"></span><br><span class="line">The privacy statement can be viewed at:</span><br><span class="line">https://go.microsoft.com/fwlink/?LinkId=853010&amp;clcid=0x409</span><br><span class="line"></span><br><span class="line">Do you accept the license terms? [Yes/No]:</span><br><span class="line">yes</span><br><span class="line"></span><br><span class="line">Enter the SQL Server system administrator password: </span><br><span class="line">Confirm the SQL Server system administrator password: </span><br><span class="line">Configuring SQL Server...</span><br><span class="line"></span><br><span class="line">ForceFlush is enabled for this instance. </span><br><span class="line">ForceFlush feature is enabled for log durability.</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/mssql-server.service to /usr/lib/systemd/system/mssql-server.service.</span><br><span class="line">Setup has completed successfully. SQL Server is now starting.</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹çŠ¶æ€</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@dev-database home]# systemctl status mssql-server</span><br><span class="line">â— mssql-server.service - Microsoft SQL Server Database Engine</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/mssql-server.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Sun 2021-01-31 16:30:10 CST; 28s ago</span><br><span class="line">     Docs: https://docs.microsoft.com/en-us/sql/linux</span><br><span class="line"> Main PID: 34727 (sqlservr)</span><br><span class="line">   CGroup: /system.slice/mssql-server.service</span><br><span class="line">           â”œâ”€34727 /opt/mssql/bin/sqlservr</span><br><span class="line">           â””â”€34747 /opt/mssql/bin/sqlservr</span><br><span class="line"></span><br><span class="line">Jan 31 16:30:15 dev-database sqlservr[34727]: 2021-01-31 16:30:15.47 spid19s     SQL Server is now ready for client connections. This is an informational message; no user action is required.</span><br><span class="line">Jan 31 16:30:15 dev-database sqlservr[34727]: 2021-01-31 16:30:15.48 spid8s      0 transactions rolled back in database &apos;msdb&apos; (4:0). This is an informational message only. No user action is required.</span><br><span class="line">Jan 31 16:30:15 dev-database sqlservr[34727]: 2021-01-31 16:30:15.51 spid11s     Polybase feature disabled.</span><br><span class="line">Jan 31 16:30:15 dev-database sqlservr[34727]: 2021-01-31 16:30:15.51 spid11s     Clearing tempdb database.</span><br><span class="line">Jan 31 16:30:15 dev-database sqlservr[34727]: 2021-01-31 16:30:15.87 spid11s     Starting up database &apos;tempdb&apos;.</span><br><span class="line">Jan 31 16:30:16 dev-database sqlservr[34727]: 2021-01-31 16:30:16.06 spid11s     The tempdb database has 1 data file(s).</span><br><span class="line">Jan 31 16:30:16 dev-database sqlservr[34727]: 2021-01-31 16:30:16.08 spid22s     The Service Broker endpoint is in disabled or stopped state.</span><br><span class="line">Jan 31 16:30:16 dev-database sqlservr[34727]: 2021-01-31 16:30:16.09 spid22s     The Database Mirroring endpoint is in disabled or stopped state.</span><br><span class="line">Jan 31 16:30:16 dev-database sqlservr[34727]: 2021-01-31 16:30:16.11 spid22s     Service Broker manager has started.</span><br><span class="line">Jan 31 16:30:16 dev-database sqlservr[34727]: 2021-01-31 16:30:16.11 spid8s      Recovery is complete. This is an informational message only. No user action is required.</span><br></pre></td></tr></table></figure><p>å¼€æœºå¯åŠ¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo systemctl enable mssql-server</span><br></pre></td></tr></table></figure><p>è¿æ¥sqlserver</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install -y mssql-tools unixODBC-devel</span><br><span class="line"></span><br><span class="line">echo &quot;export PATH=$PATH:/opt/mssql-tools/bin&quot; &gt;&gt; /etc/profile</span><br><span class="line"></span><br><span class="line">[root@dev-database home]# sqlcmd -S localhost -U sa</span><br><span class="line">Password: </span><br><span class="line">1&gt; select db_name();</span><br><span class="line">2&gt; go</span><br><span class="line">                                                                                                                                </span><br><span class="line">--------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">master                                                                                                                          </span><br><span class="line"></span><br><span class="line">(1 rows affected)</span><br><span class="line">1&gt;</span><br></pre></td></tr></table></figure><p>è¿˜åŸæ•°æ®åº“<br><img src="\image\image-20210131165156539.png"><br><img src="\image\image-20210131165233729.png"><br><img src="\image\image-20210131165242088.png"></p><h4 id="æ¢å¤mongdb"><a href="#æ¢å¤mongdb" class="headerlink" title="æ¢å¤mongdb"></a>æ¢å¤mongdb</h4><p><strong>é…ç½®ç³»ç»Ÿyumæº</strong></p><ul><li><p>åˆ›å»º.repoæ–‡ä»¶ï¼Œç”Ÿæˆmongodbçš„æº</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi /etc/yum.repos.d/mongodb-org-4.0.repo</span><br></pre></td></tr></table></figure></li><li><p>æ·»åŠ ä»¥ä¸‹é…ç½®ä¿¡æ¯ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[mongodb-org-4.0]</span><br><span class="line">name=MongoDB Repository</span><br><span class="line">baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/4.0/x86_64/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://www.mongodb.org/static/pgp/server-4.0.asc</span><br></pre></td></tr></table></figure></li><li><p>å®‰è£…MongoDB</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install -y mongodb-org</span><br></pre></td></tr></table></figure></li><li><p>å¯åŠ¨MongoDB</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl start mongod.service</span><br></pre></td></tr></table></figure></li><li><p>MongoDBé»˜è®¤ç«¯å£æ˜¯27017ï¼ŒæŸ¥çœ‹æ˜¯å¦å¼€å¯</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">netstat -natp | grep 27017</span><br></pre></td></tr></table></figure></li><li><p>éªŒè¯æœåŠ¡å¼€å¯</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mongo</span><br></pre></td></tr></table></figure></li><li><p>è¿œç¨‹è¿æ¥Mongodb</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi /etc/mongod.conf</span><br><span class="line"></span><br><span class="line"># network interfaces</span><br><span class="line">net:</span><br><span class="line">  port: 27017</span><br><span class="line">  bindIp: 0.0.0.0  # Enter 0.0.0.0,:: to bind to all IPv4 and IPv6 addresses or, alternatively, use the net.bindIpAll setting.</span><br><span class="line">#ä¿®æ”¹ç»‘å®šipé»˜è®¤127.0.0.1åªå…è®¸æœ¬åœ°è¿æ¥ï¼Œ æ‰€ä»¥ä¿®æ”¹ä¸ºbindIp:0.0.0.0</span><br></pre></td></tr></table></figure></li><li><p>é‡å¯mongodbæœåŠ¡</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">service mongod restart</span><br></pre></td></tr></table></figure></li></ul><h4 id="PostgreSQL-æ…¢æŸ¥è¯¢SQLè¯­å¥è·Ÿè¸ª"><a href="#PostgreSQL-æ…¢æŸ¥è¯¢SQLè¯­å¥è·Ÿè¸ª" class="headerlink" title="PostgreSQL æ…¢æŸ¥è¯¢SQLè¯­å¥è·Ÿè¸ª"></a>PostgreSQL æ…¢æŸ¥è¯¢SQLè¯­å¥è·Ÿè¸ª</h4><p>å¼€å¯æ—¥å¿—è·Ÿè¸ª</p><p>è¿›å…¥postgresqlçš„å®‰è£…ç›®å½•ä¸‹ä¿®æ”¹é…ç½®æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /var/lib/pgsql/12/data</span><br><span class="line">vi postgresql.conf </span><br><span class="line"></span><br><span class="line">logging_collector = on</span><br><span class="line">log_destination = &apos;stderr&apos;</span><br><span class="line">log_directory = &apos;log&apos;</span><br><span class="line">log_filename = &apos;postgresql-%Y-%m-%d_%H%M%S.log&apos;</span><br></pre></td></tr></table></figure><p>é»˜è®¤çš„è·Ÿè¸ªæ—¥å¿—è®°å½•åœ¨ data/log ä¸­,ä¾‹å¦‚:/var/lib/pgsql/12/data/log</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">log_rotation_age = 1440    #minute,å¤šé•¿æ—¶é—´åˆ›å»ºæ–°çš„æ–‡ä»¶è®°å½•æ—¥å¿—ã€‚0 è¡¨ç¤ºç¦æ‰©å±•ã€‚</span><br><span class="line">log_rotation_size = 10240    #kb,æ–‡ä»¶å¤šå¤§ååˆ›å»ºæ–°çš„æ–‡ä»¶è®°å½•æ—¥å¿—ã€‚0 è¡¨ç¤ºç¦æ‰©å±•ã€‚</span><br><span class="line">log_truncate_on_rotation = on #å¯é‡ç”¨åŒåæ—¥å¿—æ–‡ä»¶</span><br></pre></td></tr></table></figure><p>éœ€è¦è·Ÿè¸ªSQLè¯­å¥æˆ–è€…æ…¢è¯­å¥ï¼Œå¾—éœ€è¦è®¾ç½®ä»¥ä¸‹å‚æ•°ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">log_statement = all    #éœ€è®¾ç½®è·Ÿè¸ªæ‰€æœ‰è¯­å¥ï¼Œå¦åˆ™åªèƒ½è·Ÿè¸ªå‡ºé”™ä¿¡æ¯</span><br><span class="line">log_min_duration_statement = 5000    #å•ä½ä¸ºæ¯«ç§’,è®°å½•æ‰§è¡Œ5ç§’åŠä»¥ä¸Šçš„SQLè¯­å¥ã€‚</span><br></pre></td></tr></table></figure><p>postgresql.confå‚æ•° é…ç½®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">log_directory</span><br><span class="line">é»˜è®¤ï¼š log_directory = &apos;log&apos;</span><br><span class="line">å†³å®šå­˜æ”¾æ•°æ®åº“è¿è¡Œæ—¥å¿—æ–‡ä»¶çš„ç›®å½•ã€‚å¯ä»¥æ˜¯ç»å¯¹è·¯å¾„ï¼Œä¹Ÿå¯æ˜¯ç›¸å¯¹è·¯å¾„(ç›¸å¯¹äºæ•°æ®åº“æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„)</span><br><span class="line"></span><br><span class="line">log_filename:</span><br><span class="line">é»˜è®¤ï¼š log_filename = &apos;postgresql-%a.log&apos;</span><br><span class="line">æ•°æ®åº“è¿è¡Œæ—¥å¿—æ–‡ä»¶çš„åç§°ã€‚</span><br><span class="line">%Yã€%mã€%dã€%Hã€%Må’Œ%Sï¼Œåˆ†åˆ«è¡¨ç¤ºå¹´ã€æœˆã€æ—¥ã€å°æ—¶ã€åˆ†å’Œç§’ã€‚</span><br><span class="line">æ²¡æœ‰æŒ‡å®šæ—¶é—´ä¿¡æ¯ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åœ¨log_filenameå€¼çš„æœ«å°¾åŠ ä¸Šæ–‡ä»¶åˆ›å»ºæ—¶é—´æˆ³ä½œä¸ºæ–‡ä»¶å</span><br><span class="line"></span><br><span class="line">log_truncate_on_rotation</span><br><span class="line">é»˜è®¤ï¼š log_truncate_on_rotation = on</span><br><span class="line">ç³»ç»Ÿåœ¨åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“è¿è¡Œæ—¥å¿—æ–‡ä»¶æ—¶ï¼Œå¦‚æœå‘ç°å­˜åœ¨ä¸€ä¸ªåŒåçš„æ–‡ä»¶ï¼Œå½“log_truncate_on_rotationçš„å€¼æ˜¯onæ—¶ï¼Œç³»ç»Ÿè¦†ç›–è¿™ä¸ªåŒåæ–‡ä»¶ã€‚</span><br><span class="line">å½“log_truncate_on_rotationçš„å€¼æ˜¯offæ—¶ï¼Œç³»ç»Ÿå°†é‡ç”¨è¿™ä¸ªåŒåæ–‡ä»¶ï¼Œåœ¨å®ƒçš„æœ«å°¾æ·»åŠ æ–°çš„æ—¥å¿—ä¿¡æ¯ã€‚</span><br><span class="line">è¦æ³¨æ„çš„æ˜¯ï¼Œåªæœ‰åœ¨log_rotation_ageéé›¶æ—¶ï¼Œç³»ç»Ÿæ‰åˆ›å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶çš„æƒ…å†µä¸‹ï¼Œæ‰ä¼šè¦†ç›–åŒåçš„æ—¥å¿—æ–‡ä»¶ã€‚</span><br><span class="line"></span><br><span class="line">log_rotation_age</span><br><span class="line">é»˜è®¤ï¼š log_rotation_age = 1d ï¼Œå•ä½æ˜¯åˆ†é’Ÿã€‚</span><br><span class="line">æ—¥å¿—è½®è¯¢æ—¶é—´</span><br><span class="line">ä¸º0ä¸æ˜¯ç¦ç”¨è¯¥åŠŸèƒ½ã€‚</span><br><span class="line"></span><br><span class="line">log_rotation_size</span><br><span class="line">é»˜è®¤ï¼š log_rotation_size = 0 ï¼Œ å•ä½æ˜¯KBã€‚</span><br><span class="line">æ—¥å¿—è½®è¯¢å¤§å°ï¼Œå½“æ–‡ä»¶å¤§å°è¶…è¿‡è¯¥å€¼æ—¶è¿›è¡Œåˆ‡æ¢ã€‚</span><br><span class="line">å¦‚æœä¸€ä¸ªæ—¥å¿—æ–‡ä»¶å†™å…¥çš„æ•°æ®é‡è¶…è¿‡log_rotation_sizeçš„å€¼ï¼Œæ•°æ®åº“å°†åˆ›å»ºä¸€ä¸ªæ–°çš„æ—¥å¿—æ–‡ä»¶ã€‚</span><br><span class="line">ä¸º0è¡¨ç¤ºç¦ç”¨è¯¥åŠŸèƒ½ã€‚</span><br><span class="line"></span><br><span class="line">logfilemode</span><br><span class="line">é»˜è®¤ï¼š log_file_mode = 0600                   </span><br><span class="line">åˆ›å»ºæ—¥å¿—æ–‡ä»¶çš„æƒé™</span><br><span class="line"></span><br><span class="line">log_min_duration_statement</span><br><span class="line">é»˜è®¤ï¼š log_min_duration_statement = -1</span><br><span class="line">åªlogæ‰§è¡Œæ—¶é—´å¤§äºè®¾å®šå€¼çš„è¯­å¥ï¼Œç±»ä¼¼ä¸æ…¢æŸ¥è¯¢</span><br><span class="line">0è¡¨ç¤ºlogæ‰€æœ‰è¯­å¥ï¼›-1è¡¨ç¤ºä¸logä»»ä½•è¯­å¥ã€‚</span><br><span class="line"></span><br><span class="line">log_duration</span><br><span class="line">é»˜è®¤ï¼š log_duration = off</span><br><span class="line">æ§åˆ¶æ˜¯å¦è®°å½•æ¯ä¸ªå®Œæˆçš„SQLè¯­å¥çš„æ‰§è¡Œæ—¶é—´ã€‚</span><br><span class="line">å¯¹äºä½¿ç”¨æ‰©å±•åè®®ä¸æ•°æ®åº“é€šä¿¡çš„å®¢æˆ·ç«¯ï¼Œä¼šè®°è½½Parseã€Bindå’ŒExecuteçš„æ‰§è¡Œæ—¶é—´ã€‚</span><br><span class="line"></span><br><span class="line">log_statement</span><br><span class="line">é»˜è®¤ï¼š log_statement = &apos;none&apos;                </span><br><span class="line">æœ‰æ•ˆçš„å–å€¼æ˜¯noneã€ddlã€modå’Œall</span><br><span class="line">æ§åˆ¶è®°å½•å“ªç§SQLè¯­å¥çš„æ‰§è¡Œä¿¡æ¯ã€‚</span><br><span class="line">ddlåŒ…æ‹¬æ‰€æœ‰æ•°æ®å®šä¹‰è¯­å¥ï¼Œå¦‚CREATEã€ALTERå’ŒDROPè¯­å¥ã€‚</span><br><span class="line">modåŒ…æ‹¬æ‰€æœ‰ddlè¯­å¥å’Œæ›´æ–°æ•°æ®çš„è¯­å¥ï¼Œä¾‹å¦‚INSERTã€UPDATEã€DELETEã€TRUNCATEã€ COPY FROMã€PREPAREå’Œ EXECUTEã€‚</span><br><span class="line">AllåŒ…æ‹¬æ‰€æœ‰çš„è¯­å¥ã€‚</span><br></pre></td></tr></table></figure><p>å½“ log_statement=all å’Œ log_min_duration_statement åŒæ—¶è®¾ç½®æ—¶ï¼Œå°†è·Ÿè¸ªæ‰€æœ‰è¯­å¥ï¼Œå¿½ç•¥log_min_duration_statement è®¾ç½®ã€‚æ‰€ä»¥éœ€æŒ‰æƒ…å†µè®¾ç½®å…¶ä¸­ä¸€ä¸ªæˆ–ä¸¤ä¸ªå€¼ã€‚</p><p>åŠ è½½é…ç½®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select pg_reload_conf();</span><br><span class="line">show log_min_duration_statement;</span><br></pre></td></tr></table></figure><p>é’ˆå¯¹æŸä¸ªç”¨æˆ·æˆ–è€…æŸæ•°æ®åº“è¿›è¡Œè®¾ç½®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">alter database test set log_min_duration_statement=5000;</span><br></pre></td></tr></table></figure><p>æ•è·æ­£åœ¨æŸ¥è¯¢çš„æ…¢SQL</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from pg_stat_activity where state&lt;&gt;&apos;idle&apos; and now()-query_start &gt; interval &apos;5 s&apos; order by query_start ;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æœ€å¤§è¿æ¥æ•°</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">show max_connections;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è¿æ¥æ•°</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select count(1) from pg_stat_activity;</span><br></pre></td></tr></table></figure><p>å‚è€ƒé“¾æ¥:<a href="https://www.cnblogs.com/VicLiu/p/12017704.html" target="_blank" rel="noopener">https://www.cnblogs.com/VicLiu/p/12017704.html</a><br>                <a href="https://blog.csdn.net/liyingke112/article/details/84913510" target="_blank" rel="noopener">https://blog.csdn.net/liyingke112/article/details/84913510</a></p><h4 id="pgsqlæ–­å¼€æ•°æ®åº“è¿æ¥"><a href="#pgsqlæ–­å¼€æ•°æ®åº“è¿æ¥" class="headerlink" title="pgsqlæ–­å¼€æ•°æ®åº“è¿æ¥"></a>pgsqlæ–­å¼€æ•°æ®åº“è¿æ¥</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from pg_stat_activity</span><br><span class="line"></span><br><span class="line">SELECT </span><br><span class="line">    pg_terminate_backend(pid) </span><br><span class="line">FROM </span><br><span class="line">    pg_stat_activity </span><br><span class="line">WHERE </span><br><span class="line">    -- don&apos;t kill my own connection!</span><br><span class="line">    pid &lt;&gt; pg_backend_pid()</span><br><span class="line">    -- don&apos;t kill the connections to other databases</span><br><span class="line">    AND datname = &apos;databasename&apos;</span><br></pre></td></tr></table></figure><p>pgsqlåˆ›å»ºæ’åºè§„åˆ™å’Œå­—ç¬¦åˆ†ç±»ä¸ºzh_CN.UTF-8çš„æ•°æ®åº“</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE DATABASE ymall TEMPLATE template0 ENCODING UTF8 LC_COLLATE &apos;zh_CN.UTF-8&apos; LC_CTYPE &apos;zh_CN.UTF-8&apos;;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;å¤‡ä»½Mysql&quot;&gt;&lt;a href=&quot;#å¤‡ä»½Mysql&quot; class=&quot;headerlink&quot; title=&quot;å¤‡ä»½Mysql&quot;&gt;&lt;/a&gt;å¤‡ä»½Mysql&lt;/h4&gt;&lt;p&gt;åˆ›å»ºå¤‡ä»½æ–‡ä»¶å¤¹&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table</summary>
      
    
    
    
    
    <category term="database" scheme="https://nmk0718.github.io/tag/database/"/>
    
  </entry>
  
  <entry>
    <title>Prometheus</title>
    <link href="https://nmk0718.github.io/2021/03/27/Prometheus/"/>
    <id>https://nmk0718.github.io/2021/03/27/Prometheus/</id>
    <published>2021-03-27T07:16:00.000Z</published>
    <updated>2024-11-29T06:44:00.884Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯Prometheus"><a href="#ä»€ä¹ˆæ˜¯Prometheus" class="headerlink" title="ä»€ä¹ˆæ˜¯Prometheus?"></a>ä»€ä¹ˆæ˜¯Prometheus?</h2><p>Prometheusæ˜¯ç”±SoundCloudå¼€å‘çš„å¼€æºç›‘æ§æŠ¥è­¦ç³»ç»Ÿå’Œæ—¶åºåˆ—æ•°æ®åº“(TSDB)ã€‚Prometheusä½¿ç”¨Goè¯­è¨€å¼€å‘ï¼Œæ˜¯Google BorgMonç›‘æ§ç³»ç»Ÿçš„å¼€æºç‰ˆæœ¬ã€‚<br>2016å¹´ç”±Googleå‘èµ·LinuxåŸºé‡‘ä¼šæ——ä¸‹çš„åŸç”Ÿäº‘åŸºé‡‘ä¼š(Cloud Native Computing Foundation), å°†Prometheusçº³å…¥å…¶ä¸‹ç¬¬äºŒå¤§å¼€æºé¡¹ç›®ã€‚<br>Prometheusç›®å‰åœ¨å¼€æºç¤¾åŒºç›¸å½“æ´»è·ƒã€‚<br>Prometheuså’ŒHeapster(Heapsteræ˜¯K8Sçš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œç”¨äºè·å–é›†ç¾¤çš„æ€§èƒ½æ•°æ®ã€‚)ç›¸æ¯”åŠŸèƒ½æ›´å®Œå–„ã€æ›´å…¨é¢ã€‚Prometheusæ€§èƒ½ä¹Ÿè¶³å¤Ÿæ”¯æ’‘ä¸Šä¸‡å°è§„æ¨¡çš„é›†ç¾¤ã€‚</p><h2 id="Prometheusçš„ç‰¹ç‚¹"><a href="#Prometheusçš„ç‰¹ç‚¹" class="headerlink" title="Prometheusçš„ç‰¹ç‚¹"></a>Prometheusçš„ç‰¹ç‚¹</h2><ul><li>å¤šç»´åº¦æ•°æ®æ¨¡å‹ã€‚</li><li>çµæ´»çš„æŸ¥è¯¢è¯­è¨€ã€‚</li><li>ä¸ä¾èµ–åˆ†å¸ƒå¼å­˜å‚¨ï¼Œå•ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹æ˜¯è‡ªä¸»çš„ã€‚</li><li>é€šè¿‡åŸºäºHTTPçš„pullæ–¹å¼é‡‡é›†æ—¶åºæ•°æ®ã€‚</li><li>å¯ä»¥é€šè¿‡ä¸­é—´ç½‘å…³è¿›è¡Œæ—¶åºåˆ—æ•°æ®æ¨é€ã€‚</li><li>é€šè¿‡æœåŠ¡å‘ç°æˆ–è€…é™æ€é…ç½®æ¥å‘ç°ç›®æ ‡æœåŠ¡å¯¹è±¡ã€‚</li><li>æ”¯æŒå¤šç§å¤šæ ·çš„å›¾è¡¨å’Œç•Œé¢å±•ç¤ºï¼Œæ¯”å¦‚Grafanaç­‰ã€‚</li></ul><p>å®˜ç½‘åœ°å€ï¼š<a href="https://prometheus.io/" target="_blank" rel="noopener">https://prometheus.io/</a></p><h2 id="æ¶æ„å›¾"><a href="#æ¶æ„å›¾" class="headerlink" title="æ¶æ„å›¾"></a>æ¶æ„å›¾</h2><img src="\image\662544-20190308115806797-1750460125.png"><img src="\image\662544-20190308115354474-1478270204.png"><h2 id="åŸºæœ¬åŸç†"><a href="#åŸºæœ¬åŸç†" class="headerlink" title="åŸºæœ¬åŸç†"></a>åŸºæœ¬åŸç†</h2><p>Prometheusçš„åŸºæœ¬åŸç†æ˜¯é€šè¿‡HTTPåè®®å‘¨æœŸæ€§æŠ“å–è¢«ç›‘æ§ç»„ä»¶çš„çŠ¶æ€ï¼Œä»»æ„ç»„ä»¶åªè¦æä¾›å¯¹åº”çš„HTTPæ¥å£å°±å¯ä»¥æ¥å…¥ç›‘æ§ã€‚ä¸éœ€è¦ä»»ä½•SDKæˆ–è€…å…¶ä»–çš„é›†æˆè¿‡ç¨‹ã€‚è¿™æ ·åšéå¸¸é€‚åˆåšè™šæ‹ŸåŒ–ç¯å¢ƒç›‘æ§ç³»ç»Ÿï¼Œæ¯”å¦‚VMã€Dockerã€Kubernetesç­‰ã€‚è¾“å‡ºè¢«ç›‘æ§ç»„ä»¶ä¿¡æ¯çš„HTTPæ¥å£è¢«å«åšexporter ã€‚ç›®å‰äº’è”ç½‘å…¬å¸å¸¸ç”¨çš„ç»„ä»¶å¤§éƒ¨åˆ†éƒ½æœ‰exporterå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œæ¯”å¦‚Varnishã€Haproxyã€Nginxã€MySQLã€Linuxç³»ç»Ÿä¿¡æ¯(åŒ…æ‹¬ç£ç›˜ã€å†…å­˜ã€CPUã€ç½‘ç»œç­‰ç­‰)ã€‚</p><h2 id="æœåŠ¡è¿‡ç¨‹"><a href="#æœåŠ¡è¿‡ç¨‹" class="headerlink" title="æœåŠ¡è¿‡ç¨‹"></a>æœåŠ¡è¿‡ç¨‹</h2><ul><li>Prometheus Daemonè´Ÿè´£å®šæ—¶å»ç›®æ ‡ä¸ŠæŠ“å–metrics(æŒ‡æ ‡)æ•°æ®ï¼Œæ¯ä¸ªæŠ“å–ç›®æ ‡éœ€è¦æš´éœ²ä¸€ä¸ªhttpæœåŠ¡çš„æ¥å£ç»™å®ƒå®šæ—¶æŠ“å–ã€‚Prometheusæ”¯æŒé€šè¿‡é…ç½®æ–‡ä»¶ã€æ–‡æœ¬æ–‡ä»¶ã€Zookeeperã€Consulã€DNS SRV Lookupç­‰æ–¹å¼æŒ‡å®šæŠ“å–ç›®æ ‡ã€‚Prometheusé‡‡ç”¨PULLçš„æ–¹å¼è¿›è¡Œç›‘æ§ï¼Œå³æœåŠ¡å™¨å¯ä»¥ç›´æ¥é€šè¿‡ç›®æ ‡PULLæ•°æ®æˆ–è€…é—´æ¥åœ°é€šè¿‡ä¸­é—´ç½‘å…³æ¥Pushæ•°æ®ã€‚</li><li>Prometheusåœ¨æœ¬åœ°å­˜å‚¨æŠ“å–çš„æ‰€æœ‰æ•°æ®ï¼Œå¹¶é€šè¿‡ä¸€å®šè§„åˆ™è¿›è¡Œæ¸…ç†å’Œæ•´ç†æ•°æ®ï¼Œå¹¶æŠŠå¾—åˆ°çš„ç»“æœå­˜å‚¨åˆ°æ–°çš„æ—¶é—´åºåˆ—ä¸­ã€‚</li><li>Prometheusé€šè¿‡PromQLå’Œå…¶ä»–APIå¯è§†åŒ–åœ°å±•ç¤ºæ”¶é›†çš„æ•°æ®ã€‚Prometheusæ”¯æŒå¾ˆå¤šæ–¹å¼çš„å›¾è¡¨å¯è§†åŒ–ï¼Œä¾‹å¦‚Grafanaã€è‡ªå¸¦çš„Promdashä»¥åŠè‡ªèº«æä¾›çš„æ¨¡ç‰ˆå¼•æ“ç­‰ç­‰ã€‚Prometheusè¿˜æä¾›HTTP APIçš„æŸ¥è¯¢æ–¹å¼ï¼Œè‡ªå®šä¹‰æ‰€éœ€è¦çš„è¾“å‡ºã€‚</li><li>PushGatewayæ”¯æŒClientä¸»åŠ¨æ¨é€metricsåˆ°PushGatewayï¼Œè€ŒPrometheusåªæ˜¯å®šæ—¶å»Gatewayä¸ŠæŠ“å–æ•°æ®ã€‚</li><li>Alertmanageræ˜¯ç‹¬ç«‹äºPrometheusçš„ä¸€ä¸ªç»„ä»¶ï¼Œå¯ä»¥æ”¯æŒPrometheusçš„æŸ¥è¯¢è¯­å¥ï¼Œæä¾›ååˆ†çµæ´»çš„æŠ¥è­¦æ–¹å¼ã€‚</li></ul><h2 id="ä¸‰å¤§å¥—ä»¶"><a href="#ä¸‰å¤§å¥—ä»¶" class="headerlink" title="ä¸‰å¤§å¥—ä»¶"></a>ä¸‰å¤§å¥—ä»¶</h2><ul><li>Server ä¸»è¦è´Ÿè´£æ•°æ®é‡‡é›†å’Œå­˜å‚¨ï¼Œæä¾›PromQLæŸ¥è¯¢è¯­è¨€çš„æ”¯æŒã€‚</li><li>Alertmanager è­¦å‘Šç®¡ç†å™¨ï¼Œç”¨æ¥è¿›è¡ŒæŠ¥è­¦ã€‚</li><li>Push Gateway æ”¯æŒä¸´æ—¶æ€§Jobä¸»åŠ¨æ¨é€æŒ‡æ ‡çš„ä¸­é—´ç½‘å…³ã€‚</li></ul><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><h5 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -LO https://github.com/prometheus/prometheus/releases/download/v2.23.0/prometheus-2.23.0.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure><p>è§£å‹å®‰è£…</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tar zxvf prometheus-2.23.0.linux-amd64.tar.gz</span><br><span class="line">mv prometheus-2.23.0.linux-amd64 /opt/</span><br><span class="line">vi /usr/lib/systemd/system/prometheus.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Prometheus Monitoring System</span><br><span class="line">Documentation=Prometheus Monitoring System</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/opt/prometheus-2.23.0.linux-amd64/prometheus \</span><br><span class="line">  --config.file=/opt/prometheus-2.23.0.linux-amd64/prometheus.yml \</span><br><span class="line">  --web.listen-address=:9090</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>å¯åŠ¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl start prometheus</span><br><span class="line">systemctl enable prometheus</span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶è¯¦è§£</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># my global config</span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line">  # scrape_timeout is set to the global default (10s).</span><br><span class="line"></span><br><span class="line"># Alertmanager configuration</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">      # - alertmanager:9093</span><br><span class="line"></span><br><span class="line"># Load rules once and periodically evaluate them according to the global &apos;evaluation_interval&apos;.</span><br><span class="line">rule_files:</span><br><span class="line">  # - &quot;first_rules.yml&quot;</span><br><span class="line">  # - &quot;second_rules.yml&quot;</span><br><span class="line"></span><br><span class="line"># A scrape configuration containing exactly one endpoint to scrape:</span><br><span class="line"># Here it&apos;s Prometheus itself.</span><br><span class="line">scrape_configs:</span><br><span class="line">  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span><br><span class="line">  - job_name: &apos;prometheus&apos;</span><br><span class="line">    # metrics_path defaults to &apos;/metrics&apos;</span><br><span class="line">    # scheme defaults to &apos;http&apos;.</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&apos;localhost:9090&apos;]</span><br></pre></td></tr></table></figure><ul><li>globalï¼š æ­¤ç‰‡æ®µæŒ‡å®šçš„æ˜¯prometheusçš„å…¨å±€é…ç½®ï¼Œ æ¯”å¦‚é‡‡é›†é—´éš”ï¼ŒæŠ“å–è¶…æ—¶æ—¶é—´ç­‰ã€‚</li><li>scrape_interval: æŠ“å–é—´éš”,é»˜è®¤ç»§æ‰¿globalå€¼ã€‚</li><li>scrape_timeout: æŠ“å–è¶…æ—¶æ—¶é—´,é»˜è®¤ç»§æ‰¿globalå€¼ã€‚</li><li>rule_filesï¼š æ­¤ç‰‡æ®µæŒ‡å®šæŠ¥è­¦è§„åˆ™æ–‡ä»¶ï¼Œ prometheusæ ¹æ®è¿™äº›è§„åˆ™ä¿¡æ¯ï¼Œä¼šæ¨é€æŠ¥è­¦ä¿¡æ¯åˆ°alertmanagerä¸­ã€‚</li><li>scrape_configs: æ­¤ç‰‡æ®µæŒ‡å®šæŠ“å–é…ç½®ï¼Œprometheusçš„æ•°æ®é‡‡é›†é€šè¿‡æ­¤ç‰‡æ®µé…ç½®ã€‚</li><li>alerting: æ­¤ç‰‡æ®µæŒ‡å®šæŠ¥è­¦é…ç½®ï¼Œ è¿™é‡Œä¸»è¦æ˜¯æŒ‡å®šprometheuså°†æŠ¥è­¦è§„åˆ™æ¨é€åˆ°æŒ‡å®šçš„alertmanagerå®ä¾‹åœ°å€ã€‚</li><li>metric_path: æŠ“å–è·¯å¾„ï¼Œ é»˜è®¤æ˜¯/metrics</li><li>scheme: æŒ‡å®šé‡‡é›†ä½¿ç”¨çš„åè®®ï¼Œhttpæˆ–è€…httpsã€‚</li><li>params: æŒ‡å®šurlå‚æ•°ã€‚</li><li>basic_auth: æŒ‡å®šè®¤è¯ä¿¡æ¯ã€‚</li><li>*_sd_configs: æŒ‡å®šæœåŠ¡å‘ç°é…ç½®</li><li>static_configs: é™æ€æŒ‡å®šæœåŠ¡jobã€‚</li><li>relabel_config: relabelè®¾ç½®ã€‚</li></ul><p>static_configç¤ºä¾‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &apos;prometheus&apos;</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&apos;localhost:9090&apos;]</span><br><span class="line">  - job_name: &quot;node&quot;</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&apos;192.168.50.57:9100&apos;,&apos;192.168.50.58:9100&apos;,&apos;192.168.50.59:9100&apos;]</span><br></pre></td></tr></table></figure><p>file_sd_configsç¤ºä¾‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scrape_configs:</span><br><span class="line">  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span><br><span class="line">  - job_name: &apos;prometheus&apos;</span><br><span class="line"></span><br><span class="line">    # metrics_path defaults to &apos;/metrics&apos;</span><br><span class="line">    # scheme defaults to &apos;http&apos;.</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&apos;localhost:9090&apos;]</span><br><span class="line">  - job_name: &quot;node&quot;</span><br><span class="line">    file_sd_configs:</span><br><span class="line">    - refresh_interval: 1m</span><br><span class="line">      files: </span><br><span class="line">      - &quot;/usr/local/prometheus/prometheus/conf/node*.yml&quot;</span><br><span class="line"></span><br><span class="line"># ç‹¬ç«‹æ–‡ä»¶é…ç½®å¦‚ä¸‹</span><br><span class="line">cat conf/node-dis.conf</span><br><span class="line">- targets: [&apos;192.168.50.57:9100&apos;,&apos;192.168.50.58:9100&apos;,&apos;192.168.50.59:9100&apos;]</span><br><span class="line">  æˆ–è€…å¯ä»¥è¿™æ ·é…ç½®</span><br><span class="line">[root@node00 conf]# cat node-dis.yml </span><br><span class="line">- targets: </span><br><span class="line">  - &quot;192.168.100.10:20001&quot;</span><br><span class="line">  labels: </span><br><span class="line">    hostname: node00</span><br><span class="line">- targets: </span><br><span class="line">  - &quot;192.168.100.11:20001&quot;</span><br><span class="line">  labels: </span><br><span class="line">    hostname: node01</span><br><span class="line">- targets: </span><br><span class="line">  - &quot;192.168.100.12:20001&quot;</span><br><span class="line">  labels: </span><br><span class="line">    hostname: node02</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>file_fd_files</code> é…ç½®åæˆ‘ä»¬å¯ä»¥åœ¨ä¸é‡å¯prometheusçš„å‰æä¸‹ï¼Œ ä¿®æ”¹å¯¹åº”çš„é‡‡é›†æ–‡ä»¶(node_dis.yml), åœ¨ç‰¹å®šçš„æ—¶é—´å†…(refresh_interval),prometheusä¼šå®Œæˆé…ç½®ä¿¡æ¯çš„è½½å…¥å·¥ä½œã€‚</p><p>relabel_configç¤ºä¾‹</p><p>æ–°æ ‡è®°æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„å·¥å…·ï¼Œå¯ä»¥åœ¨ç›®æ ‡çš„æ ‡ç­¾é›†è¢«æŠ“å–ä¹‹å‰é‡å†™å®ƒï¼Œæ¯ä¸ªé‡‡é›†é…ç½®å¯ä»¥é…ç½®å¤šä¸ªé‡å†™æ ‡ç­¾è®¾ç½®ï¼Œå¹¶æŒ‰ç…§é…ç½®çš„é¡ºåºæ¥åº”ç”¨äºæ¯ä¸ªç›®æ ‡çš„æ ‡ç­¾é›†ã€‚</p><p>ç›®æ ‡é‡æ–°æ ‡ç­¾ä¹‹åï¼Œä»¥__å¼€å¤´çš„æ ‡ç­¾å°†ä»æ ‡ç­¾é›†ä¸­åˆ é™¤çš„ã€‚</p><p><strong>relabelçš„actionç±»å‹</strong></p><ul><li>replace: å¯¹æ ‡ç­¾å’Œæ ‡ç­¾å€¼è¿›è¡Œæ›¿æ¢ã€‚</li><li>keep: æ»¡è¶³ç‰¹å®šæ¡ä»¶çš„å®ä¾‹è¿›è¡Œé‡‡é›†ï¼Œå…¶ä»–çš„ä¸é‡‡é›†ã€‚</li><li>dropï¼š æ»¡è¶³ç‰¹å®šæ¡ä»¶çš„å®ä¾‹ä¸é‡‡é›†ï¼Œå…¶ä»–çš„é‡‡é›†ã€‚</li><li>labeldropï¼š å¯¹æŠ“å–çš„å®ä¾‹ç‰¹å®šæ ‡ç­¾è¿›è¡Œåˆ é™¤ã€‚</li><li>labelkeepï¼š å¯¹æŠ“å–çš„å®ä¾‹ç‰¹å®šæ ‡ç­¾è¿›è¡Œä¿ç•™ï¼Œå…¶ä»–æ ‡ç­¾åˆ é™¤ã€‚</li></ul><h6 id="replace"><a href="#replace" class="headerlink" title="replace"></a>replace</h6><p>åŸé…ç½®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">global:</span><br><span class="line">  scrape_interval:     5s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 5s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line">  </span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">      - localhost:9093</span><br><span class="line">      </span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;/opt/prometheus-2.23.0.linux-amd64/rule.yml&quot;</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &apos;prometheus&apos;</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&apos;localhost:9090&apos;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  - job_name: &apos;node&apos;</span><br><span class="line">    file_sd_configs:</span><br><span class="line">    - refresh_interval: 1m</span><br><span class="line">      files: </span><br><span class="line">      - &quot;/opt/prometheus-2.23.0.linux-amd64/conf/node*.yml&quot;</span><br><span class="line">vi conf/node-dis.yml</span><br><span class="line">      - targets: [&apos;192.168.50.57:9100&apos;]</span><br><span class="line">        labels:</span><br><span class="line">          __hostname__: dev-database</span><br><span class="line">          __region_id__: &quot;cn-beijing&quot;</span><br><span class="line">          __availability_zone__: &quot;a&quot;</span><br><span class="line">      - targets: [&apos;localhost:9100&apos;]</span><br><span class="line">        labels:</span><br><span class="line">          __hostname__: prometheus</span><br><span class="line">          __region_id__: &quot;cn-beijing&quot;</span><br><span class="line">          __availability_zone__: &quot;b&quot;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æŸ¥çœ‹targetä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾ã€‚<br><img src="\image\image-20201203153031448.png"></p><p>è®¾ç½®relabel,å°†labelsä¸­çš„<code>__hostname__</code>æ›¿æ¢ä¸º<code>node_name</code>ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">global:</span><br><span class="line">  scrape_interval:     5s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 5s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line">  </span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">      - localhost:9093</span><br><span class="line">      </span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;/opt/prometheus-2.23.0.linux-amd64/rule.yml&quot;</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &apos;bounter-monitor&apos;</span><br><span class="line">    scrape_interval: 5s</span><br><span class="line">    metrics_path: &apos;/actuator/prometheus&apos;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&apos;192.168.10.228:8080&apos;]</span><br><span class="line">        labels:</span><br><span class="line">          __hostname__: springboot</span><br><span class="line">    relabel_configs:</span><br><span class="line">      - source_labels:</span><br><span class="line">        - &quot;__hostname__&quot;</span><br><span class="line">        regex: &quot;(.*)&quot;</span><br><span class="line">        target_label: &quot;nodename&quot;</span><br><span class="line">        action: replace</span><br><span class="line">        replacement: &quot;$1&quot;</span><br></pre></td></tr></table></figure><p>é‡å¯æœåŠ¡æŸ¥çœ‹targetä¿¡æ¯å¦‚ä¸‹å›¾ï¼š<br><img src="\image\image-20201203153255893.png"></p><p>source_labelsæŒ‡å®šæˆ‘ä»¬æˆ‘ä»¬éœ€è¦å¤„ç†çš„æºæ ‡ç­¾ï¼Œ target_labelsæŒ‡å®šäº†æˆ‘ä»¬è¦replaceåçš„æ ‡ç­¾åå­—ï¼Œ actionæŒ‡å®šrelabelåŠ¨ä½œï¼Œè¿™é‡Œä½¿ç”¨replaceæ›¿æ¢åŠ¨ä½œã€‚ regexå»åŒ¹é…æºæ ‡ç­¾ï¼ˆ<strong>hostname</strong>ï¼‰çš„å€¼ï¼Œâ€(.*)â€ä»£è¡¨<strong>hostname</strong>è¿™ä¸ªæ ‡ç­¾æ˜¯ä»€ä¹ˆå€¼éƒ½åŒ¹é…çš„ï¼Œç„¶åreplacementæŒ‡å®šçš„æ›¿æ¢åçš„æ ‡ç­¾ï¼ˆtarget_labelï¼‰å¯¹åº”çš„æ•°å€¼ã€‚é‡‡ç”¨æ­£åˆ™å¼•ç”¨æ–¹å¼è·å–çš„ã€‚</p><p>ä¿®æ”¹ â€˜â€™regex: â€œ(dev-database)â€â€˜çš„æ—¶å€™å¯ä»¥çœ‹åˆ°å¦‚ä¸‹å›¾ã€‚<br><img src="\image\image-20201203153524812.png"></p><p>æˆ‘ä»¬çš„åŸºç¡€ä¿¡æ¯é‡Œé¢æœ‰<code>__region_id__</code>å’Œ<code>__availability_zone__</code>ä½†æ˜¯æˆ‘æƒ³èåˆ2ä¸ªå­—æ®µåœ¨ä¸€èµ·ï¼Œå¯ä»¥é€šè¿‡replaceæ¥å®ç°ã€‚</p><p>ä¿®æ”¹é…ç½®å¦‚ä¸‹:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">global:</span><br><span class="line">  scrape_interval:     5s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 5s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line">  </span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">      - localhost:9093</span><br><span class="line">      </span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;/opt/prometheus-2.23.0.linux-amd64/rule.yml&quot;</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &apos;node&apos;</span><br><span class="line">    file_sd_configs:</span><br><span class="line">    - refresh_interval: 1m</span><br><span class="line">      files: </span><br><span class="line">      - &quot;/opt/prometheus-2.23.0.linux-amd64/conf/node*.yml&quot;</span><br><span class="line">    relabel_configs:</span><br><span class="line">    - source_labels:</span><br><span class="line">      - &quot;__region_id__&quot;</span><br><span class="line">      - &quot;__availability_zone__&quot;</span><br><span class="line">      separator: &quot;-&quot;</span><br><span class="line">      regex: &quot;(.*)&quot;</span><br><span class="line">      target_label: &quot;region_zone&quot;</span><br><span class="line">      action: replace</span><br><span class="line">      replacement: &quot;$1&quot;</span><br></pre></td></tr></table></figure><p>targetå¦‚ä¸‹å›¾ï¼š<br><img src="\image\image-20201203162711581.png"></p><h6 id="keep"><a href="#keep" class="headerlink" title="keep"></a>keep</h6><p>åŸé…ç½®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">global:</span><br><span class="line">  scrape_interval:     5s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 5s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line">  </span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">      - localhost:9093</span><br><span class="line">      </span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;/opt/prometheus-2.23.0.linux-amd64/rule.yml&quot;</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &apos;prometheus&apos;</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&apos;localhost:9090&apos;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  - job_name: &apos;node&apos;</span><br><span class="line">    file_sd_configs:</span><br><span class="line">    - refresh_interval: 1m</span><br><span class="line">      files: </span><br><span class="line">      - &quot;/opt/prometheus-2.23.0.linux-amd64/conf/node*.yml&quot;</span><br></pre></td></tr></table></figure><p>targetä¿¡æ¯å¦‚ä¸‹å›¾ï¼š<br><img src="\image\image-20201203154119227.png"></p><p>ä¿®æ”¹é…ç½®æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">global:</span><br><span class="line">  scrape_interval:     5s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 5s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line">  </span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">      - localhost:9093</span><br><span class="line">      </span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;/opt/prometheus-2.23.0.linux-amd64/rule.yml&quot;</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &apos;bounter-monitor&apos;</span><br><span class="line">    scrape_interval: 5s</span><br><span class="line">    metrics_path: &apos;/actuator/prometheus&apos;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&apos;192.168.10.228:8080&apos;]</span><br><span class="line">        labels:</span><br><span class="line">          __hostname__: springboot</span><br><span class="line">    relabel_configs:</span><br><span class="line">    - source_labels:</span><br><span class="line">      - &quot;__hostname__&quot;</span><br><span class="line">      regex: &quot;(dev-database)&quot;</span><br><span class="line">      action: keep</span><br></pre></td></tr></table></figure><p>targetå¦‚ä¸‹å›¾:<br><img src="\image\image-20201203154322990.png"></p><p>actionä¸ºkeep,åªè¦source_labelsçš„å€¼åŒ¹é…regex:ï¼ˆdev-databaseï¼‰çš„å®ä¾‹æ‰èƒ½ä¼šè¢«é‡‡é›†ã€‚ å…¶ä»–çš„å®ä¾‹ä¸ä¼šè¢«é‡‡é›†ã€‚</p><h6 id="drop"><a href="#drop" class="headerlink" title="drop"></a>drop</h6><p>æ›´æ”¹actionä¸ºdrop,targetå¦‚ä¸‹å›¾:<br><img src="\image\image-20201203154545940.png"></p><p>actionä¸ºdrop,åªè¦source_labelsçš„å€¼åŒ¹é…regexï¼ˆdev-databaseï¼‰çš„å®ä¾‹ä¸ä¼šè¢«é‡‡é›†ã€‚ å…¶ä»–çš„å®ä¾‹ä¼šè¢«é‡‡é›†ã€‚</p><h5 id="labelkeep"><a href="#labelkeep" class="headerlink" title="labelkeep"></a>labelkeep</h5><h5 id="NodeExporter"><a href="#NodeExporter" class="headerlink" title="NodeExporter"></a>NodeExporter</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -LO https://github.com/prometheus/node_exporter/releases/download/v1.0.1/node_exporter-1.0.1.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure><p>è§£å‹å®‰è£…</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tar zxvf node_exporter-1.0.1.linux-amd64.tar.gz</span><br><span class="line">mkdir -p /export/prometheus_exporter</span><br><span class="line">mv node_exporter-1.0.1.linux-amd64/ /export/prometheus_exporter/node_exporter</span><br><span class="line">vi  /usr/lib/systemd/system/node_exporter.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=node_exporter</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/export/prometheus_exporter/node_exporter/node_exporter</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>å¯åŠ¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl start node_exporter</span><br><span class="line">systemctl enable node_exporter</span><br></pre></td></tr></table></figure><h5 id="alertmanager"><a href="#alertmanager" class="headerlink" title="alertmanager"></a>alertmanager</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https://github.com/prometheus/alertmanager/releases/download/v0.21.0/alertmanager-0.21.0.linux-amd64.tar.gz</span><br><span class="line">mv alertmanager-0.15.2.linux-amd64/ alertmanager</span><br></pre></td></tr></table></figure><p> åˆ›å»ºå¯åŠ¨æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /usr/lib/systemd/system/alertmanager.service</span><br></pre></td></tr></table></figure><p>æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=alertmanager</span><br><span class="line">Documentation=https://github.com/prometheus/alertmanager</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/alertmanager/alertmanager --config.file=/usr/<span class="built_in">local</span>/alertmanager/alert-test.yml</span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>Alertmanager å®‰è£…ç›®å½•ä¸‹é»˜è®¤æœ‰ alertmanager.yml é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥åˆ›å»ºæ–°çš„é…ç½®æ–‡ä»¶ï¼Œåœ¨å¯åŠ¨æ—¶æŒ‡å®šå³å¯ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">global:</span><br><span class="line">  smtp_smarthost: <span class="string">'smtp.qq.com:465'</span></span><br><span class="line">  smtp_from: <span class="string">'2977358239@qq.com'</span></span><br><span class="line">  smtp_auth_username: <span class="string">'2977358239@qq.com'</span></span><br><span class="line">  smtp_auth_password: <span class="string">'jgigqzrlhycddhcf'</span> <span class="comment"># è¿™é‡Œæ˜¯é‚®ç®±çš„æˆæƒå¯†ç ï¼Œä¸æ˜¯ç™»å½•å¯†ç </span></span><br><span class="line">  smtp_require_tls: <span class="literal">false</span></span><br><span class="line">templates:</span><br><span class="line">  - <span class="string">'/alertmanager/template/*.tmpl'</span></span><br><span class="line">route:</span><br><span class="line">  group_by: [<span class="string">'alertname'</span>, <span class="string">'cluster'</span>, <span class="string">'service'</span>]</span><br><span class="line">  group_wait: 30s</span><br><span class="line">  group_interval: 5m</span><br><span class="line">  repeat_interval: 10m</span><br><span class="line">  receiver: default-receiver</span><br><span class="line">receivers:</span><br><span class="line">- name: <span class="string">'default-receiver'</span></span><br><span class="line">  email_configs:</span><br><span class="line">  - to: <span class="string">'nimingkun@dingtalk.com'</span></span><br><span class="line">    html: <span class="string">''</span></span><br><span class="line">    headers: &#123; Subject: <span class="string">"[WARN] æŠ¥è­¦é‚®ä»¶ test"</span> &#125;</span><br></pre></td></tr></table></figure><p>smtp_smarthostï¼šæ˜¯ç”¨äºå‘é€é‚®ä»¶çš„é‚®ç®±çš„ SMTP æœåŠ¡å™¨åœ°å€+ç«¯å£ï¼›</p><p>smtp_auth_passwordï¼šæ˜¯å‘é€é‚®ç®±çš„æˆæƒç è€Œä¸æ˜¯ç™»å½•å¯†ç ï¼›</p><p>smtp_require_tlsï¼šä¸è®¾ç½®çš„è¯é»˜è®¤ä¸º trueï¼Œå½“ä¸º true æ—¶ä¼šæœ‰ starttls é”™è¯¯ï¼Œä¸ºäº†ç®€å•è¿™é‡Œè®¾ç½®ä¸º falseï¼›</p><p>templatesï¼šæŒ‡å‡ºé‚®ä»¶çš„æ¨¡æ¿è·¯å¾„ï¼›</p><p>receivers ä¸‹ html æŒ‡å‡ºé‚®ä»¶å†…å®¹æ¨¡æ¿åï¼Œè¿™é‡Œæ¨¡æ¿åä¸º â€œalert.htmlâ€ï¼Œåœ¨æ¨¡æ¿è·¯å¾„ä¸­çš„æŸä¸ªæ–‡ä»¶ä¸­å®šä¹‰ã€‚</p><p>headersï¼šä¸ºé‚®ä»¶æ ‡é¢˜ï¼›</p><p>3ï¼Œé…ç½®å‘Šè­¦è§„åˆ™</p><p>é…ç½® rule.yml</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/prometheus</span><br><span class="line">vim rule.yml</span><br><span class="line">groups:</span><br><span class="line">- name: alert-rules.yml</span><br><span class="line">  rules:</span><br><span class="line">  - alert: dev-database <span class="comment"># alert åå­—</span></span><br><span class="line">    expr: up&#123;job=<span class="string">"dev-database"</span>&#125; == 0 <span class="comment"># åˆ¤æ–­æ¡ä»¶</span></span><br><span class="line">    <span class="keyword">for</span>: 10s <span class="comment"># æ¡ä»¶ä¿æŒ 10s æ‰ä¼šå‘å‡º alter</span></span><br><span class="line">    labels: <span class="comment"># è®¾ç½® alert çš„æ ‡ç­¾</span></span><br><span class="line">      severity: <span class="string">"critical"</span></span><br><span class="line">    annotations:  <span class="comment"># alert çš„å…¶ä»–æ ‡ç­¾ï¼Œä½†ä¸ç”¨äºæ ‡è¯† alert</span></span><br><span class="line">      description: æœåŠ¡å™¨  å·²å½“æœºè¶…è¿‡ 20s</span><br><span class="line">      summary: æœåŠ¡å™¨  è¿è¡ŒçŠ¶æ€</span><br></pre></td></tr></table></figure><p>åœ¨ prometheus.yml ä¸­æŒ‡å®š rule.yml çš„è·¯å¾„</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat prometheus.yml </span><br><span class="line"><span class="comment"># my global config</span></span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     15s <span class="comment"># Set the scrape interval to every 15 seconds. Default is every 1 minute.</span></span><br><span class="line">  evaluation_interval: 15s <span class="comment"># Evaluate rules every 15 seconds. The default is every 1 minute.</span></span><br><span class="line">  <span class="comment"># scrape_timeout is set to the global default (10s).</span></span><br><span class="line"><span class="comment"># Alertmanager configuration</span></span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">      - localhost:9093 <span class="comment"># è¿™é‡Œä¿®æ”¹ä¸º localhost</span></span><br><span class="line"><span class="comment"># Load rules once and periodically evaluate them according to the global 'evaluation_interval'.</span></span><br><span class="line">rule_files:</span><br><span class="line">  <span class="comment"># - "first_rules.yml"</span></span><br><span class="line">  <span class="comment"># - "second_rules.yml"</span></span><br><span class="line">  - <span class="string">"/usr/local/prometheus/rule.yml"</span></span><br><span class="line"><span class="comment"># A scrape configuration containing exactly one endpoint to scrape:</span></span><br><span class="line"><span class="comment"># Here it's Prometheus itself.</span></span><br><span class="line">scrape_configs:</span><br><span class="line">  <span class="comment"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span></span><br><span class="line">  - job_name: <span class="string">'prometheus'</span></span><br><span class="line">    <span class="comment"># metrics_path defaults to '/metrics'</span></span><br><span class="line">    <span class="comment"># scheme defaults to 'http'.</span></span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [<span class="string">'localhost:9090'</span>,<span class="string">'localhost:9100'</span>]</span><br><span class="line">  - job_name: <span class="string">'dev-database'</span></span><br><span class="line">    scrape_interval: 5s</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [<span class="string">'192.168.50.57:9100'</span>]</span><br></pre></td></tr></table></figure><p>é‡å¯ Prometheus æœåŠ¡ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl restart prometheus</span><br></pre></td></tr></table></figure><p>4ï¼Œç¼–å†™é‚®ä»¶æ¨¡æ¿</p><p>æ³¨æ„ï¼šæ–‡ä»¶åç¼€ä¸º tmpl</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir -pv /alertmanager/template/</span><br><span class="line">vim /alertmanager/template/alert.tmpl</span><br><span class="line">&lt;table&gt;</span><br><span class="line">    &lt;tr&gt;&lt;td&gt;æŠ¥è­¦å&lt;/td&gt;&lt;td&gt;å¼€å§‹æ—¶é—´&lt;/td&gt;&lt;/tr&gt;</span><br><span class="line">        &lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;</span><br><span class="line">&lt;/table&gt;</span><br></pre></td></tr></table></figure><p>5ï¼Œå¯åŠ¨ Alertmanager</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start alertmanager.service</span><br><span class="line">systemctl status alertmanager.service</span><br></pre></td></tr></table></figure><p>6ï¼ŒéªŒè¯æ•ˆæœã€‚</p><p>æ­¤æ—¶åˆ°ç®¡ç†ç•Œé¢å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š<br><img src="\image\image-20201203111947500.png"></p><p>ç„¶ååœæ­¢dev-databaseèŠ‚ç‚¹ä¸Šçš„ node_exporter æœåŠ¡ï¼Œç„¶åå†çœ‹æ•ˆæœã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl stop node_exporter.service</span><br></pre></td></tr></table></figure><p>æ¥ç€é‚®ç®±åº”è¯¥ä¼šæ”¶åˆ°é‚®ä»¶ï¼š<br><img src="\image\image-20201203112046979.png"></p><h5 id="ç›‘æ§Linux"><a href="#ç›‘æ§Linux" class="headerlink" title="ç›‘æ§Linux"></a>ç›‘æ§Linux</h5><p>åœ¨æœºå™¨ä¸Šå®‰è£…NodeExporter,ç„¶ååœ¨Prometheus.ymlé…ç½®ç›‘æ§åœ°å€</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi /usr/local/prometheus/prometheus.yml</span><br><span class="line"></span><br><span class="line">  - job_name: &apos;dev-database&apos;</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&apos;192.168.50.57:9100&apos;]</span><br></pre></td></tr></table></figure><p>åœ¨prometheusä¸­ï¼Œ å¯ä»¥æŠ“å–çš„ç«¯ç‚¹æˆä¸ºå®ä¾‹ï¼Œé€šå¸¸æƒ…å†µä¸‹å…·æœ‰ç›¸åŒç›®çš„çš„å®ä¾‹çš„é›†åˆæˆä¸ºjobã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi /usr/local/prometheus/prometheus.yml</span><br><span class="line"></span><br><span class="line">  - job_name: &apos;dev-database&apos;</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&apos;192.168.50.57:9100&apos;,&apos;192.168.50.58:9100&apos;,&apos;192.168.50.59:9100&apos;]</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<a href="https://grafana.com/grafana/dashboards/11074è¿›è¡Œç›‘æ§" target="_blank" rel="noopener">https://grafana.com/grafana/dashboards/11074è¿›è¡Œç›‘æ§</a><br><img src="\image\image-20201202162632723.png"></p><h5 id="Grafanaå¯¼å…¥æ¨¡æ¿ç›‘æ§"><a href="#Grafanaå¯¼å…¥æ¨¡æ¿ç›‘æ§" class="headerlink" title="Grafanaå¯¼å…¥æ¨¡æ¿ç›‘æ§"></a>Grafanaå¯¼å…¥æ¨¡æ¿ç›‘æ§</h5><img src="\image\image-20201205144611781.png"><p>ä¸Šä¼ jsonæ–‡ä»¶ï¼Œé€‰æ‹©Prometheus<br><img src="\image\image-20201205144810380.png"><br><img src="\image\image-20201205144706804.png"></p><h5 id="ç›‘æ§Mysql"><a href="#ç›‘æ§Mysql" class="headerlink" title="ç›‘æ§Mysql"></a>ç›‘æ§Mysql</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">##ä¸‹è½½mysql_exporter</span><br><span class="line">wget https://github.com/prometheus/mysqld_exporter/releases/download/v0.12.1/mysqld_exporter-0.12.1.linux-amd64.tar.gz</span><br><span class="line">tar zxvf mysqld_exporter-0.12.1.linux-amd64.tar.gz </span><br><span class="line">mv mysqld_exporter-0.12.1.linux-amd64 /usr/local/mysqld_exporter</span><br></pre></td></tr></table></figure><p>æˆæƒè¿æ¥</p><p>æƒ³è¦è·å–ç›‘æ§æ•°æ®ï¼Œéœ€è¦æˆæƒç¨‹åºèƒ½å¤Ÿè¿æ¥åˆ°MySQLã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GRANT REPLICATION CLIENT, PROCESS ON *.* TO <span class="string">'exporter'</span>@<span class="string">'localhost'</span> identified by <span class="string">'123456'</span>;</span><br><span class="line">GRANT SELECT ON performance_schema.* TO <span class="string">'exporter'</span>@<span class="string">'localhost'</span>;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼šè¿™é‡Œåªæˆæƒäº†æœ¬åœ°ç™»é™†ï¼Œè¯´æ˜è¿™ä¸ªæˆæƒé€‚ç”¨äºmysql_exporterç›‘æ§å·¥å…·éƒ¨ç½²åœ¨MySQL Serverä¸Šçš„æƒ…å†µï¼Œå¦‚æœæ˜¯éƒ¨ç½²åœ¨Prometheus Serverä¸Šï¼Œåˆ™éœ€è¦æˆæƒè¿œç¨‹ç™»é™†ã€‚</p><p>åˆ›å»ºé…ç½®ä¿¡æ¯æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /usr/local/mysqld_exporter</span><br><span class="line">vim .my.cnf</span><br><span class="line">[client]</span><br><span class="line">user=exporter</span><br><span class="line">password=123456</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨systemdå¯åŠ¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/mysqld_exporter.service</span><br><span class="line"> </span><br><span class="line">[Unit]</span><br><span class="line">Description=mysqld_exporter</span><br><span class="line">After=network.target</span><br><span class="line"> </span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/usr/local/mysqld_exporter/mysqld_exporter --config.my-cnf=/usr/local/mysqld_exporter/.my.cnf</span><br><span class="line">Restart=on-failure</span><br><span class="line"> </span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>åŠ è½½é…ç½®å¹¶å¯åŠ¨ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start mysqld_exporter</span><br><span class="line">systemctl status mysqld_exporter</span><br><span class="line">systemctl enable mysqld_exporter</span><br></pre></td></tr></table></figure><p>é…ç½®prometheus.ymlæ·»åŠ ç›‘æ§ç›®æ ‡</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi /usr/local/prometheus/prometheus.yml</span><br><span class="line">  - job_name: &apos;mysql&apos;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&apos;192.168.50.57:9104&apos;]</span><br><span class="line">        labels:</span><br><span class="line">          instance: db</span><br></pre></td></tr></table></figure><p>é‡å¯æœåŠ¡</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl restart prometheus</span><br></pre></td></tr></table></figure><p>ä¸‹è½½æ¨¡æ¿<a href="https://grafana.com/api/dashboards/9623/revisions/4/download" target="_blank" rel="noopener">https://grafana.com/api/dashboards/9623/revisions/4/download</a> å¯¼å…¥Grafana<br><img src="\image\image-20201202162041540.png"></p><h5 id="ç›‘æ§SpringBoot"><a href="#ç›‘æ§SpringBoot" class="headerlink" title="ç›‘æ§SpringBoot"></a>ç›‘æ§SpringBoot</h5><ol><li>æ·»åŠ å¦‚ä¸‹ä¾èµ–</li></ol><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!--ç›‘æ§ begin--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">   &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">   &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!--Micrometer--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">   &lt;groupId&gt;io.micrometer&lt;/groupId&gt;</span><br><span class="line">   &lt;artifactId&gt;micrometer-registry-prometheus&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!--ç›‘æ§ end--&gt;</span><br></pre></td></tr></table></figure><ol start="2"><li>é…ç½®ç›‘æ§</li></ol><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: bounter-monitor</span><br><span class="line"></span><br><span class="line">## æš´éœ²æ‰€æœ‰çš„actuator endpoints</span><br><span class="line">management:</span><br><span class="line">  endpoints:</span><br><span class="line">    web:</span><br><span class="line">      exposure:</span><br><span class="line">        include: &quot;*&quot;</span><br><span class="line">  metrics:</span><br><span class="line">    tags:</span><br><span class="line">      application: $&#123;spring.application.name&#125;</span><br></pre></td></tr></table></figure><p>3.æ‰“åŒ…å¹¶è¿è¡Œ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mvn clean install</span><br><span class="line">java -jar nmk0718.jar</span><br></pre></td></tr></table></figure><p>4.é…ç½®Prometheus.yml</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># SpringBoot Application</span><br><span class="line">- job_name: &apos;bounter-monitor&apos;</span><br><span class="line">  scrape_interval: 5s</span><br><span class="line">  metrics_path: &apos;/actuator/prometheus&apos;</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&apos;localhost:8080&apos;]</span><br></pre></td></tr></table></figure><p>é‡å¯Prometheuså°±å¯ä»¥åœ¨Grafanaçœ‹åˆ°ç›‘æ§æ•°æ®äº†</p><p>å¯ä½¿ç”¨<a href="https://grafana.com/grafana/dashboards/4701æˆ–https://grafana.com/grafana/dashboards/10280" target="_blank" rel="noopener">https://grafana.com/grafana/dashboards/4701æˆ–https://grafana.com/grafana/dashboards/10280</a> æ¨¡æ¿<br><img src="\image\image-20201202161337842.png"></p><h5 id="ç›‘æ§rabbitmq"><a href="#ç›‘æ§rabbitmq" class="headerlink" title="ç›‘æ§rabbitmq"></a>ç›‘æ§rabbitmq</h5><p>ä¸‹è½½</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">weget https://github.com/kbudde/rabbitmq_exporter/releases/download/v1.0.0-RC7/rabbitmq_exporter-1.0.0-RC7.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure><p>è§£å‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tar zxvf rabbitmq_exporter-1.0.0-RC7.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure><p>è¿è¡Œexporter</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">RABBIT_USER=liangjian RABBIT_PASSWORD=liangjian360 OUTPUT_FORMAT=JSON PUBLISH_PORT=9099 RABBIT_URL=http://192.168.50.51:5672 nohup ./rabbitmq_exporter &amp;</span><br></pre></td></tr></table></figure><p>éªŒè¯ï¼šæµè§ˆå™¨è®¿é—® <a href="http://192.168.50.51:9099/metrics" target="_blank" rel="noopener">http://192.168.50.51:9099/metrics</a> </p><img src="\image\image-20201205143617017.png"><p>é…ç½®ç›‘æ§</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi prometheus.yml</span><br><span class="line"></span><br><span class="line"> - job_name: &apos;rabbitmq&apos;</span><br><span class="line">    scrape_interval: 60s</span><br><span class="line">    scrape_timeout: 60s</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&apos;192.168.50.51:9099&apos;]</span><br></pre></td></tr></table></figure><p>é…ç½®å‘Šè­¦</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi rule.yml</span><br><span class="line">groups:</span><br><span class="line">- name: alert-rules.yml</span><br><span class="line">  rules:</span><br><span class="line">  - alert: &quot;rabbitmqå®ä¾‹å¤±è´¥&quot;</span><br><span class="line">    expr: up&#123;job=&quot;rabbitmq&quot;&#125; == 0</span><br><span class="line">    for: 5s</span><br><span class="line">    labels:</span><br><span class="line">      alertname: test_rabbitmq_monitor</span><br><span class="line">      severity: &quot;critical&quot;</span><br><span class="line">    annotations:</span><br><span class="line">      description: &quot;rabbitmq &#123;&#123; $labels.instance &#125;&#125; is error&quot;</span><br><span class="line">      summary: &quot;æµ‹è¯•rabbitmqç›‘æ§å®•æœº&quot;</span><br></pre></td></tr></table></figure><p>éªŒè¯<br><img src="\image\image-20201205144047846.png"></p><h5 id="ç›‘æ§redis"><a href="#ç›‘æ§redis" class="headerlink" title="ç›‘æ§redis"></a>ç›‘æ§redis</h5><p>ä¸‹è½½åœ°å€:<a href="https://github.com/oliver006/redis_exporter/releases" target="_blank" rel="noopener">https://github.com/oliver006/redis_exporter/releases</a></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@database opt]# tar zxvf redis_exporter-v1.13.1.linux-amd64.tar.gz </span><br><span class="line">redis_exporter-v1.13.1.linux-amd64/</span><br><span class="line">redis_exporter-v1.13.1.linux-amd64/README.md</span><br><span class="line">redis_exporter-v1.13.1.linux-amd64/redis_exporter</span><br><span class="line">redis_exporter-v1.13.1.linux-amd64/LICENSE</span><br><span class="line">[root@database opt]# cd redis_exporter-v1.13.1.linux-amd64/</span><br><span class="line">[root@database redis_exporter-v1.13.1.linux-amd64]# ls</span><br><span class="line">LICENSE  README.md  redis_exporter</span><br><span class="line">[root@database redis_exporter-v1.13.1.linux-amd64]# nohup ./redis_exporter -redis.addr 192.168.50.51:6379 -redis.password liangjian360 &amp;</span><br><span class="line">[1] 208232</span><br><span class="line">[root@database redis_exporter-v1.13.1.linux-amd64]# nohup: ignoring input and appending output to â€˜nohup.outâ€™</span><br><span class="line">^C</span><br><span class="line">[root@database redis_exporter-v1.13.1.linux-amd64]# netstat -lntp     </span><br><span class="line">tcp6       0      0 :::9121                 :::*                    LISTEN      208232/./redis_expo</span><br></pre></td></tr></table></figure><p>é…ç½®prometheus.yml</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@monitor prometheus-2.23.0.linux-amd64]# vi prometheus.yml</span><br><span class="line">  - job_name: &apos;redis&apos;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&apos;192.168.50.51:9121&apos;]</span><br><span class="line">      </span><br><span class="line">[root@monitor prometheus-2.23.0.linux-amd64]# systemctl restart prometheus</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹Targets<br><img src="\image\image-20201207154557219.png"></p><p>é…ç½®Grafana,ä½¿ç”¨<a href="https://grafana.com/grafana/dashboards/11835" target="_blank" rel="noopener">https://grafana.com/grafana/dashboards/11835</a><br><img src="\image\image-20201207155435494.png"></p><p>é…ç½®alertmanager</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@monitor prometheus-2.23.0.linux-amd64]# cat rule.yml </span><br><span class="line">  - alert: &quot;rediså®ä¾‹å¤±è´¥&quot;</span><br><span class="line">    expr: up&#123;job=&quot;redis&quot;&#125; == 0</span><br><span class="line">    for: 5s</span><br><span class="line">    labels:</span><br><span class="line">      alertname: redis_monitor</span><br><span class="line">      severity: &quot;critical&quot;</span><br><span class="line">    annotations:</span><br><span class="line">      description: &quot;redis &#123;&#123; $labels.instance &#125;&#125; is error&quot;</span><br><span class="line">      summary: &quot;æµ‹è¯•redisç›‘æ§å®•æœº&quot;</span><br></pre></td></tr></table></figure><p>åœæ­¢redisç›‘æ§å,æ”¶åˆ°å‘Šè­¦é‚®ä»¶<br><img src="\image\image-20201207155944044.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ä»€ä¹ˆæ˜¯Prometheus&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯Prometheus&quot; class=&quot;headerlink&quot; title=&quot;ä»€ä¹ˆæ˜¯Prometheus?&quot;&gt;&lt;/a&gt;ä»€ä¹ˆæ˜¯Prometheus?&lt;/h2&gt;&lt;p&gt;Prometheusæ˜¯ç”±SoundCloudå¼€å‘</summary>
      
    
    
    
    
    <category term="Prometheus" scheme="https://nmk0718.github.io/tag/Prometheus/"/>
    
  </entry>
  
  <entry>
    <title>Jenkins</title>
    <link href="https://nmk0718.github.io/2021/03/27/Jenkins/"/>
    <id>https://nmk0718.github.io/2021/03/27/Jenkins/</id>
    <published>2021-03-27T07:03:00.000Z</published>
    <updated>2025-02-10T04:00:59.833Z</updated>
    
    <content type="html"><![CDATA[<h4 id="Jenkinsæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#Jenkinsæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="Jenkinsæ˜¯ä»€ä¹ˆï¼Ÿ"></a>Jenkinsæ˜¯ä»€ä¹ˆï¼Ÿ</h4><p>Jenkinsæ˜¯ä¸€ä¸ªå¼€æºçš„ã€å¯æ‰©å±•çš„æŒç»­é›†æˆã€äº¤ä»˜ã€éƒ¨ç½²ï¼ˆè½¯ä»¶/ä»£ç çš„ç¼–è¯‘ã€æ‰“åŒ…ã€éƒ¨ç½²ï¼‰çš„åŸºäºwebç•Œé¢çš„å¹³å°ã€‚å…è®¸æŒç»­é›†æˆå’ŒæŒç»­äº¤ä»˜é¡¹ç›®ï¼Œæ— è®ºç”¨çš„æ˜¯ä»€ä¹ˆå¹³å°ï¼Œå¯ä»¥å¤„ç†ä»»ä½•ç±»å‹çš„æ„å»ºæˆ–æŒç»­é›†æˆã€‚</p><p>å®˜ç½‘ï¼š<a href="https://jenkins.io/" target="_blank" rel="noopener">https://jenkins.io/</a> å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://jenkins.io/doc/" target="_blank" rel="noopener">https://jenkins.io/doc/</a></p><h4 id="å®‰è£…Jenkins"><a href="#å®‰è£…Jenkins" class="headerlink" title="å®‰è£…Jenkins"></a>å®‰è£…Jenkins</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#å®‰è£…openjdkï¼Œjenkinsä¾èµ–</span><br><span class="line">[root@test ~]# yum install -y java-1.8.0-openjdk</span><br><span class="line"></span><br><span class="line">#æŸ¥çœ‹JDKç‰ˆæœ¬,éªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸ</span><br><span class="line">[root@test ~]# java -version</span><br><span class="line">openjdk version &quot;1.8.0_292&quot;</span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_292-b10)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.292-b10, mixed mode)</span><br><span class="line"></span><br><span class="line">#yumçš„reposä¸­é»˜è®¤æ˜¯æ²¡æœ‰Jenkinsçš„ï¼Œéœ€è¦å…ˆå°†Jenkinså­˜å‚¨åº“æ·»åŠ åˆ°yum repos</span><br><span class="line">[root@test ~]# wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo</span><br><span class="line">[root@test ~]# rpm --import https://pkg.jenkins.io/redhat/jenkins.io.key</span><br><span class="line"></span><br><span class="line">#å®‰è£…jenkins</span><br><span class="line">[root@test ~]# yum install -y jenkins</span><br></pre></td></tr></table></figure><h4 id="å‘½ä»¤"><a href="#å‘½ä»¤" class="headerlink" title="å‘½ä»¤"></a>å‘½ä»¤</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#å¯åŠ¨jenkins</span><br><span class="line">[root@test ~]# systemctl start jenkins</span><br><span class="line"></span><br><span class="line">#æŸ¥çœ‹jenkinså¯åŠ¨çŠ¶æ€</span><br><span class="line">[root@test ~]# systemctl status jenkins</span><br><span class="line"></span><br><span class="line">#åœæ­¢jenkins</span><br><span class="line">[root@test ~]# systemctl stop jenkins</span><br><span class="line"></span><br><span class="line">#æŸ¥çœ‹jenkinsè¿›ç¨‹</span><br><span class="line">[root@test ~]# ps aux |grep jenkins</span><br><span class="line">jenkins   95062  230  4.1 5682456 327392 ?      Ssl  10:15   0:16 /etc/alternatives/java -Dcom.sun.akuma.Daemon=daemonized -Djava.awt.headless=true -DJENKINS_HOME=/var/lib/jenkins -jar /usr/lib/jenkins/jenkins.war --logfile=/var/log/jenkins/jenkins.log --webroot=/var/cache/jenkins/war --daemon --httpPort=8080 --debug=5 --handlerCountMax=100 --handlerCountMaxIdle=20</span><br></pre></td></tr></table></figure><h4 id="è®¿é—®"><a href="#è®¿é—®" class="headerlink" title="è®¿é—®"></a>è®¿é—®</h4><p>æµè§ˆå™¨è®¿é—®ip:8080</p><img src="https://nmk0718.github.io/image/image-20210624112633163.png" alt><p>#å¦‚æ²¡æœ‰æ˜¾ç¤ºé¡µé¢,å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä¸¤ç§æ–¹å¼çš„ä»»æ„ä¸€ç§</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#å…³é—­é˜²ç«å¢™</span><br><span class="line">systemctl stop firewalld</span><br><span class="line"></span><br><span class="line">#æ·»åŠ é˜²ç«å¢™è§„åˆ™</span><br><span class="line">firewall-cmd --zone=public --add-port=8080/tcp --permanent</span><br></pre></td></tr></table></figure><p>é€šè¿‡å‘½ä»¤æŸ¥çœ‹å¯†ç è§£é”jenkins</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">less /var/log/jenkins/jenkins.log </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Jenkins initial setup is required. An admin user has been created and a password generated.</span><br><span class="line">Please use the following password to proceed to installation:</span><br><span class="line"></span><br><span class="line">97f81ad554894de68de6e75f48e6f3b6</span><br><span class="line"></span><br><span class="line">This may also be found at: /var/lib/jenkins/secrets/initialAdminPassword</span><br><span class="line"></span><br><span class="line">*************************************************************</span><br><span class="line">*************************************************************</span><br><span class="line">*************************************************************</span><br><span class="line"></span><br><span class="line">2021-06-24 03:21:19.457+0000 [id=33]    INFO    jenkins.InitReactorRunner$1#onAttained: Completed initialization</span><br><span class="line">2021-06-24 03:21:19.481+0000 [id=22]    INFO    hudson.WebAppMain$3#run: Jenkins is fully up and running</span><br><span class="line">(END)</span><br></pre></td></tr></table></figure><p>å®‰è£…æ¨èæ’ä»¶</p><img src="https://nmk0718.github.io/image/image-20210624113218070.png" alt><p>å®‰è£…å®Œæˆå,è®¾ç½®ç®¡ç†å‘˜è´¦å·</p><img src="https://nmk0718.github.io/image/image-20210624114632352.png" alt><p>é…ç½®è®¿é—®åœ°å€</p><img src="https://nmk0718.github.io/image/image-20210624114708635.png" alt><p>è¿›å…¥ä¸»é¡µé¢</p><img src="https://nmk0718.github.io/image/image-20210624114900893.png" alt><p>jenkinsçš„é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#æŸ¥çœ‹jenkinsçš„é…ç½®æ–‡ä»¶ï¼Œå®šä¹‰äº†homeã€JAVA_CMDã€userã€portç­‰åŸºç¡€é…ç½®ï¼Œä¿æŒé»˜è®¤å³å¯</span><br><span class="line">cat /etc/sysconfig/jenkins</span><br></pre></td></tr></table></figure><p>jenkinsç¨‹åºä¸»ç›®å½•:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ls /var/lib/jenkins/</span><br><span class="line">config.xml#åˆå§‹æ—¶é‡Œè¾¹å®šä¹‰Jenkinsçš„ç‰ˆæœ¬ï¼Œç”¨æˆ·ç­‰å„ç§ä¿¡æ¯</span><br><span class="line">credentials.xml#å­˜å‚¨Gitæ‹‰å–çš„è¯ä¹¦ä¿¡æ¯ã€‚</span><br><span class="line">fingerprints#å…¶ä¸­å®šä¹‰äº†é€šè¿‡ç§˜é’¥æ‰€æ‹‰å–çš„é¡¹ç›®è®°å½•ã€‚</span><br><span class="line">hudson.model.UpdateCenter.xml</span><br><span class="line">hudson.plugins.git.GitTool.xml</span><br><span class="line">identity.key.enc</span><br><span class="line">jenkins.install.InstallUtil.installingPlugins</span><br><span class="line">jenkins.install.InstallUtil.lastExecVersion</span><br><span class="line">jenkins.install.UpgradeWizard.state</span><br><span class="line">jenkins.model.JenkinsLocationConfiguration.xml</span><br><span class="line">jenkins.security.apitoken.ApiTokenPropertyConfiguration.xml</span><br><span class="line">jenkins.security.QueueItemAuthenticatorConfiguration.xml</span><br><span class="line">jenkins.security.UpdateSiteWarningsConfiguration.xml</span><br><span class="line">jenkins.telemetry.Correlator.xml</span><br><span class="line">jobs#åˆ›å»ºçš„ä»»åŠ¡éƒ½ä¼šå­˜æ”¾åœ¨è¿™é‡Œ </span><br><span class="line">logs#å­˜æ”¾jenkinsç›¸å…³çš„æ—¥å¿—</span><br><span class="line">nodeMonitors.xml</span><br><span class="line">nodes#èŠ‚ç‚¹ç®¡ç†çš„ä¿¡æ¯,å¤šèŠ‚ç‚¹æ—¶ç”¨åˆ°</span><br><span class="line">plugins#æ’ä»¶æ‰€åœ¨ç›®å½•</span><br><span class="line">queue.xml</span><br><span class="line">queue.xml.bak</span><br><span class="line">secret.key</span><br><span class="line">secret.key.not-so-secret</span><br><span class="line">secrets#å¯†ç ç§˜é’¥æ‰€åœ¨ç›®å½•</span><br><span class="line">updates</span><br><span class="line">userContent</span><br><span class="line">users#ç”¨æˆ·ä¿¡æ¯</span><br><span class="line">workflow-libs</span><br><span class="line">workspace#å·¥ä½œç©ºé—´</span><br></pre></td></tr></table></figure><p>jenkinså­˜æ”¾æ•°æ®ä¸ä¾é æ•°æ®åº“ï¼Œæ‰€ä»¥åœ¨ç§»æ¤æ—¶åªéœ€è¦æ‹·è´æ•´ä¸ªç¨‹åºä¸»ç›®å½•å³å¯ã€‚</p><h4 id="ç”¨æˆ·ç®¡ç†"><a href="#ç”¨æˆ·ç®¡ç†" class="headerlink" title="ç”¨æˆ·ç®¡ç†"></a>ç”¨æˆ·ç®¡ç†</h4><img src="https://nmk0718.github.io/image/image-20210628112325345.png" alt><p>æ–°å»ºç”¨æˆ·</p><img src="https://nmk0718.github.io/image/image-20210628112407469.png" alt><p>å»ºç«‹å®Œæ¯•åå¯çœ‹åˆ°å¯¹åº”çš„ç”¨æˆ·,ç‚¹å‡»ç”¨æˆ·è¿›è¡Œç›¸å…³é…ç½®</p><img src="https://nmk0718.github.io/image/image-20210628112651865.png" alt><p>æŸ¥çœ‹å½“å‰ç”¨æˆ·çš„æ„å»ºå†å²</p><img src="https://nmk0718.github.io/image/image-20210628112843727.png" alt><p>å¯ä¿®æ”¹å½“å‰ç”¨æˆ·çš„é‚®ç®±,å¯†ç ,è§†å›¾ç­‰ç›¸å…³ç”¨æˆ·ä¿¡æ¯</p><img src="https://nmk0718.github.io/image/image-20210628112932432.png" alt><p>åˆ é™¤ç”¨æˆ·</p><img src="https://nmk0718.github.io/image/image-20210628112949580.png" alt><h4 id="æ’ä»¶"><a href="#æ’ä»¶" class="headerlink" title="æ’ä»¶"></a>æ’ä»¶</h4><img src="https://nmk0718.github.io/image/image-20210628111038884.png" alt><p>å®‰è£…ä»¥ä¸‹æ’ä»¶</p><img src="https://nmk0718.github.io/image/image-20210628111141523.png" alt><img src="https://nmk0718.github.io/image/image-20210628111300294.png" alt><img src="https://nmk0718.github.io/image/image-20210628151958241.png" alt><h4 id="ç¼–è¯‘ä¾èµ–"><a href="#ç¼–è¯‘ä¾èµ–" class="headerlink" title="ç¼–è¯‘ä¾èµ–"></a>ç¼–è¯‘ä¾èµ–</h4><h5 id="å®‰è£…Maven"><a href="#å®‰è£…Maven" class="headerlink" title="å®‰è£…Maven"></a>å®‰è£…Maven</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#ä¸‹è½½mavenåŒ…,è§£å‹</span><br><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/apache/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz</span><br><span class="line">tar zxvf apache-maven-3.6.3-bin.tar.gz </span><br><span class="line">mv apache-maven-3.6.3 /usr/local/maven</span><br><span class="line"></span><br><span class="line">#æ·»åŠ ç¯å¢ƒå˜é‡</span><br><span class="line">vi /etc/profile</span><br><span class="line">#MAVEN</span><br><span class="line">MAVEN_HOME=/usr/local/maven</span><br><span class="line">export MAVEN_HOME</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin:$MAVEN_HOME/bin</span><br><span class="line"></span><br><span class="line">#ç”Ÿæ•ˆç¯å¢ƒå˜é‡</span><br><span class="line">source /etc/profile</span><br><span class="line"></span><br><span class="line">#æŸ¥çœ‹ç‰ˆæœ¬å·</span><br><span class="line">mvn -v</span><br></pre></td></tr></table></figure><h5 id="å®‰è£…NPM"><a href="#å®‰è£…NPM" class="headerlink" title="å®‰è£…NPM"></a>å®‰è£…NPM</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#ä¸‹è½½node,è§£å‹</span><br><span class="line">[root@public home]# wget https://nodejs.org/dist/v12.19.0/node-v12.19.0-linux-x64.tar.xz</span><br><span class="line">[root@public home]# tar xf  node-v12.19.0-linux-x64.tar.xz </span><br><span class="line">[root@public home]# cd node-v12.19.0-linux-x64</span><br><span class="line">#è½¯é“¾æ¥</span><br><span class="line">[root@public node-v12.19.0-linux-x64]# ln -s /home/node-v12.19.0-linux-x64/bin/npm   /usr/local/bin/ </span><br><span class="line">[root@public node-v12.19.0-linux-x64]# ln -s /home/node-v12.19.0-linux-x64/bin/node   /usr/local/bin/</span><br><span class="line">#æŸ¥çœ‹ç‰ˆæœ¬å·éªŒè¯</span><br><span class="line">[root@public node-v12.19.0-linux-x64]# node -v</span><br><span class="line">v12.19.0</span><br><span class="line">[root@public node-v12.19.0-linux-x64]# npm -v</span><br><span class="line">6.14.8</span><br><span class="line">#å®‰è£…ä¾èµ–</span><br><span class="line">[root@public node-v12.19.0-linux-x64]# npm install</span><br></pre></td></tr></table></figure><p>é…ç½®Jenkinsç¯å¢ƒå˜é‡</p><img src="https://nmk0718.github.io/image/image-20210628143407807.png" alt><h4 id="ç”¨æˆ·æƒé™"><a href="#ç”¨æˆ·æƒé™" class="headerlink" title="ç”¨æˆ·æƒé™"></a>ç”¨æˆ·æƒé™</h4><p>ç³»ç»Ÿç®¡ç† â€“&gt; å…¨å±€å®‰å…¨é…ç½®(Manage Jenkins â€“&gt; Configure Global Security) å‹¾é€‰Role-Based Strategy</p><img src="https://nmk0718.github.io/image/image-20210628111648680.png" alt><p>ä¿å­˜åå¯çœ‹åˆ°å¤šäº†Manage and Assign Rolesé€‰é¡¹</p><img src="https://nmk0718.github.io/image/image-20210628111829761.png" alt><p>å‡†å¤‡å·¥ä½œ:</p><p>åˆ›å»ºä¸åŒç¯å¢ƒçš„è§†å›¾å’Œä»»åŠ¡</p><img src="https://nmk0718.github.io/image/image-20210628112217883.png" alt><p>åˆ›å»ºä¸åŒçš„ç”¨æˆ·</p><img src="https://nmk0718.github.io/image/image-20210628112533958.png" alt><p>é…ç½®è§’è‰²</p><img src="https://nmk0718.github.io/image/image-20210628113242039.png" alt><p>åˆ›å»ºè§’è‰²åç§°ä¸ºonly_read,éœ€ç‚¹å‡»addæ‰èƒ½æ·»åŠ ,èµ‹äºˆè¯»å–æƒé™</p><img src="https://nmk0718.github.io/image/image-20210628113437364.png" alt><p>åˆ›å»ºè§’è‰²åç§°dev,å¯¹åº”çœ‹åˆ°çš„è§†å›¾<code>dev.*</code>(ä»£è¡¨åŒ¹é…devå¼€å¤´çš„æ‰€æœ‰åº”ç”¨),ç‚¹å‡»å›¾ä¸­çš„<code>dev.*</code>å¯æŸ¥çœ‹åˆ°æµè§ˆå™¨çš„å¼¹çª—ä¸­æ‰€åŒ¹é…åˆ°çš„ä»»åŠ¡</p><img src="https://nmk0718.github.io/image/image-20210628113624189.png" alt><p>å‹¾é€‰èµ‹äºˆç›¸å¯¹åº”çš„æƒé™,ä¸‹å›¾æ‰€ç¤ºæƒé™ä¸º:å¯ä»¥æŸ¥çœ‹æ„å»ºå–æ¶ˆé…ç½®ä»»åŠ¡,å¯æŸ¥çœ‹è¯¥ä»»åŠ¡çš„å·¥ä½œåŒº.(è¿™é‡Œç»™äºˆé…ç½®æƒé™æ˜¯å› ä¸ºå¼€å‘å¯èƒ½éœ€è¦æ„å»ºå¯¹åº”çš„Gitåˆ†æ”¯)</p><img src="https://nmk0718.github.io/image/image-20210628114414460.png" alt><p>ä¿å­˜åé€‰æ‹©<code>åˆ†é…è§’è‰²</code>ï¼Œæ˜¯ç”¨æˆ·ä¸è§’è‰²è¿›è¡Œå…³è”</p><img src="https://nmk0718.github.io/image/image-20210628114023410.png" alt><p>ä½¿ç”¨æˆ·ä¸åŒ¹é…çš„è§†å›¾ä»»åŠ¡ç›¸å…³è”</p><img src="https://nmk0718.github.io/image/image-20210628114138544.png" alt><p>ä¿å­˜ååˆ‡æ¢åˆ°devç”¨æˆ·ç™»å½•,å¯çœ‹åˆ°devç”¨æˆ·åªèƒ½çœ‹åˆ°devçš„è§†å›¾,æ— æ³•çœ‹åˆ°testå’Œprodè§†å›¾,æ— æ³•è¿›è¡Œç®¡ç†jenkins</p><img src="https://nmk0718.github.io/image/image-20210628114638198.png" alt><p>åˆ‡æ¢ä¸ºtestç”¨æˆ·ç™»å½•,å¯çœ‹åˆ°testç”¨æˆ·åªèƒ½çœ‹åˆ°testçš„è§†å›¾,æ— æ³•çœ‹åˆ°devå’Œprodè§†å›¾,æ— æ³•è¿›è¡Œç®¡ç†jenkins</p><img src="https://nmk0718.github.io/image/image-20210628114732769.png" alt><p>âš å®šä¹‰è§’è‰²å’Œæƒé™åº”å½“è§†å½“å‰æƒ…å†µè¿›è¡Œåˆ†é…</p><h4 id="ä»»åŠ¡"><a href="#ä»»åŠ¡" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h4><img src="https://nmk0718.github.io/image/image-20210624115353433.png" alt><h5 id="ä¸¢å¼ƒæ—§çš„æ„å»º"><a href="#ä¸¢å¼ƒæ—§çš„æ„å»º" class="headerlink" title="ä¸¢å¼ƒæ—§çš„æ„å»º"></a>ä¸¢å¼ƒæ—§çš„æ„å»º</h5><p>åˆ é™¤æ„å»ºå†å²å’Œæ„å»ºæ‰“åŒ…çš„å·¥ä½œç©ºé—´(å»ºè®®åœ¨ç£ç›˜ç©ºé—´ä¸è¶³æƒ…å†µä¸‹æˆ–å¼€å‘æµ‹è¯•ç¯å¢ƒä»»åŠ¡ä½¿ç”¨,ç”Ÿäº§å‹¿ç”¨)</p><img src="https://nmk0718.github.io/image/image-20210628134327315.png" alt><h5 id="å‚æ•°åŒ–æ„å»º"><a href="#å‚æ•°åŒ–æ„å»º" class="headerlink" title="å‚æ•°åŒ–æ„å»º"></a>å‚æ•°åŒ–æ„å»º</h5><p>å¯é€šè¿‡å‚æ•°è¿›è¡Œæ‰“åŒ…ç¼–è¯‘.</p><img src="https://nmk0718.github.io/image/image-20210628134649710.png" alt><p>(ä½¿ç”¨è‹±æ–‡ç‰ˆè¿›è¡Œæ¼”ç¤º)</p><p>å­—ç¬¦ä¸²å‚æ•°</p><img src="https://nmk0718.github.io/image/image-20210628135427247.png" alt><p>ç‚¹å‡»æ„å»ºåå…ˆå¼¹å‡ºç”¨äºæ„å»ºçš„å‚æ•°</p><img src="https://nmk0718.github.io/image/image-20210628135550396.png" alt><p>æŸ¥çœ‹æ„å»ºåçš„æ§åˆ¶å°è¾“å‡º</p><img src="https://nmk0718.github.io/image/image-20210628135723128.png" alt><p>å¯æŸ¥çœ‹åˆ°ä½¿ç”¨echo $unionpayå¯è¯»å–åˆ°å…ˆå‰å®šä¹‰çš„å‚æ•°</p><img src="https://nmk0718.github.io/image/image-20210628135758926.png" alt><p>é€‰é¡¹æ„å»º</p><img src="https://nmk0718.github.io/image/image-20210628135942231.png" alt><p>ç‚¹å‡»æ„å»ºå,ä¼šå¼¹å‡ºé€‰é¡¹,è®©ç”¨æˆ·è¿›è¡Œé€‰æ‹©</p><img src="https://nmk0718.github.io/image/image-20210628140124040.png" alt><p>æŸ¥çœ‹æ§åˆ¶å°å¯çœ‹åˆ°,ç”¨æˆ·é€‰æ‹©testå,ä½¿ç”¨echo $profileæ‰“å°å‡ºäº†æ­£ç¡®çš„å‚æ•°</p><img src="https://nmk0718.github.io/image/image-20210628140223631.png" alt><h5 id="æ‹‰å–ä»£ç "><a href="#æ‹‰å–ä»£ç " class="headerlink" title="æ‹‰å–ä»£ç "></a>æ‹‰å–ä»£ç </h5><p>å¯é€‰æ‹©Gitå’ŒSvnè¿›è¡Œæ‹‰å–ä»£ç ,ä¸ºåç»­æ„å»ºé¡¹ç›®åšå‡†å¤‡,æ­¤å¤„ä½¿ç”¨git</p><img src="https://nmk0718.github.io/image/image-20210628140551120.png" alt><p>Repository URLå¡«å†™Gitçš„ä»“åº“åœ°å€,Credentialséœ€è¦æ·»åŠ è®¤è¯çš„Gitè´¦å·å¯†ç ,æŒ‡å®šåˆ†æ”¯é»˜è®¤ä¸ºmaster å¯æ”¹å˜ä¸ºå…¶ä»–åˆ†æ”¯</p><img src="https://nmk0718.github.io/image/image-20210628140740020.png" alt><h5 id="ä¿®æ”¹è®°å½•"><a href="#ä¿®æ”¹è®°å½•" class="headerlink" title="ä¿®æ”¹è®°å½•"></a>ä¿®æ”¹è®°å½•</h5><p>å¯æŸ¥çœ‹ç›¸å¯¹äºä¸Šä¸ªç‰ˆæœ¬ä»£ç çš„ä¿®æ”¹è®°å½•</p><img src="https://nmk0718.github.io/image/image-20210628140911538.png" alt><h5 id="å·¥ä½œç©ºé—´"><a href="#å·¥ä½œç©ºé—´" class="headerlink" title="å·¥ä½œç©ºé—´"></a>å·¥ä½œç©ºé—´</h5><p>å¯æŸ¥çœ‹æ‹‰å–çš„ä»£ç å’Œç¼–è¯‘åçš„æ–‡ä»¶,å¯åœ¨çº¿æŸ¥çœ‹æ–‡ä»¶,ä¹Ÿå¯ä»¥ç›´æ¥æ‰“åŒ…ä¸‹è½½,ç”¨äºæŸ¥æ‰¾é—®é¢˜,æ¸…ç†å·¥ä½œç©ºé—´,å¯ä»¥æ¸…ç©ºæ‰€ä»¥å½“å‰å·¥ä½œç©ºé—´å†…çš„æ‰€æœ‰æ–‡ä»¶</p><img src="https://nmk0718.github.io/image/image-20210628141012122.png" alt><h5 id="ç«‹å³æ„å»º"><a href="#ç«‹å³æ„å»º" class="headerlink" title="ç«‹å³æ„å»º"></a>ç«‹å³æ„å»º</h5><p>æ„å»ºå½“å‰é…ç½®å¥½çš„ä»»åŠ¡,å¯åœ¨æ§åˆ¶å°æŸ¥çœ‹æ˜¯å¦æˆåŠŸ,ä¹Ÿå¯çœ‹åˆ°å…·ä½“çš„æ‰“åŒ…é”™è¯¯</p><img src="https://nmk0718.github.io/image/image-20210628141240327.png" alt><h5 id="å®šæ—¶æ„å»º"><a href="#å®šæ—¶æ„å»º" class="headerlink" title="å®šæ—¶æ„å»º"></a>å®šæ—¶æ„å»º</h5><p>â€œæ—¥ç¨‹è¡¨â€æ ¼å¼ä¸ crontab ç›¸ä¼¼ä½†æœ‰ç»†å¾®å·®åˆ«</p><p>æ¯è¡Œç”± 5 ä¸ªå€¼ç»„æˆ(ç©ºæ ¼æˆ–TABåˆ†éš”)ï¼Œåˆ†åˆ«è¡¨ç¤ºåˆ†(0-59)ã€æ—¶(0-23)ã€æ—¥(1-31)ã€æœˆ(1-12)ã€å‘¨(0-7, 0/7=å‘¨æ—¥) ## â€œM,Nâ€ è¡¨ç¤ºMå’ŒNï¼›â€M-Nâ€ è¡¨ç¤ºèŒƒå›´[M,N]ï¼›â€M-N/Xâ€ è¡¨ç¤ºèŒƒå›´[M,N]å†…æ¯éš”Xï¼›â€*/Xâ€è¡¨ç¤ºæ•´ä¸ªèŒƒå›´å†…æ¯éš”X<br>å‰é¢æåˆ°çš„M/N/Xçš„å€¼éƒ½å¯ä»¥ç”¨H(æ„ä¸ºHash)ä»£æ›¿ï¼Œæ•£åˆ—å€¼èµ·åˆ°éšæœºå€¼çš„æ•ˆæœï¼Œä¸”åŒä¸€é¡¹ç›®å–å€¼ç¨³å®šï¼Œè¿™å¯¹äºé¡¹ç›®å¤šæ—¶åˆ†æ•£å‹åŠ›å¾ˆæœ‰ç”¨ã€‚<br>H/10 H(0-8) * * 1-5 ## è§¦å‘æ—¶é—´: å·¥ä½œæ—¥ã€Hourä¸º0~8æŒ‰å“ˆå¸Œéšæœºã€Minuteä»¥10ä¸ºé—´éš”<br>H/10 H * * 0,6,7 ## è§¦å‘æ—¶é—´: å‘¨æœ«ã€Hourä¸ºå…¨å¤©æŒ‰å“ˆå¸Œéšæœºã€Minuteä»¥10ä¸ºé—´éš” ##<br>â€œæ—¥ç¨‹è¡¨â€ä¿®æ”¹åï¼Œä¸‹æ–¹ä¼šç»™å‡ºä¸‹æ¬¡æ‰§è¡Œæ—¶é—´ç‚¹çš„é¢„å‘Šã€‚</p><img src="https://nmk0718.github.io/image/image-20210628141534174.png" alt><h5 id="æ·»åŠ æ—¶é—´æˆ³"><a href="#æ·»åŠ æ—¶é—´æˆ³" class="headerlink" title="æ·»åŠ æ—¶é—´æˆ³"></a>æ·»åŠ æ—¶é—´æˆ³</h5><img src="https://nmk0718.github.io/image/image-20210628142054564.png" alt><h5 id="å‰ç«¯ç¼–è¯‘æ‰“åŒ…éƒ¨ç½²"><a href="#å‰ç«¯ç¼–è¯‘æ‰“åŒ…éƒ¨ç½²" class="headerlink" title="å‰ç«¯ç¼–è¯‘æ‰“åŒ…éƒ¨ç½²"></a>å‰ç«¯ç¼–è¯‘æ‰“åŒ…éƒ¨ç½²</h5><p>é€šè¿‡npm installä¸‹è½½å‰ç«¯ä¾èµ–,npm run buildè¿›è¡Œç¼–è¯‘æ‰“åŒ…</p><img src="https://nmk0718.github.io/image/image-20210628150210870.png" alt><p>ä½¿ç”¨nginxé…ç½®å‰ç«¯è®¿é—®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name www.test.com;</span><br><span class="line">  location /web/ &#123;</span><br><span class="line">      root /home/web/;</span><br><span class="line">      index  index.html;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure><h5 id="åç«¯ç¼–è¯‘æ‰“åŒ…éƒ¨ç½²"><a href="#åç«¯ç¼–è¯‘æ‰“åŒ…éƒ¨ç½²" class="headerlink" title="åç«¯ç¼–è¯‘æ‰“åŒ…éƒ¨ç½²"></a>åç«¯ç¼–è¯‘æ‰“åŒ…éƒ¨ç½²</h5><p>å¯ä»¥ä½¿ç”¨<code>è°ƒç”¨é¡¶å±‚mvnå‘½ä»¤</code>ä¹Ÿå¯ä»¥ä½¿ç”¨<code>shellé‡Œç”¨mvn</code></p><img src="https://nmk0718.github.io/image/image-20210628144804207.png" alt><p>æ§åˆ¶å°å¯ä»¥çœ‹åˆ°ç¼–è¯‘æ‰“åŒ…æ˜¯å¦æˆåŠŸ</p><img src="https://nmk0718.github.io/image/image-20210628144853603.png" alt><p>é…ç½®SSHæœåŠ¡å™¨,è¿™é‡Œå®šä¹‰SSHåç§°,åœ°å€,ç«¯å£,ç”¨æˆ·å,ä¸Šä¼ æ–‡ä»¶çš„è·¯å¾„,å¦‚æœä½¿ç”¨å¯†ç å‹¾é€‰Use Passwordé€‰é¡¹,ä½¿ç”¨å¯†é’¥ä½¿ç”¨key</p><img src="https://nmk0718.github.io/image/image-20210628144959208.png" alt><p>æ„å»ºæ—¶é€‰æ‹©SSHæ’ä»¶,è¿›è¡Œéƒ¨ç½²</p><img src="https://nmk0718.github.io/image/image-20210628145258039.png" alt><p>é€‰æ‹©å¯¹åº”é…ç½®çš„SSHæœåŠ¡å™¨,è¦ä¸Šä¼ çš„æ–‡ä»¶(ç›¸å¯¹è·¯å¾„),é…ç½®ä¸­çš„SSHæœåŠ¡å™¨ä¸Šä¼ åœ°å€ä¸º/home/upload,æ­¤å¤„çš„Remote directoryä¸º/ä¼šä¸Šä¼ åˆ°/home/uploadä¸‹,ç„¶åé…ç½®ä¸Šä¼ åˆ°æœåŠ¡å™¨å,è¦æ‰§è¡Œéƒ¨ç½²çš„è„šæœ¬æ–‡ä»¶,æ­¤å¤„ä½¿ç”¨äº†nohup sh 2&gt;&amp;1æ˜¯å› ä¸ºjenkinsæœ‰ä¸€ä¸ªæœºåˆ¶ä¼šæ€æ‰å¯åŠ¨çš„é¡¹ç›®è¿›ç¨‹</p><p>éƒ¨ç½²è„šæœ¬</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@service-001 upload]# cat hospital-union-pay.sh </span><br><span class="line">#Java Env</span><br><span class="line">export JAVA_HOME=/usr/local/java</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line"></span><br><span class="line">port=8085</span><br><span class="line"></span><br><span class="line">pid=$(netstat -nlp | grep :$port | awk &apos;&#123;print $7&#125;&apos; | awk -F&quot;/&quot; &apos;&#123; print $1 &#125;&apos;);</span><br><span class="line"></span><br><span class="line">jar=hospital-union-pay.jar</span><br><span class="line"></span><br><span class="line">if [  -n  &quot;$pid&quot;  ];  then</span><br><span class="line">    kill  -9  $pid;</span><br><span class="line">fi</span><br><span class="line">rm -rf /home/app/$jar</span><br><span class="line">mv /home/upload/$jar /home/app/</span><br><span class="line">cd /home/app</span><br><span class="line">java -Xms512M -Xmx1024M -jar $jar --spring.profiles.active=test &amp;</span><br></pre></td></tr></table></figure><h5 id="æ¸…ç†å·¥ä½œç©ºé—´"><a href="#æ¸…ç†å·¥ä½œç©ºé—´" class="headerlink" title="æ¸…ç†å·¥ä½œç©ºé—´"></a>æ¸…ç†å·¥ä½œç©ºé—´</h5><img src="https://nmk0718.github.io/image/image-20210628145742797.png" alt><h4 id="é˜¿é‡Œäº‘K8Séƒ¨ç½²"><a href="#é˜¿é‡Œäº‘K8Séƒ¨ç½²" class="headerlink" title="é˜¿é‡Œäº‘K8Séƒ¨ç½²"></a>é˜¿é‡Œäº‘K8Séƒ¨ç½²</h4><p>é€šè¿‡å®šä¹‰å¥½çš„å­—ç¬¦ä¸²å‚æ•°è¿›è¡Œæ„å»º</p><img src="https://nmk0718.github.io/image/image-20210628151112491.png" alt><p>start.sh</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">JARFILE=/home/App.jar</span><br><span class="line"></span><br><span class="line">java -jar config -Djava.security.egd=file:/dev/./urandom $JARFILE profile &gt;&gt; /home/app.log &amp;</span><br><span class="line"></span><br><span class="line">tail  -50f /home/app.log</span><br></pre></td></tr></table></figure><p>Dockerfile</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FROM  registry.cn-shenzhen.aliyuncs.com/server:latest</span><br><span class="line">MAINTAINER nmk</span><br><span class="line"></span><br><span class="line">COPY  *.jar /home/App.jar</span><br><span class="line">COPY  start.sh /home/start.sh</span><br><span class="line">RUN chmod +x /home/start.sh</span><br><span class="line">ENV JAVA_HOME=/usr/local/java</span><br><span class="line">ENV PATH $JAVA_HOME/bin:$PATH</span><br><span class="line">ENV CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line">ENV LC_ALL=&quot;en_US.UTF-8&quot;</span><br><span class="line">ENV LANG=&quot;en_US.UTF-8&quot;</span><br><span class="line"></span><br><span class="line">EXPOSE appport</span><br><span class="line">CMD [&quot;/home/start.sh&quot;]</span><br></pre></td></tr></table></figure><p>build.sh</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">#æ„å»ºæœ‰ç‰ˆæœ¬å·çš„é•œåƒï¼Œä»¥é˜²éœ€è¦å›æ»šï¼Œè€Œä¸”æ˜¯ä»é•œåƒåˆ›å»ºæœåŠ¡</span><br><span class="line">docker build -t registry.cn-shenzhen.aliyuncs.com/gongsi_$1/$2:$3     . -f Dockerfile</span><br><span class="line"></span><br><span class="line">docker push     registry.cn-shenzhen.aliyuncs.com/gongsi_$1/$2:$3  </span><br><span class="line">#æ„å»ºlatestç‰ˆæœ¬ï¼Œç”¨äºè‡ªåŠ¨éƒ¨ç½²</span><br><span class="line">docker build -t registry.cn-shenzhen.aliyuncs.com/gongsi_$1/$2:latest . -f Dockerfile</span><br><span class="line">docker push     registry.cn-shenzhen.aliyuncs.com/gongsi_$1/$2:latest</span><br></pre></td></tr></table></figure><h4 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h4><p>GitLabå¯é€šè¿‡webhookè¿›è¡Œè‡ªåŠ¨éƒ¨ç½²,å¼€å‘ä¸€æäº¤ä»£ç å³å¯è§¦å‘jenkinsçš„è‡ªåŠ¨æ„å»º.</p><h5 id="ä¸»é¢˜"><a href="#ä¸»é¢˜" class="headerlink" title="ä¸»é¢˜"></a>ä¸»é¢˜</h5><p>ç”Ÿæˆå·¥å…·URLè§ï¼š<a href="http://afonsof.com/jenkins-material-theme/" target="_blank" rel="noopener">http://afonsof.com/jenkins-material-theme/</a></p><p>åœ¨ç³»ç»Ÿé…ç½®ä¸­åŠ å…¥csså³å¯<img src="https://nmk0718.github.io/image/image-20210628151721136.png" alt></p><p>æ•ˆæœå¦‚ä¸‹</p><img src="https://nmk0718.github.io/image/image-20210628151853759.png" alt><p>é’‰é’‰æœºå™¨äººé€šçŸ¥ï¼š<a href="https://blog.csdn.net/shi_hong_fei_hei/article/details/112055446" target="_blank" rel="noopener">https://blog.csdn.net/shi_hong_fei_hei/article/details/112055446</a></p><p>é‚®ä»¶é€šçŸ¥:<a href="https://www.cnblogs.com/imyalost/p/8781759.html" target="_blank" rel="noopener">https://www.cnblogs.com/imyalost/p/8781759.html</a></p><h5 id="jenkinsé€šè¿‡sshå¯åŠ¨æœåŠ¡å¤±è´¥"><a href="#jenkinsé€šè¿‡sshå¯åŠ¨æœåŠ¡å¤±è´¥" class="headerlink" title="jenkinsé€šè¿‡sshå¯åŠ¨æœåŠ¡å¤±è´¥"></a>jenkinsé€šè¿‡sshå¯åŠ¨æœåŠ¡å¤±è´¥</h5><p>æŸ¥çœ‹tomcatå¯åŠ¨æ—¥å¿—å‘ç°æŠ¥é”™:waråŒ…æ‹’ç»è®¿é—®</p><p>å› jenkinsé…ç½®çš„sshå¯¹åº”çš„windowsè´¦å·ä¸æ˜¯administratorä¼šå‡ºç°æ²¡æƒé™é—®é¢˜</p><p>æ–¹æ¡ˆ1.æ›´æ”¹jenkinsçš„sshç”¨æˆ·ä¸ºadministrator</p><p>æ–¹æ¡ˆ2.ç»™éœ€è¦æƒé™çš„æ–‡ä»¶å¤¹æˆ–æ–‡ä»¶æˆæƒ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">windowså‘½ä»¤ç»™ç”¨æˆ·æˆæƒ</span><br><span class="line">cacls E:\tomcat /t /e /c /r nmk   æ‹’ç»</span><br><span class="line">Cacls E:\tomcat /t /e /c /g nmk:F   å…è®¸</span><br><span class="line"></span><br><span class="line">å¤šç”¨æˆ·æƒ…å†µä¸‹å¯ä»¥ç»™everyone</span><br><span class="line">Cacls E:\SFTP\sftp\nmk.war /t /e /c /g everyone:F</span><br></pre></td></tr></table></figure><h4 id="è‡ªåŠ¨éƒ¨ç½²è„šæœ¬"><a href="#è‡ªåŠ¨éƒ¨ç½²è„šæœ¬" class="headerlink" title="è‡ªåŠ¨éƒ¨ç½²è„šæœ¬"></a>è‡ªåŠ¨éƒ¨ç½²è„šæœ¬</h4><h5 id="windowsè‡ªåŠ¨éƒ¨ç½²waråŒ…è„šæœ¬"><a href="#windowsè‡ªåŠ¨éƒ¨ç½²waråŒ…è„šæœ¬" class="headerlink" title="windowsè‡ªåŠ¨éƒ¨ç½²waråŒ…è„šæœ¬"></a>windowsè‡ªåŠ¨éƒ¨ç½²waråŒ…è„šæœ¬</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">for /f &quot;tokens=5&quot; %%e in (&apos;netstat -aon ^| findstr &quot;:9021&quot;&apos;) do (set f=%%e)</span><br><span class="line">taskkill /t /f /pid %f% </span><br><span class="line"></span><br><span class="line">rd /s /q &quot;E:\tomcat-9021\webapps\cmpay&quot;</span><br><span class="line">del &quot;E:\tomcat-9021\webapps\cmpay.war&quot;</span><br><span class="line">move cmpay.war &quot;E:\tomcat-9021\webapps\&quot;</span><br><span class="line">net start tomcat9021</span><br></pre></td></tr></table></figure><p>å› windowså¯åŠ¨tomcatä¼šè¢«jenkinsæ€æ‰,æ‰€ä»¥è¦æŠŠtomcatåšæˆæœåŠ¡</p><h5 id="windowsè‡ªåŠ¨éƒ¨ç½²jaråŒ…è„šæœ¬"><a href="#windowsè‡ªåŠ¨éƒ¨ç½²jaråŒ…è„šæœ¬" class="headerlink" title="windowsè‡ªåŠ¨éƒ¨ç½²jaråŒ…è„šæœ¬"></a>windowsè‡ªåŠ¨éƒ¨ç½²jaråŒ…è„šæœ¬</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">for /f &quot;tokens=5&quot; %%i in (&apos;netstat -aon ^| findstr &quot;:8081&quot;&apos;) do (set j=%%i)</span><br><span class="line">taskkill /t /f /pid %j% </span><br><span class="line"></span><br><span class="line">del E:\gzlp_red_package\lepeng-red-package-coupon.jar</span><br><span class="line">move lepeng-red-package-coupon-1.0-SNAPSHOT.jar &quot;E:\gzlp_red_package\lepeng-red-package-coupon.jar&quot;</span><br><span class="line">javaw -Xms256m -Xmx512m -jar &quot;E:\gzlp_red_package\lepeng-red-package-coupon.jar&quot; --spring.profiles.active=dev</span><br></pre></td></tr></table></figure><h5 id="linuxè‡ªåŠ¨éƒ¨ç½²waråŒ…è„šæœ¬"><a href="#linuxè‡ªåŠ¨éƒ¨ç½²waråŒ…è„šæœ¬" class="headerlink" title="linuxè‡ªåŠ¨éƒ¨ç½²waråŒ…è„šæœ¬"></a>linuxè‡ªåŠ¨éƒ¨ç½²waråŒ…è„šæœ¬</h5><p>jenkinsé…ç½®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sh /home/tomcat/upload/omall.sh</span><br></pre></td></tr></table></figure><p>omall.shè„šæœ¬å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#Java Env</span><br><span class="line">export JAVA_HOME=/usr/java</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line"></span><br><span class="line">port=19181</span><br><span class="line">#æ ¹æ®ç«¯å£å·æŸ¥è¯¢å¯¹åº”çš„pid</span><br><span class="line">pid=$(netstat -nlp | grep :$port | awk &apos;&#123;print $7&#125;&apos; | awk -F&quot;/&quot; &apos;&#123; print $1 &#125;&apos;);</span><br><span class="line"></span><br><span class="line">#æ€æ‰å¯¹åº”çš„è¿›ç¨‹ï¼Œå¦‚æœpidä¸å­˜åœ¨ï¼Œåˆ™ä¸æ‰§è¡Œ</span><br><span class="line">if [  -n  &quot;$pid&quot;  ];  then</span><br><span class="line">    kill  -9  $pid;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">rm -rf /home/tomcat/omall/webapps/omall.war</span><br><span class="line">rm -rf /home/tomcat/omall/webapps/omall</span><br><span class="line">mv /home/tomcat/upload/omall.war /home/tomcat/omall/webapps</span><br><span class="line">cd /home/tomcat/omall/bin</span><br><span class="line">./startup.sh</span><br></pre></td></tr></table></figure><h5 id="linuxè‡ªåŠ¨éƒ¨ç½²jaråŒ…è„šæœ¬"><a href="#linuxè‡ªåŠ¨éƒ¨ç½²jaråŒ…è„šæœ¬" class="headerlink" title="linuxè‡ªåŠ¨éƒ¨ç½²jaråŒ…è„šæœ¬"></a>linuxè‡ªåŠ¨éƒ¨ç½²jaråŒ…è„šæœ¬</h5><p>jenkinsé…ç½®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /home/tomcat/app/admin-core</span><br><span class="line">nohup sh /home/tomcat/upload/admin-core.sh &gt;&gt; catalina.out 2&gt;&amp;1</span><br></pre></td></tr></table></figure><p>admin-core.shè„šæœ¬å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#Java Env</span><br><span class="line">export JAVA_HOME=/usr/java</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line"></span><br><span class="line">port=48094</span><br><span class="line">#æ ¹æ®ç«¯å£å·æŸ¥è¯¢å¯¹åº”çš„pid</span><br><span class="line">pid=$(netstat -nlp | grep :$port | awk &apos;&#123;print $7&#125;&apos; | awk -F&quot;/&quot; &apos;&#123; print $1 &#125;&apos;);</span><br><span class="line"></span><br><span class="line">#æ€æ‰å¯¹åº”çš„è¿›ç¨‹ï¼Œå¦‚æœpidä¸å­˜åœ¨ï¼Œåˆ™ä¸æ‰§è¡Œ</span><br><span class="line">if [  -n  &quot;$pid&quot;  ];  then</span><br><span class="line">    kill  -9  $pid;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">rm -r /home/tomcat/app/admin-core/admin-core-0.0.1-SNAPSHOT.jar</span><br><span class="line">mv /home/tomcat/upload/admin-core-0.0.1-SNAPSHOT.jar /home/tomcat/app/admin-core</span><br><span class="line">cd /home/tomcat/app/admin-core</span><br><span class="line">java -Xms256m -Xmx512m -jar /home/tomcat/app/admin-core/admin-core-0.0.1-SNAPSHOT.jar --spring.profiles.active=dev  &amp;</span><br></pre></td></tr></table></figure><h5 id="k8sè‡ªåŠ¨éƒ¨ç½²åç«¯è„šæœ¬"><a href="#k8sè‡ªåŠ¨éƒ¨ç½²åç«¯è„šæœ¬" class="headerlink" title="k8sè‡ªåŠ¨éƒ¨ç½²åç«¯è„šæœ¬"></a>k8sè‡ªåŠ¨éƒ¨ç½²åç«¯è„šæœ¬</h5><p><strong>æ‰§è¡Œshell</strong></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd admin-core</span><br><span class="line">chmod +x ./build.sh</span><br><span class="line">./build.sh prod $BUILD_NUMBER</span><br></pre></td></tr></table></figure><p><strong>gitlabé…ç½®</strong></p><p>build.sh</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#æ„å»ºæœ‰ç‰ˆæœ¬å·çš„é•œåƒï¼Œä»¥é˜²éœ€è¦å›æ»šï¼Œè€Œä¸”æ˜¯ä»é•œåƒåˆ›å»ºæœåŠ¡</span><br><span class="line">docker build -t registry-vpc.cn-beijing.aliyuncs.com/lepeng-$1/admin-core-$1:$2     . -f Dockerfile_$1</span><br><span class="line">docker push     registry-vpc.cn-beijing.aliyuncs.com/lepeng-$1/admin-core-$1:$2</span><br><span class="line">#æ„å»ºlatestç‰ˆæœ¬ï¼Œç”¨äºè‡ªåŠ¨éƒ¨ç½²</span><br><span class="line">docker build -t registry-vpc.cn-beijing.aliyuncs.com/lepeng-$1/admin-core-$1:latest . -f Dockerfile_$1</span><br><span class="line">docker push     registry-vpc.cn-beijing.aliyuncs.com/lepeng-$1/admin-core-$1:latest</span><br></pre></td></tr></table></figure><p>start.sh</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">JARFILE=/home/App.jar</span><br><span class="line">LOGPATH=/home/logs</span><br><span class="line">LOG=/home/logs/App.log</span><br><span class="line"></span><br><span class="line">#æ—¥å¿—æŒ‚è½½</span><br><span class="line">ip=`ip addr |grep inet |grep eth0|awk &apos;&#123;print $2&#125;&apos; |awk -F &quot;/&quot; &apos;&#123;print $1&#125;&apos;`</span><br><span class="line">mkdir -p /home/log/gzlp_equity/$ip</span><br><span class="line">cd /var/log</span><br><span class="line">ln -s  /home/log/gzlp_equity/$ip java</span><br><span class="line"></span><br><span class="line">if [ ! -d $LOGPATH ];then</span><br><span class="line">   mkdir -p $LOGPATH</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">java -jar -Xms512m -Xmx1024m -Dskywalking.agent.namespace=prod -Dskywalking.agent.service_name=prod-admin-core -javaagent:/home/skywalking-agent-plugins/agent-prod-bj/skywalking-agent.jar $JARFILE -Djava.security.egd=file:/dev/./urandom --spring.profiles.active=$ACTIVE  &gt;&gt; $LOG &amp;</span><br><span class="line"></span><br><span class="line">tail  -100f $LOG</span><br></pre></td></tr></table></figure><p>Dockerfile_prod</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FROM   registry-vpc.cn-beijing.aliyuncs.com/lepeng/centos:latest</span><br><span class="line">MAINTAINER nmk</span><br><span class="line"></span><br><span class="line">COPY  target/admin-core-0.0.1-SNAPSHOT.jar /home/App.jar</span><br><span class="line">COPY  start.sh /home/start.sh</span><br><span class="line">RUN  mkdir /home/tomcat/</span><br><span class="line">RUN chmod +x /home/start.sh</span><br><span class="line">ENV  JAVA_HOME=/usr/local/java</span><br><span class="line">ENV  PATH $JAVA_HOME/bin:$PATH</span><br><span class="line">ENV  CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line">ENV LC_ALL=&quot;en_US.UTF-8&quot;</span><br><span class="line">ENV LANG=&quot;en_US.UTF-8&quot;</span><br><span class="line">ENV ACTIVE=prod</span><br><span class="line"></span><br><span class="line">EXPOSE 48094</span><br><span class="line">CMD [&quot;/home/start.sh&quot;]</span><br></pre></td></tr></table></figure><h5 id="k8sè‡ªåŠ¨éƒ¨ç½²å‰ç«¯è„šæœ¬"><a href="#k8sè‡ªåŠ¨éƒ¨ç½²å‰ç«¯è„šæœ¬" class="headerlink" title="k8sè‡ªåŠ¨éƒ¨ç½²å‰ç«¯è„šæœ¬"></a>k8sè‡ªåŠ¨éƒ¨ç½²å‰ç«¯è„šæœ¬</h5><p><strong>æ‰§è¡Œshell</strong></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd ..</span><br><span class="line">tar zcvf mps-admin-ui.tar mps-admin-ui_tdev</span><br><span class="line">mv mps-admin-ui.tar mps-admin-ui_tdev/docker/</span><br><span class="line">cd mps-admin-ui_tdev/docker/</span><br><span class="line">chmod +x ./build.sh</span><br><span class="line">./build.sh test $BUILD_NUMBER</span><br></pre></td></tr></table></figure><p><strong>gitlabé…ç½®</strong></p><p>Dockerfile_test</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FROM   registry-vpc.cn-beijing.aliyuncs.com/lepeng/nginx:latest</span><br><span class="line">MAINTAINER nmk</span><br><span class="line"></span><br><span class="line">COPY mps-admin-ui.tar /home/mps-admin-ui.tar</span><br><span class="line">RUN mv /usr/local/nginx/conf/nginx.conf /usr/local/nginx/conf/nginx.conf.default</span><br><span class="line">RUN tar zxvf /home/mps-admin-ui.tar -C /home/</span><br><span class="line">RUN mv /home/mps-admin-ui_tdev/docker/nginx.conf /usr/local/nginx/conf/nginx.conf</span><br><span class="line">COPY start.sh /home/start.sh</span><br><span class="line">RUN chmod +x /home/start.sh</span><br><span class="line"></span><br><span class="line">EXPOSE 80</span><br><span class="line">CMD [&quot;/home/start.sh&quot;]</span><br></pre></td></tr></table></figure><p>build.sh</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#æ„å»ºæœ‰ç‰ˆæœ¬å·çš„é•œåƒï¼Œä»¥é˜²éœ€è¦å›æ»šï¼Œè€Œä¸”æ˜¯ä»é•œåƒåˆ›å»ºæœåŠ¡</span><br><span class="line">docker build -t registry-vpc.cn-beijing.aliyuncs.com/lepeng-$1/mps-admin-ui-$1:$2     . -f Dockerfile_$1</span><br><span class="line">docker push     registry-vpc.cn-beijing.aliyuncs.com/lepeng-$1/mps-admin-ui-$1:$2</span><br><span class="line">#æ„å»ºlatestç‰ˆæœ¬ï¼Œç”¨äºè‡ªåŠ¨éƒ¨ç½²</span><br><span class="line">docker build -t registry-vpc.cn-beijing.aliyuncs.com/lepeng-$1/mps-admin-ui-$1:latest . -f Dockerfile_$1</span><br><span class="line">docker push     registry-vpc.cn-beijing.aliyuncs.com/lepeng-$1/mps-admin-ui-$1:latest</span><br></pre></td></tr></table></figure><p>start.sh</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">mv /home/mps-admin-ui_tdev /home/mps-admin-ui</span><br><span class="line">cd /usr/local/nginx</span><br><span class="line">./sbin/nginx</span><br><span class="line">./sbin/nginx -t</span><br><span class="line">echo &quot;nginx Start successfully&quot; &gt;&gt; nginx.log</span><br><span class="line">tail -10f nginx.log</span><br></pre></td></tr></table></figure><p>nginx.conf</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">user nginx nginx;</span><br><span class="line">worker_processes  8;</span><br><span class="line">error_log   logs/error_log;</span><br><span class="line">#error_log  logs/error.log  notice;</span><br><span class="line">#error_log  logs/error.log  info;</span><br><span class="line">pid         /usr/local/nginx/logs/nginx.pid;</span><br><span class="line">worker_rlimit_nofile 51200;</span><br><span class="line">events &#123;</span><br><span class="line">    use epoll;</span><br><span class="line">    worker_connections  51200;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">         server_names_hash_bucket_size 512;</span><br><span class="line">         client_header_buffer_size 512k;</span><br><span class="line">         large_client_header_buffers 4 256k;</span><br><span class="line">         client_max_body_size             100m;</span><br><span class="line">         client_body_buffer_size        10m;</span><br><span class="line">         client_header_timeout     3m;</span><br><span class="line">         client_body_timeout 3m;</span><br><span class="line">         send_timeout             3m;</span><br><span class="line"> server_tokens off;</span><br><span class="line">    sendfile        on;</span><br><span class="line">      #tcp_nopush     on;</span><br><span class="line">      keepalive_timeout 120;</span><br><span class="line">      tcp_nodelay on;</span><br><span class="line">        proxy_buffering on;</span><br><span class="line">    # å¼€å¯gzip</span><br><span class="line">    gzip on;</span><br><span class="line">    # å¯ç”¨gzipå‹ç¼©çš„æœ€å°æ–‡ä»¶ï¼Œå°äºè®¾ç½®å€¼çš„æ–‡ä»¶å°†ä¸ä¼šå‹ç¼©</span><br><span class="line">    gzip_min_length 1k;</span><br><span class="line">    # gzip å‹ç¼©çº§åˆ«ï¼Œ1-10ï¼Œæ•°å­—è¶Šå¤§å‹ç¼©çš„è¶Šå¥½ï¼Œä¹Ÿè¶Šå ç”¨CPUæ—¶é—´ã€‚ä¸€èˆ¬è®¾ç½®1å’Œ2</span><br><span class="line">    gzip_comp_level 2;</span><br><span class="line">    gzip_buffers 4 8k;</span><br><span class="line">    gzip_http_version 1.1;</span><br><span class="line">    # è¿›è¡Œå‹ç¼©çš„æ–‡ä»¶ç±»å‹ã€‚javascriptæœ‰å¤šç§å½¢å¼ã€‚å…¶ä¸­çš„å€¼å¯ä»¥åœ¨ mime.types æ–‡ä»¶ä¸­æ‰¾åˆ°ã€‚</span><br><span class="line">    gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png;</span><br><span class="line">    # æ˜¯å¦åœ¨http headerä¸­æ·»åŠ Vary: Accept-Encodingï¼Œå»ºè®®å¼€å¯</span><br><span class="line">    gzip_vary on;</span><br><span class="line">    # ç¦ç”¨IE 6 gzip</span><br><span class="line">    gzip_disable &quot;MSIE [1-6]\.&quot;;</span><br><span class="line">    #è®¾ç½®ç¼“å­˜è·¯å¾„å¹¶ä¸”ä½¿ç”¨ä¸€å—æœ€å¤§100Mçš„å…±äº«å†…å­˜ï¼Œç”¨äºç¡¬ç›˜ä¸Šçš„æ–‡ä»¶ç´¢å¼•ï¼ŒåŒ…æ‹¬æ–‡ä»¶åå’Œè¯·æ±‚æ¬¡æ•°ï¼Œæ¯ä¸ªæ–‡ä»¶åœ¨1å¤©å†…è‹¥ä¸æ´»è·ƒï¼ˆæ— è¯·æ±‚ï¼‰åˆ™ä»ç¡¬ç›˜ä¸Šæ·˜æ±°ï¼Œç¡¬ç›˜ç¼“å­˜æœ€å¤§10Gï¼Œæ»¡äº†åˆ™æ ¹æ®LRUç®—æ³•è‡ªåŠ¨æ¸…é™¤ç¼“å­˜ã€‚</span><br><span class="line">    proxy_connect_timeout 10;</span><br><span class="line">    proxy_read_timeout 180;</span><br><span class="line">    proxy_send_timeout 5;</span><br><span class="line">    proxy_buffer_size 16k;</span><br><span class="line">    proxy_buffers 4 32k;</span><br><span class="line">    proxy_busy_buffers_size 96k;</span><br><span class="line">    proxy_temp_file_write_size 96k;</span><br><span class="line">    proxy_temp_path /tmp/temp_dir;</span><br><span class="line">    #proxy_cache_path /var/cache/nginx/cache levels=1:2 keys_zone=imgcache:100m inactive=1d max_size=10g;</span><br><span class="line">log_format  main  &apos;[$remote_addr] - [$remote_user] [$time_local] [$request] [$status] [$body_bytes_sent] [$http_referer] [$http_user_agent] [$http_x_forwarded_for] [$request_time] [$upstream_response_time] [$upstream_addr] [$upstream_status]&apos;;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  tdev.gzlplink.com;</span><br><span class="line">                add_header backendIP $upstream_addr;   #æŠŠåç«¯å…·ä½“çš„ upstream è¿”å›ç»™å‰ç«¯ header</span><br><span class="line">                add_header backendCode $upstream_status;</span><br><span class="line">                include proxy.conf;</span><br><span class="line">                access_log /data1/logs/nginx/tdev.gzlplink.com-access_log main;</span><br><span class="line">                error_log /data1/logs/nginx/tdev.gzlplink.com-error_log;</span><br><span class="line">        </span><br><span class="line">        location /mps-admin-ui &#123;</span><br><span class="line">                root /home/;</span><br><span class="line">                index  index.html index.htm;</span><br><span class="line">                if ( -d $request_filename )&#123;</span><br><span class="line">    rewrite ^/(.*)([^/])$ $scheme://$host/$1$2/ permanent;</span><br><span class="line">        &#125;</span><br><span class="line">                log_not_found off;</span><br><span class="line">                # å…³é—­æ—¥å¿—</span><br><span class="line">                access_log off;</span><br><span class="line">                # ç¼“å­˜æ—¶é—´7å¤©</span><br><span class="line">                expires 7d;</span><br><span class="line">                # æŒ‡å®šä¸Šé¢è®¾ç½®çš„ç¼“å­˜åŒºåŸŸ</span><br><span class="line">                #proxy_cache imgcache;</span><br><span class="line">                # ç¼“å­˜è¿‡æœŸç®¡ç†</span><br><span class="line">                proxy_cache_valid 200 302 1d;</span><br><span class="line">                proxy_cache_valid 404 10m;</span><br><span class="line">                proxy_cache_valid any 1h;</span><br><span class="line">                proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="é€šè¿‡jenkinsæ›´æ–°ç”Ÿäº§çš„nginx"><a href="#é€šè¿‡jenkinsæ›´æ–°ç”Ÿäº§çš„nginx" class="headerlink" title="é€šè¿‡jenkinsæ›´æ–°ç”Ÿäº§çš„nginx"></a>é€šè¿‡jenkinsæ›´æ–°ç”Ÿäº§çš„nginx</h5><img src="https://nmk0718.github.io/image/image-20200828165059543.png" alt><img src="https://nmk0718.github.io/image/image-20200824111256188.png" alt><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@iZ2ze18q1ojbig8zevjrbuZ nginx]# cat nginx_reload </span><br><span class="line">#/bin/bash</span><br><span class="line">check_status=&quot;`/usr/local/nginx/sbin/nginx -t  2&gt;&amp;1`&quot;</span><br><span class="line"></span><br><span class="line">if [ $? -eq 0 ]; then</span><br><span class="line">     #echo &quot;nginx configure file ok&quot;</span><br><span class="line">     echo $check_status</span><br><span class="line">    /usr/local/nginx/sbin/nginx  -s reload</span><br><span class="line">else</span><br><span class="line">    #echo &quot;nginx configure file failed&quot;</span><br><span class="line">    echo $check_stutus</span><br><span class="line">exit    </span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h5 id="jenkins-newmanå®ç°æ¥å£æµ‹è¯•"><a href="#jenkins-newmanå®ç°æ¥å£æµ‹è¯•" class="headerlink" title="jenkins+newmanå®ç°æ¥å£æµ‹è¯•"></a>jenkins+newmanå®ç°æ¥å£æµ‹è¯•</h5><p>å®‰è£…newman</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@public-service jenkins]# npm install -g newman</span><br><span class="line">npm WARN deprecated har-validator@5.1.5: this library is no longer supported</span><br><span class="line">npm WARN deprecated uuid@3.4.0: Please upgrade  to version 7 or higher.  Older versions may use Math.random() in certain circumstances, which is known to be problematic.  See https://v8.dev/blog/math-random for details.</span><br><span class="line">/home/.npm-global/bin/newman -&gt; /home/.npm-global/lib/node_modules/newman/bin/newman.js</span><br><span class="line">+ newman@5.2.4</span><br><span class="line">added 128 packages from 187 contributors in 20.745s</span><br><span class="line">[root@public-service jenkins]# newman -v</span><br><span class="line">5.2.4</span><br></pre></td></tr></table></figure><p>é€šè¿‡postmanç”Ÿæˆjsonæ–‡ä»¶</p><img src="https://nmk0718.github.io/image/image-20210629094214541.png" alt><p>é€šè¿‡newmanè¯·æ±‚è¯¥æ¥å£è¿›è¡Œæµ‹è¯•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@public-service jenkins]# newman run -r cli test.postman_collection.json </span><br><span class="line">newman: could not find &quot;html&quot; reporter</span><br><span class="line">  ensure that the reporter is installed in the same directory as newman</span><br><span class="line">  run `npm install newman-reporter-html`</span><br><span class="line"></span><br><span class="line">newman</span><br><span class="line"></span><br><span class="line">test</span><br><span class="line"></span><br><span class="line">â†’ https://test.com/doctor-api/v2_0/optimalmall/getProduct</span><br><span class="line">  POST https://test.com/doctor-api/v2_0/optimalmall/getProduct [200 OK, 5.84KB, 868ms]</span><br><span class="line"></span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚                         â”‚           executed â”‚            failed â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚              iterations â”‚                  1 â”‚                 0 â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚                requests â”‚                  1 â”‚                 0 â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚            test-scripts â”‚                  0 â”‚                 0 â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚      prerequest-scripts â”‚                  0 â”‚                 0 â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚              assertions â”‚                  0 â”‚                 0 â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ total run duration: 892ms                                        â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ total data received: 5.47KB (approx)                             â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ average response time: 868ms [min: 868ms, max: 868ms, s.d.: 0Âµs] â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><p>newmanå‘½ä»¤</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">newman run  ç”¨ä¾‹jsonæ–‡ä»¶è·¯å¾„</span><br><span class="line">-e ç¯å¢ƒå˜é‡æ–‡ä»¶åœ°å€</span><br><span class="line">-g å…¨å±€å˜é‡æ–‡ä»¶åœ°å€</span><br><span class="line">--delay-request è¯·æ±‚é—´çš„delayæ—¶é•¿ï¼Œå•ä½ä¸ºæ¯«ç§’</span><br><span class="line">--folder æ–‡ä»¶å¤¹è·¯å¾„ï¼Œè¿è¡ŒæŒ‡å®šæ–‡ä»¶å¤¹ä¸‹çš„ç”¨ä¾‹</span><br><span class="line">-n,--iteration-count numberï¼Œcollectionæ‰§è¡Œçš„æ¬¡æ•°</span><br><span class="line">--export-environment pathï¼Œæ‰§è¡Œç”¨ä¾‹åå°†ç¯å¢ƒå˜é‡å¯¼å‡º</span><br><span class="line">--export-globals  pathï¼Œæ‰§è¡Œç”¨ä¾‹åå°†å…¨å±€å˜é‡å¯¼å‡º</span><br></pre></td></tr></table></figure><p>å¯¼å‡ºæŠ¥å‘Š</p><p>Cli</p><p>åœ¨consoleä¸­ç”ŸæˆæŠ¥å‘Š</p><img src="https://nmk0718.github.io/image/image-20210629094559461.png" alt><p>HTML</p><p>ä½œä¸ºä¸€ç§externalæŠ¥å‘Šæ–¹å¼ï¼Œhtml reporteréœ€è¦å®‰è£…ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install -g newman-reporter-html</span><br><span class="line"></span><br><span class="line">[root@public-service jenkins]# newman run test.postman_collection.json  -r html</span><br><span class="line">[root@public-service jenkins]# cd newman/</span><br><span class="line">[root@public-service newman]# ls</span><br><span class="line">newman-run-report-2021-06-29-01-35-46-951-0.html</span><br></pre></td></tr></table></figure><img src="https://nmk0718.github.io/image/image-20210629094719897.png" alt>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;Jenkinsæ˜¯ä»€ä¹ˆï¼Ÿ&quot;&gt;&lt;a href=&quot;#Jenkinsæ˜¯ä»€ä¹ˆï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;Jenkinsæ˜¯ä»€ä¹ˆï¼Ÿ&quot;&gt;&lt;/a&gt;Jenkinsæ˜¯ä»€ä¹ˆï¼Ÿ&lt;/h4&gt;&lt;p&gt;Jenkinsæ˜¯ä¸€ä¸ªå¼€æºçš„ã€å¯æ‰©å±•çš„æŒç»­é›†æˆã€äº¤ä»˜ã€éƒ¨ç½²ï¼ˆè½¯ä»¶/ä»£ç </summary>
      
    
    
    
    
    <category term="Jenkins" scheme="https://nmk0718.github.io/tag/Jenkins/"/>
    
  </entry>
  
  <entry>
    <title>Flutter</title>
    <link href="https://nmk0718.github.io/2021/03/27/Flutter/"/>
    <id>https://nmk0718.github.io/2021/03/27/Flutter/</id>
    <published>2021-03-27T06:50:00.000Z</published>
    <updated>2024-11-29T06:43:24.921Z</updated>
    
    <content type="html"><![CDATA[<h5 id="å®‰å…¨åŒºåŸŸ"><a href="#å®‰å…¨åŒºåŸŸ" class="headerlink" title="å®‰å…¨åŒºåŸŸ"></a>å®‰å…¨åŒºåŸŸ</h5><p>å½“ç›´æ¥ä½¿ç”¨å°éƒ¨ä»¶æ—¶ä¼šå‡ºç°åœ¨å·¦ä¸Šè§’çš„çŠ¶æ€æ é™„è¿‘</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import &apos;package:flutter/material.dart&apos;;</span><br><span class="line"></span><br><span class="line">void main() &#123;</span><br><span class="line">  runApp(</span><br><span class="line">    MaterialApp(</span><br><span class="line">      home: Scaffold(</span><br><span class="line">        backgroundColor: Colors.teal,</span><br><span class="line">        body: Container(</span><br><span class="line">          child: Text(&quot;Hello,nmk&quot;),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    ),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="\image\image-20210306164220893.png"><p>ä½¿ç”¨Safearedè¿›è¡Œæ‘†æ”¾åˆ°å®‰å…¨åŒºåŸŸ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import &apos;package:flutter/material.dart&apos;;</span><br><span class="line"></span><br><span class="line">void main() &#123;</span><br><span class="line">  runApp(</span><br><span class="line">    MaterialApp(</span><br><span class="line">      home: Scaffold(</span><br><span class="line">        backgroundColor: Colors.teal,</span><br><span class="line">        body: SafeArea(</span><br><span class="line">          child: Container(</span><br><span class="line">            child: Text(&quot;Hello,nmk&quot;),</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    ),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="\image\image-20210306164517482.png"><p>åœ†å½¢æ§ä»¶</p><p>å¯å±•ç¤ºç”¨æˆ·å¤´åƒ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">                child: CircleAvatar(</span><br><span class="line">                  radius: 50.0,</span><br><span class="line">                  backgroundImage:</span><br><span class="line">                      NetworkImage(&apos;https://s3.ax1x.com/2021/03/02/6FUzNt.jpg&apos;),</span><br><span class="line">                ),</span><br><span class="line">NetworkImage ç½‘ç»œåŠ è½½</span><br><span class="line">AssetImage æœ¬åœ°åŠ è½½</span><br></pre></td></tr></table></figure><p>æ•ˆæœå›¾</p><img src="\image\image-20210306172349708.png"><h5 id="æ–‡æœ¬æ ·å¼"><a href="#æ–‡æœ¬æ ·å¼" class="headerlink" title="æ–‡æœ¬æ ·å¼"></a>æ–‡æœ¬æ ·å¼</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Text(</span><br><span class="line">  &quot;FlUTTER DEVELOPER&quot;,</span><br><span class="line">  style: TextStyle(</span><br><span class="line">      fontFamily: &apos;SourceSansPro&apos;,</span><br><span class="line">      color: Colors.white,</span><br><span class="line">      fontSize: 20,</span><br><span class="line">      letterSpacing: 2.5,</span><br><span class="line">      fontWeight: FontWeight.bold),</span><br><span class="line">      textAlign: TextAlign.left,</span><br><span class="line">),</span><br></pre></td></tr></table></figure><p><code>color</code>: æ–‡å­—é¢œè‰²</p><p><code>fontStyle</code>: æ–‡å­—æ ·å¼  æ–œä½“å’Œæ­£å¸¸</p><p><code>fontWeight</code>: å­—ä½“ç²—ç»†  ç²—ä½“å’Œæ­£å¸¸</p><p><code>letterSpacing</code>: å­—æ¯é—´éš™(è´Ÿå€¼å¯ä»¥è®©å­—æ¯æ›´ç´§å‡‘)</p><p><code>textAlign</code>ï¼šæ–‡æœ¬çš„å¯¹é½æ–¹å¼ï¼›å¯ä»¥é€‰æ‹©å·¦å¯¹é½ã€å³å¯¹é½è¿˜æ˜¯å±…ä¸­ã€‚</p><p><code>height</code>ï¼šè¯¥å±æ€§ç”¨äºæŒ‡å®šè¡Œé«˜ï¼Œä½†å®ƒå¹¶ä¸æ˜¯ä¸€ä¸ªç»å¯¹å€¼ï¼Œè€Œæ˜¯ä¸€ä¸ªå› å­ï¼Œå…·ä½“çš„è¡Œé«˜ç­‰äº<code>fontSize</code>*<code>height</code>ã€‚</p><p><code>fontFamily</code> ï¼šæŒ‡å®šå­—ä½“,ç”±äºä¸åŒå¹³å°é»˜è®¤æ”¯æŒçš„å­—ä½“é›†ä¸åŒï¼Œæ‰€ä»¥åœ¨æ‰‹åŠ¨æŒ‡å®šå­—ä½“æ—¶ä¸€å®šè¦å…ˆåœ¨ä¸åŒå¹³å°æµ‹è¯•ä¸€ä¸‹ã€‚</p><p><code>fontSize</code>ï¼šè¯¥å±æ€§å’ŒTextçš„<code>textScaleFactor</code>éƒ½ç”¨äºæ§åˆ¶å­—ä½“å¤§å°ã€‚ä½†æ˜¯æœ‰ä¸¤ä¸ªä¸»è¦åŒºåˆ«ï¼š</p><ul><li><code>fontSize</code>å¯ä»¥ç²¾ç¡®æŒ‡å®šå­—ä½“å¤§å°ï¼Œè€Œ<code>textScaleFactor</code>åªèƒ½é€šè¿‡ç¼©æ”¾æ¯”ä¾‹æ¥æ§åˆ¶ã€‚</li><li><code>textScaleFactor</code>ä¸»è¦æ˜¯ç”¨äºç³»ç»Ÿå­—ä½“å¤§å°è®¾ç½®æ”¹å˜æ—¶å¯¹Flutteråº”ç”¨å­—ä½“è¿›è¡Œå…¨å±€è°ƒæ•´ï¼Œè€Œ<code>fontSize</code>é€šå¸¸ç”¨äºå•ä¸ªæ–‡æœ¬ï¼Œå­—ä½“å¤§å°ä¸ä¼šè·Ÿéšç³»ç»Ÿå­—ä½“å¤§å°å˜åŒ–ã€‚</li></ul><p><code>maxLines</code>ã€<code>overflow</code>ï¼šæŒ‡å®šæ–‡æœ¬æ˜¾ç¤ºçš„æœ€å¤§è¡Œæ•°ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ–‡æœ¬æ˜¯è‡ªåŠ¨æŠ˜è¡Œçš„ï¼Œå¦‚æœæŒ‡å®šæ­¤å‚æ•°ï¼Œåˆ™æ–‡æœ¬æœ€å¤šä¸ä¼šè¶…è¿‡æŒ‡å®šçš„è¡Œã€‚å¦‚æœæœ‰å¤šä½™çš„æ–‡æœ¬ï¼Œå¯ä»¥é€šè¿‡<code>overflow</code>æ¥æŒ‡å®šæˆªæ–­æ–¹å¼ï¼Œé»˜è®¤æ˜¯ç›´æ¥æˆªæ–­ TextOverflow.clipå‰ªè£   TextOverflow.fade æ¸éš  TextOverflow.ellipsisçœç•¥å·</p><p><code>textScaleFactor</code>ï¼šä»£è¡¨æ–‡æœ¬ç›¸å¯¹äºå½“å‰å­—ä½“å¤§å°çš„ç¼©æ”¾å› å­ï¼Œç›¸å¯¹äºå»è®¾ç½®æ–‡æœ¬çš„æ ·å¼<code>style</code>å±æ€§çš„<code>fontSize</code>ï¼Œå®ƒæ˜¯è°ƒæ•´å­—ä½“å¤§å°çš„ä¸€ä¸ªå¿«æ·æ–¹å¼ã€‚è¯¥å±æ€§çš„é»˜è®¤å€¼å¯ä»¥é€šè¿‡<code>MediaQueryData.textScaleFactor</code>è·å¾—ï¼Œå¦‚æœæ²¡æœ‰<code>MediaQuery</code>ï¼Œé‚£ä¹ˆä¼šé»˜è®¤å€¼å°†ä¸º1.0ã€‚</p><h5 id="æ·»åŠ å­—ä½“"><a href="#æ·»åŠ å­—ä½“" class="headerlink" title="æ·»åŠ å­—ä½“"></a>æ·»åŠ å­—ä½“</h5><p>å¯ä»¥åœ¨Flutteråº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ä¸åŒçš„å­—ä½“ã€‚ä¾‹å¦‚ï¼Œ<a href="https://fonts.google.com/" target="_blank" rel="noopener">Google Fonts (opens new window)</a>ä¸­çš„å­—ä½“ã€‚</p><p>åœ¨Flutterä¸­ä½¿ç”¨å­—ä½“åˆ†ä¸¤æ­¥å®Œæˆã€‚é¦–å…ˆåœ¨<code>pubspec.yaml</code>ä¸­å£°æ˜å®ƒä»¬ï¼Œä»¥ç¡®ä¿å®ƒä»¬ä¼šæ‰“åŒ…åˆ°åº”ç”¨ç¨‹åºä¸­ã€‚ç„¶åé€šè¿‡<a href="https://docs.flutter.io/flutter/painting/TextStyle-class.html" target="_blank" rel="noopener"><code>TextStyle</code> (opens new window)</a>å±æ€§ä½¿ç”¨å­—ä½“ã€‚</p><h5 id="åœ¨assetä¸­å£°æ˜"><a href="#åœ¨assetä¸­å£°æ˜" class="headerlink" title="åœ¨assetä¸­å£°æ˜"></a>åœ¨assetä¸­å£°æ˜</h5><p>è¦å°†å­—ä½“æ–‡ä»¶æ‰“åŒ…åˆ°åº”ç”¨ä¸­ï¼Œå’Œä½¿ç”¨å…¶å®ƒèµ„æºä¸€æ ·ï¼Œè¦å…ˆåœ¨<code>pubspec.yaml</code>ä¸­å£°æ˜å®ƒã€‚ç„¶åå°†å­—ä½“æ–‡ä»¶å¤åˆ¶åˆ°åœ¨<code>pubspec.yaml</code>ä¸­æŒ‡å®šçš„ä½ç½®ã€‚å¦‚ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">flutter:</span></span><br><span class="line">  <span class="attr">fonts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">family:</span> <span class="string">Pacifico</span></span><br><span class="line">    <span class="attr">fonts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">asset:</span> <span class="string">fonts/Pacifico-Regular.ttf</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">family:</span> <span class="string">SourceSansPro</span></span><br><span class="line">    <span class="attr">fonts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">asset:</span> <span class="string">fonts/SourceSansPro-Regular.ttf</span></span><br></pre></td></tr></table></figure><h5 id="ä½¿ç”¨å­—ä½“"><a href="#ä½¿ç”¨å­—ä½“" class="headerlink" title="ä½¿ç”¨å­—ä½“"></a>ä½¿ç”¨å­—ä½“</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Text(</span><br><span class="line">  <span class="string">"FlUTTER DEVELOPER"</span>,</span><br><span class="line">  style: TextStyle(</span><br><span class="line">      fontFamily: <span class="string">'SourceSansPro'</span>,</span><br><span class="line">),</span><br></pre></td></tr></table></figure><h5 id="æ·»åŠ æ°´å¹³æ¨ªçº¿"><a href="#æ·»åŠ æ°´å¹³æ¨ªçº¿" class="headerlink" title="æ·»åŠ æ°´å¹³æ¨ªçº¿"></a>æ·»åŠ æ°´å¹³æ¨ªçº¿</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SizedBox(</span><br><span class="line">    height: 20.0,</span><br><span class="line">    width: 180.0,</span><br><span class="line">    child: Divider(</span><br><span class="line">      color: Colors.teal.shade100,</span><br><span class="line">    )),</span><br></pre></td></tr></table></figure><h5 id="æ›´æ”¹å›¾æ ‡æ–‡ä»¶"><a href="#æ›´æ”¹å›¾æ ‡æ–‡ä»¶" class="headerlink" title="æ›´æ”¹å›¾æ ‡æ–‡ä»¶"></a>æ›´æ”¹å›¾æ ‡æ–‡ä»¶</h5><p><a href="https://www.iconfont.cn/æŸ¥æ‰¾åˆ°å–œæ¬¢çš„å›¾æ ‡" target="_blank" rel="noopener">https://www.iconfont.cn/æŸ¥æ‰¾åˆ°å–œæ¬¢çš„å›¾æ ‡</a></p><p><a href="https://appicon.co/" target="_blank" rel="noopener">https://appicon.co/</a> æŠŠå›¾æ ‡ç”Ÿæˆä¸ºioså’Œandroidå¯ä»¥ä½¿ç”¨çš„å›¾æ ‡æ–‡ä»¶</p><h5 id="Expanded"><a href="#Expanded" class="headerlink" title="Expanded"></a>Expanded</h5><p>Expandedæ˜¯ç”¨äºå±•å¼€<code>Row</code>ï¼Œ<code>Column</code>æˆ–<code>Flex</code>çš„å­<code>child</code>çš„Widgetã€‚ </p><p>ä½¿ç”¨<code>Expanded</code>å¯ä»¥ä½¿[Row]ï¼Œ[Column]æˆ–[Flex]çš„å­é¡¹æ‰©å±•ä»¥å¡«å……ä¸»è½´ä¸­çš„å¯ç”¨ç©ºé—´ï¼ˆä¾‹å¦‚ï¼Œæ°´å¹³ç”¨[Row]æˆ–å‚ç›´ç”¨[Column]ï¼‰ã€‚ </p><p>å¦‚æœæ‰©å±•äº†å¤šä¸ªå­èŠ‚ç‚¹ï¼Œåˆ™æ ¹æ®<code>[flex]</code>å› å­å°†å¯ç”¨ç©ºé—´åˆ’åˆ†ä¸ºå¤šä¸ªå­èŠ‚ç‚¹ã€‚</p><p> [Expanded]å°éƒ¨ä»¶å¿…é¡»æ˜¯[Row]ï¼Œ[Column]æˆ–[Flex]çš„åä»£ï¼Œå¹¶ä¸”ä»[Expanded]å°éƒ¨ä»¶åˆ°å…¶å°é—­çš„[Row]ï¼Œ[Column]æˆ–[Flex]çš„è·¯å¾„å¿…é¡»åŒ…å« åªæœ‰[StatelessWidget]æˆ–[StatefulWidget]</p><p>æ„é€ å‡½æ•°</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">const Expanded(&#123;</span><br><span class="line">    Key key,</span><br><span class="line">    int flex = 1,</span><br><span class="line">    @required Widget child,</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><ul><li>flex åˆ†é…ç©ºé—´çš„å¼¹æ€§ç³»æ•°ï¼Œ<code>Row</code>ï¼Œ<code>Column</code>æˆ–<code>Flex</code>çš„æ¯ä¸ªExpandedçš„flexæ„æˆç©ºé—´åˆ†é…çš„æ¯”ä¾‹ï¼Œé»˜è®¤<code>int flex = 1</code></li><li>child å³éœ€è¦åˆ†é…çš„å­Widget</li></ul><p>ç¤ºä¾‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Expanded(</span><br><span class="line">  child: FlatButton(</span><br><span class="line">    color: Colors.red,</span><br><span class="line">    onPressed: () &#123;&#125;,</span><br><span class="line">  ),</span><br><span class="line">),</span><br><span class="line">Expanded(</span><br><span class="line">  child: FlatButton(</span><br><span class="line">    color: Colors.orange,</span><br><span class="line">    onPressed: () &#123;&#125;,</span><br><span class="line">  ),</span><br><span class="line">),</span><br></pre></td></tr></table></figure><p>é»˜è®¤flexä¸º1 æ‰€ä»¥é¢œè‰²æŒ‰æ¯”ä¾‹1:1åˆ†é…</p><img src="\image\image-20210316181002701.png" alt="image-20210316181002701" style="zoom:50%;"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Expanded(</span><br><span class="line">  flex: 2,</span><br><span class="line">  child: FlatButton(</span><br><span class="line">    color: Colors.red,</span><br><span class="line">    onPressed: () &#123;&#125;,</span><br><span class="line">  ),</span><br><span class="line">),</span><br><span class="line">Expanded(</span><br><span class="line">  child: FlatButton(</span><br><span class="line">    color: Colors.orange,</span><br><span class="line">    onPressed: () &#123;&#125;,</span><br><span class="line">  ),</span><br><span class="line">),</span><br></pre></td></tr></table></figure><p>é»˜è®¤flexä¸º2 æ‰€ä»¥é¢œè‰²æŒ‰æ¯”ä¾‹2:1åˆ†é…</p><img src="\image\image-20210316181208812.png" alt="image-20210316181208812" style="zoom50%;"><h5 id="å†…è¾¹è·"><a href="#å†…è¾¹è·" class="headerlink" title="å†…è¾¹è·"></a>å†…è¾¹è·</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">padding: EdgeInsets.only(left: 12,top: 12,bottom: 12),</span><br></pre></td></tr></table></figure><h5 id="å¤–è¾¹è·"><a href="#å¤–è¾¹è·" class="headerlink" title="å¤–è¾¹è·"></a>å¤–è¾¹è·</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">margin: EdgeInsets.only(top:4),</span><br></pre></td></tr></table></figure><h5 id="flutterå†…å®¹è¶…å‡ºå±å¹•"><a href="#flutterå†…å®¹è¶…å‡ºå±å¹•" class="headerlink" title="flutterå†…å®¹è¶…å‡ºå±å¹•"></a>flutterå†…å®¹è¶…å‡ºå±å¹•</h5><p>ç¼–å†™flutterä»£ç çš„æ—¶å€™ï¼Œå¦‚æœè¶…å‡ºæ‰‹æœºå±å¹•é«˜åº¦çš„è¯æ˜¯ä¼šå‡ºé”™çš„ï¼Œéœ€è¦ä½¿ç”¨SingleChildScrollViewæ¥åŒ…è£¹</p><p>SingleChildScrollViewå’Œcontainerç”¨å‘ä¸€æ ·ï¼Œ ç›´æ¥åŒ…åœ¨å¤–å±‚å°±å¥½äº†ï¼Œé‡Œé¢æ˜¯childâ€™<br>å®ƒå¯ä»¥åœ¨ä¸»é¢˜å†…å®¹è¶…å‡ºYè½´çš„æ—¶å€™è‡ªåŠ¨ç”Ÿæˆæ»šåŠ¨æ¡ï¼Œç±»ä¼¼overflowï¼šauto<br>ç±»ä¼¼å¦‚ä¸‹ç”¨æ³•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">return SingleChildScrollView(</span><br><span class="line">child: Container(</span><br><span class="line">child .....</span><br><span class="line">)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>è¿›å…¥flutter_appçš„android&gt;app&gt;src&gt;main&gt;resç›®å½•</p><img src="\image\image-20210303180252077.png" alt="image-20210303180252077" style="zoom:50%;"><h5 id="æµ®åŠ¨æŒ‰é’®"><a href="#æµ®åŠ¨æŒ‰é’®" class="headerlink" title="æµ®åŠ¨æŒ‰é’®"></a>æµ®åŠ¨æŒ‰é’®</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">return Scaffold(</span><br><span class="line">  floatingActionButton: FloatingActionButton(</span><br><span class="line">    child: IconButton(icon: Icon(Icons.add),onPressed: ()&#123;&#125;,),</span><br><span class="line">  ),</span><br><span class="line">  floatingActionButtonLocation: FloatingActionButtonLocation.centerDocked,</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>å†™åœ¨scaffoldçš„é‡Œé¢</p><p>é€šè¿‡floatingActionButtonLocation: FloatingActionButtonLocation.æ¥æ§åˆ¶æµ®åŠ¨çš„ä½ç½®</p><h5 id="routes"><a href="#routes" class="headerlink" title="routes"></a>routes</h5><p>é»˜è®¤é¡µé¢çš„ä¸‰ç§æ–¹å¼</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ç¬¬ä¸€ç§æ–¹å¼:</span><br><span class="line">routes: &#123;</span><br><span class="line">          &apos;/&apos;: (context) =&gt; home(),</span><br><span class="line">        &#125;,</span><br><span class="line">ç¬¬äºŒç§æ–¹å¼:</span><br><span class="line">home: home(),</span><br><span class="line">ç¬¬ä¸‰ç§æ–¹å¼:</span><br><span class="line">        initialRoute: &apos;/home&apos;,</span><br></pre></td></tr></table></figure><h5 id="ListTitle"><a href="#ListTitle" class="headerlink" title="ListTitle"></a>ListTitle</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">const ListTile(&#123;</span><br><span class="line">    Key key,</span><br><span class="line">    this.leading, //å·¦ä¾§çš„ç»„ä»¶</span><br><span class="line">    this.title, //ä¸­é—´çš„ä¸»æ ‡é¢˜</span><br><span class="line">    this.subtitle, //ä¸­é—´çš„å‰¯æ ‡é¢˜</span><br><span class="line">    this.trailing, //å³ä¾§ç»„ä»¶ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªå€¼æˆ–è€…ä¸€ä¸ªå›¾æ ‡</span><br><span class="line">    this.isThreeLine = false, //æ˜¯å¦æ˜¾ç¤ºä¸‰è¡Œ</span><br><span class="line">    this.dense, //æ˜¯å¦ä»¥å‚ç›´å¯†é›†çš„æ–¹å¼æ˜¾ç¤ºï¼Œè¿™æ ·æ–‡å­—ä¼šæ›´å°</span><br><span class="line">    this.visualDensity,</span><br><span class="line">    this.shape, //å®šä¹‰å¤–è§‚å½¢çŠ¶</span><br><span class="line">    this.contentPadding, //å†…å®¹ä¸è¾¹æ¡†ä¹‹é—´çš„è¾¹è·ï¼Œé»˜è®¤16</span><br><span class="line">    this.enabled = true, //æ˜¯å¦å¯ä»¥äº’åŠ¨äº‹ä»¶</span><br><span class="line">    this.onTap, //ç‚¹å‡»äº‹ä»¶</span><br><span class="line">    this.onLongPress, //é•¿æŒ‰äº‹ä»¶</span><br><span class="line">    this.mouseCursor, //é¼ æ ‡æ‚¬åœåœ¨ListTileä¸Šæ—¶çš„å¤„ç†æ•ˆæœï¼Œç»™webç”¨çš„</span><br><span class="line">    this.selected = false, //å¦‚æœæ˜¯trueï¼Œæ–‡æœ¬å’Œå›¾æ ‡å°†ä¼šä»¥ç›¸åŒçš„é¢œè‰²å‘ˆç°</span><br><span class="line">    this.focusColor, </span><br><span class="line">    this.hoverColor, //æŒ‡é’ˆæ‚¬åœåœ¨ListTileä¸Šçš„é¢œè‰²</span><br><span class="line">    this.focusNode, //èšç„¦äº‹ä»¶</span><br><span class="line">    this.autofocus = false, //æ˜¯å¦é»˜è®¤èšç„¦</span><br><span class="line">    this.tileColor, //listTileçš„èƒŒæ™¯é¢œè‰²ï¼Œselected=falseæ—¶ç”Ÿæ•ˆ</span><br><span class="line">    this.selectedTileColor, //listTileçš„èƒŒæ™¯é¢œè‰²ï¼Œselected=trueæ—¶ç”Ÿæ•ˆ</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><h5 id="æ–¹æ³•"><a href="#æ–¹æ³•" class="headerlink" title="æ–¹æ³•"></a>æ–¹æ³•</h5><p> å®šä¹‰æ²¡æœ‰è¿”å›å€¼çš„æ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">void name ()&#123;&#125;;</span><br></pre></td></tr></table></figure><p>å®šä¹‰æœ‰è¿”å›å€¼çš„æ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">String name()&#123;</span><br><span class="line">return abc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int name()&#123;</span><br><span class="line">return 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bool name()&#123;</span><br><span class="line">return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="flutterå¯¼èˆª"><a href="#flutterå¯¼èˆª" class="headerlink" title="flutterå¯¼èˆª"></a>flutterå¯¼èˆª</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Navigator.push(context, MaterialPageRoute(builder: (context)&#123;return InputPage();&#125;,));</span><br><span class="line">#pushå¯¼èˆªåˆ°æ–°çš„é¡µé¢</span><br><span class="line"></span><br><span class="line">Navigator.pop(context);</span><br><span class="line">#popé”€æ¯å½“å‰é¡µé¢</span><br><span class="line"></span><br><span class="line">Navigator.pushNamed(context, &apos;/&apos;);</span><br><span class="line">#pushNamedé€šè¿‡è·¯ç”±åè¿›è¡Œå¯¼èˆª</span><br></pre></td></tr></table></figure><h5 id="æ ¹æ®è®¾å¤‡ç±»å‹æ˜¾ç¤ºä¸åŒå°éƒ¨ä»¶"><a href="#æ ¹æ®è®¾å¤‡ç±»å‹æ˜¾ç¤ºä¸åŒå°éƒ¨ä»¶" class="headerlink" title="æ ¹æ®è®¾å¤‡ç±»å‹æ˜¾ç¤ºä¸åŒå°éƒ¨ä»¶"></a>æ ¹æ®è®¾å¤‡ç±»å‹æ˜¾ç¤ºä¸åŒå°éƒ¨ä»¶</h5><p>æ–¹æ³•ä¸€</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å¼•å…¥åŒ…</span><br><span class="line">import &apos;dart:io&apos;;</span><br><span class="line"></span><br><span class="line">é€šè¿‡ifè¿›è¡Œåˆ¤æ–­è®¾å¤‡è¿”å›ä¸åŒå°éƒ¨ä»¶</span><br><span class="line">Widget getPicker() &#123;</span><br><span class="line">    if (Platform.isIOS) &#123;</span><br><span class="line">      return iosPicker();</span><br><span class="line">    &#125; else if (Platform.isAndroid) &#123;</span><br><span class="line">      return androidDorpdown();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">è°ƒç”¨è¯¥æ–¹æ³•</span><br><span class="line">          Container(</span><br><span class="line">              height: 100.0,</span><br><span class="line">              alignment: Alignment.center,</span><br><span class="line">              color: Colors.lightBlue,</span><br><span class="line">              child: getPicker()),</span><br></pre></td></tr></table></figure><p>æ–¹æ³•äºŒ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Container(</span><br><span class="line">  height: 120.0,</span><br><span class="line">  alignment: Alignment.center,</span><br><span class="line">  padding: EdgeInsets.only(bottom: 30.0),</span><br><span class="line">  color: Colors.lightBlue,</span><br><span class="line">  child: Platform.isIOS ? iosPicker() : androidDorpdown(),</span><br><span class="line">),</span><br></pre></td></tr></table></figure><h5 id="importä¸­çš„å«ä¹‰"><a href="#importä¸­çš„å«ä¹‰" class="headerlink" title="importä¸­çš„å«ä¹‰"></a>importä¸­çš„å«ä¹‰</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import &apos;dart:io&apos; show Platform;</span><br><span class="line">åªå¯¼å…¥Platform</span><br><span class="line">import &apos;dart:io&apos; hide Platform;</span><br><span class="line">é™¤äº†Platforméƒ½å¯¼å…¥</span><br><span class="line">import &apos;dart:io&apos; as http;</span><br><span class="line">è®²åº“é‡å‘½åé¿å…å†²çª</span><br></pre></td></tr></table></figure><h5 id="è°ƒç”¨é”®ç›˜æ—¶å‡ºç°é»„æ¡-ç©ºé—´ä¸å¤Ÿ"><a href="#è°ƒç”¨é”®ç›˜æ—¶å‡ºç°é»„æ¡-ç©ºé—´ä¸å¤Ÿ" class="headerlink" title="è°ƒç”¨é”®ç›˜æ—¶å‡ºç°é»„æ¡ ç©ºé—´ä¸å¤Ÿ"></a>è°ƒç”¨é”®ç›˜æ—¶å‡ºç°é»„æ¡ ç©ºé—´ä¸å¤Ÿ</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">åŠ å…¥Flexible</span><br><span class="line"></span><br><span class="line">              Flexible(</span><br><span class="line">                child: Hero(</span><br><span class="line">                  tag: &apos;logo&apos;,</span><br><span class="line">                  child: Container(</span><br><span class="line">                    height: 200.0,</span><br><span class="line">                    child: Image.asset(&apos;images/logo.png&apos;),</span><br><span class="line">                  ),</span><br><span class="line">                ),</span><br><span class="line">              ),</span><br></pre></td></tr></table></figure><p>ä¼šåœ¨è°ƒç”¨é”®ç›˜æ—¶ ç¼©å°è¯¥Widget</p><h4 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h4><h4 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a>iOS</h4><p><strong>Cupertinoé£æ ¼</strong></p><h5 id="CupertinoActivityIndicator"><a href="#CupertinoActivityIndicator" class="headerlink" title="CupertinoActivityIndicator"></a>CupertinoActivityIndicator</h5><table><thead><tr><th>åŠ è½½ä¸­ç»„ä»¶</th><th></th></tr></thead><tbody><tr><td>radius</td><td>é»˜è®¤10 åŠ è½½å›¾å½¢çš„åŠå¾„å€¼</td></tr><tr><td>animating</td><td>é»˜è®¤true æ˜¯å¦æ’­æ”¾åŠ è½½åŠ¨ç”»</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">CupertinoActivityIndicator(</span><br><span class="line">            animating: <span class="literal">true</span>,</span><br><span class="line">            radius: 10.0,</span><br><span class="line">          )</span><br></pre></td></tr></table></figure><h5 id="CupertinoAlertDialog"><a href="#CupertinoAlertDialog" class="headerlink" title="CupertinoAlertDialog"></a>CupertinoAlertDialog</h5><table><thead><tr><th>å¯¹è¯æ¡†</th><th></th></tr></thead><tbody><tr><td>action: List</td><td>å¯¹è¯æ¡†åº•éƒ¨æŒ‰é’®</td></tr><tr><td>title</td><td>æ ‡é¢˜</td></tr><tr><td>content</td><td>å†…å®¹</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_MyHomePageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">MyHomePage</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">_showIOSDialog</span><span class="params">(BuildContext cxt)</span> </span>&#123;</span><br><span class="line">    showCupertinoDialog&lt;<span class="keyword">int</span>&gt;(</span><br><span class="line">        context: cxt,</span><br><span class="line">        builder: (cxt) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> CupertinoAlertDialog(</span><br><span class="line">            title: Text(<span class="string">'æç¤º'</span>),</span><br><span class="line">            content: Text(<span class="string">'æ˜¯å¦é€€å‡ºåº”ç”¨'</span>),</span><br><span class="line">            actions: &lt;Widget&gt;[</span><br><span class="line">              <span class="keyword">new</span> Container(</span><br><span class="line">                decoration: BoxDecoration(</span><br><span class="line">                    border: Border(</span><br><span class="line">                        right: BorderSide(color: Color(<span class="number">0xFFD9D9D9</span>), width: <span class="number">0.5</span>),</span><br><span class="line">                        top: BorderSide(color: Color(<span class="number">0xFFD9D9D9</span>), width: <span class="number">0.5</span>))),</span><br><span class="line">                child: CupertinoDialogAction(</span><br><span class="line">                  child: <span class="keyword">new</span> Text(<span class="string">"ç¡®å®š"</span>),</span><br><span class="line">                  onPressed: () &#123;</span><br><span class="line">                    Navigator.pop(context);</span><br><span class="line">                  &#125;,</span><br><span class="line">                ),</span><br><span class="line">              ),</span><br><span class="line">              <span class="keyword">new</span> Container(</span><br><span class="line">                decoration: BoxDecoration(</span><br><span class="line">                    border: Border(</span><br><span class="line">                        top: BorderSide(color: Color(<span class="number">0xFFD9D9D9</span>), width: <span class="number">0.5</span>))),</span><br><span class="line">                child: CupertinoDialogAction(</span><br><span class="line">                  child: <span class="keyword">new</span> Text(<span class="string">"å–æ¶ˆ"</span>),</span><br><span class="line">                  onPressed: () &#123;</span><br><span class="line">                    Navigator.pop(context);</span><br><span class="line">                  &#125;,</span><br><span class="line">                ),</span><br><span class="line">              )</span><br><span class="line">            ],</span><br><span class="line">          );</span><br><span class="line">        &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="function">Widget <span class="title">build</span><span class="params">(BuildContext context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Scaffold(</span><br><span class="line">        appBar: <span class="keyword">new</span> AppBar(title: <span class="function"><span class="keyword">const</span> <span class="title">Text</span><span class="params">(<span class="string">'é¦–é¡µ'</span>)</span>),</span></span><br><span class="line"><span class="function">        body: new <span class="title">Container</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          alignment: Alignment.center,</span></span></span><br><span class="line"><span class="function"><span class="params">          child: RaisedButton(</span></span></span><br><span class="line"><span class="function"><span class="params">            onPressed: ()</span> </span>=&gt; &#123;_showIOSDialog(context)&#125;,</span><br><span class="line">            child: Text(<span class="string">'ç‚¹æˆ‘å¼¹æ¡†'</span>),</span><br><span class="line">          ),</span><br><span class="line">        ));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="CupertinoButton"><a href="#CupertinoButton" class="headerlink" title="CupertinoButton"></a>CupertinoButton</h5><p>å±•ç¤ºIOSé£æ ¼æŒ‰é’®<br>color ç»„ä»¶é¢œè‰²<br>disableColor ç¦ç”¨é¢œè‰²<br>onPressed æŒ‰ä¸‹äº‹ä»¶<br>child æ˜¾ç¤ºæŒ‰é’®çš„æ–‡æœ¬<br>enable æ˜¯å¦ç¦ç”¨</p><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">CupertinoButton(</span><br><span class="line">            <span class="comment">//æŒ‰é’®æ§ä»¶å¸ƒå±€</span></span><br><span class="line">            child: Text(<span class="string">'IOSé£æ ¼æŒ‰é’®'</span>),</span><br><span class="line">            <span class="comment">//å†…è¾¹è·</span></span><br><span class="line">            padding:EdgeInsets.all(<span class="number">10.0</span>),</span><br><span class="line">            <span class="comment">//èƒŒæ™¯é¢œè‰²</span></span><br><span class="line">            color:Colors.blue,</span><br><span class="line">            <span class="comment">//onPress ä¸º nullï¼Œç¦ç”¨ç‚¹å‡»çš„èƒŒæ™¯é¢œè‰²</span></span><br><span class="line">            disabledColor:Colors.grey,</span><br><span class="line">            <span class="comment">//æœ€å°å°ºå¯¸</span></span><br><span class="line">            minSize : <span class="number">44.0</span>,</span><br><span class="line">            <span class="comment">//æŒ‰ä¸‹çš„é€æ˜åº¦</span></span><br><span class="line">            pressedOpacity : <span class="number">0.1</span>,</span><br><span class="line">            <span class="comment">//è¾¹æ¡†åœ†è§’</span></span><br><span class="line">            borderRadius : <span class="keyword">const</span> BorderRadius.all(Radius.circular(<span class="number">8.0</span>)),</span><br><span class="line">            <span class="comment">//ç‚¹å‡»äº‹ä»¶</span></span><br><span class="line">            onPressed:()=&gt;&#123;</span><br><span class="line">              <span class="built_in">print</span>(<span class="string">'ç‚¹æˆ‘å¹²å˜›'</span>)</span><br><span class="line">            &#125;</span><br><span class="line">          )</span><br></pre></td></tr></table></figure><h5 id="CupertinoDialogAction"><a href="#CupertinoDialogAction" class="headerlink" title="CupertinoDialogAction"></a>CupertinoDialogAction</h5><p>é€šå¸¸ç”¨äºCupertinoAlertDialogçš„ä¸€ä¸ªbutton</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">CupertinoDialogAction(</span><br><span class="line">                  child: <span class="keyword">new</span> Text(<span class="string">"ç¡®å®š"</span>),</span><br><span class="line">                  <span class="comment">//æ˜¯å¦ä¸ºé»˜è®¤æŒ‰é’®</span></span><br><span class="line">                  isDefaultAction: <span class="literal">true</span>,</span><br><span class="line">                  <span class="comment">//æ˜¯å¦ä¸ºå–æ¶ˆæ“ä½œæŒ‰é’®</span></span><br><span class="line">                  isDestructiveAction: <span class="literal">true</span>,</span><br><span class="line">                  onPressed: () &#123;</span><br><span class="line">                    Navigator.pop(context);</span><br><span class="line">                  &#125;,</span><br><span class="line">                )</span><br></pre></td></tr></table></figure><h5 id="CupertinoSlider"><a href="#CupertinoSlider" class="headerlink" title="CupertinoSlider"></a>CupertinoSlider</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">CupertinoSlider(</span><br><span class="line">            <span class="comment">//å½“å‰è¿›åº¦å€¼</span></span><br><span class="line">            value:_progress,</span><br><span class="line">            <span class="comment">//è¿›åº¦æ¡ç›‘å¬äº‹ä»¶</span></span><br><span class="line">            onChanged:(progress) =&gt; &#123;</span><br><span class="line">              _progress = progress,</span><br><span class="line">              <span class="built_in">print</span>(<span class="string">"_progress<span class="subst">$_progress</span>"</span>),</span><br><span class="line">              setState(()&#123;</span><br><span class="line">              &#125;)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="comment">//è¿›åº¦æ¡å¼€å§‹ç›‘å¬</span></span><br><span class="line">            onChangeStart:(progress) =&gt; &#123;</span><br><span class="line">              <span class="built_in">print</span>(<span class="string">"onChangeStart<span class="subst">$progress</span>"</span>),</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="comment">//è¿›åº¦æ¡ç»“æŸç›‘å¬</span></span><br><span class="line">            onChangeEnd:(progress) =&gt; &#123;</span><br><span class="line">              <span class="built_in">print</span>(<span class="string">"onChangeEnd<span class="subst">$progress</span>"</span>),</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="comment">//è¿›åº¦æ¡æœ€å°å€¼</span></span><br><span class="line">            min : <span class="number">0.0</span>,</span><br><span class="line">            <span class="comment">//è¿›åº¦æ¡æœ€å¤§å€¼</span></span><br><span class="line">            max : <span class="number">100.0</span>,</span><br><span class="line">            <span class="comment">//è¿›åº¦æ¡åˆ†æˆå¤šå°‘åˆ†</span></span><br><span class="line">            divisions:<span class="number">1</span>,</span><br><span class="line">            <span class="comment">//è¿›åº¦æ¡é¢œè‰²</span></span><br><span class="line">            activeColor:Colors.blue,</span><br><span class="line">          )</span><br></pre></td></tr></table></figure><h5 id="CupertinoSwitch"><a href="#CupertinoSwitch" class="headerlink" title="CupertinoSwitch"></a>CupertinoSwitch</h5><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line">CupertinoSwitch(</span><br><span class="line">            value: _isOpen,</span><br><span class="line">            onChanged: <span class="function">(<span class="params">isOpen</span>) =&gt;</span> &#123;</span><br><span class="line">              _isOpen = isOpen,</span><br><span class="line">              setState(()&#123;</span><br><span class="line"></span><br><span class="line">              &#125;)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="comment">//å¼€å…³é¢œè‰²</span></span><br><span class="line">            activeColor: Colors.blue,</span><br><span class="line">          )</span><br></pre></td></tr></table></figure><h5 id="CupertinoPageRoute"><a href="#CupertinoPageRoute" class="headerlink" title="CupertinoPageRoute"></a>CupertinoPageRoute</h5><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line">onPressed: ()&#123;</span><br><span class="line">               Navigator.push(context, <span class="keyword">new</span> CupertinoPageRoute(</span><br><span class="line">               builder: <span class="function">(<span class="params">context</span>) =&gt;</span> Details(),</span><br><span class="line">               ));</span><br><span class="line">           &#125;,</span><br></pre></td></tr></table></figure><h5 id="CupertinoNavigationBar"><a href="#CupertinoNavigationBar" class="headerlink" title="CupertinoNavigationBar"></a>CupertinoNavigationBar</h5><p>iOSé£æ ¼çš„å¯¼èˆªæ . é€šå¸¸å’ŒCupertinoPageScaffoldä¸€èµ·ä½¿ç”¨ã€‚</p><table><thead><tr><th>cupertinoNavigationBar</th><th>å¯¼èˆªæ ç»“æ„ç»„ä»¶</th></tr></thead><tbody><tr><td>middle</td><td>ä¸­é—´ç»„ä»¶ï¼Œå¤šä¸ºæ ‡é¢˜</td></tr><tr><td>trailing</td><td>å³è¾¹ å¤šä¸ºèœå•æŒ‰é’®</td></tr><tr><td>leading</td><td>å·¦è¾¹æŒ‰é’®ï¼Œå¤šä¸ºè¿”å›</td></tr></tbody></table><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> CupertinoNavigationBar(</span><br><span class="line">          <span class="comment">//å·¦è¾¹Widgetï¼ˆä¸€èˆ¬ä¸ºè¿”å›æŒ‰é’®ï¼‰</span></span><br><span class="line">          leading: <span class="keyword">const</span> Icon(Icons.arrow_back_ios),</span><br><span class="line">          <span class="comment">//å¦‚æœä¸ºtrueå¹¶ä¸”middleä¸ºç©ºçš„æ—¶å€™å¹¶ä¸”å½“å‰è·¯ç”±æ˜¯CupertinoPageRouteï¼Œåˆ™è‡ªåŠ¨ç”¨[Text]å°éƒ¨ä»¶å¡«å……ï¼Œæ–‡æœ¬å½“å‰è·¯ç”±çš„â€œtitleâ€ã€‚</span></span><br><span class="line">          automaticallyImplyMiddle: <span class="keyword">true</span>,</span><br><span class="line">          <span class="comment">//ä¸Šä¸€é¡µæŒ‰é’®</span></span><br><span class="line">          previousPageTitle: <span class="string">'ä¸Šä¸€é¡µ'</span>,</span><br><span class="line">          backgroundColor: Colors.blue,</span><br><span class="line">          middle: <span class="keyword">const</span> Text(</span><br><span class="line">            <span class="string">'æ ‡é¢˜'</span>,</span><br><span class="line">            style: TextStyle(color: Colors.white),</span><br><span class="line">          ),</span><br><span class="line">          <span class="comment">//å³è¾¹Widget</span></span><br><span class="line">          trailing: <span class="keyword">const</span> Text(</span><br><span class="line">            <span class="string">'trailing'</span>,</span><br><span class="line">            style: TextStyle(color: Colors.white),</span><br><span class="line">          ),</span><br><span class="line">          <span class="comment">//è¾¹æ¡†</span></span><br><span class="line">          border: Border.all(color: Color(<span class="number">0xFFD9D9D9</span>), width: <span class="number">1.0</span>),</span><br><span class="line">          <span class="comment">//å›¾æ ‡é¢œè‰²</span></span><br><span class="line">          actionsForegroundColor: Colors.white,</span><br><span class="line">          <span class="comment">//å†…è¾¹è·</span></span><br><span class="line">          padding: EdgeInsetsDirectional.zero,</span><br><span class="line">          <span class="comment">//æ˜¯å¦åœ¨å¯¼èˆªæ ä¹‹é—´åˆ‡æ¢ã€‚</span></span><br><span class="line">          transitionBetweenRoutes: <span class="keyword">true</span>,</span><br><span class="line">        )</span><br></pre></td></tr></table></figure><h5 id="CupertinoPageScaffold"><a href="#CupertinoPageScaffold" class="headerlink" title="CupertinoPageScaffold"></a>CupertinoPageScaffold</h5><p>ä¸€ä¸ªiOSé£æ ¼çš„é¡µé¢çš„åŸºæœ¬å¸ƒå±€ç»“æ„ã€‚åŒ…å«å†…å®¹å’Œå¯¼èˆªæ ,å’Œ CupertinoNavigationBar ä¸€èµ·ä½¿ç”¨ã€‚</p><table><thead><tr><th>cupertinoTabScaffold</th><th>é€‰é¡¹å¡ç»„ä»¶</th></tr></thead><tbody><tr><td>tabbar</td><td>cupertinoTabbar</td></tr><tr><td>tabBuilderr: indexedWidgetBuilder</td><td>é€‰é¡¹å¡è§†å›¾æ„é€ å™¨</td></tr></tbody></table><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> CupertinoPageScaffold(</span><br><span class="line">        navigationBar: <span class="keyword">new</span> CupertinoNavigationBar(</span><br><span class="line">          middle: <span class="keyword">const</span> Text(</span><br><span class="line">            <span class="string">'æ ‡é¢˜'</span>,</span><br><span class="line">            style: TextStyle(color: Colors.black),</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">        child: <span class="keyword">new</span> Container(</span><br><span class="line">          alignment: Alignment.center,</span><br><span class="line">          child: RaisedButton(</span><br><span class="line">            child: Text(<span class="string">'è·³è½¬ä¸‹ä¸€ä¸ªé¡µé¢'</span>),</span><br><span class="line">            onPressed: () &#123;</span><br><span class="line">              Navigator.push(</span><br><span class="line">                  context,</span><br><span class="line">                  <span class="keyword">new</span> CupertinoPageRoute(</span><br><span class="line">                    builder: <span class="function">(<span class="params">context</span>) =&gt;</span> Details(),</span><br><span class="line">                  ));</span><br><span class="line">            &#125;,</span><br><span class="line">          ),</span><br><span class="line">        ))</span><br></pre></td></tr></table></figure><h5 id="CupertinoTabScaffold-å’Œ-CupertinoTabBar"><a href="#CupertinoTabScaffold-å’Œ-CupertinoTabBar" class="headerlink" title="CupertinoTabScaffold å’Œ CupertinoTabBar"></a>CupertinoTabScaffold å’Œ CupertinoTabBar</h5><p>æ ‡ç­¾å¼iOSåº”ç”¨ç¨‹åºçš„ç»“æ„ã€‚å°†é€‰é¡¹å¡æ æ”¾åœ¨å†…å®¹é€‰é¡¹å¡ä¹‹ä¸Š</p><p>CupertinoTabBar æ˜¯ iOSé£æ ¼çš„åº•éƒ¨é€‰é¡¹å¡ã€‚ é€šå¸¸å’ŒCupertinoTabScaffoldä¸€èµ·ä½¿ç”¨ã€‚</p><table><thead><tr><th>cupertinoTabbar</th><th>é€‰é¡¹å¡æŒ‰é’®ç»„ä»¶ï¼Œé€šå¸¸æœ‰BottomNavigationBarItem</th></tr></thead><tbody><tr><td>items: list</td><td></td></tr><tr><td>backgroundcolor</td><td>æŒ‰é’®èƒŒæ™¯è‰²</td></tr><tr><td>activeColor</td><td>å‰æ™¯è‰²</td></tr><tr><td>iconSize</td><td>å›¾æ ‡å¤§å°</td></tr></tbody></table><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">new CupertinoTabScaffold(</span><br><span class="line">        tabBar: new CupertinoTabBar(</span><br><span class="line">          items: &lt;BottomNavigationBarItem&gt;[</span><br><span class="line">            new BottomNavigationBarItem(</span><br><span class="line">              icon: Icon(Icons.home),</span><br><span class="line">              activeIcon: Icon(Icons.hourglass_full),</span><br><span class="line">              title:Text(&apos;é¦–é¡µ&apos;,</span><br><span class="line">                style: TextStyle(color: Colors.black))</span><br><span class="line">            ),</span><br><span class="line">            new BottomNavigationBarItem(</span><br><span class="line">                icon: Icon(Icons.fiber_manual_record),</span><br><span class="line">                activeIcon: Icon(Icons.fiber_manual_record),</span><br><span class="line">                title:Text(&apos;ç¤¾åŒº&apos;,</span><br><span class="line">                    style: TextStyle(color: Colors.black))</span><br><span class="line">            ),</span><br><span class="line">            new BottomNavigationBarItem(</span><br><span class="line">                icon: Icon(Icons.add_shopping_cart),</span><br><span class="line">                activeIcon: Icon(Icons.add_shopping_cart),</span><br><span class="line">                title:Text(&apos;å‘ç°&apos;,</span><br><span class="line">                    style: TextStyle(color: Colors.black))</span><br><span class="line">            ),</span><br><span class="line">            new BottomNavigationBarItem(</span><br><span class="line">                icon: Icon(Icons.my_location),</span><br><span class="line">                activeIcon: Icon(Icons.my_location),</span><br><span class="line">                title:Text(&apos;æˆ‘çš„&apos;,</span><br><span class="line">                    style: TextStyle(color: Colors.black))</span><br><span class="line">            ),</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">        tabBuilder: (context,index) =&gt; new Container(</span><br><span class="line">          alignment: Alignment.center,</span><br><span class="line">          child: RaisedButton(</span><br><span class="line">            child: Text(&apos;è·³è½¬ä¸‹ä¸€ä¸ªé¡µé¢$index&apos;),</span><br><span class="line">            onPressed: () &#123;</span><br><span class="line">              Navigator.push(</span><br><span class="line">                  context,</span><br><span class="line">                  new CupertinoPageRoute(</span><br><span class="line">                    builder: (context) =&gt; Details(),</span><br><span class="line">                  ));</span><br><span class="line">            &#125;,</span><br><span class="line">          ),</span><br><span class="line">        ))</span><br></pre></td></tr></table></figure><h5 id="CupertinoTabView"><a href="#CupertinoTabView" class="headerlink" title="CupertinoTabView"></a>CupertinoTabView</h5><p>é€‰é¡¹å¡è§†å›¾ç»„ä»¶,æ”¯æŒé€‰é¡¹å¡é—´å¹¶è¡Œå¯¼èˆªé¡¹å¡çš„æ ¹å†…å®¹ã€‚é€šå¸¸ä¸CupertinoTabScaffoldeä¸€èµ·ä½¿ç”¨</p><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line">tabBuilder: <span class="function">(<span class="params">context, index</span>) =&gt;</span> <span class="keyword">new</span> CupertinoTabView(</span><br><span class="line">              <span class="comment">//è¿”å›æŒ‰é’®æè¿°æ–‡æœ¬</span></span><br><span class="line">              defaultTitle: <span class="string">'è¿”å›'</span>,</span><br><span class="line">              <span class="comment">//æ³¨å†Œè·³è½¬çš„è·¯å¾„å’Œé¡µé¢</span></span><br><span class="line">              routes: &#123;</span><br><span class="line">                <span class="string">'/home'</span>: (context) &#123;</span><br><span class="line">                  <span class="keyword">return</span> CupertinoPageScaffold(</span><br><span class="line">                    navigationBar: CupertinoNavigationBar(</span><br><span class="line">                      middle: Text(<span class="string">'æˆ‘æ˜¯æ ‡é¢˜'</span>),</span><br><span class="line">                    ),</span><br><span class="line">                    child: Center(</span><br><span class="line">                      child: Text(<span class="string">'æˆ‘æ˜¯ç¬¬äºŒé¡µ'</span>),</span><br><span class="line">                    ),</span><br><span class="line">                  );</span><br><span class="line">                &#125;,</span><br><span class="line">              &#125;,</span><br><span class="line">              builder: <span class="function">(<span class="params">context</span>) =&gt;</span> <span class="keyword">new</span> Container(</span><br><span class="line">                    alignment: Alignment.center,</span><br><span class="line">                    child: RaisedButton(</span><br><span class="line">                      child: Text(<span class="string">'è·³è½¬ä¸‹ä¸€ä¸ªé¡µé¢$index'</span>),</span><br><span class="line">                      onPressed: () &#123;</span><br><span class="line">                        Navigator.of(context).pushNamed(<span class="string">'/home'</span>);</span><br><span class="line">                      &#125;,</span><br><span class="line">                    ),</span><br><span class="line">                  ),</span><br><span class="line">            )</span><br></pre></td></tr></table></figure><h4 id="ä½¿appæ”¯æŒå¤šç«¯"><a href="#ä½¿appæ”¯æŒå¤šç«¯" class="headerlink" title="ä½¿appæ”¯æŒå¤šç«¯"></a>ä½¿appæ”¯æŒå¤šç«¯</h4><h5 id="flutterä½¿appæ”¯æŒweb"><a href="#flutterä½¿appæ”¯æŒweb" class="headerlink" title="flutterä½¿appæ”¯æŒweb"></a>flutterä½¿appæ”¯æŒweb</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flutter channel stable</span><br><span class="line">flutter upgrade</span><br><span class="line"></span><br><span class="line">Unable to &apos;pub upgrade&apos; flutter tool. Retrying in five seconds</span><br><span class="line">è§£å†³æ–¹æ³•ï¼šåˆ é™¤ flutter SDKä¸­ bin/cache æ–‡ä»¶å¤¹ï¼Œç„¶åå†flutter upgradeå°±å¯ä»¥äº†ã€‚</span><br><span class="line"></span><br><span class="line">å¦‚æœæŠ¥é”™ä½¿ç”¨</span><br><span class="line">flutter upgrade --force</span><br></pre></td></tr></table></figure><p>ä¸€æ—¦å¼€å¯äº† Web æ”¯æŒï¼Œè¿è¡Œ <code>flutter devices</code>ï¼Œå‘½ä»¤ä¼šè¾“å‡ºä¸€ä¸ªåä¸º <code>Chrome</code> çš„è®¾å¤‡ä¿¡æ¯ï¼Œå¼€å¯ä¸€ä¸ªä¸º Web åº”ç”¨æä¾›æœåŠ¡çš„ <code>Web Sever</code>ï¼Œå¹¶æ‰“å¼€ Chrome æµè§ˆå™¨å¹¶è®¿é—®æŸä¸ª URL åœ°å€ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">âœflutter devices</span><br><span class="line">1 connected device:</span><br><span class="line"></span><br><span class="line">Chrome (web) â€¢ chrome â€¢ web-javascript â€¢ Google Chrome 89.0.4389.128</span><br></pre></td></tr></table></figure><p>è¦åœ¨ Chrome çš„ <code>localhost</code> ä¸­éƒ¨ç½²ä½ çš„åº”ç”¨ï¼Œä»è½¯ä»¶åŒ…æ ¹ç›®å½•è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flutter run -d chrome</span><br></pre></td></tr></table></figure><p>å½“å‰é¡¹ç›®ç›®å½•ä¸‹,åˆ›å»ºwebæ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flutter create .</span><br></pre></td></tr></table></figure><p>è¿è¡Œä¸‹é¢å‘½ä»¤ä»¥ç”Ÿæˆå‘è¡Œç‰ˆæ„å»ºï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flutter build web</span><br></pre></td></tr></table></figure><p>Release æ„å»ºäº§ç‰©ä½¿ç”¨ <a href="https://dart.cn/tools/dart2js" target="_blank" rel="noopener">dart2js</a>ï¼ˆä¸æ˜¯ dartdevcï¼‰ç”Ÿæˆäº†ä¸€ä¸ªå•ç‹¬çš„ JavaScript <code>main.dart.js</code> æ–‡ä»¶ã€‚ä½ å¯ä»¥é€šè¿‡ release æ¨¡å¼ (<code>flutter run --release</code>) æˆ–è€… <code>flutter build web</code> åˆ›å»ºä¸€ä¸ªå‘è¡Œæ„å»ºã€‚è¾“å‡ºæ–‡ä»¶åœ¨ <code>build/web</code> ç›®å½•ä¸‹ï¼ŒåŒ…æ‹¬éœ€è¦ä¸€èµ·æä¾›çš„ <code>assets</code> èµ„æºæ–‡ä»¶ã€‚</p><p>ç›®å‰é€šè¿‡ä¸¤ä¸ªä»åœ¨å¼€å‘ä¸­çš„é¡¹ç›®æä¾›å¯¹æ¡Œé¢å¹³å°çš„æ”¯æŒã€‚å…¶ä¸­ä¸€ä¸ªç”šè‡³æ˜¯è°·æ­Œå¼€å‘çš„ï¼Œä½†æœ‰è¿¹è±¡è¡¨æ˜è¯¥å…¬å¸ä¸æ”¯æŒå®ƒã€‚å¯ä»¥åœ¨ä»¥ä¸‹ Github å­˜å‚¨åº“ä¸­æ‰¾åˆ°è¿™äº›é¡¹ç›®ï¼š</p><ul><li>ã€å®˜æ–¹ã€‘Google å¼€æºçš„ Flutter åµŒå…¥æ¡Œé¢çš„ API å®ç°ï¼š<a href="https://github.com/google/flutter-desktop-embedding" target="_blank" rel="noopener">flutter-desktop-embedding</a></li><li>ã€æ¨èã€‘Go è¯­è¨€å®ç°å·¥å…·ï¼š<a href="https://github.com/go-flutter-desktop/hover" target="_blank" rel="noopener">hover</a></li></ul><p>è¿™ä¸¤ä¸ªé¡¹ç›®éƒ½å½’ç±»ä¸º Custom Flutter Engine Embeddersï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä»¬æ˜¯ Flutter API çš„å®ç°ï¼Œå› æ­¤åœ¨æ­¤æ¡†æ¶ä¸­å¼€å‘çš„é¡¹ç›®å¯ä»¥åœ¨ Flutter é¡¹ç›®ï¼ˆAndroidï¼ŒFuchsia å’Œ iOSï¼‰æ­£å¼æ”¯æŒçš„æ“ä½œç³»ç»Ÿä¹‹å¤–è¿è¡Œã€‚</p><p>æœ¬æ–‡ä½¿ç”¨ç¬¬äºŒç§å®ç°æ–¹å¼</p><p>å®‰è£…éœ€è¦ä¾èµ–ï¼šGO GCC Git</p><p>è®¿é—®<a href="https://github.com/go-flutter-desktop/hover" target="_blank" rel="noopener">https://github.com/go-flutter-desktop/hover</a></p><p>è¿è¡Œgo versionå¹¶ç¡®ä¿æ‚¨çš„Goç‰ˆæœ¬ä¸º1.13æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">C:\Users\admin&gt;go version</span><br><span class="line">go version go1.15.6 windows/amd64</span><br></pre></td></tr></table></figure><p>å®‰è£…GCC</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">exec: &quot;gcc&quot;: executable file not found in %PATH%</span><br><span class="line">è¿™æ˜¯å› ä¸ºWindowsç³»ç»Ÿä¸Šæ²¡æœ‰GCCç¼–è¯‘å™¨ã€‚è€Œç¼–è¯‘ä»£ç ä¸­çš„åŒ…é‡Œé¢å¯èƒ½éœ€è¦ç”¨åˆ°gccç¼–è¯‘å™¨ã€‚</span><br><span class="line"></span><br><span class="line">è§£å†³åŠæ³•å¦‚ä¸‹ï¼š</span><br><span class="line"></span><br><span class="line">ä¸‹è½½é“¾æ¥ï¼šhttps://sourceforge.net/projects/mingw-w64/files/mingw-w64/</span><br><span class="line"></span><br><span class="line">ä¸ªäººå»ºè®®ï¼šä¸è¦ä¸‹è½½exeæ–‡ä»¶ï¼Œç½‘ä¸å¥½å®‰è£…ä¸‹è½½èµ„æºåŒ…å¾ˆè´¹åŠ²ã€‚è¿˜æ˜¯ä¸‹è½½64ä½x86_64-posix-sehå‹ç¼©åŒ…ï¼Œç›´æ¥è§£å‹å°±è¡Œã€‚æ²¡æœ‰è§£å‹å·¥å…·çš„è‡ªå·±ä¸‹è½½ä¸€ä¸ªã€‚</span><br><span class="line">è§£å‹å®Œä¹‹åï¼Œé…ç½®ç¯å¢ƒå˜é‡ã€‚å°†å®‰è£…è·¯å¾„å¯¹åº”çš„binç›®å½•æ·»åŠ åˆ°PATHç¯å¢ƒå˜é‡ä¸­ã€‚</span><br><span class="line"></span><br><span class="line">C:\Users\admin\Desktop\gcc -v</span><br><span class="line">Using built-in specs.</span><br><span class="line">COLLECT_GCC=gcc</span><br><span class="line">COLLECT_LTO_WRAPPER=G:/x86_64-8.1.0-release-posix-seh-rt_v6-rev0/mingw64/bin/../libexec/gcc/x86_64-w64-mingw32/8.1.0/lto-wrapper.exe</span><br><span class="line">Target: x86_64-w64-mingw32</span><br><span class="line">Configured with: ../../../src/gcc-8.1.0/configure --host=x86_64-w64-mingw32 --build=x86_64-w64-mingw32 --target=x86_64-w64-mingw32 --prefix=/mingw64 --with-sysroot=/c/mingw810/x86_64-810-posix-seh-rt_v6-rev0/mingw64 --enable-shared --enable-static --disable-multilib --enable-languages=c,c++,fortran,lto --enable-libstdcxx-time=yes --enable-threads=posix --enable-libgomp --enable-libatomic --enable-lto --enable-graphite --enable-checking=release --enable-fully-dynamic-string --enable-version-specific-runtime-libs --disable-libstdcxx-pch --disable-libstdcxx-debug --enable-bootstrap --disable-rpath --disable-win32-registry --disable-nls --disable-werror --disable-symvers --with-gnu-as --with-gnu-ld --with-arch=nocona --with-tune=core2 --with-libiconv --with-system-zlib --with-gmp=/c/mingw810/prerequisites/x86_64-w64-mingw32-static --with-mpfr=/c/mingw810/prerequisites/x86_64-w64-mingw32-static --with-mpc=/c/mingw810/prerequisites/x86_64-w64-mingw32-static --with-isl=/c/mingw810/prerequisites/x86_64-w64-mingw32-static --with-pkgversion=&apos;x86_64-posix-seh-rev0, Built by MinGW-W64 project&apos; --with-bugurl=https://sourceforge.net/projects/mingw-w64 CFLAGS=&apos;-O2 -pipe -fno-ident -I/c/mingw810/x86_64-810-posix-seh-rt_v6-rev0/mingw64/opt/include -I/c/mingw810/prerequisites/x86_64-zlib-static/include -I/c/mingw810/prerequisites/x86_64-w64-mingw32-static/include&apos; CXXFLAGS=&apos;-O2 -pipe -fno-ident -I/c/mingw810/x86_64-810-posix-seh-rt_v6-rev0/mingw64/opt/include -I/c/mingw810/prerequisites/x86_64-zlib-static/include -I/c/mingw810/prerequisites/x86_64-w64-mingw32-static/include&apos; CPPFLAGS=&apos; -I/c/mingw810/x86_64-810-posix-seh-rt_v6-rev0/mingw64/opt/include -I/c/mingw810/prerequisites/x86_64-zlib-static/include -I/c/mingw810/prerequisites/x86_64-w64-mingw32-static/include&apos; LDFLAGS=&apos;-pipe -fno-ident -L/c/mingw810/x86_64-810-posix-seh-rt_v6-rev0/mingw64/opt/lib -L/c/mingw810/prerequisites/x86_64-zlib-static/lib -L/c/mingw810/prerequisites/x86_64-w64-mingw32-static/lib &apos;</span><br><span class="line">Thread model: posix</span><br><span class="line">gcc version 8.1.0 (x86_64-posix-seh-rev0, Built by MinGW-W64 project)</span><br></pre></td></tr></table></figure><p>è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…hover</p><p>windows:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">set GO111MODULE=on</span><br><span class="line">go get -u -a github.com/go-flutter-desktop/hover</span><br></pre></td></tr></table></figure><p>ç°æœ‰Flutteré¡¹ç›®å…¥é—¨</p><p>è¿›å…¥åˆ°é¡¹ç›®ç›®å½•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd flutter-app/</span><br><span class="line"></span><br><span class="line">#ç¬¬ä¸€æ¬¡å°†æ‚¬åœç”¨äºé¡¹ç›®æ—¶ï¼Œæ‚¨éœ€è¦åˆå§‹åŒ–è¯¥é¡¹ç›®ä»¥ä¸æ‚¬åœä¸€èµ·ä½¿ç”¨ã€‚å¯ä»¥å°†å‚æ•°ä¼ é€’ç»™hover initæ¥è®¾ç½®é¡¹ç›®è·¯å¾„ã€‚è¿™é€šå¸¸æ˜¯æ‚¨åœ¨githubæˆ–è‡ªæ‰˜ç®¡gitæœåŠ¡ä¸Šçš„é¡¹ç›®çš„è·¯å¾„ã€‚å¦‚æœä¸ç¡®å®šä½¿ç”¨hover initæ— è·¯å¾„ã€‚æ‚¨å¯ä»¥ç¨åæ›´æ”¹è·¯å¾„ã€‚</span><br><span class="line">hover init github.com/nmk0718/flutter-app</span><br></pre></td></tr></table></figure><p>è¿è¡Œ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hover run</span><br><span class="line">#çƒ­é‡è½½æ˜¯æ‰‹åŠ¨çš„ï¼Œå› ä¸ºæ‚¨éœ€è¦åœ¨ç»ˆç«¯ä¸­æŒ‰â€œ râ€æ¥çƒ­é‡è½½åº”ç”¨ç¨‹åºã€‚</span><br><span class="line"></span><br><span class="line">#é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‚¬åœä½¿ç”¨æ–‡ä»¶lib/main_desktop.dartä½œä¸ºå…¥å£ç‚¹ã€‚æ‚¨å¯ä»¥ä½¿ç”¨è¯¥--targetæ ‡å¿—æŒ‡å®šå…¶ä»–ç«¯ç‚¹ã€‚</span><br></pre></td></tr></table></figure><p>æ‰“åŒ…</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hover build linux # or darwin or windows</span><br></pre></td></tr></table></figure><p>é¦–æ¬¡ä½¿ç”¨æ—¶hover runå¯åŠ¨æ²¡é—®é¢˜ æ‰“åŒ…æŠ¥é”™ åˆ‡æ¢ä¸ºbetaç‰ˆæœ¬åœ¨è¿›è¡Œæ‰“åŒ…</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">C:\Users\admin\Downloads\memos-main\memos-main&gt;flutter channel beta</span><br><span class="line">Switching to flutter channel &apos;beta&apos;...</span><br><span class="line">git: Branch &apos;beta&apos; set up to track remote branch &apos;beta&apos; from &apos;origin&apos;.</span><br><span class="line">git: Switched to a new branch &apos;beta&apos;</span><br><span class="line">Successfully switched to flutter channel &apos;beta&apos;.</span><br><span class="line">To ensure that you&apos;re on the latest build from this channel, run &apos;flutter upgrade&apos;</span><br><span class="line"></span><br><span class="line">C:\Users\admin\Downloads\memos-main\memos-main&gt;hover build windows</span><br><span class="line">hover: Downloading engine for platform windows-release at version a123e75c6082da3a08f229b9c565e64b5b24a8a3...</span><br><span class="line">Download completed in 23.08s</span><br><span class="line">hover: Cleaning the build directory</span><br><span class="line">hover: Bundling flutter app</span><br><span class="line">VersionCheckError: Command exited with code 128: git fetch __flutter_version_check__ beta</span><br><span class="line">Standard error: fatal: unable to access &apos;https://github.com/flutter/flutter.git/&apos;: OpenSSL SSL_read: Connection was</span><br><span class="line">reset, errno 10054</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Flutter assets will be downloaded from https://storage.flutter-io.cn. Make sure you trust this source!</span><br><span class="line">Downloading package sky_engine...                                  368ms</span><br><span class="line">Downloading flutter_patched_sdk tools...                           448ms</span><br><span class="line">Downloading flutter_patched_sdk_product tools...                   240ms</span><br><span class="line">Downloading windows-x64 tools...                                 1,023ms</span><br><span class="line">Downloading windows-x64/font-subset tools...                       173ms</span><br><span class="line">Running &quot;flutter pub get&quot; in memos-main...                         839ms</span><br><span class="line"></span><br><span class="line"> Building with sound null safety</span><br><span class="line"></span><br><span class="line">hover: Generating kernel snapshot</span><br><span class="line">result 67978fb7-9906-4bd1-a022-0f2cb4d31ba0</span><br><span class="line">lib/main_desktop.dart: Warning: Interpreting this as package URI, &apos;package:memos/main_desktop.dart&apos;.</span><br><span class="line">67978fb7-9906-4bd1-a022-0f2cb4d31ba0</span><br><span class="line">nel_snapshot.dill 0</span><br><span class="line">hover: Generating ELF snapshot</span><br><span class="line">Warning: Generating ELF library without DWARF debugging information.</span><br><span class="line">hover: Checking available release on Github</span><br><span class="line">hover: Compiling &apos;go-flutter&apos; and plugins</span><br><span class="line">runtime/cgo</span><br><span class="line">github.com/go-flutter-desktop/go-flutter/internal/currentthread</span><br><span class="line">github.com/go-flutter-desktop/go-flutter/embedder</span><br><span class="line">github.com/go-gl/glfw/v3.3/glfw</span><br><span class="line">github.com/go-gl/gl/v3.3-core/gl</span><br><span class="line">github.com/go-flutter-desktop/go-flutter/internal/priorityqueue</span><br><span class="line">github.com/go-flutter-desktop/go-flutter/internal/keyboard</span><br><span class="line">github.com/go-flutter-desktop/go-flutter/internal/opengl</span><br><span class="line">github.com/go-flutter-desktop/go-flutter</span><br><span class="line">hover: Successfully compiled executable binary for windows</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘windowsä¸èƒ½ç›´æ¥è¿›è¡Œä½¿ç”¨,å¿…é¡»ç§»åŠ¨æ•´ä¸ªæ–‡ä»¶å¤¹æ‰èƒ½ä½¿ç”¨,æ‰€ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰“åŒ…</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">C:\Users\admin\Downloads\memos-main\memos-main&gt;hover build windows-msi</span><br><span class="line">hover: Using engine from cache</span><br><span class="line">hover: Cleaning the build directory</span><br><span class="line">hover: Bundling flutter app</span><br><span class="line"></span><br><span class="line"> Building with sound null safety</span><br><span class="line"></span><br><span class="line">hover: Generating kernel snapshot</span><br><span class="line">result 19414483-7af2-49ad-99fa-98b0c4ca254f</span><br><span class="line">lib/main_desktop.dart: Warning: Interpreting this as package URI, &apos;package:memos/main_desktop.dart&apos;.</span><br><span class="line">19414483-7af2-49ad-99fa-98b0c4ca254f</span><br><span class="line">nel_snapshot.dill 0</span><br><span class="line">hover: Generating ELF snapshot</span><br><span class="line">Warning: Generating ELF library without DWARF debugging information.</span><br><span class="line">hover: Compiling &apos;go-flutter&apos; and plugins</span><br><span class="line">hover: Successfully compiled executable binary for windows</span><br><span class="line">hover: Packaging app for windows-msi</span><br><span class="line">hover: Missing/Empty `author` field in pubspec.yaml. Please add it or otherwise you may publish your app with a wrong author. Continuing with `DESKTOP-D5VSCI4\admin` as a placeholder author.</span><br><span class="line">hover: Missing/Empty `license` field in go/hover.yaml. Please add it or otherwise you may publish your app with a wrong license. Continuing with `NOASSERTION` as a placeholder license.</span><br><span class="line">hover: Failed to read `go/packaging/windows-msi/upgrade-code.txt`: open C:\Users\admin\Downloads\memos-main\memos-main\go\packaging\windows-msi\upgrade-code.txt: The system cannot find the file specified.</span><br><span class="line">hover: Please re-init windows-msi to generate the `go/packaging/windows-msi/upgrade-code.txt`</span><br><span class="line">hover: or put a GUID from https://www.guidgen.com/ into a new `go/packaging/windows-msi/upgrade-code.txt` file.</span><br><span class="line"></span><br><span class="line">å¦‚æœæŠ¥é”™To package windows-msi these tools are required: candle</span><br><span class="line">è¯·å‰å¾€https://wixtoolset.org/releases/è¿›è¡Œä¸‹è½½å®‰è£…</span><br><span class="line">å¯åŠ¨ä¸‹è½½å¥½çš„Wixç¨‹åº,ä¼šæç¤ºç¼ºå°‘.netframework3.5.1ï¼Œwindowsçš„æ§åˆ¶é¢æ¿&gt;ç¨‹åº&gt;å¯ç”¨å’Œå…³é—­windowsåŠŸèƒ½&gt;å‹¾é€‰.netframework3.5</span><br><span class="line">å®‰è£…å¥½.netfameworkåå†æ¬¡å¯åŠ¨Wixè¿›è¡Œå®‰è£…,å®‰è£…å®Œæ¯•,ç›®å½•ä¸ºC:\Program Files (x86)\WiX Toolset v3.11</span><br><span class="line">è¿è¡Œå‘½ä»¤åè¿˜æ˜¯ç¼ºå°‘candle.exe,æŠŠC:\Program Files (x86)\WiX Toolset v3.11\binåŠ å…¥ç³»ç»Ÿç¯å¢ƒå˜é‡çš„Pathä¸­å³å¯</span><br><span class="line"></span><br><span class="line">Failed to read `go/packaging/windows-msi/upgrade-code.txt</span><br><span class="line">æŒ‰ç…§æç¤ºä¿¡æ¯è®¿é—® https://www.guidgen.com/å¤åˆ¶é¡µé¢ä¸­çš„code</span><br><span class="line">åˆ›å»ºgo/packaging/windows-msi/upgrade-code.txtæ–‡ä»¶,ç²˜è´´codeåˆ°æ–‡æœ¬ä¸­ä¿å­˜å³å¯</span><br></pre></td></tr></table></figure><h4 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h4><p>Your Flutter application is created using an older version of the Android</p><p>embedding. Itâ€™s being deprecated in favor of Android embedding v2.</p><p><strong>è§£å†³åŠæ³•</strong>ï¼šæ‰“å¼€android/app/mainæ–‡ä»¶å¤¹ä¸‹çš„AndroidManifest.xmlæ–‡ä»¶ï¼Œåœ¨activityæ ‡ç­¾çš„ä¸‹é¢å¢åŠ å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;meta-data</span><br><span class="line">     android:name=&quot;flutterEmbedding&quot;</span><br><span class="line">     android:value=&quot;2&quot; /&gt;</span><br></pre></td></tr></table></figure><p>[!] Your app isnâ€™t using AndroidX.</p><p>To avoid potential build failures, you can quickly migrate your app by following the steps on https:<em>//goo.gl/CP92wY.</em></p><p><strong>è§£å†³åŠæ³•</strong>ï¼šåœ¨androidæ–‡ä»¶å¤¹çš„gradle.propertiesä¸­æ·»åŠ å¦‚ä¸‹ä»£ç å³å¯ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">android.enableJetifier=true</span><br><span class="line">android.useAndroidX=true</span><br></pre></td></tr></table></figure><p>error: resource android:attr/fontVariationSettings not found</p><p>è§£å†³åŠæ³•</p><p>æ›´æ”¹androidç›®å½•ä¸‹appä¸‹çš„build.gradleæ–‡ä»¶ä¸­çš„ç¼–è¯‘ç‰ˆæœ¬ç”±27æ”¹ä¸º28å³å¯</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">compileSdkVersion 28</span><br><span class="line">#æ›´æ”¹è¯¥å‚æ•°ä¸º28</span><br><span class="line"></span><br><span class="line">lintOptions &#123;</span><br><span class="line">disable &apos;InvalidPackage&apos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>flutterå·²ç»pub getä¸‹è½½å®Œæ’ä»¶,ä½†æ˜¯ä¼šæŠ¥é”™ Error: Type â€˜PathProviderWindowsâ€™ not found.</p><p>ä½¿ç”¨å‘½ä»¤</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flutter clean</span><br><span class="line">flutter pub cache repair</span><br></pre></td></tr></table></figure><p>ç­‰ä¸‹å®Œå³å¯</p><p>[!] The following Swift pods cannot yet be integrated as static libraries:</p><p>The Swift pod <code>DKPhotoGallery</code> depends upon <code>SDWebImage</code>, which does not define modules. To opt into those targets generating module maps (which is necessary to import them from Swift when building as static libraries), you may set <code>use_modular_headers!</code> globally in your Podfile, or specify <code>:modular_headers =&gt; true</code> for particular dependencies.</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">åœ¨ios/Podfileä¸­ä¿®æ”¹</span><br><span class="line"></span><br><span class="line">target &apos;Runner&apos; do</span><br><span class="line">  use_frameworks! #add here</span><br><span class="line">  flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>Automatically assigning platform <a href="http://lib.csdn.net/base/ios" target="_blank" rel="noopener">iOS</a> with version 9.0 on target ä½ çš„å·¥ç¨‹åç§° because no platform was specified. Please specify a platform for this target in your Podfile. See <code>https://guides.cocoapods.org/syntax/podfile.html#platform</code></p><p>è¿™æ˜¯åœ¨ä½¿ç”¨cocoapodså®‰è£…ä¸‰æ–¹åº“é…ç½®podfileä¹‹åçš„ä¸€ä¸ªè­¦å‘Šä¿¡æ¯ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># Uncomment this line to define a global platform for your project</span><br><span class="line">platform :ios, &apos;9.0&apos;</span><br></pre></td></tr></table></figure><p>åªéœ€è¦å°†ç¬¬äºŒè¡Œplatformå‰é¢çš„æ³¨é”€# ç¬¦å·å»æ‰  å°±å¯ä»¥äº†</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h5 id=&quot;å®‰å…¨åŒºåŸŸ&quot;&gt;&lt;a href=&quot;#å®‰å…¨åŒºåŸŸ&quot; class=&quot;headerlink&quot; title=&quot;å®‰å…¨åŒºåŸŸ&quot;&gt;&lt;/a&gt;å®‰å…¨åŒºåŸŸ&lt;/h5&gt;&lt;p&gt;å½“ç›´æ¥ä½¿ç”¨å°éƒ¨ä»¶æ—¶ä¼šå‡ºç°åœ¨å·¦ä¸Šè§’çš„çŠ¶æ€æ é™„è¿‘&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;ta</summary>
      
    
    
    
    
    <category term="Flutter" scheme="https://nmk0718.github.io/tag/Flutter/"/>
    
  </entry>
  
  <entry>
    <title>Jmeter</title>
    <link href="https://nmk0718.github.io/2021/03/27/Jmeter/"/>
    <id>https://nmk0718.github.io/2021/03/27/Jmeter/</id>
    <published>2021-03-27T06:05:00.000Z</published>
    <updated>2024-11-29T06:44:36.032Z</updated>
    
    <content type="html"><![CDATA[<p>Apache JMeteræ˜¯Apacheç»„ç»‡å¼€å‘çš„åŸºäºJavaçš„å‹åŠ›æµ‹è¯•å·¥å…·.å®ƒå¯ä»¥ç”¨äºæµ‹è¯•é™æ€å’ŒåŠ¨æ€èµ„æºï¼Œä¾‹å¦‚é™æ€æ–‡ä»¶ã€Java å°æœåŠ¡ç¨‹åºã€CGI è„šæœ¬ã€Java å¯¹è±¡ã€æ•°æ®åº“ã€FTP æœåŠ¡å™¨ï¼Œ ç­‰ç­‰ã€‚JMeter å¯ä»¥ç”¨äºå¯¹æœåŠ¡å™¨ã€ç½‘ç»œæˆ–å¯¹è±¡æ¨¡æ‹Ÿå·¨å¤§çš„è´Ÿè½½ï¼Œæ¥è‡ªä¸åŒå‹åŠ›ç±»åˆ«ä¸‹æµ‹è¯•å®ƒä»¬çš„å¼ºåº¦å’Œåˆ†ææ•´ä½“æ€§èƒ½ã€‚å¦å¤–ï¼ŒJMeterèƒ½å¤Ÿå¯¹åº”ç”¨ç¨‹åºåšåŠŸèƒ½/å›å½’æµ‹è¯•ï¼Œé€šè¿‡åˆ›å»ºå¸¦æœ‰æ–­è¨€çš„è„šæœ¬æ¥éªŒè¯ä½ çš„ç¨‹åºè¿”å›äº†ä½ æœŸæœ›çš„ç»“æœã€‚ä¸ºäº†æœ€å¤§é™åº¦çš„çµæ´»æ€§ï¼ŒJMeterå…è®¸ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åˆ›å»ºæ–­è¨€ã€‚<br><strong>Jmeterçš„ä½œç”¨</strong><br>1.èƒ½å¤Ÿå¯¹HTTPå’ŒFTPæœåŠ¡å™¨è¿›è¡Œå‹åŠ›å’Œæ€§èƒ½æµ‹è¯•ï¼Œ ä¹Ÿå¯ä»¥å¯¹ä»»ä½•æ•°æ®åº“è¿›è¡ŒåŒæ ·çš„æµ‹è¯•ï¼ˆé€šè¿‡JDBCï¼‰ã€‚<br>2.å®Œå…¨çš„å¯ç§»æ¤æ€§å’Œ100% çº¯javaã€‚<br>3.å®Œå…¨ Swing å’Œè½»é‡ç»„ä»¶æ”¯æŒï¼ˆé¢„ç¼–è¯‘çš„JARä½¿ç”¨ javax.swing.<em>)åŒ…ã€‚<br>4.å®Œå…¨å¤šçº¿ç¨‹ æ¡†æ¶å…è®¸é€šè¿‡å¤šä¸ªçº¿ç¨‹å¹¶å‘å–æ ·å’Œ é€šè¿‡å•ç‹¬çš„çº¿ç¨‹ç»„å¯¹ä¸åŒçš„åŠŸèƒ½åŒæ—¶å–æ ·ã€‚<br>5.ç²¾å¿ƒçš„GUIè®¾è®¡å…è®¸å¿«é€Ÿæ“ä½œå’Œæ›´ç²¾ç¡®çš„è®¡æ—¶ã€‚<br>6.ç¼“å­˜å’Œç¦»çº¿åˆ†æ/å›æ”¾æµ‹è¯•ç»“æœã€‚<br>*</em>JMeterçš„é«˜å¯æ‰©å±•æ€§**<br>1.å¯é“¾æ¥çš„å–æ ·å™¨å…è®¸æ— é™åˆ¶çš„æµ‹è¯•èƒ½åŠ›ã€‚<br>2.å„ç§è´Ÿè½½ç»Ÿè®¡è¡¨å’Œå¯é“¾æ¥çš„è®¡æ—¶å™¨å¯ä¾›é€‰æ‹©ã€‚<br>3.æ•°æ®åˆ†æå’Œå¯è§†åŒ–æ’ä»¶æä¾›äº†å¾ˆå¥½çš„å¯æ‰©å±•æ€§ä»¥åŠä¸ªæ€§åŒ–ã€‚<br>4.å…·æœ‰æä¾›åŠ¨æ€è¾“å…¥åˆ°æµ‹è¯•çš„åŠŸèƒ½ï¼ˆåŒ…æ‹¬Javascriptï¼‰ã€‚<br>5.æ”¯æŒè„šæœ¬ç¼–ç¨‹çš„å–æ ·å™¨ï¼ˆåœ¨1.9.2åŠä»¥ä¸Šç‰ˆæœ¬æ”¯æŒBeanShellï¼‰ã€‚</p><p><strong>JDK</strong></p><p>Jmeterä½¿ç”¨,éœ€è¦ä¾èµ–JDK1.8,å¯å‰å¾€å®˜ç½‘è¿›è¡Œä¸‹è½½</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å½’æ¡£ç‰ˆ:</span><br><span class="line">https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html</span><br><span class="line">#æœ€å¥½ä¸é‡‡ç”¨æœ€æ–°ç‰ˆæœ¬çš„JDKè¿›è¡Œä½¿ç”¨</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨è‡ªå·±ä¸‹è½½å¥½çš„ä¸‹è½½é“¾æ¥</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https://nmk0718.com.com/jdk/jdk-8u181-windows-x64.exe</span><br><span class="line">https://nmk0718.com.com/jdk/jdk-8u181-linux-x64.tar.gz</span><br></pre></td></tr></table></figure><p>windowså®‰è£…JDK</p><p>åŒå‡»ä¸‹è½½å¥½çš„exeä¸€ç›´ä¸‹ä¸€æ­¥å³å¯</p><p>é…ç½®ç¯å¢ƒå˜é‡:å³é”®æˆ‘çš„ç”µè„‘&gt;å±æ€§&gt;é«˜çº§ç³»ç»Ÿè®¾ç½®&gt;ç¯å¢ƒå˜é‡</p><img src="\image\image-20210319105114950.png"><p>æ–°å¢ç”¨æˆ·å˜é‡</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å˜é‡å:JAVA_HOME</span><br><span class="line">å˜é‡å€¼:C:\Program Files\Java\jdk1.8.0_181</span><br><span class="line"></span><br><span class="line">å˜é‡å:CLASSPATH</span><br><span class="line">å˜é‡å€¼:.;%JAVA_HOME%\lib\dt.jar;%JAVA_HOME%\lib\tools.jar</span><br><span class="line"></span><br><span class="line">å˜é‡å:Path</span><br><span class="line">å˜é‡å€¼:%JAVA_HOME%\bin;%JAVA_HOME%\jre\bin;</span><br></pre></td></tr></table></figure><p>é€šè¿‡cmdæŸ¥çœ‹æ˜¯å¦å·²ç»é…ç½®å®Œæˆ</p><img src="\image\image-20210319105859901.png"><p>linuxå®‰è£…JDK</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@centos ~]# cd /usr/local/</span><br><span class="line">[root@centos local]# wget https://nmk0718.com.com/jdk/jdk-8u181-linux-x64.tar.gz</span><br><span class="line">--2021-03-19 11:00:06--  https://nmk0718.com.com/jdk/jdk-8u181-linux-x64.tar.gz</span><br><span class="line">Resolving nmk0718.com.com (nmk0718.com.com)... 119.130.113.242</span><br><span class="line">Connecting to nmk0718.com.com (nmk0718.com.com)|119.130.113.242|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 185646832 (177M) [application/octet-stream]</span><br><span class="line">Saving to: â€˜jdk-8u181-linux-x64.tar.gzâ€™</span><br><span class="line"></span><br><span class="line">100%[================================================================================================================================================================&gt;] 185,646,832 57.6MB/s   in 3.1s   </span><br><span class="line"></span><br><span class="line">2021-03-19 11:00:09 (57.6 MB/s) - â€˜jdk-8u181-linux-x64.tar.gzâ€™ saved [185646832/185646832]</span><br><span class="line">[root@centos local]# tar zxvf jdk-8u181-linux-x64.tar.gz</span><br></pre></td></tr></table></figure><p>é…ç½®ç¯å¢ƒå˜é‡</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@centos local]# vi /etc/profile</span><br><span class="line">è¾“å…¥å¤§å†™çš„G,åˆ°è¾¾æ–‡æœ¬çš„æœ€å,è¾“å…¥iè¿›å…¥ç¼–è¾‘æ¨¡å¼åŠ å…¥ä»¥ä¸‹é…ç½®,æŒ‰escé”®ç›˜é€€å‡ºç¼–è¾‘æ¨¡å¼,è¾“å…¥:wqä¿å­˜å¹¶é€€å‡º</span><br><span class="line">JAVA_HOME=/usr/local/jdk1.8.0_181</span><br><span class="line">CLASSPATH=$CLASSPATH:$JAVA_HOME/lib/</span><br><span class="line">PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line">[root@centos local]# source /etc/profile</span><br><span class="line">[root@centos local]# java -version</span><br><span class="line">java version &quot;1.8.0_181&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_181-b13)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.181-b13, mixed mode)</span><br></pre></td></tr></table></figure><h3 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h3><p>å®˜ç½‘ä¸‹è½½åœ°å€</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https://mirrors.bfsu.edu.cn/apache//jmeter/source/</span><br></pre></td></tr></table></figure><p>ä¸‹è½½</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/apache/jmeter/binaries/apache-jmeter-5.2.zip</span><br></pre></td></tr></table></figure><p>è§£å‹jmeteråŒ…,è¿›å…¥apache-jmeter-5.2\binç›®å½•åŒå‡»jmeter.bat</p><img src="\image\image-20210312165019995.png"><p>ç•Œé¢æ›´æ”¹è¯­è¨€ä¸ºç®€ä½“ä¸­æ–‡(æ­¤æ¬¡ç”Ÿæ•ˆ)<br><img src="\image\image-20210312165057251.png"></p><p>ä¿®æ”¹jmeter.propertiesæ–‡ä»¶ä¸­çš„#language=enä¸ºlanguage=zh_CN,å°±å¯ä»¥å®ç°æ°¸ä¹…ä¸­æ–‡ç•Œé¢äº†</p><h4 id="è™šæ‹Ÿç”¨æˆ·å‹æµ‹"><a href="#è™šæ‹Ÿç”¨æˆ·å‹æµ‹" class="headerlink" title="è™šæ‹Ÿç”¨æˆ·å‹æµ‹"></a>è™šæ‹Ÿç”¨æˆ·å‹æµ‹</h4><p>æ·»åŠ çº¿ç¨‹ç»„</p><img src="\image\image-20210312165142531.png"><p>é…ç½®çº¿ç¨‹æ•°å’Œæ—¶é—´</p><img src="\image\image-20210315160425834.png"><p>çº¿ç¨‹æ•°ï¼šé…ç½®å‡ ä¸ªå°±ä»£è¡¨æœ‰å‡ ä¸ªè™šæ‹Ÿç”¨æˆ·</p><p>Ramp-Up æ—¶é—´ï¼ˆç§’ï¼‰:è¡¨ç¤ºä»ç¬¬ä¸€ä¸ªè™šæ‹Ÿç”¨æˆ·å¼€å§‹ç”Ÿæˆç›´åˆ°æœ€åä¸€ä¸ªè™šæ‹Ÿç”¨æˆ·å¼€å§‹ç”Ÿæˆçš„æ—¶é—´ï¼ŒåŠ å…¥é…ç½®äº†5ä¸ªè™šæ‹Ÿç”¨æˆ·ï¼ŒRamp-Up è®¾ç½®æˆ10sï¼Œé‚£ä¹ˆjmeterä¼šæ¯éš”2sç”Ÿæˆ1ä¸ªè™šæ‹Ÿç”¨æˆ·ï¼Œè¿™ä¸ªé€‰é¡¹ä¸»è¦çš„ä½œç”¨æ˜¯æ§åˆ¶å¹¶å‘çš„å¼ºåº¦ï¼Œä¸è®©è™šæ‹Ÿç”¨æˆ·åœ¨åŒä¸€æ—¶é—´äº§ç”Ÿä»è€Œå¯¹ç³»ç»Ÿé€ æˆå¤šå¤§çš„å¤æ‚ï¼ŒRamp-Upè®¾ç½®æˆ0ï¼Œé‚£ä¹ˆæ‰€æœ‰ç”¨æˆ·å°†ä¼šåŒæ—¶ç«‹å³äº§ç”Ÿ</p><p>å¾ªç¯æ•°ï¼šè¦ä¹ˆæ˜¯Næ¬¡ï¼Œè¦ä¹ˆæ˜¯æ°¸è¿œ</p><p>è°ƒåº¦å™¨ï¼šå°±æ˜¯å®šæ—¶æ‰§è¡Œçš„è®¾ç½®æ–¹å¼ã€‚æˆ‘ä»¬å¯ä»¥è®¾ç½®åœ¨æœªæ¥çš„æŸä¸ªæ—¶é—´å¼€å§‹æ‰§è¡Œä¹Ÿå¯ä»¥è®¾ç½®å¤šå°‘ç§’åå¼€å§‹æ‰§è¡Œã€‚</p><p>æ·»åŠ HTTPè¯·æ±‚</p><img src="\image\image-20210315161224028.png"><p>é…ç½®è¯·HTTPè¯·æ±‚</p><img src="\image\image-20210315161618996.png"><p>æ·»åŠ ç»“æœæ ‘å’ŒèšåˆæŠ¥å‘Š</p><img src="\image\image-20210315161726624.png"><p>é…ç½®HTTPä¿¡æ¯å¤´</p><img src="\image\image-20210315161937333.png"><p>æ‰§è¡Œè¯·æ±‚</p><img src="\image\image-20210315162059990.png"><p>èšåˆæŠ¥å‘Šä¸­å¯æŸ¥çœ‹åˆ°è¯·æ±‚æ€»æ•°,å¼‚å¸¸æ•°,ååé‡ç­‰</p><p>æŸ¥çœ‹ç»“æœæ ‘ä¸­å¯æŸ¥çœ‹åˆ°è¯·æ±‚çš„æ¥å£è¿”å›ç»“æœ</p><img src="\image\image-20210315162241338.png"><p>ç‚¹å‡»æ¸…é™¤æŒ‰é’®,æ¸…é™¤ä¸Šæ¬¡æ‰§è¡Œè¯·æ±‚çš„ç»“æœ</p><img src="\image\image-20210315162344364.png"><p>ä¿å­˜æµ‹è¯•è®¡åˆ’,ä¿å­˜åæ ¼å¼ä¸ºjmx</p><img src="\image\image-20210315162551652.png"><h4 id="çœŸå®ç”¨æˆ·å‚æ•°åŒ–å‹æµ‹"><a href="#çœŸå®ç”¨æˆ·å‚æ•°åŒ–å‹æµ‹" class="headerlink" title="çœŸå®ç”¨æˆ·å‚æ•°åŒ–å‹æµ‹"></a>çœŸå®ç”¨æˆ·å‚æ•°åŒ–å‹æµ‹</h4><p>æ¨¡æ‹Ÿå¤šç”¨æˆ·è¯·æ±‚</p><img src="\image\image-20210318145516123.png"><p>é…ç½®CSVæ•°æ®æ–‡ä»¶</p><img src="\image\image-20210318145657948.png"><p>åœ¨<strong>æµè§ˆ</strong>ä¸­å¼•å…¥å®šä¹‰çš„CSVæ–‡ä»¶,æŒ‡å®šæ–‡ä»¶çš„ç¼–ç æ ¼å¼ä¸ºUTF-8,å®šä¹‰å˜é‡å{phone,code},å˜é‡åç§°ä¸ªæ•°ä¸CSVä¸­çš„åˆ—æ•°ç›¸å¯¹åº”,å˜é‡åä»¥é€—å·åˆ†éš”</p><p>CSVæ•°æ®ç¤ºä¾‹</p><img src="\image\image-20210318145932235.png"><p>æ›´æ”¹HTTPè¯·æ±‚ä¸­çš„è¯·æ±‚æ•°æ®ä¸ºå‚æ•°åŒ–,æŠŠè¯·æ±‚çš„æ‰‹æœºå·å’ŒäºŒç»´ç ä¿¡æ¯é…ç½®ä¸ºä¸Šé¢å®šä¹‰çš„å‚æ•°,å‚æ•°æ ¼å¼ä¸º<strong>${å‚æ•°}</strong></p><img src="\image\image-20210318150323783.png"><p>æ·»åŠ è¡¨æ ¼æŸ¥çœ‹ç»“æœ</p><img src="\image\image-20210318150700170.png"><p>å‹æµ‹è¯·æ±‚å,å¯çœ‹åˆ°å…·ä½“è¯·æ±‚æ—¶é—´,è¯·æ±‚æ—¶é—´,è¿æ¥å¤§å°ç­‰å‚æ•°</p><img src="\image\image-20210318150630922.png"><h4 id="ä¿®æ”¹jmeterå¯åŠ¨å†…å­˜"><a href="#ä¿®æ”¹jmeterå¯åŠ¨å†…å­˜" class="headerlink" title="ä¿®æ”¹jmeterå¯åŠ¨å†…å­˜"></a>ä¿®æ”¹jmeterå¯åŠ¨å†…å­˜</h4><p>ä¿®æ”¹jmeter.batæ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ä¿®æ”¹å‰:</span><br><span class="line">HEAP=-Xms1g -Xmx1g -XX:MaxMetaspaceSize=256m</span><br><span class="line">ä¿®æ”¹å</span><br><span class="line">HEAP=-Xms1024m -Xmx2048m -XX:MaxMetaspaceSize=600m</span><br></pre></td></tr></table></figure><p>å¯åŠ¨meter.bat,å‘ç°å¼¹çª—é‡Œå‡ºç°çš„è¿˜æ˜¯256m,ç»æ£€æµ‹å‘ç°è¯¥å¼¹çª—å†…æ˜¾ç¤ºçš„åªæ˜¯å¼•å¯¼è¯­,ç±»ä¼¼æ¬¢è¿ä½ ,æ˜¯å†™æ­»çš„,ä¸æ˜¯çœŸå®çš„é…ç½®</p><img src="\image\image-20210318195746254.png"><p>å¯ä½¿ç”¨javaä¸­çš„jconsole(jdk\bin\jconsole.exe)æŸ¥çœ‹çœŸå®çš„å†…å­˜é…ç½®</p><img src="\image\image-20210318200420577.png"><p>è¿æ¥æœ¬åœ°çš„Jmeterè¿›ç¨‹,é€‰æ‹©VMæ¦‚è¦å¯æŸ¥çœ‹åˆ°çœŸå®çš„å†…å­˜é…ç½®</p><img src="\image\image-20210318200539443.png"><h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p>å®˜ç½‘ä¸‹è½½åœ°å€</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https://mirrors.bfsu.edu.cn/apache//jmeter/source/</span><br></pre></td></tr></table></figure><p>ä¸‹è½½</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/apache/jmeter/binaries/apache-jmeter-5.2.zip</span><br></pre></td></tr></table></figure><p>è§£å‹jmeteråŒ…</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">unzip apache-jmeter-5.2.zip</span><br></pre></td></tr></table></figure><p>é…ç½®ç¯å¢ƒå˜é‡</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#ç¼–è¾‘ç³»ç»Ÿç¯å¢ƒå˜é‡</span><br><span class="line">[root@centos ~]# vi /etc/profile</span><br><span class="line">#ä½¿ç”¨å¿«æ·é”® shift+g åˆ°æœ€åä¸€è¡Œ,åŠ å…¥ä»¥ä¸‹é…ç½®</span><br><span class="line">#JMETER_HOMEä¸ºjmeterè§£å‹ç›®å½•</span><br><span class="line"></span><br><span class="line">export JMETER_HOME=/usr/local/apache-jmeter-5.2</span><br><span class="line">export CLASSPATH=$JMETER_HOME/lib/ext/ApacheJMeter_core.jar:$JMETER_HOME/lib/jorphan.jar:$CLASSPATH</span><br><span class="line">export PATH=$JMETER_HOME/bin:$PATH</span><br><span class="line"></span><br><span class="line">#ä½¿åŠ å…¥çš„ç¯å¢ƒå˜é‡ç”Ÿæ•ˆ</span><br><span class="line">[root@centos ~]# source /etc/profile</span><br><span class="line"></span><br><span class="line">#æŸ¥çœ‹jmeterç‰ˆæœ¬,éªŒè¯å®‰è£…æˆåŠŸ</span><br><span class="line">[root@centos ~]# jmeter -v</span><br><span class="line">Mar 12, 2021 11:40:02 AM java.util.prefs.FileSystemPreferences$1 run</span><br><span class="line">INFO: Created user preferences directory.</span><br><span class="line">    _    ____   _    ____ _   _ _____       _ __  __ _____ _____ _____ ____</span><br><span class="line">   / \  |  _ \ / \  / ___| | | | ____|     | |  \/  | ____|_   _| ____|  _ \</span><br><span class="line">  / _ \ | |_) / _ \| |   | |_| |  _|    _  | | |\/| |  _|   | | |  _| | |_) |</span><br><span class="line"> / ___ \|  __/ ___ \ |___|  _  | |___  | |_| | |  | | |___  | | | |___|  _ &lt;</span><br><span class="line">/_/   \_\_| /_/   \_\____|_| |_|_____|  \___/|_|  |_|_____| |_| |_____|_| \_\ 5.2</span><br><span class="line"></span><br><span class="line">Copyright (c) 1999-2019 The Apache Software Foundation</span><br></pre></td></tr></table></figure><p>ä¸Šä¼ windowsä¿å­˜çš„æµ‹è¯•è®¡åˆ’.jmxæ–‡ä»¶åˆ°jmeterçš„binç›®å½•ä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@centos bin]# pwd</span><br><span class="line">/home/apache-jmeter-5.2/bin</span><br><span class="line">[root@centos bin]# ls</span><br><span class="line">ApacheJMeter.jar          create-rmi-keystore.sh  jaas.conf                   jmeter.properties  krb5.conf                   report-template         stoptest.sh         user.properties</span><br><span class="line">BeanShellAssertion.bshrc  examples                jdk-8u281-linux-x64.tar.gz  jmeter-server      log4j2.xml                  rmi_keystore.jks        system.properties   utility.groovy</span><br><span class="line">BeanShellFunction.bshrc   hc.parameters           jmeter                      jmeter-server.bat  mirror-server               saveservice.properties  templates           wget-log</span><br><span class="line">BeanShellListeners.bshrc  heapdump.cmd            jmeter.bat                  jmeter.sh          mirror-server.cmd           shutdown.cmd            threaddump.cmd</span><br><span class="line">BeanShellSampler.bshrc    heapdump.sh             jmeter-n.cmd                jmeter-t.cmd       mirror-server.sh            shutdown.sh             threaddump.sh</span><br><span class="line">create-rmi-keystore.bat   HttpRequest.jmx         jmeter-n-r.cmd              jmeterw.cmd        reportgenerator.properties  stoptest.cmd            upgrade.properties</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œæµ‹è¯•è®¡åˆ’</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@centos bin]# jmeter -n -t HttpRequest.jmx -l request.log</span><br><span class="line">Creating summariser &lt;summary&gt;</span><br><span class="line">Created the tree successfully using HttpRequest.jmx</span><br><span class="line">Starting standalone test @ Mon Mar 15 16:34:43 CST 2021 (1615797283522)</span><br><span class="line">Waiting for possible Shutdown/StopTestNow/HeapDump/ThreadDump message on port 4445</span><br><span class="line">summary =     10 in 00:00:02 =    5.3/s Avg:  1490 Min:  1343 Max:  1636 Err:     0 (0.00%)</span><br><span class="line">Tidying up ...    @ Mon Mar 15 16:34:46 CST 2021 (1615797286014)</span><br><span class="line">... end of run</span><br><span class="line"></span><br><span class="line">#å› jmxæ–‡ä»¶å’Œæ‰§è¡Œå‘½ä»¤ç›¸åŒ,æ•…æ— é¡»æŒ‡å®šjmxçš„ç»å¯¹è·¯å¾„,å½“æ‰§è¡Œå‘½ä»¤ä¸jmxä¸åœ¨åŒä¸€ç›®å½•ä¸‹æ—¶,éœ€è¦æŒ‡å®šç»å¯¹è·¯å¾„</span><br><span class="line">#-nï¼šä»¥NoGUIæ–¹å¼è¿è¡Œè„šæœ¬ -tï¼šåé¢æ¥è„šæœ¬åç§° -lï¼šåé¢æ¥æ—¥å¿—åç§°ï¼Œä¿å­˜è¿è¡Œç»“æœ</span><br><span class="line">#æ³¨æ„ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„Jmeterç‰ˆæœ¬æœ€å¥½ä¿æŒä¸€è‡´ï¼Œä¸ç„¶è¿è¡Œè„šæœ¬æ—¶ä¼šæŠ¥é”™</span><br><span class="line">#-låçš„æ–‡ä»¶åç¼€å¯éšæ„å–å,å»ºè®®ä»¥jtlç»“å°¾</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ç»“æœ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@centos bin]# cat request.log </span><br><span class="line">timeStamp,elapsed,label,responseCode,responseMessage,threadName,dataType,success,failureMessage,bytes,sentBytes,grpThreads,allThreads,URL,Latency,IdleTime,Connect</span><br><span class="line">1615797284375,1343,HTTPè¯·æ±‚,200,,çº¿ç¨‹ç»„ 1-10,text,true,,816,357,10,10,https://nmk0718.com/host-api/v3_0/login/VerificationCodeLogin,1340,0,1009</span><br><span class="line">1615797284375,1378,HTTPè¯·æ±‚,200,,çº¿ç¨‹ç»„ 1-9,text,true,,816,357,9,9,https://nmk0718.com/host-api/v3_0/login/VerificationCodeLogin,1377,0,999</span><br><span class="line">1615797284375,1406,HTTPè¯·æ±‚,200,,çº¿ç¨‹ç»„ 1-2,text,true,,816,357,8,8,https://nmk0718.com/host-api/v3_0/login/VerificationCodeLogin,1406,0,1004</span><br><span class="line">1615797284371,1412,HTTPè¯·æ±‚,200,,çº¿ç¨‹ç»„ 1-7,text,true,,816,357,7,7,https://nmk0718.com/host-api/v3_0/login/VerificationCodeLogin,1412,0,1013</span><br><span class="line">1615797284375,1504,HTTPè¯·æ±‚,200,,çº¿ç¨‹ç»„ 1-4,text,true,,816,357,6,6,https://nmk0718.com/host-api/v3_0/login/VerificationCodeLogin,1504,0,1008</span><br><span class="line">1615797284389,1513,HTTPè¯·æ±‚,200,,çº¿ç¨‹ç»„ 1-1,text,true,,816,357,5,5,https://nmk0718.com/host-api/v3_0/login/VerificationCodeLogin,1513,0,990</span><br><span class="line">1615797284388,1517,HTTPè¯·æ±‚,200,,çº¿ç¨‹ç»„ 1-6,text,true,,816,357,4,4,https://nmk0718.com/host-api/v3_0/login/VerificationCodeLogin,1516,0,992</span><br><span class="line">1615797284388,1578,HTTPè¯·æ±‚,200,,çº¿ç¨‹ç»„ 1-8,text,true,,816,357,3,3,https://nmk0718.com/host-api/v3_0/login/VerificationCodeLogin,1578,0,995</span><br><span class="line">1615797284373,1619,HTTPè¯·æ±‚,200,,çº¿ç¨‹ç»„ 1-5,text,true,,816,357,2,2,https://nmk0718.com/host-api/v3_0/login/VerificationCodeLogin,1619,0,1005</span><br><span class="line">1615797284375,1636,HTTPè¯·æ±‚,200,,çº¿ç¨‹ç»„ 1-3,text,true,,816,357,1,1,https://nmk0718.com/host-api/v3_0/login/VerificationCodeLogin,1636,0,1007</span><br><span class="line"></span><br><span class="line">#å¯ä»¥çœ‹åˆ°responseCodeè¿™ä¸€åˆ—éƒ½æ˜¯200,ä»£è¡¨è¯·æ±‚æˆåŠŸ</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹èšåˆæŠ¥å‘Š</p><p>æŠŠrequest.logä¸‹è½½åˆ°æ¡Œé¢,æ·»åŠ ä¸€ä¸ªæ–°çš„èšåˆæŠ¥å‘Š,å¯¼å…¥request.logå³å¯çœ‹åˆ°èšåˆæŠ¥å‘Š</p><img src="\image\image-20210315164725351.png"><p>æŸ¥çœ‹è¯·æ±‚ç»“æœ</p><p>ä»linuxå¯¼å‡ºçš„æ–‡ä»¶,æ˜¯çœ‹ä¸åˆ°è¯·æ±‚è¿”å›çš„æ•°æ®çš„</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@centos bin]# pwd</span><br><span class="line">/home/apache-jmeter-5.2/bin</span><br><span class="line">[root@centos bin]# vi jmeter.properties </span><br><span class="line">ä¿®æ”¹å‰:</span><br><span class="line">#jmeter.save.saveservice.response_data=false</span><br><span class="line">#jmeter.save.saveservice.samplerData=false</span><br><span class="line"></span><br><span class="line">ä¿®æ”¹å:</span><br><span class="line">jmeter.save.saveservice.response_data=true</span><br><span class="line">jmeter.save.saveservice.samplerData=true</span><br><span class="line"></span><br><span class="line">[root@centos bin]# vi user.properties </span><br><span class="line">#åœ¨æ–‡ä»¶çš„æœ€åé¢åŠ å…¥ä»¥ä¸‹é…ç½®</span><br><span class="line">jmeter.save.saveservice.output_format=xml</span><br><span class="line">jmeter.save.saveservice.response_data=true</span><br><span class="line">jmeter.save.saveservice.samplerData=true</span><br><span class="line">jmeter.save.saveservice.requestHeaders=true</span><br><span class="line">jmeter.save.saveservice.url=true</span><br><span class="line">jmeter.save.saveservice.responseHeaders=true</span><br></pre></td></tr></table></figure><p>å†é‡æ–°æ‰§è¡Œè„šæœ¬</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@centos bin]# jmeter -n -t HttpRequest.jmx -l request.jtl</span><br><span class="line">Creating summariser &lt;summary&gt;</span><br><span class="line">Created the tree successfully using HttpRequest.jmx</span><br><span class="line">Starting standalone test @ Fri Mar 19 15:51:56 CST 2021 (1616140316075)</span><br><span class="line">Waiting for possible Shutdown/StopTestNow/HeapDump/ThreadDump message on port 4445</span><br><span class="line">summary +     45 in 00:00:03 =   13.8/s Avg:  2299 Min:  2061 Max:  2663 Err:     0 (0.00%) Active: 56 Started: 100 Finished: 44</span><br><span class="line">summary +     55 in 00:00:01 =   63.7/s Avg:  3070 Min:  2649 Max:  3478 Err:     0 (0.00%) Active: 0 Started: 100 Finished: 100</span><br><span class="line">summary =    100 in 00:00:04 =   24.2/s Avg:  2723 Min:  2061 Max:  3478 Err:     0 (0.00%)</span><br><span class="line">Tidying up ...    @ Fri Mar 19 15:52:00 CST 2021 (1616140320872)</span><br><span class="line">... end of run</span><br></pre></td></tr></table></figure><p>åœ¨windowsæŸ¥çœ‹ç»“æœæ ‘</p><img src="\image\image-20210319155449953.png"><p>å¯¼å…¥request.jtlæ–‡ä»¶,å³å¯çœ‹åˆ°è¯·æ±‚çš„å“åº”æ•°æ®</p><img src="\image\image-20210319155539610.png">]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Apache JMeteræ˜¯Apacheç»„ç»‡å¼€å‘çš„åŸºäºJavaçš„å‹åŠ›æµ‹è¯•å·¥å…·.å®ƒå¯ä»¥ç”¨äºæµ‹è¯•é™æ€å’ŒåŠ¨æ€èµ„æºï¼Œä¾‹å¦‚é™æ€æ–‡ä»¶ã€Java å°æœåŠ¡ç¨‹åºã€CGI è„šæœ¬ã€Java å¯¹è±¡ã€æ•°æ®åº“ã€FTP æœåŠ¡å™¨ï¼Œ ç­‰ç­‰ã€‚JMeter å¯ä»¥ç”¨äºå¯¹æœåŠ¡å™¨ã€ç½‘ç»œæˆ–å¯¹è±¡æ¨¡æ‹Ÿå·¨å¤§çš„è´Ÿè½½ï¼Œæ¥è‡ªä¸åŒå‹</summary>
      
    
    
    
    
    <category term="Jmeter" scheme="https://nmk0718.github.io/tag/Jmeter/"/>
    
  </entry>
  
  <entry>
    <title>LogView</title>
    <link href="https://nmk0718.github.io/2021/03/27/LogView/"/>
    <id>https://nmk0718.github.io/2021/03/27/LogView/</id>
    <published>2021-03-27T06:05:00.000Z</published>
    <updated>2024-11-29T06:44:53.284Z</updated>
    
    <content type="html"><![CDATA[<p>1.ç™»å½•é˜¿é‡Œäº‘<br>ç™»å½•åœ°å€ï¼š<a href="https://signin.aliyun.com/login.htm#/main" target="_blank" rel="noopener">https://signin.aliyun.com/login.htm#/main</a>  </p><h5 id="å®æ—¶æ—¥å¿—"><a href="#å®æ—¶æ—¥å¿—" class="headerlink" title="å®æ—¶æ—¥å¿—"></a>å®æ—¶æ—¥å¿—</h5><img src="\image\image-20210224153302900.png"><p>ç”Ÿäº§é›†ç¾¤ liangjian-prod</p><img src="\image\image-20210224153409185.png"><p>æ— çŠ¶æ€&gt;å¯¹åº”æœåŠ¡</p><img src="\image\image-20210224153503908.png"><p>æŸ¥çœ‹åˆ°æœ‰ä¸¤ä¸ªæ—¥å¿—é€‰é¡¹</p><img src="\image\image-20210224153630926.png"><p><code>è§¦å‘å™¨</code>æ—çš„<strong>æ—¥å¿—</strong>å¯æŸ¥çœ‹500è¡Œ,ä¸æ”¯æŒè‡ªåŠ¨åˆ·æ–°</p><p><img src="\image\image-20210224153904216.png"><code>è¯¦æƒ…</code>æ—çš„<strong>æ—¥å¿—</strong>å¯æŸ¥çœ‹200è¡Œ,æ”¯æŒè‡ªåŠ¨åˆ·æ–°</p><img src="\image\image-20210224153951254.png"><h5 id="å†å²æ—¥å¿—"><a href="#å†å²æ—¥å¿—" class="headerlink" title="å†å²æ—¥å¿—"></a>å†å²æ—¥å¿—</h5><img src="\image\image-20210224153320967.png"><p>liangjian_prod</p><img src="\image\image-20210224154056234.png"><p>é€‰æ‹©å¯¹åº”çš„æœåŠ¡å³å¯æŸ¥æ‰¾åˆ°æ—¥å¿—</p><img src="\image\image-20210224154142147.png"><p>é€šè¿‡æ—¶é—´è¿‡æ»¤æ—¥å¿—</p><img src="\image\image-20210224154230642.png"><p>å…³é”®è¯æœç´¢,æŸ¥æ‰¾<strong>å¼€å¹´å¤§å‰</strong></p><img src="\image\image-20210224154807352.png"><p>ä¸Šå›¾ä¸­å‡ºç°äº†<strong>å‡ºå‚è¯·æ±‚æµæ°´</strong> æŸ¥è¯¢å‡ºå‚æµæ°´å­—æ®µ</p><img src="\image\image-20210224155037661.png"><p>ç»“æœä»€ä¹ˆéƒ½æ²¡è¿”å›,åœ¨<strong>å‡ºå‚è¯·æ±‚æµæ°´</strong>ååŠ ä¸Š*,å¯æŸ¥æ‰¾åˆ°, è¿™æ˜¯å› ä¸ºæ—¥å¿—çš„åˆ†è¯é—®é¢˜,âš ï¸æ³¨æ„è§‚å¯Ÿä¸‹å›¾å­—æ®µçš„çº¢è‰²æ¨ªçº¿</p><p>å®ƒæŠŠçº¢è‰²æ¨ªçº¿ä¸­çš„(å‡ºå‚è¯·æ±‚æµæ°´-å‡ºå‚:) å½“ä½œäº†ä¸€ä¸ªå­—æ®µ,æ‰€ä»¥åŒ¹é…æœç´¢ä¸åˆ°,è¿™æ—¶å€™å°±éœ€è¦åŠ *è¿›è¡Œæ¨¡ç³ŠåŒ¹é…</p><img src="\image\image-20210224155154773.png"><p>ä¹Ÿå¯ä»¥é€šè¿‡å¢åŠ åˆ†è¯,å†è¿›è¡ŒæŸ¥è¯¢</p><img src="\image\image-20210224173240145.png"><p>åœ¨å¯¹åº”è¾“å‡ºçš„å­—æ®µçš„åˆ†è¯ä¸­å¢åŠ æ‰€éœ€è¦çš„åˆ†è¯,æ­¤å¤„å¢åŠ ä¸ºä¸­æ–‡ï¼šå’Œä¸­æ–‡ï¼Œ</p><img src="\image\image-20210224173341635.png"><p>å†æ¬¡æŸ¥è¯¢å‘ç°,åˆ†è¯æˆåŠŸ</p><img src="\image\image-20210224173509000.png"><p>æŸ¥æ‰¾<strong>å¼€å¹´å¤§å‰</strong>å’Œ<strong>å¥³æ€§ä¸“åœº</strong></p><img src="\image\image-20210224155720883.png"><p>æŸ¥æ‰¾<strong>å¼€å¹´å¤§å‰</strong>æˆ–<strong>é™ˆçº¢</strong></p><img src="\image\image-20210224155913802.png"><p>æŸ¥æ‰¾<strong>å¼€å¹´å¤§å‰</strong>ä¸åŒ…å«<strong>é™ˆçº¢</strong></p><img src="\image\image-20210224160005711.png"><p>å…·ä½“å¯æŸ¥çœ‹ä»¥ä¸‹è¿ç®—ç¬¦æˆ–è®¿é—®é˜¿é‡Œäº‘å¸®åŠ©æ–‡æ¡£ï¼š<a href="https://help.aliyun.com/document_detail/29060.html?spm=a2c4g.11186623.6.829.f44f672c3F2old" target="_blank" rel="noopener">https://help.aliyun.com/document_detail/29060.html?spm=a2c4g.11186623.6.829.f44f672c3F2old</a></p><table><thead><tr><th align="left">è¿ç®—ç¬¦</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">and</td><td align="left">andè¿ç®—ç¬¦ã€‚ä¾‹å¦‚<code>request_method:GET and status:200</code>ã€‚å¦‚æœå¤šä¸ªå…³é”®è¯ä¹‹é—´æ²¡æœ‰è¯­æ³•å…³é”®è¯ï¼Œé»˜è®¤ä¸ºandå…³ç³»ï¼Œä¾‹å¦‚<code>GET 200 cn-shanghai</code>ç­‰åŒäº<code>GET and 200 and cn-shanghai</code>ã€‚</td></tr><tr><td align="left">or</td><td align="left">orè¿ç®—ç¬¦ã€‚ä¾‹å¦‚<code>request_method:GET or status:200</code>ã€‚</td></tr><tr><td align="left">not</td><td align="left">notè¿ç®—ç¬¦ã€‚ä¾‹å¦‚<code>request_method:GET not status:200</code>ã€<code>not status:200</code>ã€‚</td></tr><tr><td align="left">( )</td><td align="left">ç”¨äºæé«˜æ‹¬å·å†…æŸ¥è¯¢æ¡ä»¶çš„ä¼˜å…ˆçº§ã€‚ä¾‹å¦‚<code>(request_method:GET or request_method:POST) and status:200</code>ã€‚</td></tr><tr><td align="left">:</td><td align="left">ç”¨äºå­—æ®µæŸ¥è¯¢ï¼ˆKey:Valueï¼‰ï¼Œä¾‹å¦‚<code>request_method:GET</code>ã€‚å¦‚æœå­—æ®µåç§°æˆ–è€…å­—æ®µå€¼å†…æœ‰ç©ºæ ¼ã€å†’å·ï¼ˆ:ï¼‰ç­‰ä¿ç•™å­—ç¬¦ï¼Œè¯·ä½¿ç”¨åŒå¼•å·ï¼ˆâ€â€ï¼‰åŒ…è£¹å­—æ®µåç§°æˆ–è€…å­—æ®µå€¼ï¼Œä¾‹å¦‚<code>&quot;file info&quot;:apsara</code>ã€‚</td></tr><tr><td align="left">â€œâ€</td><td align="left">ä½¿ç”¨åŒå¼•å·ï¼ˆâ€â€ï¼‰åŒ…è£¹ä¸€ä¸ªè¯­æ³•å…³é”®è¯ï¼Œå¯ä»¥å°†è¯¥è¯­æ³•å…³é”®è¯è½¬æ¢æˆæ™®é€šå­—ç¬¦ã€‚ä¾‹å¦‚<code>&quot;and&quot;</code>è¡¨ç¤ºæŸ¥è¯¢åŒ…å«andçš„æ—¥å¿—ï¼Œæ­¤å¤„çš„andä¸ä»£è¡¨è¿ç®—ç¬¦ã€‚åœ¨å­—æ®µæŸ¥è¯¢ä¸­åŒå¼•å·ï¼ˆâ€â€ï¼‰å†…çš„æ‰€æœ‰è¯è¢«å½“æˆä¸€ä¸ªæ•´ä½“ã€‚</td></tr><tr><td align="left">\</td><td align="left">è½¬ä¹‰ç¬¦å·ï¼Œç”¨äºè½¬ä¹‰åŒå¼•å·ï¼ˆâ€â€ï¼‰ï¼Œè½¬ä¹‰åçš„å¼•å·è¡¨ç¤ºç¬¦å·æœ¬èº«ã€‚ä¾‹å¦‚æ—¥å¿—å†…å®¹ä¸º<code>instance_id:nginx&quot;01&quot;</code>ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<code>instance_id:nginx\&quot;01\&quot;</code>è¿›è¡ŒæŸ¥è¯¢ã€‚</td></tr><tr><td align="left">*</td><td align="left">é€šé…ç¬¦æŸ¥è¯¢ï¼ŒåŒ¹é…é›¶ä¸ªã€å•ä¸ªã€å¤šä¸ªå­—ç¬¦ã€‚ä¾‹å¦‚<code>host:www.yl.mo*k.com</code>ã€‚<strong>è¯´æ˜</strong> æ—¥å¿—æœåŠ¡ä¼šåœ¨æ‰€æœ‰æ—¥å¿—ä¸­ä¸ºæ‚¨æŸ¥è¯¢åˆ°ç¬¦åˆæ¡ä»¶çš„100ä¸ªè¯ï¼Œè¿”å›åŒ…å«è¿™100ä¸ªè¯å¹¶æ»¡è¶³æŸ¥è¯¢æ¡ä»¶çš„æ‰€æœ‰æ—¥å¿—ã€‚</td></tr><tr><td align="left">?</td><td align="left">é€šé…ç¬¦æŸ¥è¯¢ï¼ŒåŒ¹é…å•ä¸ªå­—ç¬¦ã€‚ä¾‹å¦‚<code>host:www.yl.mo?k.com</code>ã€‚</td></tr><tr><td align="left">&gt;</td><td align="left">æŸ¥è¯¢æŸå­—æ®µçš„å€¼å¤§äºæŸæ•°å€¼çš„æ—¥å¿—ã€‚ä¾‹å¦‚<code>request_time&gt;100</code>ã€‚</td></tr><tr><td align="left">&gt;=</td><td align="left">æŸ¥è¯¢æŸå­—æ®µçš„å€¼å¤§äºæˆ–ç­‰äºæŸæ•°å€¼çš„æ—¥å¿—ã€‚ä¾‹å¦‚<code>request_time&gt;=100</code>ã€‚</td></tr><tr><td align="left">&lt;</td><td align="left">æŸ¥è¯¢æŸå­—æ®µçš„å€¼å°äºæŸæ•°å€¼çš„æ—¥å¿—ã€‚ä¾‹å¦‚<code>request_time&lt;100</code>ã€‚</td></tr><tr><td align="left">&lt;=</td><td align="left">æŸ¥è¯¢æŸå­—æ®µçš„å€¼å°äºæˆ–ç­‰äºæŸæ•°å€¼çš„æ—¥å¿—ã€‚ä¾‹å¦‚<code>request_time&lt;=100</code>ã€‚</td></tr><tr><td align="left">=</td><td align="left">æŸ¥è¯¢æŸå­—æ®µçš„å€¼ç­‰äºæŸæ•°å€¼çš„æ—¥å¿—ã€‚é’ˆå¯¹doubleã€longç±»å‹çš„å­—æ®µï¼Œç­‰å·ï¼ˆ=ï¼‰å’Œå†’å·ï¼ˆ:ï¼‰ä½œç”¨ç›¸åŒã€‚ä¾‹å¦‚<code>request_time=100</code>ç­‰åŒäº<code>request_time:100</code>ã€‚</td></tr><tr><td align="left">in</td><td align="left">æŸ¥è¯¢æŸå­—æ®µçš„å€¼å¤„äºæŸæ•°å€¼èŒƒå›´å†…çš„æ—¥å¿—ï¼Œä¸­æ‹¬å·è¡¨ç¤ºé—­åŒºé—´ï¼Œå°æ‹¬å·è¡¨ç¤ºå¼€åŒºé—´ï¼Œä¸¤ä¸ªæ•°å­—ä¹‹é—´ä½¿ç”¨ç©ºæ ¼åˆ†éš”ã€‚ä¾‹å¦‚<code>request_time in [100 200]</code>æˆ–<code>request_time in (100 200]</code>ã€‚<strong>è¯´æ˜</strong> inåªèƒ½ä¸ºå°å†™å­—æ¯ã€‚</td></tr><tr><td align="left"><strong><strong>source</strong></strong></td><td align="left">æŸ¥è¯¢æŸä¸ªæ—¥å¿—æºçš„æ—¥å¿—ï¼Œæ”¯æŒé€šé…ç¬¦ã€‚ä¾‹å¦‚<code>__source__:&quot;192.0.2.*&quot;</code>ã€‚<strong>æ³¨æ„</strong> æ—¥å¿—æœåŠ¡ä¸­çš„<strong><strong>source</strong></strong>ä¸ºä¿ç•™å­—æ®µï¼Œå¯ç¼©å†™ä¸º<strong>source</strong>ã€‚å¦‚æœæ‚¨è‡ªå®šä¹‰çš„å­—æ®µä¸­å­˜åœ¨<strong>source</strong>å­—æ®µï¼Œåˆ™ä¼šä¸æ—¥å¿—æœåŠ¡ä¿ç•™å­—æ®µ<strong>source</strong>å†²çªï¼Œæ­¤æ—¶æ‚¨éœ€è¦ä½¿ç”¨<strong>Source</strong>ã€<strong>SOURCE</strong>ç­‰è¯æŸ¥è¯¢è‡ªå®šä¹‰çš„å­—æ®µã€‚</td></tr><tr><td align="left"><strong><strong>tag</strong></strong></td><td align="left">é€šè¿‡å…ƒæ•°æ®ä¿¡æ¯æŸ¥è¯¢æ—¥å¿—ã€‚ä¾‹å¦‚<code>__tag__:__receive_time__:1609837139</code>ã€‚</td></tr><tr><td align="left"><strong><strong>topic</strong></strong></td><td align="left">æŸ¥è¯¢æŸæ—¥å¿—ä¸»é¢˜ä¸‹çš„æ—¥å¿—ã€‚ä¾‹å¦‚<code>__topic__:nginx_access_log</code>ã€‚</td></tr></tbody></table><p>ä¸Šä¸‹æ–‡æµè§ˆ</p><img src="\image\image-20210224160609787.png"><p>ç‚¹å‡»ä¸Šä¸‹æ–‡æµè§ˆ,å¾€ä¸Šæ»šåŠ¨å¯æŸ¥çœ‹å½“å‰æ—¥å¿—çš„å‰å‡ æ¡æ—¥å¿—,å¾€ä¸‹æ»šåŠ¨å¯æŸ¥çœ‹å½“å‰æ—¥å¿—çš„åå‡ æ¡æ—¥å¿—,å¯é€‰æ‹©<code>é«˜äº®å­—ç¬¦ä¸²</code>å’Œ<code>è¿‡æ»¤æ¡ä»¶</code></p><img src="\image\image-20210224160751446.png"><p>å¯æŠŠå¸¸ç”¨çš„æŸ¥è¯¢è¯­å¥ä¿å­˜ä¸ºå¿«é€ŸæŸ¥è¯¢</p><img src="\image\image-20210224163256372.png"><p>è®¾ç½®å¯¹åº”çš„æŸ¥è¯¢åç§°</p><img src="\image\image-20210224163327355.png"><p>ä¸‹æ¬¡å¯ç›´æ¥åœ¨å¿«é€ŸæŸ¥è¯¢ä¸­ç›´æ¥æŸ¥çœ‹,æ— éœ€å†æ‰‹åŠ¨ç¼–å†™è¯­å¥</p><img src="\image\image-20210224163618059.png"><p>å¯é€šè¿‡å¦å­˜ä¸ºå‘Šè­¦è¿›è¡Œå‘Šè­¦é€šçŸ¥è¯¥é¡¹ç›®è´Ÿè´£äºº(æ­¤ä¸ºç¤ºä¾‹,é€šå¸¸è®¾ç½®æŸ¥è¯¢ä¿¡æ¯ä¸ºerrorè¿›è¡Œè¿‡æ»¤)</p><img src="\image\image-20210224170527703.png"><p>é…ç½®ä»ªè¡¨ç›˜ç­‰ä¿¡æ¯</p><img src="\image\image-20210224170812824.png"><p>å‘Šè­¦é€šçŸ¥é€‰æ‹©é’‰é’‰</p><img src="\image\image-20210224171054017.png"><p>WebHookåœ°å€ä¸ºé’‰é’‰ç¾¤ç»„ä¸­çš„WebHookåœ°å€</p><img src="\image\image-20210224171141251.png"><p>åœ¨ä¸‹æ–¹è®¾ç½®<strong>å…³é”®è¯</strong>.è¦ä¸é…ç½®çš„å‘Šè­¦ä¿¡æ¯ä¸€è‡´,å¦åˆ™ä¼šå‡ºç°é€šçŸ¥å¤±è´¥</p><img src="\image\image-20210224172650615.png"><p>å› è®¾ç½®é—´éš”ä¸º5åˆ†é’Ÿ,5åˆ†é’Ÿåé’‰é’‰ç¾¤ç»„æ”¶åˆ°å‘Šè­¦ä¿¡æ¯</p><img src="\image\image-20210224172147596.png"><p>å¯æŸ¥çœ‹å‘Šè­¦æ¬¡æ•°å’Œå‘Šè­¦å†å²</p><img src="\image\image-20210224172517286.png"><p>å‘Šè­¦è¡¨è¾¾å¼å¯å‚è€ƒé˜¿é‡Œäº‘å¸®åŠ©æ–‡æ¡£ï¼š<a href="https://help.aliyun.com/document_detail/98379.html?spm=5176.2020520112.0.dexternal.7ec034c0CHYDNp" target="_blank" rel="noopener">https://help.aliyun.com/document_detail/98379.html?spm=5176.2020520112.0.dexternal.7ec034c0CHYDNp</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;1.ç™»å½•é˜¿é‡Œäº‘&lt;br&gt;ç™»å½•åœ°å€ï¼š&lt;a href=&quot;https://signin.aliyun.com/login.htm#/main&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://signin.aliyun.com/login.htm#/m</summary>
      
    
    
    
    
    <category term="log" scheme="https://nmk0718.github.io/tag/log/"/>
    
  </entry>
  
  <entry>
    <title>Kunbernetesè‡ªåŠ¨åŒ–éƒ¨ç½²</title>
    <link href="https://nmk0718.github.io/2020/10/17/Kunbernetes%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/"/>
    <id>https://nmk0718.github.io/2020/10/17/Kunbernetes%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/</id>
    <published>2020-10-17T01:29:00.000Z</published>
    <updated>2024-11-29T06:44:58.792Z</updated>
    
    <content type="html"><![CDATA[<p>éƒ¨ç½²æµç¨‹å¦‚ä¸‹å›¾</p><img src="\image\1.png"><h3 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h3><p>æ­¤æ–‡æ¡£ä¸ºå®‰è£… Kubernetes å•MasterèŠ‚ç‚¹</p><h4 id="é…ç½®è¦æ±‚"><a href="#é…ç½®è¦æ±‚" class="headerlink" title="é…ç½®è¦æ±‚"></a>é…ç½®è¦æ±‚</h4><ul><li>è‡³å°‘2å°<strong>2æ ¸4G</strong>çš„æœåŠ¡å™¨</li><li><strong>Cent OS 7.6 / 7.7 / 7.8</strong></li></ul><h4 id="æ£€æŸ¥-centos-hostname"><a href="#æ£€æŸ¥-centos-hostname" class="headerlink" title="æ£€æŸ¥ centos / hostname"></a>æ£€æŸ¥ centos / hostname</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åœ¨ master èŠ‚ç‚¹å’Œ worker èŠ‚ç‚¹éƒ½è¦æ‰§è¡Œ</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># cat /etc/redhat-release</span></span><br><span class="line">CentOS Linux release 7.8.2003 (Core)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¤å¤„ hostname çš„è¾“å‡ºå°†ä¼šæ˜¯è¯¥æœºå™¨åœ¨ Kubernetes é›†ç¾¤ä¸­çš„èŠ‚ç‚¹åå­—</span></span><br><span class="line"><span class="comment"># ä¸èƒ½ä½¿ç”¨ localhost ä½œä¸ºèŠ‚ç‚¹çš„åå­—</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># hostname</span></span><br><span class="line">k8s-node1</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯·ä½¿ç”¨ lscpu å‘½ä»¤ï¼Œæ ¸å¯¹ CPU ä¿¡æ¯</span></span><br><span class="line"><span class="comment"># Architecture: x86_64    æœ¬å®‰è£…æ–‡æ¡£ä¸æ”¯æŒ arm æ¶æ„</span></span><br><span class="line"><span class="comment"># CPU(s):       2         CPU å†…æ ¸æ•°é‡ä¸èƒ½ä½äº 2</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># lscpu</span></span><br><span class="line">Architecture:          x86_64</span><br><span class="line">CPU op-mode(s):        32-bit, 64-bit</span><br><span class="line">Byte Order:            Little Endian</span><br><span class="line">CPU(s):                2</span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹-hostname"><a href="#ä¿®æ”¹-hostname" class="headerlink" title="ä¿®æ”¹ hostname"></a>ä¿®æ”¹ hostname</h4><p>å¦‚æœæ‚¨éœ€è¦ä¿®æ”¹ hostnameï¼Œå¯æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ï¼š</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¿®æ”¹ hostname</span></span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname your-new-host-name</span><br><span class="line"><span class="comment"># æŸ¥çœ‹ä¿®æ”¹ç»“æœ</span></span><br><span class="line">hostnamectl status</span><br><span class="line"><span class="comment"># è®¾ç½® hostname è§£æ</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"127.0.0.1   <span class="variable">$(hostname)</span>"</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure><h4 id="æ£€æŸ¥ç½‘ç»œ"><a href="#æ£€æŸ¥ç½‘ç»œ" class="headerlink" title="æ£€æŸ¥ç½‘ç»œ"></a>æ£€æŸ¥ç½‘ç»œ</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-node1 ~]# ip route show</span><br><span class="line">default via 192.168.229.2 dev ens33 proto static metric 100 </span><br><span class="line">192.168.229.0/24 dev ens33 proto kernel scope link src 192.168.229.6 metric 100 </span><br><span class="line"></span><br><span class="line">[root@k8s-node1 ~]# ip address</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:67:6f:10 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.229.6/24 brd 192.168.229.255 scope global noprefixroute ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p>kubeletä½¿ç”¨çš„IPåœ°å€</p><ul><li><code>ip route show</code> å‘½ä»¤ä¸­ï¼Œå¯ä»¥çŸ¥é“æœºå™¨çš„é»˜è®¤ç½‘å¡ï¼Œé€šå¸¸æ˜¯ <code>eth0</code>ï¼Œå¦‚ <strong><em>default via 172.21.0.23 dev eth0</em></strong> . è¿™é‡Œçš„æ˜¯<code>ens33</code></li><li><code>ip address</code> å‘½ä»¤ä¸­ï¼Œå¯æ˜¾ç¤ºé»˜è®¤ç½‘å¡çš„ IP åœ°å€ï¼ŒKubernetes å°†ä½¿ç”¨æ­¤ IP åœ°å€ä¸é›†ç¾¤å†…çš„å…¶ä»–èŠ‚ç‚¹é€šä¿¡ï¼Œå¦‚ <code>192.168.229.6</code></li><li>æ‰€æœ‰èŠ‚ç‚¹ä¸Š Kubernetes æ‰€ä½¿ç”¨çš„ IP åœ°å€å¿…é¡»å¯ä»¥äº’é€šï¼ˆæ— éœ€ NAT æ˜ å°„ã€æ— å®‰å…¨ç»„æˆ–é˜²ç«å¢™éš”ç¦»ï¼‰</li></ul><h4 id="å®‰è£…dockeråŠkubelet"><a href="#å®‰è£…dockeråŠkubelet" class="headerlink" title="å®‰è£…dockeråŠkubelet"></a>å®‰è£…dockeråŠkubelet</h4><p>ç¡®è®¤æ˜¯å¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶</p><ul><li>æ˜¾ç¤º å®‰è£… docker/kubelet çš„æ–‡æ¡£</li><li>æˆ‘çš„ä»»æ„èŠ‚ç‚¹ centos ç‰ˆæœ¬ä¸º 7.6 / 7.7 æˆ– 7.8</li><li>æˆ‘çš„ä»»æ„èŠ‚ç‚¹ CPU å†…æ ¸æ•°é‡å¤§äºç­‰äº 2ï¼Œä¸”å†…å­˜å¤§äºç­‰äº 4G</li><li>æˆ‘çš„ä»»æ„èŠ‚ç‚¹ hostname ä¸æ˜¯ localhostï¼Œä¸”ä¸åŒ…å«ä¸‹åˆ’çº¿ã€å°æ•°ç‚¹ã€å¤§å†™å­—æ¯</li><li>æˆ‘çš„ä»»æ„èŠ‚ç‚¹éƒ½æœ‰å›ºå®šçš„å†…ç½‘ IP åœ°å€</li><li>æˆ‘çš„ä»»æ„èŠ‚ç‚¹éƒ½åªæœ‰ä¸€ä¸ªç½‘å¡ï¼Œå¦‚æœæœ‰ç‰¹æ®Šç›®çš„ï¼Œæˆ‘å¯ä»¥åœ¨å®Œæˆ K8S å®‰è£…åå†å¢åŠ æ–°çš„ç½‘å¡</li><li>æˆ‘çš„ä»»æ„èŠ‚ç‚¹ä¸Š <a href="https://www.kuboard.cn/install/install-k8s.html#æ£€æŸ¥ç½‘ç»œ" target="_blank" rel="noopener">Kubeletä½¿ç”¨çš„ IP åœ°å€</a> å¯äº’é€šï¼ˆæ— éœ€ NAT æ˜ å°„å³å¯ç›¸äº’è®¿é—®ï¼‰ï¼Œä¸”æ²¡æœ‰é˜²ç«å¢™ã€å®‰å…¨ç»„éš”ç¦»</li><li>æˆ‘çš„ä»»æ„èŠ‚ç‚¹ä¸ä¼šç›´æ¥ä½¿ç”¨ docker run æˆ– docker-compose è¿è¡Œå®¹å™¨</li></ul><p>ä½¿ç”¨ root èº«ä»½åœ¨æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œå¦‚ä¸‹ä»£ç ï¼Œä»¥å®‰è£…è½¯ä»¶ï¼š</p><ul><li>docker</li><li>nfs-utils</li><li>kubectl / kubeadm / kubelet</li></ul><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åœ¨ master èŠ‚ç‚¹å’Œ worker èŠ‚ç‚¹éƒ½è¦æ‰§è¡Œ</span></span><br><span class="line"><span class="comment"># é˜¿é‡Œäº‘ docker hub é•œåƒ</span></span><br><span class="line"><span class="built_in">export</span> REGISTRY_MIRROR=https://registry.cn-hangzhou.aliyuncs.com</span><br><span class="line">curl -sSL https://kuboard.cn/install-script/v1.19.x/install_kubelet.sh | sh -s 1.19.2</span><br></pre></td></tr></table></figure><h4 id="åˆå§‹åŒ–-master-èŠ‚ç‚¹"><a href="#åˆå§‹åŒ–-master-èŠ‚ç‚¹" class="headerlink" title="åˆå§‹åŒ– master èŠ‚ç‚¹"></a>åˆå§‹åŒ– master èŠ‚ç‚¹</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ</span></span><br><span class="line"><span class="comment"># æ›¿æ¢ x.x.x.x ä¸º master èŠ‚ç‚¹å®é™… IPï¼ˆè¯·ä½¿ç”¨å†…ç½‘ IPï¼‰</span></span><br><span class="line"><span class="comment"># export å‘½ä»¤åªåœ¨å½“å‰ shell ä¼šè¯ä¸­æœ‰æ•ˆï¼Œå¼€å¯æ–°çš„ shell çª—å£åï¼Œå¦‚æœè¦ç»§ç»­å®‰è£…è¿‡ç¨‹ï¼Œè¯·é‡æ–°æ‰§è¡Œæ­¤å¤„çš„ export å‘½ä»¤</span></span><br><span class="line"><span class="built_in">export</span> MASTER_IP=x.x.x.x</span><br><span class="line"><span class="comment"># æ›¿æ¢ apiserver.demo ä¸º æ‚¨æƒ³è¦çš„ dnsName</span></span><br><span class="line"><span class="built_in">export</span> APISERVER_NAME=apiserver.demo</span><br><span class="line"><span class="comment"># Kubernetes å®¹å™¨ç»„æ‰€åœ¨çš„ç½‘æ®µï¼Œè¯¥ç½‘æ®µå®‰è£…å®Œæˆåï¼Œç”± kubernetes åˆ›å»ºï¼Œäº‹å…ˆå¹¶ä¸å­˜åœ¨äºæ‚¨çš„ç‰©ç†ç½‘ç»œä¸­</span></span><br><span class="line"><span class="built_in">export</span> POD_SUBNET=10.100.0.1/16</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;MASTER_IP&#125;</span>    <span class="variable">$&#123;APISERVER_NAME&#125;</span>"</span> &gt;&gt; /etc/hosts</span><br><span class="line">curl -sSL https://kuboard.cn/install-script/v1.19.x/init_master.sh | sh -s 1.19.2</span><br></pre></td></tr></table></figure><h5 id="æ£€æŸ¥-master-åˆå§‹åŒ–ç»“æœ"><a href="#æ£€æŸ¥-master-åˆå§‹åŒ–ç»“æœ" class="headerlink" title="æ£€æŸ¥ master åˆå§‹åŒ–ç»“æœ"></a><strong>æ£€æŸ¥ master åˆå§‹åŒ–ç»“æœ</strong></h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œç­‰å¾… 3-10 åˆ†é’Ÿï¼Œç›´åˆ°æ‰€æœ‰çš„å®¹å™¨ç»„å¤„äº Running çŠ¶æ€</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># watch kubectl get pod -n kube-system -o wide</span></span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE   IP              NODE        </span><br><span class="line">calico-kube-controllers-6c89d944d5-zwcl2   1/1     Running   3          43h   10.100.36.75    k8s-node1   </span><br><span class="line">calico-node-6gcj9                          1/1     Running   3          43h   192.168.229.6   k8s-node1   </span><br><span class="line">calico-node-pgqjz                          1/1     Running   5          42h   192.168.229.7   k8s-node2   </span><br><span class="line">coredns-59c898cd69-7vnfg                   1/1     Running   3          43h   10.100.36.76    k8s-node1   </span><br><span class="line">coredns-59c898cd69-fmrjf                   1/1     Running   3          43h   10.100.36.77    k8s-node1   </span><br><span class="line">etcd-k8s-node1                             1/1     Running   3          43h   192.168.229.6   k8s-node1   </span><br><span class="line">kube-apiserver-k8s-node1                   1/1     Running   3          43h   192.168.229.6   k8s-node1   </span><br><span class="line">kube-controller-manager-k8s-node1          1/1     Running   3          43h   192.168.229.6   k8s-node1   </span><br><span class="line">kube-proxy-6sfnc                           1/1     Running   5          42h   192.168.229.7   k8s-node2   </span><br><span class="line">kube-proxy-gpfrv                           1/1     Running   3          43h   192.168.229.6   k8s-node1   </span><br><span class="line">kube-scheduler-k8s-node1                   1/1     Running   3          43h   192.168.229.6   k8s-node1   </span><br><span class="line">kuboard-655785f55c-rc52g                   1/1     Running   1          23h   10.100.36.78    k8s-node1   </span><br><span class="line">metrics-server-7dbf6c4558-5ggbt            1/1     Running   3          21h   192.168.229.7   k8s-node2  </span><br><span class="line"><span class="comment"># æŸ¥çœ‹ master èŠ‚ç‚¹åˆå§‹åŒ–ç»“æœ</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># kubectl get nodes -o wide</span></span><br><span class="line">NAME        STATUS   ROLES    AGE   VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION           CONTAINER-RUNTIME</span><br><span class="line">k8s-node1   Ready    master   43h   v1.19.2   192.168.229.6   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1127.el7.x86_64   docker://19.3.11</span><br></pre></td></tr></table></figure><h4 id="åˆå§‹åŒ–-workerèŠ‚ç‚¹"><a href="#åˆå§‹åŒ–-workerèŠ‚ç‚¹" class="headerlink" title="åˆå§‹åŒ– workerèŠ‚ç‚¹"></a>åˆå§‹åŒ– workerèŠ‚ç‚¹</h4><h5 id="è·å¾—-joinå‘½ä»¤å‚æ•°"><a href="#è·å¾—-joinå‘½ä»¤å‚æ•°" class="headerlink" title="è·å¾— joinå‘½ä»¤å‚æ•°"></a>è·å¾— joinå‘½ä»¤å‚æ•°</h5><p><strong>åœ¨ master èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</strong></p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ</span></span><br><span class="line">kubeadm token create --<span class="built_in">print</span>-join-command</span><br></pre></td></tr></table></figure><p>å¯è·å–kubeadm join å‘½ä»¤åŠå‚æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubeadm token create å‘½ä»¤çš„è¾“å‡º</span></span><br><span class="line">kubeadm join apiserver.demo:6443 --token mpfjma.4vjjg8flqihor4vt     --discovery-token-ca-cert-hash sha256:6f7a8e40a810323672de5eee6f4d19aa2dbdb38411845a1bf5dd63485c43d303</span><br></pre></td></tr></table></figure><p>æœ‰æ•ˆæ—¶é—´</p><p>è¯¥ token çš„æœ‰æ•ˆæ—¶é—´ä¸º 2 ä¸ªå°æ—¶ï¼Œ2å°æ—¶å†…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ­¤ token åˆå§‹åŒ–ä»»æ„æ•°é‡çš„ worker èŠ‚ç‚¹ã€‚</p><p><strong>é’ˆå¯¹æ‰€æœ‰çš„ worker èŠ‚ç‚¹æ‰§è¡Œ</strong></p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åªåœ¨ worker èŠ‚ç‚¹æ‰§è¡Œ</span></span><br><span class="line"><span class="comment"># æ›¿æ¢ x.x.x.x ä¸º master èŠ‚ç‚¹çš„å†…ç½‘ IP</span></span><br><span class="line"><span class="built_in">export</span> MASTER_IP=x.x.x.x</span><br><span class="line"><span class="comment"># æ›¿æ¢ apiserver.demo ä¸ºåˆå§‹åŒ– master èŠ‚ç‚¹æ—¶æ‰€ä½¿ç”¨çš„ APISERVER_NAME</span></span><br><span class="line"><span class="built_in">export</span> APISERVER_NAME=apiserver.demo</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;MASTER_IP&#125;</span>    <span class="variable">$&#123;APISERVER_NAME&#125;</span>"</span> &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›¿æ¢ä¸º master èŠ‚ç‚¹ä¸Š kubeadm token create å‘½ä»¤çš„è¾“å‡º</span></span><br><span class="line">kubeadm join apiserver.demo:6443 --token mpfjma.4vjjg8flqihor4vt     --discovery-token-ca-cert-hash sha256:6f7a8e40a810323672de5eee6f4d19aa2dbdb38411845a1bf5dd63485c43d303</span><br></pre></td></tr></table></figure><h4 id="æ£€æŸ¥åˆå§‹åŒ–ç»“æœ"><a href="#æ£€æŸ¥åˆå§‹åŒ–ç»“æœ" class="headerlink" title="æ£€æŸ¥åˆå§‹åŒ–ç»“æœ"></a>æ£€æŸ¥åˆå§‹åŒ–ç»“æœ</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># kubectl get nodes -o wide</span></span><br><span class="line">NAME        STATUS   ROLES    AGE   VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION           CONTAINER-RUNTIME</span><br><span class="line">k8s-node1   Ready    master   43h   v1.19.2   192.168.229.6   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1127.el7.x86_64   docker://19.3.11</span><br><span class="line">k8s-node2   Ready    &lt;none&gt;   42h   v1.19.2   192.168.229.7   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1127.el7.x86_64   docker://19.3.11</span><br><span class="line">[root@k8s-node1 ~]<span class="comment">#  kubectl get nodes</span></span><br><span class="line">NAME        STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s-node1   Ready    master   43h   v1.19.2</span><br><span class="line">k8s-node2   Ready    &lt;none&gt;   42h   v1.19.2</span><br></pre></td></tr></table></figure><h4 id="å®‰è£…-Ingress-Controller"><a href="#å®‰è£…-Ingress-Controller" class="headerlink" title="å®‰è£… Ingress Controller"></a>å®‰è£… Ingress Controller</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ</span></span><br><span class="line">kubectl apply -f https://kuboard.cn/install-script/v1.19.x/nginx-ingress.yaml</span><br></pre></td></tr></table></figure><h4 id="å®‰è£…Kuboard"><a href="#å®‰è£…Kuboard" class="headerlink" title="å®‰è£…Kuboard"></a>å®‰è£…Kuboard</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">kubectl apply -f https://kuboard.cn/install-script/kuboard.yaml</span><br><span class="line">kubectl apply -f https://addons.kuboard.cn/metrics-server/0.3.7/metrics-server.yaml</span><br></pre></td></tr></table></figure><h5 id="æŸ¥çœ‹Kuboardè¿è¡ŒçŠ¶æ€ï¼š"><a href="#æŸ¥çœ‹Kuboardè¿è¡ŒçŠ¶æ€ï¼š" class="headerlink" title="æŸ¥çœ‹Kuboardè¿è¡ŒçŠ¶æ€ï¼š"></a>æŸ¥çœ‹Kuboardè¿è¡ŒçŠ¶æ€ï¼š</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@k8s-node1 ~]<span class="comment"># kubectl get pods -l k8s.kuboard.cn/name=kuboard -n kube-system</span></span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">kuboard-655785f55c-rc52g   1/1     Running   1          23h</span><br></pre></td></tr></table></figure><h5 id="è·å–token"><a href="#è·å–token" class="headerlink" title="è·å–token"></a>è·å–token</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-master ~]# echo $(kubectl -n kube-system get secret $(kubectl -n kube-system get secret | grep kuboard-user | awk &apos;&#123;print $1&#125;&apos;) -o go-template=&apos;&#123;&#123;.data.token&#125;&#125;&apos; | base64 -d)</span><br><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6IjctcWttYVAycFljWlRoMUhtbE5lQzNueHV1dzhHX2xOUUNOQUpaSFI0TkUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJvYXJkLXVzZXItdG9rZW4tbTlycXMiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoia3Vib2FyZC11c2VyIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiODdmMjBjOTQtZDZjZi00N2Y3LTg3ZjItNTg3NDc4OTY1ZDE0Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOmt1Ym9hcmQtdXNlciJ9.mMD-OaqLoHrUeHFNNP2LyAS6d5yO1SbbkdPtxFCKFiGG7y5l6A6cuWzE0gqnrZXRXGMJ8nLJqNRmZDgdlyUnlBPtVe2ipWK3SYNy4kVRSguRqEXjhw7H6r1zDkyHRNczkuQQ6eYCAS55t-NRohBE6e4CAE_FiPnDF-AaO-0a0p2cZnqO1vgrkt3y_-9wfs2btmACkbzXJUyfECVWF2LYDsmeQvuiMMQkn_qcPRqh_Y65wBVfXv575NpyJox4KVEcPHcTUxgkMciIlgB6SjDCJI3PrX3GrXilqPx0tSILhvPo-cglwyK33Spvh7b0DWNi-oR3SL3aeME4Khz-ZLiLIQ</span><br></pre></td></tr></table></figure><h5 id="ä½¿ç”¨tokenç™»å½•kuboard"><a href="#ä½¿ç”¨tokenç™»å½•kuboard" class="headerlink" title="ä½¿ç”¨tokenç™»å½•kuboard"></a>ä½¿ç”¨tokenç™»å½•kuboard</h5><p>http://ä»»æ„ä¸€ä¸ªWorkerèŠ‚ç‚¹çš„IPåœ°å€:32567/</p><h3 id="GitLab"><a href="#GitLab" class="headerlink" title="GitLab"></a>GitLab</h3><h5 id="ä½¿ç”¨dockerä¸‹è½½gitlabé•œåƒ"><a href="#ä½¿ç”¨dockerä¸‹è½½gitlabé•œåƒ" class="headerlink" title="ä½¿ç”¨dockerä¸‹è½½gitlabé•œåƒ"></a>ä½¿ç”¨dockerä¸‹è½½gitlabé•œåƒ</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@public ~]#  docker pull gitlab/gitlab-ce</span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from gitlab/gitlab-ce</span><br><span class="line">001ecc9468da: Pull complete </span><br><span class="line">f2b966749869: Pull complete </span><br><span class="line">abe474042557: Pull complete </span><br><span class="line">e1bf2fb0fbbc: Pull complete </span><br><span class="line">01aa4f31067e: Pull complete </span><br><span class="line">3e98644dd3ba: Pull complete </span><br><span class="line">d1964c740a63: Pull complete </span><br><span class="line">67d6f9c7950b: Pull complete </span><br><span class="line">3a47828397ca: Pull complete </span><br><span class="line">00ef60c779e0: Pull complete </span><br><span class="line">Digest: sha256:81ff3b05d4da7a8c9b73ec0c4945319932f2ed1d89661831f5a9defe5e408125</span><br><span class="line">Status: Downloaded newer image for gitlab/gitlab-ce:latest</span><br><span class="line">docker.io/gitlab/gitlab-ce:latest</span><br></pre></td></tr></table></figure><h5 id="æ£€æŸ¥é•œåƒä¸‹è½½æ˜¯å¦æˆåŠŸ"><a href="#æ£€æŸ¥é•œåƒä¸‹è½½æ˜¯å¦æˆåŠŸ" class="headerlink" title="æ£€æŸ¥é•œåƒä¸‹è½½æ˜¯å¦æˆåŠŸ"></a>æ£€æŸ¥é•œåƒä¸‹è½½æ˜¯å¦æˆåŠŸ</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@public ~]# docker images</span><br><span class="line">REPOSITORY                                TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">gitlab/gitlab-ce                          latest              85ef0c92d667        3 days ago          1.98GB</span><br><span class="line">registry.aliyuncs.com/k8sxio/kube-proxy   v1.19.2             d373dd5a8593        11 days ago         118MB</span><br><span class="line">eipwork/kuboard                           latest              58cbda9ae6df        2 weeks ago         182MB</span><br><span class="line">eipwork/metrics-server                    v0.3.7              07c9e703ca2c        5 months ago        55.4MB</span><br><span class="line">calico/node                               v3.13.1             2e5029b93d4a        6 months ago        260MB</span><br><span class="line">calico/pod2daemon-flexvol                 v3.13.1             e8c600448aae        6 months ago        111MB</span><br><span class="line">calico/cni                                v3.13.1             6912ec2cfae6        6 months ago        207MB</span><br><span class="line">registry.aliyuncs.com/k8sxio/pause        3.2                 80d28bedfe5d        7 months ago        683kB</span><br><span class="line">nginx/nginx-ingress                       1.5.5               1e674eebb1af        12 months ago       161MB</span><br></pre></td></tr></table></figure><h5 id="åˆ›å»ºæ•°æ®å­˜å‚¨ç›®å½•"><a href="#åˆ›å»ºæ•°æ®å­˜å‚¨ç›®å½•" class="headerlink" title="åˆ›å»ºæ•°æ®å­˜å‚¨ç›®å½•"></a>åˆ›å»ºæ•°æ®å­˜å‚¨ç›®å½•</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@public ~]# mkdir  -p /file/gitlab/data</span><br><span class="line">[root@public ~]# mkdir /file/gitlab/logs</span><br><span class="line">[root@public ~]# mkdir /file/gitlab/config</span><br></pre></td></tr></table></figure><h5 id="å¯åŠ¨gitlab"><a href="#å¯åŠ¨gitlab" class="headerlink" title="å¯åŠ¨gitlab"></a>å¯åŠ¨gitlab</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@public gitlab]# docker run --detach \</span><br><span class="line">&gt;       --hostname 192.168.229.8 \</span><br><span class="line">&gt;       --publish 8443:443 --publish 9080:80 --publish 2222:22 \</span><br><span class="line">&gt;       --name gitlab \</span><br><span class="line">&gt;       --restart always \</span><br><span class="line">&gt;       --volume /file/gitlab/config:/etc/gitlab \</span><br><span class="line">&gt;       --volume /file/gitlab/logs:/var/log/gitlab \</span><br><span class="line">&gt;       --volume /file/gitlab/data:/var/opt/gitlab \</span><br><span class="line">&gt;    docker.io/gitlab/gitlab-ce:latest</span><br><span class="line">ca10c6a70bfc8f55cd43af2471c1d670fc378726375ac4b39b6c9a761d2b5ed1</span><br></pre></td></tr></table></figure><p><strong>gitlabå¦‚ä½¿ç”¨å•å°æœåŠ¡å™¨å¯ä½¿ç”¨é»˜è®¤é…ç½®,è‹¥è·Ÿåˆ«çš„æœåŠ¡æ”¾ä¸€èµ·ä¼šå‡ºç°gitlabå ç”¨å†…å­˜è¿‡å¤šé—®é¢˜</strong></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi /file/gitlab/config/gitlab.rb</span><br><span class="line"></span><br><span class="line">#å»æ‰ä¸‹é¢çš„æ³¨é‡Š</span><br><span class="line"></span><br><span class="line">unicorn[&apos;worker_processes&apos;] = 2</span><br><span class="line"></span><br><span class="line">#ä¹‹åæ‰§è¡Œ</span><br><span class="line"></span><br><span class="line">docker exec -it gitlab gitlab-ctl reconfigure</span><br><span class="line"></span><br><span class="line">docker exec -it gitlab gitlab-ctl restart</span><br></pre></td></tr></table></figure><h5 id="åˆ›å»ºé¡¹ç›®ç»„"><a href="#åˆ›å»ºé¡¹ç›®ç»„" class="headerlink" title="åˆ›å»ºé¡¹ç›®ç»„"></a>åˆ›å»ºé¡¹ç›®ç»„</h5><img src="\image\image-20200929152933319.png"><h5 id="åˆ›å»ºé¡¹ç›®"><a href="#åˆ›å»ºé¡¹ç›®" class="headerlink" title="åˆ›å»ºé¡¹ç›®"></a>åˆ›å»ºé¡¹ç›®</h5><img src="\image\image-20200929153011476.png"><h5 id="é…ç½®æœ¬åœ°Gitç¯å¢ƒ"><a href="#é…ç½®æœ¬åœ°Gitç¯å¢ƒ" class="headerlink" title="é…ç½®æœ¬åœ°Gitç¯å¢ƒ"></a>é…ç½®æœ¬åœ°Gitç¯å¢ƒ</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git config --global user.name &quot;Administrator&quot;</span><br><span class="line">git config --global user.email &quot;admin@example.com&quot;</span><br></pre></td></tr></table></figure><h3 id="Jenkins"><a href="#Jenkins" class="headerlink" title="Jenkins"></a>Jenkins</h3><h5 id="å®‰è£…jdk"><a href="#å®‰è£…jdk" class="headerlink" title="å®‰è£…jdk"></a>å®‰è£…jdk</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">tar zxvf jdk-8u181-linux-x64.tar.gz</span><br><span class="line">mv jdk1.8.0_181/ java</span><br><span class="line">mv java /usr/<span class="built_in">local</span>/</span><br><span class="line"></span><br><span class="line"><span class="comment">#åŠ å…¥ç¯å¢ƒå˜é‡</span></span><br><span class="line">vi /etc/profile</span><br><span class="line"></span><br><span class="line">JAVA_HOME=/usr/<span class="built_in">local</span>/java</span><br><span class="line">CLASSPATH=<span class="variable">$CLASSPATH</span>:<span class="variable">$JAVA_HOME</span>/lib/</span><br><span class="line">PATH=<span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"><span class="comment">#æŸ¥çœ‹ç‰ˆæœ¬å·</span></span><br><span class="line">java -version</span><br></pre></td></tr></table></figure><h5 id="å®‰è£…Jenkins"><a href="#å®‰è£…Jenkins" class="headerlink" title="å®‰è£…Jenkins"></a>å®‰è£…Jenkins</h5><p>yumçš„reposä¸­é»˜è®¤æ˜¯æ²¡æœ‰Jenkinsçš„ï¼Œéœ€è¦å…ˆå°†Jenkinså­˜å‚¨åº“æ·»åŠ åˆ°yum reposã€‚</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo</span><br><span class="line">sudo rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key</span><br></pre></td></tr></table></figure><p>yumå®‰è£…Jenkins</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yum install jenkins</span><br></pre></td></tr></table></figure><p>å¯åŠ¨jenkins</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/lib/jenkins/</span><br><span class="line">java -jar -Xms512m -Xmx1024m jenkins.war  &amp;</span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶/root/.jenkins/config.xml</p><p>åœ¨æµè§ˆå™¨è¾“å…¥<code>ip:8080</code>è¿›å…¥Jenkinsç™»å½•é¡µé¢ã€‚</p><p>è¿›å…¥ç™»å½•é¡µé¢åï¼ŒJenkinsæç¤ºæˆ‘ä»¬éœ€è¦è¾“å…¥è¶…çº§ç®¡ç†å‘˜å¯†ç è¿›è¡Œè§£é”ã€‚æ ¹æ®æç¤ºï¼Œæˆ‘ä»¬å¯ä»¥åœ¨<code>/var/lib/jenkins/secrets/initialAdminPassword</code>æ–‡ä»¶é‡Œæ‰¾åˆ°å¯†ç ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat /var/lib/jenkins/secrets/initialAdminPassword</span><br></pre></td></tr></table></figure><p>æ‰¾åˆ°å¯†ç åï¼Œå¤åˆ¶å¯†ç ï¼Œç²˜è´´åˆ°Jenkinsè§£é”é¡µé¢ï¼Œç‚¹å‡»<code>Continue</code>ç»§ç»­åˆå§‹åŒ–é…ç½®ã€‚çŸ­æš‚çš„ç­‰å¾…åï¼Œè¿›å…¥æ’ä»¶å®‰è£…é¡µé¢ã€‚</p><p>ç‚¹å‡»<code>Install suggested plugins</code>ï¼Œå®‰è£…é»˜è®¤æ’ä»¶</p><p>å®‰è£…å®Œæˆåï¼Œé¡µé¢è‡ªåŠ¨è¿›å…¥äº†ç®¡ç†å‘˜è´¦æˆ·æ³¨å†Œé¡µé¢</p><p>è¾“å…¥ä¿¡æ¯æ³¨å†Œã€‚ç‚¹å‡»<code>Save and Finish</code>ã€‚</p><p>ç‚¹å‡»<code>Start using Jenkins</code>ï¼Œè¿›å…¥Jenkinsä¸»é¡µé¢ã€‚</p><h5 id="å®‰è£…Git"><a href="#å®‰è£…Git" class="headerlink" title="å®‰è£…Git"></a>å®‰è£…Git</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install curl-devel expat-devel gettext-devel \</span><br><span class="line">  openssl-devel zlib-devel</span><br><span class="line"></span><br><span class="line">yum -y install git-core</span><br><span class="line">#æŸ¥çœ‹ç‰ˆæœ¬å·</span><br><span class="line">git --version</span><br></pre></td></tr></table></figure><h5 id="å®‰è£…Maven"><a href="#å®‰è£…Maven" class="headerlink" title="å®‰è£…Maven"></a>å®‰è£…Maven</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#ä¸‹è½½mavenåŒ…,è§£å‹</span><br><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/apache/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz</span><br><span class="line">tar zxvf apache-maven-3.6.3-bin.tar.gz </span><br><span class="line">mv apache-maven-3.6.3 /usr/local/maven</span><br><span class="line"></span><br><span class="line">#æ·»åŠ ç¯å¢ƒå˜é‡</span><br><span class="line">vi /etc/profile</span><br><span class="line">#MAVEN</span><br><span class="line">MAVEN_HOME=/usr/local/maven</span><br><span class="line">export MAVEN_HOME</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin:$MAVEN_HOME/bin</span><br><span class="line"></span><br><span class="line">#ç”Ÿæ•ˆç¯å¢ƒå˜é‡</span><br><span class="line">source /etc/profile</span><br><span class="line"></span><br><span class="line">#æŸ¥çœ‹ç‰ˆæœ¬å·</span><br><span class="line">mvn -v</span><br></pre></td></tr></table></figure><h5 id="å®‰è£…NPM"><a href="#å®‰è£…NPM" class="headerlink" title="å®‰è£…NPM"></a>å®‰è£…NPM</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#ä¸‹è½½node,è§£å‹</span><br><span class="line">[root@public home]# wget https://nodejs.org/dist/v12.19.0/node-v12.19.0-linux-x64.tar.xz</span><br><span class="line">[root@public home]# tar xf  node-v12.19.0-linux-x64.tar.xz </span><br><span class="line">[root@public home]# cd node-v12.19.0-linux-x64</span><br><span class="line">#è½¯é“¾æ¥</span><br><span class="line">[root@public node-v12.19.0-linux-x64]# ln -s /home/node-v12.19.0-linux-x64/bin/npm   /usr/local/bin/ </span><br><span class="line">[root@public node-v12.19.0-linux-x64]# ln -s /home/node-v12.19.0-linux-x64/bin/node   /usr/local/bin/</span><br><span class="line">#æŸ¥çœ‹ç‰ˆæœ¬å·éªŒè¯</span><br><span class="line">[root@public node-v12.19.0-linux-x64]# node -v</span><br><span class="line">v12.19.0</span><br><span class="line">[root@public node-v12.19.0-linux-x64]# npm -v</span><br><span class="line">6.14.8</span><br><span class="line">#å®‰è£…ä¾èµ–</span><br><span class="line">[root@public node-v12.19.0-linux-x64]# npm install</span><br></pre></td></tr></table></figure><h5 id="åˆ›å»ºæ„å»º"><a href="#åˆ›å»ºæ„å»º" class="headerlink" title="åˆ›å»ºæ„å»º"></a>åˆ›å»ºæ„å»º</h5><img src="\image\image-20201009095212341.png"><h5 id="é…ç½®å‚æ•°"><a href="#é…ç½®å‚æ•°" class="headerlink" title="é…ç½®å‚æ•°"></a>é…ç½®å‚æ•°</h5><img src="\image\image-20201009095313048.png"><h5 id="é…ç½®æ‰“åŒ…æ„å»º"><a href="#é…ç½®æ‰“åŒ…æ„å»º" class="headerlink" title="é…ç½®æ‰“åŒ…æ„å»º"></a>é…ç½®æ‰“åŒ…æ„å»º</h5><img src="\image\image-20200929153431712.png"><p>é€šè¿‡git clone æ‹‰å–ä»£ç .mvn clean installè¿›è¡Œæ‰“åŒ….é€šè¿‡dockerfileä¸Šä¼ åˆ°é•œåƒä»“åº“</p><h5 id="å‘å¸ƒåˆ°k8s"><a href="#å‘å¸ƒåˆ°k8s" class="headerlink" title="å‘å¸ƒåˆ°k8s"></a>å‘å¸ƒåˆ°k8s</h5><img src="\image\image-20200929154250350.png">é€šè¿‡sshæ’ä»¶å‘é€yamlæ–‡ä»¶åˆ°k8s-master<h5 id="åˆ é™¤æ‰“åŒ…æ–‡ä»¶"><a href="#åˆ é™¤æ‰“åŒ…æ–‡ä»¶" class="headerlink" title="åˆ é™¤æ‰“åŒ…æ–‡ä»¶"></a>åˆ é™¤æ‰“åŒ…æ–‡ä»¶</h5><img src="\image\image-20200929154426301.png"><h5 id="dockerfileæ–‡ä»¶"><a href="#dockerfileæ–‡ä»¶" class="headerlink" title="dockerfileæ–‡ä»¶"></a>dockerfileæ–‡ä»¶</h5><p>Dockerfile</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FROM  192.168.229.8:8551/centos:latest</span><br><span class="line">MAINTAINER nmk</span><br><span class="line"></span><br><span class="line">COPY  *.jar /home/App.jar</span><br><span class="line">COPY  start.sh /home/start.sh</span><br><span class="line">RUN chmod +x /home/start.sh</span><br><span class="line">ENV JAVA_HOME=/usr/local/java</span><br><span class="line">ENV PATH $JAVA_HOME/bin:$PATH</span><br><span class="line">ENV CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line">ENV LC_ALL=&quot;en_US.UTF-8&quot;</span><br><span class="line">ENV LANG=&quot;en_US.UTF-8&quot;</span><br><span class="line"></span><br><span class="line">EXPOSE appport</span><br><span class="line">CMD [&quot;/home/start.sh&quot;]</span><br></pre></td></tr></table></figure><p>build.sh</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">#æ„å»ºæœ‰ç‰ˆæœ¬å·çš„é•œåƒï¼Œä»¥é˜²éœ€è¦å›æ»šï¼Œè€Œä¸”æ˜¯ä»é•œåƒåˆ›å»ºæœåŠ¡</span><br><span class="line">docker build -t 192.168.229.8:8551/$1:$2     . -f Dockerfile</span><br><span class="line"></span><br><span class="line">docker push     192.168.229.8:8551/$1:$2</span><br><span class="line">#æ„å»ºlatestç‰ˆæœ¬ï¼Œç”¨äºè‡ªåŠ¨éƒ¨ç½²</span><br><span class="line">docker build -t 192.168.229.8:8551/$1:latest . -f Dockerfile</span><br><span class="line">docker push     192.168.229.8:8551/$1:latest</span><br></pre></td></tr></table></figure><p>start.sh</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">JARFILE=/home/App.jar</span><br><span class="line">LOGPATH=/home/logs</span><br><span class="line">LOG=/home/logs/app.log</span><br><span class="line">if [ ! -d $LOGPATH ];then</span><br><span class="line">   mkdir -p $LOGPATH</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">java -jar -Xms512M -Xmx1024M -Djava.security.egd=file:/dev/./urandom $JARFILE &gt;&gt; $LOG &amp;</span><br><span class="line"></span><br><span class="line">tail  -50f $LOG</span><br></pre></td></tr></table></figure><h5 id="yamlæ–‡ä»¶"><a href="#yamlæ–‡ä»¶" class="headerlink" title="yamlæ–‡ä»¶"></a>yamlæ–‡ä»¶</h5><p>app.yaml</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: appname</span><br><span class="line">  name: appname</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: appname</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 25%</span><br><span class="line">      maxUnavailable: 25%</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: appname</span><br><span class="line">    spec:</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: regcred</span><br><span class="line">      containers:</span><br><span class="line">      - name: appname</span><br><span class="line">        image: 192.168.229.8:8551/appname:latest</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        livenessProbe:</span><br><span class="line">            failureThreshold: 3</span><br><span class="line">            httpGet:</span><br><span class="line">              path: apppath</span><br><span class="line">              port: appport</span><br><span class="line">              scheme: HTTP</span><br><span class="line">            initialDelaySeconds: 180</span><br><span class="line">            periodSeconds: 10</span><br><span class="line">            successThreshold: 1</span><br><span class="line">            timeoutSeconds: 1 </span><br><span class="line">        readinessProbe:</span><br><span class="line">            failureThreshold: 3</span><br><span class="line">            httpGet:</span><br><span class="line">              path: apppath</span><br><span class="line">              port: appport</span><br><span class="line">              scheme: HTTP</span><br><span class="line">            initialDelaySeconds: 180</span><br><span class="line">            periodSeconds: 10</span><br><span class="line">            successThreshold: 1</span><br><span class="line">            timeoutSeconds: 1</span><br><span class="line">        resources:</span><br><span class="line">            limits:</span><br><span class="line">              cpu: 200m</span><br><span class="line">              memory: 512Mi</span><br><span class="line">            requests:</span><br><span class="line">              cpu: 100m</span><br><span class="line">              memory: 256Mi</span><br></pre></td></tr></table></figure><p>service.yaml</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">  labels:</span><br><span class="line">    app: appname</span><br><span class="line">  name: appname</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - name: appname</span><br><span class="line">      port: appport</span><br><span class="line">      protocol: TCP</span><br><span class="line">      targetPort: appport</span><br><span class="line">  selector:</span><br><span class="line">    app: appname</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  type: ClusterIP</span><br></pre></td></tr></table></figure><p>ingress.yaml</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: appname</span><br><span class="line">  name: appname</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">    - host: nmk0718.com</span><br><span class="line">      http:</span><br><span class="line">        paths:</span><br><span class="line">          - backend:</span><br><span class="line">              serviceName: appname</span><br><span class="line">              servicePort: appname</span><br><span class="line">            path: /apppath</span><br><span class="line">            pathType: ImplementationSpecific</span><br></pre></td></tr></table></figure><p>*ingress.yamlåŒåŸŸåä¸åŒURLåˆ›å»ºä¼šè¦†ç›–,éœ€æ‰‹åŠ¨è¿›è¡Œæ·»åŠ ã€‚ä¸åŒåŸŸååŒURLåˆ›å»ºä¸ä¼šè¦†ç›–.</p><h5 id="æ‰“åŒ…å‰ç«¯é¡¹ç›®"><a href="#æ‰“åŒ…å‰ç«¯é¡¹ç›®" class="headerlink" title="æ‰“åŒ…å‰ç«¯é¡¹ç›®"></a>æ‰“åŒ…å‰ç«¯é¡¹ç›®</h5><ul><li>æ‹‰å–å‰ç«¯ä»£ç å’Œdockerfileæ–‡ä»¶</li><li>è§£å‹å‰ç«¯ä¾èµ–çš„node_modules</li><li>ä½¿ç”¨npm run buildæ‰“åŒ…</li><li>å‹ç¼©buildå‡ºæ¥çš„distæ–‡ä»¶å¤¹</li><li>ç§»åŠ¨distå‹ç¼©åŒ…åˆ°dockerfileæ–‡ä»¶å¤¹</li><li>æˆäºˆbuild.shæ‰§è¡Œæƒé™,ä¼ é€’appnameå’Œbuild_numberè¿›è¡Œæ‰“åŒ…é•œåƒ</li><li>æ›¿æ¢yamlæ–‡ä»¶çš„é…ç½®</li></ul><img src="\image\image-20201010152902659.png"><ul><li>é€šè¿‡sshæ’ä»¶å‘é€yamlæ–‡ä»¶åˆ°k8s-master</li><li>é€šè¿‡yamlæ–‡ä»¶åˆ›å»ºåº”ç”¨å’Œåº”ç”¨éœ€è¦çš„service</li><li>åˆ é™¤yamlæ–‡ä»¶</li></ul><img src="\image\image-20201010153404229.png"><ul><li>æ‰‹åŠ¨æ›´æ–°ingressè¿›è¡Œè·¯å¾„è½¬å‘</li></ul><img src="\image\image-20201010153550656.png"><ul><li>é€šè¿‡æ’ä»¶åœ¨å‘å¸ƒå®Œæ¸…ç©ºå·¥ä½œç©ºé—´çš„æ®‹ç•™</li></ul><img src="\image\image-20201010153710024.png"><ul><li>æŸ¥çœ‹åº”ç”¨æ˜¯serviceæ˜¯å¦åˆ›å»ºæˆåŠŸ</li></ul><img src="\image\image-20201010154554549.png"><ul><li>è®¿é—®åŸŸåæŸ¥çœ‹æ˜¯å¦æˆåŠŸ</li></ul><img src="\image\image-20201010155028976.png"><h5 id="æ‰“åŒ…åç«¯é¡¹ç›®"><a href="#æ‰“åŒ…åç«¯é¡¹ç›®" class="headerlink" title="æ‰“åŒ…åç«¯é¡¹ç›®"></a>æ‰“åŒ…åç«¯é¡¹ç›®</h5><ul><li>æ‹‰å–åç«¯ä»£ç å’Œdockerfile</li><li>è¿›å…¥é¡¹ç›®ç›®å½•è¿›è¡Œæ‰“åŒ…æ„å»º</li><li>å¤åˆ¶jaråŒ…åˆ°dockerfileçš„æ–‡ä»¶å¤¹</li><li>è¿›å…¥dockerfileæ–‡ä»¶å¤¹ æ›¿æ¢å‚æ•°åˆ°dockerå’Œyaml</li><li>æˆäºˆbuild.shæ‰§è¡Œæƒé™ æ‰§è¡Œbuild.shå¹¶ä¼ é€’å‚æ•°</li></ul><img src="\image\image-20201010155626966.png"><ul><li>é€šè¿‡sshæ’ä»¶å‘é€yamlæ–‡ä»¶åˆ°k8s-master</li><li>é€šè¿‡yamlæ–‡ä»¶åˆ›å»ºåº”ç”¨å’Œåº”ç”¨éœ€è¦çš„service</li><li>åˆ é™¤yamlæ–‡ä»¶</li></ul><img src="\image\image-20201010155815880.png"><ul><li>æ‰‹åŠ¨æ›´æ–°ingressè¿›è¡Œè·¯å¾„è½¬å‘</li></ul><img src="\image\image-20201010155910502.png"><ul><li>é€šè¿‡æ’ä»¶åœ¨å‘å¸ƒå®Œæ¸…ç©ºå·¥ä½œç©ºé—´çš„æ®‹ç•™</li></ul><img src="\image\image-20201010153710024.png"><ul><li>æŸ¥çœ‹åº”ç”¨æ˜¯serviceæ˜¯å¦åˆ›å»ºæˆåŠŸ</li></ul><img src="\image\image-20201010154554549.png"><ul><li>è®¿é—®åŸŸåæŸ¥çœ‹æ˜¯å¦æˆåŠŸ</li></ul><img src="\image\image-20201010160221404.png"><h3 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h3><h5 id="æ‰“åŒ…åŸºç¡€é•œåƒä¾›é¡¹ç›®ä½¿ç”¨"><a href="#æ‰“åŒ…åŸºç¡€é•œåƒä¾›é¡¹ç›®ä½¿ç”¨" class="headerlink" title="æ‰“åŒ…åŸºç¡€é•œåƒä¾›é¡¹ç›®ä½¿ç”¨"></a>æ‰“åŒ…åŸºç¡€é•œåƒä¾›é¡¹ç›®ä½¿ç”¨</h5><p>æ‹‰å–centosé•œåƒ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@public bin]# docker pull centos:7.8.2003</span><br><span class="line">7.8.2003: Pulling from library/centos</span><br><span class="line">9b4ebb48de8d: Already exists </span><br><span class="line">Digest: sha256:8540a199ad51c6b7b51492fa9fee27549fd11b3bb913e888ab2ccf77cbb72cc1</span><br><span class="line">Status: Downloaded newer image for centos:7.8.2003</span><br><span class="line">docker.io/library/centos:7.8.2003</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹é•œåƒä¿¡æ¯</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@public bin]# docker images</span><br><span class="line">REPOSITORY                                TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">centos                                    7.8.2003            afb6fca791e0        4 months ago        203MB</span><br></pre></td></tr></table></figure><p>åå°è¿è¡Œé•œåƒ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker  run -d afb6fca791e0  tail -f /dev/null</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è¿è¡Œçš„å®¹å™¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@public bin]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND               CREATED             STATUS                  PORTS               NAMES</span><br><span class="line">fc7ac56e28e4        afb6fca791e0        &quot;tail -f /dev/null&quot;   3 seconds ago       Up Less than a second                       determined_nightingale</span><br></pre></td></tr></table></figure><h5 id="å®‰è£…jdk-1"><a href="#å®‰è£…jdk-1" class="headerlink" title="å®‰è£…jdk"></a>å®‰è£…jdk</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#æ‹·è´å‹ç¼©åŒ…åˆ°å®¹å™¨</span><br><span class="line">docker cp jdk-8u181-linux-x64.tar.gz fc7ac56e28e4:/home/</span><br><span class="line"></span><br><span class="line">#è¿›å…¥å®¹å™¨</span><br><span class="line">docker exec -it fc7ac56e28e4 /bin/bash</span><br><span class="line">tar zxvf jdk-8u181-linux-x64.tar.gz</span><br><span class="line">mv jdk-8u181-linux-x64 java</span><br><span class="line">mv java /usr/local/</span><br><span class="line"> </span><br><span class="line">#åŠ å…¥ç¯å¢ƒå˜é‡</span><br><span class="line">vi /etc/profile</span><br><span class="line"> </span><br><span class="line">export JAVA_HOME=/usr/local/java</span><br><span class="line">export CLASSPATH=$CLASSPATH:$JAVA_HOME/lib/</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line"></span><br><span class="line">#ç”Ÿæ•ˆç¯å¢ƒå˜é‡</span><br><span class="line">source /etc/profile</span><br><span class="line"></span><br><span class="line">#æŸ¥çœ‹ç‰ˆæœ¬å·</span><br><span class="line">java -version</span><br></pre></td></tr></table></figure><h5 id="æ‰“åŒ…é•œåƒ"><a href="#æ‰“åŒ…é•œåƒ" class="headerlink" title="æ‰“åŒ…é•œåƒ"></a>æ‰“åŒ…é•œåƒ</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#æŠŠè¿è¡Œçš„å®¹å™¨æ‰“æˆé•œåƒ</span><br><span class="line">[root@public bin]# docker commit -a &quot;nmk&quot; fc7ac56e28e4 centos:v1.1</span><br><span class="line">sha256:bd61002052705bc6b2c838ddae7fb2e1d4974c7ed32ab6dd0ed205096deba5d5</span><br><span class="line"></span><br><span class="line">[root@public bin]# docker images</span><br><span class="line">REPOSITORY                                TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">centos                                    v1.1                bd6100205270        3 seconds ago       203MB</span><br><span class="line">centos                                    7.8.2003            afb6fca791e0        4 months ago        203MB</span><br></pre></td></tr></table></figure><h3 id="Nexus"><a href="#Nexus" class="headerlink" title="Nexus"></a>Nexus</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ä¸‹è½½nexus</span><br><span class="line">https://www.sonatype.com/download-oss-sonatype</span><br><span class="line">é€‰æ‹©   Nexus Repository Manager OSS 3.x - Unix</span><br><span class="line"></span><br><span class="line">tar zxvf nexus-3.27.0-03-unix.tar.gz</span><br><span class="line">mv nexus-3.27.0-03 /usr/local/nexus</span><br><span class="line">mv sonatype-work/ /usr/local/</span><br><span class="line"></span><br><span class="line">vi /etc/profile</span><br><span class="line">#nexus</span><br><span class="line">export NEXUS_HOME=/usr/local/nexus</span><br><span class="line">export PATH=$PATH:$NEXUS_HOME/bin</span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br><span class="line"></span><br><span class="line">cd /usr/local/nexus/etc/</span><br><span class="line">vi nexus-default.properties</span><br><span class="line"></span><br><span class="line">cd /usr/local/nexus/bin</span><br><span class="line">nexus start</span><br><span class="line"></span><br><span class="line">è®¿é—®http://192.168.229.8:8081/</span><br></pre></td></tr></table></figure><h5 id="åˆ›å»ºDockerä»“åº“"><a href="#åˆ›å»ºDockerä»“åº“" class="headerlink" title="åˆ›å»ºDockerä»“åº“"></a>åˆ›å»ºDockerä»“åº“</h5><p>åœ¨Nexusä¸­Dockerä»“åº“è¢«åˆ†ä¸ºäº†ä¸‰ç§</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hostedï¼š æ‰˜ç®¡ä»“åº“ ï¼Œç§æœ‰ä»“åº“ï¼Œå¯ä»¥pushå’Œpull </span><br><span class="line">proxyï¼š ä»£ç†å’Œç¼“å­˜è¿œç¨‹ä»“åº“ ï¼Œåªèƒ½pull</span><br><span class="line">groupï¼š å°†å¤šä¸ªproxyå’Œhostedä»“åº“æ·»åŠ åˆ°ä¸€ä¸ªç»„ï¼Œåªè®¿é—®ä¸€ä¸ªç»„åœ°å€å³å¯ï¼Œåªèƒ½pull</span><br></pre></td></tr></table></figure><p><strong>1ã€é…ç½®Blob Stores</strong></p><p>ç‚¹å‡» ç®¡ç† -&gt;Repository -&gt;Blob Stores-&gt; Create blob stores</p><img src="\image\image-20200923150230710.png"><p>ä¸€æ—¦åˆ›å»ºäº†blob storeï¼Œå°±ä¸å¯ä¿®æ”¹ç±»å‹å’Œåç§°ã€‚è€Œä¸”ï¼Œè¯¥blob storeè¢«ä»“åº“æˆ–è€…ä»“åº“ç»„ä½¿ç”¨åï¼Œéƒ½ä¸å¯ä»¥è¢«åˆ é™¤ã€‚ä¸€ä¸ªä»“åº“åªå¯ä»¥ä½¿ç”¨ä¸€ä¸ªBlob Storeï¼Œä¸€ä¸ªBlob Storeå¯ä»¥å¯¹åº”å¤šä¸ªä»“åº“ã€‚Blob storeçš„å¤§å°ä¸ºPathå¯¹åº”çš„æ–‡ä»¶å¤¹çš„å¤§å°ã€‚</p><p><strong>2.åˆ›å»º<code>hosted repository*</code></strong></p><p>ç‚¹å‡» ç®¡ç† -&gt; Repository -&gt; Repositories -&gt; Create Repository -&gt; Docker(hosted)</p><img src="\image\image-20200923150844177.png"><p>è¿™æ ·å°±åˆ›å»ºå¥½äº†ä¸€ä¸ªç§æœ‰ä»“åº“ã€‚è®¿é—®åœ°å€å³ ä¸º192.168.229.8:8551</p><h5 id="æŸ¥çœ‹ç§æœ‰é•œåƒä»“åº“çš„åˆ—è¡¨"><a href="#æŸ¥çœ‹ç§æœ‰é•œåƒä»“åº“çš„åˆ—è¡¨" class="headerlink" title="æŸ¥çœ‹ç§æœ‰é•œåƒä»“åº“çš„åˆ—è¡¨"></a>æŸ¥çœ‹ç§æœ‰é•œåƒä»“åº“çš„åˆ—è¡¨</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@public ~]#  curl -X GET -u admin:nmk0718 http://192.168.229.8:8551/v2/_catalog</span><br><span class="line">&#123;&quot;repositories&quot;:[&quot;bosybox&quot;,&quot;centos&quot;,&quot;nmk0718&quot;,&quot;nmktest&quot;]&#125;</span><br></pre></td></tr></table></figure><h5 id="æŸ¥çœ‹ç§æœ‰é•œåƒä»“åº“çš„ç‰ˆæœ¬"><a href="#æŸ¥çœ‹ç§æœ‰é•œåƒä»“åº“çš„ç‰ˆæœ¬" class="headerlink" title="æŸ¥çœ‹ç§æœ‰é•œåƒä»“åº“çš„ç‰ˆæœ¬"></a>æŸ¥çœ‹ç§æœ‰é•œåƒä»“åº“çš„ç‰ˆæœ¬</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@public ~]#  curl -X GET -u admin:nmk0718 http://192.168.229.8:8551/v2/centos/tags/list</span><br><span class="line">&#123;&quot;name&quot;:&quot;centos&quot;,&quot;tags&quot;:[&quot;v1.1&quot;,&quot;v1.2&quot;,&quot;v1.3&quot;]&#125;</span><br></pre></td></tr></table></figure><p><strong>ä¿®æ”¹dockeré…ç½®</strong></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å¢åŠ &quot;insecure-registries&quot;: [&quot;ç§æœåº“åœ°å€&quot;] åˆ°é…ç½®ä¸­</span><br><span class="line">[root@k8s-node2 ~]# vi /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://registry.cn-hangzhou.aliyuncs.com&quot;],</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">  &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">  &quot;log-opts&quot;: &#123;</span><br><span class="line">    &quot;max-size&quot;: &quot;100m&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">  &quot;storage-opts&quot;: [</span><br><span class="line">    &quot;overlay2.override_kernel_check=true&quot;</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">    &quot;insecure-registries&quot;: [</span><br><span class="line">       &quot;192.168.229.8:8551&quot;</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">service docker restart</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#æ ‡è®°é•œåƒ</span><br><span class="line">docker tag cenots:v1.1 192.168.229.8:8551/centos:v1.1</span><br><span class="line">#è¯­æ³•å’Œæ ¼å¼ï¼šdocker tag &lt;imageId or imageName&gt; &lt;nexus-hostname&gt;:&lt;repository-port&gt;/&lt;image&gt;:&lt;tag&gt;</span><br></pre></td></tr></table></figure><p>ç™»å½•åˆ°ç§æœåº“</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker login -u admin -p nmk0718 192.168.229.8:8551</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ç™»å½•å‡­è¯</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-node2 ~]# cat ~/.docker/config.json</span><br><span class="line">&#123;</span><br><span class="line">        &quot;auths&quot;: &#123;</span><br><span class="line">                &quot;192.168.229.8:8551&quot;: &#123;</span><br><span class="line">                        &quot;auth&quot;: &quot;YWRtaW46bm1rMDcxOA==&quot;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;HttpHeaders&quot;: &#123;</span><br><span class="line">                &quot;User-Agent&quot;: &quot;Docker-Client/19.03.11 (linux)&quot;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>ç”¨æˆ·åå¯†ç å¯é€šè¿‡å‘½ä»¤è§£ç ä¸ºæ˜æ–‡</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-node2 ~]# echo &apos;YWRtaW46bm1rMDcxOA==&apos; | base64 --decode</span><br><span class="line">admin:nmk0718</span><br></pre></td></tr></table></figure><p><strong>åç»­éœ€ä¼˜åŒ–</strong>:</p><p>Dockerç›´æ¥å°†ä»“åº“çš„ç”¨æˆ·åå¯†ç æ˜æ–‡ä¿å­˜åœ¨é…ç½®æ–‡ä»¶ä¸­éå¸¸ä¸å®‰å…¨ï¼Œé™¤éç”¨æˆ·æ¯æ¬¡åœ¨ä¸é•œåƒä»“åº“äº¤äº’å®Œæˆä¹‹åæ‰‹åŠ¨æ‰§è¡Œ<code>docker logout</code>åˆ é™¤ï¼Œè¿™ç§æ˜æ–‡å¯†ç å¾ˆå®¹æ˜“è¢«ä»–äººçªƒå–. Dockerä¹Ÿè€ƒè™‘åˆ°è¿™ä¸€ç‚¹ï¼Œé’ˆå¯¹ä¸åŒçš„å¹³å°ï¼Œå…¶æä¾›äº†ä¸åŒçš„è¾…åŠ©å·¥å…·å°†ä»“åº“çš„ç™»å½•å‡­è¯ä¿å­˜åˆ°å…¶ä»–å®‰å…¨ç³»æ•°é«˜çš„å­˜å‚¨ä¸­ã€‚</p><p>ä¸Šä¼ é•œåƒåˆ°ç§æœä»“åº“</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker push 192.168.229.8:8551/centos:v1.1</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ä¸Šä¼ çš„é•œåƒ</p><img src="\image\3.png"><p>æ‹‰å–ä¸Šä¼ åˆ°ç§æœä»“åº“çš„é•œåƒ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@public bin]# docker pull 192.168.229.8:8551/centos:v1.1</span><br><span class="line">v1.1: Pulling from centos</span><br><span class="line">9b4ebb48de8d: Already exists </span><br><span class="line">72bf021082cd: Pull complete </span><br><span class="line">7f669da652be: Pull complete </span><br><span class="line">b64a50fe3bd5: Pull complete </span><br><span class="line">3e3a9f68a07c: Pull complete </span><br><span class="line">Digest: sha256:7c78a495de5556ab53b14c017bc20c1c4ce682d1e9d4c6aefde2c908d65ef80c</span><br><span class="line">Status: Downloaded newer image for 192.168.229.8:8551/centos:v1.1</span><br><span class="line">192.168.229.8:8551/centos:v1.1</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æ‹‰å–å®Œçš„é•œåƒä¿¡æ¯</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@public bin]# docker images</span><br><span class="line">REPOSITORY                                TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">192.168.229.8:8551/centos                 v1.1                3a26ef36258c        18 hours ago        1.03GB</span><br><span class="line">centos                                    7.8.2003            afb6fca791e0        4 months ago        203MB</span><br></pre></td></tr></table></figure><h5 id="Kubernetesä»ç§æœ‰é•œåƒæ‹‰å–é•œåƒ"><a href="#Kubernetesä»ç§æœ‰é•œåƒæ‹‰å–é•œåƒ" class="headerlink" title="Kubernetesä»ç§æœ‰é•œåƒæ‹‰å–é•œåƒ"></a>Kubernetesä»ç§æœ‰é•œåƒæ‹‰å–é•œåƒ</h5><p><strong>ç”Ÿæˆå¯†é’¥</strong></p><p>åœ¨ä½¿ç”¨ç§æœ‰é•œåƒæ‹‰å–é•œåƒæ—¶ï¼Œéœ€è¦ä¸ºç§æœ‰é•œåƒä»“åº“åˆ›å»ºä¸€ä¸ªé•œåƒä»“åº“çš„å¯†é’¥ï¼Œå¹¶åœ¨åˆ›å»ºå®¹å™¨ä¸­è¿›è¡Œå¼•ç”¨ã€‚åˆ›å»ºé•œåƒä»“åº“çš„è¯­æ³•å’Œæ ¼å¼ï¼š</p><p><em>kubectl create secret dockerâ€“registry &lt;<strong>regsecret-name&gt;</strong> â€”dockerâ€“server=&lt;yourâ€“registryâ€“server&gt; â€”dockerâ€“username=&lt;yourâ€“name&gt; â€”dockerâ€“password=&lt;yourâ€“pword&gt; â€”dockerâ€“email=&lt;yourâ€“email&gt;ã€‚</em></p><ul><li><regsecret-name>ï¼šæ‰€åˆ›å»ºçš„ç§æœ‰é•œåƒä»“åº“å¯†é’¥çš„åç§°ï¼›</regsecret-name></li><li><your-registry-server>ï¼šä¸ºé•œåƒä»“åº“çš„æœåŠ¡å™¨åœ°å€ï¼›</your-registry-server></li><li><your-name>ï¼šç™»å½•é•œåƒä»“åº“çš„ç”¨æˆ·åï¼›</your-name></li><li><your-pword>ï¼šç™»å½•é•œåƒä»“åº“çš„å¯†ç ï¼›</your-pword></li><li><your-email>ï¼šç”¨æˆ·çš„é‚®ç®±åœ°å€ã€‚</your-email></li></ul><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl create secret docker-registry regcred   --docker-server=192.168.229.8:8551   --docker-username=admin   --docker-password=nmk0718   --docker-email=nmk0718@163.com</span><br></pre></td></tr></table></figure><h5 id="æ£€æŸ¥-Secret-regcred"><a href="#æ£€æŸ¥-Secret-regcred" class="headerlink" title="æ£€æŸ¥ Secret regcred"></a>æ£€æŸ¥ Secret <code>regcred</code></h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-node1 ~]# kubectl get secret regcred --output=yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  .dockerconfigjson: eyJhdXRocyI6eyIxOTIuMTY4LjIyOS44Ojg1NTEiOnsidXNlcm5hbWUiOiJhZG1pbiIsInBhc3N3b3JkIjoibm1rMDcxOCIsImVtYWlsIjoibm1rMDcxOEAxNjMuY29tIiwiYXV0aCI6IllXUnRhVzQ2Ym0xck1EY3hPQT09In19fQ==</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: &quot;2020-09-22T10:38:20Z&quot;</span><br><span class="line">  managedFields:</span><br><span class="line">  - apiVersion: v1</span><br><span class="line">    fieldsType: FieldsV1</span><br><span class="line">    fieldsV1:</span><br><span class="line">      f:data:</span><br><span class="line">        .: &#123;&#125;</span><br><span class="line">        f:.dockerconfigjson: &#123;&#125;</span><br><span class="line">      f:type: &#123;&#125;</span><br><span class="line">    manager: kubectl-create</span><br><span class="line">    operation: Update</span><br><span class="line">    time: &quot;2020-09-22T10:38:20Z&quot;</span><br><span class="line">  name: regcred</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: &quot;98093&quot;</span><br><span class="line">  selfLink: /api/v1/namespaces/default/secrets/regcred</span><br><span class="line">  uid: 4bd46b7a-9f5c-4a73-9651-c1d947bba264</span><br><span class="line">type: kubernetes.io/dockerconfigjson</span><br></pre></td></tr></table></figure><p><code>.dockerconfigjson</code> å­—æ®µçš„å€¼æ˜¯ Docker å‡­æ®çš„ base64 è¡¨ç¤ºã€‚</p><p>è¦äº†è§£ <code>dockerconfigjson</code> å­—æ®µä¸­çš„å†…å®¹ï¼Œè¯·å°† Secret æ•°æ®è½¬æ¢ä¸ºå¯è¯»æ ¼å¼ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-node1 ~]# kubectl get secret regcred --output=&quot;jsonpath=&#123;.data.\.dockerconfigjson&#125;&quot; | base64 --decode</span><br><span class="line">&#123;&quot;auths&quot;:&#123;&quot;192.168.229.8:8551&quot;:&#123;&quot;username&quot;:&quot;admin&quot;,&quot;password&quot;:&quot;nmk0718&quot;,&quot;email&quot;:&quot;nmk0718@163.com&quot;,&quot;auth&quot;:&quot;YWRtaW46bm1rMDcxOA==&quot;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p>è¦äº†è§£ <code>auth</code> å­—æ®µä¸­çš„å†…å®¹ï¼Œè¯·å°† base64 ç¼–ç è¿‡çš„æ•°æ®è½¬æ¢ä¸ºå¯è¯»æ ¼å¼ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-node1 ~]# echo &quot;YWRtaW46bm1rMDcxOA==&quot; | base64 --decode</span><br><span class="line">admin:nmk0718</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼ŒSecret æ•°æ®åŒ…å«ä¸æœ¬åœ° <code>~/.docker/config.json</code> æ–‡ä»¶ç±»ä¼¼çš„æˆæƒä»¤ç‰Œã€‚</p><p>è¿™æ ·ä½ å°±å·²ç»æˆåŠŸåœ°å°† Docker å‡­æ®è®¾ç½®ä¸ºé›†ç¾¤ä¸­çš„åä¸º <code>regcred</code> çš„ Secretã€‚</p><h5 id="å®šä¹‰æ‹‰å–é•œåƒçš„éƒ¨ç½²"><a href="#å®šä¹‰æ‹‰å–é•œåƒçš„éƒ¨ç½²" class="headerlink" title="å®šä¹‰æ‹‰å–é•œåƒçš„éƒ¨ç½²"></a>å®šä¹‰æ‹‰å–é•œåƒçš„éƒ¨ç½²</h5><p>åˆ›å»ºä¸€ä¸ªä½¿ç”¨ä½ çš„secretçš„pod</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: private-reg</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: private-reg-container</span><br><span class="line">    image: &lt;your-private-image&gt;</span><br><span class="line">  imagePullSecrets:</span><br><span class="line">  - name: regcred</span><br></pre></td></tr></table></figure><p>åœ¨<code>my-private-reg-pod.yaml</code> æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨ç§æœ‰ä»“åº“çš„é•œåƒè·¯å¾„æ›¿æ¢ <code>&lt;your-private-image&gt;</code>ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">192.168.229.8:8551/centos:v1.1</span><br></pre></td></tr></table></figure><p>è¦ä»ç§æœ‰ä»“åº“æ‹‰å–é•œåƒï¼ŒKubernetes éœ€è¦å‡­è¯ã€‚ é…ç½®æ–‡ä»¶ä¸­çš„ <code>imagePullSecrets</code> å­—æ®µè¡¨æ˜ Kubernetes åº”è¯¥é€šè¿‡åä¸º <code>regcred</code> çš„ Secret è·å–å‡­è¯ã€‚</p><p>åˆ›å»ºä½¿ç”¨äº†ä½ çš„ Secret çš„ Podï¼Œå¹¶æ£€æŸ¥å®ƒæ˜¯å¦æ­£å¸¸è¿è¡Œï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl apply -f my-private-reg-pod.yaml</span><br><span class="line">[root@k8s-node1 ~]# kubectl get pod private-reg</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">private-reg   1/1     Running   1          20h</span><br></pre></td></tr></table></figure><h5 id="kuberneteså‘½ä»¤"><a href="#kuberneteså‘½ä»¤" class="headerlink" title="kuberneteså‘½ä»¤"></a>kuberneteså‘½ä»¤</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1ã€æŸ¥çœ‹æŒ‡å®špodçš„æ—¥å¿—</span><br><span class="line"></span><br><span class="line">kubectl logs &lt;pod_name&gt;</span><br><span class="line"></span><br><span class="line">kubectl logs -f &lt;pod_name&gt; #ç±»ä¼¼tail -fçš„æ–¹å¼æŸ¥çœ‹(tail -f å®æ—¶æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ tail -f æ—¥å¿—æ–‡ä»¶log)</span><br><span class="line"></span><br><span class="line">2ã€æŸ¥çœ‹æŒ‡å®špodä¸­æŒ‡å®šå®¹å™¨çš„æ—¥å¿—</span><br><span class="line"></span><br><span class="line">kubectl logs &lt;pod_name&gt; -c &lt;container_name&gt;</span><br><span class="line"></span><br><span class="line">3ã€è¿›å…¥å®¹å™¨çš„pod</span><br><span class="line">kubectl exec -ti &lt;your-pod-name&gt;  -n &lt;your-namespace&gt;  -- /bin/sh</span><br><span class="line"></span><br><span class="line">kubectl exec -it private-reg -n default /bin/bash</span><br><span class="line"></span><br><span class="line">4ã€æ˜¾ç¤ºPodçš„æ›´å¤šä¿¡æ¯</span><br><span class="line">kubectl get pod &lt;pod-name&gt; -o wide</span><br><span class="line"></span><br><span class="line">#ä»¥yamlæ ¼å¼æ˜¾ç¤ºPodçš„è¯¦ç»†ä¿¡æ¯</span><br><span class="line">kubectl get pod &lt;pod-name&gt; -o yaml</span><br><span class="line"></span><br><span class="line">5ã€æŸ¥çœ‹æ‰€æœ‰Podåˆ—è¡¨</span><br><span class="line">kubectl get pods</span><br><span class="line"></span><br><span class="line">#æŸ¥çœ‹rcå’Œserviceåˆ—è¡¨</span><br><span class="line">kubectl get rc,service</span><br><span class="line"></span><br><span class="line">#æŸ¥çœ‹èµ„æºè¯¦ç»†æè¿°</span><br><span class="line"></span><br><span class="line">kubectl describe $&#123;type&#125; $&#123;name&#125; -o wide</span><br><span class="line">kubectl describe pod private-reg</span><br><span class="line">#æŸ¥çœ‹èµ„æº</span><br><span class="line">kubectl get nodes|namespaces|services|pods|rc|deployments|replicasets(rs) -o wide</span><br><span class="line">kubectl get nodes -o wide</span><br></pre></td></tr></table></figure><h5 id="æ‰©å®¹åº”ç”¨"><a href="#æ‰©å®¹åº”ç”¨" class="headerlink" title="æ‰©å®¹åº”ç”¨"></a>æ‰©å®¹åº”ç”¨</h5><p>1ï¼‰è¿›è¡Œæ‰©å®¹</p><p>æ ¹æ®åœºæ™¯éœ€è¦ï¼Œé€šè¿‡kubectl scale deploymentå‘½ä»¤å°†Podçš„æ‰©å®¹åˆ°4ä¸ªã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ kubectl scale deployments my-nexus3 --replicas=4</span><br></pre></td></tr></table></figure><p>2ï¼‰æŸ¥çœ‹æ‰©å®¹åçš„Pod</p><p>åœ¨æ‰©å®¹åï¼Œé€šè¿‡kubectl get podsèƒ½å¤ŸæŸ¥çœ‹æ‰©å®¹åçš„Podæ•°é‡ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods -o wide</span><br></pre></td></tr></table></figure><h5 id="å‡çº§åº”ç”¨"><a href="#å‡çº§åº”ç”¨" class="headerlink" title="å‡çº§åº”ç”¨"></a>å‡çº§åº”ç”¨</h5><p>1ï¼‰ä½¿ç”¨kubectl set imageå‘½ä»¤æ›´æ–°åº”ç”¨é•œåƒç‰ˆæœ¬</p><p>å½“åº”ç”¨å‘å¸ƒæ–°ç‰ˆæœ¬åï¼Œå¯ä»¥</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ kubectl set image deployments/my-nexus3 *=sonatype/nexus3:latest</span><br></pre></td></tr></table></figure><p>2ï¼‰å›æ»šå‡çº§åˆ°ä¹‹å‰çš„ç‰ˆæœ¬</p><p>å½“éƒ¨ç½²çš„ç‰ˆæœ¬å­˜åœ¨é—®é¢˜æ—¶ï¼Œå¯ä»¥é€šè¿‡æ‰§è¡Œkubectl rollout unduoå›æ»šè‡³ä¹‹å‰çš„ç‰ˆæœ¬ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ kubectl rollout undo deployments/my-nexus3</span><br></pre></td></tr></table></figure><p>3ï¼‰æŸ¥çœ‹éƒ¨ç½²çš„å›æ»šçŠ¶æ€</p><p>å›æ»šçŠ¶æ€ï¼Œå¯ä»¥é€šè¿‡rollout statusç¡®è®¤ã€‚é€šè¿‡æ‰§è¡Œkubectl rollout stautså¯ä»¥æŸ¥çœ‹å‡çº§å’Œå›å½’çš„çŠ¶æ€ä¿¡æ¯ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ kubectl rollout status deployments/my-nexus3</span><br></pre></td></tr></table></figure><h5 id="è„šæœ¬å®šæ—¶åˆ é™¤workerç¯å¢ƒçš„é•œåƒ"><a href="#è„šæœ¬å®šæ—¶åˆ é™¤workerç¯å¢ƒçš„é•œåƒ" class="headerlink" title="è„šæœ¬å®šæ—¶åˆ é™¤workerç¯å¢ƒçš„é•œåƒ"></a>è„šæœ¬å®šæ—¶åˆ é™¤workerç¯å¢ƒçš„é•œåƒ</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker rmi `docker images | grep  &quot;&lt;none&gt;&quot; | awk &apos;&#123;print $3&#125;&apos;`</span><br></pre></td></tr></table></figure><h5 id="docker-login-å‡ºç°é”™è¯¯"><a href="#docker-login-å‡ºç°é”™è¯¯" class="headerlink" title="docker login å‡ºç°é”™è¯¯"></a>docker login å‡ºç°é”™è¯¯</h5><p>WARNING! Using â€“password via the CLI is insecure. Use â€“password-stdin.<br>Error response from daemon: Get <a href="https://192.168.229.8:8551/v2/" target="_blank" rel="noopener">https://192.168.229.8:8551/v2/</a>: http: server gave HTTP response to HTTPS client</p><p>åœ¨/etc/docker/daemon.jsonä¸­åŠ å…¥insecure-registriesæŒ‡å®šç§æœåº“åœ°å€,é‡å¯dockerå³å¯</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-node2 ~]# vi /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://registry.cn-hangzhou.aliyuncs.com&quot;],</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">  &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">  &quot;log-opts&quot;: &#123;</span><br><span class="line">    &quot;max-size&quot;: &quot;100m&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">  &quot;storage-opts&quot;: [</span><br><span class="line">    &quot;overlay2.override_kernel_check=true&quot;</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">    &quot;insecure-registries&quot;: [</span><br><span class="line">       &quot;192.168.229.8:8551&quot;</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">[root@k8s-node2 ~]# systemctl restart docker</span><br></pre></td></tr></table></figure><p>Error response from daemon: login attempt to <a href="http://xx.xx.xx.xx:2020/v2/" target="_blank" rel="noopener">http://xx.xx.xx.xx:2020/v2/</a> failed with status: 401 Unauthorized</p><img src="\image\2.png"><p>æ·»åŠ <code>Docker Bearer Token Realm</code>åˆ°Activeå³å¯</p><h5 id="Kubernetes-podçŠ¶æ€å‡ºç°ImagePullBackOffçš„åŸå› "><a href="#Kubernetes-podçŠ¶æ€å‡ºç°ImagePullBackOffçš„åŸå› " class="headerlink" title="Kubernetes podçŠ¶æ€å‡ºç°ImagePullBackOffçš„åŸå› "></a>Kubernetes podçŠ¶æ€å‡ºç°ImagePullBackOffçš„åŸå› </h5><p>æŸ¥çœ‹è¿™ä¸ªPodçš„çŠ¶æ€ï¼Œå‘ç°çŠ¶æ€ä¸º ErrImagePull æˆ–è€… ImagePullBackOffï¼š</p><p>[root@k8s-node1 ~]#  kubectl get pods<br>NAME          READY   STATUS    RESTARTS   AGE<br>failpod   1/1     ImagePullBackOff   1          14h</p><p>å¯ä»¥ä½¿ç”¨describeå‘½ä»¤æŸ¥çœ‹è¿™ä¸ªå¤±è´¥çš„Podçš„æ˜ç»†ï¼š<br>[root@k8s-node1 ~]#  kubectl describe pod failpod</p><p>æŸ¥çœ‹ describe å‘½ä»¤çš„è¾“å‡ºä¸­ Events è¿™éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹å†…å®¹ï¼š<br>  Normal   BackOff                 14h (x5 over 14h)   kubelet            Back-off pulling image â€œ192.168.229.8:8551/centos:v1.3â€<br>  Warning  Failed                  14h (x4 over 14h)   kubelet            Failed to pull image â€œ192.168.229.8:8551/centos:v1.3â€: rpc error: code = Unknown desc = Error response from daemon: Get <a href="https://192.168.229.8:8551/v2/" target="_blank" rel="noopener">https://192.168.229.8:8551/v2/</a>: http: server gave HTTP response to HTTPS client<br>  Warning  Failed                  14h (x4 over 14h)   kubelet            Error: ErrImagePull</p><p>å¾—çŸ¥åŸå› ä¸ºpullçš„é“¾æ¥ä¸ºhttps,æ›´æ”¹/etc/docker/daemon.jsonæ·»åŠ ç§æœ‰åº“åœ°å€é‡å¯å³å¯</p><p>æ³¨æ„ï¼šè§‚å¯Ÿ Pod çŠ¶æ€çš„æ—¶å€™ï¼Œé•œåƒç¼ºå¤±å’Œä»“åº“æƒé™ä¸æ­£ç¡®æ˜¯æ²¡æ³•åŒºåˆ†çš„ã€‚å…¶å®ƒæƒ…å†µä¸‹ï¼ŒKubernetes å°†æŠ¥å‘Šä¸€ä¸ª ErrImagePull çŠ¶æ€ã€‚</p><h3 id="å®¿ä¸»æœºæ˜ å°„k8sä¸­çš„æœåŠ¡"><a href="#å®¿ä¸»æœºæ˜ å°„k8sä¸­çš„æœåŠ¡" class="headerlink" title="å®¿ä¸»æœºæ˜ å°„k8sä¸­çš„æœåŠ¡"></a>å®¿ä¸»æœºæ˜ å°„k8sä¸­çš„æœåŠ¡</h3><h4 id="NodePort"><a href="#NodePort" class="headerlink" title="NodePort"></a>NodePort</h4><p>æˆ‘ä»¬éœ€è¦åœ¨serviceçš„yamlå®šä¹‰ä¸­æŒ‡å®šnodePortï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: my-service</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort        // æŒ‡å®šserviceç±»å‹</span><br><span class="line">  selector:</span><br><span class="line">    app: forme</span><br><span class="line">  ports:</span><br><span class="line">    - port: 8088         // ä¾›é›†ç¾¤ä¸­å…¶å®ƒæœåŠ¡è®¿é—®çš„ç«¯å£</span><br><span class="line">      targetPort: 8088 // åç«¯podä¸­containeræš´éœ²çš„ç«¯å£</span><br><span class="line">      nodePort: 8088   //  èŠ‚ç‚¹æš´éœ²çš„ç«¯å£</span><br></pre></td></tr></table></figure><p>éªŒè¯</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://192.168.50.56:8088/health(å®¿ä¸»æœºip+nodePort)</span><br></pre></td></tr></table></figure><p><strong>ä¿®æ”¹NodePortçš„èŒƒå›´</strong></p><p>åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼ŒNodePort é»˜è®¤èŒƒå›´æ˜¯ 30000-32767</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-master ~]# vi /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    kubeadm.kubernetes.io/kube-apiserver.advertise-address.endpoint: 192.168.50.53:6443</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    component: kube-apiserver</span><br><span class="line">    tier: control-plane</span><br><span class="line">  name: kube-apiserver</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - command:</span><br><span class="line">    - kube-apiserver</span><br><span class="line">    - --advertise-address=192.168.50.53</span><br><span class="line">    - --allow-privileged=true</span><br><span class="line">    - --authorization-mode=Node,RBAC</span><br><span class="line">    - --client-ca-file=/etc/kubernetes/pki/ca.crt</span><br><span class="line">    - --enable-admission-plugins=NodeRestriction</span><br><span class="line">    - --enable-bootstrap-token-auth=true</span><br><span class="line">    - --etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt</span><br><span class="line">    - --etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt</span><br><span class="line">    - --etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key</span><br><span class="line">    - --etcd-servers=https://127.0.0.1:2379</span><br><span class="line">    - --insecure-port=0</span><br><span class="line">    - --kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt</span><br><span class="line">    - --kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key</span><br><span class="line">    - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span><br><span class="line">    - --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.crt</span><br><span class="line">    - --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client.key</span><br><span class="line">    - --requestheader-allowed-names=front-proxy-client</span><br><span class="line">    - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt</span><br><span class="line">    - --requestheader-extra-headers-prefix=X-Remote-Extra-</span><br><span class="line">    - --requestheader-group-headers=X-Remote-Group</span><br><span class="line">    - --requestheader-username-headers=X-Remote-User</span><br><span class="line">    - --secure-port=6443</span><br><span class="line">    - --service-account-key-file=/etc/kubernetes/pki/sa.pub</span><br><span class="line">    - --service-cluster-ip-range=10.96.0.0/16</span><br><span class="line">    - --tls-cert-file=/etc/kubernetes/pki/apiserver.crt</span><br><span class="line">    - --tls-private-key-file=/etc/kubernetes/pki/apiserver.key</span><br><span class="line">    image: registry.aliyuncs.com/k8sxio/kube-apiserver:v1.19.2</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    livenessProbe:</span><br><span class="line">      failureThreshold: 8</span><br><span class="line">      httpGet:</span><br><span class="line">        host: 192.168.50.53</span><br><span class="line">        path: /livez</span><br><span class="line">        port: 6443</span><br><span class="line">        scheme: HTTPS</span><br><span class="line">      initialDelaySeconds: 10</span><br><span class="line">      periodSeconds: 10</span><br><span class="line">      timeoutSeconds: 15</span><br><span class="line">    name: kube-apiserver</span><br><span class="line">    readinessProbe:</span><br><span class="line">      failureThreshold: 3</span><br><span class="line">      httpGet:</span><br><span class="line">        host: 192.168.50.53</span><br><span class="line">        path: /readyz</span><br><span class="line">        port: 6443</span><br><span class="line">        scheme: HTTPS</span><br><span class="line">      periodSeconds: 1</span><br><span class="line">      timeoutSeconds: 15</span><br><span class="line">    resources:</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 250m</span><br><span class="line">    startupProbe:</span><br><span class="line">      failureThreshold: 24</span><br><span class="line">      httpGet:</span><br><span class="line">        host: 192.168.50.53</span><br><span class="line">        path: /livez</span><br><span class="line">        port: 6443</span><br><span class="line">        scheme: HTTPS</span><br><span class="line">      initialDelaySeconds: 10</span><br><span class="line">      periodSeconds: 10</span><br><span class="line">      timeoutSeconds: 15</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - mountPath: /etc/ssl/certs</span><br><span class="line">      name: ca-certs</span><br><span class="line">      readOnly: true</span><br><span class="line">    - mountPath: /etc/pki</span><br><span class="line">      name: etc-pki</span><br><span class="line">      readOnly: true</span><br><span class="line">    - mountPath: /etc/kubernetes/pki</span><br><span class="line">      name: k8s-certs</span><br><span class="line">      readOnly: true</span><br><span class="line">  hostNetwork: true</span><br><span class="line">  priorityClassName: system-node-critical</span><br><span class="line">  volumes:</span><br><span class="line">  - hostPath:</span><br><span class="line">      path: /etc/ssl/certs</span><br><span class="line">      type: DirectoryOrCreate</span><br><span class="line">    name: ca-certs</span><br><span class="line">  - hostPath:</span><br><span class="line">      path: /etc/pki</span><br><span class="line">      type: DirectoryOrCreate</span><br><span class="line">    name: etc-pki</span><br><span class="line">  - hostPath:</span><br><span class="line">      path: /etc/kubernetes/pki</span><br><span class="line">      type: DirectoryOrCreate</span><br><span class="line">    name: k8s-certs</span><br><span class="line">status: &#123;&#125;</span><br><span class="line"></span><br><span class="line">åœ¨- --service-cluster-ip-range=10.96.0.0/16ä¸‹é¢åŠ å…¥ä»¥ä¸‹é…ç½®</span><br><span class="line">- --service-node-port-range=7000-10000</span><br></pre></td></tr></table></figure><p>é‡å¯apiserver</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># è·å¾— apiserver çš„ pod åå­—</span><br><span class="line">export apiserver_pods=$(kubectl get pods --selector=component=kube-apiserver -n kube-system --output=jsonpath=&#123;.items..metadata.name&#125;)</span><br><span class="line"># åˆ é™¤ apiserver çš„ pod</span><br><span class="line">kubectl delete pod $apiserver_pods -n kube-system</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ŒéªŒè¯ä¿®æ”¹æ˜¯å¦ç”Ÿæ•ˆ:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl describe pod $apiserver_pods -n kube-system</span><br></pre></td></tr></table></figure><h4 id="HostNetwork"><a href="#HostNetwork" class="headerlink" title="HostNetwork"></a>HostNetwork</h4><p>æ›´æ”¹app.yaml</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: ymall</span><br><span class="line">  name: ymall</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: ymall</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 25%</span><br><span class="line">      maxUnavailable: 25%</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: ymall</span><br><span class="line">    spec:</span><br><span class="line">      hostNetwork: true</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: regcred</span><br><span class="line">      containers:</span><br><span class="line">      - name: ymall</span><br><span class="line">        image: 192.168.50.52:8551/ymall:latest</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        ports:</span><br><span class="line">    - containerPort: 8080</span><br><span class="line">        resources:</span><br><span class="line">            limits:</span><br><span class="line">              cpu: 800m</span><br><span class="line">              memory: 1224Mi</span><br><span class="line">            requests:</span><br><span class="line">              cpu: 100m</span><br><span class="line">              memory: 512Mi</span><br></pre></td></tr></table></figure><ul><li>ä¸»è¦å‚æ•°:hostNetwork: true,containerPort: 8080</li><li>ä½¿ç”¨hostç½‘ç»œæ¨¡å¼,ä½¿å®¹å™¨ä½¿ç”¨å®¿ä¸»æœºipå°±æ— éœ€å†è¿›è¡Œåˆ›å»ºservice.yaml</li></ul><p>åˆ›å»ºå³å¯è·å¾—å®¿ä¸»æœºipçš„å®¹å™¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl apply -f app.yaml</span><br><span class="line">[root@k8s-master ~]# kubectl get po --all-namespaces -o wide --show-labels |grep ymall</span><br><span class="line">default         ymall-754946fd54-dwwjp                          1/1     Running   0          37s   192.168.50.54    k8s-work1    &lt;none&gt;           &lt;none&gt;            app=ymall,pod-template-hash=754946fd54</span><br></pre></td></tr></table></figure><p>å®¹å™¨ipå·²ç»å˜æ›´ä¸ºå®¿ä¸»æœºip</p><h4 id="æŒ‚è½½å®¹å™¨ç›®å½•åˆ°å®¿ä¸»æœºç›®å½•"><a href="#æŒ‚è½½å®¹å™¨ç›®å½•åˆ°å®¿ä¸»æœºç›®å½•" class="headerlink" title="æŒ‚è½½å®¹å™¨ç›®å½•åˆ°å®¿ä¸»æœºç›®å½•"></a>æŒ‚è½½å®¹å™¨ç›®å½•åˆ°å®¿ä¸»æœºç›®å½•</h4><p>æ›´æ”¹yaml</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: appname</span><br><span class="line">  name: appname</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: appname</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 25%</span><br><span class="line">      maxUnavailable: 25%</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: appname</span><br><span class="line">    spec:</span><br><span class="line">      hostNetwork: true</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: regcred</span><br><span class="line">      containers:</span><br><span class="line">      - name: appname</span><br><span class="line">        image: 192.168.50.52:8551/appname:latest</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: appname</span><br><span class="line">          mountPath: /home/www/appCenterTest/public</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8081</span><br><span class="line">        resources:</span><br><span class="line">            limits:</span><br><span class="line">              cpu: 800m</span><br><span class="line">              memory: 1224Mi</span><br><span class="line">            requests:</span><br><span class="line">              cpu: 100m</span><br><span class="line">              memory: 512Mi</span><br><span class="line">      volumes:</span><br><span class="line">      - name: appname</span><br><span class="line">        hostPath:</span><br><span class="line">           path: /data</span><br><span class="line">           type: Directory</span><br></pre></td></tr></table></figure><h3 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-master ~]# wget https://github.com/prometheus-operator/kube-prometheus/archive/v0.6.0.tar.gz</span><br><span class="line">[root@k8s-master ~]# tar zxvf kube-prometheus-0.6.0.tar.gz</span><br><span class="line">[root@k8s-master ~]# cd kube-prometheus-0.6.0</span><br><span class="line">[root@k8s-master ~]# kubectl create -f manifests/setup</span><br><span class="line">[root@k8s-master ~]# until kubectl get servicemonitors --all-namespaces ; do date; sleep 1; echo â€œâ€; done</span><br><span class="line">[root@k8s-master ~]# kubectl create -f manifests/</span><br><span class="line">[root@k8s-master ~]# kubectl get pod -n monitoring</span><br><span class="line">NAME                                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">alertmanager-main-0                    2/2     Running   0          74m</span><br><span class="line">alertmanager-main-1                    2/2     Running   0          74m</span><br><span class="line">alertmanager-main-2                    2/2     Running   0          74m</span><br><span class="line">grafana-7c9bc466d8-r566p               1/1     Running   0          88m</span><br><span class="line">kube-state-metrics-66b65b78bc-mhgxq    3/3     Running   0          88m</span><br><span class="line">node-exporter-2764r                    2/2     Running   0          88m</span><br><span class="line">node-exporter-92pd7                    2/2     Running   0          88m</span><br><span class="line">node-exporter-mkj2p                    2/2     Running   0          88m</span><br><span class="line">node-exporter-mxrd9                    2/2     Running   0          88m</span><br><span class="line">prometheus-adapter-557648f58c-j4jcz    1/1     Running   0          88m</span><br><span class="line">prometheus-k8s-0                       3/3     Running   1          74m</span><br><span class="line">prometheus-k8s-1                       3/3     Running   0          74m</span><br><span class="line">prometheus-operator-5b7946f4d6-jqwbb   2/2     Running   0          88m</span><br><span class="line"></span><br><span class="line">#å› ç«¯å£é—®é¢˜,éœ€æ‰‹åŠ¨ä¿®æ”¹prometheus alertmanager grafanaçš„Nodeport,åŠ å…¥nodePort: 8001å’Œtype: NodePortå³å¯</span><br><span class="line">ç¤ºä¾‹</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: &apos;2020-12-05T09:37:14Z&apos;</span><br><span class="line">  labels:</span><br><span class="line">    app: grafana</span><br><span class="line">  managedFields:</span><br><span class="line">    - apiVersion: v1</span><br><span class="line">      fieldsType: FieldsV1</span><br><span class="line">      fieldsV1:</span><br><span class="line">        &apos;f:metadata&apos;: &#123;&#125;</span><br><span class="line">        &apos;f:spec&apos;:</span><br><span class="line">          &apos;f:ports&apos;: &#123;&#125;</span><br><span class="line">      manager: kubectl-create</span><br><span class="line">      operation: Update</span><br><span class="line">      time: &apos;2020-12-05T09:37:14Z&apos;</span><br><span class="line">  name: grafana</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  resourceVersion: &apos;9637020&apos;</span><br><span class="line">  selfLink: /api/v1/namespaces/monitoring/services/grafana</span><br><span class="line">  uid: 6e6edd10-68b4-43b6-93ba-9b72e280d411</span><br><span class="line">spec:</span><br><span class="line">  clusterIP: 10.96.98.51</span><br><span class="line">  ports:</span><br><span class="line">    - name: http</span><br><span class="line">      port: 3000</span><br><span class="line">      protocol: TCP</span><br><span class="line">      targetPort: http</span><br><span class="line">  selector:</span><br><span class="line">    app: grafana</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  type: ClusterIP</span><br><span class="line">æ”¹ä¸º</span><br><span class="line">spec:</span><br><span class="line">  clusterIP: 10.96.98.51</span><br><span class="line">  ports:</span><br><span class="line">    - name: http</span><br><span class="line">      nodePort: 8001</span><br><span class="line">      port: 3000</span><br><span class="line">      protocol: TCP</span><br><span class="line">      targetPort: http</span><br><span class="line">  selector:</span><br><span class="line">    app: grafana</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  type: NodePort</span><br></pre></td></tr></table></figure><p>ç­‰å¾…å…¨éƒ¨å¯åŠ¨å®Œæ¯•å³å¯<br><img src="\image\image-20201210154137980.png"></p><p>å¯¼å…¥ç›‘æ§æ¨¡æ¿<br><img src="\image\image-20201210154216377.png"></p><p>å®Œæˆ<br><img src="\image\image-20201210154228617.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;éƒ¨ç½²æµç¨‹å¦‚ä¸‹å›¾&lt;/p&gt;
&lt;img src=&quot;\image\1.png&quot;&gt;

&lt;h3 id=&quot;Kubernetes&quot;&gt;&lt;a href=&quot;#Kubernetes&quot; class=&quot;headerlink&quot; title=&quot;Kubernetes&quot;&gt;&lt;/a&gt;Kubernetes&lt;/h3&gt;</summary>
      
    
    
    
    
    <category term="k8s" scheme="https://nmk0718.github.io/tag/k8s/"/>
    
  </entry>
  
  <entry>
    <title>Process</title>
    <link href="https://nmk0718.github.io/2020/10/16/Process/"/>
    <id>https://nmk0718.github.io/2020/10/16/Process/</id>
    <published>2020-10-16T03:35:00.000Z</published>
    <updated>2024-11-29T06:44:07.100Z</updated>
    
    <content type="html"><![CDATA[<h3 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h3><h4 id="windowsä¸‹æ€æ‰æŒ‡å®šåº”ç”¨"><a href="#windowsä¸‹æ€æ‰æŒ‡å®šåº”ç”¨" class="headerlink" title="windowsä¸‹æ€æ‰æŒ‡å®šåº”ç”¨"></a>windowsä¸‹æ€æ‰æŒ‡å®šåº”ç”¨</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">taskkill /im nginx.exe /f</span><br><span class="line">#/im  ç«‹å³  /f   å¼ºåˆ¶ç»“æŸè¿›ç¨‹</span><br><span class="line">#ä»»åŠ¡ç®¡ç†å™¨&gt;è¯¦ç»†ä¿¡æ¯&gt;å†…å­˜&gt;æŸ¥çœ‹åº”ç”¨çš„pid</span><br></pre></td></tr></table></figure><h4 id="windowsä¸‹æ€æ‰æŒ‡å®šç«¯å£çš„è¿›ç¨‹"><a href="#windowsä¸‹æ€æ‰æŒ‡å®šç«¯å£çš„è¿›ç¨‹" class="headerlink" title="windowsä¸‹æ€æ‰æŒ‡å®šç«¯å£çš„è¿›ç¨‹"></a>windowsä¸‹æ€æ‰æŒ‡å®šç«¯å£çš„è¿›ç¨‹</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">for /f &quot;tokens=5&quot; %%i in (&apos;netstat -aon ^| findstr &quot;:9091&quot;&apos;) do (set j=%%i)</span><br><span class="line">taskkill /t /f /pid %j% </span><br><span class="line">#netstat -aon | findstr &quot;:port&quot; æŸ¥æ‰¾ç«¯å£å¯¹åº”çš„pid</span><br><span class="line">#taskkill /t /f /pid æ€æ‰pidå¯¹åº”çš„è¿›ç¨‹</span><br></pre></td></tr></table></figure><h4 id="å¦‚æœ‰é‡åˆ°åˆ é™¤æ–‡ä»¶-æç¤ºæ­£åœ¨è¢«ä½¿ç”¨"><a href="#å¦‚æœ‰é‡åˆ°åˆ é™¤æ–‡ä»¶-æç¤ºæ­£åœ¨è¢«ä½¿ç”¨" class="headerlink" title="å¦‚æœ‰é‡åˆ°åˆ é™¤æ–‡ä»¶,æç¤ºæ­£åœ¨è¢«ä½¿ç”¨"></a>å¦‚æœ‰é‡åˆ°åˆ é™¤æ–‡ä»¶,æç¤ºæ­£åœ¨è¢«ä½¿ç”¨</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ä»»åŠ¡ç®¡ç†å™¨&gt;æ€§èƒ½&gt;æ‰“å¼€èµ„æºç›‘è§†å™¨&gt;CPU&gt;å…³è”çš„å¥æŸ„</span><br><span class="line">æœç´¢éœ€è¦åˆ é™¤çš„æ–‡ä»¶å¤¹åç§°æˆ–æ–‡ä»¶åç§°</span><br></pre></td></tr></table></figure><h4 id="å¦‚æœ‰é‡åˆ°æŸè¿›ç¨‹å ç”¨å†…å­˜è¿‡å¤§-å¹¶ä¸æ¸…æ¥šåº”ç”¨æƒ…å†µä¸‹"><a href="#å¦‚æœ‰é‡åˆ°æŸè¿›ç¨‹å ç”¨å†…å­˜è¿‡å¤§-å¹¶ä¸æ¸…æ¥šåº”ç”¨æƒ…å†µä¸‹" class="headerlink" title="å¦‚æœ‰é‡åˆ°æŸè¿›ç¨‹å ç”¨å†…å­˜è¿‡å¤§,å¹¶ä¸æ¸…æ¥šåº”ç”¨æƒ…å†µä¸‹"></a>å¦‚æœ‰é‡åˆ°æŸè¿›ç¨‹å ç”¨å†…å­˜è¿‡å¤§,å¹¶ä¸æ¸…æ¥šåº”ç”¨æƒ…å†µä¸‹</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ä»»åŠ¡ç®¡ç†å™¨&gt;è¯¦ç»†ä¿¡æ¯&gt;å†…å­˜&gt;æŸ¥çœ‹åº”ç”¨çš„pid</span><br><span class="line">ä»»åŠ¡ç®¡ç†å™¨&gt;&gt;æ€§èƒ½&gt;æ‰“å¼€èµ„æºç›‘è§†å™¨&gt;æ¦‚è¿°&gt;ç£ç›˜&gt;æŒ‰pidæ’åº</span><br><span class="line">å³å¯çœ‹åˆ°pidå¯¹åº”çš„å¯åŠ¨æ–‡ä»¶å’Œç›®å½•</span><br></pre></td></tr></table></figure><h4 id="å¦‚æœ‰é‡åˆ°ä½¿ç”¨windowsè¿œç¨‹-ä¸å¯å¤åˆ¶ç²˜è´´æƒ…å†µ"><a href="#å¦‚æœ‰é‡åˆ°ä½¿ç”¨windowsè¿œç¨‹-ä¸å¯å¤åˆ¶ç²˜è´´æƒ…å†µ" class="headerlink" title="å¦‚æœ‰é‡åˆ°ä½¿ç”¨windowsè¿œç¨‹,ä¸å¯å¤åˆ¶ç²˜è´´æƒ…å†µ"></a>å¦‚æœ‰é‡åˆ°ä½¿ç”¨windowsè¿œç¨‹,ä¸å¯å¤åˆ¶ç²˜è´´æƒ…å†µ</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ä»»åŠ¡ç®¡ç†å™¨&gt;ç”¨æˆ·&gt;nmk&gt;RDPå‰ªè´´æ¿ç›‘è§†ç¨‹åº</span><br><span class="line">ç»“æŸæ‰RDP,ä½¿ç”¨windows+Rè¿è¡Œrdpclip.exeå³å¯</span><br></pre></td></tr></table></figure><h4 id="å¦‚æœ‰é‡åˆ°windowsé»‘å±æˆ–ä»»åŠ¡æ ä¸è§ç­‰æƒ…å†µ"><a href="#å¦‚æœ‰é‡åˆ°windowsé»‘å±æˆ–ä»»åŠ¡æ ä¸è§ç­‰æƒ…å†µ" class="headerlink" title="å¦‚æœ‰é‡åˆ°windowsé»‘å±æˆ–ä»»åŠ¡æ ä¸è§ç­‰æƒ…å†µ"></a>å¦‚æœ‰é‡åˆ°windowsé»‘å±æˆ–ä»»åŠ¡æ ä¸è§ç­‰æƒ…å†µ</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ä»»åŠ¡ç®¡ç†å™¨&gt;ç”¨æˆ·&gt;nmk&gt;windowsèµ„æºç®¡ç†å™¨</span><br><span class="line">ç»“æŸæ‰windowsèµ„æºç®¡ç†å™¨,ä½¿ç”¨windows+Rè¿è¡Œexplorer.exeå³å¯</span><br></pre></td></tr></table></figure><h3 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h3><h4 id="linuxä¸‹æŸ¥çœ‹ip"><a href="#linuxä¸‹æŸ¥çœ‹ip" class="headerlink" title="linuxä¸‹æŸ¥çœ‹ip"></a>linuxä¸‹æŸ¥çœ‹ip</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ifconfig|grep 192|awk &apos;&#123;print $2&#125;&apos;</span><br><span class="line">curl ifconfig.me</span><br></pre></td></tr></table></figure><h4 id="linuxä¸‹æ€æ‰æŒ‡å®šç«¯å£è¿›ç¨‹"><a href="#linuxä¸‹æ€æ‰æŒ‡å®šç«¯å£è¿›ç¨‹" class="headerlink" title="linuxä¸‹æ€æ‰æŒ‡å®šç«¯å£è¿›ç¨‹"></a>linuxä¸‹æ€æ‰æŒ‡å®šç«¯å£è¿›ç¨‹</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">port=48094</span><br><span class="line">#æ ¹æ®ç«¯å£å·æŸ¥è¯¢å¯¹åº”çš„pid</span><br><span class="line">pid=$(netstat -nlp | grep :$port | awk &apos;&#123;print $7&#125;&apos; | awk -F&quot;/&quot; &apos;&#123; print $1 &#125;&apos;);</span><br><span class="line"></span><br><span class="line">#æ€æ‰å¯¹åº”çš„è¿›ç¨‹ï¼Œå¦‚æœpidä¸å­˜åœ¨ï¼Œåˆ™ä¸æ‰§è¡Œ</span><br><span class="line">if [  -n  &quot;$pid&quot;  ];  then</span><br><span class="line">    kill  -9  $pid;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h4 id="linuxæŸ¥çœ‹åº”ç”¨è¿›ç¨‹"><a href="#linuxæŸ¥çœ‹åº”ç”¨è¿›ç¨‹" class="headerlink" title="linuxæŸ¥çœ‹åº”ç”¨è¿›ç¨‹"></a>linuxæŸ¥çœ‹åº”ç”¨è¿›ç¨‹</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ps -ef|grep java</span><br><span class="line">#grepä¸ºè¿‡æ»¤ javaä¸ºå¯åŠ¨çš„åº”ç”¨</span><br><span class="line">#è¾“å‡ºç»“æœjavaåçš„æ•°å­—ä¸ºpid,å¦‚éœ€ç»“æŸ,ä½¿ç”¨kill -9 pid</span><br><span class="line">netstat -lntp</span><br><span class="line">#æŸ¥çœ‹å½“å‰åº”ç”¨ä½¿ç”¨çš„ç«¯å£å’Œpid</span><br></pre></td></tr></table></figure><h4 id="linuxæŸ¥çœ‹æ–‡ä»¶æœ‰å¤šå°‘è¡Œ"><a href="#linuxæŸ¥çœ‹æ–‡ä»¶æœ‰å¤šå°‘è¡Œ" class="headerlink" title="linuxæŸ¥çœ‹æ–‡ä»¶æœ‰å¤šå°‘è¡Œ"></a>linuxæŸ¥çœ‹æ–‡ä»¶æœ‰å¤šå°‘è¡Œ</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wc -l filename#è¾“å‡ºfilenameçš„è¡Œæ•°</span><br><span class="line">wc -c filename#è¾“å‡ºfilenameçš„å­—èŠ‚æ•°</span><br><span class="line">wc -m filename#è¾“å‡ºfilenameçš„å­—ç¬¦æ•°</span><br><span class="line">wc -w filename#è¾“å‡ºfilenameçš„å­—æ•°</span><br></pre></td></tr></table></figure><h4 id="linuxæŸ¥æ‰¾æ–‡ä»¶"><a href="#linuxæŸ¥æ‰¾æ–‡ä»¶" class="headerlink" title="linuxæŸ¥æ‰¾æ–‡ä»¶"></a>linuxæŸ¥æ‰¾æ–‡ä»¶</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">åœ¨ä½¿ç”¨linuxæ—¶ï¼Œç»å¸¸éœ€è¦è¿›è¡Œæ–‡ä»¶æŸ¥æ‰¾ã€‚å…¶ä¸­æŸ¥æ‰¾çš„å‘½ä»¤ä¸»è¦æœ‰findå’Œgrepã€‚ä¸¤ä¸ªå‘½ä»¤æ˜¯æœ‰åŒºåˆ«çš„ã€‚</span><br><span class="line">(1)findå‘½ä»¤æ˜¯æ ¹æ®æ–‡ä»¶çš„å±æ€§è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¦‚æ–‡ä»¶åï¼Œæ–‡ä»¶å¤§å°ï¼Œæ‰€æœ‰è€…ï¼Œæ‰€å±ç»„ï¼Œæ˜¯å¦ä¸ºç©ºï¼Œè®¿é—®æ—¶é—´ï¼Œä¿®æ”¹æ—¶é—´ç­‰ã€‚ </span><br><span class="line">(2)grepæ˜¯æ ¹æ®æ–‡ä»¶çš„å†…å®¹è¿›è¡ŒæŸ¥æ‰¾ï¼Œä¼šå¯¹æ–‡ä»¶çš„æ¯ä¸€è¡ŒæŒ‰ç…§ç»™å®šçš„æ¨¡å¼(patter)è¿›è¡ŒåŒ¹é…æŸ¥æ‰¾ã€‚</span><br><span class="line"></span><br><span class="line">ã€€ã€€ä¸€.findå‘½ä»¤</span><br><span class="line"></span><br><span class="line">ã€€ã€€ã€€ã€€åŸºæœ¬æ ¼å¼ï¼šfind  path expression</span><br><span class="line"></span><br><span class="line">ã€€ã€€ã€€ã€€1.æŒ‰ç…§æ–‡ä»¶åæŸ¥æ‰¾</span><br><span class="line"></span><br><span class="line">ã€€ã€€ã€€ã€€(1)find / -name httpd.confã€€ã€€#åœ¨æ ¹ç›®å½•ä¸‹æŸ¥æ‰¾æ–‡ä»¶httpd.confï¼Œè¡¨ç¤ºåœ¨æ•´ä¸ªç¡¬ç›˜æŸ¥æ‰¾</span><br><span class="line">ã€€ã€€ã€€ã€€(2)find /etc -name httpd.confã€€ã€€#åœ¨/etcç›®å½•ä¸‹æ–‡ä»¶httpd.conf</span><br><span class="line">ã€€ã€€ã€€ã€€(3)find /etc -name &apos;*srm*&apos;ã€€ã€€#ä½¿ç”¨é€šé…ç¬¦*(0æˆ–è€…ä»»æ„å¤šä¸ª)ã€‚è¡¨ç¤ºåœ¨/etcç›®å½•ä¸‹æŸ¥æ‰¾æ–‡ä»¶åä¸­å«æœ‰å­—ç¬¦ä¸²â€˜srmâ€™çš„æ–‡ä»¶</span><br><span class="line">ã€€ã€€ã€€ã€€(4)find . -name &apos;srm*&apos; ã€€ã€€#è¡¨ç¤ºå½“å‰ç›®å½•ä¸‹æŸ¥æ‰¾æ–‡ä»¶åå¼€å¤´æ˜¯å­—ç¬¦ä¸²â€˜srmâ€™çš„æ–‡ä»¶</span><br><span class="line"></span><br><span class="line">ã€€ã€€ã€€ã€€2.æŒ‰ç…§æ–‡ä»¶ç‰¹å¾æŸ¥æ‰¾ ã€€ã€€ã€€ã€€</span><br><span class="line"></span><br><span class="line">ã€€ã€€ã€€ã€€(1)find / -amin -10 ã€€ã€€# æŸ¥æ‰¾åœ¨ç³»ç»Ÿä¸­æœ€å10åˆ†é’Ÿè®¿é—®çš„æ–‡ä»¶(access time)</span><br><span class="line">ã€€ã€€ã€€ã€€(2)find / -atime -2ã€€ã€€ # æŸ¥æ‰¾åœ¨ç³»ç»Ÿä¸­æœ€å48å°æ—¶è®¿é—®çš„æ–‡ä»¶</span><br><span class="line">ã€€ã€€ã€€ã€€(3)find / -empty ã€€ã€€# æŸ¥æ‰¾åœ¨ç³»ç»Ÿä¸­ä¸ºç©ºçš„æ–‡ä»¶æˆ–è€…æ–‡ä»¶å¤¹</span><br><span class="line">ã€€ã€€ã€€ã€€(4)find / -group cat ã€€ã€€# æŸ¥æ‰¾åœ¨ç³»ç»Ÿä¸­å±äº groupä¸ºcatçš„æ–‡ä»¶</span><br><span class="line">ã€€ã€€ã€€ã€€(5)find / -mmin -5 ã€€ã€€# æŸ¥æ‰¾åœ¨ç³»ç»Ÿä¸­æœ€å5åˆ†é’Ÿé‡Œä¿®æ”¹è¿‡çš„æ–‡ä»¶(modify time)</span><br><span class="line">ã€€ã€€ã€€ã€€(6)find / -mtime -1 ã€€ã€€#æŸ¥æ‰¾åœ¨ç³»ç»Ÿä¸­æœ€å24å°æ—¶é‡Œä¿®æ”¹è¿‡çš„æ–‡ä»¶</span><br><span class="line">ã€€ã€€ã€€ã€€(7)find / -user fred ã€€ã€€#æŸ¥æ‰¾åœ¨ç³»ç»Ÿä¸­å±äºfredè¿™ä¸ªç”¨æˆ·çš„æ–‡ä»¶</span><br><span class="line">ã€€ã€€ã€€ã€€(8)find / -size +10000cã€€ã€€#æŸ¥æ‰¾å‡ºå¤§äº10000000å­—èŠ‚çš„æ–‡ä»¶(c:å­—èŠ‚ï¼Œw:åŒå­—ï¼Œk:KBï¼ŒM:MBï¼ŒG:GB)</span><br><span class="line">ã€€ã€€ã€€ã€€(9)find / -size -1000k ã€€ã€€#æŸ¥æ‰¾å‡ºå°äº1000KBçš„æ–‡ä»¶</span><br><span class="line"></span><br><span class="line">ã€€ã€€ã€€ã€€3.ä½¿ç”¨æ··åˆæŸ¥æ‰¾æ–¹å¼æŸ¥æ‰¾æ–‡ä»¶</span><br><span class="line"></span><br><span class="line">ã€€ã€€ã€€ã€€å‚æ•°æœ‰ï¼š ï¼ï¼Œ-and(-a)ï¼Œ-or(-o)ã€‚</span><br><span class="line"></span><br><span class="line">ã€€ã€€ã€€ã€€(1)find /tmp -size +10000c -and -mtime +2 ã€€ã€€#åœ¨/tmpç›®å½•ä¸‹æŸ¥æ‰¾å¤§äº10000å­—èŠ‚å¹¶åœ¨æœ€å2åˆ†é’Ÿå†…ä¿®æ”¹çš„æ–‡ä»¶</span><br><span class="line">   ã€€ã€€    (2)find / -user fred -or -user george ã€€ã€€#åœ¨/ç›®å½•ä¸‹æŸ¥æ‰¾ç”¨æˆ·æ˜¯fredæˆ–è€…georgeçš„æ–‡ä»¶æ–‡ä»¶</span><br><span class="line">   ã€€ã€€    (3)find /tmp ! -user pandaã€€ã€€#åœ¨/tmpç›®å½•ä¸­æŸ¥æ‰¾æ‰€æœ‰ä¸å±äºpandaç”¨æˆ·çš„æ–‡ä»¶</span><br><span class="line">    ã€€ã€€  </span><br><span class="line"></span><br><span class="line">ã€€ã€€äºŒã€grepå‘½ä»¤</span><br><span class="line"></span><br><span class="line">ã€€ã€€ã€€  åŸºæœ¬æ ¼å¼ï¼šfind  expression</span><br><span class="line"></span><br><span class="line"> ã€€ã€€ã€€ 1.ä¸»è¦å‚æ•°</span><br><span class="line"></span><br><span class="line">ã€€ã€€ã€€ã€€[options]ä¸»è¦å‚æ•°ï¼š</span><br><span class="line">ã€€ã€€ã€€ã€€ï¼cï¼šåªè¾“å‡ºåŒ¹é…è¡Œçš„è®¡æ•°ã€‚</span><br><span class="line">ã€€ã€€ã€€ã€€ï¼iï¼šä¸åŒºåˆ†å¤§å°å†™</span><br><span class="line">ã€€ã€€ã€€ã€€ï¼hï¼šæŸ¥è¯¢å¤šæ–‡ä»¶æ—¶ä¸æ˜¾ç¤ºæ–‡ä»¶åã€‚</span><br><span class="line">ã€€ã€€ã€€ã€€ï¼lï¼šæŸ¥è¯¢å¤šæ–‡ä»¶æ—¶åªè¾“å‡ºåŒ…å«åŒ¹é…å­—ç¬¦çš„æ–‡ä»¶åã€‚</span><br><span class="line">ã€€ã€€ã€€ã€€ï¼nï¼šæ˜¾ç¤ºåŒ¹é…è¡ŒåŠè¡Œå·ã€‚</span><br><span class="line">ã€€ã€€ã€€ã€€ï¼sï¼šä¸æ˜¾ç¤ºä¸å­˜åœ¨æˆ–æ— åŒ¹é…æ–‡æœ¬çš„é”™è¯¯ä¿¡æ¯ã€‚</span><br><span class="line">ã€€ã€€ã€€ã€€ï¼vï¼šæ˜¾ç¤ºä¸åŒ…å«åŒ¹é…æ–‡æœ¬çš„æ‰€æœ‰è¡Œã€‚</span><br><span class="line"></span><br><span class="line">ã€€ã€€ã€€ã€€patternæ­£åˆ™è¡¨è¾¾å¼ä¸»è¦å‚æ•°ï¼š</span><br><span class="line">ã€€ã€€ã€€ã€€\ï¼š å¿½ç•¥æ­£åˆ™è¡¨è¾¾å¼ä¸­ç‰¹æ®Šå­—ç¬¦çš„åŸæœ‰å«ä¹‰ã€‚</span><br><span class="line">ã€€ã€€ã€€ã€€^ï¼šåŒ¹é…æ­£åˆ™è¡¨è¾¾å¼çš„å¼€å§‹è¡Œã€‚</span><br><span class="line">ã€€ã€€ã€€ã€€$: åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼çš„ç»“æŸè¡Œã€‚</span><br><span class="line">ã€€ã€€ã€€ã€€\&lt;ï¼šä»åŒ¹é…æ­£åˆ™è¡¨è¾¾ å¼çš„è¡Œå¼€å§‹ã€‚</span><br><span class="line">ã€€ã€€ã€€ã€€\&gt;ï¼šåˆ°åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼çš„è¡Œç»“æŸã€‚</span><br><span class="line">ã€€ã€€ã€€ã€€[ ]ï¼šå•ä¸ªå­—ç¬¦ï¼Œå¦‚[A]å³Aç¬¦åˆè¦æ±‚ ã€‚</span><br><span class="line">ã€€ã€€ã€€ã€€[ - ]ï¼šèŒƒå›´ï¼Œå¦‚[A-Z]ï¼Œå³Aã€Bã€Cä¸€ç›´åˆ°Zéƒ½ç¬¦åˆè¦æ±‚ ã€‚</span><br><span class="line">ã€€ã€€ã€€ã€€.ï¼šæ‰€æœ‰çš„å•ä¸ªå­—ç¬¦ã€‚</span><br><span class="line"></span><br><span class="line">   * ï¼šæœ‰å­—ç¬¦ï¼Œé•¿åº¦å¯ä»¥ä¸º0ã€‚</span><br><span class="line"></span><br><span class="line">ã€€ã€€ã€€ã€€2.å®ä¾‹ã€€ </span><br><span class="line"></span><br><span class="line">ã€€ã€€(1)grep &apos;test&apos; d*ã€€ã€€#æ˜¾ç¤ºæ‰€æœ‰ä»¥då¼€å¤´çš„æ–‡ä»¶ä¸­åŒ…å« testçš„è¡Œ</span><br><span class="line">ã€€ã€€(2)grep â€˜testâ€™ aa bb cc ã€€ã€€ #æ˜¾ç¤ºåœ¨aaï¼Œbbï¼Œccæ–‡ä»¶ä¸­åŒ…å«testçš„è¡Œ</span><br><span class="line">ã€€ã€€(3)grep â€˜[a-z]\&#123;5\&#125;â€™ aa ã€€ã€€#æ˜¾ç¤ºæ‰€æœ‰åŒ…å«æ¯è¡Œå­—ç¬¦ä¸²è‡³å°‘æœ‰5ä¸ªè¿ç»­å°å†™å­—ç¬¦çš„å­—ç¬¦ä¸²çš„è¡Œ</span><br><span class="line">ã€€ã€€(4)grep magic /usr/srcã€€ã€€#æ˜¾ç¤º/usr/srcç›®å½•ä¸‹çš„æ–‡ä»¶(ä¸å«å­ç›®å½•)åŒ…å«magicçš„è¡Œ</span><br><span class="line">ã€€ã€€(5)grep -r magic /usr/srcã€€ã€€#æ˜¾ç¤º/usr/srcç›®å½•ä¸‹çš„æ–‡ä»¶(åŒ…å«å­ç›®å½•)åŒ…å«magicçš„è¡Œ</span><br><span class="line"></span><br><span class="line">ã€€ã€€(6)grep -w pattern files ï¼šåªåŒ¹é…æ•´ä¸ªå•è¯ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸²çš„ä¸€éƒ¨åˆ†(å¦‚åŒ¹é…â€™magicâ€™ï¼Œè€Œä¸æ˜¯â€™magicalâ€™)ï¼Œ</span><br><span class="line"></span><br><span class="line">å¦‚æœä½ æƒ³åœ¨å½“å‰ç›®å½•ä¸‹ æŸ¥æ‰¾&quot;hello,world!&quot;å­—ç¬¦ä¸²,å¯ä»¥è¿™æ ·:</span><br><span class="line"></span><br><span class="line">grep -rn &quot;hello,world!&quot; *</span><br><span class="line"></span><br><span class="line">* : è¡¨ç¤ºå½“å‰ç›®å½•æ‰€æœ‰æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯æŸä¸ªæ–‡ä»¶å</span><br><span class="line"></span><br><span class="line">-r æ˜¯é€’å½’æŸ¥æ‰¾ï¼ˆå¦‚æœä¸åŠ -rè¡¨ç¤ºåªæŸ¥æ‰¾å½“å‰ç›®å½•ï¼Œä¸ä¼šé€’å½’çš„æŸ¥æ‰¾å­ç›®å½•ï¼‰</span><br><span class="line"></span><br><span class="line">-n æ˜¯æ˜¾ç¤ºè¡Œå·</span><br><span class="line"></span><br><span class="line">-R æŸ¥æ‰¾æ‰€æœ‰æ–‡ä»¶åŒ…å«å­ç›®å½•</span><br><span class="line"></span><br><span class="line">-i å¿½ç•¥å¤§å°å†™</span><br><span class="line"></span><br><span class="line">ä¸‹é¢æ˜¯ä¸€äº›æœ‰æ„æ€çš„å‘½ä»¤è¡Œå‚æ•°ï¼š</span><br><span class="line"></span><br><span class="line">grep -i pattern files ï¼šä¸åŒºåˆ†å¤§å°å†™åœ°æœç´¢ã€‚é»˜è®¤æƒ…å†µåŒºåˆ†å¤§å°å†™ï¼Œ </span><br><span class="line"></span><br><span class="line">grep -l pattern files ï¼šåªåˆ—å‡ºåŒ¹é…çš„æ–‡ä»¶åï¼Œ </span><br><span class="line"></span><br><span class="line">grep -L pattern files ï¼šåˆ—å‡ºä¸åŒ¹é…çš„æ–‡ä»¶åï¼Œ </span><br><span class="line"></span><br><span class="line">grep -w pattern files ï¼šåªåŒ¹é…æ•´ä¸ªå•è¯ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸²çš„ä¸€éƒ¨åˆ†ï¼ˆå¦‚åŒ¹é…â€˜magicâ€™ï¼Œè€Œä¸æ˜¯â€˜magicalâ€™ï¼‰ï¼Œ </span><br><span class="line"></span><br><span class="line">grep -C number pattern files ï¼šåŒ¹é…çš„ä¸Šä¸‹æ–‡åˆ†åˆ«æ˜¾ç¤º[number]è¡Œï¼Œ </span><br><span class="line"></span><br><span class="line">grep pattern1 | pattern2 files ï¼šæ˜¾ç¤ºåŒ¹é… pattern1 æˆ– pattern2 çš„è¡Œï¼Œ </span><br><span class="line"></span><br><span class="line">grep pattern1 files | grep pattern2 ï¼šæ˜¾ç¤ºæ—¢åŒ¹é… pattern1 åˆåŒ¹é… pattern2 çš„è¡Œã€‚</span><br></pre></td></tr></table></figure><h4 id="æŸ¥çœ‹åº”ç”¨æ‰€å å†…å­˜"><a href="#æŸ¥çœ‹åº”ç”¨æ‰€å å†…å­˜" class="headerlink" title="æŸ¥çœ‹åº”ç”¨æ‰€å å†…å­˜"></a>æŸ¥çœ‹åº”ç”¨æ‰€å å†…å­˜</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# ps -u postgres o pid,rss:8,cmd | awk &apos;NR&gt;1 &#123;A+=$2&#125; &#123;print&#125; END&#123;print &quot;Total RSS: &quot; A&#125;&apos;</span><br><span class="line">  PID      RSS CMD</span><br><span class="line"> 3314    47100 /usr/pgsql-12/bin/postmaster -D /home/pgsql12/data/</span><br><span class="line"> 3318      544 postgres: logger   </span><br><span class="line"> 3320    76952 postgres: checkpointer   </span><br><span class="line"> 3321    57716 postgres: background writer   </span><br><span class="line"> 3322    16980 postgres: walwriter   </span><br><span class="line"> 3323     1664 postgres: autovacuum launcher   </span><br><span class="line"> 3324     1248 postgres: stats collector   </span><br><span class="line"> 3325      920 postgres: logical replication launcher   </span><br><span class="line">34905    23572 postgres: dbuser qiyewechat 192.168.138.1(59622) idle</span><br><span class="line">39446     9936 postgres: dbuser qiyewechat 192.168.138.1(49408) idle</span><br><span class="line">39449    16132 postgres: dbuser qiyewechat 192.168.138.1(49412) idle</span><br><span class="line">42193    32336 postgres: dbuser ymall_test 192.168.138.1(52546) idle</span><br><span class="line">42194    15376 postgres: dbuser ymall_test 192.168.138.1(52547) idle</span><br><span class="line">42996     4492 postgres: dbuser ymall_test 192.168.138.1(54459) idle</span><br><span class="line">43002     8260 postgres: dbuser ymall 192.168.138.1(54498) idle</span><br><span class="line">43489     6604 postgres: dbuser ymall 192.168.138.1(55454) idle</span><br><span class="line">43490     6612 postgres: dbuser ymall 192.168.138.1(55461) idle</span><br><span class="line">43885     4496 postgres: dbuser ymall 192.168.138.1(56158) idle</span><br><span class="line">43886     4496 postgres: dbuser ymall 192.168.138.1(56160) idle</span><br><span class="line">43887    18624 postgres: dbuser ymall 192.168.138.1(56163) idle</span><br><span class="line">43888    25448 postgres: dbuser ymall 192.168.138.1(56165) idle</span><br><span class="line">43889    26704 postgres: dbuser ymall 192.168.138.1(56167) idle</span><br><span class="line">44302    10696 postgres: dbuser qiyewechat 192.168.138.1(57075) idle</span><br><span class="line">44369    14456 postgres: dbuser qiyewechat 192.168.138.1(57083) idle</span><br><span class="line">44370     6028 postgres: dbuser qiyewechat 192.168.138.1(57084) idle</span><br><span class="line">44478     4496 postgres: dbuser ymall_test 192.168.138.1(57323) idle</span><br><span class="line">45814     8460 postgres: dbuser qiyewechat 192.168.138.1(59407) idle</span><br><span class="line">45900    13064 postgres: dbuser qiyewechat 192.168.138.1(59474) idle</span><br><span class="line">45907     5776 postgres: dbuser qiyewechat 192.168.138.1(59514) idle</span><br><span class="line">45992     6344 postgres: dbuser ymall_test 192.168.138.1(59703) idle</span><br><span class="line">46565    17660 postgres: dbuser ymall 192.168.138.1(60717) idle</span><br><span class="line">46573    14536 postgres: dbuser ymall 192.168.138.1(60758) idle</span><br><span class="line">46574     6048 postgres: dbuser ymall 192.168.138.1(60759) idle</span><br><span class="line">47215     4504 postgres: dbuser ymall_test 192.168.138.1(61764) idle</span><br><span class="line">47879     9428 postgres: dbuser ymall_test 192.168.138.1(63113) idle</span><br><span class="line">47880    15380 postgres: dbuser ymall_test 192.168.138.1(63114) idle</span><br><span class="line">48631     4496 postgres: dbuser ymall_test 192.168.138.1(64278) idle</span><br><span class="line">49247     6076 postgres: dbuser postgres 192.168.138.1(65312) idle</span><br><span class="line">49890    18168 postgres: dbuser ymall 192.168.138.1(50169) idle</span><br><span class="line">49893    14576 postgres: dbuser ymall 192.168.138.1(50175) idle</span><br><span class="line">49894     5816 postgres: dbuser ymall 192.168.138.1(50176) idle</span><br><span class="line">50162     4492 postgres: dbuser ymall_test 192.168.138.1(50486) idle</span><br><span class="line">50710    10560 postgres: dbuser ymall 192.168.138.1(51809) idle</span><br><span class="line">50711    14512 postgres: dbuser ymall 192.168.138.1(51810) idle</span><br><span class="line">50717    14816 postgres: dbuser ymall 192.168.138.1(51826) idle</span><br><span class="line">50718     7660 postgres: dbuser ymall 192.168.138.1(51827) idle</span><br><span class="line">50719     5824 postgres: dbuser postgres 192.168.138.1(51828) idle</span><br><span class="line">50723     6064 postgres: dbuser ymall 192.168.138.1(51833) idle</span><br><span class="line">51657     4500 postgres: dbuser ymall_test 192.168.138.1(53646) idle</span><br><span class="line">53083     4504 postgres: dbuser ymall_test 192.168.138.1(56425) idle</span><br><span class="line">53091     8468 postgres: dbuser ymall 192.168.138.1(56449) idle</span><br><span class="line">53092    14500 postgres: dbuser ymall 192.168.138.1(56450) idle</span><br><span class="line">53093     6048 postgres: dbuser ymall 192.168.138.1(56451) idle</span><br><span class="line">62156     4228 postgres: dbuser ymall 192.168.138.1(57632) idle</span><br><span class="line">Total RSS: 698396</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@prod-ghospital ~]#  ps -u mysql o pid,rss:8,cmd | awk &apos;NR&gt;1 &#123;A+=$2&#125; &#123;print&#125; END&#123;print &quot;Total RSS: &quot; A&#125;&apos;</span><br><span class="line">  PID      RSS CMD</span><br><span class="line"> 3057  1496720 /usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid</span><br><span class="line">Total RSS: 1496720</span><br></pre></td></tr></table></figure><h4 id="æ£€æµ‹é¡µé¢çš„çŠ¶æ€ç æŸ¥çœ‹é¡¹ç›®å­˜æ´»"><a href="#æ£€æµ‹é¡µé¢çš„çŠ¶æ€ç æŸ¥çœ‹é¡¹ç›®å­˜æ´»" class="headerlink" title="æ£€æµ‹é¡µé¢çš„çŠ¶æ€ç æŸ¥çœ‹é¡¹ç›®å­˜æ´»"></a>æ£€æµ‹é¡µé¢çš„çŠ¶æ€ç æŸ¥çœ‹é¡¹ç›®å­˜æ´»</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@lepeng ~]# cat url.txt </span><br><span class="line">http://localhost:9980/front/test/aaaa2</span><br><span class="line"></span><br><span class="line">[root@lepeng ~]# cat checkurl.sh </span><br><span class="line">fileurl=&apos;/root/url.txt&apos;</span><br><span class="line">for chkurl in $(cat $&#123;fileurl&#125;)  # $&#123;&#125;å¿½ç•¥ç©ºæ ¼</span><br><span class="line">do</span><br><span class="line">    # -o è¾“å‡ºå†…å®¹åˆ°/dev/null; -s é™é»˜æ–¹å¼ ï¼›-w å®šä¹‰æ˜¾ç¤ºè¾“å‡ºæ ¼å¼ï¼›&quot;%&#123;http_code&#125;&quot; åœ¨æœ€åè¢«æ£€ç´¢çš„ HTTP(S) é¡µä¸­è¢«æ‰¾åˆ°çš„æ•°å­—çš„ä»£ç </span><br><span class="line">    HTTP_CODE=`curl -o /dev/null -s --head -w &quot;%&#123;http_code&#125;&quot; &quot;$&#123;chkurl&#125;&quot;`</span><br><span class="line">    if [ $&#123;HTTP_CODE&#125; -ne 200 ]</span><br><span class="line">    then</span><br><span class="line">        port=9980</span><br><span class="line">        echo `date &quot;+%Y-%m-%d %H:%M:%S&quot;` é¡¹ç›®æ­£åœ¨é‡å¯.....  &gt;&gt;check-result.txt</span><br><span class="line">        #æ ¹æ®ç«¯å£å·æŸ¥è¯¢å¯¹åº”çš„pid</span><br><span class="line">        pid=$(netstat -nlp | grep :$port | awk &apos;&#123;print $7&#125;&apos; | awk -F&quot;/&quot; &apos;&#123; print $1 &#125;&apos;);</span><br><span class="line"></span><br><span class="line">        #æ€æ‰å¯¹åº”çš„è¿›ç¨‹ï¼Œå¦‚æœpidä¸å­˜åœ¨ï¼Œåˆ™ä¸æ‰§è¡Œ</span><br><span class="line">        if [  -n  &quot;$pid&quot;  ];  then</span><br><span class="line">                kill  -9  $pid;</span><br><span class="line">        fi</span><br><span class="line">        cd /home/tomcat/lepeng_tomcat/tomcat-8.0.46-9980/bin/</span><br><span class="line">        ./startup.sh</span><br><span class="line">    else</span><br><span class="line">        echo -e  `date &quot;+%Y-%m-%d %H:%M:%S&quot;` å½“å‰çŠ¶æ€ç ä¸º$&#123;HTTP_CODE&#125;: $chkurl  &gt;&gt;check-result.txt</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p>åŠ å…¥å®šæ—¶ä»»åŠ¡</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">*/5 * * * * sh /root/checkurl.sh</span><br><span class="line">#æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡æ£€æµ‹è„šæœ¬</span><br><span class="line">#ä¾‹å¦‚é¡¹ç›®è¦3åˆ†é’Ÿ,å®šæ—¶ä»»åŠ¡è¦å¤§äº3åˆ†é’Ÿ,å¦åˆ™ä¼šä¸€ç›´é‡å¯</span><br></pre></td></tr></table></figure><h4 id="æœåŠ¡ä¸€ç›´killä¸æ‰"><a href="#æœåŠ¡ä¸€ç›´killä¸æ‰" class="headerlink" title="æœåŠ¡ä¸€ç›´killä¸æ‰"></a>æœåŠ¡ä¸€ç›´killä¸æ‰</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@prodl bin]# ps -ef|grep runsv</span><br><span class="line">root      7808     1  0 21:11 ?        00:00:00 runsvdir -P /opt/gitlab/service log: vlogd: warning: unable to lock directory: /var/log/gitlab/grafana: temporary failure svlogd: fatal: no functional log directories. svlogd: warning: unable to lock directory: /var/log/gitlab/grafana: temporary failure svlogd: fatal: no functional log directories. svlogd: warning: unable to lock directory: /var/log/gitlab/grafana: temporary failure svlogd: fatal: no functional log directories. </span><br><span class="line">root      7811  7808  0 21:11 ?        00:00:00 runsv gitaly</span><br><span class="line">root      7812  7808  0 21:11 ?        00:00:00 runsv alertmanager</span><br><span class="line">root      7813  7808  0 21:11 ?        00:00:00 runsv sidekiq</span><br><span class="line">root      7814  7808  0 21:11 ?        00:00:00 runsv postgresql</span><br><span class="line">root      7815  7808  0 21:11 ?        00:00:00 runsv unicorn</span><br><span class="line">root      7816  7808  0 21:11 ?        00:00:00 runsv prometheus</span><br><span class="line">root      7818  7808  0 21:11 ?        00:00:00 runsv postgres-exporter</span><br><span class="line">root      7819  7808  0 21:11 ?        00:00:00 runsv logrotate</span><br><span class="line">root      7820  7808  0 21:11 ?        00:00:00 runsv node-exporter</span><br><span class="line">root      7821  7808  0 21:11 ?        00:00:00 runsv gitlab-exporter</span><br><span class="line">root      7822  7808  0 21:11 ?        00:00:00 runsv gitlab-workhorse</span><br><span class="line">root      8329  7808  0 21:23 ?        00:00:00 runsv grafana</span><br></pre></td></tr></table></figure><p>runsvdir -P /opt/gitlab/service logä¸ºä¸»è¿›ç¨‹</p><p>è¿™æ˜¯ä¸€ä¸ªrunit serviceï¼Œkill -9 æ— æ³•æ€æ­»ã€‚ã€runsvdir è¿›ç¨‹æ€æ­»ååˆé‡æ–°åˆ›å»ºï¼ˆæ€ä¸æ­»ï¼‰ã€‘</p><p>åæ¥æŸ¥çœ‹äº†å®˜æ–¹æ–‡æ¡£ä¸­çš„è¯´æ˜åï¼Œ ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@prod-ghospital bin]# systemctl stop gitlab-runsvdir</span><br><span class="line">[root@prod-ghospital bin]# ps -ef|grep runsv</span><br><span class="line">root     12453  6424  0 21:36 pts/0    00:00:00 grep --color=auto runsv</span><br><span class="line">[root@prod-ghospital bin]# netstat -lntp</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class="line">tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      4904/sendmail: acce </span><br><span class="line">tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      2081/nginx: master  </span><br><span class="line">tcp        0      0 127.0.0.1:20037         0.0.0.0:*               LISTEN      2534/java           </span><br><span class="line">tcp        0      0 0.0.0.0:6379            0.0.0.0:*               LISTEN      1350/redis-server * </span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      2081/nginx: master  </span><br><span class="line">tcp        0      0 0.0.0.0:8081            0.0.0.0:*               LISTEN      2534/java           </span><br><span class="line">tcp        0      0 0.0.0.0:81              0.0.0.0:*               LISTEN      2081/nginx: master  </span><br><span class="line">tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      2978/sshd           </span><br><span class="line">tcp6       0      0 127.0.0.1:9600          :::*                    LISTEN      18615/java          </span><br><span class="line">tcp6       0      0 :::9000                 :::*                    LISTEN      19159/java          </span><br><span class="line">tcp6       0      0 :::3306                 :::*                    LISTEN      2970/mysqld         </span><br><span class="line">tcp6       0      0 :::6379                 :::*                    LISTEN      1350/redis-server * </span><br><span class="line">tcp6       0      0 :::9200                 :::*                    LISTEN      20071/java          </span><br><span class="line">tcp6       0      0 :::80                   :::*                    LISTEN      2081/nginx: master  </span><br><span class="line">tcp6       0      0 :::9300                 :::*                    LISTEN      19159/java          </span><br><span class="line">tcp6       0      0 :::9302                 :::*                    LISTEN      20071/java</span><br></pre></td></tr></table></figure><p>ç³»ç»Ÿè´Ÿè½½å¤§äºç­‰äº4å¹¶ä¸”cpu&gt;200% é‡å¯ç¨‹åº</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">#è·å–5åˆ†é’Ÿç³»ç»Ÿè´Ÿè½½</span><br><span class="line">sys_load=`/bin/cat /proc/loadavg | awk &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">#è·å–potè¿›ç¨‹pid</span><br><span class="line">pot=$(netstat -nlp | grep 10010 | awk &apos;&#123;print $7&#125;&apos; | awk -F&quot;/&quot; &apos;&#123; print $1 &#125;&apos;);</span><br><span class="line">#è·å–shopè¿›ç¨‹pid</span><br><span class="line">shop=$(netstat -nlp | grep 9980 | awk &apos;&#123;print $7&#125;&apos; | awk -F&quot;/&quot; &apos;&#123; print $1 &#125;&apos;);</span><br><span class="line"></span><br><span class="line">#å¦‚æœç³»ç»Ÿè´Ÿè½½å¤§äºç­‰äº4å¹¶ä¸”cpu&gt;200%æ€æ‰è¯¥è¿›ç¨‹</span><br><span class="line">if [ &quot;$sys_load&quot; &gt; &quot;4&quot; ] || [ &quot;$sys_load&quot; = &quot;4&quot; ]; then</span><br><span class="line"></span><br><span class="line">ps axf -o &quot;pid %cpu&quot; | awk &apos;&#123;if($2&gt;=200.0) print $1&#125;&apos; | while read procid</span><br><span class="line">do</span><br><span class="line">kill -9 $procid</span><br><span class="line">echo ç³»ç»Ÿè´Ÿè½½+$sys_load &gt;&gt; /home/output.txt</span><br><span class="line">echo cpué«˜çš„è¿›ç¨‹+ $procid &gt;&gt; /home/output.txt</span><br><span class="line">echo `date`+&quot;æ€æ‰cpué«˜çš„è¿›ç¨‹&quot; &gt;&gt; /home/output.txt</span><br><span class="line"></span><br><span class="line">#å¦‚æœpotè¿›ç¨‹ä¸åœ¨ é‡å¯pot</span><br><span class="line">if [ &quot;$pot&quot; = &quot;&quot;  ];  then</span><br><span class="line">echo potè¿›ç¨‹+$pot &gt;&gt; /home/output.txt</span><br><span class="line">cd /home/tomcat/lepeng_tomcat/tomcat-8.0.46-10010/bin/</span><br><span class="line">./startup.sh</span><br><span class="line">echo `date`+&quot;poté‡å¯&quot; &gt;&gt; /home/output.txt</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">#å¦‚æœshopè¿›ç¨‹ä¸åœ¨ é‡å¯shop</span><br><span class="line">if [ &quot;$shop&quot; = &quot;&quot;  ];  then</span><br><span class="line">echo shopè¿›ç¨‹+$shop &gt;&gt; /home/output.txt</span><br><span class="line">cd /home/tomcat/lepeng_tomcat/tomcat-8.0.46-9980/bin/</span><br><span class="line">./startup.sh</span><br><span class="line">echo `date`+&quot;shopé‡å¯&quot; &gt;&gt; /home/output.txt</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h4 id="sshç™»é™†å³è¿›è¡Œå‘Šè­¦é€šçŸ¥"><a href="#sshç™»é™†å³è¿›è¡Œå‘Šè­¦é€šçŸ¥" class="headerlink" title="sshç™»é™†å³è¿›è¡Œå‘Šè­¦é€šçŸ¥"></a>sshç™»é™†å³è¿›è¡Œå‘Šè­¦é€šçŸ¥</h4><p>ç¼–å†™ç›¸å…³è„šæœ¬å†…å®¹å¦‚ä¸‹:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#msg=&apos;ç›‘æ§æœåŠ¡å™¨ç™»å½•ç”¨æˆ·:\nä¸»æœºå: &apos;`hostname`&apos;\nç›‘æ§ä¸»æœºIP: &apos;`ifconfig eth0|awk -F &apos;[ :]+&apos; &apos;NR==2 &#123;print $3&#125;&apos;`&apos;\nç›‘æ§ç™»å½•ç”¨æˆ·: &apos;`whoami`&apos;\nç›‘æ§ç™»å½•IP: &apos;`who am i |awk -F &apos;[()]&apos; &apos;&#123;print $2&#125;&apos;`&apos;\nç›‘æ§ç™»å½•æ—¶é—´: &apos;`date &apos;+%Y-%m-%d-%H:%M:%S&apos;`&apos;&apos;</span><br><span class="line">#è·å–ç›¸å…³ç™»é™†ä¿¡æ¯</span><br><span class="line">name=`hostname`</span><br><span class="line">ip=`ifconfig eth0|awk -F &apos;[ :]+&apos; &apos;NR==2 &#123;print $3&#125;&apos;`</span><br><span class="line">user=`whoami`</span><br><span class="line">_ip=`who am i |awk -F &apos;[()]&apos; &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">_time=`date &apos;+%Y-%m-%d-%H:%M:%S&apos;`</span><br><span class="line">#æŸ¥è¯¢ç™»é™†åœ°å€å¹¶è¿”å›ç›¸åº”ä¿¡æ¯</span><br><span class="line">addr=`curl -q -s http://freeapi.ipip.net/$_ip | awk -F &apos;&quot;&apos; &apos;&#123;print $2&quot;-&quot;$4&quot;-&quot;$6&#125;&apos;`</span><br><span class="line">#è‡ªå®šä¹‰æ¥å…¥é’‰é’‰å‡½æ•°</span><br><span class="line">function SendMessageToDingding()&#123;</span><br><span class="line">    #é’‰é’‰åœ°å€</span><br><span class="line">        url=&quot;https://oapi.dingtalk.com/robot/send?access_token=11030e780f87aee0e5849dc488072940405c03aefa66341cde7e3a3d09916583&quot;</span><br><span class="line">    #æ¨é€åˆ°é’‰é’‰</span><br><span class="line">        res=`curl -XPOST -s -L -H &quot;Content-Type:application/json&quot; -H &quot;charset:utf-8&quot; $url -d &quot;</span><br><span class="line">        &#123;</span><br><span class="line">        \&quot;msgtype\&quot;: \&quot;text\&quot;, </span><br><span class="line">        \&quot;text\&quot;: &#123;</span><br><span class="line">                 \&quot;content\&quot;: \&quot;ç›‘æ§ä¸»æœºåï¼š$1\nä¸»æœºIP: $2\n ç™»é™†ç”¨æˆ·ï¼š$3\n ç™»é™†IP: $4\nIPå½’å±ï¼š$5\nç™»é™†æ—¶é—´ï¼š$6\&quot;</span><br><span class="line">                 &#125;</span><br><span class="line">    &#125;&quot;`</span><br><span class="line">        echo $res</span><br><span class="line">&#125;</span><br><span class="line">#subject=`echo -e $msg`</span><br><span class="line">body=&quot;ECSç›‘æ§sshç™»é™†&quot;</span><br><span class="line">#SendMessageToDingding $subject $body</span><br><span class="line">#è°ƒç”¨å‡½æ•°</span><br><span class="line">SendMessageToDingding $name $ip $user $_ip $addr $_time $body</span><br></pre></td></tr></table></figure><p>å°†è„šæœ¬æ–‡ä»¶æ”¾ç½®åœ¨ /etc/profile.d/ æ–‡ä»¶ç›®å½•ä¸‹ï¼Œå³å¯å®ç°ç™»é™†æ—¶ï¼Œå‘é€ç›¸å…³å‘Šè­¦è‡³é’‰é’‰</p><p>æ•ˆæœå¦‚ä¸‹ï¼š<br><img src="\image\image-20210325100413140.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;windows&quot;&gt;&lt;a href=&quot;#windows&quot; class=&quot;headerlink&quot; title=&quot;windows&quot;&gt;&lt;/a&gt;windows&lt;/h3&gt;&lt;h4 id=&quot;windowsä¸‹æ€æ‰æŒ‡å®šåº”ç”¨&quot;&gt;&lt;a href=&quot;#windowsä¸‹æ€æ‰æŒ‡å®šåº”ç”¨&quot; cla</summary>
      
    
    
    
    
    <category term="Process" scheme="https://nmk0718.github.io/tag/Process/"/>
    
  </entry>
  
  <entry>
    <title>Loki</title>
    <link href="https://nmk0718.github.io/2020/10/16/Loki/"/>
    <id>https://nmk0718.github.io/2020/10/16/Loki/</id>
    <published>2020-10-16T03:18:00.000Z</published>
    <updated>2024-11-29T06:44:20.734Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Grafanaæ—¥å¿—èšåˆå·¥å…·Lokiæ­å»ºä½¿ç”¨"><a href="#Grafanaæ—¥å¿—èšåˆå·¥å…·Lokiæ­å»ºä½¿ç”¨" class="headerlink" title="Grafanaæ—¥å¿—èšåˆå·¥å…·Lokiæ­å»ºä½¿ç”¨"></a>Grafanaæ—¥å¿—èšåˆå·¥å…·Lokiæ­å»ºä½¿ç”¨</h3><h4 id="ç‰¹ç‚¹"><a href="#ç‰¹ç‚¹" class="headerlink" title="ç‰¹ç‚¹"></a>ç‰¹ç‚¹</h4><p>ä¸å…¶ä»–æ—¥å¿—èšåˆç³»ç»Ÿç›¸æ¯”ï¼Œ Lokiå…·æœ‰ä¸‹é¢çš„ä¸€äº›ç‰¹æ€§ï¼š</p><ul><li>ä¸å¯¹æ—¥å¿—è¿›è¡Œå…¨æ–‡ç´¢å¼•ã€‚é€šè¿‡å­˜å‚¨å‹ç¼©éç»“æ„åŒ–æ—¥å¿—å’Œä»…ç´¢å¼•å…ƒæ•°æ®ï¼ŒLoki æ“ä½œèµ·æ¥ä¼šæ›´ç®€å•ï¼Œæ›´çœæˆæœ¬ã€‚</li><li>é€šè¿‡ä½¿ç”¨ä¸ Prometheus ç›¸åŒçš„æ ‡ç­¾è®°å½•æµå¯¹æ—¥å¿—è¿›è¡Œç´¢å¼•å’Œåˆ†ç»„ï¼Œè¿™ä½¿å¾—æ—¥å¿—çš„æ‰©å±•å’Œæ“ä½œæ•ˆç‡æ›´é«˜ã€‚</li><li>ç‰¹åˆ«é€‚åˆå‚¨å­˜ Kubernetes Pod æ—¥å¿—; è¯¸å¦‚ Pod æ ‡ç­¾ä¹‹ç±»çš„å…ƒæ•°æ®ä¼šè¢«è‡ªåŠ¨åˆ é™¤å’Œç¼–å…¥ç´¢å¼•ã€‚</li><li>å— Grafana åŸç”Ÿæ”¯æŒã€‚</li></ul><h4 id="ç»„æˆ"><a href="#ç»„æˆ" class="headerlink" title="ç»„æˆ"></a>ç»„æˆ</h4><ul><li>lokiæ˜¯ä¸»æœåŠ¡å™¨ï¼Œè´Ÿè´£å­˜å‚¨æ—¥å¿—å’Œå¤„ç†æŸ¥è¯¢ã€‚</li><li>promtailæ˜¯ä»£ç†ï¼Œè´Ÿè´£æ”¶é›†æ—¥å¿—å¹¶å°†å…¶å‘é€ç»™ lokiã€‚</li><li>Grafana ç”¨äº UI å±•ç¤ºã€‚</li></ul><h4 id="Loki"><a href="#Loki" class="headerlink" title="Loki"></a>Loki</h4><h5 id="ä¸‹è½½"><a href="#ä¸‹è½½" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget https://github.com/grafana/loki/releases/download/v1.6.0/loki-linux-amd64.zip</span><br><span class="line">mkdir /usr/local/loki</span><br><span class="line">unzip loki-linux-amd64.zip</span><br><span class="line">mv loki-linux-amd64 loki</span><br><span class="line">mv loki /usr/local/loki</span><br></pre></td></tr></table></figure><h5 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /usr/local/loki</span><br><span class="line">vi loki-local-config.yaml</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">auth_enabled: false</span><br><span class="line"></span><br><span class="line">server:</span><br><span class="line">  http_listen_port: 3100</span><br><span class="line"></span><br><span class="line">ingester:</span><br><span class="line">  lifecycler:</span><br><span class="line">    address: 127.0.0.1</span><br><span class="line">    ring:</span><br><span class="line">      kvstore:</span><br><span class="line">        store: inmemory</span><br><span class="line">      replication_factor: 1</span><br><span class="line">    final_sleep: 0s</span><br><span class="line">  chunk_idle_period: 5m</span><br><span class="line">  chunk_retain_period: 30s</span><br><span class="line">  max_transfer_retries: 1</span><br><span class="line"></span><br><span class="line">schema_config:</span><br><span class="line">  configs:</span><br><span class="line">  - from: 2018-04-15</span><br><span class="line">    store: boltdb</span><br><span class="line">    object_store: filesystem</span><br><span class="line">    schema: v9</span><br><span class="line">    index:</span><br><span class="line">      prefix: index_</span><br><span class="line">      period: 168h</span><br><span class="line"></span><br><span class="line">storage_config:</span><br><span class="line">  boltdb:</span><br><span class="line">    directory: /tmp/loki/index</span><br><span class="line"></span><br><span class="line">  filesystem:</span><br><span class="line">    directory: /tmp/loki/chunks</span><br><span class="line"></span><br><span class="line">limits_config:</span><br><span class="line">  enforce_metric_name: false</span><br><span class="line">  reject_old_samples: true</span><br><span class="line">  reject_old_samples_max_age: 168h</span><br><span class="line"></span><br><span class="line">chunk_store_config:</span><br><span class="line">  max_look_back_period: 0</span><br><span class="line"></span><br><span class="line">table_manager:</span><br><span class="line">  chunk_tables_provisioning:</span><br><span class="line">    inactive_read_throughput: 0</span><br><span class="line">    inactive_write_throughput: 0</span><br><span class="line">    provisioned_read_throughput: 0</span><br><span class="line">    provisioned_write_throughput: 0</span><br><span class="line">  index_tables_provisioning:</span><br><span class="line">    inactive_read_throughput: 0</span><br><span class="line">    inactive_write_throughput: 0</span><br><span class="line">    provisioned_read_throughput: 0</span><br><span class="line">    provisioned_write_throughput: 0</span><br><span class="line">  retention_deletes_enabled: false</span><br><span class="line">  retention_period: 0</span><br></pre></td></tr></table></figure><h5 id="å¯åŠ¨"><a href="#å¯åŠ¨" class="headerlink" title="å¯åŠ¨"></a>å¯åŠ¨</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /usr/local/loki</span><br><span class="line">./loki -config.file=loki-local-config.yaml</span><br></pre></td></tr></table></figure><h5 id="é…ç½®ç³»ç»ŸæœåŠ¡"><a href="#é…ç½®ç³»ç»ŸæœåŠ¡" class="headerlink" title="é…ç½®ç³»ç»ŸæœåŠ¡"></a>é…ç½®ç³»ç»ŸæœåŠ¡</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi /etc/systemd/system/loki.service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=loki</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=network-online.target</span><br><span class="line">[Service]</span><br><span class="line">Restart=on-failure</span><br><span class="line">ExecStart=/usr/local/loki/loki --config.file=/usr/local/loki/loki-local-config.yaml</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>é…ç½®å¥½å‡éœ€è¦æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure><ul><li>ç›¸å…³å¯åŠ¨ï¼Œåœæ­¢å‘½ä»¤</li></ul><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl start loki.service</span><br><span class="line">systemctl status loki.service</span><br><span class="line">systemctl stop loki.service</span><br><span class="line">systemctl restart loki.service</span><br></pre></td></tr></table></figure><h4 id="Promtail"><a href="#Promtail" class="headerlink" title="Promtail"></a>Promtail</h4><h5 id="ä¸‹è½½-1"><a href="#ä¸‹è½½-1" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https://github.com/grafana/loki/releases/download/v1.6.0/promtail-linux-amd64.zip</span><br><span class="line">unzip promtail-linux-amd64.zip</span><br><span class="line">mkdir /usr/local/promtail</span><br><span class="line">mv promtail-linux-amd64 promtail</span><br><span class="line">mv promtail /usr/local/promtail</span><br></pre></td></tr></table></figure><h5 id="é…ç½®-1"><a href="#é…ç½®-1" class="headerlink" title="é…ç½®"></a>é…ç½®</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /usr/local/promtail</span><br><span class="line">vi promtail-local-config.yaml</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server:</span><br><span class="line">  http_listen_port: 9080</span><br><span class="line">  grpc_listen_port: 0</span><br><span class="line"></span><br><span class="line">positions:</span><br><span class="line">  filename: /tmp/positions.yaml</span><br><span class="line"></span><br><span class="line">clients:</span><br><span class="line">  - url: http://localhost:3100/loki/api/v1/push</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">- job_name: system</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets:</span><br><span class="line">      - localhost</span><br><span class="line">    labels:</span><br><span class="line">      job: varlogs</span><br><span class="line">      __path__: /var/log/*</span><br></pre></td></tr></table></figure><h5 id="å¯åŠ¨-1"><a href="#å¯åŠ¨-1" class="headerlink" title="å¯åŠ¨"></a>å¯åŠ¨</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /usr/local/promtail</span><br><span class="line">./promtail -config.file=promtail-local-config.yaml</span><br></pre></td></tr></table></figure><h5 id="é…ç½®ç³»ç»ŸæœåŠ¡-1"><a href="#é…ç½®ç³»ç»ŸæœåŠ¡-1" class="headerlink" title="é…ç½®ç³»ç»ŸæœåŠ¡"></a>é…ç½®ç³»ç»ŸæœåŠ¡</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi /etc/systemd/system/promtail.service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=promtail</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=network-online.target</span><br><span class="line">[Service]</span><br><span class="line">Restart=on-failure</span><br><span class="line">ExecStart=/usr/local/promtail/promtail --config.file=/usr/local/promtail/promtail-local-config.yaml</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>é…ç½®å¥½æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure><ul><li>ç›¸å…³å¯åŠ¨ï¼Œåœæ­¢å‘½ä»¤</li></ul><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl start  promtail.service</span><br><span class="line">systemctl status  promtail.service</span><br><span class="line">systemctl restart  promtail.service</span><br><span class="line">systemctl stop  promtail.service</span><br></pre></td></tr></table></figure><h5 id="Promtailé¡µé¢"><a href="#Promtailé¡µé¢" class="headerlink" title="Promtailé¡µé¢"></a>Promtailé¡µé¢</h5><img src="\image\image-20201013173438546.png"><h4 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a>Grafana</h4><h5 id="ä¸‹è½½-2"><a href="#ä¸‹è½½-2" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https://dl.grafana.com/oss/release/grafana-7.2.0-1.x86_64.rpm</span><br><span class="line">sudo yum install grafana-7.2.0-1.x86_64.rpm</span><br></pre></td></tr></table></figure><h5 id="å¯åŠ¨-2"><a href="#å¯åŠ¨-2" class="headerlink" title="å¯åŠ¨"></a>å¯åŠ¨</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /usr/share/grafana &amp;&amp; grafana-server web</span><br></pre></td></tr></table></figure><p>è®¿é—® <a href="http://localhost:3000" target="_blank" rel="noopener">http://localhost:3000</a> </p><h5 id="é…ç½®-2"><a href="#é…ç½®-2" class="headerlink" title="é…ç½®"></a>é…ç½®</h5><p>æ‰§è¡ŒæˆåŠŸè¿›å…¥åˆ°grafanaç™»å½•é¡µé¢ã€‚</p><p>é»˜è®¤è´¦å·å¯†ç éƒ½æ˜¯admin</p><p>é¦–æ¬¡è¿›å…¥ä¼šæç¤ºä¿®æ”¹å¯†ç ã€‚çœ‹æ¸…æ¥šè¾“å…¥æ¡†ã€‚</p><img src="\image\image-20201013173155583.png"><p> åˆ›å»ºä¸€ä¸ªdata sources</p><img src="\image\image-20201013173306785.png"><p>è¿™é‡Œå¡«å†™çš„æ˜¯lokiçš„é“¾æ¥ï¼Œè¿™ä¸ªé“¾æ¥å¯ä»¥è®¿é—®ï¼Œæ­£å¸¸æ˜¯è¿”å›æ•°æ®ï¼Œä½†æœ‰æ—¶å€™ä¹Ÿå¯èƒ½è¿”å›404ã€‚ç›®å‰æ²¡å‘ç°å½±å“ä½¿ç”¨çš„åœ°æ–¹</p><img src="\image\image-20201013173222709.png"><p> ä¿å­˜æˆåŠŸçš„æç¤ºæ˜¯ä¸¤ä¸ªç»¿è‰²çš„å¼¹çª—success </p><img src="\image\image-20201013173818989.png"><p>ç„¶åç›´æ¥å»æŸ¥çœ‹explore</p><img src="\image\image-20201013174000884.png"><h5 id="LogQL-è¯­æ³•"><a href="#LogQL-è¯­æ³•" class="headerlink" title="LogQL è¯­æ³•"></a>LogQL è¯­æ³•</h5><h5 id="é€‰æ‹©å™¨"><a href="#é€‰æ‹©å™¨" class="headerlink" title="é€‰æ‹©å™¨"></a>é€‰æ‹©å™¨</h5><p>å¯¹äºæŸ¥è¯¢è¡¨è¾¾å¼çš„æ ‡ç­¾éƒ¨åˆ†ï¼Œå°†æ”¾åœ¨{}ä¸­ï¼Œå¤šä¸ªæ ‡ç­¾è¡¨è¾¾å¼ç”¨é€—å·åˆ†éš”ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;app=&quot;mysql&quot;,name=&quot;mysql-backup&quot;&#125;</span><br></pre></td></tr></table></figure><p>æ”¯æŒçš„ç¬¦å·æœ‰ï¼š</p><ul><li>= å®Œå…¨ç›¸åŒã€‚</li><li>!= ä¸å¹³ç­‰ã€‚</li><li>=~ æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ã€‚</li><li>!~ ä¸è¦æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ã€‚</li></ul><h5 id="è¿‡æ»¤è¡¨è¾¾å¼"><a href="#è¿‡æ»¤è¡¨è¾¾å¼" class="headerlink" title="è¿‡æ»¤è¡¨è¾¾å¼"></a>è¿‡æ»¤è¡¨è¾¾å¼</h5><p>ç¼–å†™æ—¥å¿—æµé€‰æ‹©å™¨åï¼Œæ‚¨å¯ä»¥é€šè¿‡ç¼–å†™æœç´¢è¡¨è¾¾å¼è¿›ä¸€æ­¥è¿‡æ»¤ç»“æœã€‚æœç´¢è¡¨è¾¾å¼å¯ä»¥æ–‡æœ¬æˆ–æ­£åˆ™è¡¨è¾¾å¼ã€‚ å¦‚ï¼š</p><ul><li>{job=â€œmysqlâ€} |= â€œerrorâ€</li><li>{name=â€œkafkaâ€} |~ â€œtsdb-ops.*io:2003â€</li><li>{instance=~â€œkafka-[23]â€,name=â€œkafkaâ€} != kafka.server:type=ReplicaManager æ”¯æŒå¤šä¸ªè¿‡æ»¤</li><li>{job=â€œmysqlâ€} |= â€œerrorâ€ != â€œtimeoutâ€ ç›®å‰æ”¯æŒçš„æ“ä½œç¬¦ï¼š</li><li>|= lineåŒ…å«å­—ç¬¦ä¸²ã€‚</li><li>!= lineä¸åŒ…å«å­—ç¬¦ä¸²ã€‚</li><li>|~ lineåŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ã€‚</li><li>!~ lineä¸æ­£åˆ™è¡¨è¾¾å¼ä¸åŒ¹é…ã€‚</li></ul><p>Lokiè¯­æ³•  æŸ¥è¯¢æ˜¯ERRORçš„æ—¥å¿— |=â€ERRORâ€ æŸ¥è¯¢ä¸æ˜¯ERRORçš„æ—¥å¿— !=â€ERRORâ€<br>æŸ¥è¯¢å«æœ‰4187çš„æ—¥å¿— åˆä¸æ˜¯INFOçº§åˆ«çš„æ—¥å¿—<br>{filename=â€/home/app/logs/nHospitalService/app.2020-10-27.0.logâ€}!=â€INFOâ€ |=â€4187â€</p><h5 id="æŸ¥çœ‹æ›´å¤š"><a href="#æŸ¥çœ‹æ›´å¤š" class="headerlink" title="æŸ¥çœ‹æ›´å¤š"></a>æŸ¥çœ‹æ›´å¤š</h5><p>åœ¨æŸ¥è¯¢å‡ºæ¥çš„ç»“æœè¡Œåé¢æœ‰ä¸€ä¸ªshow context ï¼ˆæŸ¥çœ‹ä¸Šä¸‹æ–‡ï¼‰,ç‚¹å‡»è¿™ä¸ªæŒ‰é’®ï¼Œé»˜è®¤å±•ç¤ºç»“æœè¡Œå‰10è¡Œå’Œå10è¡Œã€‚</p><img src="\image\8RI0zT.png"><h4 id="å®é™…åº”ç”¨"><a href="#å®é™…åº”ç”¨" class="headerlink" title="å®é™…åº”ç”¨"></a>å®é™…åº”ç”¨</h4><h5 id="promtailæ‰“å¦‚åŸºç¡€é•œåƒ"><a href="#promtailæ‰“å¦‚åŸºç¡€é•œåƒ" class="headerlink" title="promtailæ‰“å¦‚åŸºç¡€é•œåƒ"></a>promtailæ‰“å¦‚åŸºç¡€é•œåƒ</h5><p>æ‹‰å–åŸºç¡€é•œåƒ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker pull 192.168.229.8:8551/centos:latest</span><br></pre></td></tr></table></figure><p>å¯åŠ¨åŸºç¡€é•œåƒ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker run -d 92926cb8d09b tail -f /dev/null</span><br></pre></td></tr></table></figure><p>å¤åˆ¶æ–‡ä»¶åˆ°åŸºç¡€é•œåƒ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker exec d8dcd4162411  mkdir /usr/local/promtail</span><br><span class="line">docker cp promtail d8dcd4162411:/usr/local/promtail</span><br><span class="line">docker cp promtail-local-config.yaml d8dcd4162411:/usr/local/promtail</span><br></pre></td></tr></table></figure><p>ç»™é•œåƒæ‰“æ ‡è®°</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker commit d8dcd4162411 192.168.229.8:8551/centos:latest</span><br></pre></td></tr></table></figure><p>æ¨é€é•œåƒåˆ°é•œåƒä»“åº“</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker push 192.168.229.8:8551/centos:latest</span><br></pre></td></tr></table></figure><h5 id="æ›´æ”¹å¯åŠ¨æ–‡ä»¶"><a href="#æ›´æ”¹å¯åŠ¨æ–‡ä»¶" class="headerlink" title="æ›´æ”¹å¯åŠ¨æ–‡ä»¶"></a>æ›´æ”¹å¯åŠ¨æ–‡ä»¶</h5><p>é…ç½®promtailå¼€æœºå¯åŠ¨,å¹¶å»ºç«‹æœ¬æœºipçš„ç›®å½•åšæ—¥å¿—åŒºåˆ†</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">cd /usr/local/promtail/</span><br><span class="line">nohup ./promtail -config.file=promtail-local-config.yaml &gt;&gt; /usr/local/promtail.log 2&gt;&amp;1 &amp;</span><br><span class="line">JARFILE=/home/App.jar</span><br><span class="line">ip=`hostname -I`</span><br><span class="line">mkdir -p /var/log/$ip</span><br><span class="line">cd /var/log/$ip</span><br><span class="line"></span><br><span class="line">java -jar -Xms512M -Xmx1024M -Djava.security.egd=file:/dev/./urandom $JARFILE &gt;&gt; app.log &amp;</span><br><span class="line"></span><br><span class="line">tail  -50f app.log</span><br></pre></td></tr></table></figure><h5 id="æŸ¥çœ‹Grafanaä¸­æ˜¯å¦åŒºåˆ†"><a href="#æŸ¥çœ‹Grafanaä¸­æ˜¯å¦åŒºåˆ†" class="headerlink" title="æŸ¥çœ‹Grafanaä¸­æ˜¯å¦åŒºåˆ†"></a>æŸ¥çœ‹Grafanaä¸­æ˜¯å¦åŒºåˆ†</h5><img src="\image\image-20201016111119852.png"><p>æ³¨:Grafanaä¸­ä¸è®ºåŒºé—´å¤§å°,å•æ¬¡æŸ¥è¯¢æ¡æ•°æœ€å¤§ä¸º5000,å»ºè®®é€šè¿‡ç²¾ç¡®æ—¶é—´æŸ¥è¯¢</p><h4 id="é‡‡é›†æ€§èƒ½"><a href="#é‡‡é›†æ€§èƒ½" class="headerlink" title="é‡‡é›†æ€§èƒ½"></a>é‡‡é›†æ€§èƒ½</h4><p>promtailåœ¨å®¹å™¨ä¸­,ä¸€ç§’é’Ÿé‡‡é›†1wè¡Œæ•°æ®æ—¶,cpuä¸º4-10%ä¹‹é—´,å†…å­˜æ— æ˜æ˜¾å˜åŒ–</p><p>lokiæ”¶åˆ°promtailé‡‡é›†çš„æ•°æ®æ—¶é—´å†…,cpuä¸º3%å·¦å³,å†…å­˜æ— æ˜æ˜¾å˜åŒ–</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;Grafanaæ—¥å¿—èšåˆå·¥å…·Lokiæ­å»ºä½¿ç”¨&quot;&gt;&lt;a href=&quot;#Grafanaæ—¥å¿—èšåˆå·¥å…·Lokiæ­å»ºä½¿ç”¨&quot; class=&quot;headerlink&quot; title=&quot;Grafanaæ—¥å¿—èšåˆå·¥å…·Lokiæ­å»ºä½¿ç”¨&quot;&gt;&lt;/a&gt;Grafanaæ—¥å¿—èšåˆå·¥å…·Lokiæ­å»ºä½¿ç”¨&lt;/</summary>
      
    
    
    
    
    <category term="log" scheme="https://nmk0718.github.io/tag/log/"/>
    
  </entry>
  
  <entry>
    <title>Gogs</title>
    <link href="https://nmk0718.github.io/2020/10/13/gogs/"/>
    <id>https://nmk0718.github.io/2020/10/13/gogs/</id>
    <published>2020-10-13T07:30:00.000Z</published>
    <updated>2024-11-29T06:44:30.319Z</updated>
    
    <content type="html"><![CDATA[<h4 id="Gogså®‰è£…"><a href="#Gogså®‰è£…" class="headerlink" title="Gogså®‰è£…"></a>Gogså®‰è£…</h4><h5 id="å®‰è£…docker"><a href="#å®‰è£…docker" class="headerlink" title="å®‰è£…docker"></a>å®‰è£…docker</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install -y docker</span><br></pre></td></tr></table></figure><h5 id="æ‹‰å–gogsé•œåƒ"><a href="#æ‹‰å–gogsé•œåƒ" class="headerlink" title="æ‹‰å–gogsé•œåƒ"></a>æ‹‰å–gogsé•œåƒ</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker pull gogs/gogs:0.11.29</span><br></pre></td></tr></table></figure><h5 id="docker-è¿è¡Œå®¹å™¨"><a href="#docker-è¿è¡Œå®¹å™¨" class="headerlink" title="docker è¿è¡Œå®¹å™¨"></a>docker è¿è¡Œå®¹å™¨</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker run -d --name=gogs -p 8030:3000 -p 8022:22 -v /docker/gogs:/data gogs:0.11.29</span><br><span class="line">#8030å’Œ8022ä¸ºå¤–éƒ¨è®¿é—®ç«¯å£,3000å’Œ22å¯¹åº”å®¹å™¨å†…éƒ¨ç«¯å£</span><br></pre></td></tr></table></figure><h5 id="æŸ¥çœ‹æ˜¯å¦è¿è¡ŒæˆåŠŸ"><a href="#æŸ¥çœ‹æ˜¯å¦è¿è¡ŒæˆåŠŸ" class="headerlink" title="æŸ¥çœ‹æ˜¯å¦è¿è¡ŒæˆåŠŸ"></a>æŸ¥çœ‹æ˜¯å¦è¿è¡ŒæˆåŠŸ</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@public-service ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE                         COMMAND                  CREATED             STATUS              PORTS                                          NAMES</span><br><span class="line">2317dd952a84        docker.io/gogs/gogs:0.11.29   &quot;/app/gogs/docker/...&quot;   4 hours ago         Up 53 minutes       0.0.0.0:8022-&gt;22/tcp, 0.0.0.0:8030-&gt;3000/tcp   gogs</span><br></pre></td></tr></table></figure><p>å®‰è£…å®Œæˆå,è®¿é—®<a href="http://192.168.1.1:8030" target="_blank" rel="noopener">http://192.168.1.1:8030</a></p><p>æ•°æ®åº“è®¾ç½®ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨å†…ç½®çš„ æ•°æ®åº“å³å¯,ä½¿ç”¨å…¶ä»–çš„éœ€è¦è‡ªè¡Œæ­å»ºæ•°æ®åº“ï¼›</p><img src="\image\922993672-889e9757631ec0c2_articlex.png"><p>åº”ç”¨åŸºæœ¬è®¾ç½®ï¼Œä¸»è¦ä¿®æ”¹åŸŸåã€SSHç«¯å£å·å’Œåº”ç”¨URLå³å¯ã€‚</p><img src="\image\3165017497-1e7f737f53650d12_articlex.png">#### Gogsä½¿ç”¨<p>å¤–ç½‘è®¿é—®è·¯å¾„ä¸º:<a href="http://192.168.1.1:8030/" target="_blank" rel="noopener">http://192.168.1.1:8030/</a></p><h5 id="ç™»å½•"><a href="#ç™»å½•" class="headerlink" title="ç™»å½•"></a>ç™»å½•</h5><p>ä½¿ç”¨å„è‡ªçš„åç§°å…¨æ‹¼ç™»å½•,ä¾‹å¦‚(å€ªæ˜å¤,ç”¨æˆ·åä¸ºnimingkun,å¯†ç ä¸ºnimingkun)</p><img src="\image\image-20201013143334338.png"><p>ç™»å½•ä¹‹åç‚¹å‡»å¤´åƒå³ä¾§çš„æŒ‰é’®,è¿›å…¥ç”¨æˆ·è®¾ç½®,ä¿®æ”¹å¯†ç </p><img src="\image\image-20201013143605181.png"><h5 id="æŸ¥çœ‹è´¦æˆ·å¯¹åº”çš„ä»“åº“"><a href="#æŸ¥çœ‹è´¦æˆ·å¯¹åº”çš„ä»“åº“" class="headerlink" title="æŸ¥çœ‹è´¦æˆ·å¯¹åº”çš„ä»“åº“"></a>æŸ¥çœ‹è´¦æˆ·å¯¹åº”çš„ä»“åº“</h5><img src="\image\image-20201013144342105.png"><h5 id="åˆ›å»ºç”¨æˆ·"><a href="#åˆ›å»ºç”¨æˆ·" class="headerlink" title="åˆ›å»ºç”¨æˆ·"></a>åˆ›å»ºç”¨æˆ·</h5><img src="\image\image-20201013145515110.png"><h5 id="ç”¨æˆ·æˆæƒ"><a href="#ç”¨æˆ·æˆæƒ" class="headerlink" title="ç”¨æˆ·æˆæƒ"></a>ç”¨æˆ·æˆæƒ</h5><img src="\image\image-20201013145545961.png"><h5 id="åˆ›å»ºç»„ç»‡"><a href="#åˆ›å»ºç»„ç»‡" class="headerlink" title="åˆ›å»ºç»„ç»‡"></a>åˆ›å»ºç»„ç»‡</h5><p>æ³¨æ„:éœ€è¦æŠŠä»“åº“å»ºç«‹å†ç»„ç»‡ä¸‹</p><img src="\image\image-20201013145623214.png"><h5 id="æŸ¥çœ‹è´¦æˆ·å¯¹åº”çš„ç»„ç»‡"><a href="#æŸ¥çœ‹è´¦æˆ·å¯¹åº”çš„ç»„ç»‡" class="headerlink" title="æŸ¥çœ‹è´¦æˆ·å¯¹åº”çš„ç»„ç»‡"></a>æŸ¥çœ‹è´¦æˆ·å¯¹åº”çš„ç»„ç»‡</h5><img src="\image\image-20201013144427973.png"><h5 id="åˆ›å»ºæ–°çš„ä»“åº“"><a href="#åˆ›å»ºæ–°çš„ä»“åº“" class="headerlink" title="åˆ›å»ºæ–°çš„ä»“åº“"></a>åˆ›å»ºæ–°çš„ä»“åº“</h5><p>æ³¨æ„æ‹¥æœ‰è€…åº”è®¾ç½®ä¸º<strong>ç»„ç»‡å</strong>,ç¦æ­¢è®¾ç½®ä¸ºè‡ªå·±çš„ç”¨æˆ·</p><img src="\image\image-20201013143251028.png"><p>åˆ›å»ºåå¯æ ¹æ®å‘½ä»¤è¿›è¡Œæ‹‰å–æˆ–å·¥å…·æ‹‰å–</p><img src="\image\image-20201013144846374.png"><h5 id="HTTPæ–¹å¼æ‹‰å–"><a href="#HTTPæ–¹å¼æ‹‰å–" class="headerlink" title="HTTPæ–¹å¼æ‹‰å–"></a>HTTPæ–¹å¼æ‹‰å–</h5><p>å¼€å‘éœ€è¦åœ¨æœ¬åœ°é…ç½®</p><p>ç¤ºä¾‹:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git config --global user.name &quot;nimingkun&quot;</span><br><span class="line">git config --global user.email nimingkun@liangjian.com</span><br></pre></td></tr></table></figure><p>é…ç½®åå³å¯æ‹‰å–gitä»£ç </p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@public ~]# git clone http://192.168.1.1:8030/hospWeb/bridge.git</span><br><span class="line">æ­£å…‹éš†åˆ° &apos;bridge&apos;...</span><br><span class="line">Username for &apos;http://192.168.1.1:8030&apos;: nimingkun</span><br><span class="line">Password for &apos;http://nimingkun@192.168.1.1:8030&apos;: </span><br><span class="line">remote: Counting objects: 1966, done.</span><br><span class="line">remote: Compressing objects: 100% (777/777), done.</span><br><span class="line">remote: Total 1966 (delta 1093), reused 1966 (delta 1093)</span><br><span class="line">æ¥æ”¶å¯¹è±¡ä¸­: 100% (1966/1966), 773.85 KiB | 0 bytes/s, done.</span><br><span class="line">å¤„ç† delta ä¸­: 100% (1093/1093), done.</span><br><span class="line">[root@public code]# ls</span><br><span class="line">bridge</span><br></pre></td></tr></table></figure><h5 id="SSHæ–¹å¼æ‹‰å–"><a href="#SSHæ–¹å¼æ‹‰å–" class="headerlink" title="SSHæ–¹å¼æ‹‰å–"></a>SSHæ–¹å¼æ‹‰å–</h5><p>å¼€å‘éœ€è¦åœ¨æœ¬åœ°é…ç½®</p><p>ç¤ºä¾‹:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git config --global user.name &quot;nimingkun&quot;</span><br><span class="line">git config --global user.email nimingkun@liangjian.com</span><br></pre></td></tr></table></figure><p>ç”ŸæˆSSH Key(å¯†é’¥)</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -C &quot;nimingkun@liangjian.com&quot;</span><br></pre></td></tr></table></figure><p>ç¤ºä¾‹:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@public code]# ssh-keygen -t rsa -C &quot;nimingkun@liangjian.com&quot;</span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:G706PSkd8DxM7JS+wDzdrmZbFiZWuCYq/cpZXmr1g1k nimingkun@liangjian.com</span><br><span class="line">The key&apos;s randomart image is:</span><br><span class="line">+---[RSA 2048]----+</span><br><span class="line">|                 |</span><br><span class="line">|           .     |</span><br><span class="line">|         ....    |</span><br><span class="line">|        ..=o     |</span><br><span class="line">|       oS@*.o    |</span><br><span class="line">|     . .=*@+E.   |</span><br><span class="line">|    . o o*o@o    |</span><br><span class="line">|     o =++@o+    |</span><br><span class="line">|      +o==o+ .   |</span><br><span class="line">+----[SHA256]-----+</span><br><span class="line">[root@public code]# ll ~/.ssh/</span><br><span class="line">æ€»ç”¨é‡ 12</span><br><span class="line">-rw-------  1 root root 1679 10æœˆ 13 15:23 id_rsa</span><br><span class="line">-rw-r--r--  1 root root  405 10æœˆ 13 15:23 id_rsa.pub</span><br><span class="line">-rw-r--r--. 1 root root  175 9æœˆ  21 16:32 known_hosts</span><br><span class="line"></span><br><span class="line">Windowsä¼šç”Ÿæˆåœ¨ç”¨æˆ·ç›®å½•çš„.sshä¸‹</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹å…¬é’¥</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@public code]# cat ~/.ssh/id_rsa.pub</span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDGyFIujsLkRzIVmfZJC2W7scE+JXljm54r98Od9LgTSsJosClHd9AmMNENtr1pX1s/yfp1UQVGk+BUJav+PrbboGJqE/PUQgQ3PaYhgl0YoVImLF3XvALJI3SgMTddRy4SOMkdqfzQnZRYY1R6YIpv+JNRY7W4HrbNRqP1x+HwFPP+fD/5tmF+rSKgHdJR6ygMxMf5y16V2FHjmf4s3iPAba10yvE/WW66/KV8s/FOnyjFNMYYS/aBsI73ilvE6sg9zLnZYxLIqMKIaQWak/p9iXTfRkJSI5d3sWx2c4tPyQsFJM895vsp0n+bKU02u/ekvaAZTEzHZ/5AjPK6IX91 nimingkun@liangjian.com</span><br></pre></td></tr></table></figure><p>åœ¨é¡µé¢ä¸­æ·»åŠ å…¬é’¥</p><img src="\image\image-20201013152656686.png"><p>ä½¿ç”¨sshé“¾æ¥è¿›è¡Œå…‹éš†é¡¹ç›®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@public code]# git clone ssh://git@192.168.1.1:8022/hospWeb/video.git</span><br><span class="line">æ­£å…‹éš†åˆ° &apos;video&apos;...</span><br><span class="line">The authenticity of host &apos;[192.168.1.1]:8022 ([192.168.1.1]:8022)&apos; can&apos;t be established.</span><br><span class="line">ECDSA key fingerprint is SHA256:3ZXSjpz9luXRVT9coc+57HwVSmaSdi7pL4pvetgHEpk.</span><br><span class="line">ECDSA key fingerprint is MD5:40:ca:ae:87:91:7b:f2:85:35:a3:7e:61:33:59:ce:95.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added &apos;[192.168.1.1]:8022&apos; (ECDSA) to the list of known hosts.</span><br><span class="line">remote: Counting objects: 428, done.</span><br><span class="line">remote: Compressing objects: 100% (371/371), done.</span><br><span class="line">remote: Total 428 (delta 48), reused 428 (delta 48)</span><br><span class="line">æ¥æ”¶å¯¹è±¡ä¸­: 100% (428/428), 951.64 KiB | 1.36 MiB/s, done.</span><br><span class="line">å¤„ç† delta ä¸­: 100% (48/48), done.</span><br><span class="line">[root@public code]# ls</span><br><span class="line">bridge  video</span><br></pre></td></tr></table></figure><h5 id="æŸ¥çœ‹é¡¹ç›®æäº¤å†å²å’Œåˆ†æ”¯"><a href="#æŸ¥çœ‹é¡¹ç›®æäº¤å†å²å’Œåˆ†æ”¯" class="headerlink" title="æŸ¥çœ‹é¡¹ç›®æäº¤å†å²å’Œåˆ†æ”¯"></a>æŸ¥çœ‹é¡¹ç›®æäº¤å†å²å’Œåˆ†æ”¯</h5><img src="\image\image-20201013145142683.png"><h5 id="æœç´¢ä»“åº“-ç”¨æˆ·-ç»„ç»‡"><a href="#æœç´¢ä»“åº“-ç”¨æˆ·-ç»„ç»‡" class="headerlink" title="æœç´¢ä»“åº“,ç”¨æˆ·.ç»„ç»‡"></a>æœç´¢ä»“åº“,ç”¨æˆ·.ç»„ç»‡</h5><img src="\image\image-20201013144513505.png"><h5 id="è¿ç§»å¤–éƒ¨ä»“åº“"><a href="#è¿ç§»å¤–éƒ¨ä»“åº“" class="headerlink" title="è¿ç§»å¤–éƒ¨ä»“åº“"></a>è¿ç§»å¤–éƒ¨ä»“åº“</h5><p>å¡«å…¥éœ€è¦å…‹éš†çš„åœ°å€å’Œgitç”¨æˆ·åå¯†ç ,å³å¯</p><img src="\image\image-20201013145727136.png"><h5 id="é—®é¢˜ï¼š"><a href="#é—®é¢˜ï¼š" class="headerlink" title="é—®é¢˜ï¼š"></a>é—®é¢˜ï¼š</h5><p>ç›‘å¬æ—¥å¿—ï¼Œæç¤ºæ²¡æœ‰æƒé™<br>mkdir: canâ€™t create directory â€˜/data/git/â€˜: Permission denied<br>æ­¤æ—¶ï¼Œå¯èƒ½æ˜¯SELINUXé˜»æ­¢çš„åŸå› </p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@localhost data]# docker logs --tail 0 -f 712c350adb28cc17b73f0a87548ab97e02f45d0b9bb56c6f6b495de258f01222</span><br><span class="line"></span><br><span class="line">Saving key &quot;/data/ssh/ssh_host_dsa_key&quot; failed: No such file or directory</span><br><span class="line">Saving key &quot;/data/ssh/ssh_host_ecdsa_key&quot; failed: No such file or directory</span><br><span class="line">Saving key &quot;/data/ssh/ssh_host_ed25519_key&quot; failed: No such file or directory</span><br><span class="line">chown: /data/ssh/*: No such file or directory</span><br><span class="line">chmod: /data/ssh: No such file or directory</span><br><span class="line">chmod: /data/ssh/*: No such file or directory</span><br><span class="line">Could not load host key: /data/ssh/ssh_host_rsa_key</span><br><span class="line">Could not load host key: /data/ssh/ssh_host_dsa_key</span><br><span class="line">Could not load host key: /data/ssh/ssh_host_ecdsa_key</span><br><span class="line">Could not load host key: /data/ssh/ssh_host_ed25519_key</span><br><span class="line">sshd: no hostkeys available -- exiting.</span><br><span class="line">mkdir: can&apos;t create directory &apos;/data/git/&apos;: Permission denied</span><br><span class="line">chmod: /data/git/.ssh: No such file or directory</span><br><span class="line">./run: ./setup: line 11: can&apos;t create /data/git/.ssh/environment: nonexistent directory</span><br><span class="line">chmod: /data/git/.ssh/environment: No such file or directory</span><br><span class="line">chown: /data: Permission denied</span><br><span class="line">chown: /data: Permission denied</span><br><span class="line">chown: /data/git/: No such file or directory</span><br><span class="line">chmod: /data: Permission denied</span><br><span class="line">chmod: /data/gogs: No such file or directory</span><br><span class="line">chmod: /data/git/: No such file or directory</span><br><span class="line">2017/12/31 01:19:08 [ WARN] Custom config &apos;/data/gogs/conf/app.ini&apos; not found, ignore this if you&apos;re running first time</span><br><span class="line">2017/12/31 01:19:08 [FATAL] [...g/setting/setting.go:501 NewContext()] Fail to create &apos;/data/git/.ssh&apos;: mkdir /data/git: permission denied</span><br><span class="line">Saving key &quot;/data/ssh/ssh_host_rsa_key&quot; failed: No such file or directory</span><br></pre></td></tr></table></figure><p>å…³é—­SELINUXå³å¯è§£å†³</p><ul><li>ä¸´æ—¶å…³é—­ï¼šsetenforce 0</li><li>æ°¸ä¹…å…³é—­ï¼š vim /etc/selinux/config</li></ul><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># This file controls the state of SELinux on the system.</span><br><span class="line"># SELINUX= can take one of these three values:</span><br><span class="line">#     enforcing - SELinux security policy is enforced.</span><br><span class="line">#     permissive - SELinux prints warnings instead of enforcing.</span><br><span class="line">#     disabled - No SELinux policy is loaded.</span><br><span class="line">#SELINUX=enforcing</span><br><span class="line">SELINUX=disabled</span><br><span class="line"># SELINUXTYPE= can take one of three two values:</span><br><span class="line">#     targeted - Targeted processes are protected,</span><br><span class="line">#     minimum - Modification of targeted policy. Only selected processes are protected.</span><br><span class="line">#     mls - Multi Level Security protection.</span><br><span class="line">SELINUXTYPE=targeted</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;Gogså®‰è£…&quot;&gt;&lt;a href=&quot;#Gogså®‰è£…&quot; class=&quot;headerlink&quot; title=&quot;Gogså®‰è£…&quot;&gt;&lt;/a&gt;Gogså®‰è£…&lt;/h4&gt;&lt;h5 id=&quot;å®‰è£…docker&quot;&gt;&lt;a href=&quot;#å®‰è£…docker&quot; class=&quot;headerlink&quot; </summary>
      
    
    
    
    
    <category term="gogs" scheme="https://nmk0718.github.io/tag/gogs/"/>
    
  </entry>
  
  <entry>
    <title>k8sé›†ç¾¤ç»´æŠ¤</title>
    <link href="https://nmk0718.github.io/2020/07/30/k8s%E9%9B%86%E7%BE%A4%E7%BB%B4%E6%8A%A4/"/>
    <id>https://nmk0718.github.io/2020/07/30/k8s%E9%9B%86%E7%BE%A4%E7%BB%B4%E6%8A%A4/</id>
    <published>2020-07-30T15:40:00.000Z</published>
    <updated>2025-02-10T04:00:59.703Z</updated>
    
    <content type="html"><![CDATA[<p>æŸ¥çœ‹é›†ç¾¤</p><p>å›¾ä¸­æœ‰ä¸‰ä¸ªé›†ç¾¤,é›†ç¾¤åŒºåŸŸä¸ºååŒ—2 çŠ¶æ€è¿è¡Œä¸­,èŠ‚ç‚¹æ•°ä¸ºæ¯ä¸ªé›†ç¾¤çš„workeræ•°.<br><img src="https://nmk0718.github.io/image/5f0e9d826971d.png"></p><details><summary>é›†ç¾¤æ‰©å®¹</summary>é€‰æ‹© æ›´å¤š>é›†ç¾¤æ‰©å®¹ æ¥ä¸ºé›†ç¾¤æ‰©å®¹èŠ‚ç‚¹ä¹Ÿå¯é€‰æ‹© æ›´å¤š>æ·»åŠ å·²æœ‰èŠ‚ç‚¹ æ¥æ‰©å®¹(æŠŠecsæ·»åŠ åˆ°é›†ç¾¤)<img src="https://nmk0718.github.io/image/5f0e9e447e472.png">é€‰æ‹© ä¸“æœ‰ç½‘ç»œå’Œäº¤æ¢æœº ä»˜è´¹æ–¹å¼<img src="https://nmk0718.github.io/image/5f0e9ecc9358f.png">é€‰æ‹©æ‰©å®¹èŠ‚ç‚¹æ•°å’Œè§„æ ¼(è§„æ ¼>å†…å­˜å‹>ecs.r5.xlarge)  è®¾ç½®å¯†ç æäº¤å³å¯<img src="https://nmk0718.github.io/image/5f0ea01d29a2e.png"></details><h4 id="èŠ‚ç‚¹è¯¦æƒ…"><a href="#èŠ‚ç‚¹è¯¦æƒ…" class="headerlink" title="èŠ‚ç‚¹è¯¦æƒ…"></a>èŠ‚ç‚¹è¯¦æƒ…</h4><p>å›¾ä¸­testé›†ç¾¤æœ‰ä¸¤ä¸ªworkerèŠ‚ç‚¹,å¯æŸ¥çœ‹å¯¹åº”çš„ipåœ°å€ è®¡è´¹æ–¹å¼ å†…å­˜å¤§å° åˆ°æœŸæ—¶é—´ å†…å­˜CPUä½¿ç”¨<br>å¦‚éœ€æ›´ç»†å¾®çš„ç›‘æ§,è¯·ç‚¹å‡»å³è¾¹çš„ç›‘æ§å¯æŸ¥çœ‹è´Ÿè½½ç½‘ç»œç­‰æƒ…å†µ<br>ç§»é™¤workerèŠ‚ç‚¹ï¼šæ›´å¤š&gt;ç§»é™¤ å³å¯,å¦‚éœ€æ‰¹é‡ç§»é™¤,è¯·å‹¾é€‰workerèŠ‚ç‚¹çš„é€‰é¡¹,ç‚¹å‡»æ‰¹é‡ç§»é™¤å³å¯<br><img src="https://nmk0718.github.io/image/5f0fb71a27871.png"></p><h4 id="æ— çŠ¶æ€"><a href="#æ— çŠ¶æ€" class="headerlink" title="æ— çŠ¶æ€"></a>æ— çŠ¶æ€</h4><p>å¯æŸ¥çœ‹åº”ç”¨æ•°é‡,å®¹å™¨æ•°é‡æ˜¾ç¤ºåº”ç”¨çš„èŠ‚ç‚¹æ•°å’ŒçŠ¶æ€<br>ğŸŒ°ä¸¾ä¾‹:1/1ä»£è¡¨1ä¸ªèŠ‚ç‚¹å¯åŠ¨æˆåŠŸ.0/1ä»£è¡¨1ä¸ªèŠ‚ç‚¹ä½†å¯åŠ¨å¤±è´¥.1/2ä»£è¡¨2ä¸ªèŠ‚ç‚¹ä½†åªæœ‰ä¸€ä¸ªå¯åŠ¨æˆåŠŸ<br><img src="https://nmk0718.github.io/image/5f0fb998b34c9.png"></p><details>  <summary>ğŸ’ğŸ»<font color="blue">è¯¦æƒ…</font></summary>æŸ¥çœ‹åº”ç”¨åç§°,åº”ç”¨çš„æ¥æº(é•œåƒä»“åº“åœ°å€),åº”ç”¨çš„çŠ¶æ€,podçš„ip,podæ‰€åœ¨workerçš„ip åˆ›å»ºæ—¶é—´<img src="https://nmk0718.github.io/image/5f0fbb19e1c65.png">ğŸ”<font color="blue">è¯¦æƒ…</font>æŸ¥çœ‹è¯¥åº”ç”¨æ‰€åœ¨podçš„èµ„æºæƒ…å†µ<img src="https://nmk0718.github.io/image/5f0fbc63e18cb.png">ğŸ“‹<font color="blue">æ—¥å¿—</font>é€‰æ‹©æ˜¾ç¤ºçš„è¡Œæ•°,æ˜¯å¦è‡ªåŠ¨åˆ·æ–°æ—¥å¿—,å¯ä¸‹è½½æ—¥å¿—æ–‡ä»¶<img src="https://nmk0718.github.io/image/5f0fbcb40601f.png">âš™ï¸<font color="blue">æ›´å¤š</font>ç¼–è¾‘å¯æŸ¥çœ‹è¯¥åº”ç”¨çš„yamlæ–‡ä»¶ ç»ˆç«¯å¯è¿æ¥åˆ°podé‡Œè¿›è¡Œæ“ä½œ åˆ é™¤å¯åˆ é™¤å½“å‰çš„pod,ä½†ä¼šè‡ªåŠ¨å†åˆ›å»ºä¸€ä¸ª<img src="https://nmk0718.github.io/image/5f0fbd389d876.png">ğŸšªè®¿é—®æ–¹å¼å¯æŸ¥çœ‹å’Œç¼–è¾‘ æœåŠ¡ä»£è¡¨podå¯¹å¤–æ˜ å°„çš„ç«¯å£ è·¯ç”±ä»£è¡¨è¿›æ¥çš„åŸŸååœ°å€è½¬å‘åˆ°podé‡Œçš„åº”ç”¨åœ°å€<img src="https://nmk0718.github.io/image/5f0fbfd4236f2.png">ğŸ›å®¹å™¨æ°´å¹³ä¼¸ç¼©å™¨å¯æŒ‰ç…§è§„åˆ™è¿›è¡Œè‡ªåŠ¨çš„æ‰©å®¹å’Œå‡å°‘èŠ‚ç‚¹æ•° æœ€å°å‰¯æœ¬å†³å®šè¯¥åº”ç”¨çš„æœ€å°èŠ‚ç‚¹æ•°<img src="https://nmk0718.github.io/image/5f0fbfe8106a7.png">ğŸ“·å†å²ç‰ˆæœ¬å‡ºç°é—®é¢˜æ—¶å¯ä½¿ç”¨è¿›è¡Œå›æ»š(è¿ç»´é…ç½®è¯¥å›æ»šæœ‰ç‚¹é—®é¢˜,è¯·å‹¿ä½¿ç”¨)<img src="https://nmk0718.github.io/image/5f0fc088499a1.png">ğŸ§­è§¦å‘å™¨ä¸å®¹å™¨é•œåƒæœåŠ¡çš„è§¦å‘å™¨ç›¸å¯¹åº”,æ£€æµ‹åˆ°é•œåƒå˜åŒ–åˆ™æ›´æ–°åº”ç”¨<img src="https://nmk0718.github.io/image/5f0fc154cd697.png"></details><details>    <summary>ğŸ’ğŸ»<font color="blue">ç¼–è¾‘</font></summary>**é•œåƒåç§°**: é•œåƒä»“åº“åœ°å€**é•œåƒTag**: é•œåƒçš„ç‰ˆæœ¬**æ€»æ˜¯æ‹‰å–é•œåƒ**: å½“å‡ºç°åˆ é™¤æˆ–æ‰©å®¹æ—¶æ‹‰å–é•œåƒ**æ‰€éœ€èµ„æº**: å®šä¹‰çš„podå†…å­˜å’Œcpu**èµ„æºé™åˆ¶**: podå…±äº«çš„å†…å­˜å’Œcpu (æ­¤ä¸ºpodçš„æœ€å¤§å†…å­˜å’Œcpuå€¼)<img src="https://nmk0718.github.io/image/5f0fc613da038.png">å­˜æ´»æ£€æŸ¥å°±ç»ªæ£€æŸ¥<img src="https://nmk0718.github.io/image/5f0fc70509928.png">æŒ‚è½½ç›®å½•åˆ°workerèŠ‚ç‚¹(å½“podé‡å¯æ—¶,å¯¹åº”ç›®å½•çš„æ•°æ®ä¼šä¿ç•™)<img src="https://nmk0718.github.io/image/5f0fc7d588040.png"></details><details>    <summary>ğŸ’ğŸ»<font color="blue">ä¼¸ç¼©</font></summary>å¯å¢åŠ å’Œå‡å°‘å½“å‰åº”ç”¨çš„èŠ‚ç‚¹æ•°(âš ï¸<font color="red">å½“é…ç½®å®¹å™¨ä¼¸ç¼©æ°´å¹³æ—¶,å½“å‰æ­¤é…ç½®æ— æ•ˆ</font>)<img src="https://nmk0718.github.io/image/5f0fc3fe369c2.png"></details><details>    <summary>ğŸ’ğŸ»<font color="blue">ç›‘æ§</font></summary>å¯æŸ¥çœ‹åº”ç”¨æ‰€åœ¨å®¹å™¨çš„ç›‘æ§,<font color="red">åˆ†ç»„</font>ä¸ºæ•´ä¸ªç»„çš„èµ„æºä½¿ç”¨,<font color="red">å®ä¾‹</font>å¯æŸ¥çœ‹å•ä¸ªèŠ‚ç‚¹çš„èµ„æºä½¿ç”¨<img src="https://nmk0718.github.io/image/5f0fc3a3b9692.png"></details><details>    <summary>ğŸ’ğŸ»<font color="blue">æ›´å¤š</font></summary>å¯æŸ¥çœ‹yamlæ–‡ä»¶,é‡æ–°éƒ¨ç½²åº”ç”¨,å›æ»šåˆ°ç›¸åº”ç‰ˆæœ¬,åˆ é™¤åº”ç”¨<img src="https://nmk0718.github.io/image/5f0fc33ab80b4.png"></details><h4 id="æœ‰çŠ¶æ€"><a href="#æœ‰çŠ¶æ€" class="headerlink" title="æœ‰çŠ¶æ€"></a>æœ‰çŠ¶æ€</h4><h5 id="ä¸€ã€åœ¨é˜¿é‡Œäº‘Kubernetesä¸­è¿è¡Œçš„æœåŠ¡åˆ†ä¸º-æ— çŠ¶æ€å’Œæœ‰çŠ¶æ€"><a href="#ä¸€ã€åœ¨é˜¿é‡Œäº‘Kubernetesä¸­è¿è¡Œçš„æœåŠ¡åˆ†ä¸º-æ— çŠ¶æ€å’Œæœ‰çŠ¶æ€" class="headerlink" title="ä¸€ã€åœ¨é˜¿é‡Œäº‘Kubernetesä¸­è¿è¡Œçš„æœåŠ¡åˆ†ä¸º:æ— çŠ¶æ€å’Œæœ‰çŠ¶æ€"></a>ä¸€ã€åœ¨é˜¿é‡Œäº‘Kubernetesä¸­è¿è¡Œçš„æœåŠ¡åˆ†ä¸º:æ— çŠ¶æ€å’Œæœ‰çŠ¶æ€</h5><ul><li><p>æ— çŠ¶æ€: K8Sä½¿ç”¨RCï¼ˆæˆ–æ›´æ–°çš„Replica Setï¼‰æ¥ä¿è¯ä¸€ä¸ªæœåŠ¡çš„å®ä¾‹æ•°é‡ï¼Œå¦‚æœè¯´æŸä¸ªPodå®ä¾‹ç”±äºæŸç§åŸå› Crashäº†ï¼ŒRCä¼šç«‹åˆ»ç”¨è¿™ä¸ªPodçš„æ¨¡ç‰ˆæ–°å¯ä¸€ä¸ªPodæ¥æ›¿ä»£å®ƒï¼Œç”±äºæ˜¯æ— çŠ¶æ€çš„æœåŠ¡ï¼Œæ–°å¯çš„Podä¸åŸæ¥å¥åº·çŠ¶æ€ä¸‹çš„Podä¸€æ¨¡ä¸€æ ·ã€‚åœ¨Podè¢«é‡å»ºåå®ƒçš„IPåœ°å€å¯èƒ½å‘ç”Ÿå˜åŒ–ï¼Œä¸ºäº†å¯¹å¤–æä¾›ä¸€ä¸ªç¨³å®šçš„è®¿é—®æ¥å£ï¼ŒK8Så¼•å…¥äº†Serviceçš„æ¦‚å¿µã€‚ä¸€ä¸ªServiceåé¢å¯ä»¥æŒ‚å¤šä¸ªPodï¼Œå®ç°æœåŠ¡çš„é«˜å¯ç”¨ã€‚</p></li><li><p>æœ‰çŠ¶æ€: K8Så¼€å‘äº†ä¸€å¥—ä»¥Pet Setä¸ºæ ¸å¿ƒçš„å…¨æ–°ç‰¹æ€§ï¼Œæ–¹ä¾¿äº†æœ‰çŠ¶æ€é›†ç¾¤æœåŠ¡åœ¨K8Sä¸Šçš„éƒ¨ç½²å’Œç®¡ç†ã€‚å…·ä½“æ¥è¯´æ˜¯é€šè¿‡Init Containeræ¥åšé›†ç¾¤çš„åˆå§‹åŒ–å·¥ä½œï¼Œç”¨ Headless Service æ¥ç»´æŒé›†ç¾¤æˆå‘˜çš„ç¨³å®šå…³ç³»ï¼Œç”¨åŠ¨æ€å­˜å‚¨ä¾›ç»™æ¥æ–¹ä¾¿é›†ç¾¤æ‰©å®¹ï¼Œæœ€åç”¨Pet Setæ¥ç»¼åˆç®¡ç†æ•´ä¸ªé›†ç¾¤ã€‚<br>(åœ¨ Kubernetes 1.5 æˆ–æ›´é«˜ç‰ˆæœ¬ä¹‹åï¼ŒPetSet ä¸å†å¯ç”¨ã€‚æ”¹åä¸º StatefulSet)</p></li></ul><h5 id="äºŒã€ä»€ä¹ˆæ˜¯Init-Containerï¼Ÿ"><a href="#äºŒã€ä»€ä¹ˆæ˜¯Init-Containerï¼Ÿ" class="headerlink" title="äºŒã€ä»€ä¹ˆæ˜¯Init Containerï¼Ÿ"></a>äºŒã€ä»€ä¹ˆæ˜¯Init Containerï¼Ÿ</h5><p>Init Containerå°±æ˜¯ç”¨æ¥åšåˆå§‹åŒ–å·¥ä½œçš„å®¹å™¨ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæˆ–è€…å¤šä¸ªï¼Œå¦‚æœæœ‰å¤šä¸ªçš„è¯ï¼Œè¿™äº›å®¹å™¨ä¼šæŒ‰å®šä¹‰çš„é¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œåªæœ‰æ‰€æœ‰çš„Init Containeræ‰§è¡Œå®Œåï¼Œä¸»å®¹å™¨æ‰ä¼šè¢«å¯åŠ¨ã€‚</p><p>Init Containerä¸»è¦æ˜¯æ¥åšåˆå§‹åŒ–å®¹å™¨å·¥ä½œçš„åº”ç”¨åœºæ™¯ï¼š</p><ul><li>ç­‰å¾…å…¶ä»–æ¨¡å—Readyï¼šè¿™ä¸ªå¯ä»¥ç”¨æ¥è§£å†³æœåŠ¡ä¹‹é—´çš„ä¾èµ–é—®é¢˜ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ª Web æœåŠ¡ï¼Œè¯¥æœåŠ¡åˆä¾èµ–äºå¦å¤–ä¸€ä¸ªæ•°æ®åº“æœåŠ¡ï¼Œä½†æ˜¯åœ¨æˆ‘ä»¬å¯åŠ¨è¿™ä¸ª Web æœåŠ¡çš„æ—¶å€™æˆ‘ä»¬å¹¶ä¸èƒ½ä¿è¯ä¾èµ–çš„è¿™ä¸ªæ•°æ®åº“æœåŠ¡å°±å·²ç»å¯åŠ¨èµ·æ¥äº†ï¼Œæ‰€ä»¥å¯èƒ½ä¼šå‡ºç°ä¸€æ®µæ—¶é—´å†… Web æœåŠ¡è¿æ¥æ•°æ®åº“å¼‚å¸¸ã€‚è¦è§£å†³è¿™ä¸ªé—®é¢˜çš„è¯æˆ‘ä»¬å°±å¯ä»¥åœ¨ Web æœåŠ¡çš„ Pod ä¸­ä½¿ç”¨ä¸€ä¸ªInitContainerï¼Œåœ¨è¿™ä¸ªåˆå§‹åŒ–å®¹å™¨ä¸­å»æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å·²ç»å‡†å¤‡å¥½äº†ï¼Œå‡†å¤‡å¥½äº†è¿‡ååˆå§‹åŒ–å®¹å™¨å°±ç»“æŸé€€å‡ºï¼Œç„¶åæˆ‘ä»¬çš„ä¸»å®¹å™¨ Web æœåŠ¡è¢«å¯åŠ¨èµ·æ¥ï¼Œè¿™ä¸ªæ—¶å€™å»è¿æ¥æ•°æ®åº“å°±ä¸ä¼šæœ‰é—®é¢˜äº†ã€‚</li><li>åšåˆå§‹åŒ–é…ç½®ï¼šæ¯”å¦‚é›†ç¾¤é‡Œæ£€æµ‹æ‰€æœ‰å·²ç»å­˜åœ¨çš„æˆå‘˜èŠ‚ç‚¹ï¼Œä¸ºä¸»å®¹å™¨å‡†å¤‡å¥½é›†ç¾¤çš„é…ç½®ä¿¡æ¯ï¼Œè¿™æ ·ä¸»å®¹å™¨èµ·æ¥åå°±èƒ½ç”¨è¿™ä¸ªé…ç½®ä¿¡æ¯åŠ å…¥é›†ç¾¤ã€‚</li><li>å…¶å®ƒåœºæ™¯ï¼šå¦‚å°†Podæ³¨å†Œåˆ°ä¸€ä¸ªä¸­å¤®æ•°æ®åº“ã€é…ç½®ä¸­å¿ƒç­‰ã€‚</li></ul><h5 id="ä¸‰ã€ä»€ä¹ˆæ˜¯Pet-Setï¼Ÿ"><a href="#ä¸‰ã€ä»€ä¹ˆæ˜¯Pet-Setï¼Ÿ" class="headerlink" title="ä¸‰ã€ä»€ä¹ˆæ˜¯Pet Setï¼Ÿ"></a>ä¸‰ã€ä»€ä¹ˆæ˜¯Pet Setï¼Ÿ</h5><ul><li><p>Petæ˜¯ä¸€ä¸ªæœ‰çŠ¶æ€åº”ç”¨ç¨‹åºï¼Œæœ¬è´¨ä¸Šå®ƒæ˜¯ä¸€ä¸ªå…·æœ‰ç¡®å®šæ€§åç§°ä»¥åŠå”¯ä¸€èº«ä»½çš„Podï¼Œèº«ä»½å†…å®¹åŒ…æ‹¬ï¼š<br>DNSä¸­å¯ä»¥è¯†åˆ«çš„å›ºå®šhostname<br>é¡ºåºåŒ–ç´¢å¼•ï¼ˆPetåç§°ç»„æˆï¼šPetSetName-Ordinalï¼‰<br>é“¾æ¥åˆ°ç´¢å¼•ä¸hostnameçš„å›ºå®šå­˜å‚¨</p></li><li><p>Pet Setå°±æ˜¯Peté›†åˆï¼Œå®ƒå…·æœ‰ç‰¹å®šæ•°é‡çš„Petï¼Œå…¶ç›®çš„å°±åœ¨äºè§£è€¦é›†ç¾¤åŒ–æœ‰çŠ¶æ€åº”ç”¨ç¨‹åºï¼Œä¾‹å¦‚MySQLã€PostgreSQLç­‰æ•°æ®åº“åº”ç”¨ç¨‹åºï¼Œæˆ–è€…Zookeeperã€Etcdä»¥åŠElasticsearchç­‰é›†ç¾¤åŒ–åº”ç”¨ç¨‹åºã€‚ä¸€èˆ¬é›†ç¾¤åŒ–åº”ç”¨ç¨‹åºéƒ½æ˜¯éƒ¨ç½²åœ¨å›ºå®šçš„ç»“ç‚¹ä¸Šï¼Œå…·æœ‰æ°¸ä¹…æ€§å­˜å‚¨ä»¥åŠé™æ€çš„IPåœ°å€ï¼Œå¹¶ä¸”åœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­éœ€è¦åœ¨ç»“ç‚¹ä¹‹é—´å»ºç«‹ä¸€å®šçš„å…³è”è”ç³»ã€‚è€ŒPet Setä¼šç»™æ¯ä¸ªåº”ç”¨ç¨‹åºå®ä¾‹åˆ†é…ä¸€ä¸ªèº«ä»½ï¼Œè¿™æ ·åº”ç”¨ç¨‹åºå®ä¾‹å°±ä¸å¿…å›ºå®šåœ¨ç‰©ç†åŸºç¡€æœåŠ¡ä¸Šï¼Œå®ä¾‹ä¹‹é—´ä¾é èº«ä»½å»ºç«‹è”ç³»ã€‚</p></li></ul><h6 id="ä¸€ä¸ªPetæœ‰ä¸‰ä¸ªç‰¹å¾ã€‚"><a href="#ä¸€ä¸ªPetæœ‰ä¸‰ä¸ªç‰¹å¾ã€‚" class="headerlink" title="ä¸€ä¸ªPetæœ‰ä¸‰ä¸ªç‰¹å¾ã€‚"></a>ä¸€ä¸ªPetæœ‰ä¸‰ä¸ªç‰¹å¾ã€‚</h6><ol><li><p>æ˜¯æœ‰ç¨³å®šçš„å­˜å‚¨ï¼Œè¿™æ˜¯é€šè¿‡PV/PVC æ¥å®ç°çš„ã€‚</p></li><li><p>æ˜¯ç¨³å®šçš„ç½‘ç»œèº«ä»½ï¼Œè¿™æ˜¯é€šè¿‡ä¸€ç§å« Headless Service çš„ç‰¹æ®ŠServiceæ¥å®ç°çš„ã€‚Serviceå¯ä»¥ä¸ºå¤šä¸ªPodå®ä¾‹æä¾›ä¸€ä¸ªç¨³å®šçš„å¯¹å¤–è®¿é—®æ¥å£ã€‚è¿™ä¸ªç¨³å®šçš„æ¥å£æ˜¯é€šè¿‡Cluster IPæ¥å®ç°çš„ï¼ŒCluster IPæ˜¯ä¸€ä¸ªè™šæ‹ŸIPï¼Œä¸æ˜¯çœŸæ­£çš„IPï¼Œæ‰€ä»¥ç¨³å®šã€‚K8Sä¼šåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ç³»åˆ—çš„IPTablesè§„åˆ™ï¼Œå®ç°ä»Cluster IPåˆ°å®é™…Pod IPçš„è½¬å‘ã€‚åŒæ—¶è¿˜ä¼šç›‘æ§è¿™äº›Podçš„IPåœ°å€å˜åŒ–ï¼Œå¦‚æœå˜äº†ï¼Œä¼šæ›´æ–°IP Tablesè§„åˆ™ï¼Œä½¿è½¬å‘è·¯å¾„ä¿æŒæ­£ç¡®ã€‚æ‰€ä»¥å³ä½¿Pod IPæœ‰å˜åŒ–ï¼Œå¤–éƒ¨ç…§æ ·èƒ½é€šè¿‡Serviceçš„ClusterIPè®¿é—®åˆ°åé¢çš„Podã€‚<br><br>æ™®é€šServiceçš„Cluster IP æ˜¯å¯¹å¤–çš„ï¼Œç”¨äºå¤–éƒ¨è®¿é—®å¤šä¸ªPodå®ä¾‹ã€‚è€ŒHeadless Serviceçš„ä½œç”¨æ˜¯å¯¹å†…çš„ï¼Œç”¨äºä¸ºä¸€ä¸ªé›†ç¾¤å†…éƒ¨çš„æ¯ä¸ªæˆå‘˜æä¾›ä¸€ä¸ªå”¯ä¸€çš„DNSåå­—ï¼Œè¿™æ ·é›†ç¾¤æˆå‘˜ä¹‹é—´å°±èƒ½ç›¸äº’é€šä¿¡äº†ã€‚æ‰€ä»¥<font color="red">Headless Serviceæ²¡æœ‰Cluster IP</font>ï¼Œè¿™æ˜¯å®ƒå’Œæ™®é€šServiceçš„åŒºåˆ«ã€‚<br><br>Headless Service ä¼šä¸ºå…³è”çš„æ¯ä¸€ä¸ª pod æä¾›å¯¹åº”çš„ DNS åœ°å€ï¼Œæ ¼å¼ä¸º<pod-name>.<service-name>ã€‚è¿™æ ·ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥è‡ªç”±åœ°é€‰æ‹©æƒ³è¦è®¿é—®çš„åº”ç”¨å®ä¾‹ï¼ŒåŒæ—¶ä¹Ÿèƒ½å¤Ÿè§£å†³åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ä¸åŒå®ä¾‹ä¹‹é—´èº«ä»½è¯†åˆ«çš„é—®é¢˜ã€‚<br><br>æ ·ä¾‹åŒ…å«ä¸€ä¸ªåä¸ºmysqlçš„ Headless Serviceï¼Œè¯¥ service ä¸ StatefulSet ä¸­çš„ pod ç›¸å…³è”ï¼Œè¿™äº› pod å°†è¢«åˆ†é…å¦‚ä¸‹ DNS åœ°å€mysql-0.mysqlã€mysql-1.mysqlã€mysql-2.mysqlã€‚è¿™æ ·ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥é€šè¿‡mysql-0.mysqlè®¿é—® master èŠ‚ç‚¹ï¼Œé€šè¿‡mysql-1.mysqlæˆ–mysql-2.mysqlè®¿é—® slave èŠ‚ç‚¹ã€‚</service-name></pod-name></p></li><li><p>æ˜¯åºå·å‘½åè§„åˆ™ã€‚Petæ˜¯ä¸€ç§ç‰¹æ®Šçš„Podï¼Œé‚£ä¹ˆPetèƒ½ä¸èƒ½ç”¨Podçš„å‘½åè§„åˆ™å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¸èƒ½ï¼Œå› ä¸ºPodçš„åå­—æ˜¯ä¸ç¨³å®šçš„ã€‚Podçš„å‘½åè§„åˆ™æ˜¯ï¼Œå¦‚æœä¸€ä¸ªPodæ˜¯ç”±ä¸€ä¸ªRCåˆ›å»ºçš„ï¼Œé‚£ä¹ˆPodçš„åå­—æ˜¯RCçš„åå­—åŠ ä¸Šä¸€ä¸ªéšæœºå­—ç¬¦ä¸²ã€‚ä¸ºä»€ä¹ˆè¦åŠ ä¸€ä¸ªéšæœºå­—ç¬¦ä¸²ï¼Œæ˜¯å› ä¸ºRCé‡ŒæŒ‡å®šçš„æ˜¯Podçš„æ¨¡ç‰ˆï¼Œä¸ºäº†å®ç°é«˜å¯ç”¨ï¼Œé€šå¸¸ä¼šä»è¿™ä¸ªæ¨¡ç‰ˆé‡Œåˆ›å»ºå¤šä¸ªä¸€æ¨¡ä¸€æ ·çš„Podå®ä¾‹ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸ªéšæœºå­—ç¬¦ä¸²ï¼ŒåŒä¸€ä¸ªRCåˆ›å»ºçš„Podä¹‹é—´å°±ä¼šç”±åå­—å†²çªã€‚<br><br>å¦‚æœè¯´æŸä¸ªPodç”±äºæŸç§åŸå› æ­»æ‰äº†ï¼ŒRCä¼šæ–°å»ºä¸€ä¸ªæ¥ä»£æ›¿å®ƒï¼Œä½†æ˜¯è¿™ä¸ªæ–°å»ºé‡Œçš„Podåå­—é‡Œçš„éšæœºå­—ç¬¦ä¸²ä¸åŸæ¥æ­»æ‰çš„Podæ˜¯ä¸ä¸€æ ·çš„ã€‚æ‰€ä»¥Podçš„åå­—è·Ÿå®ƒçš„IPä¸€æ ·æ˜¯ä¸ç¨³å®šçš„ã€‚<br>ä¸ºäº†è§£å†³åå­—ä¸ç¨³å®šçš„é—®é¢˜ï¼ŒK8Så¯¹Petçš„åå­—ä¸å†ä½¿ç”¨éšæœºå­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ä¸ºæ¯ä¸ªPetåˆ†é…ä¸€ä¸ªå”¯ä¸€ä¸å˜çš„åºå·ï¼Œæ¯”å¦‚ Pet Set çš„åå­—å« mysqlï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªå¯èµ·æ¥çš„Petå°±å« mysql-0ï¼Œç¬¬äºŒä¸ªå« mysql-1ï¼Œå¦‚æ­¤ä¸‹å»ã€‚<br><br>å½“ä¸€ä¸ªPet down æ‰åï¼Œæ–°åˆ›å»ºçš„Pet ä¼šè¢«èµ‹äºˆè·ŸåŸæ¥Petä¸€æ ·çš„åå­—ã€‚ç”±äºPetåå­—ä¸å˜æ‰€ä»¥DNSåå­—ä¹Ÿè·Ÿä»¥å‰ä¸€æ ·ï¼ŒåŒæ—¶é€šè¿‡åå­—è¿˜èƒ½åŒ¹é…åˆ°åŸæ¥Petç”¨åˆ°çš„å­˜å‚¨ï¼Œå®ç°çŠ¶æ€ä¿å­˜ã€‚<br>åœ¨Kubernetesä¸­ï¼Œå…¶å°†å®¹å™¨éƒ¨ç½²åˆ’åˆ†æˆå¤šä¸ªPetï¼Œå¹¶ä¿è¯æ¯ä¸ªPetéƒ½æœ‰ç¡®å®šæ€§çš„å”¯ä¸€èº«ä»½ï¼Œèº«ä»½å†…å®¹åŒ…æ‹¬DNSåŸŸåã€ä¸€è‡´æ€§å­˜å‚¨ä»¥åŠé¡ºåºåŒ–podç´¢å¼•ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œä½¿ç”¨Deploymentså’ŒReplication Controllersè¿›è¡Œéƒ¨ç½²ï¼Œåªä¼šç»™åº”ç”¨ç¨‹åºåˆ†é…ä¸€ä¸ªéè€¦åˆçš„å¼±èº«ä»½ã€‚å¼±èº«ä»½æ¯”è¾ƒé€‚åˆå¾®æœåŠ¡ç­‰åº”ç”¨ç¨‹åºï¼Œè¿™ç±»åº”ç”¨ç¨‹åºä¸å…³å¿ƒpodçš„åç§°ï¼Œå…¶é‡ç‚¹åœ¨äºæœåŠ¡å‘ç°ï¼Œå¹¶ä¸”è¿™äº›åº”ç”¨ç¨‹åºæ˜¯æ— çŠ¶æ€çš„ã€‚ç„¶è€Œæœ‰å¾ˆå¤šè½¯ä»¶åº”ç”¨ç¨‹åºæ˜¯éœ€è¦å¼ºèº«ä»½ï¼Œä¾‹å¦‚å¤šç§ä¸åŒç±»å‹çš„åˆ†å¸ƒå¼æœ‰çŠ¶æ€ç³»ç»Ÿã€‚Cassandraå°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„ä¾‹å­ï¼Œå®ƒéœ€è¦ä¸€è‡´çš„ç½‘ç»œæ ‡è¯†ä»¥åŠå›ºå®šçš„å­˜å‚¨ã€‚<br><br>Pet Setsæä¾›äº†å¦‚ä¸‹åŠŸèƒ½ï¼š<br>åœ¨DNSä¸­å…·æœ‰å›ºå®šçš„hostnameï¼ŒåŒä¸€ä¸ªPet Setä¸­çš„Pet hostnameä»¥Pet Setåç§°ä¸ºåŸºç¡€ï¼ŒåŠ ä¸Šä»0å¼€å§‹çš„é¡ºåºåŒ–æ•°å­—ï¼Œä¾‹å¦‚cassandra-0ã€‚<br>é¡ºåºåŒ–ç´¢å¼•ï¼Œä¾‹å¦‚0ã€1ã€2ã€3ã€‚<br>é“¾æ¥åˆ°Petåºåˆ—ä»¥åŠhostnameçš„å›ºå®šå­˜å‚¨ã€‚<br>é€šè¿‡DNSå‘ç°åŒä¼´ï¼Œåœ¨Petåˆ›å»ºä¹‹å‰ï¼ŒåŒä¼´çš„åç§°æ˜¯å·²çŸ¥çš„ã€‚<br>é¡ºåºå¯åŠ¨ä¸é”€æ¯Petï¼Œé€šè¿‡Petç¼–å·ï¼Œä¸‹ä¸€ä¸ªéœ€è¦è¢«åˆ›å»ºçš„Petæ˜¯å·²çŸ¥çš„ï¼Œå¹¶ä¸”å½“Pet Setè§„æ¨¡å‡å°æ—¶ï¼Œå“ªäº›Petéœ€è¦è¢«é”€æ¯ä¹Ÿæ˜¯å·²çŸ¥çš„ã€‚å½“ç¼©å‡é›†ç¾¤è§„æ¨¡æ—¶ï¼Œå¯¹äºä»ä¸€ä¸ªPetä¸­æŠ½å–æ•°æ®è¿™ç±»ç®¡ç†ä»»åŠ¡æ¥è¯´ï¼Œè¯¥åŠŸèƒ½æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚</p></li></ol><h5 id="å››ã€åˆ›å»ºæœ‰çŠ¶æ€çš„å®¹å™¨"><a href="#å››ã€åˆ›å»ºæœ‰çŠ¶æ€çš„å®¹å™¨" class="headerlink" title="å››ã€åˆ›å»ºæœ‰çŠ¶æ€çš„å®¹å™¨"></a>å››ã€åˆ›å»ºæœ‰çŠ¶æ€çš„å®¹å™¨</h5><ul><li><p>æŒ‡å®šåº”ç”¨åç§°,é›†ç¾¤,å‘½åç©ºé—´,èŠ‚ç‚¹æ•°,ç±»å‹</p><img src="https://nmk0718.github.io/image/5ef01fe715b40.png"></li><li><p>é€‰æ‹©æ‹‰å–çš„é•œåƒçš„ä»“åº“åœ°å€</p></li><li><p>å•å‡»é€‰æ‹©é•œåƒTagé€‰æ‹©é•œåƒçš„ç‰ˆæœ¬ã€‚è‹¥ä¸æŒ‡å®šï¼Œé»˜è®¤ä¸ºæœ€æ–°ç‰ˆã€‚</p></li><li><p>å‹¾é€‰æ€»æ˜¯æ‹‰å–é•œåƒï¼Œè¡¨ç¤ºæ¯æ¬¡éƒ¨ç½²æˆ–æ‰©å®¹éƒ½ä¼šä»å®¹å™¨é•œåƒæœåŠ¡é‡æ–°æ‹‰å–é•œåƒï¼Œè€Œä¸ä¼šä»æœ¬åœ°æ‹‰å–é•œåƒã€‚</p></li><li><p>é…ç½®åº”ç”¨çš„cpuå’Œå†…å­˜</p></li><li><p>å­˜æ´»æ£€æµ‹å’Œå°±ç»ªæ£€æµ‹å¯æŒ‰ç…§ä¸Šç¯‡æ–‡ç« è¿›è¡Œé…ç½®</p></li><li><p>é…ç½®æ•°æ®å·æŒ‚è½½æœ¬æœºç›®å½•åˆ°pod</p><img src="https://nmk0718.github.io/image/5ef024be1dcb3.png"></li><li><p>åˆ›å»ºæœåŠ¡,æœåŠ¡åå¯¹åº”åº”ç”¨å</p></li><li><p>å‹¾é€‰å®ä¾‹é—´æœåŠ¡å‘ç°</p></li><li><p>ç«¯å£æ˜ å°„</p><img src="https://nmk0718.github.io/image/5ef028fc3eb28.png"></li><li><p>åˆ›å»ºåæŸ¥çœ‹åº”ç”¨çš„ä¸»æœºååæ˜¯å¦æœ‰åºå·</p></li><li><p>åœ¨podç»ˆç«¯æ—¶å€™å°è¯•æ˜¯å¦èƒ½é€šè¿‡<pod-name>.<service-name>:<port>è®¿é—®åº”ç”¨</port></service-name></pod-name></p><img src="https://nmk0718.github.io/image/5ef0297c107c7.png"></li></ul><h4 id="æœåŠ¡"><a href="#æœåŠ¡" class="headerlink" title="æœåŠ¡"></a>æœåŠ¡</h4><p><strong>åç§°</strong>: è‡ªå®šä¹‰(åº”ç”¨åå³å¯)<br><strong>å…³è”</strong>: åº”ç”¨çš„çš„æ— çŠ¶æ€åç§°<br><strong>ç«¯å£æ˜ å°„</strong>: éœ€è¦å¤–æ”¾çš„ç«¯å£<br><img src="https://nmk0718.github.io/image/5f0fee1759024.png"></p><h4 id="è·¯ç”±"><a href="#è·¯ç”±" class="headerlink" title="è·¯ç”±"></a>è·¯ç”±</h4><p><strong>åç§°</strong>: è‡ªå®šä¹‰(å¯å¡«å†™åŸŸååç§°)<br><strong>åŸŸå</strong>: åŸŸå(tdev.gzlplink.com)<br><strong>è·¯å¾„</strong>: è¦è®¿é—®çš„åœ°å€(å¦‚/api)<br><strong>æœåŠ¡</strong>: é€‰æ‹©æœåŠ¡å¯¹åº”çš„å®¹å™¨å<br>å‹¾é€‰å¼€å¯TLS,ä½¿ç”¨å¯†é’¥,æ—¢å¯ä½¿ç”¨https,å¦‚æœªæœ‰å¯†é’¥å¯ç‚¹å‡»æ–°å»ºå¯†é’¥è¿›è¡Œåˆ›å»º<br><img src="https://nmk0718.github.io/image/5f0fefc2ea532.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æŸ¥çœ‹é›†ç¾¤&lt;/p&gt;
&lt;p&gt;å›¾ä¸­æœ‰ä¸‰ä¸ªé›†ç¾¤,é›†ç¾¤åŒºåŸŸä¸ºååŒ—2 çŠ¶æ€è¿è¡Œä¸­,èŠ‚ç‚¹æ•°ä¸ºæ¯ä¸ªé›†ç¾¤çš„workeræ•°.&lt;br&gt;&lt;img src=&quot;https://nmk0718.github.io/image/5f0e9d826971d.png&quot;&gt;&lt;/p&gt;
&lt;details&gt;
&lt;summ</summary>
      
    
    
    
    
    <category term="k8s" scheme="https://nmk0718.github.io/tag/k8s/"/>
    
  </entry>
  
  <entry>
    <title>elasticsearch</title>
    <link href="https://nmk0718.github.io/2020/07/30/elasticsearch/"/>
    <id>https://nmk0718.github.io/2020/07/30/elasticsearch/</id>
    <published>2020-07-30T14:55:00.000Z</published>
    <updated>2025-02-20T09:54:36.934Z</updated>
    
    <content type="html"><![CDATA[<h3 id="elasticsearché›†ç¾¤æ­å»º"><a href="#elasticsearché›†ç¾¤æ­å»º" class="headerlink" title="elasticsearché›†ç¾¤æ­å»º"></a>elasticsearché›†ç¾¤æ­å»º</h3><h4 id="elasticsearch"><a href="#elasticsearch" class="headerlink" title="elasticsearch"></a>elasticsearch</h4><h5 id="ä¸‹è½½"><a href="#ä¸‹è½½" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-oss-7.8.0-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure><p>æ³¨æ„ä¸‹è½½å¸¦ossçš„å¼€æºç‰ˆæœ¬</p><h5 id="æ‹·è´åˆ°å®‰è£…ç›®å½•"><a href="#æ‹·è´åˆ°å®‰è£…ç›®å½•" class="headerlink" title="æ‹·è´åˆ°å®‰è£…ç›®å½•"></a>æ‹·è´åˆ°å®‰è£…ç›®å½•</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cp elasticsearch-7.8.0-linux-x86_64.tar.gz /opt/es</span><br></pre></td></tr></table></figure><h5 id="è§£å‹"><a href="#è§£å‹" class="headerlink" title="è§£å‹"></a>è§£å‹</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /opt/es</span><br><span class="line">tar -zxvf elasticsearch-7.8.0-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure><h5 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim elasticsearch-7.8.0/config/elasticsearch.yml</span><br></pre></td></tr></table></figure><ul><li><strong>cluster.name</strong>: é›†ç¾¤åç§°,é›†ç¾¤åç§°ç”¨äºè·Ÿå…¶ä»–ç›¸åŒåå­—çš„èŠ‚ç‚¹æ„æˆæ•´ä¸ªé›†ç¾¤.</li><li><strong>node.name</strong>: èŠ‚ç‚¹åç§°, æ˜¯è¯¥elasticsearchå®ä¾‹çš„å”¯ä¸€æ ‡è¯†</li><li><strong>path.data</strong>: æ•°æ®è·¯å¾„,æŒ‡å®šæ–‡æ¡£ï¼Œç´¢å¼•å­˜æ”¾çš„ä½ç½®ã€‚</li><li><strong>path.logs</strong>:æ—¥å¿—è·¯å¾„ï¼ŒæŒ‡å®šè¿è¡Œæ—¥å¿—çš„å­˜æ”¾ç›®å½•</li><li><strong>network.host</strong>: ç»‘å®šåœ°å€</li><li><strong>http.port</strong>: httpç«¯å£,é»˜è®¤9200</li><li><strong>discovery.seed_hosts</strong>: é›†ç¾¤ä¸»æœºåˆ—è¡¨</li><li><strong>cluster.initial_master_nodes</strong>: åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„é›†ç¾¤æ—¶é€‰ä¸¾master(ç¬¬ä¸€ä¸ªå¯åŠ¨ä¸ºmaster)</li><li><strong>http.cors.enabled</strong>: æ˜¯å¦æ”¯æŒè·¨åŸŸ,æ˜¯ï¼štrueï¼Œåœ¨ä½¿ç”¨headæ’ä»¶æ—¶éœ€è¦æ­¤é…ç½®</li><li><strong>node.master</strong>: æ˜¯å¦æ˜¯masterèŠ‚ç‚¹</li><li><strong>discovery.type: single-node</strong> å•èŠ‚ç‚¹ä½¿ç”¨æ­¤é…ç½®</li></ul><p>é…ç½®å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># ======================== Elasticsearch Configuration =========================</span><br><span class="line">#</span><br><span class="line"># NOTE: Elasticsearch comes with reasonable defaults for most settings.</span><br><span class="line">#       Before you set out to tweak and tune the configuration, make sure you</span><br><span class="line">#       understand what are you trying to accomplish and the consequences.</span><br><span class="line">#</span><br><span class="line"># The primary way of configuring a node is via this file. This template lists</span><br><span class="line"># the most important settings you may want to configure for a production cluster.</span><br><span class="line">#</span><br><span class="line"># Please consult the documentation for further information on configuration options:</span><br><span class="line"># https://www.elastic.co/guide/en/elasticsearch/reference/index.html</span><br><span class="line">#</span><br><span class="line"># ---------------------------------- Cluster -----------------------------------</span><br><span class="line">#</span><br><span class="line"># Use a descriptive name for your cluster:</span><br><span class="line">#</span><br><span class="line">cluster.name: elasticsearch</span><br><span class="line">#</span><br><span class="line"># ------------------------------------ Node ------------------------------------</span><br><span class="line">#</span><br><span class="line"># Use a descriptive name for the node:</span><br><span class="line">#</span><br><span class="line">node.name: node-100</span><br><span class="line">#</span><br><span class="line"># Add custom attributes to the node:</span><br><span class="line">#</span><br><span class="line">#node.attr.rack: r1</span><br><span class="line">#</span><br><span class="line"># ----------------------------------- Paths ------------------------------------</span><br><span class="line">#</span><br><span class="line"># Path to directory where to store the data (separate multiple locations by comma):</span><br><span class="line">#</span><br><span class="line">path.data: /home/elasticsearch/data</span><br><span class="line">#</span><br><span class="line"># Path to log files:</span><br><span class="line">#</span><br><span class="line">path.logs: /home/elasticsearch/logs</span><br><span class="line">#</span><br><span class="line"># ----------------------------------- Memory -----------------------------------</span><br><span class="line">#</span><br><span class="line"># Lock the memory on startup:</span><br><span class="line">#</span><br><span class="line">#bootstrap.memory_lock: true</span><br><span class="line">#</span><br><span class="line"># Make sure that the heap size is set to about half the memory available</span><br><span class="line"># on the system and that the owner of the process is allowed to use this</span><br><span class="line"># limit.</span><br><span class="line">#</span><br><span class="line"># Elasticsearch performs poorly when the system is swapping the memory.</span><br><span class="line">#</span><br><span class="line"># ---------------------------------- Network -----------------------------------</span><br><span class="line">#</span><br><span class="line"># Set the bind address to a specific IP (IPv4 or IPv6):</span><br><span class="line">#</span><br><span class="line">network.host: 172.17.53.225</span><br><span class="line">#</span><br><span class="line"># Set a custom port for HTTP:</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">http.port: 9100</span><br><span class="line">#</span><br><span class="line"># For more information, consult the network module documentation.</span><br><span class="line">#</span><br><span class="line"># --------------------------------- Discovery ----------------------------------</span><br><span class="line">#</span><br><span class="line"># Pass an initial list of hosts to perform discovery when this node is started:</span><br><span class="line"># The default list of hosts is [&quot;127.0.0.1&quot;, &quot;[::1]&quot;]</span><br><span class="line">#</span><br><span class="line">discovery.seed_hosts: [&quot;172.17.53.225:9300&quot;,&quot;172.17.53.226:9300&quot;,&quot;172.17.53.227:9300&quot;]</span><br><span class="line">#ES7.xå‰ä½¿ç”¨discovery.zen.ping.unicast.hosts: [&quot;192.168.1.130&quot;, &quot;192.168.1.134&quot;] </span><br><span class="line">#</span><br><span class="line"># Bootstrap the cluster using an initial set of master-eligible nodes:</span><br><span class="line">#</span><br><span class="line">cluster.initial_master_nodes: [&quot;node-100&quot;, &quot;node-101&quot;,&quot;node-102&quot;]</span><br><span class="line">#</span><br><span class="line"># For more information, consult the discovery and cluster formation module documentation.</span><br><span class="line">#</span><br><span class="line"># ---------------------------------- Gateway -----------------------------------</span><br><span class="line">#</span><br><span class="line"># Block initial recovery after a full cluster restart until N nodes are started:</span><br><span class="line">#</span><br><span class="line">#gateway.recover_after_nodes: 3</span><br><span class="line">#</span><br><span class="line"># For more information, consult the gateway module documentation.</span><br><span class="line">#</span><br><span class="line"># ---------------------------------- Various -----------------------------------</span><br><span class="line">#</span><br><span class="line"># Require explicit names when deleting indices:</span><br><span class="line">#</span><br><span class="line">#action.destructive_requires_name: true</span><br><span class="line">http.cors.enabled: true</span><br><span class="line">#</span><br><span class="line">node.master: true</span><br></pre></td></tr></table></figure><p>âš ï¸æ³¨æ„discovery.seed_hostså¤„ä¸ºé›†ç¾¤äº¤äº’ç«¯å£,é»˜è®¤ä¸º9300,å¦‚éœ€æ›´æ”¹è¯·æŠŠä¸‹é¢å‚æ•°åŠ å…¥é…ç½®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#TCPçš„é»˜è®¤ç›‘å¬ç«¯å£ï¼Œé»˜è®¤ 9300</span><br><span class="line">transport.tcp.port: 9300</span><br></pre></td></tr></table></figure><p>é…ç½®å®Œæˆåï¼Œå°†æ•´ä¸ªæ–‡ä»¶copyåˆ°å¦å¤–ä¸¤ä¸ªæœºå™¨</p><p>Elasticsearchä¸å…è®¸ä½¿ç”¨rootè´¦å·å¯åŠ¨ï¼Œå› æ­¤éœ€è¦å»ºä¸€ä¸ªä¸“ç”¨çš„è´¦å·ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adduser es</span><br><span class="line">passwd gzlp</span><br><span class="line">chown -R es ./elasticsearch-7.8.0</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹æ•°æ®è·¯å¾„å’Œæ—¥å¿—è·¯å¾„çš„æƒé™:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">chown -R es /home/elasticsearch/data</span><br><span class="line">chown -R es /home/elasticsearch/logs</span><br></pre></td></tr></table></figure><p>å¢åŠ æ’ä»¶</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https://github.com/medcl/elasticsearch-analysis-ik/releases</span><br><span class="line">https://github.com/medcl/elasticsearch-analysis-pinyin/releases</span><br><span class="line">https://github.com/medcl/elasticsearch-analysis-stconvert/releases</span><br><span class="line">ä¸‹è½½esç‰ˆæœ¬ä¸€è‡´çš„åŒ…,è§£å‹.ç§»åŠ¨åˆ°elasticsearch-7.8.0/pluginsé‡Œ</span><br><span class="line">é‡å‘½åelasticsearch-analysis-ikä¸ºik</span><br><span class="line">é‡å‘½åelasticsearch-analysis-pinyinä¸ºpinyin</span><br><span class="line">é‡å‘½åelasticsearch-analysis-stconvertä¸ºstconvert</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹é…ç½®sysctl.conf</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi /etc/sysctl.conf</span><br></pre></td></tr></table></figure><p>æ·»åŠ é…ç½®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vm.max_map_count=262144</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå‘½ä»¤</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure><p>å¯åŠ¨elasticsearch</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#åå°å¯åŠ¨</span><br><span class="line">./elasticsearch -d</span><br></pre></td></tr></table></figure><p>éªŒè¯æ˜¯å¦å¯åŠ¨æˆåŠŸ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://172.17.53.255:9100</span><br></pre></td></tr></table></figure><p>éªŒè¯æ˜¯å¦ä¸ºé›†ç¾¤</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://172.17.53.255:9100/_cluster/stats?pretty</span><br></pre></td></tr></table></figure><p>éªŒè¯æ˜¯å¦ä¸ºä¸»èŠ‚ç‚¹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://172.17.53.226:9200/_cat/nodes?v</span><br><span class="line"></span><br><span class="line">#å¸¦*æ˜Ÿå·è¡¨æ˜è¯¥èŠ‚ç‚¹æ˜¯ä¸»èŠ‚ç‚¹ã€‚å¸¦-è¡¨æ˜è¯¥èŠ‚ç‚¹æ˜¯ä»èŠ‚ç‚¹ã€‚</span><br><span class="line">#å¦å¤–è¿˜æ˜¯heap.percentå †å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œram.percentè¿è¡Œå†…å­˜ä½¿ç”¨æƒ…å†µï¼Œcpuä½¿ç”¨æƒ…å†µã€‚</span><br><span class="line"></span><br><span class="line">ip            heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name</span><br><span class="line">172.17.53.227           61          78   0    0.04    0.30     0.38 dimr      *      node-3</span><br><span class="line">172.17.53.226           69          90   1    0.21    0.84     1.03 dimr      -      node-2</span><br><span class="line">172.17.53.225           34          92   1    0.20    0.32     0.18 dimr      -      node-1</span><br></pre></td></tr></table></figure><h5 id="å¼€æœºè‡ªå¯"><a href="#å¼€æœºè‡ªå¯" class="headerlink" title="å¼€æœºè‡ªå¯"></a>å¼€æœºè‡ªå¯</h5><ul><li>åœ¨/etc/init.dç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶elasticsearch</li></ul><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ä¸€èˆ¬çš„æœåŠ¡å™¨åœ¨init.dè¿™ä¸ªç›®å½•ä¸‹é¢å¥½åƒéƒ½æœ‰æ²¡æœ‰elasticsearchè¿™ä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦è‡ªå·±åˆ›å»ºä¸€ä¸ª</span><br><span class="line">1</span><br></pre></td></tr></table></figure><ul><li>åœ¨æ–‡ä»¶é‡Œé¢å†™å…¥shellè„šæœ¬</li></ul><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"><span class="comment">#chkconfig: 2345 80 05</span></span><br><span class="line"><span class="comment">#description: elasticsearch</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Java Env</span></span><br><span class="line">export JAVA_HOME=/usr/java</span><br><span class="line">export CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/lib/dt.jar:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</span><br><span class="line">export PATH=<span class="variable">$PATH:</span><span class="variable">$JAVA_HOME</span>/bin</span><br><span class="line"> </span><br><span class="line">case <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">    su es&lt;&lt;!</span><br><span class="line">    cd /opt/es</span><br><span class="line">    ./bin/elasticsearch <span class="literal">-d</span></span><br><span class="line">!</span><br><span class="line">    echo <span class="string">"elasticsearch startup"</span></span><br><span class="line">    ;;  </span><br><span class="line">stop)</span><br><span class="line">    es_pid=`ps aux|grep elasticsearch | grep <span class="literal">-v</span> <span class="string">'grep elasticsearch'</span> | awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line">    kill <span class="literal">-9</span> <span class="variable">$es_pid</span></span><br><span class="line">    echo <span class="string">"elasticsearch stopped"</span></span><br><span class="line">    ;;  </span><br><span class="line">restart)</span><br><span class="line">    es_pid=`ps aux|grep elasticsearch | grep <span class="literal">-v</span> <span class="string">'grep elasticsearch'</span> | awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line">    kill <span class="literal">-9</span> <span class="variable">$es_pid</span></span><br><span class="line">    echo <span class="string">"elasticsearch stopped"</span></span><br><span class="line">    su es&lt;&lt;!</span><br><span class="line">    cd /opt/es</span><br><span class="line">    ./bin/elasticsearch <span class="literal">-d</span></span><br><span class="line">!</span><br><span class="line">    echo <span class="string">"elasticsearch startup"</span></span><br><span class="line">    ;;  </span><br><span class="line">*)</span><br><span class="line">    echo <span class="string">"start|stop|restart"</span></span><br><span class="line">    ;;  </span><br><span class="line">esac</span><br><span class="line"> </span><br><span class="line"><span class="keyword">exit</span> <span class="variable">$</span>?</span><br></pre></td></tr></table></figure><p>ä»£ç ä¸­çš„JAVA_HOMEå’ŒJAVA_BINè·¯å¾„éœ€è¦æ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µå¡«å†™ï¼Œsu esè¿™ä¸ªè¦æ¢æˆè‡ªå·±çš„æœåŠ¡å™¨ç”¨æˆ·åï¼Œcd /usr/local/elasticsearch-7.7.1éœ€è¦æ¢æˆè‡ªå·±esçš„å®é™…å®‰è£…åœ°å€</p><ul><li>åœ¨/etc/init.d/ä¸‹é¢ç»™elasticsearchèµ‹äºˆæ‰§è¡Œæƒé™</li></ul><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">chmod +x elasticsearch</span><br></pre></td></tr></table></figure><ul><li>å°†elasticsearchæ·»åŠ åˆ°å¼€æœºå¯åŠ¨</li></ul><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">chkconfig -<span class="literal">-add</span> elasticsearch</span><br></pre></td></tr></table></figure><ul><li>é‡å¯æœåŠ¡å™¨åœ¨æµè§ˆå™¨ä¸­è¾“å…¥<a href="http://X.X.X.X:9200/å°±å¯ä»¥äº†" target="_blank" rel="noopener">http://X.X.X.X:9200/å°±å¯ä»¥äº†</a></li></ul><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure><p>å°†è„šæœ¬åŠ åœ¨ /etc/rc.localçš„åé¢</p><h5 id="é‡åˆ°çš„æŠ¥é”™"><a href="#é‡åˆ°çš„æŠ¥é”™" class="headerlink" title="é‡åˆ°çš„æŠ¥é”™"></a>é‡åˆ°çš„æŠ¥é”™</h5><p><strong>é”™è¯¯ä¿¡æ¯ï¼š</strong> [1]: max file descriptors [4096] for elasticsearch process is too low, increase to at least [65535]</p><p>ERROR: [5] bootstrap checks failed</p><p>[1]: max file descriptors [4096] for elasticsearch process is too low, increase to at least [65535]</p><p>[2]: max number of threads [1024] for user [es] is too low, increase to at least [4096]</p><p>[3]: max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]</p><p>ä¿®æ”¹é…ç½®limits.conf</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi /etc/security/limits.conf</span><br></pre></td></tr></table></figure><p>æ·»åŠ é…ç½®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 65536</span><br><span class="line"></span><br><span class="line">* soft nproc 4096</span><br><span class="line">* hard nproc 4096</span><br><span class="line">#ä¿å­˜åéœ€é‡æ–°è¿æ¥æœåŠ¡å™¨</span><br></pre></td></tr></table></figure><h4 id="ElasticHD"><a href="#ElasticHD" class="headerlink" title="ElasticHD"></a>ElasticHD</h4><h5 id="ä¸‹è½½-1"><a href="#ä¸‹è½½-1" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https://github.com/360EntSecGroup-Skylar/ElasticHD/releases</span><br></pre></td></tr></table></figure><h5 id="è§£å‹-1"><a href="#è§£å‹-1" class="headerlink" title="è§£å‹"></a>è§£å‹</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">unzip elasticHD_linux_amd64.zip</span><br></pre></td></tr></table></figure><h5 id="è¿›å…¥ç›®å½•"><a href="#è¿›å…¥ç›®å½•" class="headerlink" title="è¿›å…¥ç›®å½•"></a>è¿›å…¥ç›®å½•</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mv ElasticHD /opt/</span><br><span class="line">cd /opt/</span><br></pre></td></tr></table></figure><h5 id="åå°å¯åŠ¨"><a href="#åå°å¯åŠ¨" class="headerlink" title="åå°å¯åŠ¨"></a>åå°å¯åŠ¨</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nohup ./ElasticHD -p 192.168.50.60:9800 &amp;</span><br></pre></td></tr></table></figure><h4 id="Cerebro"><a href="#Cerebro" class="headerlink" title="Cerebro"></a>Cerebro</h4><h5 id="ä¸‹è½½-2"><a href="#ä¸‹è½½-2" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https://github.com/lmenezes/cerebro/releases/download/v0.9.2/cerebro-0.9.2.tgz</span><br></pre></td></tr></table></figure><h5 id="è§£å‹-2"><a href="#è§£å‹-2" class="headerlink" title="è§£å‹"></a>è§£å‹</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tar zxvf cerebro-0.9.2.tgz</span><br></pre></td></tr></table></figure><h5 id="ä¿®æ”¹é…ç½®"><a href="#ä¿®æ”¹é…ç½®" class="headerlink" title="ä¿®æ”¹é…ç½®"></a>ä¿®æ”¹é…ç½®</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim cerebro-0.9.2/conf/application.conf</span><br></pre></td></tr></table></figure><ul><li><strong>basePath</strong>: å®šä¹‰è®¿é—®è·¯å¾„ é»˜è®¤ä¸º/</li><li><strong>pidfile.path</strong>: pidè·¯å¾„</li><li><strong>data.path</strong>: æ•°æ®å­˜æ”¾ä½ç½®</li><li><strong>server.http.port</strong>: è®¿é—®ç«¯å£ é»˜è®¤ä¸º9000</li><li><strong>network.host</strong>: ç»‘å®šåœ°å€</li><li><strong>username</strong>: ç™»å½•ç”¨æˆ·å</li><li><strong>password</strong>: ç™»å½•å¯†ç </li><li><strong>host</strong>: esé›†ç¾¤åœ°å€</li><li><strong>name</strong>: æ ‡è¯† ä¸€èˆ¬ç”¨ESçš„cluster_name</li></ul><p>ç¤ºä¾‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># Secret will be used to sign session cookies, CSRF tokens and for other encryption utilities.</span><br><span class="line"># It is highly recommended to change this value before running cerebro in production.</span><br><span class="line">secret = &quot;ki:s:[[@=Ag?QI`W2jMwkY:eqvrJ]JqoJyi2axj3ZvOv^/KavOT4ViJSv?6YY4[N&quot;</span><br><span class="line"></span><br><span class="line"># Application base path</span><br><span class="line">basePath = &quot;/cerebro/&quot;</span><br><span class="line"></span><br><span class="line"># Defaults to RUNNING_PID at the root directory of the app.</span><br><span class="line"># To avoid creating a PID file set this value to /dev/null</span><br><span class="line">#pidfile.path = &quot;/var/run/cerebro.pid&quot;</span><br><span class="line">pidfile.path=/dev/null</span><br><span class="line"></span><br><span class="line"># Rest request history max size per user</span><br><span class="line">rest.history.size = 50 // defaults to 50 if not specified</span><br><span class="line"></span><br><span class="line"># Path of local database file</span><br><span class="line">#data.path: &quot;/var/lib/cerebro/cerebro.db&quot;</span><br><span class="line">data.path = &quot;./cerebro.db&quot;</span><br><span class="line"></span><br><span class="line">play &#123;</span><br><span class="line">  # Cerebro port, by default it&apos;s 9000 (play&apos;s default)</span><br><span class="line">  server.http.port = $&#123;?CEREBRO_PORT&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">es = &#123;</span><br><span class="line">  gzip = true</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Authentication</span><br><span class="line">auth = &#123;</span><br><span class="line">  # either basic or ldap</span><br><span class="line">  type: basic</span><br><span class="line">  settings: &#123;</span><br><span class="line">    # Basic auth</span><br><span class="line">    username = &quot;gzlp&quot;</span><br><span class="line">    password = &quot;gzlplink&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># A list of known hosts</span><br><span class="line">hosts = [</span><br><span class="line">&#123; </span><br><span class="line">host = &quot;http://172.17.53.225:9100&quot;</span><br><span class="line">name = &quot;gzlp-elasticsearch&quot;</span><br><span class="line">&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h5 id="åå°å¯åŠ¨-1"><a href="#åå°å¯åŠ¨-1" class="headerlink" title="åå°å¯åŠ¨"></a>åå°å¯åŠ¨</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#åå°å¯åŠ¨</span><br><span class="line">nohup ./bin/cerebro &amp;</span><br></pre></td></tr></table></figure><h4 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a>Logstash</h4><h5 id="é‡‡é›†æ—¥å¿—"><a href="#é‡‡é›†æ—¥å¿—" class="headerlink" title="é‡‡é›†æ—¥å¿—"></a>é‡‡é›†æ—¥å¿—</h5><h6 id="ä¸‹è½½-3"><a href="#ä¸‹è½½-3" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h6><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/logstash/logstash-oss-7.8.0.tar.gz</span><br></pre></td></tr></table></figure><h6 id="è§£å‹-3"><a href="#è§£å‹-3" class="headerlink" title="è§£å‹"></a>è§£å‹</h6><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tar zxvf logstash-oss-7.8.0.tar.gz</span><br></pre></td></tr></table></figure><h6 id="é…ç½®logstash-yml"><a href="#é…ç½®logstash-yml" class="headerlink" title="é…ç½®logstash.yml"></a>é…ç½®logstash.yml</h6><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http.host: &quot;192.168.30.129&quot;</span><br><span class="line">http.port: 9600</span><br></pre></td></tr></table></figure><p>åœ¨binç›®å½•ä¸‹åˆ›å»ºlogstash.confé…ç½®ç´¢å¼•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#================================ input =====================================</span><br><span class="line">input &#123;</span><br><span class="line"> beats &#123;</span><br><span class="line">   port =&gt; 5044</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#================================ output =====================================</span><br><span class="line">output &#123;</span><br><span class="line">  if [fields][docType] == &quot;sys-log&quot; &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts =&gt; [ &quot;172.17.53.226:9101&quot; ]</span><br><span class="line">          ###æ¯å¤©è‡ªåŠ¨åˆ›å»ºsys-log-å¹´æœˆæ—¥çš„ç´¢å¼•ï¼ŒåŒ¹é…åˆ°çš„æ¨¡æ¿æ˜¯sys-log-*</span><br><span class="line">      index =&gt; &quot;sys-log-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if [fields][docType] == &quot;point-log&quot; &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts =&gt; [ &quot;172.17.53.226:9101&quot; ]</span><br><span class="line">      ###æ¯å¤©è‡ªåŠ¨åˆ›å»ºpoint-log-å¹´æœˆæ—¥çš„ç´¢å¼•ï¼ŒåŒ¹é…åˆ°çš„æ¨¡æ¿æ˜¯point-log-*</span><br><span class="line">          index =&gt; &quot;point-log-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">      routing =&gt; &quot;%&#123;type&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if [fields][docType] == &quot;mysqlslowlogs&quot; &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts =&gt; [ &quot;172.17.53.226:9101&quot; ]</span><br><span class="line">          ###æ¯å¤©è‡ªåŠ¨åˆ›å»ºmysql-slowlog-å¹´æœˆæ—¥çš„ç´¢å¼•ï¼ŒåŒ¹é…åˆ°çš„æ¨¡æ¿æ˜¯mysql-slowlog-*</span><br><span class="line">      index =&gt; &quot;mysql-slowlog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">      manage_template =&gt; false</span><br><span class="line">      document_type =&gt; &quot;%&#123;[@metadata][type]&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  if [fields][docType] == &quot;audit-log&quot; &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts =&gt; [&quot;172.17.53.226:9101&quot;]</span><br><span class="line">      manage_template =&gt; false</span><br><span class="line">      index =&gt; &quot;audit-log-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">      document_type =&gt; &quot;%&#123;[@metadata][type]&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#================================ filter =====================================</span><br><span class="line">filter &#123;</span><br><span class="line">  if [type] == &quot;syslog&quot; &#123;</span><br><span class="line">        ##%&#123;è¯­æ³•ï¼šè¯­ä¹‰&#125;</span><br><span class="line">    grok &#123;</span><br><span class="line">      match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;SYSLOGTIMESTAMP:syslog_timestamp&#125; %&#123;SYSLOGHOST:syslog_hostname&#125; %&#123;DATA:syslog_program&#125;(?:\[%&#123;POSINT:syslog_pid&#125;\])?: %&#123;GREEDYDATA:syslog_message&#125;&quot; &#125;</span><br><span class="line">      add_field =&gt; [ &quot;received_at&quot;, &quot;%&#123;@timestamp&#125;&quot; ]</span><br><span class="line">      add_field =&gt; [ &quot;received_from&quot;, &quot;%&#123;host&#125;&quot; ]</span><br><span class="line">    &#125;</span><br><span class="line">    syslog_pri &#123; &#125;</span><br><span class="line">    date &#123;</span><br><span class="line">      match =&gt; [ &quot;syslog_timestamp&quot;, &quot;MMM  d HH:mm:ss&quot;, &quot;MMM dd HH:mm:ss&quot; ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if [fields][docType] == &quot;sys-log&quot; &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">      patterns_dir =&gt; [&quot;/home/logstash-7.8.0/config/patterns&quot;]</span><br><span class="line">      match =&gt; &#123; &quot;message&quot; =&gt; &quot;\[%&#123;NOTSPACE:appName&#125;:%&#123;NOTSPACE:serverIp&#125;:%&#123;NOTSPACE:serverPort&#125;\] %&#123;TIMESTAMP_ISO8601:logTime&#125; %&#123;LOGLEVEL:logLevel&#125; %&#123;WORD:pid&#125; \[%&#123;MYAPPNAME:traceId&#125;\] \[%&#123;MYTHREADNAME:threadName&#125;\] %&#123;NOTSPACE:classname&#125; %&#123;GREEDYDATA:message&#125;&quot; &#125;</span><br><span class="line">      overwrite =&gt; [&quot;message&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">    date &#123;</span><br><span class="line">      match =&gt; [&quot;logTime&quot;,&quot;yyyy-MM-dd HH:mm:ss.SSS Z&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">    date &#123;</span><br><span class="line">      match =&gt; [&quot;logTime&quot;,&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;]</span><br><span class="line">      target =&gt; &quot;timestamp&quot;</span><br><span class="line">      locale =&gt; &quot;en&quot;</span><br><span class="line">      timezone =&gt; &quot;+08:00&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    mutate &#123;</span><br><span class="line">      remove_field =&gt; &quot;logTime&quot;</span><br><span class="line">      remove_field =&gt; &quot;@version&quot;</span><br><span class="line">      remove_field =&gt; &quot;host&quot;</span><br><span class="line">      remove_field =&gt; &quot;offset&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  if [fields][docType] == &quot;point-log&quot; &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">      patterns_dir =&gt; [&quot;/home/logstash-7.8.0/config/patterns&quot;] </span><br><span class="line">        match =&gt; &#123;</span><br><span class="line">        &quot;message&quot; =&gt; &quot;%&#123;TIMESTAMP_ISO8601:logTime&#125;\|%&#123;MYAPPNAME:appName&#125;\|%&#123;WORD:resouceid&#125;\|%&#123;MYAPPNAME:type&#125;\|%&#123;GREEDYDATA:object&#125;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    kv &#123;</span><br><span class="line">        source =&gt; &quot;object&quot;</span><br><span class="line">        field_split =&gt; &quot;&amp;&quot;</span><br><span class="line">        value_split =&gt; &quot;=&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    date &#123;</span><br><span class="line">      match =&gt; [&quot;logTime&quot;,&quot;yyyy-MM-dd HH:mm:ss.SSS Z&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">    date &#123;</span><br><span class="line">      match =&gt; [&quot;logTime&quot;,&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;]</span><br><span class="line">      target =&gt; &quot;timestamp&quot;</span><br><span class="line">      locale =&gt; &quot;en&quot;</span><br><span class="line">      timezone =&gt; &quot;+08:00&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    mutate &#123;</span><br><span class="line">      remove_field =&gt; &quot;message&quot;</span><br><span class="line">      remove_field =&gt; &quot;logTime&quot;</span><br><span class="line">      remove_field =&gt; &quot;@version&quot;</span><br><span class="line">      remove_field =&gt; &quot;host&quot;</span><br><span class="line">      remove_field =&gt; &quot;offset&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  ##mysqlslowlogs</span><br><span class="line">  if [fields][docType] == &quot;mysqlslowlogs&quot; &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">        match =&gt; [</span><br><span class="line">          &quot;message&quot;, &quot;^#\s+User@Host:\s+%&#123;USER:user&#125;\[[^\]]+\]\s+@\s+(?:(?&lt;clienthost&gt;\S*) )?\[(?:%&#123;IP:clientip&#125;)?\]\s+Id:\s+%&#123;NUMBER:id&#125;\n# Query_time: %&#123;NUMBER:query_time&#125;\s+Lock_time: %&#123;NUMBER:lock_time&#125;\s+Rows_sent: %&#123;NUMBER:rows_sent&#125;\s+Rows_examined: %&#123;NUMBER:rows_examined&#125;\nuse\s(?&lt;dbname&gt;\w+);\nSET\s+timestamp=%&#123;NUMBER:timestamp_mysql&#125;;\n(?&lt;query_str&gt;[\s\S]*)&quot;,</span><br><span class="line">          &quot;message&quot;, &quot;^#\s+User@Host:\s+%&#123;USER:user&#125;\[[^\]]+\]\s+@\s+(?:(?&lt;clienthost&gt;\S*) )?\[(?:%&#123;IP:clientip&#125;)?\]\s+Id:\s+%&#123;NUMBER:id&#125;\n# Query_time: %&#123;NUMBER:query_time&#125;\s+Lock_time: %&#123;NUMBER:lock_time&#125;\s+Rows_sent: %&#123;NUMBER:rows_sent&#125;\s+Rows_examined: %&#123;NUMBER:rows_examined&#125;\nSET\s+timestamp=%&#123;NUMBER:timestamp_mysql&#125;;\n(?&lt;query_str&gt;[\s\S]*)&quot;,</span><br><span class="line">          &quot;message&quot;, &quot;^#\s+User@Host:\s+%&#123;USER:user&#125;\[[^\]]+\]\s+@\s+(?:(?&lt;clienthost&gt;\S*) )?\[(?:%&#123;IP:clientip&#125;)?\]\n# Query_time: %&#123;NUMBER:query_time&#125;\s+Lock_time: %&#123;NUMBER:lock_time&#125;\s+Rows_sent: %&#123;NUMBER:rows_sent&#125;\s+Rows_examined: %&#123;NUMBER:rows_examined&#125;\nuse\s(?&lt;dbname&gt;\w+);\nSET\s+timestamp=%&#123;NUMBER:timestamp_mysql&#125;;\n(?&lt;query_str&gt;[\s\S]*)&quot;,</span><br><span class="line">          &quot;message&quot;, &quot;^#\s+User@Host:\s+%&#123;USER:user&#125;\[[^\]]+\]\s+@\s+(?:(?&lt;clienthost&gt;\S*) )?\[(?:%&#123;IP:clientip&#125;)?\]\n# Query_time: %&#123;NUMBER:query_time&#125;\s+Lock_time: %&#123;NUMBER:lock_time&#125;\s+Rows_sent: %&#123;NUMBER:rows_sent&#125;\s+Rows_examined: %&#123;NUMBER:rows_examined&#125;\nSET\s+timestamp=%&#123;NUMBER:timestamp_mysql&#125;;\n(?&lt;query_str&gt;[\s\S]*)&quot;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">    date &#123;</span><br><span class="line">      match =&gt; [&quot;timestamp_mysql&quot;,&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;,&quot;UNIX&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">    date &#123;</span><br><span class="line">      match =&gt; [&quot;timestamp_mysql&quot;,&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;,&quot;UNIX&quot;]</span><br><span class="line">      target =&gt; &quot;timestamp&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    mutate &#123;</span><br><span class="line">      convert =&gt; [&quot;query_time&quot;, &quot;float&quot;]</span><br><span class="line">      convert =&gt; [&quot;lock_time&quot;, &quot;float&quot;]</span><br><span class="line">      convert =&gt; [&quot;rows_sent&quot;, &quot;integer&quot;]</span><br><span class="line">      convert =&gt; [&quot;rows_examined&quot;, &quot;integer&quot;]</span><br><span class="line">      remove_field =&gt; &quot;message&quot;</span><br><span class="line">      remove_field =&gt; &quot;timestamp_mysql&quot;</span><br><span class="line">      remove_field =&gt; &quot;@version&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  ####audit-log</span><br><span class="line">  if [fields][docType] == &quot;audit-log&quot; &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">      patterns_dir =&gt; [&quot;/home/logstash-7.8.0/config/patterns&quot;]</span><br><span class="line">      match =&gt; &#123;</span><br><span class="line">        &quot;message&quot; =&gt; &quot;%&#123;TIMESTAMP_ISO8601:logTime&#125;\|%&#123;MYAPPNAME:appName&#125;\|%&#123;MYTHREADNAME:className&#125;\|%&#123;WORD:methodName&#125;\|%&#123;MYAPPNAME:userId&#125;\|%&#123;MYAPPNAME:userName&#125;\|%&#123;MYAPPNAME:clientId&#125;\|%&#123;GREEDYDATA:operation&#125;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    date &#123;</span><br><span class="line">      match =&gt; [&quot;logTime&quot;,&quot;yyyy-MM-dd HH:mm:ss.SSS Z&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">    date &#123;</span><br><span class="line">      match =&gt; [&quot;logTime&quot;,&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;]</span><br><span class="line">      target =&gt; &quot;timestamp&quot;</span><br><span class="line">      locale =&gt; &quot;en&quot;</span><br><span class="line">      timezone =&gt; &quot;+08:00&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    mutate &#123;</span><br><span class="line">      remove_field =&gt; &quot;message&quot;</span><br><span class="line">      remove_field =&gt; &quot;logTime&quot;</span><br><span class="line">      remove_field =&gt; &quot;@version&quot;</span><br><span class="line">      remove_field =&gt; &quot;host&quot;</span><br><span class="line">      remove_field =&gt; &quot;offset&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•æ ‡å‡†è¾“å…¥è¾“å‡º</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">./bin/logstash -e &apos;input &#123; stdin &#123;&#125; &#125; output &#123; stdout &#123; codec =&gt; rubydebug&#125; &#125;&apos;</span><br><span class="line"></span><br><span class="line">#è¾“å…¥</span><br><span class="line">hellword</span><br><span class="line"></span><br><span class="line">#è¾“å‡ºç»“æœ</span><br><span class="line">&#123;</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">          &quot;host&quot; =&gt; &quot;iZ2zehsi01vpevu3usi6etZ&quot;,</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2020-07-09T02:49:10.957Z,</span><br><span class="line">       &quot;message&quot; =&gt; &quot;helloword&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•è¾“å‡ºåˆ°æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">./bin/logstash -e &apos;input &#123; stdin&#123;&#125; &#125; output &#123; file &#123; path =&gt; &quot;/tmp/log-%&#123;+YYYY.MM.dd&#125;messages.gz&quot;&#125;&#125;&apos;</span><br><span class="line"></span><br><span class="line">#è¾“å…¥</span><br><span class="line">hellword</span><br><span class="line"></span><br><span class="line">#è¾“å‡ºç»“æœ</span><br><span class="line">tail /tmp/log-2020.07.09messages.gz </span><br><span class="line"></span><br><span class="line">&#123;&quot;host&quot;:&quot;iZ2zehsi01vpevu3usi6etZ&quot;,&quot;message&quot;:&quot;helloword&quot;,&quot;@version&quot;:&quot;1&quot;,&quot;@timestamp&quot;:&quot;2020-07-09T02:50:01.682Z&quot;&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•è¾“å‡ºåˆ°elasticsearch</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">./bin/logstash -e &apos;input &#123;  stdin&#123;&#125; &#125; output &#123; elasticsearch &#123;hosts =&gt; [&quot;172.17.53.225:9100&quot;] index =&gt; &quot;mytest-%&#123;+YYYY.MM.dd&#125;&quot; &#125;&#125;&apos;</span><br><span class="line"></span><br><span class="line">#åœ¨esæœåŠ¡ç›®å½•æŸ¥çœ‹</span><br><span class="line">ll /home/elasticsearch/data/nodes/0/indices/</span><br><span class="line">total 4</span><br><span class="line">drwxr-xr-x 4 es es 4096 Jul  9 10:55 mKYuiHd9Tj-qIH_h1sda9A</span><br></pre></td></tr></table></figure><p>åˆ›å»ºæ¨¡ç‰ˆ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -XPUT http://172.17.53.226:9101/_template/template_sys_log -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">&quot;index_patterns&quot; : [&quot;sys-log-*&quot;],</span><br><span class="line">&quot;order&quot; : 0,</span><br><span class="line">&quot;settings&quot; : &#123;</span><br><span class="line">&quot;number_of_replicas&quot; : 0</span><br><span class="line">&#125;,</span><br><span class="line">&quot;mappings&quot;: &#123;</span><br><span class="line">&quot;properties&quot;: &#123;</span><br><span class="line">&quot;message&quot;: &#123;</span><br><span class="line">&quot;type&quot;: &quot;text&quot;,</span><br><span class="line">&quot;fields&quot;: &#123;</span><br><span class="line">&quot;keyword&quot;: &#123;</span><br><span class="line">&quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">&quot;ignore_above&quot;: 256</span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;analyzer&quot;: &quot;ik_max_word&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;pid&quot;: &#123;</span><br><span class="line">&quot;type&quot;: &quot;text&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;serverPort&quot;: &#123;</span><br><span class="line">&quot;type&quot;: &quot;text&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;logLevel&quot;: &#123;</span><br><span class="line">&quot;type&quot;: &quot;text&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;traceId&quot;: &#123;</span><br><span class="line">&quot;type&quot;: &quot;text&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;&apos; --header &quot;Content-Type: application/json&quot;</span><br><span class="line"></span><br><span class="line">curl -XPUT http://172.17.53.226:9101/_template/template_point_log -d &apos;</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&quot;index_patterns&quot; : [&quot;point-log-*&quot;],</span><br><span class="line"></span><br><span class="line">&quot;order&quot; : 0,</span><br><span class="line"></span><br><span class="line">&quot;settings&quot; : &#123;</span><br><span class="line"></span><br><span class="line">&quot;number_of_replicas&quot; : 0</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;&apos; --header &quot;Content-Type: application/json&quot;</span><br></pre></td></tr></table></figure><p>åœ¨configç›®å½•ä¸‹åˆ›å»ºpatternsç›®å½•,åœ¨ç›®å½•ä¸‹åˆ›å»ºmepattern.txt</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># user-center</span><br><span class="line">MYAPPNAME ([0-9a-zA-Z_-]*)</span><br><span class="line"># RMI TCP Connection(2)-127.0.0.1</span><br><span class="line">MYTHREADNAME ([0-9a-zA-Z._-]|\(|\)|\s)*</span><br></pre></td></tr></table></figure><p>åœ¨binç›®å½•ä¸‹å¯åŠ¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">./logstash -f logstash.conf</span><br></pre></td></tr></table></figure><h5 id="åŒæ­¥mysql"><a href="#åŒæ­¥mysql" class="headerlink" title="åŒæ­¥mysql"></a>åŒæ­¥mysql</h5><p>éœ€è¦ä¾èµ–mysql-connector-java-5.1.49.jar</p><p>åœ¨binç›®å½•ä¸‹åˆ›å»ºjdbc.confé…ç½®ç´¢å¼•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># è¾“å…¥éƒ¨åˆ†</span><br><span class="line">input &#123;</span><br><span class="line">  stdin &#123;&#125;</span><br><span class="line">  jdbc &#123;</span><br><span class="line">    jdbc_default_timezone =&gt;&quot;Asia/Shanghai&quot; </span><br><span class="line">   </span><br><span class="line">    # mysqlæ•°æ®åº“é©±åŠ¨</span><br><span class="line">    jdbc_driver_library =&gt; &quot;//root/mysql-connector-java-5.1.49.jar&quot;</span><br><span class="line">    jdbc_driver_class =&gt; &quot;com.mysql.jdbc.Driver&quot;</span><br><span class="line">    # mysqlæ•°æ®åº“é“¾æ¥ï¼Œæ•°æ®åº“å</span><br><span class="line">    jdbc_connection_string =&gt; &quot;jdbc:mysql://219.128.77.86:7000/nethospital&quot;</span><br><span class="line">    # mysqlæ•°æ®åº“ç”¨æˆ·åï¼Œå¯†ç </span><br><span class="line">    jdbc_user =&gt; &quot;hospitalTest&quot;</span><br><span class="line">    jdbc_password =&gt; &quot;Liangjian123360@8899&quot;</span><br><span class="line"></span><br><span class="line">    # è®¾ç½®ç›‘å¬é—´éš”  å„å­—æ®µå«ä¹‰ï¼ˆåˆ†ã€æ—¶ã€å¤©ã€æœˆã€å¹´ï¼‰ï¼Œå…¨éƒ¨ä¸º*é»˜è®¤å«ä¹‰ä¸ºæ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡</span><br><span class="line">    schedule =&gt; &quot;* * * * *&quot;</span><br><span class="line"></span><br><span class="line">    # åˆ†é¡µ</span><br><span class="line">    jdbc_paging_enabled =&gt; &quot;true&quot;</span><br><span class="line">    # åˆ†é¡µå¤§å°</span><br><span class="line">    jdbc_page_size =&gt; &quot;50000&quot;</span><br><span class="line"></span><br><span class="line">    # sqlè¯­å¥æ‰§è¡Œæ–‡ä»¶ï¼Œä¹Ÿå¯ç›´æ¥ä½¿ç”¨sql</span><br><span class="line">        statement =&gt; &apos;select id,name,level,hospital_phone,update_time from h_hospital_outer WHERE update_time&gt;=:sql_last_value order by update_time asc&apos;</span><br><span class="line">    # statement_filepath =&gt; &quot;/usr/local/logstash-6.4.2/config/jdbc.sql&quot;</span><br><span class="line"></span><br><span class="line">    # elasticsearchç´¢å¼•ç±»å‹å</span><br><span class="line">    type =&gt; &quot;hospital_outer_index&quot;</span><br><span class="line"></span><br><span class="line">        # æ˜¯å¦è®°å½•ä¸Šæ¬¡æ‰§è¡Œç»“æœï¼Œtrueè¡¨ç¤ºä¼šå°†ä¸Šæ¬¡æ‰§è¡Œç»“æœçš„tracking_columnå­—æ®µçš„å€¼ä¿å­˜åˆ°last_run_metadata_pathæŒ‡å®šçš„æ–‡ä»¶ä¸­ï¼›</span><br><span class="line">        record_last_run =&gt; true</span><br><span class="line">        # éœ€è¦è®°å½•æŸ¥è¯¢ç»“æœæŸå­—æ®µçš„å€¼æ—¶ï¼Œæ­¤å­—æ®µä¸ºtrueã€‚</span><br><span class="line">        use_column_value =&gt; true</span><br><span class="line">        # éœ€è¦è®°å½•çš„å­—æ®µï¼Œç”¨äºå¢é‡åŒæ­¥ï¼Œéœ€æ˜¯æ•°æ®åº“å­—æ®µ</span><br><span class="line">        tracking_column =&gt; &quot;update_time&quot;</span><br><span class="line">        # é€’å¢å­—æ®µçš„ç±»å‹ï¼Œnumeric è¡¨ç¤ºæ•°å€¼ç±»å‹, timestamp è¡¨ç¤ºæ—¶é—´æˆ³ç±»å‹</span><br><span class="line">        tracking_column_type =&gt; timestamp</span><br><span class="line">        # åŒæ­¥ç‚¹æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶è®°å½•äº†ä¸Šæ¬¡çš„åŒæ­¥ç‚¹ï¼Œé‡å¯æ—¶ä¼šè¯»å–è¿™ä¸ªæ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶å¯ä»¥æ‰‹åŠ¨ä¿®æ”¹</span><br><span class="line">        last_run_metadata_path =&gt; &quot;/opt/logstash-7.8.0/config/hospital_outer_index_id&quot;</span><br><span class="line">        # æ˜¯å¦æ¸…é™¤last_run_metadata_pathçš„è®°å½•ï¼Œéœ€è¦å¢é‡åŒæ­¥æ—¶æ­¤å­—æ®µå¿…é¡»ä¸ºfalseï¼›</span><br><span class="line">        clean_run =&gt; false</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">input &#123;</span><br><span class="line">  stdin &#123;&#125;</span><br><span class="line">  jdbc &#123;</span><br><span class="line">    jdbc_default_timezone =&gt;&quot;Asia/Shanghai&quot; </span><br><span class="line">          </span><br><span class="line">    # mysqlæ•°æ®åº“é©±åŠ¨</span><br><span class="line">    jdbc_driver_library =&gt; &quot;//root/mysql-connector-java-5.1.49.jar&quot;</span><br><span class="line">    jdbc_driver_class =&gt; &quot;com.mysql.jdbc.Driver&quot;</span><br><span class="line">    # mysqlæ•°æ®åº“é“¾æ¥ï¼Œæ•°æ®åº“å</span><br><span class="line">    jdbc_connection_string =&gt; &quot;jdbc:mysql://219.128.77.86:7000/nethospital&quot;</span><br><span class="line">    # mysqlæ•°æ®åº“ç”¨æˆ·åï¼Œå¯†ç </span><br><span class="line">    jdbc_user =&gt; &quot;hospitalTest&quot;</span><br><span class="line">    jdbc_password =&gt; &quot;Liangjian123360@8899&quot;</span><br><span class="line">    # è®¾ç½®ç›‘å¬é—´éš”  å„å­—æ®µå«ä¹‰ï¼ˆåˆ†ã€æ—¶ã€å¤©ã€æœˆã€å¹´ï¼‰ï¼Œå…¨éƒ¨ä¸º*é»˜è®¤å«ä¹‰ä¸ºæ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡</span><br><span class="line">    schedule =&gt; &quot;0 2 * * *&quot;</span><br><span class="line">    # åˆ†é¡µ</span><br><span class="line">    jdbc_paging_enabled =&gt; &quot;true&quot;</span><br><span class="line">    # åˆ†é¡µå¤§å°</span><br><span class="line">    jdbc_page_size =&gt; &quot;50000&quot;</span><br><span class="line">    # sqlè¯­å¥æ‰§è¡Œæ–‡ä»¶ï¼Œä¹Ÿå¯ç›´æ¥ä½¿ç”¨ statement =&gt; &apos;select * from h_hospital_outer&apos;</span><br><span class="line">        statement =&gt; &apos;select id,name,level,hospital_phone from h_hospital_outer&apos;</span><br><span class="line">    # statement_filepath =&gt; &quot;/usr/local/logstash-6.4.2/config/jdbc.sql&quot;</span><br><span class="line">    # elasticsearchç´¢å¼•ç±»å‹å</span><br><span class="line">    type =&gt; &quot;hospital_outer_index&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># è¿‡æ»¤éƒ¨åˆ†(ä¸æ˜¯å¿…é¡»é¡¹ï¼‰</span><br><span class="line">filter &#123;</span><br><span class="line">    ruby &#123; </span><br><span class="line">                code =&gt; &quot;event.set(&apos;timestamp&apos;, event.get(&apos;@timestamp&apos;).time.localtime + 8*60*60)&quot; </span><br><span class="line">        &#125;</span><br><span class="line">        ruby &#123;</span><br><span class="line">                code =&gt; &quot;event.set(&apos;@timestamp&apos;,event.get(&apos;timestamp&apos;))&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        ruby &#123;</span><br><span class="line">                code =&gt; &quot;event.set(&apos;update_time&apos;,event.get(&apos;timestamp&apos;))&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        ruby &#123;</span><br><span class="line">                code =&gt; &quot;event.set(&apos;create_time&apos;,event.get(&apos;timestamp&apos;))&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        mutate &#123;</span><br><span class="line">                remove_field =&gt; [&quot;timestamp&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># è¾“å‡ºéƒ¨åˆ†</span><br><span class="line">output &#123;</span><br><span class="line">        if  [type] == &quot;hospital_outer_index&quot; &#123;</span><br><span class="line">                elasticsearch &#123;</span><br><span class="line">                        # elasticsearchç´¢å¼•å</span><br><span class="line">                        index =&gt; &quot;hospital_outer_index&quot;</span><br><span class="line">                        # ä½¿ç”¨inputä¸­çš„typeä½œä¸ºelasticsearchç´¢å¼•ä¸‹çš„ç±»å‹å</span><br><span class="line">                        document_type =&gt; &quot;%&#123;type&#125;&quot;   # &lt;- use the type from each input</span><br><span class="line">                        # elasticsearchçš„ipå’Œç«¯å£å·</span><br><span class="line">                        hosts =&gt; &quot;192.168.50.60:9000&quot;</span><br><span class="line">                        # åŒæ­¥mysqlä¸­æ•°æ®idä½œä¸ºelasticsearchä¸­æ–‡æ¡£id</span><br><span class="line">                        document_id =&gt; &quot;%&#123;id&#125;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stdout &#123;</span><br><span class="line">                codec =&gt; json_lines</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨binç›®å½•ä¸‹å¯åŠ¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">./logstash -f jdbc.conf</span><br></pre></td></tr></table></figure><h5 id="é‡åˆ°çš„æŠ¥é”™-1"><a href="#é‡åˆ°çš„æŠ¥é”™-1" class="headerlink" title="é‡åˆ°çš„æŠ¥é”™"></a>é‡åˆ°çš„æŠ¥é”™</h5><p>Error: Bad file descriptor - Bad file descriptor Exceptioné”™è¯¯</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">æŸ¥çœ‹dataä¸‹çš„æ˜¯å¦æœ‰.lockæ–‡ä»¶</span><br><span class="line">[root@es-1 ~]# ls -all /opt/logstash-7.8.0/data/</span><br><span class="line">total 4</span><br><span class="line">drwxr-xr-x.  4  631  503  69 Nov 13 12:58 .</span><br><span class="line">drwxr-xr-x. 12  631  503 253 Nov 12 17:31 ..</span><br><span class="line">drwxr-xr-x.  2 root root   6 Nov 12 17:31 dead_letter_queue</span><br><span class="line">-rw-r--r--.  1 root root   0 Nov 13 12:58 .lock</span><br><span class="line">drwxr-xr-x.  2 root root   6 Nov 12 17:31 queue</span><br><span class="line">-rw-r--r--.  1 root root  36 Nov 12 17:31 uuid</span><br><span class="line"></span><br><span class="line">åˆ é™¤.lockæ–‡ä»¶é‡æ–°å¯åŠ¨å³å¯</span><br></pre></td></tr></table></figure><p>æ—¥å¿—å‡ºç°æŠ¥é”™:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[logstash.outputs.elasticsearch] retrying failed action with response code: 403 (&#123;&quot;type&quot;=&gt;&quot;cluster_block_exception&quot;, &quot;reason&quot;=&gt;&quot;blocked by: [FORBIDDEN/12/index read-only / allow delete (api)];&quot;&#125;)</span><br></pre></td></tr></table></figure><p>ESè¯´æ˜æ–‡æ¡£:å½“ESæ•°æ®æ‰€åœ¨ç›®å½•ç£ç›˜ç©ºé—´ä½¿ç”¨ç‡è¶…è¿‡90%åï¼ŒESå°†ä¿®æ”¹ä¸ºåªè¯»çŠ¶æ€ï¼Œæ‰€ä»¥åˆæ­¥åˆ¤æ–­æ˜¯ç£ç›˜ç©ºé—´ä¸è¶³å¯¼è‡´ESä¸å…è®¸å†™å…¥ã€‚</p><p>è§£å†³:</p><p>æœåŠ¡å™¨ç£ç›˜ç©ºé—´å¯¼è‡´,æ¸…ç†æœåŠ¡å™¨ç£ç›˜ç©ºé—´è¿˜æ˜¯å‡ºç°è¯¥æŠ¥é”™é—®é¢˜</p><p>æ€€ç–‘ä¸ºesç´¢å¼•å¯¼è‡´çš„ä¸èƒ½åŒæ­¥æ•°æ®</p><p><strong>è§£å†³åŠæ³•1 åœ¨kibanaå¼€å‘æ§åˆ¶å°æ‰§è¡Œä¸‹é¢è¯­å¥å³å¯</strong></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PUT _settings</span><br><span class="line">    &#123;</span><br><span class="line">    &quot;index&quot;: &#123;</span><br><span class="line">    &quot;blocks&quot;: &#123;</span><br><span class="line">    &quot;read_only_allow_delete&quot;: &quot;false&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>è§£å†³æ–¹æ³•2</strong></p><p>å¦‚æœkibanaæ— æ³•æ‰§è¡Œå‘½ä»¤ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤è§£å†³</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -XPUT -H &quot;Content-Type: application/json&quot; http://localhost:9200/_all/_settings -d &apos;&#123;&quot;index.blocks.read_only_allow_delete&quot;: null&#125;&apos;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ç´¢å¼•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl http://192.168.50.70:9200/_cat/indices?v</span><br><span class="line">health status index                uuid                   pri rep docs.count docs.deleted store.size pri.store.size</span><br><span class="line">yellow open   h_hospital_outer     N4hbdo5TQnSazNx58_a5Qg   5   1     433934       126728    161.3mb        161.3mb</span><br><span class="line">yellow open   m_medicine_info      swwieAn-TNG3FTTvpOlxwg   5   1      36556         1699     41.3mb         41.3mb</span><br><span class="line">green  open   .kibana_1            OQh5HFwsRDSG0QAPKasZyg   1   0          1            0      3.7kb          3.7kb</span><br><span class="line">yellow open   recommend_doctor_rsp vpIMBifjSySYU6h0j9nM-A   5   1        609            1    983.8kb        983.8kb</span><br></pre></td></tr></table></figure><p>åˆ é™¤ç´¢å¼•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -XDELETE localhost:9200/ç´¢å¼•å</span><br><span class="line">ä¾‹å¦‚:</span><br><span class="line">curl -XDELETE http://192.168.50.70:9200/m_medicine_info</span><br><span class="line">curl -XDELETE http://192.168.50.70:9200/h_hospital_outer</span><br><span class="line">curl -XDELETE http://192.168.50.70:9200/recommend_doctor_rsp</span><br><span class="line">curl -XDELETE http://192.168.50.70:9200/.kibana_1</span><br></pre></td></tr></table></figure><p>å†æ¬¡å¯åŠ¨logstash,æ— æŠ¥é”™,è·Ÿç”Ÿäº§ç´¢å¼•è¿›è¡Œå¯¹æ¯”å‘ç°,æœ‰ç¼ºå°‘,ä½¿ç”¨æ¥å£è¿›è¡Œè§¦å‘</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">esæœåŠ¡</span><br><span class="line">åŒ»ç”Ÿæ¨¡æ¿ç”Ÿæˆæ¥å£ï¼š/api/es/doctor/refreshIndexAndDate</span><br><span class="line">è§†é¢‘/æ–‡ç« æ¨¡æ¿ç”Ÿæˆæ¥å£ï¼š/app/video/article/refreshIndexAndDate</span><br><span class="line">è§†é¢‘æ¨¡æ¿ç”Ÿæˆæ¥å£(å·²æœªä½¿ç”¨):/app/video/refreshIndexAndDate</span><br><span class="line"></span><br><span class="line">è¯·æ±‚ç¤ºä¾‹:</span><br><span class="line">curl http://127.0.0.1:8908/app/video/article/refreshIndexAndDate</span><br><span class="line"></span><br><span class="line">jobæœåŠ¡</span><br><span class="line">åŒ»ç”Ÿeså…¨é‡åŒæ­¥:/job/doctor/synAllDoctorDates</span><br><span class="line">è§†é¢‘/æ–‡ç« å…¨é‡åŒæ­¥:/job/video/article/synAll</span><br><span class="line">è§†é¢‘å…¨é‡åŒæ­¥: /job/ljVideo/synAllVideo</span><br><span class="line"></span><br><span class="line">è¯·æ±‚ç¤ºä¾‹:</span><br><span class="line">curl http://127.0.0.1:8092/job/doctor/synAllDoctorDates</span><br></pre></td></tr></table></figure><p>åœ¨å®¹å™¨çš„ç»ˆç«¯è¿›è¡Œè§¦å‘æ—¶,å‡ºç°é”™è¯¯</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Elasticsearchï¼šNone of the configured nodes are available:[&#123;#transport#-1&#125;</span><br></pre></td></tr></table></figure><p>æ’æŸ¥é—®é¢˜å‘ç°,é€šè¿‡nginxå¤–æ”¾çš„ç«¯å£æ˜ å°„ä¸º192.168.50.70:9200.</p><p>9200 æ˜¯ESèŠ‚ç‚¹ä¸å¤–éƒ¨é€šè®¯ä½¿ç”¨çš„ç«¯å£ã€‚å®ƒæ˜¯httpåè®®çš„RESTfulæ¥å£,å„ç§CRUDæ“ä½œéƒ½æ˜¯èµ°çš„è¯¥ç«¯å£</p><p>9300æ˜¯ESèŠ‚ç‚¹ä¹‹é—´é€šè®¯ä½¿ç”¨çš„ç«¯å£ã€‚å®ƒæ˜¯tcpé€šè®¯ç«¯å£ï¼Œé›†ç¾¤é—´å’ŒTCPclientéƒ½èµ°çš„å®ƒã€‚javaç¨‹åºä¸­ä½¿ç”¨ESæ—¶ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­è¦é…ç½®è¯¥ç«¯å£</p><p>æ›´æ”¹nginxçš„ç«¯å£æ˜ å°„ä¸º9300</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">stream &#123;</span><br><span class="line">    upstream es &#123;</span><br><span class="line">       server 192.168.50.70:9300 weight=1 max_fails=2 fail_timeout=120s;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen  3304;</span><br><span class="line">        proxy_connect_timeout 10s;</span><br><span class="line">        proxy_timeout 300s;#è®¾ç½®å®¢æˆ·ç«¯å’Œä»£ç†æœåŠ¡ä¹‹é—´çš„è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœ5åˆ†é’Ÿå†…æ²¡æ“ä½œå°†è‡ªåŠ¨æ–­å¼€ã€‚</span><br><span class="line">        proxy_pass es;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åç«¯å†æ¬¡è¯·æ±‚æ¥å£åŒæ­¥æ•°æ®æ­£å¸¸</p><p>å†æ¬¡æŸ¥çœ‹ç´¢å¼•,ç´¢å¼•éƒ½å·²ç»æ­£å¸¸åˆ›å»º</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@monitor ~]# curl http://192.168.50.70:9200/_cat/indices?v</span><br><span class="line">health status index                uuid                   pri rep docs.count docs.deleted store.size pri.store.size</span><br><span class="line">yellow open   app_video_article    -tQTMGs4SCKoLtNMJf-Aqw   5   1       2282            0      2.2mb          2.2mb</span><br><span class="line">yellow open   h_hospital_outer     N4hbdo5TQnSazNx58_a5Qg   5   1     433934       126728    161.3mb        161.3mb</span><br><span class="line">yellow open   m_medicine_info      swwieAn-TNG3FTTvpOlxwg   5   1      36556         1699     41.3mb         41.3mb</span><br><span class="line">green  open   .kibana_1            OQh5HFwsRDSG0QAPKasZyg   1   0          1            0      3.7kb          3.7kb</span><br><span class="line">yellow open   recommend_doctor_rsp vpIMBifjSySYU6h0j9nM-A   5   1        609            1    983.8kb        983.8kb</span><br><span class="line">yellow open   mini_doctor_list     q0DGDN1_SZeIXyAeTNu8Dw   5   1          0            0      1.2kb          1.2kb</span><br></pre></td></tr></table></figure><h4 id="filebeat"><a href="#filebeat" class="headerlink" title="filebeat"></a>filebeat</h4><h5 id="ä¸‹è½½-4"><a href="#ä¸‹è½½-4" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https://mirrors.huaweicloud.com/filebeat/7.8.0/filebeat-7.8.0-x86_64.rpm</span><br></pre></td></tr></table></figure><h5 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rpm -Uvh filebeat-7.8.0-x86_64.rpm</span><br></pre></td></tr></table></figure><p>é…ç½®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi /etc/filebeat/filebeat.yml</span><br><span class="line"></span><br><span class="line">filebeat.inputs:</span><br><span class="line"></span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  # æ£€æŸ¥æ–‡ä»¶æ›´æ–°çš„é¢‘ç‡ï¼Œé»˜è®¤æ˜¯ 10s</span><br><span class="line">  scan_frequency: 10s</span><br><span class="line">  #å¿½ç•¥è¿‡å» ignore_older æ—¶é—´æ²¡æœ‰ä¿®æ”¹çš„æ–‡ä»¶,0(ç¦ç”¨),2h(2å°æ—¶),5m(5åˆ†é’Ÿ),168h(1å‘¨)</span><br><span class="line">  ignore_older: 0</span><br><span class="line">  # å…³é—­è¿‡å» close_inactive æ—¶é—´éæ´»åŠ¨çŠ¶æ€çš„æ–‡ä»¶çš„ harvester</span><br><span class="line">  close_inactive: 2m</span><br><span class="line">  #å•æ–‡ä»¶æœ€å¤§æ”¶é›†çš„å­—èŠ‚æ•°,è¶…è¿‡å°†è¢«ä¸¢å¼ƒï¼Œé»˜è®¤10MB=10485760ï¼Œ60MB=62914560,å¿…é¡»å¤§äºå•æ–‡ä»¶æœ€å¤§å¤§å°</span><br><span class="line">  max_bytes: 62914560</span><br><span class="line">  #æ¯ä¸ªharvesteråœ¨è·å–æ–‡ä»¶æ—¶ä½¿ç”¨çš„ç¼“å†²åŒºå¤§å°å­—èŠ‚æ•°ï¼Œé»˜è®¤å€¼æ˜¯16384,1MB=1048576â€¬</span><br><span class="line">  harvester_buffer_size: 1048576â€¬</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/java/*/app.*log</span><br><span class="line">  #exclude_lines: [&apos;\s^DEBUG\s\d&apos;]</span><br><span class="line">  #fields_under_root: true</span><br><span class="line">  fields:</span><br><span class="line">    docType: sys-log</span><br><span class="line">    project: microservices-platform</span><br><span class="line">  multiline:</span><br><span class="line">    #pattern: &apos;^\[\S+:\S+:\d&#123;2,&#125;] &apos;</span><br><span class="line">    pattern: &apos;^\[&apos;</span><br><span class="line">    negate: true</span><br><span class="line">    match: after</span><br><span class="line">    </span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  # æ£€æŸ¥æ–‡ä»¶æ›´æ–°çš„é¢‘ç‡ï¼Œé»˜è®¤æ˜¯ 10s</span><br><span class="line">  scan_frequency: 15s</span><br><span class="line">  #å¿½ç•¥è¿‡å» ignore_older æ—¶é—´æ²¡æœ‰ä¿®æ”¹çš„æ–‡ä»¶,0(ç¦ç”¨),2h(2å°æ—¶),5m(5åˆ†é’Ÿ),168h(1å‘¨)</span><br><span class="line">  ignore_older: 0</span><br><span class="line">  # å…³é—­è¿‡å» close_inactive æ—¶é—´éæ´»åŠ¨çŠ¶æ€çš„æ–‡ä»¶çš„ harvester</span><br><span class="line">  close_inactive: 2m</span><br><span class="line">  #å•æ–‡ä»¶æœ€å¤§æ”¶é›†çš„å­—èŠ‚æ•°,è¶…è¿‡å°†è¢«ä¸¢å¼ƒï¼Œé»˜è®¤10MB=10485760ï¼Œ60MB=62914560,å¿…é¡»å¤§äºå•æ–‡ä»¶æœ€å¤§å¤§å°</span><br><span class="line">  max_bytes: 62914560</span><br><span class="line">  #æ¯ä¸ªharvesteråœ¨è·å–æ–‡ä»¶æ—¶ä½¿ç”¨çš„ç¼“å†²åŒºå¤§å°å­—èŠ‚æ•°ï¼Œé»˜è®¤å€¼æ˜¯16384,1MB=1048576â€¬</span><br><span class="line">  harvester_buffer_size: 1048576â€¬</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/java/*/point.*log</span><br><span class="line">  #fields_under_root: true</span><br><span class="line">  fields:</span><br><span class="line">    docType: point-log</span><br><span class="line">    project: microservices-platform</span><br><span class="line">    </span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  # æ£€æŸ¥æ–‡ä»¶æ›´æ–°çš„é¢‘ç‡ï¼Œé»˜è®¤æ˜¯ 10s</span><br><span class="line">  scan_frequency: 20s</span><br><span class="line">  #å¿½ç•¥è¿‡å» ignore_older æ—¶é—´æ²¡æœ‰ä¿®æ”¹çš„æ–‡ä»¶,0(ç¦ç”¨),2h(2å°æ—¶),5m(5åˆ†é’Ÿ),168h(1å‘¨)</span><br><span class="line">  ignore_older: 0</span><br><span class="line">  # å…³é—­è¿‡å» close_inactive æ—¶é—´éæ´»åŠ¨çŠ¶æ€çš„æ–‡ä»¶çš„ harvester</span><br><span class="line">  close_inactive: 2m</span><br><span class="line">  #å•æ–‡ä»¶æœ€å¤§æ”¶é›†çš„å­—èŠ‚æ•°,è¶…è¿‡å°†è¢«ä¸¢å¼ƒï¼Œé»˜è®¤10MB=10485760ï¼Œ60MB=62914560,å¿…é¡»å¤§äºå•æ–‡ä»¶æœ€å¤§å¤§å°</span><br><span class="line">  max_bytes: 62914560</span><br><span class="line">  #æ¯ä¸ªharvesteråœ¨è·å–æ–‡ä»¶æ—¶ä½¿ç”¨çš„ç¼“å†²åŒºå¤§å°å­—èŠ‚æ•°ï¼Œé»˜è®¤å€¼æ˜¯16384,1MB=1048576â€¬</span><br><span class="line">  harvester_buffer_size: 1048576â€¬</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/java/*/audit.*log</span><br><span class="line">  #fields_under_root: true</span><br><span class="line">  fields:</span><br><span class="line">    docType: audit-log</span><br><span class="line">    project: microservices-platform</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">#filebeatå…¨å±€é…ç½®</span><br><span class="line">max_procs: 1</span><br><span class="line">queue.mem:</span><br><span class="line">  #äº‹ä»¶å®¹é‡</span><br><span class="line">  events: 4096</span><br><span class="line">  #ä¸€æ¬¡å‘é€æœ€å°eventæ•°</span><br><span class="line">  flush.min_events: 512</span><br><span class="line">  #ä¸€æ¬¡å‘é€æœ€å¤§min_eventsç­‰å¾…æ—¶é—´</span><br><span class="line">  flush.timeout: 5s</span><br><span class="line"></span><br><span class="line">output.logstash:</span><br><span class="line">  enabled: true</span><br><span class="line">  # The Logstash hosts</span><br><span class="line">  hosts: [&quot;172.17.53.226:5044&quot;]</span><br><span class="line">  bulk_max_size: 2048</span><br><span class="line">  </span><br><span class="line">processors:</span><br><span class="line">  - add_host_metadata: ~</span><br><span class="line">  - add_cloud_metadata: ~</span><br><span class="line">  - add_docker_metadata: ~</span><br><span class="line">  - add_kubernetes_metadata:</span><br><span class="line">      default_indexers.enabled: false</span><br><span class="line">      default_matchers.enabled: false</span><br></pre></td></tr></table></figure><h5 id="å¯åŠ¨"><a href="#å¯åŠ¨" class="headerlink" title="å¯åŠ¨"></a>å¯åŠ¨</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">filebeat -c /etc/filebeat/filebeat.yml -e</span><br><span class="line"></span><br><span class="line">åå°å¯åŠ¨</span><br><span class="line">nohup filebeat -c /etc/filebeat/filebeat.yml -e &gt;filebeat.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><h4 id="kibana"><a href="#kibana" class="headerlink" title="kibana"></a>kibana</h4><p>ä¸‹è½½åœ°å€:<a href="https://www.elastic.co/cn/downloads/kibana-oss" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/kibana-oss</a><br>è§£å‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tar zxvf kibana-oss-7.8.0-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure><h5 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim kibana-oss-7.8.0-linux-x86_64/config/kibana.ymlserver.port: 5600    #ç›‘å¬ç«¯å£server.host: &quot;172.17.53.226&quot;    #ç›‘å¬åœ°å€elasticsearch.hosts: [&quot;http://172.17.53.225:9200&quot;,&quot;http://172.17.53.226:9200&quot;] #elasticsearchæœåŠ¡å™¨åœ°å€</span><br></pre></td></tr></table></figure><h5 id="å¯åŠ¨-1"><a href="#å¯åŠ¨-1" class="headerlink" title="å¯åŠ¨"></a>å¯åŠ¨</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">./bin/kibana --allow-root</span><br></pre></td></tr></table></figure><p><strong>Kibanaæ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†æå’Œå¯è§†åŒ–å¹³å°ï¼Œè®¾è®¡ç”¨äºå’ŒElasticsearchä¸€èµ·å·¥ä½œã€‚</strong></p><ul><li>ä½ ç”¨Kibanaæ¥æœç´¢ï¼ŒæŸ¥çœ‹ï¼Œå¹¶å’Œå­˜å‚¨åœ¨Elasticsearchç´¢å¼•ä¸­çš„æ•°æ®è¿›è¡Œäº¤äº’ã€‚</li><li>ä½ å¯ä»¥è½»æ¾åœ°æ‰§è¡Œé«˜çº§æ•°æ®åˆ†æï¼Œå¹¶ä¸”ä»¥å„ç§å›¾æ ‡ã€è¡¨æ ¼å’Œåœ°å›¾çš„å½¢å¼å¯è§†åŒ–æ•°æ®ã€‚</li><li>Kibanaä½¿å¾—ç†è§£å¤§é‡æ•°æ®å˜å¾—å¾ˆå®¹æ˜“ã€‚å®ƒç®€å•çš„ã€åŸºäºæµè§ˆå™¨çš„ç•Œé¢ä½¿ä½ èƒ½å¤Ÿå¿«é€Ÿåˆ›å»ºå’Œå…±äº«åŠ¨æ€ä»ªè¡¨æ¿ï¼Œå®æ—¶æ˜¾ç¤ºElasticsearchæŸ¥è¯¢çš„å˜åŒ–ã€‚</li></ul><p><strong>Kibanaå¯è§†åŒ–ç®¡ç†é¡µé¢è¯¦ç»†ä½¿ç”¨è¯´æ˜</strong></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Discoverï¼šæ—¥å¿—ç®¡ç†è§†å›¾ ä¸»è¦è¿›è¡Œæœç´¢å’ŒæŸ¥è¯¢Visualizeï¼šç»Ÿè®¡è§†å›¾ æ„å»ºå¯è§†åŒ–çš„å›¾è¡¨Dashboardï¼šä»ªè¡¨è§†å›¾ å°†æ„å»ºçš„å›¾è¡¨ç»„åˆå½¢æˆå›¾è¡¨ç›˜Dev Toolsï¼š å¼€å‘è€…å‘½ä»¤è§†å›¾ å¼€å‘å·¥å…·Managementï¼šç®¡ç†è§†å›¾ ç®¡ç†å·¥å…·</span><br></pre></td></tr></table></figure><p><strong>ç®€å•æŸ¥è¯¢</strong><br>ç‚¹å‡»discoverï¼Œåˆ™ä¼šæ˜¾ç¤ºé»˜è®¤ç´¢å¼•çš„ç©ºé—´ï¼Œæ˜¾ç¤ºçš„æ•°æ®é»˜è®¤æ˜¯15åˆ†é’Ÿï¼Œä½ å¯ä»¥è‡ªå·±è°ƒæ•´æ—¶é—´æ®µårefreshåˆ·æ–°æŸ¥è¯¢åˆ°ä½ æƒ³è¦çš„æ•°æ®ã€‚<br><img src="\image\5f16b919cf571.png"><br>é»˜è®¤æƒ…å†µä¸‹,åˆ—è¡¨ä¼šæ˜¾ç¤ºæ‰€æœ‰å­—æ®µ,åœ¨å·¦ä¾§çš„Available fieldsä¸‹æ–¹çš„å­—æ®µé€‰ä¸­addæ·»åŠ ,åˆ™åªæ˜¾ç¤ºä½ æ‰€é€‰ä¸­çš„å­—æ®µåˆ°åˆ—è¡¨ä¸­ã€‚<br><img src="\image\5f16b9c6b79d3.png"><br>saveä¿å­˜æœç´¢æ¡ä»¶<br><img src="\image\5f17b28256ac4.png"><br>openæ‰“å¼€ä¿å­˜çš„æœç´¢æ¡ä»¶<br><img src="\image\5f17b26c3780b.png"><br><strong>è‡ªå®šä¹‰ç´¢å¼•</strong><br>åˆ›å»ºç´¢å¼•<br><img src="\image\5f16bd2e3b622.png"><br>è¾“å…¥æ—¥å¿—åç§°(å¯é€šè¿‡æ­£åˆ™åŒ¹é…)<br><img src="\image\5f16bd669d4ac.png"><br><img src="\image\5f16bd9a241ec.png"><br>å¯æŸ¥çœ‹æ‰€æœ‰å­—æ®µ<br><img src="\image\5f16bdc9b995c.png"><br>ç‚¹å‡»Discoverå¯æŸ¥çœ‹åˆ°æ–°æ·»åŠ çš„ç´¢å¼•<br><img src="\image\5f16bdf66aab1.png"><br>Visualize åˆ›å»ºå¯è§†åŒ–å›¾è¡¨<br><img src="\image\5f16bfd8e2c2f.png"><br>Kibanaè‡ªå¸¦æœ‰ä¸Š10ç§å›¾è¡¨,è¿™é‡Œé€‰æ‹©ç›´æ–¹å›¾ğŸ“Š<br><img src="\image\5f16c0138f4c3.png"><br>é€‰æ‹©æ•°æ®æ¥æº<br><img src="\image\5f16c7d5b235b.png"><br>é»˜è®¤å·²ç»æœ‰ä¸€ä¸ªYè½´äº†ï¼Œç»Ÿè®¡çš„æ˜¯æ•°é‡ï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªXè½´ï¼Œç‚¹å‡»Bucketsä¸‹çš„Add<br><img src="\image\5f16c8377e70b.png"><br>æˆ‘é€‰æ‹©äº†<a href="https://github.com/timestamp" target="_blank" rel="noopener">@timestamp</a>å­—æ®µä½œä¸ºxè½´ ç„¶åUpdate<br><img src="\image\5f16c8c18cf67.png"><br>ä¿å­˜<br><img src="\image\5f16c8fe1622e.png"><br><strong>ä»ªè¡¨ç›˜</strong> å±•ç¤ºä¿å­˜çš„å¯è§†åŒ–ç»“æœé›†åˆ<br>åˆ›å»ºä¸€ä¸ªDashboard,å±•ç¤ºä¸Šé¢å®šä¹‰å¥½çš„å›¾è¡¨<br><img src="\image\5f17af8cbf6d4.png"><br>æ·»åŠ å·²ç»å­˜åœ¨çš„å›¾è¡¨<br><img src="\image\5f17afa79b0a6.png"><br>æ·»åŠ å®Œåä¿å­˜å³å¯<br><img src="\image\5f17aff2b7ccd.png"><br><strong>Dev Tools</strong> å¯ä»¥çœ‹åˆ°Consoleå‘½ä»¤è¡Œç›´æ¥å¯ä»¥æ‰§è¡ŒESçš„RESTé£æ ¼APIï¼Œå³ä¾§æ˜¯æŸ¥è¯¢çš„è¿”å›ç»“æœ<br><img src="\image\5f16bad4c39a6.png"><br><strong>Management</strong><br>å¯å¯¹è§†å›¾æˆ–æœç´¢ç­‰åˆ é™¤å’Œå¯¼å…¥å¯¼å‡º<br><img src="\image\5f17b36c51b37.png"><br>kibanaå¯è§†åŒ–æ“ä½œ: <a href="https://www.cnblogs.com/ygunoil/p/13279514.html" target="_blank" rel="noopener">https://www.cnblogs.com/ygunoil/p/13279514.html</a><br>æŸ¥è¯¢è¯­æ³•: <a href="https://www.cnblogs.com/chenqionghe/p/12501218.html" target="_blank" rel="noopener">https://www.cnblogs.com/chenqionghe/p/12501218.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;elasticsearché›†ç¾¤æ­å»º&quot;&gt;&lt;a href=&quot;#elasticsearché›†ç¾¤æ­å»º&quot; class=&quot;headerlink&quot; title=&quot;elasticsearché›†ç¾¤æ­å»º&quot;&gt;&lt;/a&gt;elasticsearché›†ç¾¤æ­å»º&lt;/h3&gt;&lt;h4 id=&quot;elast</summary>
      
    
    
    
    
    <category term="elasticsearch" scheme="https://nmk0718.github.io/tag/elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>nginx</title>
    <link href="https://nmk0718.github.io/2020/07/16/nginx/"/>
    <id>https://nmk0718.github.io/2020/07/16/nginx/</id>
    <published>2020-07-16T08:47:00.000Z</published>
    <updated>2024-12-09T03:02:15.154Z</updated>
    
    <content type="html"><![CDATA[<h4 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h4><p>Nginx æ˜¯å¼€æºã€é«˜æ€§èƒ½ã€é«˜å¯é çš„HTTPæœåŠ¡å™¨,ä¹Ÿå¯ä½œä¸ºåå‘ä»£ç†æœåŠ¡å™¨,é‚®ä»¶æœåŠ¡å™¨ï¼Œæ”¯æŒçƒ­éƒ¨ç½²ï¼Œå ç”¨å†…å­˜å°‘ã€å¹¶å‘èƒ½åŠ›å¼ºã€èƒ½æ”¯æŒé«˜è¾¾ 5w ä¸ªå¹¶å‘è¿æ¥æ•°ï¼Œæœ€é‡è¦çš„æ˜¯Nginx æ˜¯å…è´¹çš„å¹¶å¯ä»¥å•†ä¸šåŒ–ï¼Œé…ç½®ä½¿ç”¨ä¹Ÿæ¯”è¾ƒç®€å•ã€‚æ”¯æŒFastCGIã€SSLã€Virtual Hostã€URL Rewriteã€Gzipç­‰åŠŸèƒ½ã€‚å¹¶ä¸”æ”¯æŒå¾ˆå¤šç¬¬ä¸‰æ–¹çš„æ¨¡å—æ‰©å±•ã€‚</p><h4 id="Nginxå¸¸ç”¨åŠŸèƒ½"><a href="#Nginxå¸¸ç”¨åŠŸèƒ½" class="headerlink" title="Nginxå¸¸ç”¨åŠŸèƒ½"></a>Nginxå¸¸ç”¨åŠŸèƒ½</h4><p>Nginxåœ¨åšåå‘ä»£ç†æ—¶,æä¾›æ€§èƒ½ç¨³å®š,å¹¶ä¸”èƒ½å¤Ÿæä¾›é…ç½®çµæ´»çš„è½¬å‘åŠŸèƒ½ã€‚Nginxå¯ä»¥æ ¹æ®ä¸åŒçš„æ­£åˆ™åŒ¹é…,é‡‡å–ä¸åŒçš„è½¬å‘ç­–ç•¥,æ¯”å¦‚å›¾ç‰‡æ–‡ä»¶ç»“å°¾çš„èµ°æ–‡ä»¶æœåŠ¡å™¨,åŠ¨æ€é¡µé¢èµ°webæœåŠ¡å™¨ã€‚å¹¶ä¸”Nginxå¯¹è¿”å›ç»“æœè¿›è¡Œé”™è¯¯é¡µè·³è½¬,å¼‚å¸¸åˆ¤æ–­ç­‰ã€‚å¦‚æœè¢«åˆ†å‘çš„æœåŠ¡å™¨å­˜åœ¨å¼‚å¸¸,ä»–å¯ä»¥å°†è¯·æ±‚é‡æ–°è½¬å‘ç»™å¦å¤–ä¸€å°æœåŠ¡å™¨,ç„¶åè‡ªåŠ¨å»é™¤å¼‚å¸¸æœåŠ¡å™¨ã€‚</p><h4 id="æ­£å‘ä»£ç†å’Œåå‘ä»£ç†"><a href="#æ­£å‘ä»£ç†å’Œåå‘ä»£ç†" class="headerlink" title="æ­£å‘ä»£ç†å’Œåå‘ä»£ç†"></a>æ­£å‘ä»£ç†å’Œåå‘ä»£ç†</h4><p>åå‘ä»£ç†ï¼ˆReverse Proxyï¼‰å¯¹åº”çš„æ˜¯æ­£å‘ä»£ç†ï¼ˆForward Proxyï¼‰,ä»–ä»¬çš„åŒºåˆ«ï¼š<br>æ­£å‘ä»£ç†ï¼š å†…ç½‘æœåŠ¡å™¨ä¸»åŠ¨è¦å»è¯·æ±‚å¤–ç½‘çš„åœ°å€æˆ–æœåŠ¡ï¼Œæ‰€è¿›è¡Œçš„ä¸€ç§è¡Œä¸ºã€‚å†…ç½‘æœåŠ¡&gt;ä»£ç†æœåŠ¡å™¨&gt;å¤–ç½‘<br>åå‘ä»£ç†ï¼šå¤–ç½‘è¦è®¿é—®å†…ç½‘æœåŠ¡è€Œè¿›è¡Œçš„ä¸€ç§è¡Œä¸ºã€‚ å¤–ç½‘&gt;ä»£ç†æœåŠ¡å™¨&gt;å†…ç½‘æœåŠ¡<br><img src="/image/proxy.png" alt="proxy"></p><h4 id="è´Ÿè½½å‡è¡¡"><a href="#è´Ÿè½½å‡è¡¡" class="headerlink" title="è´Ÿè½½å‡è¡¡"></a>è´Ÿè½½å‡è¡¡</h4><p>è¯·æ±‚çˆ†å‘å¼å¢é•¿çš„æƒ…å†µä¸‹,å•ä¸ªæœºå™¨æ€§èƒ½å†å¼ºåŠ²ä¹Ÿæ— æ³•æ»¡è¶³è¦æ±‚äº†,è¿™ä¸ªæ—¶å€™é›†ç¾¤çš„æ¦‚å¿µäº§ç”Ÿäº†,å•ä¸ªæœåŠ¡å™¨è§£å†³ä¸äº†çš„é—®é¢˜,å¯ä»¥ä½¿ç”¨å¤šä¸ªæœåŠ¡å™¨,ç„¶åå°†è¯·æ±‚åˆ†å‘åˆ°å„ä¸ªæœåŠ¡å™¨ä¸Š,å°†è´Ÿè½½åˆ†å‘åˆ°ä¸åŒçš„æœåŠ¡å™¨,è¿™å°±æ˜¯è´Ÿè½½å‡è¡¡,æ ¸å¿ƒæ˜¯ã€Œåˆ†æ‘Šå‹åŠ›ã€ã€‚Nginx å®ç°è´Ÿè½½å‡è¡¡,ä¸€èˆ¬æ¥è¯´æŒ‡çš„æ˜¯å°†è¯·æ±‚è½¬å‘ç»™æœåŠ¡å™¨é›†ç¾¤ã€‚<br><img src="/image/balancer.png" alt="balancer"></p><h4 id="åŠ¨é™åˆ†ç¦»"><a href="#åŠ¨é™åˆ†ç¦»" class="headerlink" title="åŠ¨é™åˆ†ç¦»"></a>åŠ¨é™åˆ†ç¦»</h4><p>ä¸ºäº†åŠ å¿«ç½‘ç«™çš„è§£æé€Ÿåº¦,å¯ä»¥æŠŠåŠ¨æ€é¡µé¢å’Œé™æ€é¡µé¢ç”±ä¸åŒçš„æœåŠ¡å™¨æ¥è§£æ,åŠ å¿«è§£æé€Ÿåº¦,é™ä½åŸæ¥å•ä¸ªæœåŠ¡å™¨çš„å‹åŠ›ã€‚<br>ä¸€èˆ¬æ¥è¯´,éƒ½éœ€è¦å°†åŠ¨æ€èµ„æºå’Œé™æ€èµ„æºåˆ†å¼€,ç”±äº Nginx çš„é«˜å¹¶å‘å’Œé™æ€èµ„æºç¼“å­˜ç­‰ç‰¹æ€§,ç»å¸¸å°†é™æ€èµ„æºéƒ¨ç½²åœ¨ Nginx ä¸Šã€‚å¦‚æœè¯·æ±‚çš„æ˜¯é™æ€èµ„æº,ç›´æ¥åˆ°é™æ€èµ„æºç›®å½•è·å–èµ„æº,å¦‚æœæ˜¯åŠ¨æ€èµ„æºçš„è¯·æ±‚,åˆ™åˆ©ç”¨åå‘ä»£ç†çš„åŸç†,æŠŠè¯·æ±‚è½¬å‘ç»™å¯¹åº”åå°åº”ç”¨å»å¤„ç†,ä»è€Œå®ç°åŠ¨é™åˆ†ç¦»ã€‚<br>ä½¿ç”¨å‰åç«¯åˆ†ç¦»å,å¯ä»¥å¾ˆå¤§ç¨‹åº¦æå‡é™æ€èµ„æºçš„è®¿é—®é€Ÿåº¦,å³ä½¿åŠ¨æ€æœåŠ¡ä¸å¯ç”¨,é™æ€èµ„æºçš„è®¿é—®ä¹Ÿä¸ä¼šå—åˆ°å½±å“ã€‚<br><img src="/image/DynamicAndStaticSeparation.png" alt="DynamicAndStaticSeparation"></p><h4 id="Master-Workeræ¨¡å¼"><a href="#Master-Workeræ¨¡å¼" class="headerlink" title="Master-Workeræ¨¡å¼"></a>Master-Workeræ¨¡å¼</h4><p>å¯åŠ¨Nginxåï¼Œå…¶å®å°±æ˜¯åœ¨80ç«¯å£å¯åŠ¨äº†SocketæœåŠ¡è¿›è¡Œç›‘å¬</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@service nginx]# ps -ef|grep nginx</span><br><span class="line">root     146987      1  0 11:18 ?        00:00:00 nginx: master process ./sbin/nginx</span><br><span class="line">nobody   152247 146987  0 14:55 ?        00:00:00 nginx: worker process</span><br></pre></td></tr></table></figure><p><strong>Masterè¿›ç¨‹</strong>:<br>è¯»å–å¹¶éªŒè¯é…ç½®æ–‡ä»¶nginx.conf,ç®¡ç†workerè¿›ç¨‹ã€‚1024ä»¥ä¸‹çš„ç«¯å£åªæœ‰rootç”¨æˆ·å¯ä»¥ä½¿ç”¨</p><p><strong>Workerè¿›ç¨‹</strong>:<br>çœŸæ­£å¤„ç†è¯·æ±‚çš„è¿›ç¨‹,æ˜¯ä»¥æ™®é€šç”¨æˆ·çš„èº«ä»½è¿›è¡Œè¿è¡Œçš„,è¿™æ ·å°±å¯ä»¥æå¤§å¢åŠ ç¨‹åºçš„å®‰å…¨æ€§ã€‚å°±ç®—æ˜¯ä¸‡ä¸€æœ‰ä¸€ä¸ªè¿›ç¨‹è¢«åŠ«æŒï¼Œé‚£ä¹Ÿä¸ä¼šæœ‰ç®¡ç†å‘˜æƒé™.æ³¨æ„Workerè¿›ç¨‹çš„ä¸ªæ•°ç”±é…ç½®æ–‡ä»¶å†³å®šï¼Œä¸€èˆ¬å’ŒCPUä¸ªæ•°ç›¸å…³ï¼ˆæœ‰åˆ©äºè¿›ç¨‹åˆ‡æ¢ï¼‰ï¼Œé…ç½®å‡ ä¸ªå°±æœ‰å‡ ä¸ªWorkerè¿›ç¨‹ã€‚</p><p><strong>çƒ­éƒ¨ç½²åŸç†</strong>:<br>ä¿®æ”¹é…ç½®æ–‡ä»¶nginx.confåï¼Œé‡æ–°åŠ è½½ï¼Œmasterè¿›ç¨‹ä¼šè¿›è¡Œè¯­æ³•é”™è¯¯çš„åˆ¤æ–­ã€‚å¦‚æœå­˜åœ¨è¯­æ³•é”™è¯¯çš„è¯ï¼Œè¿”å›é”™è¯¯ï¼Œä¸è¿›è¡Œè£…è½½ï¼Œå¦‚æœé…ç½®æ–‡ä»¶æ²¡æœ‰è¯­æ³•é”™è¯¯ï¼Œé‚£ä¹ˆngnixä¹Ÿä¸ä¼šå°†æ–°çš„é…ç½®è°ƒæ•´åˆ°æ‰€æœ‰workerä¸­ã€‚è€Œæ˜¯ï¼Œå…ˆä¸æ”¹å˜å·²ç»å»ºç«‹è¿æ¥çš„workerï¼Œç­‰å¾…workerå°†æ‰€æœ‰è¯·æ±‚ç»“æŸä¹‹åï¼Œå°†åŸå…ˆåœ¨æ—§çš„é…ç½®ä¸‹å¯åŠ¨çš„workeræ€æ­»ï¼Œç„¶åä½¿ç”¨æ–°çš„é…ç½®åˆ›å»ºæ–°çš„workerã€‚</p><h4 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h4><p>nginx é…ç½®æ–‡ä»¶ä¸»è¦åˆ†æˆå››éƒ¨åˆ†ï¼š</p><p><code>main</code>(å…¨å±€è®¾ç½®): è®¾ç½®çš„æŒ‡ä»¤å½±å“å…¶ä»–æ‰€æœ‰éƒ¨åˆ†çš„è®¾ç½®<br><code>server</code>(ä¸»æœºè®¾ç½®):ä¸»è¦ç”¨äºåˆ¶å®šè™šæ‹Ÿä¸»æœºåŸŸå IP å’Œç«¯å£å·<br><code>upstream</code>(ä¸Šæ¸¸æœåŠ¡å™¨è®¾ç½®):è®¾ç½®ä¸€ç³»åˆ—çš„åç«¯æœåŠ¡å™¨,è®¾ç½®åå‘ä»£ç†åŠåç«¯æœåŠ¡å™¨çš„è´Ÿè½½å‡è¡¡<br><code>location</code>(URLåŒ¹é…ç‰¹å®šä½ç½®åçš„è®¾ç½®):ç”¨äºåŒ¹é…ç½‘é¡µä½ç½®ï¼ˆæ¯”å¦‚,æ ¹ç›®å½•â€œ/â€,â€œ/imagesâ€,ç­‰ç­‰ï¼‰ã€‚</p><p>ä»–ä»¬ä¹‹é—´çš„å…³ç³»ï¼šserver ç»§æ‰¿ main,location ç»§æ‰¿ serverï¼›upstream æ—¢ä¸ä¼šç»§æ‰¿æŒ‡ä»¤ä¹Ÿä¸ä¼šè¢«ç»§æ‰¿ã€‚</p><p>é…ç½®æ–‡ä»¶çš„è¯­æ³•è§„åˆ™ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.é…ç½®æ–‡ä»¶ç”±æŒ‡ä»¤ä¸æŒ‡ä»¤å—æ„æˆï¼›</span><br><span class="line">2.æ¯æ¡æŒ‡ä»¤ä»¥ ; åˆ†å·ç»“å°¾,æŒ‡ä»¤ä¸å‚æ•°é—´ä»¥ç©ºæ ¼ç¬¦å·åˆ†éš”ï¼›</span><br><span class="line">3.æŒ‡ä»¤å—ä»¥ &#123;&#125; å¤§æ‹¬å·å°†å¤šæ¡æŒ‡ä»¤ç»„ç»‡åœ¨ä¸€èµ·ï¼›</span><br><span class="line">4.include è¯­å¥å…è®¸ç»„åˆå¤šä¸ªé…ç½®æ–‡ä»¶ä»¥æå‡å¯ç»´æŠ¤æ€§ï¼›</span><br><span class="line">5.ä½¿ç”¨ # ç¬¦å·æ·»åŠ æ³¨é‡Š,æé«˜å¯è¯»æ€§ï¼›</span><br><span class="line">6.ä½¿ç”¨ $ ç¬¦å·ä½¿ç”¨å˜é‡ï¼›</span><br><span class="line">7.éƒ¨åˆ†æŒ‡ä»¤çš„å‚æ•°æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ï¼›</span><br></pre></td></tr></table></figure><p>Nginx çš„é…ç½®ï¼š</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="comment">#å®šä¹‰Nginxè¿è¡Œçš„ç”¨æˆ·å’Œç”¨æˆ·ç»„</span></span><br><span class="line"><span class="attribute">user</span>  nginx; </span><br><span class="line"></span><br><span class="line"><span class="comment">#nginxè¿›ç¨‹æ•°,é€šå¸¸è®¾ç½®æˆå’Œcpuçš„æ•°é‡ç›¸ç­‰,ä¹Ÿå¯ä»¥è®¾ç½®ä¸ºauto</span></span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#å…¨å±€é”™è¯¯æ—¥å¿—å®šä¹‰ç±»å‹,[debug | info | notice | warn | error | crit]</span></span><br><span class="line"><span class="attribute">error_log</span>  /var/log/nginx/error.log;  </span><br><span class="line"><span class="comment">#error_log  /var/log/nginx/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  /var/log/nginx/error.log  info;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿›ç¨‹pidæ–‡ä»¶</span></span><br><span class="line"><span class="attribute">pid</span>        /run/nginx.pid;</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŒ‡å®šè¿›ç¨‹å¯ä»¥æ‰“å¼€çš„æœ€å¤§æè¿°ç¬¦ï¼šæ•°ç›®</span></span><br><span class="line"><span class="comment">#å·¥ä½œæ¨¡å¼ä¸è¿æ¥æ•°ä¸Šé™</span></span><br><span class="line"><span class="comment">##è¿™ä¸ªæŒ‡ä»¤æ˜¯æŒ‡å½“ä¸€ä¸ªnginxè¿›ç¨‹æ‰“å¼€çš„æœ€å¤šæ–‡ä»¶æè¿°ç¬¦æ•°ç›®,ç†è®ºå€¼åº”è¯¥æ˜¯æœ€å¤šæ‰“å¼€æ–‡ä»¶æ•°ï¼ˆulimit -nï¼‰ä¸nginxè¿›ç¨‹æ•°ç›¸é™¤,ä½†æ˜¯nginxåˆ†é…è¯·æ±‚å¹¶ä¸æ˜¯é‚£ä¹ˆå‡åŒ€,æ‰€ä»¥æœ€å¥½ä¸ulimit -n çš„å€¼ä¿æŒä¸€è‡´ã€‚</span></span><br><span class="line"><span class="comment">#è¿™æ˜¯å› ä¸ºnginxè°ƒåº¦æ—¶åˆ†é…è¯·æ±‚åˆ°è¿›ç¨‹å¹¶ä¸æ˜¯é‚£ä¹ˆçš„å‡è¡¡,æ‰€ä»¥å‡å¦‚å¡«å†™10240,æ€»å¹¶å‘é‡è¾¾åˆ°3-4ä¸‡æ—¶å°±æœ‰è¿›ç¨‹å¯èƒ½è¶…è¿‡10240äº†,è¿™æ—¶ä¼šè¿”å›502é”™è¯¯ã€‚</span></span><br><span class="line"><span class="attribute">worker_rlimit_nofile</span> <span class="number">65535</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">include</span> /etc/nginx/conf.modules.d/<span class="regexp">*.conf</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line"><span class="comment">#å•ä¸ªè¿›ç¨‹æœ€å¤§è¿æ¥æ•°ï¼ˆæœ€å¤§è¿æ¥æ•°=è¿æ¥æ•°+è¿›ç¨‹æ•°ï¼‰ é»˜è®¤ä¸º1024</span></span><br><span class="line"><span class="comment">#æ ¹æ®ç¡¬ä»¶è°ƒæ•´,å’Œå‰é¢å·¥ä½œè¿›ç¨‹é…åˆèµ·æ¥ç”¨,å°½é‡å¤§,ä½†æ˜¯åˆ«æŠŠcupè·‘åˆ°100%å°±è¡Œã€‚</span></span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line"><span class="comment">#å½“è¿æ¥æ•°è¿‡å¤§æ—¶å¯è®¾ç½®ä¸ºworker_connections  51200;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#è®¾å®šhttpæœåŠ¡å™¨</span></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment"># æ–‡ä»¶æ‰©å±•åä¸ç±»å‹æ˜ å°„è¡¨</span></span><br><span class="line">    <span class="attribute">include</span>       /etc/nginx/mime.types;</span><br><span class="line">    </span><br><span class="line"><span class="comment"># é»˜è®¤æ–‡ä»¶ç±»å‹</span></span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line">    </span><br><span class="line"><span class="comment">#nginxçš„æ—¥å¿—æ ¼å¼</span></span><br><span class="line">    <span class="attribute">log_format</span>  main  <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></span><br><span class="line">                      <span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line">                      <span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</span><br><span class="line"><span class="comment"># Nginxè®¿é—®æ—¥å¿—å­˜æ”¾ä½ç½®</span></span><br><span class="line">    <span class="attribute">access_log</span>  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line"><span class="comment">#å…è®¸å®¢æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å•æ–‡ä»¶å­—èŠ‚æ•°ã€‚å¦‚æœæœ‰ä¸Šä¼ è¾ƒå¤§æ–‡ä»¶ï¼Œè¯·è®¾ç½®å®ƒçš„é™åˆ¶å€¼</span></span><br><span class="line"><span class="attribute">client_max_body_size</span> Â  Â  Â  Â  Â  Â  <span class="number">100m</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç¼“å†²åŒºä»£ç†ç¼“å†²ç”¨æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å­—èŠ‚æ•°</span></span><br><span class="line">    <span class="attribute">client_body_buffer_size</span> Â  Â  Â  Â <span class="number">10m</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€ä¸€ä¸ªå®Œæ•´çš„ request header çš„è¶…æ—¶æ—¶é—´</span></span><br><span class="line"><span class="attribute">client_header_timeout</span> Â  Â  <span class="number">3m</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å»ºç«‹è¿æ¥åå‘é€ request body çš„è¶…æ—¶æ—¶é—´</span></span><br><span class="line"><span class="attribute">client_body_timeout</span> <span class="number">3m</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯ä¼ è¾“æ•°æ®çš„è¶…æ—¶æ—¶é—´</span></span><br><span class="line">    <span class="attribute">send_timeout</span> Â  Â  Â  Â  Â  Â  <span class="number">3m</span>;</span><br><span class="line">    </span><br><span class="line"><span class="comment">#å¼€å¯é«˜æ•ˆæ–‡ä»¶ä¼ è¾“æ¨¡å¼,sendfileæŒ‡ä»¤æŒ‡å®šnginxæ˜¯å¦è°ƒç”¨sendfileå‡½æ•°æ¥è¾“å‡ºæ–‡ä»¶,å¯¹äºæ™®é€šåº”ç”¨è®¾ä¸º on,å¦‚æœç”¨æ¥è¿›è¡Œä¸‹è½½ç­‰åº”ç”¨ç£ç›˜IOé‡è´Ÿè½½åº”ç”¨,å¯è®¾ç½®ä¸ºoff,ä»¥å¹³è¡¡ç£ç›˜ä¸ç½‘ç»œI/Oå¤„ç†é€Ÿåº¦,é™ä½ç³»ç»Ÿçš„è´Ÿè½½ã€‚æ³¨æ„ï¼šå¦‚æœå›¾ç‰‡æ˜¾ç¤ºä¸æ­£å¸¸æŠŠè¿™ä¸ªæ”¹ æˆoffã€‚</span></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    </span><br><span class="line"><span class="comment">#é˜²æ­¢ç½‘ç»œé˜»å¡</span></span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#é•¿è¿æ¥è¶…æ—¶æ—¶é—´,å•ä½æ˜¯ç§’</span></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line">    </span><br><span class="line"><span class="comment">#å¼€å¯gzipå‹ç¼©</span></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½å­é…ç½®é¡¹</span></span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">index</span>   index.html index.htm;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;       <span class="comment">#ç›‘å¬ç«¯å£ï¼Œé»˜è®¤80ï¼Œå°äº1024çš„è¦ä»¥rootå¯åŠ¨</span></span><br><span class="line">    <span class="attribute">server_name</span>  localhost;  <span class="comment">#æœåŠ¡å™¨åï¼Œå¦‚localhostã€http://www.example.comï¼Œå¯ä»¥é€šè¿‡æ­£åˆ™åŒ¹é…ã€‚</span></span><br><span class="line">    </span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">root</span>   /usr/share/nginx/html;  <span class="comment"># ç½‘ç«™æ ¹ç›®å½•</span></span><br><span class="line">    <span class="attribute">index</span>  index.html index.htm;   <span class="comment"># é»˜è®¤é¦–é¡µæ–‡ä»¶</span></span><br><span class="line">    <span class="attribute">deny</span> <span class="number">172.168.22.11</span>;   <span class="comment"># ç¦æ­¢è®¿é—®çš„ipåœ°å€,å¯ä»¥ä¸ºall</span></span><br><span class="line">    <span class="attribute">allow</span> <span class="number">172.168.33.44</span>ï¼› <span class="comment"># å…è®¸è®¿é—®çš„ipåœ°å€,å¯ä»¥ä¸ºall</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    error_page <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> /50x.html;  <span class="comment"># é»˜è®¤50xå¯¹åº”çš„è®¿é—®é¡µé¢</span></span><br><span class="line">    <span class="attribute">error_page</span> <span class="number">400</span> <span class="number">404</span> <span class="literal">error</span>.html;   <span class="comment"># åŒä¸Š</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>server å—å¯ä»¥åŒ…å«å¤šä¸ª location å—,location æŒ‡ä»¤ç”¨äºåŒ¹é… uri,è¯­æ³•ï¼š</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">location</span> [ = | <span class="regexp">~ |</span> <span class="regexp">~* |</span><span class="regexp"> ^~]</span> uri &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŒ‡ä»¤åé¢ï¼š</p><p>1.<code>=</code>ç²¾ç¡®åŒ¹é…è·¯å¾„,ç”¨äºä¸å«æ­£åˆ™è¡¨è¾¾å¼çš„ uri å‰,å¦‚æœåŒ¹é…æˆåŠŸ,ä¸å†è¿›è¡Œåç»­çš„æŸ¥æ‰¾ï¼›<br>2.<code>^<del></del></code>ç”¨äºä¸å«æ­£åˆ™è¡¨è¾¾å¼çš„ uriï¼› å‰,è¡¨ç¤ºå¦‚æœè¯¥ç¬¦å·åé¢çš„å­—ç¬¦æ˜¯æœ€ä½³åŒ¹é…,é‡‡ç”¨è¯¥è§„åˆ™,ä¸å†è¿›è¡Œåç»­çš„æŸ¥æ‰¾ï¼›<br>3.<code></code> è¡¨ç¤ºç”¨è¯¥ç¬¦å·åé¢çš„æ­£åˆ™å»åŒ¹é…è·¯å¾„,åŒºåˆ†å¤§å°å†™ï¼›<br>4.<code>~*</code>è¡¨ç¤ºç”¨è¯¥ç¬¦å·åé¢çš„æ­£åˆ™å»åŒ¹é…è·¯å¾„,ä¸åŒºåˆ†å¤§å°å†™ã€‚è·Ÿ ~ ä¼˜å…ˆçº§éƒ½æ¯”è¾ƒä½,å¦‚æœ‰å¤šä¸ªlocationçš„æ­£åˆ™èƒ½åŒ¹é…çš„è¯,åˆ™ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æœ€é•¿çš„é‚£ä¸ªï¼›</p><p>å¦‚æœ uri åŒ…å«æ­£åˆ™è¡¨è¾¾å¼,åˆ™å¿…é¡»è¦æœ‰ ~ æˆ– ~* æ ‡å¿—ã€‚</p><h4 id="å¸¸ç”¨çš„å…¨å±€å˜é‡"><a href="#å¸¸ç”¨çš„å…¨å±€å˜é‡" class="headerlink" title="å¸¸ç”¨çš„å…¨å±€å˜é‡"></a>å¸¸ç”¨çš„å…¨å±€å˜é‡</h4><table><thead><tr><th>å…¨å±€å˜é‡å</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td>$host</td><td>è¯·æ±‚ä¿¡æ¯ä¸­çš„ Host,å¦‚æœè¯·æ±‚ä¸­æ²¡æœ‰ Host è¡Œ,åˆ™ç­‰äºè®¾ç½®çš„æœåŠ¡å™¨å,ä¸åŒ…å«ç«¯å£</td></tr><tr><td>$request_method</td><td>å®¢æˆ·ç«¯è¯·æ±‚ç±»å‹,å¦‚ GETã€POST</td></tr><tr><td>$remote_addr</td><td>å®¢æˆ·ç«¯çš„ IP åœ°å€</td></tr><tr><td>$args</td><td>è¯·æ±‚ä¸­çš„å‚æ•°</td></tr><tr><td>$arg_PARAMETER</td><td>GET è¯·æ±‚ä¸­å˜é‡å PARAMETER å‚æ•°çš„å€¼,ä¾‹å¦‚ï¼š$http_user_agent(Uaer-Agent å€¼), $http_refererâ€¦</td></tr><tr><td>$content_length</td><td>è¯·æ±‚å¤´ä¸­çš„ Content-length å­—æ®µ</td></tr><tr><td>$http_user_agent</td><td>å®¢æˆ·ç«¯agentä¿¡æ¯</td></tr><tr><td>$http_cookie</td><td>å®¢æˆ·ç«¯cookieä¿¡æ¯</td></tr><tr><td>$remote_addr</td><td>å®¢æˆ·ç«¯çš„IPåœ°å€</td></tr><tr><td>$remote_port</td><td>å®¢æˆ·ç«¯çš„ç«¯å£</td></tr><tr><td>$http_user_agent</td><td>å®¢æˆ·ç«¯agentä¿¡æ¯</td></tr><tr><td>$server_protocol</td><td>è¯·æ±‚ä½¿ç”¨çš„åè®®,å¦‚ HTTP/1.0ã€HTTP/1.1</td></tr><tr><td>$server_addr</td><td>æœåŠ¡å™¨åœ°å€</td></tr><tr><td>$server_name</td><td>æœåŠ¡å™¨åç§°</td></tr><tr><td>$server_port</td><td>æœåŠ¡å™¨çš„ç«¯å£å·</td></tr><tr><td>$scheme</td><td>HTTP æ–¹æ³•ï¼ˆå¦‚http,httpsï¼‰</td></tr></tbody></table><h4 id="é…ç½®æ­£å‘ä»£ç†"><a href="#é…ç½®æ­£å‘ä»£ç†" class="headerlink" title="é…ç½®æ­£å‘ä»£ç†"></a>é…ç½®æ­£å‘ä»£ç†</h4><p>ä»£ç†æœåŠ¡å™¨:</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">resolver</span> <span class="number">8.8.8.8</span>;    <span class="comment"># å¿…éœ€</span></span><br><span class="line">    <span class="attribute">resolver_timeout</span> <span class="number">5s</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç›‘å¬ç«¯å£</span></span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8088</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="comment"># é…ç½®æ­£å‘ä»£ç†å‚æ•°</span></span><br><span class="line">        <span class="attribute">proxy_pass</span> <span class="variable">$scheme</span>://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">        <span class="comment"># è§£å†³å¦‚æœURLä¸­å¸¦"."åNginx 503é”™è¯¯</span></span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$http_host</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>linuxå®¢æˆ·ç«¯</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ä¸€æ¬¡ä»£ç†ï¼Œç›´æ¥åœ¨shellæ‰§è¡Œï¼š</span><br><span class="line">export http_proxy=http://192.168.10.117:8088</span><br><span class="line"></span><br><span class="line">æ°¸ä¹…ä½¿ç”¨ï¼š</span><br><span class="line">vim .bashrc</span><br><span class="line">export http_proxy=http://192.168.10.117:8088</span><br><span class="line">sourceÂ  .bashrc</span><br></pre></td></tr></table></figure><p>é…ç½®ä»£ç†å,æŸ¥çœ‹å‡ºå£æ˜¯å¦å˜ä¸ºç™½åå•ip</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">export http_proxy=http://192.168.10.117:8088</span><br><span class="line">curl http://myip.ipip.net/</span><br><span class="line">å½“å‰ IPï¼š119.130.113.243  æ¥è‡ªäºï¼šä¸­å›½ å¹¿ä¸œ å¹¿å·  ç”µä¿¡</span><br></pre></td></tr></table></figure><h4 id="é…ç½®åå‘ä»£ç†"><a href="#é…ç½®åå‘ä»£ç†" class="headerlink" title="é…ç½®åå‘ä»£ç†"></a>é…ç½®åå‘ä»£ç†</h4><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line">  <span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">linsten</span> <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">server_name</span> localhost;</span><br><span class="line">    </span><br><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://myserver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å°†è¯·æ±‚è½¬å‘åˆ°å¦ä¸€ä¸ªæœåŠ¡å™¨ä¸Š,ä¹Ÿå¯ä»¥æ ¹æ®è®¿é—®çš„è·¯å¾„è·³è½¬åˆ°ä¸åŒç«¯å£çš„æœåŠ¡ä¸­ã€‚<br>æ¯”å¦‚æˆ‘ä»¬ç›‘å¬ 9001 ç«¯å£,ç„¶åæŠŠè®¿é—®ä¸åŒè·¯å¾„çš„è¯·æ±‚è¿›è¡Œåå‘ä»£ç†ï¼š</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="comment">#æŠŠè®¿é—® http://127.0.0.1:9001/a çš„è¯·æ±‚è½¬å‘åˆ° http://127.0.0.1:8080</span></span><br><span class="line"><span class="comment">#æŠŠè®¿é—® http://127.0.0.1:9001/b çš„è¯·æ±‚è½¬å‘åˆ° http://127.0.0.1:8081</span></span><br><span class="line"></span><br><span class="line">åœ¨ http æ¨¡å—ä¸‹å¢åŠ ä¸€ä¸ª server å—ï¼š</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">9001</span>;</span><br><span class="line">  <span class="attribute">server_name</span> localhost;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">location</span> /a/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:8080;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">location</span> /b/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:8081;</span><br><span class="line"><span class="comment">#proxy_set_header å®¢æˆ·ç«¯è¯·æ±‚å‘é€ç»™åç«¯æœåŠ¡å™¨ä¹‹å‰,æ›´æ”¹æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚å¤´ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#æŠŠåŸè¯·æ±‚çš„Headerä¸­çš„Hostå­—æ®µä¹Ÿæ”¾åˆ°è½¬å‘é‡Œ,å¦‚æœä¸åŠ åç«¯è·å–çš„è¯·æ±‚ä¸ºnginxçš„IP</span></span><br><span class="line">    <span class="attribute">proxy_set_header</span> Â  Host Â  Â <span class="variable">$host</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#è·å¾—ç”¨æˆ·çš„çœŸå®ip</span></span><br><span class="line">    <span class="attribute">proxy_set_header</span> Â  X-Real-IP Â  <span class="variable">$remote_addr</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Â  X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#è¯†åˆ«åè®®HTTPæˆ–HTTPS</span></span><br><span class="line">    <span class="attribute">proxy_set_header</span> Â  X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#é…ç½®Nginxä¸åç«¯ä»£ç†æœåŠ¡å™¨å°è¯•å»ºç«‹è¿æ¥çš„è¶…æ—¶æ—¶é—´</span></span><br><span class="line">    <span class="attribute">proxy_connect_timeout</span> <span class="number">300</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#è¿æ¥æˆåŠŸå_ç­‰å€™åç«¯æœåŠ¡å™¨å“åº”æ—¶é—´</span></span><br><span class="line"><span class="attribute">proxy_send_timeout</span> <span class="number">300</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#åç«¯æœåŠ¡å™¨æ•°æ®å›ä¼ æ—¶é—´</span></span><br><span class="line"><span class="attribute">proxy_read_timeout</span> <span class="number">300</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¿®æ”¹åç«¯æœåŠ¡å™¨è¿”å›çš„å“åº”å¤´ä¸­çš„Locationå’ŒRefresh</span></span><br><span class="line"><span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="é…ç½®è´Ÿè½½å‡è¡¡"><a href="#é…ç½®è´Ÿè½½å‡è¡¡" class="headerlink" title="é…ç½®è´Ÿè½½å‡è¡¡"></a>é…ç½®è´Ÿè½½å‡è¡¡</h4><p>Nginx æä¾›äº†å¥½å‡ ç§åˆ†é…æ–¹å¼,é»˜è®¤ä¸ºè½®è¯¢,å°±æ˜¯è½®æµæ¥ã€‚æœ‰ä»¥ä¸‹å‡ ç§åˆ†é…æ–¹å¼ï¼š</p><p>1.è½®è¯¢,é»˜è®¤æ–¹å¼,æ¯ä¸ªè¯·æ±‚æŒ‰æ—¶é—´é¡ºåºé€ä¸€åˆ†é…åˆ°ä¸åŒçš„åç«¯æœåŠ¡å™¨,å¦‚æœåç«¯æœåŠ¡æŒ‚äº†,èƒ½è‡ªåŠ¨å‰”é™¤ï¼›</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="attribute">upstream</span> myserver &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8081</span>;  <span class="comment"># è´Ÿè½½å‡è¡¡ç›®çš„æœåŠ¡åœ°å€</span></span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1</span>:8082p;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.weight,æƒé‡åˆ†é…,æŒ‡å®šè½®è¯¢å‡ ç‡,æƒé‡è¶Šé«˜,åœ¨è¢«è®¿é—®çš„æ¦‚ç‡è¶Šå¤§,ç”¨äºåç«¯æœåŠ¡å™¨æ€§èƒ½ä¸å‡çš„æƒ…å†µï¼›</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="attribute">upstream</span> myserver &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8081</span> weight=<span class="number">1</span>;  <span class="comment"># è´Ÿè½½å‡è¡¡ç›®çš„æœåŠ¡åœ°å€</span></span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8080</span> weight=<span class="number">1</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8082</span> weight=<span class="number">10</span>;  <span class="comment"># weight æ–¹å¼,ä¸å†™é»˜è®¤ä¸º 1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3.ip_hash,å¯¹å®¢æˆ·ç«¯è¯·æ±‚çš„ipè¿›è¡Œhashæ“ä½œ,ç„¶åæ ¹æ®hashç»“æœå°†åŒä¸€ä¸ªå®¢æˆ·ç«¯ipçš„è¯·æ±‚åˆ†å‘ç»™åŒä¸€å°æœåŠ¡å™¨è¿›è¡Œå¤„ç†,å¯ä»¥è§£å†³sessionä¸å…±äº«çš„é—®é¢˜ã€‚</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="attribute">upstream</span> myserver &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8081</span>;  <span class="comment"># è´Ÿè½½å‡è¡¡ç›®çš„æœåŠ¡åœ°å€</span></span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8082</span>;</span><br><span class="line">    ip_hash;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/iphash.png" alt="iphash"></p><p>4.fairï¼ˆç¬¬ä¸‰æ–¹ï¼‰,æŒ‰åç«¯æœåŠ¡å™¨çš„å“åº”æ—¶é—´åˆ†é…,å“åº”æ—¶é—´çŸ­çš„ä¼˜å…ˆåˆ†é…,ä¾èµ–ç¬¬ä¸‰æ–¹æ’ä»¶ nginx-upstream-fair,éœ€è¦å…ˆå®‰è£…ï¼›</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="attribute">upstream</span> myserver &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8081</span>;  <span class="comment"># è´Ÿè½½å‡è¡¡ç›®çš„æœåŠ¡åœ°å€</span></span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8082</span>;</span><br><span class="line">    fair;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>5.backup,æºå¸¦backupä»£è¡¨æ­¤serverä¸ºå¤‡ç”¨,nginxåªæœ‰åœ¨è½¬å‘åˆ°ä¸»serverå‡ºç°é—®é¢˜,æ‰ä¼šåˆ‡æ¢åˆ°backupçš„server</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="attribute">upstream</span> myserver &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8081</span>;  <span class="comment"># è´Ÿè½½å‡è¡¡ç›®çš„æœåŠ¡åœ°å€</span></span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8082</span> backup;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¼€å¯gzip</strong></p><p>gzip æ˜¯ä¸€ç§å¸¸ç”¨çš„ç½‘é¡µå‹ç¼©æŠ€æœ¯,ä¼ è¾“çš„ç½‘é¡µç»è¿‡ gzip å‹ç¼©ä¹‹åå¤§å°é€šå¸¸å¯ä»¥å˜ä¸ºåŸæ¥çš„ä¸€åŠç”šè‡³æ›´å°ï¼ˆå®˜ç½‘åŸè¯ï¼‰,æ›´å°çš„ç½‘é¡µä½“ç§¯ä¹Ÿå°±æ„å‘³ç€å¸¦å®½çš„èŠ‚çº¦å’Œä¼ è¾“é€Ÿåº¦çš„æå‡,ç‰¹åˆ«æ˜¯å¯¹äºè®¿é—®é‡å·¨å¤§å¤§å‹ç½‘ç«™æ¥è¯´,æ¯ä¸€ä¸ªé™æ€èµ„æºä½“ç§¯çš„å‡å°,éƒ½ä¼šå¸¦æ¥å¯è§‚çš„æµé‡ä¸å¸¦å®½çš„èŠ‚çœã€‚</p><p>ä½¿ç”¨ gzip ä¸ä»…éœ€è¦ Nginx é…ç½®,æµè§ˆå™¨ç«¯ä¹Ÿéœ€è¦é…åˆ,éœ€è¦åœ¨è¯·æ±‚æ¶ˆæ¯å¤´ä¸­åŒ…å« Accept-Encoding: gzipï¼ˆIE5 ä¹‹åæ‰€æœ‰çš„æµè§ˆå™¨éƒ½æ”¯æŒäº†,æ˜¯ç°ä»£æµè§ˆå™¨çš„é»˜è®¤è®¾ç½®ï¼‰ã€‚ä¸€èˆ¬åœ¨è¯·æ±‚ html å’Œ css ç­‰é™æ€èµ„æºçš„æ—¶å€™,æ”¯æŒçš„æµè§ˆå™¨åœ¨ request è¯·æ±‚é™æ€èµ„æºçš„æ—¶å€™,ä¼šåŠ ä¸Š Accept-Encoding: gzip è¿™ä¸ª header,è¡¨ç¤ºè‡ªå·±æ”¯æŒ gzip çš„å‹ç¼©æ–¹å¼,Nginx åœ¨æ‹¿åˆ°è¿™ä¸ªè¯·æ±‚çš„æ—¶å€™,å¦‚æœæœ‰ç›¸åº”é…ç½®,å°±ä¼šè¿”å›ç»è¿‡ gzip å‹ç¼©è¿‡çš„æ–‡ä»¶ç»™æµè§ˆå™¨,å¹¶åœ¨ response ç›¸åº”çš„æ—¶å€™åŠ ä¸Š content-encoding: gzip æ¥å‘Šè¯‰æµè§ˆå™¨è‡ªå·±é‡‡ç”¨çš„å‹ç¼©æ–¹å¼ï¼ˆå› ä¸ºæµè§ˆå™¨åœ¨ä¼ ç»™æœåŠ¡å™¨çš„æ—¶å€™ä¸€èˆ¬è¿˜å‘Šè¯‰æœåŠ¡å™¨è‡ªå·±æ”¯æŒå¥½å‡ ç§å‹ç¼©æ–¹å¼ï¼‰,æµè§ˆå™¨æ‹¿åˆ°å‹ç¼©çš„æ–‡ä»¶å,æ ¹æ®è‡ªå·±çš„è§£å‹æ–¹å¼è¿›è¡Œè§£æã€‚</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿›è¡Œå‹ç¼©çš„æ–‡ä»¶ç±»å‹ã€‚javascriptæœ‰å¤šç§å½¢å¼ã€‚å…¶ä¸­çš„å€¼å¯ä»¥åœ¨ mime.types æ–‡ä»¶ä¸­æ‰¾åˆ°ã€‚</span></span><br><span class="line"><span class="attribute">gzip_types</span> text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;</span><br><span class="line"></span><br><span class="line"><span class="comment">#é»˜è®¤ off,è¯¥æ¨¡å—å¯ç”¨å,Nginx é¦–å…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨è¯·æ±‚é™æ€æ–‡ä»¶çš„ gz ç»“å°¾çš„æ–‡ä»¶,å¦‚æœæœ‰åˆ™ç›´æ¥è¿”å›è¯¥ .gz æ–‡ä»¶å†…å®¹;</span></span><br><span class="line"><span class="attribute">gzip_static</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#é»˜è®¤ off,nginxåšä¸ºåå‘ä»£ç†æ—¶å¯ç”¨,ç”¨äºè®¾ç½®å¯ç”¨æˆ–ç¦ç”¨ä»ä»£ç†æœåŠ¡å™¨ä¸Šæ”¶åˆ°ç›¸åº”å†…å®¹ gzip å‹ç¼©ï¼›</span></span><br><span class="line"><span class="attribute">gzip_proxied</span> any;</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç”¨äºåœ¨å“åº”æ¶ˆæ¯å¤´ä¸­æ·»åŠ  Varyï¼šAccept-Encoding,ä½¿ä»£ç†æœåŠ¡å™¨æ ¹æ®è¯·æ±‚å¤´ä¸­çš„ Accept-Encoding è¯†åˆ«æ˜¯å¦å¯ç”¨ gzip å‹ç¼©</span></span><br><span class="line"><span class="attribute">gzip_vary</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#gzip å‹ç¼©æ¯”,å‹ç¼©çº§åˆ«æ˜¯ 1-9,1 å‹ç¼©çº§åˆ«æœ€ä½,9 æœ€é«˜,æ•°å­—è¶Šå¤§å‹ç¼©çš„è¶Šå¥½,ä¹Ÿè¶Šå ç”¨CPUæ—¶é—´ã€‚ä¸€èˆ¬è®¾ç½®1å’Œ2ï¼›</span></span><br><span class="line"><span class="attribute">gzip_comp_level</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#è·å–å¤šå°‘å†…å­˜ç”¨äºç¼“å­˜å‹ç¼©ç»“æœ,4 8k è¡¨ç¤ºä»¥ 8k*4 ä¸ºå•ä½è·å¾—ï¼›</span></span><br><span class="line"><span class="attribute">gzip_buffers</span> <span class="number">4</span> <span class="number">8k</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¯ç”¨gzipå‹ç¼©çš„æœ€å°æ–‡ä»¶,å°äºè®¾ç½®å€¼çš„æ–‡ä»¶å°†ä¸ä¼šå‹ç¼©</span></span><br><span class="line"><span class="attribute">gzip_min_length</span> <span class="number">1k</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#é»˜è®¤ 1.1,å¯ç”¨ gzip æ‰€éœ€çš„ HTTP æœ€ä½ç‰ˆæœ¬;è¿™ä¸ªé…ç½®å¯ä»¥æ’å…¥åˆ° http æ¨¡å—æ•´ä¸ªæœåŠ¡å™¨çš„é…ç½®é‡Œ,ä¹Ÿå¯ä»¥æ’å…¥åˆ°éœ€è¦ä½¿ç”¨çš„è™šæ‹Ÿä¸»æœºçš„ server æˆ–è€…ä¸‹é¢çš„ location æ¨¡å—ä¸­</span></span><br><span class="line"><span class="attribute">gzip_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br></pre></td></tr></table></figure><h4 id="é…ç½®-HTTPS"><a href="#é…ç½®-HTTPS" class="headerlink" title="é…ç½® HTTPS"></a>é…ç½® HTTPS</h4><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">443</span> ssl http2 default_server;   <span class="comment"># SSL è®¿é—®ç«¯å£å·ä¸º 443</span></span><br><span class="line">  <span class="attribute">server_name</span> www.nmk0718.com;         <span class="comment"># å¡«å†™ç»‘å®šè¯ä¹¦çš„åŸŸå</span></span><br><span class="line">  <span class="attribute">add_header</span> backendIP <span class="variable">$upstream_addr</span>;   <span class="comment">#æŠŠåç«¯å…·ä½“çš„ upstream è¿”å›ç»™å‰ç«¯ header</span></span><br><span class="line">  <span class="attribute">add_header</span> backendCode <span class="variable">$upstream_status</span>;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">ssl_certificate</span> /etc/nginx/https/nm0718.crt;   <span class="comment"># è¯ä¹¦æ–‡ä»¶åœ°å€</span></span><br><span class="line">  <span class="attribute">ssl_certificate_key</span> /etc/nginx/https/nm0718.key;      <span class="comment"># ç§é’¥æ–‡ä»¶åœ°å€</span></span><br><span class="line">  <span class="attribute">ssl_session_timeout</span> <span class="number">10m</span>;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>;      <span class="comment">#è¯·æŒ‰ç…§ä»¥ä¸‹åè®®é…ç½®</span></span><br><span class="line">  <span class="attribute">ssl_ciphers</span> ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE; </span><br><span class="line">  <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">root</span>         /usr/share/nginx/html;</span><br><span class="line">    <span class="attribute">index</span>        index.html index.htm;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è·¨åŸŸ-CORS-é…ç½®"><a href="#è·¨åŸŸ-CORS-é…ç½®" class="headerlink" title="è·¨åŸŸ CORS é…ç½®"></a>è·¨åŸŸ CORS é…ç½®</h4><p><strong>ä½¿ç”¨åå‘ä»£ç†è§£å†³è·¨åŸŸ</strong></p><p>åœ¨å‰ç«¯æœåŠ¡åœ°å€ä¸º <code>prod.nmk0718.com</code> çš„é¡µé¢è¯·æ±‚ <code>api.nmk0718.com</code> çš„åç«¯æœåŠ¡å¯¼è‡´çš„è·¨åŸŸï¼Œå¯ä»¥è¿™æ ·é…ç½®ï¼š</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">server_name</span> prod.nmk0718.com;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">proxy_pass</span> api.nmk0718.com;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å‰ç«¯è°ƒç”¨prod.nmk0718.comçš„æ¥å£ä¼šè¢«è½¬å‘åapi.nmk0718.com,å‰åç«¯éƒ½æ˜¯prod.nmk0718.comçš„æƒ…å†µä¸‹å°±ä¸å­˜åœ¨è·¨åŸŸäº†</p><p><strong>é…ç½® header è§£å†³è·¨åŸŸ</strong></p><p>åœ¨è¯·æ±‚çš„æ¥å£locationä¸­åŠ å…¥ä»¥ä¸‹é…ç½®è¿›è¡Œè§£å†³è·¨åŸŸ</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">server_name</span> api.nmk0718.com;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">proxy_pass</span> http://localhost:8081;</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ¥å—æ‰€æœ‰è·¨åŸŸçš„è¯·æ±‚</span></span><br><span class="line"><span class="attribute">add_header</span> Access-Control-Allow-Origin *;</span><br><span class="line"></span><br><span class="line"><span class="comment">#å…è®¸çš„è¯·æ±‚æ–¹æ³•</span></span><br><span class="line">    <span class="attribute">add_header</span> Access-Control-Allow-Methods <span class="string">'GET, POST, OPTIONS'</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#å…è®¸è¯·æ±‚çš„header</span></span><br><span class="line">    <span class="attribute">add_header</span> Access-Control-Allow-Headers <span class="string">'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$request_method</span> = <span class="string">'OPTIONS'</span>) &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">204</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="httpè¯·æ±‚è½¬å‘åˆ°https"><a href="#httpè¯·æ±‚è½¬å‘åˆ°https" class="headerlink" title="httpè¯·æ±‚è½¬å‘åˆ°https"></a>httpè¯·æ±‚è½¬å‘åˆ°https</h4><p>é…ç½®å®Œ HTTPS åï¼Œæµè§ˆå™¨è¿˜æ˜¯å¯ä»¥è®¿é—® HTTP çš„åœ°å€çš„ï¼Œå¯ä»¥åšä¸€ä¸ª 301 è·³è½¬ï¼ŒæŠŠå¯¹åº”åŸŸåçš„ HTTP è¯·æ±‚é‡å®šå‘åˆ° HTTPS ä¸Š</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line"><span class="attribute">listen</span>   <span class="number">80</span>;</span><br><span class="line"><span class="attribute">servername</span> www.nmk0718.com;</span><br><span class="line"></span><br><span class="line"><span class="comment">#å•åŸŸåé‡å®šå‘</span></span><br><span class="line">if ($host = 'www.nmk0718.com';)&#123;</span><br><span class="line"><span class="attribute">return</span> <span class="number">301</span> https://www.nmk0718.com<span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#å…¨å±€é https åè®®æ—¶é‡å®šå‘</span></span><br><span class="line">if ($scheme != 'https';)&#123;</span><br><span class="line"><span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#æˆ–è€…å…¨éƒ¨é‡å®šå‘</span></span><br><span class="line"><span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä»¥ä¸Šé…ç½®é€‰æ‹©è‡ªå·±éœ€è¦çš„å³å¯,ä¸ç”¨å…¨éƒ¨åŠ </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è½¬å‘websocket"><a href="#è½¬å‘websocket" class="headerlink" title="è½¬å‘websocket"></a>è½¬å‘websocket</h4><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">map $http_upgrade $connection_upgrade &#123; default upgrade; '' close;&#125; </span><br><span class="line"><span class="section">server</span> &#123; </span><br><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="comment">#â€¦ </span></span><br><span class="line">    <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>; </span><br><span class="line">    <span class="attribute">proxy_set_header</span> Connection <span class="variable">$connection_upgrade</span>; </span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="é™æ€æ–‡ä»¶è½¬å‘"><a href="#é™æ€æ–‡ä»¶è½¬å‘" class="headerlink" title="é™æ€æ–‡ä»¶è½¬å‘"></a>é™æ€æ–‡ä»¶è½¬å‘</h4><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="comment">#è¯·æ±‚/webæ—¶è®¿é—®çš„æ–‡ä»¶ä¸º/home/test/index.html</span></span><br><span class="line"><span class="attribute">location</span> /web &#123;</span><br><span class="line"><span class="attribute">alias</span> /home/test/;</span><br><span class="line"><span class="attribute">index</span> index.html;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#è¯·æ±‚/web/æ—¶è®¿é—®çš„æ–‡ä»¶ä¸º/home/web/index.html</span></span><br><span class="line"><span class="attribute">location</span> /web/ &#123;</span><br><span class="line"><span class="attribute">root</span> /home/;</span><br><span class="line"><span class="attribute">index</span> index.html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">##Vueè·¯ç”±æ¨¡å¼éœ€è¦åŠ å…¥try_files</span></span><br><span class="line"><span class="attribute">location</span> /app &#123;</span><br><span class="line"><span class="attribute">alias</span> /home/test/app/;</span><br><span class="line"><span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html <span class="literal">last</span>;</span><br><span class="line"><span class="attribute">index</span> index.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é™æ€æ–‡ä»¶ç¼“å­˜</strong><br>ç”±äºå›¾ç‰‡ã€å­—ä½“ã€éŸ³é¢‘ã€è§†é¢‘ç­‰é™æ€æ–‡ä»¶åœ¨æ‰“åŒ…çš„æ—¶å€™é€šå¸¸ä¼šå¢åŠ äº† hashï¼Œæ‰€ä»¥ç¼“å­˜å¯ä»¥è®¾ç½®çš„é•¿ä¸€ç‚¹ï¼Œå…ˆè®¾ç½®å¼ºåˆ¶ç¼“å­˜ï¼Œå†è®¾ç½®åå•†ç¼“å­˜ï¼›å¦‚æœå­˜åœ¨æ²¡æœ‰ hash å€¼çš„é™æ€æ–‡ä»¶ï¼Œå»ºè®®ä¸è®¾ç½®å¼ºåˆ¶ç¼“å­˜ï¼Œä»…é€šè¿‡åå•†ç¼“å­˜åˆ¤æ–­æ˜¯å¦éœ€è¦ä½¿ç”¨ç¼“å­˜</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">location</span> <span class="regexp">~ .*\.(css|js|jpg|png|gif|swf|woff|woff2|eot|svg|ttf|otf|mp3|m4a|aac|txt)$</span> &#123;</span><br><span class="line"><span class="attribute">expires</span> <span class="number">10d</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="comment"># å¦‚æœä¸å¸Œæœ›ç¼“å­˜</span></span><br><span class="line"><span class="attribute">expires</span> -<span class="number">1</span>;</span><br></pre></td></tr></table></figure><h4 id="é‡å®šå‘"><a href="#é‡å®šå‘" class="headerlink" title="é‡å®šå‘"></a>é‡å®šå‘</h4><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="comment">#è½¬å‘ åŸŸå/api/åçš„ä»»æ„å­—ç¬¦ åˆ° https://www.nmk0718.com/api/åé¢</span></span><br><span class="line"><span class="attribute">rewrite</span><span class="regexp"> ^/api/(.*)</span>    https://www.nmk0718.com/api/<span class="variable">$1</span> <span class="literal">permanent</span>;</span><br><span class="line">ä¾‹å¦‚è®¿é—® test.nmk0718/api/abc è½¬å‘åˆ° https://www.nmk0718.com/api/abc</span><br><span class="line"></span><br><span class="line"><span class="comment">#è½¬å‘ åŸŸå/nmk0718/indexåçš„ä»»æ„å­—ç¬¦ åˆ°error.jpg</span></span><br><span class="line"><span class="attribute">rewrite</span><span class="regexp"> ^/nmk0718/index(.*)</span> http://nmk0718.com/error.jpg;</span><br><span class="line"></span><br><span class="line"><span class="comment">#è½¬å‘ åŸŸå/nmk0718/indexåå­—ç¬¦è·ŸsystemIdå’Œ&amp;shopsåŒ¹é…çš„é“¾æ¥ åˆ°error.jpg(å› nginxä¸æ”¯æŒandæ•…ä½¿ç”¨setå‚æ•°çš„æ–¹å¼è¿›è¡Œè½¬å‘)</span></span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~/nmk0718/index</span> &#123;</span><br><span class="line">        </span><br><span class="line"><span class="attribute">set</span> <span class="variable">$foo</span> <span class="string">""</span>;</span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$args</span> <span class="regexp">~* "systemId=202006117621654047")</span> &#123;</span><br><span class="line"><span class="attribute">set</span> <span class="variable">$foo</span> <span class="string">"<span class="variable">$&#123;foo&#125;</span>1"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$args</span> <span class="regexp">~* "&amp;shops=102")</span> &#123;</span><br><span class="line"><span class="attribute">set</span> <span class="variable">$foo</span> <span class="string">"<span class="variable">$&#123;foo&#125;</span>1"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$foo</span> <span class="regexp">~* "11")</span> &#123;</span><br><span class="line"><span class="attribute">rewrite</span>  /nmk0718/index    http://nmk0718.com/error.jpg;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">root</span>   html;</span><br><span class="line"><span class="comment">#å®šä¹‰é¦–é¡µç´¢å¼•æ–‡ä»¶çš„åç§°</span></span><br><span class="line"><span class="attribute">index</span>  index.html index.htm index.jsp;</span><br><span class="line"><span class="comment">#å®šä¹‰åç«¯è´Ÿè½½æœåŠ¡å™¨ç»„</span></span><br><span class="line"><span class="attribute">proxy_pass</span> http://nmk/nmk0718/index;</span><br><span class="line"><span class="attribute">proxy_set_header</span>   Host    <span class="variable">$host</span>;  </span><br><span class="line"><span class="attribute">proxy_set_header</span>   X-Real-IP   <span class="variable">$remote_addr</span>;  </span><br><span class="line"><span class="attribute">proxy_set_header</span>   X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ“ä½œå‘½ä»¤"><a href="#æ“ä½œå‘½ä»¤" class="headerlink" title="æ“ä½œå‘½ä»¤"></a>æ“ä½œå‘½ä»¤</h4><p>ä½¿ç”¨nginx -h æŸ¥çœ‹å®Œæ•´çš„nginxå‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@deployment nginx]# ./sbin/nginx -h</span><br><span class="line">nginx version: nginx/1.16.0</span><br><span class="line">Usage: nginx [-?hvVtTq] [-s signal] [-c filename] [-p prefix] [-g directives]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -?,-h         : this help</span><br><span class="line">  -v            : show version and exit</span><br><span class="line">  -V            : show version and configure options then exit</span><br><span class="line">  -t            : test configuration and exit</span><br><span class="line">  -T            : test configuration, dump it and exit</span><br><span class="line">  -q            : suppress non-error messages during configuration testing</span><br><span class="line">  -s signal     : send signal to a master process: stop, quit, reopen, reload</span><br><span class="line">  -p prefix     : set prefix path (default: /usr/local/nginx/)</span><br><span class="line">  -c filename   : set configuration file (default: conf/nginx.conf)</span><br><span class="line">  -g directives : set global directives out of configuration file</span><br><span class="line">  </span><br><span class="line"><span class="meta">#</span><span class="bash">nginxå‘½ä»¤å‚æ•°</span></span><br><span class="line">-c &lt;/path/to/config&gt; ä¸º Nginx æŒ‡å®šä¸€ä¸ªé…ç½®æ–‡ä»¶,æ¥ä»£æ›¿ç¼ºçœçš„ã€‚</span><br><span class="line">-t å¦‚éœ€æ£€æŸ¥é…ç½®æ–‡ä»¶çš„è¯­æ³•çš„æ­£ç¡®æ€§</span><br><span class="line">-v æ˜¾ç¤º nginx çš„ç‰ˆæœ¬</span><br><span class="line">-V æ˜¾ç¤º nginx çš„ç‰ˆæœ¬,ç¼–è¯‘å™¨ç‰ˆæœ¬å’Œé…ç½®å‚æ•°(å¯æŸ¥çœ‹nginxä½¿ç”¨çš„æ¨¡å—)ã€‚</span><br><span class="line">-s reload  # å‘ä¸»è¿›ç¨‹å‘é€ä¿¡å·,é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶</span><br><span class="line">-s reopen # é‡å¯ Nginx</span><br><span class="line">-s stop    # å¿«é€Ÿå…³é—­</span><br><span class="line">-s quit    # ç­‰å¾…å·¥ä½œè¿›ç¨‹å¤„ç†å®Œæˆåå…³é—­</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">---windowsä¸‹nginxå‘½ä»¤---</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">æŸ¥çœ‹nginxè¿›ç¨‹</span></span><br><span class="line">tasklist /fi "imagename eq nginx.exe"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">å¼ºåˆ¶ç»“æŸæ‰€æœ‰nginxè¿›ç¨‹</span></span><br><span class="line">taskkill /F /IM nginx.exe</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">---linuxä¸‹nginxå‘½ä»¤---</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">ä½¿ç”¨yumå®‰è£…çš„ç›®å½•</span></span><br><span class="line">/etc/nginx</span><br><span class="line"><span class="meta">#</span><span class="bash">è‡ªå·±ç¼–è¯‘æˆ–åŒ…å®‰è£…çš„ç›®å½•</span></span><br><span class="line">/usr/local/nginx</span><br><span class="line"><span class="meta">#</span><span class="bash">å¦‚æœä¸¤ç§éƒ½æ²¡æ‰¾åˆ°nginxä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯æŸ¥çœ‹åˆ°ç›®å½•</span></span><br><span class="line"><span class="meta">#</span><span class="bash">centos7ä¹‹å‰</span></span><br><span class="line">service nginx status</span><br><span class="line"><span class="meta">#</span><span class="bash">centos7ä¹‹å</span></span><br><span class="line">systemctl status nginx</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">æŸ¥çœ‹nginxè¿›ç¨‹</span></span><br><span class="line">ps -ef|grep nginx</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">å¼ºåˆ¶ç»“æŸæ‰€æœ‰nginxè¿›ç¨‹</span></span><br><span class="line">killalll nginx</span><br></pre></td></tr></table></figure><h4 id="proxy-passä¸­urlæœ«å°¾å¸¦-ä¸ä¸å¸¦-çš„åŒºåˆ«"><a href="#proxy-passä¸­urlæœ«å°¾å¸¦-ä¸ä¸å¸¦-çš„åŒºåˆ«" class="headerlink" title="proxy_passä¸­urlæœ«å°¾å¸¦/ä¸ä¸å¸¦/çš„åŒºåˆ«"></a>proxy_passä¸­urlæœ«å°¾å¸¦/ä¸ä¸å¸¦/çš„åŒºåˆ«</h4><p><strong>proxy_passé…ç½®ä¸­urlæœ«å°¾å¸¦/æ—¶ï¼Œnginxè½¬å‘æ—¶ï¼Œä¼šå°†åŸuriå»é™¤locationåŒ¹é…è¡¨è¾¾å¼åçš„å†…å®¹æ‹¼æ¥åœ¨proxy_passä¸­urlä¹‹åã€‚</strong></p><figure class="highlight"><table><tr><td class="code"><pre><span class="line">æµ‹è¯•åœ°å€:http://192.168.171.129/test/tes.jsp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">åœºæ™¯ä¸€:</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /test/ &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">proxy_pass</span> http://192.168.171.129:8080/server/;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">ä»£ç†åå®é™…è®¿é—®åœ°å€: http://192.168.171.129:8080/server/tes.jsp</span><br><span class="line"></span><br><span class="line">åœºæ™¯äºŒ:</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /test &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">proxy_pass</span> http://192.168.171.129:8080/server/;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">ä»£ç†åå®é™…è®¿é—®åœ°å€: http://192.168.171.129:8080/server//tes.jsp</span><br><span class="line"></span><br><span class="line">åœºæ™¯ä¸‰:</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /test/ &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">proxy_pass</span> http://192.168.171.129:8080/;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">ä»£ç†åå®é™…è®¿é—®åœ°å€: http://192.168.171.129:8080/tes.jsp</span><br><span class="line"></span><br><span class="line">åœºæ™¯å››:</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /test &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">proxy_pass</span> http://192.168.171.129:8080/;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">ä»£ç†åå®é™…è®¿é—®åœ°å€: http://192.168.171.129:8080//tes.jsp</span><br></pre></td></tr></table></figure><p><strong>proxy_passé…ç½®ä¸­urlæœ«å°¾ä¸å¸¦/æ—¶ï¼Œå¦‚urlä¸­ä¸åŒ…å«pathï¼Œåˆ™ç›´æ¥å°†åŸuriæ‹¼æ¥åœ¨proxy_passä¸­urlä¹‹åï¼›å¦‚urlä¸­åŒ…å«pathï¼Œåˆ™å°†åŸuriå»é™¤locationåŒ¹é…è¡¨è¾¾å¼åçš„å†…å®¹æ‹¼æ¥åœ¨proxy_passä¸­çš„urlä¹‹åã€‚</strong></p><figure class="highlight"><table><tr><td class="code"><pre><span class="line">æµ‹è¯•åœ°å€:http://192.168.171.129/test/tes.jsp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">åœºæ™¯ä¸€:</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /test/ &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">proxy_pass</span> http://192.168.171.129:8080/server;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">ä»£ç†åå®é™…è®¿é—®åœ°å€: http://192.168.171.129:8080/servertes.jsp</span><br><span class="line"></span><br><span class="line">åœºæ™¯äºŒ:</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /test &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">proxy_pass</span> http://192.168.171.129:8080/server;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">ä»£ç†åå®é™…è®¿é—®åœ°å€: http://192.168.171.129:8080/server/tes.jsp</span><br><span class="line"></span><br><span class="line">åœºæ™¯ä¸‰:</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /test/ &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">proxy_pass</span> http://192.168.171.129:8080;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">ä»£ç†åå®é™…è®¿é—®åœ°å€: http://192.168.171.129:8080/test/tes.jsp</span><br><span class="line"></span><br><span class="line">åœºæ™¯å››:</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /test &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">proxy_pass</span> http://192.168.171.129:8080;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">ä»£ç†åå®é™…è®¿é—®åœ°å€: http://192.168.171.129:8080/test/tes.jsp</span><br></pre></td></tr></table></figure><h4 id="é€‚é…-PC-æˆ–ç§»åŠ¨è®¾å¤‡"><a href="#é€‚é…-PC-æˆ–ç§»åŠ¨è®¾å¤‡" class="headerlink" title="é€‚é… PC æˆ–ç§»åŠ¨è®¾å¤‡"></a>é€‚é… PC æˆ–ç§»åŠ¨è®¾å¤‡</h4><p>æ ¹æ®ç”¨æˆ·è®¾å¤‡ä¸åŒè¿”å›ä¸åŒæ ·å¼çš„ç«™ç‚¹ï¼Œä»¥å‰ç»å¸¸ä½¿ç”¨çš„æ˜¯çº¯å‰ç«¯çš„è‡ªé€‚åº”å¸ƒå±€ï¼Œä½†æ— è®ºæ˜¯å¤æ‚æ€§å’Œæ˜“ç”¨æ€§ä¸Šé¢è¿˜æ˜¯ä¸å¦‚åˆ†å¼€ç¼–å†™çš„å¥½ï¼Œæ¯”å¦‚æˆ‘ä»¬å¸¸è§çš„æ·˜å®ã€äº¬ä¸œâ€¦â€¦è¿™äº›å¤§å‹ç½‘ç«™å°±éƒ½æ²¡æœ‰é‡‡ç”¨è‡ªé€‚åº”ï¼Œè€Œæ˜¯ç”¨åˆ†å¼€åˆ¶ä½œçš„æ–¹å¼ï¼Œæ ¹æ®ç”¨æˆ·è¯·æ±‚çš„ user-agent æ¥åˆ¤æ–­æ˜¯è¿”å› PC è¿˜æ˜¯ H5 ç«™ç‚¹ã€‚<br>ä½¿ç”¨<code>$http_user_agent</code> å…¨å±€å˜é‡æ¥åˆ¤æ–­ç”¨æˆ·è¯·æ±‚çš„ <code>user-agent</code>ï¼ŒæŒ‡å‘ä¸åŒçš„ root è·¯å¾„ï¼Œè¿”å›å¯¹åº”ç«™ç‚¹ã€‚</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">server_name</span> www.nmk0718.com;</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">root</span> /usr/share/nginx/html/pc;</span><br><span class="line"></span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$http_user_agent</span> <span class="regexp">~* '(Android|webOS|iPhone|iPod|BlackBerry)')</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">root</span> /usr/share/nginx/html/mobile;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">index</span> index.html;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ³›åŸŸåè½¬å‘"><a href="#æ³›åŸŸåè½¬å‘" class="headerlink" title="æ³›åŸŸåè½¬å‘"></a>æ³›åŸŸåè½¬å‘</h4><h5 id="æ­£åˆ™åŒ¹é…"><a href="#æ­£åˆ™åŒ¹é…" class="headerlink" title="æ­£åˆ™åŒ¹é…"></a>æ­£åˆ™åŒ¹é…</h5><p>å®ç°æ•ˆæœï¼šæŠŠäºŒçº§æˆ–è€…ä¸‰çº§åŸŸåé“¾æ¥é‡å†™åˆ°æˆ‘ä»¬å¸Œæœ›çš„è·¯å¾„,è®©åç«¯å°±å¯ä»¥æ ¹æ®è·¯ç”±è§£æä¸åŒçš„è§„åˆ™ï¼š</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line">test1.nmk0718.com/api?name=a è‡ªåŠ¨è½¬å‘åˆ° 127.0.0.1:8080/test1/api?name=aï¼›</span><br><span class="line">test2.nmk0718.com/api?name=a è‡ªåŠ¨è½¬å‘åˆ° 127.0.0.1:8080/test2/api?name=a ï¼›</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> ~^([\w-]+)\.nmk0718\.com$;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_set_header</span>        X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span>        X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span>        Host <span class="variable">$http_host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span>        X-NginX-Proxy <span class="literal">true</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span>              http://127.0.0.1:8080/<span class="variable">$1</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="é€šé…ç¬¦åŒ¹é…"><a href="#é€šé…ç¬¦åŒ¹é…" class="headerlink" title="é€šé…ç¬¦åŒ¹é…"></a>é€šé…ç¬¦åŒ¹é…</h5><p>å®ç°æ•ˆæœï¼šå›½å†…æœºå™¨æƒ³è®¿é—®è°·æ­Œæ¥å£ï¼Œåœ¨èƒ½è®¿é—®åˆ°å¤–ç½‘çš„æœºå™¨å†…éƒ¨ç½²nginxè½¬å‘è¯¥è®¿é—®</p><p>åœ¨httpå±‚å¢åŠ é…ç½®dnsè§£æ</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment"># å®šä¹‰DNSè§£æå™¨</span></span><br><span class="line">    <span class="attribute">resolver</span> <span class="number">8.8.8.8</span> <span class="number">8.8.4.4</span> valid=<span class="number">300s</span>; <span class="comment"># ä½¿ç”¨Googleçš„å…¬å…±DNSæœåŠ¡å™¨</span></span><br><span class="line">    <span class="attribute">resolver_timeout</span> <span class="number">10s</span>; <span class="comment"># è®¾ç½®DNSè§£æè¶…æ—¶æ—¶é—´ä¸º10ç§’</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨confæ–‡ä»¶ä¸­é…ç½®googleçš„æ³›åŸŸåè½¬å‘</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> <span class="regexp">*.google.com</span>;</span><br><span class="line">    <span class="attribute">index</span> index.html;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> https://<span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_read_timeout</span> <span class="number">300</span>;</span><br><span class="line">        <span class="attribute">proxy_connect_timeout</span> <span class="number">300</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span>   X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span>   Host              <span class="variable">$host</span>:<span class="variable">$server_port</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span>   X-Forwarded-For   <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span>   X-Requested-With  XMLHttpRequest;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®å,æœ¬åœ°éœ€è¦è®¿é—®ä»€ä¹ˆåŸŸåï¼Œå°±éœ€è¦ç»‘å®šä¸€ä¸ªhost</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#nginxæœºå™¨ip googleåŸŸå</span></span><br><span class="line">1.1.1.1 www.google.com</span><br><span class="line">2.2.2.2 mail.google.com</span><br></pre></td></tr></table></figure><p>è®¿é—®<a href="http://www.google.com" target="_blank" rel="noopener">http://www.google.com</a> å’Œ <a href="http://mail.google.com" target="_blank" rel="noopener">http://mail.google.com</a> çš„æ¥å£éƒ½å¯è½¬å‘<br>å¦‚éœ€é›†ç¾¤å†…ä½¿ç”¨ï¼Œå¯é…ç½®k8sçš„corednsé…åˆä½¿ç”¨</p><h5 id="server-nameä¸hoståŒ¹é…ä¼˜å…ˆçº§ï¼š"><a href="#server-nameä¸hoståŒ¹é…ä¼˜å…ˆçº§ï¼š" class="headerlink" title="server_nameä¸hoståŒ¹é…ä¼˜å…ˆçº§ï¼š"></a>server_nameä¸hoståŒ¹é…ä¼˜å…ˆçº§ï¼š</h5><ol><li><p>å®Œå…¨åŒ¹é…</p></li><li><p>é€šé…ç¬¦åœ¨å‰çš„ï¼Œå¦‚*.test.com</p></li><li><p>åœ¨åçš„ï¼Œå¦‚<a href="http://www.test" target="_blank" rel="noopener">www.test</a>.*</p></li><li><p>æ­£åˆ™åŒ¹é…ï¼Œå¦‚~^.www.test.com$</p></li></ol><p>å¦‚æœéƒ½ä¸åŒ¹é…</p><ol><li><p>ä¼˜å…ˆé€‰æ‹©listené…ç½®é¡¹åæœ‰defaultæˆ–default_serverçš„</p></li><li><p>æ‰¾åˆ°åŒ¹é…listenç«¯å£çš„ç¬¬ä¸€ä¸ªserverå—</p></li></ol><h4 id="æ³›åŸŸåè·¯å¾„åˆ†ç¦»"><a href="#æ³›åŸŸåè·¯å¾„åˆ†ç¦»" class="headerlink" title="æ³›åŸŸåè·¯å¾„åˆ†ç¦»"></a>æ³›åŸŸåè·¯å¾„åˆ†ç¦»</h4><p>è¿™æ˜¯ä¸€ä¸ªéå¸¸å®ç”¨çš„æŠ€èƒ½,ç»å¸¸æœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½éœ€è¦é…ç½®ä¸€äº›äºŒçº§æˆ–è€…ä¸‰çº§åŸŸå,å¸Œæœ›é€šè¿‡ Nginx è‡ªåŠ¨æŒ‡å‘å¯¹åº”ç›®å½•,æ¯”å¦‚ï¼š</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line">test1.nmk0718.com è‡ªåŠ¨æŒ‡å‘ /usr/share/nginx/html/test1 æœåŠ¡å™¨åœ°å€ï¼›</span><br><span class="line">test2.nmk0718.com è‡ªåŠ¨æŒ‡å‘ /usr/share/nginx/html/test2 æœåŠ¡å™¨åœ°å€ï¼›</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  ~^([\w-]+)\.nmk0718\.com$;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">root</span> /usr/share/nginx/html/<span class="variable">$1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1.ä¸ºäº†ä½¿ Nginx é…ç½®æ›´æ˜“äºç»´æŠ¤,å»ºè®®ä¸ºæ¯ä¸ªæœåŠ¡åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„é…ç½®æ–‡ä»¶,å­˜å‚¨åœ¨ /etc/nginx/conf/website ç›®å½•,æ ¹æ®éœ€æ±‚å¯ä»¥åˆ›å»ºä»»æ„å¤šä¸ªç‹¬ç«‹çš„é…ç½®æ–‡ä»¶ã€‚<br>2.ç‹¬ç«‹çš„é…ç½®æ–‡ä»¶,å»ºè®®éµå¾ªä»¥ä¸‹å‘½åçº¦å®š &lt;æœåŠ¡&gt;.conf,æ¯”å¦‚åŸŸåæ˜¯www. nmk0718.comâ€,é‚£ä¹ˆä½ çš„é…ç½®æ–‡ä»¶çš„åº”è¯¥æ˜¯è¿™æ ·çš„./etc/nginx/conf/website/www. nmk0718.com.conf,å¦‚æœéƒ¨ç½²å¤šä¸ªæœåŠ¡,ä¹Ÿå¯ä»¥åœ¨æ–‡ä»¶åä¸­åŠ ä¸Š Nginx è½¬å‘çš„ç«¯å£å·ã€‚<br>3.Nginx æ—¥å¿—ç›¸å…³ç›®å½•,å†…ä»¥ åŸŸå.type.log å‘½åï¼ˆæ¯”å¦‚www. nmk0718.com.access.log å’Œ www. nmk0718.com.error.log ï¼‰ä½äº /var/log/nginx/ ç›®å½•ä¸­,ä¸ºæ¯ä¸ªç‹¬ç«‹çš„æœåŠ¡é…ç½®ä¸åŒçš„è®¿é—®æƒé™å’Œé”™è¯¯æ—¥å¿—æ–‡ä»¶,è¿™æ ·æŸ¥æ‰¾é”™è¯¯æ—¶,ä¼šæ›´åŠ æ–¹ä¾¿å¿«æ·ã€‚<br>æ—¥å¿—ç›¸å…³ç›®å½•,å†…ä»¥ åŸŸå.type.log å‘½åï¼ˆæ¯”å¦‚ www. nmk0718.com.access.log å’Œ www. nmk0718.com.error.log ï¼‰ä½äº /var/log/nginx/ ç›®å½•ä¸­,ä¸ºæ¯ä¸ªç‹¬ç«‹çš„æœåŠ¡é…ç½®ä¸åŒçš„è®¿é—®æƒé™å’Œé”™è¯¯æ—¥å¿—æ–‡ä»¶,è¿™æ ·æŸ¥æ‰¾é”™è¯¯æ—¶,ä¼šæ›´åŠ æ–¹ä¾¿å¿«æ·ã€‚</p><h4 id="è½¬å‘ç‰©ç†æœº-å®¹å™¨æµé‡10-1"><a href="#è½¬å‘ç‰©ç†æœº-å®¹å™¨æµé‡10-1" class="headerlink" title="è½¬å‘ç‰©ç†æœº:å®¹å™¨æµé‡10:1"></a>è½¬å‘ç‰©ç†æœº:å®¹å™¨æµé‡10:1</h4><p>è½¬å‘æ€è·¯:user&gt;master-nginx&gt;upstream&gt;slave-nginxæˆ–ingress</p><p>æœ€åæ•ˆæœ:ç”¨æˆ·è®¿é—®åŸŸå,åŸŸåè¿›å…¥nginxçš„upstream 10æ¬¡æœ‰1æ¬¡è¿›å…¥ingressè½¬å‘ç»™å®¹å™¨,å¦å¤–å°±æ­¤è½¬å‘ç»™slave-nginx,å†è½¬ç»™ç‰©ç†æœº</p><p>master-nginx</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="comment">#ç‰©ç†æœºåŒèŠ‚ç‚¹</span></span><br><span class="line"><span class="attribute">upstream</span> nmk&#123;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">172.17.53.153:19151</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">172.17.53.154:19151</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> æ”¹ä¸º</span><br><span class="line"><span class="comment">#148ä¸ºslave-nginxçš„ip,172ä¸ºingressçš„ip</span></span><br><span class="line"><span class="attribute">upstream</span> nmkhttp &#123;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">172.17.53.148:80</span> weight=<span class="number">10</span> fail_timeout=<span class="number">10</span>;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">172.17.53.172:80</span> weight=<span class="number">1</span> fail_timeout=<span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">upstream</span> nmkhttps &#123;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">172.17.53.148:443</span> weight=<span class="number">10</span> fail_timeout=<span class="number">10</span>;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">172.17.53.172:443</span> weight=<span class="number">1</span> fail_timeout=<span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span> default;</span><br><span class="line"><span class="attribute">server_name</span>  www.nmk0718.com</span><br><span class="line"></span><br><span class="line">location /nmk &#123;</span><br><span class="line"><span class="attribute">root</span>   html;</span><br><span class="line"><span class="comment">#å®šä¹‰é¦–é¡µç´¢å¼•æ–‡ä»¶çš„åç§°</span></span><br><span class="line"><span class="attribute">index</span>  index.html index.htm index.jsp;</span><br><span class="line"><span class="comment">#å®šä¹‰åç«¯è´Ÿè½½æœåŠ¡å™¨ç»„</span></span><br><span class="line"><span class="attribute">proxy_pass</span> http://nmkhttp;</span><br><span class="line"><span class="attribute">proxy_set_header</span>   Host   <span class="variable">$host</span>:<span class="variable">$server_port</span>;  </span><br><span class="line"><span class="attribute">proxy_set_header</span>   X-Real-IP   <span class="variable">$remote_addr</span>;  </span><br><span class="line"><span class="attribute">proxy_set_header</span>   X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>; </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">            <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">8443</span> ssl;</span><br><span class="line">            <span class="attribute">server_name</span> www.nmk0718.com</span><br><span class="line"></span><br><span class="line">location /nmk &#123;</span><br><span class="line"><span class="attribute">root</span>   html;</span><br><span class="line"><span class="comment">#å®šä¹‰é¦–é¡µç´¢å¼•æ–‡ä»¶çš„åç§°</span></span><br><span class="line"><span class="attribute">index</span>  index.html index.htm index.jsp;</span><br><span class="line"><span class="comment">#å®šä¹‰åç«¯è´Ÿè½½æœåŠ¡å™¨ç»„</span></span><br><span class="line"><span class="attribute">proxy_pass</span> https://nmkhttps;</span><br><span class="line"><span class="attribute">proxy_set_header</span>   Host   <span class="variable">$host</span>:<span class="variable">$server_port</span>;  </span><br><span class="line"><span class="attribute">proxy_set_header</span>   X-Real-IP   <span class="variable">$remote_addr</span>;  </span><br><span class="line"><span class="attribute">proxy_set_header</span>   X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>slave-nginx</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">upstream</span> nmk&#123;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">172.17.53.153:19151</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">172.17.53.154:19151</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span> default;</span><br><span class="line"><span class="attribute">server_name</span>  www.nmk0718.com</span><br><span class="line"></span><br><span class="line">location /nmk &#123;</span><br><span class="line"><span class="attribute">root</span>   html;</span><br><span class="line"><span class="comment">#å®šä¹‰é¦–é¡µç´¢å¼•æ–‡ä»¶çš„åç§°</span></span><br><span class="line"><span class="attribute">index</span>  index.html index.htm index.jsp;</span><br><span class="line"><span class="comment">#å®šä¹‰åç«¯è´Ÿè½½æœåŠ¡å™¨ç»„</span></span><br><span class="line"><span class="attribute">proxy_pass</span> http://nmk;</span><br><span class="line"><span class="attribute">proxy_set_header</span>   Host   <span class="variable">$host</span>:<span class="variable">$server_port</span>;  </span><br><span class="line"><span class="attribute">proxy_set_header</span>   X-Real-IP   <span class="variable">$remote_addr</span>;  </span><br><span class="line"><span class="attribute">proxy_set_header</span>   X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>; </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="åç«¯å¥åº·æ£€æŸ¥"><a href="#åç«¯å¥åº·æ£€æŸ¥" class="headerlink" title="åç«¯å¥åº·æ£€æŸ¥"></a>åç«¯å¥åº·æ£€æŸ¥</h4><p>nginxè‡ªå¸¦å¥åº·æ£€æŸ¥çš„ç¼ºé™·ï¼š</p><ol><li>Nginxåªæœ‰å½“æœ‰è®¿é—®æ—¶åï¼Œæ‰å‘èµ·å¯¹åç«¯èŠ‚ç‚¹æ¢æµ‹ã€‚</li><li>å¦‚æœæœ¬æ¬¡è¯·æ±‚ä¸­ï¼ŒèŠ‚ç‚¹æ­£å¥½å‡ºç°æ•…éšœï¼ŒNginxä¾ç„¶å°†è¯·æ±‚è½¬äº¤ç»™æ•…éšœçš„èŠ‚ç‚¹,ç„¶åå†è½¬äº¤ç»™å¥åº·çš„èŠ‚ç‚¹å¤„ç†ã€‚æ‰€ä»¥ä¸ä¼šå½±å“åˆ°è¿™æ¬¡è¯·æ±‚çš„æ­£å¸¸è¿›è¡Œã€‚ä½†æ˜¯ä¼šå½±å“æ•ˆç‡,å› ä¸ºå¤šäº†ä¸€æ¬¡è½¬å‘</li><li>è‡ªå¸¦æ¨¡å—æ— æ³•åšåˆ°é¢„è­¦</li><li>è¢«åŠ¨å¥åº·æ£€æŸ¥</li></ol><p>ä½¿ç”¨ç¬¬ä¸‰è®¿æ¨¡å—nginx_upstream_check_moduleï¼š</p><ol><li>åŒºåˆ«äºnginxè‡ªå¸¦çš„éä¸»åŠ¨å¼çš„å¿ƒè·³æ£€æµ‹ï¼Œæ·˜å®å¼€å‘çš„tengineè‡ªå¸¦äº†ä¸€ä¸ªæä¾›ä¸»åŠ¨å¼åç«¯æœåŠ¡å™¨å¿ƒè·³æ£€æµ‹æ¨¡å—</li><li>è‹¥å¥åº·æ£€æŸ¥åŒ…ç±»å‹ä¸ºhttpï¼Œåœ¨å¼€å¯å¥åº·æ£€æŸ¥åŠŸèƒ½åï¼Œnginxä¼šæ ¹æ®è®¾ç½®çš„é—´éš”å‘æŒ‡å®šçš„åç«¯æœåŠ¡å™¨ç«¯å£å‘é€å¥åº·æ£€æŸ¥åŒ…ï¼Œå¹¶æ ¹æ®æœŸæœ›çš„HTTPå›å¤çŠ¶æ€ç æ¥åˆ¤æ–­æœåŠ¡æ˜¯å¦å¥åº·ã€‚</li><li>åç«¯çœŸå®èŠ‚ç‚¹ä¸å¯ç”¨ï¼Œåˆ™è¯·æ±‚ä¸ä¼šè½¬å‘åˆ°æ•…éšœèŠ‚ç‚¹</li><li>æ•…éšœèŠ‚ç‚¹æ¢å¤åï¼Œè¯·æ±‚æ­£å¸¸è½¬å‘</li></ol><p>ä¸»åŠ¨åœ°å¥åº·æ£€æŸ¥ï¼Œnignxå®šæ—¶ä¸»åŠ¨åœ°å»pingåç«¯çš„æœåŠ¡åˆ—è¡¨ï¼Œå½“å‘ç°æŸæœåŠ¡å‡ºç°å¼‚å¸¸æ—¶ï¼ŒæŠŠè¯¥æœåŠ¡ä»å¥åº·åˆ—è¡¨ä¸­ç§»é™¤ï¼Œå½“å‘ç°æŸæœåŠ¡æ¢å¤æ—¶ï¼Œåˆèƒ½å¤Ÿå°†è¯¥æœåŠ¡åŠ å›å¥åº·åˆ—è¡¨ä¸­ã€‚æ·˜å®æœ‰ä¸€ä¸ªå¼€æºçš„å®ç°nginx_upstream_check_moduleæ¨¡å—</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">githubåœ°å€ï¼šhttps://github.com/yaoweibin/nginx_upstream_check_module</span><br><span class="line">taobaoå®˜ç½‘ï¼šhttp://tengine.taobao.org/document_cn/http_upstream_check_cn.html</span><br></pre></td></tr></table></figure><p>å®‰è£…nginx_upstream_check_module </p><p>å®‰è£…æ‰©å±•æ¨¡å—ï¼Œéœ€è¦ç¼–è¯‘å®‰è£…çš„nginxï¼Œç‰ˆæœ¬è‡ªå·±é€‰æ‹©</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">è·å–å®‰è£…åŒ…</span></span><br><span class="line">wget https://codeload.github.com/yaoweibin/nginx_upstream_check_module/zip/master</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">ç»™nginxæ‰“è¡¥ä¸</span></span><br><span class="line">unzip master</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">è¿›å…¥nginx-1.16.1ï¼Œè¿›è¡Œæ‰“è¯¥æ¨¡å—çš„è¡¥ä¸</span></span><br><span class="line">yum install patch-2.7.1-12.el7_7.x86_64 -y</span><br><span class="line">patch -p1 &lt; ../nginx_upstream_check_module-master/check_1.16.1+.patch</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">ç¼–è¯‘å®‰è£…</span></span><br><span class="line">./configure --prefix=/usr/local/nginx --add-module=/usr/local/nginx_upstream_check_module-master/</span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">make upgrade</span><br><span class="line"></span><br><span class="line">[root@service nginx]# ./sbin/nginx -V</span><br><span class="line">nginx version: nginx/1.16.1</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) </span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --add-module=/usr/local/nginx_upstream_check_module-master/</span><br></pre></td></tr></table></figure><p>æœåŠ¡æ²»ç†çš„ä¸€ä¸ªé‡è¦ä»»åŠ¡æ˜¯æ„ŸçŸ¥æœåŠ¡èŠ‚ç‚¹å˜æ›´ï¼Œå®ŒæˆæœåŠ¡è‡ªåŠ¨æ³¨å†ŒåŠå¼‚å¸¸èŠ‚ç‚¹çš„è‡ªåŠ¨æ‘˜é™¤ã€‚è¿™å°±éœ€è¦æœåŠ¡æ²»ç†å¹³å°èƒ½å¤Ÿï¼š<code>åŠæ—¶</code>ã€<code>å‡†ç¡®</code>çš„æ„ŸçŸ¥serviceèŠ‚ç‚¹çš„å¥åº·çŠ¶å†µã€‚</p><p>Nginx æä¾›äº†ä¸‰ç§HTTPæœåŠ¡å¥åº·æ£€æŸ¥æ–¹æ¡ˆä¾›ç”¨æˆ·é€‰æ‹©ï¼š</p><ol><li>TCPå±‚é»˜è®¤æ£€æŸ¥æ–¹æ¡ˆï¼š<br>å®šæ—¶ä¸åç«¯æœåŠ¡å»ºç«‹ä¸€æ¡<code>tcpè¿æ¥</code>ï¼Œé“¾æ¥å»ºç«‹æˆåŠŸåˆ™è®¤ä¸ºæœåŠ¡èŠ‚ç‚¹æ˜¯å¥åº·çš„ã€‚</li><li>HTTPå±‚é»˜è®¤æ£€æŸ¥æ–¹æ¡ˆï¼š<br>TCPå±‚æ£€æŸ¥æœ‰ä¸€å®šçš„å±€é™æ€§ï¼š<ol><li>å¾ˆå¤šHTTPæœåŠ¡æ˜¯å¸¦çŠ¶æ€çš„ï¼Œç«¯å£å¤„äºlistençŠ¶æ€å¹¶ä¸èƒ½ä»£è¡¨æœåŠ¡å·²ç»å®Œæˆé¢„çƒ­ï¼›</li><li>ä¸èƒ½çœŸå®åæ˜ æœåŠ¡å†…éƒ¨å¤„ç†é€»è¾‘æ˜¯å¦äº§ç”Ÿæ‹¥å µã€‚</li><li>è¿™æ—¶å¯ä»¥é€‰æ‹©<code>httpå±‚</code>å¥åº·æ£€æŸ¥ï¼Œä¼šå‘æœåŠ¡å‘é€ä¸€ä¸ªhttpè¯·æ±‚<code>GET / HTTP/1.0\r\n\r\n</code>ï¼Œè¿”å›çŠ¶æ€æ˜¯2xxæˆ–3xxæ—¶è®¤ä¸ºåç«¯æœåŠ¡æ­£å¸¸ã€‚</li></ol></li><li>è‡ªå®šä¹‰æ–¹æ¡ˆï¼šï¼ˆnginx_upstream_check_moduleæ¨¡å—ï¼‰<br>å¯æ ¹æ®ä¸‹æ–‡æè¿°è‡ªå®šä¹‰æ£€æŸ¥æ–¹æ¡ˆã€‚</li></ol><h5 id="æŒ‡ä»¤"><a href="#æŒ‡ä»¤" class="headerlink" title="æŒ‡ä»¤"></a>æŒ‡ä»¤</h5><blockquote><p>Syntax: <strong>check</strong> <code>interval=milliseconds [fall=count] [rise=count] [timeout=milliseconds] [default_down=true|false] [type=tcp|http|ssl_hello|mysql|ajp] [port=check_port]</code><br>Default: å¦‚æœæ²¡æœ‰é…ç½®å‚æ•°ï¼Œé»˜è®¤å€¼æ˜¯ï¼š<code>interval=30000 fall=5 rise=2 timeout=1000 default_down=true type=tcp</code><br>Context: <code>upstream</code></p></blockquote><p>æŒ‡ä»¤åé¢çš„å‚æ•°æ„ä¹‰æ˜¯ï¼š</p><ul><li><code>interval</code>ï¼šå‘åç«¯å‘é€çš„å¥åº·æ£€æŸ¥åŒ…çš„é—´éš”ã€‚</li><li><code>fall</code>(fall_count): å¦‚æœè¿ç»­å¤±è´¥æ¬¡æ•°è¾¾åˆ°fall_countï¼ŒæœåŠ¡å™¨å°±è¢«è®¤ä¸ºæ˜¯downã€‚</li><li><code>rise</code>(rise_count): å¦‚æœè¿ç»­æˆåŠŸæ¬¡æ•°è¾¾åˆ°rise_countï¼ŒæœåŠ¡å™¨å°±è¢«è®¤ä¸ºæ˜¯upã€‚</li><li><code>timeout</code>: åç«¯å¥åº·è¯·æ±‚çš„è¶…æ—¶æ—¶é—´ã€‚</li><li><code>default_down</code>: è®¾å®šåˆå§‹æ—¶æœåŠ¡å™¨çš„çŠ¶æ€ï¼Œå¦‚æœæ˜¯trueï¼Œå°±è¯´æ˜é»˜è®¤æ˜¯downçš„ï¼Œå¦‚æœæ˜¯falseï¼Œå°±æ˜¯upçš„ã€‚é»˜è®¤å€¼æ˜¯trueï¼Œä¹Ÿå°±æ˜¯ä¸€å¼€å§‹æœåŠ¡å™¨è®¤ä¸ºæ˜¯ä¸å¯ç”¨ï¼Œè¦ç­‰å¥åº·æ£€æŸ¥åŒ…è¾¾åˆ°ä¸€å®šæˆåŠŸæ¬¡æ•°ä»¥åæ‰ä¼šè¢«è®¤ä¸ºæ˜¯å¥åº·çš„ã€‚</li><li><code>type</code>ï¼šå¥åº·æ£€æŸ¥åŒ…çš„ç±»å‹ï¼Œç°åœ¨æ”¯æŒä»¥ä¸‹å¤šç§ç±»å‹<ul><li><code>tcp</code>ï¼šç®€å•çš„tcpè¿æ¥ï¼Œå¦‚æœè¿æ¥æˆåŠŸï¼Œå°±è¯´æ˜åç«¯æ­£å¸¸ã€‚</li><li><code>ssl_hello</code>ï¼šå‘é€ä¸€ä¸ªåˆå§‹çš„SSL helloåŒ…å¹¶æ¥å—æœåŠ¡å™¨çš„SSL helloåŒ…ã€‚</li><li><code>http</code>ï¼šå‘é€HTTPè¯·æ±‚ï¼Œé€šè¿‡åç«¯çš„å›å¤åŒ…çš„çŠ¶æ€æ¥åˆ¤æ–­åç«¯æ˜¯å¦å­˜æ´»ã€‚</li><li><code>mysql</code>: å‘mysqlæœåŠ¡å™¨è¿æ¥ï¼Œé€šè¿‡æ¥æ”¶æœåŠ¡å™¨çš„greetingåŒ…æ¥åˆ¤æ–­åç«¯æ˜¯å¦å­˜æ´»ã€‚</li><li><code>ajp</code>ï¼šå‘åç«¯å‘é€AJPåè®®çš„CpingåŒ…ï¼Œé€šè¿‡æ¥æ”¶CpongåŒ…æ¥åˆ¤æ–­åç«¯æ˜¯å¦å­˜æ´»ã€‚</li></ul></li><li><code>port</code>: æŒ‡å®šåç«¯æœåŠ¡å™¨çš„æ£€æŸ¥ç«¯å£ã€‚ä½ å¯ä»¥æŒ‡å®šä¸åŒäºçœŸå®æœåŠ¡çš„åç«¯æœåŠ¡å™¨çš„ç«¯å£ï¼Œæ¯”å¦‚åç«¯æä¾›çš„æ˜¯443ç«¯å£çš„åº”ç”¨ï¼Œä½ å¯ä»¥å»æ£€æŸ¥80ç«¯å£çš„çŠ¶æ€æ¥åˆ¤æ–­åç«¯å¥åº·çŠ¶å†µã€‚é»˜è®¤æ˜¯0ï¼Œè¡¨ç¤ºè·Ÿåç«¯serveræä¾›çœŸå®æœåŠ¡çš„ç«¯å£ä¸€æ ·ã€‚è¯¥é€‰é¡¹å‡ºç°äºTengine-1.4.0ã€‚</li></ul><blockquote><p>Syntax: <strong>check_http_expect_alive</strong> <code>[ http_2xx | http_3xx | http_4xx | http_5xx ]</code><br>Default: <code>http_2xx | http_3xx</code><br>Context: <code>upstream</code></p></blockquote><p>è¯¥æŒ‡ä»¤æŒ‡å®šHTTPå›å¤çš„æˆåŠŸçŠ¶æ€ï¼Œé»˜è®¤è®¤ä¸º2XXå’Œ3XXçš„çŠ¶æ€æ˜¯å¥åº·çš„ã€‚</p><blockquote><p>Syntax: <strong>check_http_send</strong> <code>http_packet</code><br>Default: <code>&quot;GET / HTTP/1.0\r\n\r\n&quot;</code><br>Context: <code>upstream</code></p></blockquote><p>è¯¥æŒ‡ä»¤å¯ä»¥é…ç½®httpå¥åº·æ£€æŸ¥åŒ…å‘é€çš„è¯·æ±‚å†…å®¹ã€‚ä¸ºäº†å‡å°‘ä¼ è¾“æ•°æ®é‡ï¼Œæ¨èé‡‡ç”¨<code>&quot;HEAD&quot;</code>æ–¹æ³•ã€‚</p><p>å½“é‡‡ç”¨é•¿è¿æ¥è¿›è¡Œå¥åº·æ£€æŸ¥æ—¶ï¼Œéœ€åœ¨è¯¥æŒ‡ä»¤ä¸­æ·»åŠ keep-aliveè¯·æ±‚å¤´ï¼Œå¦‚ï¼š<code>&quot;HEAD / HTTP/1.1\r\nConnection: keep-alive\r\n\r\n&quot;</code>ã€‚<br>åŒæ—¶ï¼Œåœ¨é‡‡ç”¨<code>&quot;GET&quot;</code>æ–¹æ³•çš„æƒ…å†µä¸‹ï¼Œè¯·æ±‚uriçš„sizeä¸å®œè¿‡å¤§ï¼Œç¡®ä¿å¯ä»¥åœ¨1ä¸ª<code>interval</code>å†…ä¼ è¾“å®Œæˆï¼Œå¦åˆ™ä¼šè¢«å¥åº·æ£€æŸ¥æ¨¡å—è§†ä¸ºåç«¯æœåŠ¡å™¨æˆ–ç½‘ç»œå¼‚å¸¸ã€‚</p><p>å®Œæ•´å‚æ•°é…ç½®:<br><a href="http://tengine.taobao.org/document_cn/http_upstream_check_cn.html" target="_blank" rel="noopener">http://tengine.taobao.org/document_cn/http_upstream_check_cn.html</a></p><p>å®˜æ–¹ç¤ºä¾‹ï¼š</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">upstream</span> cluster1 &#123;</span><br><span class="line">        <span class="comment"># simple round-robin</span></span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.0.1:80</span>;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.0.2:80</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">check</span> interval=<span class="number">3000</span> rise=<span class="number">2</span> fall=<span class="number">5</span> timeout=<span class="number">1000</span> type=http;</span><br><span class="line">        <span class="attribute">check_http_send</span> <span class="string">"HEAD / HTTP/1.0\r\n\r\n"</span>;</span><br><span class="line">        <span class="attribute">check_http_expect_alive</span> http_2xx http_3xx;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">upstream</span> cluster2 &#123;</span><br><span class="line">        <span class="comment"># simple round-robin</span></span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.0.3:80</span>;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.0.4:80</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">check</span> interval=<span class="number">3000</span> rise=<span class="number">2</span> fall=<span class="number">5</span> timeout=<span class="number">1000</span> type=http;</span><br><span class="line">        <span class="attribute">check_keepalive_requests</span> <span class="number">100</span>;</span><br><span class="line">        <span class="attribute">check_http_send</span> <span class="string">"HEAD / HTTP/1.1\r\nConnection: keep-alive\r\n\r\n"</span>;</span><br><span class="line">        <span class="attribute">check_http_expect_alive</span> http_2xx http_3xx;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> /<span class="number">1</span> &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://cluster1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> /<span class="number">2</span> &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://cluster2;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> /status &#123;</span><br><span class="line">            check_status;</span><br><span class="line"></span><br><span class="line">            <span class="attribute">access_log</span>   <span class="literal">off</span>;</span><br><span class="line">            <span class="attribute">allow</span> SOME.IP.ADD.RESS;</span><br><span class="line">            <span class="attribute">deny</span> all;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨demo:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">upstream apiservice&#123;</span><br><span class="line">    server 192.168.50.55:8087;</span><br><span class="line"></span><br><span class="line">    #å¯¹httpä¸»åŠ¨æ£€æµ‹ï¼Œ2XX,3XXä¸ºup,4XX,5xxä¸ºdown</span><br><span class="line">    check interval=3000 rise=2 fall=5 timeout=1000 type=http;</span><br><span class="line">    check_http_send &quot;HEAD /health/check HTTP/1.0\r\n\r\n&quot;;</span><br><span class="line">    check_http_expect_alive http_2xx http_3xx;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    #charset koi8-r;</span><br><span class="line"></span><br><span class="line">    #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">    location /check-status &#123;</span><br><span class="line">    check_status;</span><br><span class="line">    &#125;</span><br><span class="line">    location /doctor-api/ &#123;</span><br><span class="line">            proxy_pass http://apiservice;</span><br><span class="line">            proxy_set_header   Host    $host;</span><br><span class="line">            proxy_set_header   X-Real-IP   $remote_addr;</span><br><span class="line">            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">            proxy_set_header   X-Forwarded-Proto $scheme;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è®¿é—®å¥åº·æ£€æµ‹çš„é¡µé¢<br><img src="/image/check_up.png" alt="check_up"><br>å¯çœ‹åˆ°æœåŠ¡ä¸ºup,æŠŠæœåŠ¡ä¸‹çº¿åå†æ¬¡æŸ¥çœ‹<br><img src="/image/check_down.png" alt="check_down"><br>æœåŠ¡ä¸ºdown,æ­¤æ—¶åç«¯æœåŠ¡å·²ä¸‹çº¿</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server numberæ˜¯åç«¯æœåŠ¡å™¨çš„æ•°é‡</span><br><span class="line">Indexæ˜¯æœåŠ¡å™¨çš„ç´¢å¼• </span><br><span class="line">Upstreamæ˜¯åœ¨é…ç½®ä¸­upstreamçš„åç§° </span><br><span class="line">Nameæ˜¯æœåŠ¡å™¨IP </span><br><span class="line">Statusæ˜¯æœåŠ¡å™¨çš„çŠ¶æ€ </span><br><span class="line">Rise countsæ˜¯æœåŠ¡å™¨è¿ç»­æ£€æŸ¥æˆåŠŸçš„æ¬¡æ•° </span><br><span class="line">Fall countsæ˜¯è¿ç»­æ£€æŸ¥å¤±è´¥çš„æ¬¡æ•° </span><br><span class="line">Check typeæ˜¯æ£€æŸ¥çš„æ–¹å¼ </span><br><span class="line">Check portæ˜¯åç«¯ä¸“é—¨ä¸ºå¥åº·æ£€æŸ¥è®¾ç½®çš„ç«¯å£</span><br></pre></td></tr></table></figure><h4 id="å››å±‚è´Ÿè½½å‡è¡¡"><a href="#å››å±‚è´Ÿè½½å‡è¡¡" class="headerlink" title="å››å±‚è´Ÿè½½å‡è¡¡"></a>å››å±‚è´Ÿè½½å‡è¡¡</h4><p>ä¸ƒå±‚è´Ÿè½½å‡è¡¡ï¼šåªè¯†åˆ«åŸŸåï¼Œæ˜¯httpå±‚ã€‚</p><p>å››å±‚è´Ÿè½½å‡è¡¡ï¼šä¸è¯†åˆ«åŸŸåï¼Œæ˜¯tcpå±‚ï¼Œç±»ä¼¼äºç«¯å£è½¬å‘ã€‚</p><p>å¯ç”¨äºftp,sftp,databaseç­‰ç«¯å£çš„è½¬å‘</p><p>æŸ¥çœ‹å½“å‰æ¨¡å—</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@service nginx]# ./sbin/nginx -V</span><br><span class="line">nginx version: nginx/1.16.1</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) </span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --add-module=/usr/local/nginx_upstream_check_module-master/</span><br></pre></td></tr></table></figure><p>è¿›å…¥æºç ç›®å½•,é‡æ–°ç¼–è¯‘</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /usr/local/nginx-1.16.1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">åœ¨å½“å‰æ¨¡å—å‘½ä»¤åæ·»åŠ --with-stream</span></span><br><span class="line">./configure --prefix=/usr/local/nginx --add-module=/usr/local/nginx_upstream_check_module-master/ --with-stream</span><br><span class="line"></span><br><span class="line">make &amp; make install</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">å†æ¬¡æŸ¥çœ‹æ·»åŠ æ¨¡å—æ˜¯å¦æˆåŠŸ</span></span><br><span class="line">[root@service nginx]# ./sbin/nginx -V</span><br><span class="line">nginx version: nginx/1.16.1</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) </span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --add-module=/usr/local/nginx_upstream_check_module-master/ --with-stream</span><br></pre></td></tr></table></figure><p>ç¤ºä¾‹é…ç½®:<br>streamæ®µçš„é…ç½®è¦ä¸httpæ®µåœ¨åŒçº§</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">Â·Â·Â·</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">stream</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">upstream</span> mysql &#123;</span><br><span class="line">       <span class="attribute">server</span> <span class="number">192.168.50.51:3306</span> max_fails=<span class="number">2</span> fail_timeout=<span class="number">120s</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">3307</span>;</span><br><span class="line">        <span class="attribute">proxy_connect_timeout</span> <span class="number">10s</span>;</span><br><span class="line">        <span class="attribute">proxy_timeout</span> <span class="number">300s</span>;<span class="comment">#è®¾ç½®å®¢æˆ·ç«¯å’Œä»£ç†æœåŠ¡ä¹‹é—´çš„è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœ5åˆ†é’Ÿå†…æ²¡æ“ä½œå°†è‡ªåŠ¨æ–­å¼€ã€‚</span></span><br><span class="line">        <span class="attribute">proxy_pass</span> mysql;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•è¿æ¥æ˜¯å¦æ­£å¸¸<br><img src="/image/teststream.png" alt="teststream"></p><h4 id="nginxå¢åŠ kafkaæ¨¡å—"><a href="#nginxå¢åŠ kafkaæ¨¡å—" class="headerlink" title="nginxå¢åŠ kafkaæ¨¡å—"></a>nginxå¢åŠ kafkaæ¨¡å—</h4><p>æ¨¡å—åœ°å€</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https://github.com/brg-liuwei/ngx_kafka_module/tree/master</span><br></pre></td></tr></table></figure><p>ä¸‹è½½æºç </p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.20.1.tar.gz</span><br><span class="line">tar -zxvf  nginx-1.20.1.tar.gz</span><br><span class="line">cd nginx-1.20.1/</span><br></pre></td></tr></table></figure><p>é…ç½®ç¼–è¯‘ä½¿ç”¨çš„æ¨¡å—</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">./configure  --prefix=/usr/share/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --http-client-body-temp-path=/var/lib/nginx/tmp/client_body --http-proxy-temp-path=/var/lib/nginx/tmp/proxy --http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi --http-uwsgi-temp-path=/var/lib/nginx/tmp/uwsgi --http-scgi-temp-path=/var/lib/nginx/tmp/scgi --pid-path=/run/nginx.pid --lock-path=/run/lock/subsys/nginx --user=nginx --group=nginx --with-file-aio --with-ipv6 --with-http_auth_request_module --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_addition_module --with-http_xslt_module=dynamic --with-http_image_filter_module=dynamic --with-http_geoip_module=dynamic --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_degradation_module --with-http_slice_module --with-http_stub_status_module --with-http_perl_module=dynamic --with-mail=dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream=dynamic --with-stream_ssl_module --with-google_perftools_module --with-debug --with-cc-opt=&apos;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic&apos; --with-ld-opt=&apos;-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-E&apos; --with-compat --with-stream_ssl_preread_module --with-threads --add-dynamic-module=/root/ngx_kafka_module</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></figure><p>æ­¤å¤„ä¸è¿›è¡Œinstallå®‰è£…</p><p>è¿›å…¥ç¼–è¯‘çš„ç›®å½•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd objs</span><br><span class="line">[root@idt01 objs]# ./nginx -c /etc/nginx/nginx.conf -t</span><br><span class="line">nginx: [emerg] module &quot;/usr/lib64/nginx/modules/ngx_http_image_filter_module.so&quot; is not binary compatible in /usr/share/nginx/modules/mod-http-image-filter.conf:1</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test failed</span><br></pre></td></tr></table></figure><p>æ‹·è´soæ–‡ä»¶åˆ°åŸç›®å½•è¿›è¡ŒåŠ è½½</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cp *.so /usr/lib64/nginx/modules/</span><br></pre></td></tr></table></figure><p>å†æ¬¡æµ‹è¯•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">the &quot;ssl&quot; directive is deprecated, use the &quot;listen ... ssl&quot; directive instead</span><br></pre></td></tr></table></figure><p>æ³¨é‡Šé…ç½®æ–‡ä»¶ä¸­çš„ssl onï¼›åŒæ—¶åœ¨listen 443; åé¢åŠ ä¸Š ssl</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">listen 443  ssl;</span><br><span class="line">#ssl on;</span><br></pre></td></tr></table></figure><p>å†æ¬¡æµ‹è¯•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">version 1.20.1 of nginx.pm is required, but 1.12.2 was found</span><br></pre></td></tr></table></figure><p>find nginx.pmå‘ç°ï¼Œè¿™ä¸ªperlæ–‡ä»¶ï¼Œåœ¨make installçš„æ—¶å€™ï¼Œä¹Ÿä¼šå®‰è£…ï¼Œå¦‚æœä¸æŒ‡å®šå®‰è£…ç›®å½•ï¼Œè¿™ä¸ªæ–‡ä»¶ä¼šé»˜è®¤å®‰è£…åˆ°/usr/local/lib64/perl5/nginx.pmã€‚<br>è€Œnginx.pmé‡Œé¢è®°å½•äº†nginxçš„ç‰ˆæœ¬å·ã€‚æ‰€ä»¥ï¼Œå¦‚æœå¯åŠ¨nginxçš„æ—¶å€™ï¼Œè¿è¡Œçš„nginxä¸nginx.pmç‰ˆæœ¬å·ä¸ä¸€è‡´å°±æœ‰é—®é¢˜</p><p>åœ¨æµ‹è¯•çš„æœºå™¨è¿›è¡Œä¸Šè¿°æ“ä½œå¹¶è¿›è¡Œinstallå®‰è£…,æŠŠperl5ä¸‹è½½åˆ°æœ¬æœåŠ¡å™¨,æŠŠæœ¬åœ°çš„ç›®å½•è¿›è¡Œå¤‡ä»½,ä½¿ç”¨ä¸‹è½½çš„perl5æ–‡ä»¶å¤¹</p><p>å†æ¬¡æµ‹è¯•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@idt01 objs]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br></pre></td></tr></table></figure><p>./configure: error: C compiler cc is not found</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum -y install gcc gcc-c++ autoconf automake make</span><br></pre></td></tr></table></figure><p>./configure: error: the invalid value in â€“with-ld-opt=â€-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-Eâ€</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum -y install redhat-rpm-config.noarch</span><br></pre></td></tr></table></figure><p>./configure: error: the HTTP rewrite module requires the PCRE library.</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum -y install pcre-devel</span><br></pre></td></tr></table></figure><p>./configure: error: SSL modules require the OpenSSL library.</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum -y install openssl openssl-devel</span><br></pre></td></tr></table></figure><p>./configure: error: the HTTP XSLT module requires the libxml2/libxslt</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum -y install libxml2 libxml2-dev libxslt-devel</span><br></pre></td></tr></table></figure><p>./configure: error: the HTTP image filter module requires the GD library.</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum -y install gd-devel</span><br></pre></td></tr></table></figure><p>./configure: error: perl module ExtUtils::Embed is required</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum -y install perl-devel perl-ExtUtils-Embed</span><br></pre></td></tr></table></figure><p>./configure: error: the GeoIP module requires the GeoIP library.</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum -y install GeoIP GeoIP-devel GeoIP-data</span><br></pre></td></tr></table></figure><p>./configure: error: the Google perftools module requires the Google perftools</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum -y install gperftools</span><br></pre></td></tr></table></figure><p>[root@rancher modules]# nginx -t<br>nginx: [emerg] dlopen() â€œ/usr/lib64/nginx/modules/ngx_http_kafka_module.soâ€ failed (librdkafka.so.1: cannot open shared object file: No such file or directory) in /usr/share/nginx/modules/mod-kafka.conf:1</p><p><a href="https://www.jianshu.com/p/635e8cde4cbc" target="_blank" rel="noopener">https://www.jianshu.com/p/635e8cde4cbc</a></p><p>å‚è€ƒæ–‡æ¡£:<br><a href="https://blog.csdn.net/stormwolf/article/details/123371698" target="_blank" rel="noopener">https://blog.csdn.net/stormwolf/article/details/123371698</a></p><p><a href="http://t.zoukankan.com/damon-blogs-p-14158831.html" target="_blank" rel="noopener">http://t.zoukankan.com/damon-blogs-p-14158831.html</a></p><p><a href="https://blog.csdn.net/sayyy/article/details/121179039?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~aggregatepage~first_rank_ecpm_v1~rank_v31_ecpm-6-121179039-null-null.pc_agg_new_rank&amp;utm_term=nginx%E6%B7%BB%E5%8A%A0%E6%A8%A1%E5%9D%97stream&amp;spm=1000.2123.3001.4430" target="_blank" rel="noopener">https://blog.csdn.net/sayyy/article/details/121179039?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~aggregatepage~first_rank_ecpm_v1~rank_v31_ecpm-6-121179039-null-null.pc_agg_new_rank&amp;utm_term=nginx%E6%B7%BB%E5%8A%A0%E6%A8%A1%E5%9D%97stream&amp;spm=1000.2123.3001.4430</a></p><p>ä¸ºäº†ä½¿ Nginx é…ç½®æ›´æ˜“äºç»´æŠ¤ï¼Œå»ºè®®ä¸ºæ¯ä¸ªæœåŠ¡åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„é…ç½®æ–‡ä»¶ï¼Œå­˜å‚¨åœ¨ /usr/local/nginx/website ç›®å½•ï¼Œæ ¹æ®éœ€æ±‚å¯ä»¥åˆ›å»ºä»»æ„å¤šä¸ªç‹¬ç«‹çš„é…ç½®æ–‡ä»¶ã€‚</p><p>ç‹¬ç«‹çš„é…ç½®æ–‡ä»¶ï¼Œå»ºè®®éµå¾ªä»¥ä¸‹å‘½åçº¦å®š &lt;åŸŸå&gt;.confï¼Œæ¯”å¦‚åŸŸåæ˜¯ nmk0718.comï¼Œé‚£ä¹ˆä½ çš„é…ç½®æ–‡ä»¶çš„åº”è¯¥æ˜¯è¿™æ ·çš„ /usr/local/nginx/website/<a href="http://www.nmk0718.com.conf,æŠŠlocationå•ç‹¬æŠ½å‡ºæ”¾åœ¨/usr/local/nginx/include/www.nmk0718.com.confä¸­è¿›è¡Œå­˜å‚¨.å†é€šè¿‡includeè¿›è¡Œå¼•ç”¨" target="_blank" rel="noopener">www.nmk0718.com.conf,æŠŠlocationå•ç‹¬æŠ½å‡ºæ”¾åœ¨/usr/local/nginx/include/www.nmk0718.com.confä¸­è¿›è¡Œå­˜å‚¨.å†é€šè¿‡includeè¿›è¡Œå¼•ç”¨</a><br>æ–°å¢æœåŠ¡æ—¶,åªéœ€æ›´æ”¹includeä¸­çš„é…ç½®æ–‡ä»¶æœºå³å¯</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@deployment nginx]# ll conf/website/</span><br><span class="line">-rw-r--r--. 1 root root   416 Jun 10  2021 dev.nmk0718.com.conf</span><br><span class="line">-rw-r--r--. 1 root root  7189 Mar 10 15:19 test.nmk0718.com.conf</span><br><span class="line">[root@deployment nginx]# ll conf/include/</span><br><span class="line">-rw-r--r--. 1 root root 13398 Mar 14 17:38 dev.nmk0718.com.conf</span><br><span class="line">-rw-r--r--. 1 root root 14987 Feb 22 15:01 test.nmk0718.com.conf</span><br></pre></td></tr></table></figure><p>Nginx æ—¥å¿—ç›¸å…³ç›®å½•ï¼Œå†…ä»¥ åŸŸå.type.log å‘½åï¼ˆæ¯”å¦‚<a href="http://www.nmk0718.com.access.log" target="_blank" rel="noopener">www.nmk0718.com.access.log</a> å’Œ<a href="http://www.nmk0718.com.error.log" target="_blank" rel="noopener">www.nmk0718.com.error.log</a> ï¼‰ä½äº /usr/local/nginx/log/ ç›®å½•ä¸­ï¼Œä¸ºæ¯ä¸ªç‹¬ç«‹çš„æœåŠ¡é…ç½®ä¸åŒçš„è®¿é—®æƒé™å’Œé”™è¯¯æ—¥å¿—æ–‡ä»¶ï¼Œè¿™æ ·æŸ¥æ‰¾é”™è¯¯æ—¶ï¼Œä¼šæ›´åŠ æ–¹ä¾¿å¿«æ·ã€‚</p><p>å‚è€ƒæ–‡æ¡£:<br><a href="https://blog.csdn.net/Janson_Lin/article/details/105954705" target="_blank" rel="noopener">https://blog.csdn.net/Janson_Lin/article/details/105954705</a><br><a href="https://www.cnblogs.com/cheyunhua/p/14011800.html" target="_blank" rel="noopener">https://www.cnblogs.com/cheyunhua/p/14011800.html</a><br><a href="https://www.cnblogs.com/cuishuai/p/8073748.html" target="_blank" rel="noopener">https://www.cnblogs.com/cuishuai/p/8073748.html</a><br><a href="https://blog.csdn.net/zhanghui200920061988/article/details/105132167" target="_blank" rel="noopener">https://blog.csdn.net/zhanghui200920061988/article/details/105132167</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;ä»‹ç»&quot;&gt;&lt;a href=&quot;#ä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;ä»‹ç»&quot;&gt;&lt;/a&gt;ä»‹ç»&lt;/h4&gt;&lt;p&gt;Nginx æ˜¯å¼€æºã€é«˜æ€§èƒ½ã€é«˜å¯é çš„HTTPæœåŠ¡å™¨,ä¹Ÿå¯ä½œä¸ºåå‘ä»£ç†æœåŠ¡å™¨,é‚®ä»¶æœåŠ¡å™¨ï¼Œæ”¯æŒçƒ­éƒ¨ç½²ï¼Œå ç”¨å†…å­˜å°‘ã€å¹¶å‘èƒ½åŠ›å¼ºã€èƒ½æ”¯æŒé«˜è¾¾ 5w</summary>
      
    
    
    
    
    <category term="nginx" scheme="https://nmk0718.github.io/tag/nginx/"/>
    
  </entry>
  
  <entry>
    <title>Rocketchat</title>
    <link href="https://nmk0718.github.io/2020/07/01/Rocketchat/"/>
    <id>https://nmk0718.github.io/2020/07/01/Rocketchat/</id>
    <published>2020-07-01T14:17:00.000Z</published>
    <updated>2024-11-29T06:43:47.806Z</updated>
    
    <content type="html"><![CDATA[<p>è¯·æ ¹æ®æ“ä½œç³»ç»Ÿé€‰æ‹©å®˜ç½‘å®‰è£…æ–‡æ¡£</p><p>æœ¬æ–‡ä½¿ç”¨centosè¿›è¡Œå®‰è£…</p><p><a href="https://docs.rocket.chat/installation/manual-installation/centos/" target="_blank" rel="noopener">https://docs.rocket.chat/installation/manual-installation/centos/</a></p><p>RocketChatä¸ºå¼€æºçš„èŠå¤©è½¯ä»¶,æ”¯æŒWeb,Windows,Android,ios,macOS</p><h3 id="å®‰è£…å¿…è¦çš„ä¾èµ–åŒ…"><a href="#å®‰è£…å¿…è¦çš„ä¾èµ–åŒ…" class="headerlink" title="å®‰è£…å¿…è¦çš„ä¾èµ–åŒ…"></a>å®‰è£…å¿…è¦çš„ä¾èµ–åŒ…</h3><p>æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨å¹¶é…ç½®yumä»¥ä½¿ç”¨ä»¥ä¸‹yumå­˜å‚¨åº“æ–‡ä»¶å®‰è£…æ­£å¼çš„MongoDBè½¯ä»¶åŒ…ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo yum -y check-update</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF | sudo tee -a /etc/yum.repos.d/mongodb-org-4.0.repo</span><br><span class="line">[mongodb-org-4.0]</span><br><span class="line">name=MongoDB Repository</span><br><span class="line">baseurl=https://repo.mongodb.org/yum/redhat/7/mongodb-org/4.0/x86_64/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://www.mongodb.org/static/pgp/server-4.0.asc</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>é…ç½®è¦é€šè¿‡è½¯ä»¶åŒ…ç®¡ç†å™¨å®‰è£…çš„Node.jsï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo yum install -y curl &amp;&amp; curl -sL https://rpm.nodesource.com/setup_12.x | sudo bash -</span><br></pre></td></tr></table></figure><p>å®‰è£…æ„å»ºå·¥å…·ï¼ŒMongoDBï¼Œnodejså’Œgraphicsmagick</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo yum install -y gcc-c++ make mongodb-org nodejs</span><br><span class="line">sudo yum install -y epel-release &amp;&amp; sudo yum install -y GraphicsMagick</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨npm å®‰è£… inherits å’Œ n ä»¥åŠRocket.Chatæ‰€éœ€çš„èŠ‚ç‚¹ç‰ˆæœ¬ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo npm install -g inherits n &amp;&amp; sudo n 12.14.0</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…Rocket-Chat"><a href="#å®‰è£…Rocket-Chat" class="headerlink" title="å®‰è£…Rocket.Chat"></a>å®‰è£…Rocket.Chat</h3><p>ä¸‹è½½æœ€æ–°çš„Rocket.Chatç‰ˆæœ¬ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -L https://releases.rocket.chat/latest/download -o /tmp/rocket.chat.tgz</span><br><span class="line">tar -xzf /tmp/rocket.chat.tgz -C /tmp</span><br></pre></td></tr></table></figure><p>å®‰è£…ï¼ˆæœ¬æŒ‡å—ä½¿ç”¨/ optï¼Œä½†å¯ä»¥é€‰æ‹©å…¶ä»–ç›®å½•ï¼‰ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /tmp/bundle/programs/server &amp;&amp; npm install</span><br><span class="line">sudo mv /tmp/bundle /opt/Rocket.Chat</span><br></pre></td></tr></table></figure><h3 id="é…ç½®Rocket-ChatæœåŠ¡"><a href="#é…ç½®Rocket-ChatæœåŠ¡" class="headerlink" title="é…ç½®Rocket.ChatæœåŠ¡"></a>é…ç½®Rocket.ChatæœåŠ¡</h3><p>æ·»åŠ rocketchatç”¨æˆ·ï¼Œåœ¨Rocket.Chatæ–‡ä»¶å¤¹ä¸Šè®¾ç½®æ­£ç¡®çš„æƒé™ï¼Œå¹¶åˆ›å»ºRocket.ChatæœåŠ¡æ–‡ä»¶:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo useradd -M rocketchat &amp;&amp; sudo usermod -L rocketchat</span><br><span class="line">sudo chown -R rocketchat:rocketchat /opt/Rocket.Chat</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt; EOF |sudo tee -a /lib/systemd/system/rocketchat.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=The Rocket.Chat server</span><br><span class="line">After=network.target remote-fs.target nss-lookup.target nginx.target mongod.target</span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/node /opt/Rocket.Chat/main.js</span><br><span class="line">StandardOutput=syslog</span><br><span class="line">StandardError=syslog</span><br><span class="line">SyslogIdentifier=rocketchat</span><br><span class="line">User=rocketchat</span><br><span class="line">Environment=MONGO_URL=mongodb://localhost:27017/rocketchat?replicaSet=rs01 MONGO_OPLOG_URL=mongodb://localhost:27017/local?replicaSet=rs01 ROOT_URL=http://localhost:3000/ PORT=3000</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>æ‰“å¼€åˆšåˆšåˆ›å»ºçš„Rocket.ChatæœåŠ¡æ–‡ä»¶(/usr/lib/systemd/system/rocketchat.service) </p><p>æ”¹ROOT_URLç¯å¢ƒå˜é‡ä»¥åæ˜ æ‚¨è¦ç”¨äºè®¿é—®æœåŠ¡å™¨çš„URLï¼ˆå¯ä»¥é€‰æ‹©æ›´æ”¹MONGO_URLï¼ŒMONGO_OPLOG_URLå’ŒPORTï¼‰</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MONGO_URL=mongodb://localhost:27017/rocketchat?replicaSet=rs01</span><br><span class="line">MONGO_OPLOG_URL=mongodb://localhost:27017/local?replicaSet=rs01</span><br><span class="line">ROOT_URL=http://your-host-name.com-as-accessed-from-internet:3000</span><br><span class="line">PORT=3000</span><br></pre></td></tr></table></figure><p>ä¸ºMongoDBè®¾ç½®å­˜å‚¨å¼•æ“å’Œå¤åˆ¶ï¼ˆå¯¹äºç‰ˆæœ¬&gt; 1ä¸ºå¿…éœ€ï¼‰ï¼Œå¹¶å¯ç”¨å¹¶å¯åŠ¨MongoDBå’ŒRocket.Chat</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo sed -i &quot;s/^#  engine:/  engine: mmapv1/&quot;  /etc/mongod.conf</span><br><span class="line"></span><br><span class="line">sudo sed -i &quot;s/^#replication:/replication:\n  replSetName: rs01/&quot; /etc/mongod.conf</span><br><span class="line"></span><br><span class="line">sudo systemctl enable mongod &amp;&amp; sudo systemctl start mongod</span><br><span class="line"></span><br><span class="line">mongo --eval &quot;printjson(rs.initiate())&quot;</span><br><span class="line"></span><br><span class="line">sudo systemctl enable rocketchat &amp;&amp; sudo systemctl start rocketchat</span><br></pre></td></tr></table></figure><p><a href="http://your-host-name.com:3000" target="_blank" rel="noopener">http://your-host-name.com:3000</a> å³å¯è®¿é—®</p><p>å¦‚æœmongodbå¯åŠ¨æŠ¥é”™å¯å®Œå…¨å¸è½½mongodb</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1ã€åˆ é™¤å®‰è£…çš„åŒ…</span><br><span class="line"></span><br><span class="line">yum erase $(rpm -qa | grep mongodb-org)</span><br><span class="line"></span><br><span class="line">2ã€åˆ é™¤æ•°æ®åŠæ—¥å¿—</span><br><span class="line"></span><br><span class="line">rm -r /var/log/mongodb</span><br><span class="line"></span><br><span class="line">rm -r /var/lib/mongo</span><br><span class="line">ã€€ã€€</span><br><span class="line">3ã€åˆ é™¤æ•°æ®é…ç½®æ–‡ä»¶</span><br><span class="line"></span><br><span class="line">rm -r /etc/mongo.conf</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¯·æ ¹æ®æ“ä½œç³»ç»Ÿé€‰æ‹©å®˜ç½‘å®‰è£…æ–‡æ¡£&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡ä½¿ç”¨centosè¿›è¡Œå®‰è£…&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.rocket.chat/installation/manual-installation/centos/&quot; target=&quot;_blank&quot; </summary>
      
    
    
    
    
    <category term="IM" scheme="https://nmk0718.github.io/tag/IM/"/>
    
  </entry>
  
  <entry>
    <title>Mac</title>
    <link href="https://nmk0718.github.io/2020/05/21/Mac/"/>
    <id>https://nmk0718.github.io/2020/05/21/Mac/</id>
    <published>2020-05-21T14:20:00.000Z</published>
    <updated>2025-01-05T15:41:46.122Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Macå†™å…¥Windows-NTFS"><a href="#Macå†™å…¥Windows-NTFS" class="headerlink" title="Macå†™å…¥Windows(NTFS)"></a>Macå†™å…¥Windows(NTFS)</h3><h4 id="ç¬¬ä¸€æ­¥ï¼šæŸ¥çœ‹ç£ç›˜è®¾å¤‡æ–‡ä»¶å"><a href="#ç¬¬ä¸€æ­¥ï¼šæŸ¥çœ‹ç£ç›˜è®¾å¤‡æ–‡ä»¶å" class="headerlink" title="ç¬¬ä¸€æ­¥ï¼šæŸ¥çœ‹ç£ç›˜è®¾å¤‡æ–‡ä»¶å"></a>ç¬¬ä¸€æ­¥ï¼šæŸ¥çœ‹ç£ç›˜è®¾å¤‡æ–‡ä»¶å</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">diskutil list</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ç§»åŠ¨ç¡¬ç›˜è¢«æŒ‚è½½äº†disk2çš„ä½ç½®ä¸Šï¼Œå…¶ä¸­Windowsç£ç›˜<strong>è®¾å¤‡æ–‡ä»¶å</strong>ä¸º<strong>disk2s1</strong></p><h4 id="ç¬¬äºŒæ­¥ï¼šæ–°å»ºæŒ‚è½½ç‚¹"><a href="#ç¬¬äºŒæ­¥ï¼šæ–°å»ºæŒ‚è½½ç‚¹" class="headerlink" title="ç¬¬äºŒæ­¥ï¼šæ–°å»ºæŒ‚è½½ç‚¹"></a>ç¬¬äºŒæ­¥ï¼šæ–°å»ºæŒ‚è½½ç‚¹</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir ~/Desktop/Windows</span><br></pre></td></tr></table></figure><h4 id="ç¬¬ä¸‰æ­¥ï¼šæ¨å‡ºç£ç›˜ï¼ˆé‡æ–°æŒ‚è½½ï¼‰"><a href="#ç¬¬ä¸‰æ­¥ï¼šæ¨å‡ºç£ç›˜ï¼ˆé‡æ–°æŒ‚è½½ï¼‰" class="headerlink" title="ç¬¬ä¸‰æ­¥ï¼šæ¨å‡ºç£ç›˜ï¼ˆé‡æ–°æŒ‚è½½ï¼‰"></a>ç¬¬ä¸‰æ­¥ï¼šæ¨å‡ºç£ç›˜ï¼ˆé‡æ–°æŒ‚è½½ï¼‰</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo umount /dev/disk2s1</span><br></pre></td></tr></table></figure><h4 id="ç¬¬å››æ­¥ï¼šé‡æ–°æŒ‚è½½"><a href="#ç¬¬å››æ­¥ï¼šé‡æ–°æŒ‚è½½" class="headerlink" title="ç¬¬å››æ­¥ï¼šé‡æ–°æŒ‚è½½"></a>ç¬¬å››æ­¥ï¼šé‡æ–°æŒ‚è½½</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo mount_ntfs -o rw,nobrowse /dev/disk2s1 ~/Desktop/Windows</span><br></pre></td></tr></table></figure><p>ç£ç›˜å¯ä»¥æ­£å¸¸è¯»å†™äº†ï¼ï¼ï¼</p><p>æˆ–è€…</p><p>æ›´æ–°fstabæ–‡ä»¶ï¼Œæ­¤æ­¥éª¤éœ€è¦è¾“å…¥å¯†ç </p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo nano /etc/fstab</span><br></pre></td></tr></table></figure><p>åœ¨fstabæ–‡ä»¶ä¸­å†™å…¥ä¸€ä¸‹å†…å®¹(movieæ›¿æ¢ä¸ºä½ è‡ªå·±çš„Volume Nameï¼Œå»ºè®®ç”¨è‹±æ–‡å‘½å)</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">LABEL=K none ntfs rw,auto,nobrowse</span><br></pre></td></tr></table></figure><p>CTRL + Xä¿å­˜ï¼Œé€‰æ‹© Yï¼Œç„¶åæŒ‰å›è½¦é”®ã€‚</p><hr><h3 id="Macä½¿ç”¨pptp"><a href="#Macä½¿ç”¨pptp" class="headerlink" title="Macä½¿ç”¨pptp"></a>Macä½¿ç”¨pptp</h3><p>macos 10.15+ ç‰ˆæœ¬ä»¥åç³»ç»Ÿå°±åˆ é™¤äº†å¯¹PPTPçš„æ”¯æŒã€‚</p><p>åœ¨macos 10.15ä¸­è¢«åˆ é™¤çš„æ–‡ä»¶æ˜¯ <code>/usr/local/bin/pptp</code> å’Œ <code>/System/Library/Extensions/PPTP.ppp</code>ã€‚</p><p>[ä¸‹è½½pptpå’ŒPPTP.ppp]</p><p>é“¾æ¥: <a href="https://pan.baidu.com/s/1lANcpclyTMJPZZLcgOpXFQ" target="_blank" rel="noopener">https://pan.baidu.com/s/1lANcpclyTMJPZZLcgOpXFQ</a> æå–ç : vbr9</p><p>Mac OS Xç³»ç»Ÿé»˜è®¤æƒ…å†µæ˜¯å¼€å¯äº†å®Œæ•´æ€§ä¿æŠ¤ï¼ˆSystem Intregrity Protectionï¼ŒSIPï¼‰çš„ï¼Œæ‰€ä»¥å³ä½¿æ˜¯rootå¸æˆ·ä¹Ÿæ— æ³•ä¿®æ”¹ç³»ç»Ÿç›®å½•ä¸­çš„æ–‡ä»¶ã€‚ä¸ºäº†èƒ½å¤Ÿä¿®æ”¹å—ä¿æŠ¤çš„æ–‡ä»¶ï¼Œéœ€è¦ç¦ç”¨ä¿æŠ¤åŠŸèƒ½ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.é‡å¯ç”µè„‘ï¼ŒæŒ‰Command+R(ç›´åˆ°å‡ºç°è‹¹æœæ ‡å¿—)è¿›å…¥Recovery Mode(æ¢å¤æ¨¡å¼)</span><br><span class="line">2.é€‰æ‹©ç”¨æˆ·&gt;ä¸‹ä¸€æ­¥&gt;è¾“å…¥å¯†ç &gt;å·¦ä¸Šè§’&quot;å®ç”¨å·¥å…·&quot;&gt;ç»ˆç«¯</span><br><span class="line">3.åœ¨ç»ˆç«¯ä¸­è¾“å…¥csrutil disableå‘½ä»¤å›è½¦ã€‚</span><br><span class="line">4.sudo cp -R PPTP.ppp /System/Library/Extensions</span><br><span class="line">sudo cp -R pptp /usr/local/bin/pptp</span><br><span class="line">æ‹·è´æ–‡ä»¶åˆ°ç›¸åº”ç›®å½•</span><br><span class="line">5.csrutil enableï¼ˆå¯ç”¨å®Œæ•´æ€§ä¿æŠ¤ï¼‰</span><br></pre></td></tr></table></figure><p>è¿›å…¥ /etc/ppp/peers/ ç›®å½•ï¼Œåˆ›å»º nmk.vpnï¼Œæ­¤æ–‡ä»¶åè‡ªå·±å–ï¼›</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /etc/ppp/peers</span><br><span class="line">sudo vim nmk.vpn</span><br><span class="line">å†…å®¹ä¸ºä»¥ä¸‹ä»£ç :</span><br><span class="line"></span><br><span class="line">plugin PPTP.ppp</span><br><span class="line">noauth</span><br><span class="line">remoteaddress &quot;------VPN server name or IP address------&quot;</span><br><span class="line">user &quot;------VPN username------&quot;</span><br><span class="line">password &quot;------VPN password------&quot;</span><br><span class="line">redialcount 1</span><br><span class="line">redialtimer 5</span><br><span class="line">idle 1800</span><br><span class="line"># mru 1368</span><br><span class="line"># mtu 1368</span><br><span class="line">receive-all</span><br><span class="line">novj 0:0</span><br><span class="line">ipcp-accept-local</span><br><span class="line">ipcp-accept-remote</span><br><span class="line">refuse-eap</span><br><span class="line">refuse-pap</span><br><span class="line">refuse-chap-md5</span><br><span class="line">hide-password</span><br><span class="line">mppe-stateless</span><br><span class="line">mppe-128</span><br><span class="line"># require-mppe-128</span><br><span class="line">looplocal</span><br><span class="line">nodetach</span><br><span class="line">ms-dns 8.8.8.8</span><br><span class="line">usepeerdns</span><br><span class="line"># ipparam gwvpn</span><br><span class="line">defaultroute</span><br><span class="line">debug</span><br></pre></td></tr></table></figure><p>è¿æ¥vpn</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo pppd call nmk.vpn</span><br></pre></td></tr></table></figure><p>æ–­å¼€vpn</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo pkill pppd</span><br><span class="line">#æ­¤å¤„æ³¨æ„ä½¿ç”¨pkill,å®æµ‹kill-9 æ€æ‰è¿›ç¨‹å,ç½‘ç»œæ–­å¼€,ä½¿ç”¨pkillç½‘ç»œæ­£å¸¸</span><br><span class="line"> ç™¾åº¦å¾—çŸ¥pkillä¸ºpså’Œkillçš„ç»“åˆ,ä½†å…·ä½“å·®å¼‚æœªçŸ¥è¯·ä½¿ç”¨pkillç»“æŸè¿›ç¨‹</span><br></pre></td></tr></table></figure><p>æŠ¥é”™</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MPPE required but peer negotiation failed</span><br><span class="line">è§£å†³æ–¹æ¡ˆ:æ³¨é‡Šæ‰nmk.vpnä¸­çš„</span><br><span class="line">mppe-stateless</span><br><span class="line">mppe-128</span><br><span class="line">LCP terminated by peer (MPPE required but peer refused)</span><br><span class="line">è§£å†³æ–¹æ¡ˆ:å–æ¶ˆæ³¨é‡Šæˆ–æ·»åŠ  nmk.vpnä¸­çš„require-mppe-128</span><br></pre></td></tr></table></figure><h3 id="Macå¸è½½ç¨‹åºæ¸…é™¤æ®‹ç•™æ–‡ä»¶"><a href="#Macå¸è½½ç¨‹åºæ¸…é™¤æ®‹ç•™æ–‡ä»¶" class="headerlink" title="Macå¸è½½ç¨‹åºæ¸…é™¤æ®‹ç•™æ–‡ä»¶"></a>Macå¸è½½ç¨‹åºæ¸…é™¤æ®‹ç•™æ–‡ä»¶</h3><p>å¸è½½æŸäº›åº”ç”¨ç¨‹åºåä¼šç•™ä¸‹ä¸€äº›é¢„ç½®æ–‡ä»¶å’Œç¼“å­˜ç­‰ï¼Œä¸€èˆ¬è¿™äº›æ–‡ä»¶æ²¡æœ‰æ½œåœ¨åå¤„ï¼Œä½†æ˜¯ä½ å¯ä»¥åˆ é™¤å®ƒä»¬æ¥å½»åº•è·Ÿè¯¥åº”ç”¨ç¨‹åºè¯´æ‹œæ‹œã€‚è¿™äº›æ–‡ä»¶é€šå¸¸ä½äºä»¥ä¸‹è·¯å¾„ï¼š</p><p>~/Library/Application Support/(åº”ç”¨ç¨‹åºåç§°)<br>~/Library/Preferences/(åº”ç”¨ç¨‹åºåç§°)<br>~/Library/Caches/(åº”ç”¨ç¨‹åºåç§°)</p><p>æ³¨ï¼šæœ‰æ—¶ä½ ä¼šéœ€è¦å¯»æ‰¾å¼€å‘å•†åç§°ï¼Œè€Œä¸æ˜¯åº”ç”¨ç¨‹åºçš„åç§°ï¼Œå› ä¸ºå¹¶ä¸æ˜¯æ‰€æœ‰çš„åº”ç”¨ç¨‹åºæ–‡ä»¶éƒ½æ˜¯ç”±å®ƒä»¬çš„åç§°æ ‡è¯†å‡ºæ¥çš„ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;Macå†™å…¥Windows-NTFS&quot;&gt;&lt;a href=&quot;#Macå†™å…¥Windows-NTFS&quot; class=&quot;headerlink&quot; title=&quot;Macå†™å…¥Windows(NTFS)&quot;&gt;&lt;/a&gt;Macå†™å…¥Windows(NTFS)&lt;/h3&gt;&lt;h4 id=&quot;ç¬¬ä¸€æ­¥</summary>
      
    
    
    
    
    <category term="macOS" scheme="https://nmk0718.github.io/tag/macOS/"/>
    
  </entry>
  
  <entry>
    <title>expect</title>
    <link href="https://nmk0718.github.io/2020/05/21/expect/"/>
    <id>https://nmk0718.github.io/2020/05/21/expect/</id>
    <published>2020-05-21T14:20:00.000Z</published>
    <updated>2024-11-29T06:43:11.184Z</updated>
    
    <content type="html"><![CDATA[<h3 id="expect-å®‰è£…"><a href="#expect-å®‰è£…" class="headerlink" title="expect å®‰è£…"></a>expect å®‰è£…</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install -y expect</span><br></pre></td></tr></table></figure><h3 id="expectå·¥ä½œåŸç†"><a href="#expectå·¥ä½œåŸç†" class="headerlink" title="expectå·¥ä½œåŸç†"></a>expectå·¥ä½œåŸç†</h3><p>â€‹    ä»æœ€ç®€å•çš„å±‚æ¬¡æ¥è¯´ï¼ŒExpectçš„å·¥ä½œæ–¹å¼è±¡ä¸€ä¸ªé€šç”¨åŒ–çš„Chatè„šæœ¬å·¥å…·ã€‚Chatè„šæœ¬æœ€æ—©ç”¨äºUUCPç½‘ç»œå†…ï¼Œä»¥ç”¨æ¥å®ç°è®¡ç®—æœºä¹‹é—´éœ€è¦å»ºç«‹è¿æ¥æ—¶è¿›è¡Œç‰¹å®šçš„ç™»å½•ä¼šè¯çš„è‡ªåŠ¨åŒ–ã€‚</p><p>â€‹    Chatè„šæœ¬ç”±ä¸€ç³»åˆ—expect-sendå¯¹ç»„æˆï¼šexpectç­‰å¾…è¾“å‡ºä¸­è¾“å‡ºç‰¹å®šçš„å­—ç¬¦ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªæç¤ºç¬¦ï¼Œç„¶åå‘é€ç‰¹å®šçš„å“åº”ã€‚ä¾‹å¦‚ä¸‹é¢çš„ Chatè„šæœ¬å®ç°ç­‰å¾…æ ‡å‡†è¾“å‡ºå‡ºç°Login:å­—ç¬¦ä¸²ï¼Œç„¶åå‘é€somebodyä½œä¸ºç”¨æˆ·åï¼›ç„¶åç­‰å¾…Password:æç¤ºç¬¦ï¼Œå¹¶å‘å‡ºå“åº” sillymeã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Login: somebody Password: sillyme</span><br></pre></td></tr></table></figure><p>Expectæœ€ç®€å•çš„è„šæœ¬æ“ä½œæ¨¡å¼æœ¬è´¨ä¸Šå’ŒChatè„šæœ¬å·¥ä½œæ¨¡å¼æ˜¯ä¸€æ ·çš„ã€‚</p><h3 id="expectç®€å•ä¾‹å­"><a href="#expectç®€å•ä¾‹å­" class="headerlink" title="expectç®€å•ä¾‹å­"></a>expectç®€å•ä¾‹å­</h3><p>ä¸ºäº†æ›´å¥½ç†è§£exceptè„šæœ¬å‡ ä¸ªç®€å•å‚æ•°ï¼Œæˆ‘ä»¬å†ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š </p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/usr/bin/expect   </span><br><span class="line">set timeout 30   </span><br><span class="line">spawn ssh -l username 192.168.1.1   </span><br><span class="line">expect &quot;password:&quot;   </span><br><span class="line">send &quot;ispass\r&quot;   </span><br><span class="line">interact</span><br></pre></td></tr></table></figure><p>è¯´æ˜:</p><p>1.[#!/usr/bin/expect]</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">è¿™ä¸€è¡Œå‘Šè¯‰æ“ä½œç³»ç»Ÿè„šæœ¬é‡Œçš„ä»£ç ä½¿ç”¨é‚£ä¸€ä¸ªshellæ¥æ‰§è¡Œã€‚è¿™é‡Œçš„expectå…¶å®å’Œlinuxä¸‹çš„bashã€windowsä¸‹çš„cmdæ˜¯ä¸€ç±»ä¸œè¥¿ã€‚æ³¨æ„ï¼šè¿™ä¸€è¡Œéœ€è¦åœ¨è„šæœ¬çš„ç¬¬ä¸€è¡Œã€‚</span><br></pre></td></tr></table></figure><p>2.[set timeout 30]</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œè®¡æ—¶å•ä½æ˜¯ï¼šç§’</span><br></pre></td></tr></table></figure><p>3.[spawn ssh -l username 192.168.1.1]</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">spawnæ˜¯è¿›å…¥expectç¯å¢ƒåæ‰å¯ä»¥æ‰§è¡Œçš„expectå†…éƒ¨å‘½ä»¤ï¼Œå¦‚æœæ²¡æœ‰è£…expectæˆ–è€…ç›´æ¥åœ¨é»˜è®¤çš„SHELLä¸‹æ‰§è¡Œæ˜¯æ‰¾ä¸åˆ°spawnå‘½ä»¤çš„ã€‚æ‰€ä»¥ä¸è¦ç”¨ â€œwhich spawnâ€œä¹‹ç±»çš„å‘½ä»¤å»æ‰¾spawnå‘½ä»¤ã€‚å¥½æ¯”windowsé‡Œçš„dirå°±æ˜¯ä¸€ä¸ªå†…éƒ¨å‘½ä»¤ï¼Œè¿™ä¸ªå‘½ä»¤ç”±shellè‡ªå¸¦ï¼Œä½ æ— æ³•æ‰¾åˆ°ä¸€ä¸ªdir.com æˆ– dir.exe çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚å®ƒä¸»è¦çš„åŠŸèƒ½æ˜¯ç»™sshè¿è¡Œè¿›ç¨‹åŠ ä¸ªå£³ï¼Œç”¨æ¥ä¼ é€’äº¤äº’æŒ‡ä»¤ã€‚</span><br></pre></td></tr></table></figure><p>4.[expect â€œpassword:â€]</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">è¿™é‡Œçš„expectä¹Ÿæ˜¯expectçš„ä¸€ä¸ªå†…éƒ¨å‘½ä»¤ï¼Œæœ‰ç‚¹æ™•å§ï¼Œexpectçš„shellå‘½ä»¤å’Œå†…éƒ¨å‘½ä»¤æ˜¯ä¸€æ ·çš„ï¼Œä½†ä¸æ˜¯ä¸€ä¸ªåŠŸèƒ½ï¼Œä¹ æƒ¯å°±å¥½äº†ã€‚è¿™ä¸ªå‘½ä»¤çš„æ„æ€æ˜¯åˆ¤æ–­ä¸Šæ¬¡è¾“å‡ºç»“æœé‡Œæ˜¯å¦åŒ…å«â€œpassword:â€çš„å­—ç¬¦ä¸²ï¼Œå¦‚æœæœ‰åˆ™ç«‹å³è¿”å›ï¼Œå¦åˆ™å°±ç­‰å¾…ä¸€æ®µæ—¶é—´åè¿”å›ï¼Œè¿™é‡Œç­‰å¾…æ—¶é•¿å°±æ˜¯å‰é¢è®¾ç½®çš„30ç§’</span><br></pre></td></tr></table></figure><p>5.[send â€œispass\râ€]</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">è¿™é‡Œå°±æ˜¯æ‰§è¡Œäº¤äº’åŠ¨ä½œï¼Œä¸æ‰‹å·¥è¾“å…¥å¯†ç çš„åŠ¨ä½œç­‰æ•ˆã€‚  </span><br><span class="line">æ¸©é¦¨æç¤ºï¼š å‘½ä»¤å­—ç¬¦ä¸²ç»“å°¾åˆ«å¿˜è®°åŠ ä¸Š â€œ\râ€ï¼Œå¦‚æœå‡ºç°å¼‚å¸¸ç­‰å¾…çš„çŠ¶æ€å¯ä»¥æ ¸æŸ¥ä¸€ä¸‹ã€‚</span><br></pre></td></tr></table></figure><p>6.[interactï¼½  </p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">æ‰§è¡Œå®Œæˆåä¿æŒäº¤äº’çŠ¶æ€ï¼ŒæŠŠæ§åˆ¶æƒäº¤ç»™æ§åˆ¶å°ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥æ‰‹å·¥æ“ä½œäº†ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸€å¥ç™»å½•å®Œæˆåä¼šé€€å‡ºï¼Œè€Œä¸æ˜¯ç•™åœ¨è¿œç¨‹ç»ˆç«¯ä¸Šã€‚å¦‚æœä½ åªæ˜¯ç™»å½•è¿‡å»æ‰§è¡Œä¸€æ®µå‘½ä»¤å°±é€€å‡ºï¼Œå¯æ”¹ä¸ºï¼»expect eofï¼½</span><br></pre></td></tr></table></figure><h3 id="expectå®ç”¨æ¡ˆä¾‹"><a href="#expectå®ç”¨æ¡ˆä¾‹" class="headerlink" title="expectå®ç”¨æ¡ˆä¾‹"></a>expectå®ç”¨æ¡ˆä¾‹</h3><h4 id="è¿œç¨‹ç™»å½•åˆ°linux-å¹¶ä¸”æ‰§è¡Œå‘½ä»¤-æ‰§è¡Œå®Œåå¹¶é€€å‡º"><a href="#è¿œç¨‹ç™»å½•åˆ°linux-å¹¶ä¸”æ‰§è¡Œå‘½ä»¤-æ‰§è¡Œå®Œåå¹¶é€€å‡º" class="headerlink" title="è¿œç¨‹ç™»å½•åˆ°linux,å¹¶ä¸”æ‰§è¡Œå‘½ä»¤,æ‰§è¡Œå®Œåå¹¶é€€å‡º"></a>è¿œç¨‹ç™»å½•åˆ°linux,å¹¶ä¸”æ‰§è¡Œå‘½ä»¤,æ‰§è¡Œå®Œåå¹¶é€€å‡º</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/usr/bin/expect -f </span><br><span class="line">set ip 192.168.1.130 </span><br><span class="line">set password admin </span><br><span class="line">set timeout 10 </span><br><span class="line">spawn ssh root@$ip </span><br><span class="line">expect &#123; </span><br><span class="line">&quot;*yes/no&quot; &#123; send &quot;yes\r&quot;; exp_continue&#125; </span><br><span class="line">&quot;*password:&quot; &#123; send &quot;$password\r&quot; &#125; </span><br><span class="line">&#125; </span><br><span class="line">expect &quot;#*&quot; </span><br><span class="line">send &quot;pwd\r&quot; </span><br><span class="line">send &quot;exit\r&quot; </span><br><span class="line">expect eof</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœå¦‚ä¸‹:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. root@nmk# ./test.exp </span><br><span class="line">2. spawn ssh root@192.168.1.130 </span><br><span class="line">3. root@192.168.1.130&apos;s password: </span><br><span class="line">4. Last login: Fri Sep 7 14:05:07 2012 from 116.246.27.90 </span><br><span class="line">5. [root@localhost ~]# pwd </span><br><span class="line">6. /root </span><br><span class="line">7. [root@localhost ~]# exit </span><br><span class="line">8. logout </span><br><span class="line">9. Connection to 192.168.1.130 closed.</span><br></pre></td></tr></table></figure><p>linuxä¸‹åŒ¹é… #,windowsä¸‹åŒ¹é… &gt;</p><h4 id="è¿œç¨‹ç™»å½•åˆ°ftp-å¹¶ä¸”ä¸‹è½½æ–‡ä»¶"><a href="#è¿œç¨‹ç™»å½•åˆ°ftp-å¹¶ä¸”ä¸‹è½½æ–‡ä»¶" class="headerlink" title="è¿œç¨‹ç™»å½•åˆ°ftp,å¹¶ä¸”ä¸‹è½½æ–‡ä»¶"></a>è¿œç¨‹ç™»å½•åˆ°ftp,å¹¶ä¸”ä¸‹è½½æ–‡ä»¶</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. \#!/usr/bin/expect -f </span><br><span class="line">2.  set ip [lindex $argv 0 ] </span><br><span class="line">3.  set dir [lindex $argv 1 ] </span><br><span class="line">4.  set file [lindex $argv 2 ] </span><br><span class="line">5.  set timeout 10 </span><br><span class="line">6.  spawn ftp $ip </span><br><span class="line">7.  expect &quot;Name*&quot; </span><br><span class="line">8.  send &quot;zwh\r&quot; </span><br><span class="line">9.  expect &quot;Password:*&quot; </span><br><span class="line">10.  send &quot;zwh\r&quot; </span><br><span class="line">11.  expect &quot;ftp&gt;*&quot; </span><br><span class="line">12.  send &quot;lcd $dir\r&quot; </span><br><span class="line">13.  expect &#123; </span><br><span class="line">14.  &quot;*file&quot; &#123; send_user &quot;local $_dir No such file or directory&quot;;send &quot;quit\r&quot; &#125; </span><br><span class="line">15.  &quot;*now*&quot; &#123; send &quot;get $dir/$file $dir/$file\r&quot;&#125; </span><br><span class="line">16.  &#125; </span><br><span class="line">17.  expect &#123; </span><br><span class="line">18.  &quot;*Failed&quot; &#123; send_user &quot;remote $file No such file&quot;;send &quot;quit\r&quot; &#125; </span><br><span class="line">19.  &quot;*OK&quot;   &#123; send_user &quot;$file has been download\r&quot;;send &quot;quit\r&quot;&#125; </span><br><span class="line">20.  &#125; </span><br><span class="line">21.  expect eof</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœå¦‚ä¸‹: </p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. root@nmk# ./test2.exp 192.168.1.130 /var/www/www aaa.html </span><br><span class="line">2. spawn ftp 192.168.1.130 </span><br><span class="line">3. Connected to 192.168.1.130. </span><br><span class="line">4. 220 (vsFTPd 2.0.5) </span><br><span class="line">5. Name (192.168.1.130:root): zwh </span><br><span class="line">6. 331 Please specify the password. </span><br><span class="line">7. Password: </span><br><span class="line">8. 230 Login successful. </span><br><span class="line">9. Remote system type is UNIX. </span><br><span class="line">10. Using binary mode to transfer files. </span><br><span class="line">11. ftp&gt; lcd /var/www/www </span><br><span class="line">12. Local directory now /var/www/www </span><br><span class="line">13. ftp&gt; get /var/www/www/aaa.html /var/www/www/aaa.html </span><br><span class="line">14. local: /var/www/www/aaa.html remote: /var/www/www/aaa.html </span><br><span class="line">15. 200 PORT command successful. Consider using PASV. </span><br><span class="line">16. 150 Opening BINARY mode data connection for /var/www/www/aaa.html (66 bytes). </span><br><span class="line">17. 226 File send OK. </span><br><span class="line">18. 66 bytes received in 0.00 secs (515.6 kB/s) </span><br><span class="line">19. quit aaa.html has been download </span><br><span class="line">20. 221 Goodbye.</span><br></pre></td></tr></table></figure><h4 id="å•å°æœåŠ¡å™¨scp"><a href="#å•å°æœåŠ¡å™¨scp" class="headerlink" title="å•å°æœåŠ¡å™¨scp"></a>å•å°æœåŠ¡å™¨scp</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/usr/bin/expect </span><br><span class="line">if &#123;$argc &lt; 2&#125; &#123;</span><br><span class="line">    send_user &quot;usage: $argv0 src_file username ip dest_file password\n&quot;</span><br><span class="line">exit</span><br><span class="line">set timeout 10 </span><br><span class="line">set host [lindex $argv 0] </span><br><span class="line">set username [lindex $argv 1] </span><br><span class="line">set password [lindex $argv 2] </span><br><span class="line">set src_file [lindex $argv 3] </span><br><span class="line">set dest_file [lindex $argv 4] </span><br><span class="line">spawn scp $src_file $username@$host:$dest_file </span><br><span class="line">expect &#123; </span><br><span class="line">&quot;(yes/no)?&quot; </span><br><span class="line">&#123; </span><br><span class="line">send &quot;yes\n&quot; </span><br><span class="line">expect &quot;*assword:&quot; &#123; send &quot;$password\n&quot;&#125; </span><br><span class="line">&#125; </span><br><span class="line">&quot;*assword:&quot; </span><br><span class="line">&#123; </span><br><span class="line">send &quot;$password\n&quot; </span><br><span class="line">&#125; </span><br><span class="line">&#125; </span><br><span class="line">expect &quot;100%&quot; </span><br><span class="line">expect eof</span><br></pre></td></tr></table></figure><p>è¯´æ˜ï¼š</p><p>ï¼ˆ1ï¼‰æ³¨æ„ä»£ç åˆšå¼€å§‹çš„ç¬¬ä¸€è¡Œï¼ŒæŒ‡å®šäº†expectçš„è·¯å¾„ï¼Œä¸shellè„šæœ¬ç›¸åŒï¼Œè¿™ä¸€å¥æŒ‡å®šäº†ç¨‹åºåœ¨æ‰§è¡Œæ—¶åˆ°å“ªé‡Œå»å¯»æ‰¾ç›¸åº”çš„å¯åŠ¨ç¨‹åºã€‚ä»£ç åˆšå¼€å§‹è¿˜è®¾å®šäº†timeoutçš„æ—¶é—´ä¸º10ç§’ï¼Œå¦‚æœåœ¨æ‰§è¡Œscpä»»åŠ¡æ—¶é‡åˆ°äº†ä»£ç ä¸­æ²¡æœ‰æŒ‡å®šçš„å¼‚å¸¸ï¼Œåˆ™åœ¨ç­‰å¾…10ç§’åè¯¥è„šæœ¬çš„æ‰§è¡Œä¼šè‡ªåŠ¨ç»ˆæ­¢ã€‚</p><p>ï¼ˆ2ï¼‰è¿™ä¸ªè„šæœ¬è®¾ç½®äº†5ä¸ªéœ€è¦æ‰‹åŠ¨è¾“å…¥çš„å‚æ•°ï¼Œåˆ†åˆ«ä¸ºï¼šç›®æ ‡ä¸»æœºçš„IPã€ç”¨æˆ·åã€å¯†ç ã€æœ¬åœ°æ–‡ä»¶è·¯å¾„ã€ç›®æ ‡ä¸»æœºä¸­çš„æ–‡ä»¶è·¯å¾„ã€‚å¦‚æœå°†ä»¥ä¸Šè„šæœ¬ä¿å­˜ä¸ºexpect_scpæ–‡ä»¶ï¼Œåˆ™åœ¨shellä¸‹æ‰§è¡Œæ—¶éœ€è¦æŒ‰ä»¥ä¸‹çš„è§„èŒƒæ¥è¾“å…¥å‘½ä»¤ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">./expect_scp 192.168.75.130 root 123456 /root/src_file /root/dest_file</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šçš„å‘½ä»¤æ‰§è¡Œåï¼Œå°†æŠŠæœ¬åœ°/rootç›®å½•ä¸‹çš„src_fileæ–‡ä»¶æ‹·è´åˆ°ç”¨æˆ·åä¸ºrootï¼Œå¯†ç ä¸º123456çš„ä¸»æœº192.168.75.130ä¸­çš„/rootä¸‹ï¼ŒåŒæ—¶è¿˜å°†è¿™ä¸ªæºæ–‡ä»¶é‡å‘½åä¸ºdest_fileã€‚</p><p>ï¼ˆ3ï¼‰spawnä»£è¡¨åœ¨æœ¬åœ°ç»ˆç«¯æ‰§è¡Œçš„è¯­å¥ï¼Œåœ¨è¯¥è¯­å¥å¼€å§‹æ‰§è¡Œåï¼Œexpectå¼€å§‹æ•è·ç»ˆç«¯çš„è¾“å‡ºä¿¡æ¯ï¼Œç„¶ååšå‡ºå¯¹åº”çš„æ“ä½œã€‚expectä»£ç ä¸­çš„æ•è·çš„(yes/no)å†…å®¹ç”¨äºå®Œæˆç¬¬ä¸€æ¬¡è®¿é—®ç›®æ ‡ä¸»æœºæ—¶ä¿å­˜å¯†é’¥çš„æ“ä½œã€‚æœ‰äº†è¿™ä¸€å¥ï¼Œscpçš„ä»»åŠ¡å‡å°‘äº†ä¸­æ–­çš„æƒ…å†µã€‚ä»£ç ç»“å°¾çš„expect eofä¸spawnå¯¹åº”ï¼Œè¡¨ç¤ºæ•è·ç»ˆç«¯è¾“å‡ºä¿¡æ¯çš„ç»ˆæ­¢ã€‚</p><h4 id="å¤šå°ä¼ è¾“è„šæœ¬"><a href="#å¤šå°ä¼ è¾“è„šæœ¬" class="headerlink" title="å¤šå°ä¼ è¾“è„šæœ¬"></a><strong>å¤šå°ä¼ è¾“è„šæœ¬</strong></h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat mainscp.sh</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">host_list=&quot;server_list.conf&quot;</span><br><span class="line">cat $host_list | while read line</span><br><span class="line">do</span><br><span class="line"> host_ip=`echo $line|awk &apos;&#123;print $1&#125;&apos;`</span><br><span class="line"> username=`echo $line|awk &apos;&#123;print $2&#125;&apos;`</span><br><span class="line"> password=`echo $line|awk &apos;&#123;print $3&#125;&apos;`</span><br><span class="line"> src_file=`echo $line|awk &apos;&#123;print $4&#125;&apos;`</span><br><span class="line"> dest_file=`echo $line|awk &apos;&#123;print $5&#125;&apos;`</span><br><span class="line"> ##key=`echo $line|awk &apos;&#123;print $6&#125;&apos;`</span><br><span class="line"> ##./allscp.sh $key $src_file $username $host_ip $dest_file $password</span><br><span class="line"> ./allscp.sh $src_file $username $host_ip $dest_file $password</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p><strong>3.æœåŠ¡å™¨ä¿¡æ¯æ–‡ä»¶</strong></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat server_list.conf</span><br></pre></td></tr></table></figure><p>æ ¼å¼ä¸º:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ip ç”¨æˆ·å å¯†ç  æºæ–‡ä»¶ ç›®æ ‡æ–‡ä»¶åœ°å€</span><br></pre></td></tr></table></figure><p>é€šè¿‡jenkinsåŠ expectéƒ¨ç½²æ–°é¡¹ç›®æˆ–å¢åŠ èŠ‚ç‚¹</p><p>update.sh</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/usr/bin/expect</span><br><span class="line"></span><br><span class="line">if &#123;$argc &lt; 3&#125; &#123;</span><br><span class="line">        send_user &quot;è¯·æŒ‰ç…§æ ¼å¼è¾“å…¥: $argv0 host_ip username password local_file remote_file project port\n&quot;</span><br><span class="line">exit</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#æ¥æ”¶è¾“å…¥çš„å‚æ•°å®šä¹‰ä¸ºå˜é‡</span><br><span class="line">set host_ip [lindex $argv 0]</span><br><span class="line">set username [lindex $argv 1]</span><br><span class="line">set password [lindex $argv 2]</span><br><span class="line">set local_file [lindex $argv 3]</span><br><span class="line">set remote_file [lindex $argv 4]</span><br><span class="line">set project [lindex $argv 5]</span><br><span class="line">set port [lindex $argv 6]</span><br><span class="line"></span><br><span class="line">spawn scp package/$project.war $username@$host_ip:$remote_file</span><br><span class="line"></span><br><span class="line">expect &#123;</span><br><span class="line">&quot;*password:&quot;</span><br><span class="line">        &#123;send &quot;$password\r&quot;&#125;</span><br><span class="line">&#125;</span><br><span class="line">expect &quot;100%&quot;</span><br><span class="line">expect eof</span><br><span class="line">spawn ssh $username@$host_ip</span><br><span class="line"></span><br><span class="line">expect &#123; </span><br><span class="line">&quot;(yes/no)?&quot;</span><br><span class="line">&#123;send &quot;yes\r&quot;&#125;</span><br><span class="line">&quot;*password:&quot;</span><br><span class="line">&#123;send &quot;$password\r&quot;&#125;</span><br><span class="line">&#125;</span><br><span class="line">expect &quot;$&quot;</span><br><span class="line">send &quot;cd $remote_file\r&quot;</span><br><span class="line">expect &quot;$&quot;</span><br><span class="line">send &quot;./killport.sh $port\r&quot;</span><br><span class="line">expect &quot;$&quot;</span><br><span class="line">send &quot;cd /home/tomcat/tomcat_$port/webapps\r&quot;</span><br><span class="line">expect &quot;$&quot;</span><br><span class="line">send &quot;tar czvf $project`date +%Y%m%d%H%M%S`.bak.tar $project\r&quot;</span><br><span class="line">expect &quot;$&quot;</span><br><span class="line">send &quot;rm -r $project.war\r&quot;</span><br><span class="line">expect &quot;(yes/no)?&quot;</span><br><span class="line">send &quot;yes\r&quot;</span><br><span class="line">send &quot;rm -rf $project\r&quot;</span><br><span class="line">expect &quot;$&quot;</span><br><span class="line">send &quot;mv *.bak.tar backup\r&quot;</span><br><span class="line">expect &quot;$&quot;</span><br><span class="line">send &quot;mv $remote_file/$project.war /home/tomcat/tomcat_$port/webapps\r&quot;</span><br><span class="line">expect &quot;$&quot;</span><br><span class="line">send &quot;cd /home/tomcat/tomcat_$port/bin\r&quot;</span><br><span class="line">expect &quot;$&quot;</span><br><span class="line">send &quot;./startup.sh\r&quot;</span><br><span class="line">expect eof</span><br></pre></td></tr></table></figure><p>Release.sh</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">project=$2</span><br><span class="line">host_ip=$4</span><br><span class="line">port=$6</span><br><span class="line"></span><br><span class="line">line1=`ls package|grep $project`</span><br><span class="line">if [ &quot;$project.war&quot; != &quot;$line1&quot; ] ; then</span><br><span class="line">    echo -e &quot;è¯·å…ˆå»jenkinsæ‰“åŒ…,ä¸å­˜åœ¨$projectçš„waråŒ….\nè¯·æ£€æŸ¥æ‹¼å†™æ ¼å¼:\n</span><br><span class="line">        -P(project name)\n</span><br><span class="line">        -H(host ip)\n</span><br><span class="line">        -Port(tomcat port)\n</span><br><span class="line">        ä¾‹å¦‚:./release.sh -P mfapi -H 192.168.1.1 -Port 8080&quot;</span><br><span class="line">exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">line2=`cat files/server_list.conf|grep $host_ip|awk &apos;&#123;print $1&#125;&apos;`</span><br><span class="line">if [ &quot;$host_ip&quot; != &quot;$line2&quot; ] ; then</span><br><span class="line">    echo -e &quot;æœåŠ¡å™¨åˆ—è¡¨ä¸å­˜åœ¨$host_ip.\nè¯·æ£€æŸ¥æ‹¼å†™æ ¼å¼:\n</span><br><span class="line">        -P(project name)\n</span><br><span class="line">        -H(host ip)\n</span><br><span class="line">        -Port(tomcat port)\n</span><br><span class="line">        ä¾‹å¦‚:./release.sh -P mfapi -H 192.168.1.1 -Port 8080&quot;</span><br><span class="line">exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">#line3=`ls tomcat/conf|grep $port`</span><br><span class="line">if [ ! -n &quot;$port&quot; ] ; then</span><br><span class="line">    echo -e &quot;tomcatä¸­ä¸å­˜åœ¨ç«¯å£ä¸º$portçš„é…ç½®,å¦‚æœ‰éœ€è¦è¯·æ·»åŠ .\nè¯·æ£€æŸ¥æ‹¼å†™æ ¼å¼:\n</span><br><span class="line">        -P(project name)\n</span><br><span class="line">        -H(host ip)\n</span><br><span class="line">        -Port(tomcat port)\n</span><br><span class="line">        ä¾‹å¦‚:./release.sh -P mfapi -H 192.168.1.1 -Port 8080&quot;</span><br><span class="line">exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if  [ &quot;$1&quot;a == &quot;-P&quot;a ] &amp;&amp; [ &quot;$3&quot;c == &quot;-H&quot;c ] &amp;&amp; [ &quot;$5&quot;e == &quot;-Port&quot;e ] ; then</span><br><span class="line">line=`cat files/server_list.conf |grep $host_ip`</span><br><span class="line">        ip=`echo $line|awk &apos;&#123;print $1&#125;&apos;`</span><br><span class="line">username=`echo $line|awk &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">password=`echo $line|awk &apos;&#123;print $3&#125;&apos;`</span><br><span class="line">local_file=`echo $line|awk &apos;&#123;print $4&#125;&apos;`</span><br><span class="line">remote_file=`echo $line|awk &apos;&#123;print $5&#125;&apos;`</span><br><span class="line">  ./deploy.sh $host_ip $username $password $local_file $remote_file $project $port</span><br><span class="line">else</span><br><span class="line">    echo -e &quot;è¯·æ£€æŸ¥æ‹¼å†™æ ¼å¼:\n</span><br><span class="line">        -P(project name)\n</span><br><span class="line">        -H(host ip)\n</span><br><span class="line">        -Port(tomcat port)\n</span><br><span class="line">ä¾‹å¦‚:./release.sh -P mfapi -H 192.168.1.1 -Port 8080&quot;</span><br><span class="line">exit</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>Deploy.sh</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/usr/bin/expect</span><br><span class="line"></span><br><span class="line">if &#123;$argc &lt; 3&#125; &#123;</span><br><span class="line">        send_user &quot;è¯·æŒ‰ç…§æ ¼å¼è¾“å…¥: $argv0 host_ip username password local_file remote_file project port\n&quot;</span><br><span class="line">exit</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#æ¥æ”¶è¾“å…¥çš„å‚æ•°å®šä¹‰ä¸ºå˜é‡</span><br><span class="line">set host_ip [lindex $argv 0]</span><br><span class="line">set username [lindex $argv 1]</span><br><span class="line">set password [lindex $argv 2]</span><br><span class="line">set local_file [lindex $argv 3]</span><br><span class="line">set remote_file [lindex $argv 4]</span><br><span class="line">set project [lindex $argv 5]</span><br><span class="line">set port [lindex $argv 6]</span><br><span class="line"></span><br><span class="line">spawn cp files/tomcat.tar.gz .</span><br><span class="line">expect eof</span><br><span class="line">spawn tar zvxf tomcat.tar.gz</span><br><span class="line">expect eof</span><br><span class="line"></span><br><span class="line">#åˆ¤æ–­é¡¹ç›®---------------------------</span><br><span class="line">if &#123; &quot;$project&quot; != &quot;&quot; &#125; &#123;</span><br><span class="line">spawn cp /home/jenkins/nmk/package/$project.war /home/jenkins/nmk/tomcat/webapps/</span><br><span class="line">expect eof</span><br><span class="line">&#125; else &#123;</span><br><span class="line">spawn echo &quot;è¯·è¾“å…¥é¡¹ç›®å&quot;</span><br><span class="line">exit</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#-----------------------------------</span><br><span class="line"></span><br><span class="line">#åˆ¤æ–­ç«¯å£---------------------------</span><br><span class="line"></span><br><span class="line">if &#123; &quot;$port&quot; != &quot;&quot; &#125; &#123;</span><br><span class="line">spawn rm -r /home/jenkins/nmk/tomcat/conf/server.xml</span><br><span class="line">spawn cp /home/jenkins/nmk/tomcat/conf/server_$port.xml /home/jenkins/nmk/tomcat/conf/server.xml</span><br><span class="line">expect eof</span><br><span class="line">&#125; else &#123;</span><br><span class="line">spawn echo &quot;è¯·è¾“å…¥ç«¯å£&quot;</span><br><span class="line">exit</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#-----------------------------------</span><br><span class="line">spawn rm -r tomcat.tar.gz</span><br><span class="line">expect eof</span><br><span class="line">spawn mv tomcat tomcat_$port</span><br><span class="line">expect eof</span><br><span class="line">spawn tar zcvf tomcat_$port.tar.gz tomcat_$port</span><br><span class="line">expect eof</span><br><span class="line">spawn scp $local_file/tomcat_$port.tar.gz $username@$host_ip:$remote_file</span><br><span class="line"></span><br><span class="line">expect &#123; </span><br><span class="line">&quot;(yes/no)?&quot;</span><br><span class="line">        &#123;send &quot;yes\r&quot;&#125;</span><br><span class="line">&quot;*password:&quot;</span><br><span class="line">        &#123;send &quot;$password\r&quot;&#125;</span><br><span class="line">&#125;</span><br><span class="line">expect &quot;100%&quot;</span><br><span class="line">expect eof</span><br><span class="line">spawn rm -r tomcat_$port.tar.gz</span><br><span class="line">expect eof</span><br><span class="line">spawn rm -r tomcat_$port</span><br><span class="line">expect eof</span><br><span class="line">spawn ssh $username@$host_ip</span><br><span class="line"></span><br><span class="line">expect &#123; </span><br><span class="line">&quot;(yes/no)?&quot;</span><br><span class="line">&#123;send &quot;yes\r&quot;&#125;</span><br><span class="line">&quot;*password:&quot;</span><br><span class="line">&#123;send &quot;$password\r&quot;&#125;</span><br><span class="line">&#125;</span><br><span class="line">expect &quot;$&quot;</span><br><span class="line">send &quot;cd $remote_file\r&quot;</span><br><span class="line">expect &quot;$&quot;</span><br><span class="line">send &quot;tar zvxf tomcat_$port.tar.gz\r&quot;</span><br><span class="line">expect &quot;$&quot;</span><br><span class="line">send &quot;rm -r tomcat_$port.tar.gz\r&quot;</span><br><span class="line">expect &quot;(yes/no)?&quot;</span><br><span class="line">send &quot;yes\r&quot;</span><br><span class="line">expect &quot;$&quot;</span><br><span class="line">send &quot;cd tomcat_$port\r&quot;</span><br><span class="line">expect &quot;$&quot;</span><br><span class="line">send &quot;./bin/startup.sh\r&quot;</span><br><span class="line">expect eof</span><br></pre></td></tr></table></figure><p>Files/server_list.conf</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Hostile username password srcfile distfile</span><br></pre></td></tr></table></figure><p>æ›´å¤šexpectçš„è¯¦ç»†å‘½ä»¤</p><p><a href="https://www.cnblogs.com/lixigang/articles/4849527.html" target="_blank" rel="noopener">https://www.cnblogs.com/lixigang/articles/4849527.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;expect-å®‰è£…&quot;&gt;&lt;a href=&quot;#expect-å®‰è£…&quot; class=&quot;headerlink&quot; title=&quot;expect å®‰è£…&quot;&gt;&lt;/a&gt;expect å®‰è£…&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;t</summary>
      
    
    
    
    
    <category term="expect" scheme="https://nmk0718.github.io/tag/expect/"/>
    
  </entry>
  
  <entry>
    <title>httpsè½¬å‘æ—¶ä¸¢å¤±</title>
    <link href="https://nmk0718.github.io/2020/05/21/https%E4%B8%A2%E5%A4%B1/"/>
    <id>https://nmk0718.github.io/2020/05/21/https%E4%B8%A2%E5%A4%B1/</id>
    <published>2020-05-21T14:20:00.000Z</published>
    <updated>2022-03-08T06:16:31.584Z</updated>
    
    <content type="html"><![CDATA[<p>é—®é¢˜:è®¿é—®httpsä½†ç•Œé¢çš„jsæˆ–cssä¼šåŠ è½½http,è·å–ä¸åˆ°https</p><p>è§£å†³æ–¹æ¡ˆ<br>1ã€nginxé…ç½®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">proxy_set_header Host $host;</span><br><span class="line">proxy_pass http://127.0.0.1:8080;</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">proxy_set_header X-Forwarded-Proto  $scheme;</span><br></pre></td></tr></table></figure><p>2ã€Spring Boot é…ç½®ï¼ˆåœ¨å¯åŠ¨ç±»é‡Œé¢é…ç½®,æ­¤æ–¹æ³•ä¸ºSpring Boot 2.Xä»¥ä¸Šï¼‰</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Bean</span><br><span class="line">    public TomcatServletWebServerFactory servletContainer() &#123;</span><br><span class="line">        TomcatServletWebServerFactory factory = new TomcatServletWebServerFactory();</span><br><span class="line">        factory.setUriEncoding(Charset.forName(&quot;UTF-8&quot;));</span><br><span class="line">        RemoteIpValve value = new RemoteIpValve();</span><br><span class="line">        value.setRemoteIpHeader(&quot;X-Forwarded-For&quot;);</span><br><span class="line">        value.setProtocolHeader(&quot;X-Forwarded-Proto&quot;);</span><br><span class="line">        value.setProtocolHeaderHttpsValue(&quot;https&quot;);</span><br><span class="line">        factory.addEngineValves(value);</span><br><span class="line">        return factory;</span><br></pre></td></tr></table></figure><p>3ã€è‹¥æ˜¯waråŒ…ï¼Œåœ¨tomcatçš„åœ¨server.xmlçš„Engineæ¨¡å—ä¸‹é¢é…ç½®å¤šä¸€ä¸ªä»¥ä¸‹çš„Valve</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;Valve  className=&quot;org.apache.catalina.valves.RemoteIpValve&quot; </span><br><span class="line">        remoteIpHeader=&quot;X-Forwarded-For&quot; </span><br><span class="line">        protocolHeader=&quot;X-Forwarded-Proto&quot; </span><br><span class="line">        protocolHeaderHttpsValue=&quot;https&quot;/&gt;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;é—®é¢˜:è®¿é—®httpsä½†ç•Œé¢çš„jsæˆ–cssä¼šåŠ è½½http,è·å–ä¸åˆ°https&lt;/p&gt;
&lt;p&gt;è§£å†³æ–¹æ¡ˆ&lt;br&gt;1ã€nginxé…ç½®&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span</summary>
      
    
    
    
    
    <category term="https" scheme="https://nmk0718.github.io/tag/https/"/>
    
  </entry>
  
  <entry>
    <title>kafka</title>
    <link href="https://nmk0718.github.io/2020/05/21/kafka/"/>
    <id>https://nmk0718.github.io/2020/05/21/kafka/</id>
    <published>2020-05-21T14:20:00.000Z</published>
    <updated>2024-11-29T06:44:43.779Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å®‰è£…kafka"><a href="#å®‰è£…kafka" class="headerlink" title="å®‰è£…kafka"></a>å®‰è£…kafka</h3><h4 id="ä¸‹è½½"><a href="#ä¸‹è½½" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir -p /opt/kafka &amp;&amp; cd /opt/kafka</span><br><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/apache/kafka/2.5.0/kafka_2.12-2.5.0.tgz</span><br></pre></td></tr></table></figure><h4 id="è§£å‹"><a href="#è§£å‹" class="headerlink" title="è§£å‹"></a>è§£å‹</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tar -zxvf kafka_2.12-2.5.0.tgz</span><br></pre></td></tr></table></figure><h4 id="é…ç½®ç¯å¢ƒå˜é‡"><a href="#é…ç½®ç¯å¢ƒå˜é‡" class="headerlink" title="é…ç½®ç¯å¢ƒå˜é‡"></a>é…ç½®ç¯å¢ƒå˜é‡</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi /etc/profile</span><br><span class="line"></span><br><span class="line">#å°†ä¸‹é¢çš„ä»£ç æ”¾åˆ°æœ«å°¾</span><br><span class="line">#set kafka environment</span><br><span class="line">export KAFKA_HOME=/opt/kafka/kafka_2.12-2.5.0</span><br><span class="line">export PATH=$PATH:$KAFKA_HOME/bin</span><br></pre></td></tr></table></figure><p>é‡æ–°åŠ è½½ç¯å¢ƒå˜é‡</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><h4 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi /opt/kafka/kafka_2.12-2.5.0/config/server.properties</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># (1).é…ç½® broker çš„ID</span><br><span class="line">broker.id=1  # ç¬¬ä¸€ä¸ªkafkaé…ç½®ä¸º 1ï¼Œç¬¬äºŒä¸ªé…ç½®ä¸º2ï¼Œä»¥æ­¤ç±»æ¨</span><br><span class="line"># (2).æ‰“å¼€ç›‘å¬ç«¯å£</span><br><span class="line"># å°½é‡å†™ipåœ°å€ï¼Œä»¥å…é€ æˆé”™è¯¯</span><br><span class="line">listeners=PLAINTEXT://10.211.55.3:9092</span><br><span class="line"># (3).ä¿®æ”¹ log çš„ç›®å½•ã€åœ¨æŒ‡å®šçš„ä½ç½®åˆ›å»ºå¥½æ–‡ä»¶å¤¹logs</span><br><span class="line">log.dirs=/opt/kafka/kafka_2.12-2.5.0/logs</span><br><span class="line"># (4).ä¿®æ”¹ zookeeper.connect,å°½é‡å†™ipåœ°å€ï¼Œä»¥å…é€ æˆé”™è¯¯</span><br><span class="line">zookeeper.connect=10.211.55.3:2181</span><br><span class="line"># (5).ç½‘ç»œçº¿ç¨‹æ•°é‡</span><br><span class="line">num.network.threads=3</span><br><span class="line"># (6).Zookeeperæ¯6ç§’ç›‘è§†kafkaæ˜¯å¦è¿˜æ´»ç€(é»˜è®¤)</span><br><span class="line">zookeeper.connection.timeout.ms=6000</span><br></pre></td></tr></table></figure><h4 id="å¯åŠ¨"><a href="#å¯åŠ¨" class="headerlink" title="å¯åŠ¨"></a>å¯åŠ¨</h4><p>å¯åŠ¨kafkaä¹‹å‰éœ€è¦å…ˆå¯åŠ¨zookeeperï¼Œç„¶åå†å¯åŠ¨kafka</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#å¯åŠ¨zookeeper</span><br><span class="line">zkServer.sh start</span><br><span class="line"></span><br><span class="line">#å¯åŠ¨kafka</span><br><span class="line">kafka-server-start.sh $KAFKA_HOME/config/server.properties &amp;  æ‰“å°æ—¥å¿—å¯åŠ¨</span><br><span class="line">kafka-server-start.sh -daemon $KAFKA_HOME/config/server.properties &amp; ä¸æ‰“å°æ—¥å¿—å¯åŠ¨</span><br><span class="line"></span><br><span class="line">#é€šè¿‡jpsæŸ¥çœ‹æ˜¯å¦å¯åŠ¨</span><br><span class="line">[root@nmk kafka]# jps</span><br><span class="line">2049 QuorumPeerMain</span><br><span class="line">3496 Jps</span><br><span class="line">3101 Kafka</span><br></pre></td></tr></table></figure><h4 id="å‘½ä»¤"><a href="#å‘½ä»¤" class="headerlink" title="å‘½ä»¤"></a>å‘½ä»¤</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#åˆ›å»ºtopic</span><br><span class="line">kafka-topics.sh --create --zookeeper 10.211.55.3:2181 --replication-factor 1 --partitions 1 --topic test</span><br><span class="line"></span><br><span class="line">#åˆ—å‡ºkafka</span><br><span class="line">[root@nmk kafka]# kafka-topics.sh --list --zookeeper 10.211.55.3:2181</span><br><span class="line">test</span><br><span class="line">#æœ‰åˆšåˆšçš„æµ‹è¯•topicåï¼Œè¡¨ç¤ºåˆ›å»ºæˆåŠŸ</span><br><span class="line"></span><br><span class="line">#å¦‚æœéœ€è¦æŸ¥çœ‹topicçš„è¯¦ç»†ä¿¡æ¯ï¼Œéœ€è¦ä½¿ç”¨describeå‘½ä»¤</span><br><span class="line">kafka-topics.sh --describe --zookeeper 10.211.55.3:2181--topic test-topic</span><br><span class="line"></span><br><span class="line">#è‹¥ä¸æŒ‡å®štopicï¼Œåˆ™æŸ¥çœ‹æ‰€æœ‰topicçš„ä¿¡æ¯</span><br><span class="line">kafka-topics.sh --describe --zookeeper 10.211.55.3:2181</span><br><span class="line"></span><br><span class="line">#åˆ é™¤topic</span><br><span class="line">kafka-topics.sh --delete --zookeeper 10.211.55.3:2181 --topic nmk</span><br><span class="line"></span><br><span class="line">#æŸ¥çœ‹æ¶ˆè´¹è€…ç»„</span><br><span class="line">kafka-consumer-groups.sh --bootstrap-server 10.211.55.3:9092 --list</span><br><span class="line"></span><br><span class="line">#åˆ›å»ºæ¶ˆè´¹è€…ç»„çš„ä¸¤ç§æ–¹å¼</span><br><span class="line">1.kafka-console-consumer.sh --bootstrap-server 10.211.55.3:9092 --topic nmk --consumer.config config/consumer.properties</span><br><span class="line"></span><br><span class="line">2.kafka-console-consumer.sh --bootstrap-server 10.211.55.3:9092 --topic nmk --group nmkgroup</span><br><span class="line"></span><br><span class="line">#ç”Ÿäº§è€…æ“ä½œ</span><br><span class="line">kafka-console-producer.sh --broker-list 10.211.55.3:9092 --topic nmk</span><br><span class="line"></span><br><span class="line">#æ¶ˆè´¹è€…æ“ä½œ</span><br><span class="line"></span><br><span class="line"># é€šè¿‡ä»¥ä¸Šå‘½ä»¤ï¼Œå¯ä»¥çœ‹åˆ°æ¶ˆè´¹è€…å¯ä»¥æ¥æ”¶ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯</span><br><span class="line">kafka-console-consumer.sh --bootstrap-server 10.211.55.3:9092 --topic nmk</span><br><span class="line"> </span><br><span class="line"># å¦‚æœéœ€è¦ä»å¤´å¼€å§‹æ¥æ”¶æ•°æ®ï¼Œéœ€è¦æ·»åŠ --from-beginningå‚æ•°</span><br><span class="line">kafka-console-consumer.sh --bootstrap-server 10.211.55.3:9092 --from-beginning --topic nmk</span><br><span class="line"></span><br><span class="line">#ä¸åŒç‰ˆæœ¬çš„kafkaæ“ä½œç‰ˆæœ¬ä¸åŒ.é«˜ç‰ˆæœ¬å¯ä½¿ç”¨--bootstrap-server ä½ç‰ˆæœ¬ä»…æ”¯æŒ--zookeeper</span><br></pre></td></tr></table></figure><h4 id="Kafkaç®¡ç†å·¥å…·"><a href="#Kafkaç®¡ç†å·¥å…·" class="headerlink" title="Kafkaç®¡ç†å·¥å…·"></a>Kafkaç®¡ç†å·¥å…·</h4><p> kafka-manageræ˜¯ç›®å‰æœ€å—æ¬¢è¿çš„kafkaé›†ç¾¤ç®¡ç†å·¥å…·ï¼Œæœ€æ—©ç”±é›…è™å¼€æºï¼Œç”¨æˆ·å¯ä»¥åœ¨Webç•Œé¢æ‰§è¡Œä¸€äº›ç®€å•çš„é›†ç¾¤ç®¡ç†æ“ä½œã€‚å…·ä½“æ”¯æŒä»¥ä¸‹å†…å®¹ï¼š</p><ul><li>ç®¡ç†å¤šä¸ªé›†ç¾¤</li><li>è½»æ¾æ£€æŸ¥ç¾¤é›†çŠ¶æ€ï¼ˆä¸»é¢˜ï¼Œæ¶ˆè´¹è€…ï¼Œåç§»ï¼Œä»£ç†ï¼Œå‰¯æœ¬åˆ†å‘ï¼Œåˆ†åŒºåˆ†å‘ï¼‰</li><li>è¿è¡Œé¦–é€‰å‰¯æœ¬é€‰ä¸¾</li><li>ä½¿ç”¨é€‰é¡¹ç”Ÿæˆåˆ†åŒºåˆ†é…ä»¥é€‰æ‹©è¦ä½¿ç”¨çš„ä»£ç†</li><li>è¿è¡Œåˆ†åŒºé‡æ–°åˆ†é…ï¼ˆåŸºäºç”Ÿæˆçš„åˆ†é…ï¼‰</li><li>ä½¿ç”¨å¯é€‰ä¸»é¢˜é…ç½®åˆ›å»ºä¸»é¢˜ï¼ˆ0.8.1.1å…·æœ‰ä¸0.8.2+ä¸åŒçš„é…ç½®ï¼‰</li><li>åˆ é™¤ä¸»é¢˜ï¼ˆä»…æ”¯æŒ0.8.2+å¹¶è®°ä½åœ¨ä»£ç†é…ç½®ä¸­è®¾ç½®delete.topic.enable = trueï¼‰</li><li>ä¸»é¢˜åˆ—è¡¨ç°åœ¨æŒ‡ç¤ºæ ‡è®°ä¸ºåˆ é™¤çš„ä¸»é¢˜ï¼ˆä»…æ”¯æŒ0.8.2+ï¼‰</li><li>æ‰¹é‡ç”Ÿæˆå¤šä¸ªä¸»é¢˜çš„åˆ†åŒºåˆ†é…ï¼Œå¹¶å¯é€‰æ‹©è¦ä½¿ç”¨çš„ä»£ç†</li><li>æ‰¹é‡è¿è¡Œé‡æ–°åˆ†é…å¤šä¸ªä¸»é¢˜çš„åˆ†åŒº</li><li>å°†åˆ†åŒºæ·»åŠ åˆ°ç°æœ‰ä¸»é¢˜</li><li>æ›´æ–°ç°æœ‰ä¸»é¢˜çš„é…ç½®</li></ul><p>kafka-manager é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/yahoo/CMAK" target="_blank" rel="noopener">https://github.com/yahoo/CMAK</a></p><p>ä¸‹è½½</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /opt/kafka/</span><br><span class="line">wget https://github.com/yahoo/CMAK/releases/download/3.0.0.4/cmak-3.0.0.4.zip</span><br><span class="line">mv cmak-3.0.0.4.zip kafka-manager-3.0.0.4.zip</span><br><span class="line">unzip kafka-manager-3.0.0.4.zip</span><br></pre></td></tr></table></figure><p>é…ç½®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi conf/application.conf </span><br><span class="line">#ä¿®æ”¹kafka-manager.zkhostsåˆ—è¡¨ä¸ºè‡ªå·±çš„zkèŠ‚ç‚¹</span><br><span class="line">kafka-manager.zkhosts=&quot;10.211.55.3&quot;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bin/kafka-manager é»˜è®¤çš„ç«¯å£æ˜¯9000ï¼Œå¯é€šè¿‡ -Dhttp.portï¼ŒæŒ‡å®šç«¯å£; </span><br><span class="line">-Dconfig.file=conf/application.confæŒ‡å®šé…ç½®æ–‡ä»¶:</span><br><span class="line"></span><br><span class="line">nohup bin/kafka-manager -Dconfig.file=conf/application.conf -Dhttp.port=9001 &amp;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;å®‰è£…kafka&quot;&gt;&lt;a href=&quot;#å®‰è£…kafka&quot; class=&quot;headerlink&quot; title=&quot;å®‰è£…kafka&quot;&gt;&lt;/a&gt;å®‰è£…kafka&lt;/h3&gt;&lt;h4 id=&quot;ä¸‹è½½&quot;&gt;&lt;a href=&quot;#ä¸‹è½½&quot; class=&quot;headerlink&quot; title=&quot;ä¸‹</summary>
      
    
    
    
    
    <category term="kafka" scheme="https://nmk0718.github.io/tag/kafka/"/>
    
  </entry>
  
  <entry>
    <title>zookeeper</title>
    <link href="https://nmk0718.github.io/2020/05/21/zookeeper/"/>
    <id>https://nmk0718.github.io/2020/05/21/zookeeper/</id>
    <published>2020-05-21T14:20:00.000Z</published>
    <updated>2024-11-29T06:41:35.817Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å®‰è£…zookeeper"><a href="#å®‰è£…zookeeper" class="headerlink" title="å®‰è£…zookeeper"></a>å®‰è£…zookeeper</h3><p>ç¯å¢ƒè¦æ±‚:JDK1.8</p><p>ä¸‹è½½</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir -p /opt/zookeeper &amp;&amp; <span class="built_in">cd</span> /opt/zookeeper</span><br><span class="line">wget https://mirrors.cnnic.cn/apache/zookeeper/zookeeper-3.6.1/apache-zookeeper-3.6.1-bin.tar.gz</span><br></pre></td></tr></table></figure><p>è§£å‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tar -zxvf apache-zookeeper-3.6.1-bin.tar.gz</span><br></pre></td></tr></table></figure><p>å…³é—­é˜²ç«å¢™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">## åœæ­¢firewall</span></span><br><span class="line">systemctl stop firewalld.service</span><br><span class="line"><span class="comment">## ç¦æ­¢firewallå¼€æœºå¯åŠ¨</span></span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld.service</span><br></pre></td></tr></table></figure><p>é…ç½®ç¯å¢ƒå˜é‡</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment">#å°†ä¸‹é¢çš„ä»£ç æ”¾åˆ°æœ«å°¾</span></span><br><span class="line"><span class="comment">#set zookeeper environment</span></span><br><span class="line"><span class="built_in">export</span> ZK_HOME=/opt/zookeeper/apache-zookeeper-3.6.1-bin</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$ZK_HOME</span>/bin</span><br></pre></td></tr></table></figure><p>é‡æ–°åŠ è½½ç¯å¢ƒå˜é‡</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure><h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/zookeeper/apache-zookeeper-3.6.1-bin/conf</span><br><span class="line">cp zoo_sample.cfg zoo.cfg</span><br><span class="line">vi zoo.cfg</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> The number of milliseconds of each tick</span></span><br><span class="line">tickTime=2000</span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of ticks that the initial</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> synchronization phase can take</span></span><br><span class="line">initLimit=10</span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of ticks that can pass between</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sending a request and getting an acknowledgement</span></span><br><span class="line">syncLimit=5</span><br><span class="line"><span class="meta">#</span><span class="bash"> the directory <span class="built_in">where</span> the snapshot is stored.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">do</span> not use /tmp <span class="keyword">for</span> storage, /tmp here is just</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> example sakes.</span></span><br><span class="line">dataDir=/tmp/zookeeper</span><br><span class="line"><span class="meta">#</span><span class="bash"> the port at <span class="built_in">which</span> the clients will connect</span></span><br><span class="line">clientPort=2181</span><br><span class="line"><span class="meta">#</span><span class="bash"> the maximum number of client connections.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> increase this <span class="keyword">if</span> you need to handle more clients</span></span><br><span class="line"><span class="meta">#</span><span class="bash">maxClientCnxns=60</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Be sure to <span class="built_in">read</span> the maintenance section of the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> administrator guide before turning on autopurge.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> http://zookeeper.apache.org/doc/current/zookeeperAdmin.html<span class="comment">#sc_maintenance</span></span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">æ•°æ®æ–‡ä»¶å¤¹</span></span><br><span class="line">dataDir=/opt/zookeeper/apache-zookeeper-3.6.1-bin/data</span><br><span class="line"><span class="meta">#</span><span class="bash">ç›‘å¬ç«¯å£</span></span><br><span class="line">clientPort=2181</span><br></pre></td></tr></table></figure><p>å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">zkServer.sh start</span><br><span class="line">zkServer.sh stop</span><br><span class="line">zkServer.sh status</span><br><span class="line">zkServer.sh stop</span><br></pre></td></tr></table></figure><p>å¦‚ä¸åŠ ç¯å¢ƒå˜é‡éœ€è¦è¿›å…¥ç›®å½•ä½¿ç”¨å‘½ä»¤</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /opt/zookeeper/apache-zookeeper-3.6.1-bin/bin</span><br><span class="line">./zkServer.sh start</span><br><span class="line"></span><br><span class="line">## å¦‚æœæ— æ³•å¯åŠ¨ï¼ŒæŸ¥çœ‹å¯åŠ¨æ—¥å¿—</span><br><span class="line">./zkServer.sh start-foreground</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è¿›ç¨‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ps -ef|grep zookeeper</span><br></pre></td></tr></table></figure><h3 id="zookeeperå‘½ä»¤"><a href="#zookeeperå‘½ä»¤" class="headerlink" title="zookeeperå‘½ä»¤"></a>zookeeperå‘½ä»¤</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#æŸ¥çœ‹brokerçš„id</span><br><span class="line">[zk: localhost:2181(CONNECTED) 0] ls /brokers/ids</span><br><span class="line">[1]</span><br><span class="line">#æŸ¥çœ‹æ¶ˆæ¯</span><br><span class="line">[zk: localhost:2181(CONNECTED) 1] ls /brokers/topics</span><br><span class="line">[__consumer_offsets, fund-deploy-dev, nmk, test, tmallgift-dev, tmallgift-tdev]</span><br><span class="line">#æŸ¥çœ‹åˆ é™¤çš„æ¶ˆæ¯</span><br><span class="line">ls /admin/delete_topics</span><br><span class="line">[account]</span><br><span class="line">#æŸ¥çœ‹brokerçš„ä¿¡æ¯</span><br><span class="line">get /brokers/ids/0</span><br><span class="line">[zk: localhost:2181(CONNECTED) 1] get /brokers/ids/1</span><br><span class="line">&#123;&quot;listener_security_protocol_map&quot;:&#123;&quot;PLAINTEXT&quot;:&quot;PLAINTEXT&quot;&#125;,&quot;endpoints&quot;:[&quot;PLAINTEXT://172.17.65.46:9092&quot;],&quot;jmx_port&quot;:-1,&quot;host&quot;:&quot;172.17.65.46&quot;,&quot;timestamp&quot;:&quot;1589882903946&quot;,&quot;port&quot;:9092,&quot;version&quot;:4&#125;</span><br><span class="line">#åˆ é™¤æ¶ˆæ¯</span><br><span class="line">rmr /brokers/topics/test</span><br><span class="line">rmr /admin/delete_topics/test</span><br></pre></td></tr></table></figure><h3 id="å•æœºæ­å»ºzookeeperé›†ç¾¤"><a href="#å•æœºæ­å»ºzookeeperé›†ç¾¤" class="headerlink" title="å•æœºæ­å»ºzookeeperé›†ç¾¤"></a>å•æœºæ­å»ºzookeeperé›†ç¾¤</h3><p>æ‰€è°“å•æœºæ­å»ºzookeeperé›†ç¾¤å…¶å®å°±æ˜¯åœ¨ä¸€å°æœºå™¨ä¸Šå¯åŠ¨å¤šä¸ªzookeeperï¼Œåœ¨å¯åŠ¨æ¯ä¸ªzookeeperæ—¶åˆ†åˆ«ä½¿ç”¨ä¸åŒçš„é…ç½®æ–‡ä»¶zoo.cfgæ¥å¯åŠ¨,æ¯ä¸ªé…ç½®æ–‡ä»¶ä½¿ç”¨ä¸åŒçš„é…ç½®å‚æ•°(clientPortç«¯å£å·ã€dataDiræ•°æ®ç›®å½•ã€dataLogDiræ•°æ®æ—¥å¿—ç›®å½•)åœ¨åŒä¸€å°æœºå™¨ä¸Šå¯åŠ¨å¤šæ¬¡ã€‚</p><h5 id="é…ç½®å¤šä¸ªzoo-cfgé…ç½®æ–‡ä»¶"><a href="#é…ç½®å¤šä¸ªzoo-cfgé…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®å¤šä¸ªzoo.cfgé…ç½®æ–‡ä»¶"></a>é…ç½®å¤šä¸ªzoo.cfgé…ç½®æ–‡ä»¶</h5><p>zookeeper-1</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@server conf]# cat zoo.cfg </span><br><span class="line"># The number of milliseconds of each tick</span><br><span class="line">tickTime=2000</span><br><span class="line"># The number of ticks that the initial</span><br><span class="line"># synchronization phase can take</span><br><span class="line">initLimit=10</span><br><span class="line"># The number of ticks that can pass between</span><br><span class="line"># sending a request and getting an acknowledgement</span><br><span class="line">syncLimit=5</span><br><span class="line"># the directory where the snapshot is stored.</span><br><span class="line"># do not use /tmp for storage, /tmp here is just</span><br><span class="line"># example sakes.</span><br><span class="line">dataDir=/opt/zookeeper-1/zookeeper</span><br><span class="line"># the port at which the clients will connect</span><br><span class="line">clientPort=2181</span><br><span class="line"># the maximum number of client connections.</span><br><span class="line"># increase this if you need to handle more clients</span><br><span class="line">#maxClientCnxns=60</span><br><span class="line">#</span><br><span class="line"># Be sure to read the maintenance section of the</span><br><span class="line"># administrator guide before turning on autopurge.</span><br><span class="line">#</span><br><span class="line"># http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span><br><span class="line">#</span><br><span class="line"># The number of snapshots to retain in dataDir</span><br><span class="line">#autopurge.snapRetainCount=3</span><br><span class="line"># Purge task interval in hours</span><br><span class="line"># Set to &quot;0&quot; to disable auto purge feature</span><br><span class="line">#autopurge.purgeInterval=1</span><br><span class="line">server.0=localhost:2287:3387</span><br><span class="line">server.1=localhost:2288:3388</span><br><span class="line">server.2=localhost:2289:3389</span><br><span class="line">admin.serverPort=8881</span><br></pre></td></tr></table></figure><p>zookeeper-2</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@server conf]# cat zoo.cfg </span><br><span class="line"># The number of milliseconds of each tick</span><br><span class="line">tickTime=2000</span><br><span class="line"># The number of ticks that the initial</span><br><span class="line"># synchronization phase can take</span><br><span class="line">initLimit=10</span><br><span class="line"># The number of ticks that can pass between</span><br><span class="line"># sending a request and getting an acknowledgement</span><br><span class="line">syncLimit=5</span><br><span class="line"># the directory where the snapshot is stored.</span><br><span class="line"># do not use /tmp for storage, /tmp here is just</span><br><span class="line"># example sakes.</span><br><span class="line">dataDir=/opt/zookeeper-2/zookeeper</span><br><span class="line"># the port at which the clients will connect</span><br><span class="line">clientPort=2182</span><br><span class="line"># the maximum number of client connections.</span><br><span class="line"># increase this if you need to handle more clients</span><br><span class="line">#maxClientCnxns=60</span><br><span class="line">#</span><br><span class="line"># Be sure to read the maintenance section of the</span><br><span class="line"># administrator guide before turning on autopurge.</span><br><span class="line">#</span><br><span class="line"># http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span><br><span class="line">#</span><br><span class="line"># The number of snapshots to retain in dataDir</span><br><span class="line">#autopurge.snapRetainCount=3</span><br><span class="line"># Purge task interval in hours</span><br><span class="line"># Set to &quot;0&quot; to disable auto purge feature</span><br><span class="line">#autopurge.purgeInterval=1</span><br><span class="line">server.0=localhost:2287:3387</span><br><span class="line">server.1=localhost:2288:3388</span><br><span class="line">server.2=localhost:2289:3389</span><br><span class="line">admin.serverPort=8882</span><br></pre></td></tr></table></figure><p>zookeeper-3</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@server conf]# cat zoo.cfg </span><br><span class="line"># The number of milliseconds of each tick</span><br><span class="line">tickTime=2000</span><br><span class="line"># The number of ticks that the initial</span><br><span class="line"># synchronization phase can take</span><br><span class="line">initLimit=10</span><br><span class="line"># The number of ticks that can pass between</span><br><span class="line"># sending a request and getting an acknowledgement</span><br><span class="line">syncLimit=5</span><br><span class="line"># the directory where the snapshot is stored.</span><br><span class="line"># do not use /tmp for storage, /tmp here is just</span><br><span class="line"># example sakes.</span><br><span class="line">dataDir=/opt/zookeeper-3/zookeeper</span><br><span class="line"># the port at which the clients will connect</span><br><span class="line">clientPort=2183</span><br><span class="line"># the maximum number of client connections.</span><br><span class="line"># increase this if you need to handle more clients</span><br><span class="line">#maxClientCnxns=60</span><br><span class="line">#</span><br><span class="line"># Be sure to read the maintenance section of the</span><br><span class="line"># administrator guide before turning on autopurge.</span><br><span class="line">#</span><br><span class="line"># http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span><br><span class="line">#</span><br><span class="line"># The number of snapshots to retain in dataDir</span><br><span class="line">#autopurge.snapRetainCount=3</span><br><span class="line"># Purge task interval in hours</span><br><span class="line"># Set to &quot;0&quot; to disable auto purge feature</span><br><span class="line">#autopurge.purgeInterval=1</span><br><span class="line">server.0=localhost:2287:3387</span><br><span class="line">server.1=localhost:2288:3388</span><br><span class="line">server.2=localhost:2289:3389</span><br><span class="line">admin.serverPort=8883</span><br></pre></td></tr></table></figure><ul><li>tickTime: åŸºæœ¬äº‹ä»¶å•å…ƒï¼Œä»¥æ¯«ç§’ä¸ºå•ä½ã€‚è¿™ä¸ªæ—¶é—´æ˜¯ä½œä¸ºzookeeperæœåŠ¡å™¨ä¹‹é—´æˆ–å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨é—´ç»´æŒå¿ƒè·³çš„æ—¶é—´ã€‚ä¹Ÿå°±æ˜¯æ¯éš”tickTimeæ—¶é—´å°±ä¼šå‘é€ä¸€ä¸ªå¿ƒè·³</li><li>dataDir: å­˜å‚¨å†…å­˜ä¸­æ•°æ®åº“å¿«ç…§çš„ä½ç½®ï¼Œå°±æ˜¯zookeeperä¿å­˜æ•°æ®çš„ç›®å½•ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œzookeeperå°†æ•°æ®çš„æ—¥å¿—é—®ä¹Ÿä¿å­˜åœ¨è¿™ä¸ªç›®å½•é‡Œ</li><li>clientPort: å®¢æˆ·ç«¯è¿æ¥zookeeperæœåŠ¡å™¨çš„ç«¯å£ï¼Œé»˜è®¤æ˜¯2181ï¼Œzookeeperä¼šç›‘å¬è¿™ä¸ªç«¯å£ï¼Œæ¥æ”¶å®¢æˆ·ç«¯çš„è®¿é—®è¯·æ±‚</li><li>initLimit: è¿™ä¸ªé…ç½®é¡¹æ˜¯ç”¨æ¥é…ç½®zookeeperæ¥æ”¶å®¢æˆ·ç«¯åˆå§‹åŒ–è¿æ¥èƒ½å¿å—å¤šå°‘ä¸ªå¿ƒè·³æ—¶é—´é—´éš”æ•°ã€‚å½“å·²ç»è¶…è¿‡10ä¸ªå¿ƒè·³çš„æ—¶é—´(tickTime)é•¿åº¦åï¼ŒzookeeperæœåŠ¡å™¨è¿˜æ²¡æœ‰æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„è¿”å›ä¿¡æ¯ï¼Œé‚£ä¹ˆè¡¨æ˜è¿™ä¸ªå®¢æˆ·ç«¯è¿æ¥å¤±è´¥ã€‚æ€»çš„æ—¶é—´é•¿åº¦å°±æ˜¯ 10*2000 = 20 ç§’</li><li>syncLimit: è¿™ä¸ªé…ç½®é¡¹æ ‡è¯†Leaderå’ŒFollowerä¹‹é—´å‘é€æ¶ˆæ¯ï¼Œè¯·æ±‚å’Œåº”ç­”çš„é•¿åº¦ï¼Œæœ€é•¿ä¸èƒ½è¶…è¿‡å¤šå°‘ä¸ªtickTimeçš„æ—¶é—´é•¿åº¦ï¼Œæ€»çš„æ—¶é—´é•¿åº¦å°±æ˜¯ 5 * 2000 = 10ç§’</li><li>server.myid=IP:Port1:Port2, myidæ˜¯æœåŠ¡å™¨çš„ç¼–å·ï¼Œä¸€ä¸ªæ­£æ•´æ•°ï¼Œä¸€èˆ¬æ˜¯0ã€1ã€2ã€3ç­‰å¾…ï¼Œport1è¡¨ç¤ºçš„æ˜¯æœåŠ¡å™¨ä¸é›†ç¾¤ä¸­çš„LeaderæœåŠ¡å™¨äº¤æ¢ä¿¡æ¯çš„ç«¯å£ï¼Œä¸€èˆ¬ç”¨2288ï¼ŒPort2è¡¨ç¤ºçš„æ˜¯ä¸‡ä¸€é›†ç¾¤ä¸­çš„LeaderæœåŠ¡å™¨å®•æœºäº†ï¼Œéœ€è¦ä¸€ä¸ªç«¯å£æ¥é‡æ–°è¿›è¡Œå®£è®²ï¼Œé€‰å‡ºä¸€ä¸ªæ–°çš„Leaderï¼Œä¸€èˆ¬ç”¨3388</li></ul><p>åˆ›å»ºmyidæ–‡ä»¶å¹¶é…ç½®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@public-service zookeeper]# cat /opt/zookeeper-1/zookeeper/myid</span><br><span class="line">0</span><br><span class="line">[root@public-service zookeeper]# cat /opt/zookeeper-2/zookeeper/myid </span><br><span class="line">1</span><br><span class="line">[root@public-service zookeeper]# cat /opt/zookeeper-3/zookeeper/myid</span><br><span class="line">2</span><br></pre></td></tr></table></figure><h5 id="å¯åŠ¨3ä¸ªzookeeperæœåŠ¡"><a href="#å¯åŠ¨3ä¸ªzookeeperæœåŠ¡" class="headerlink" title="å¯åŠ¨3ä¸ªzookeeperæœåŠ¡"></a>å¯åŠ¨3ä¸ªzookeeperæœåŠ¡</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">./zkServer.sh start /opt/zookeeper-1/conf/zoo.cfg </span><br><span class="line">./zkServer.sh start /opt/zookeeper-2/conf/zoo.cfg </span><br><span class="line">./zkServer.sh start /opt/zookeeper-3/conf/zoo.cfg</span><br></pre></td></tr></table></figure><h5 id="æŸ¥çœ‹æ¯ä¸ªzookeeperå¯¹åº”çš„è§’è‰²"><a href="#æŸ¥çœ‹æ¯ä¸ªzookeeperå¯¹åº”çš„è§’è‰²" class="headerlink" title="æŸ¥çœ‹æ¯ä¸ªzookeeperå¯¹åº”çš„è§’è‰²"></a>æŸ¥çœ‹æ¯ä¸ªzookeeperå¯¹åº”çš„è§’è‰²</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">./zkServer.sh status /opt/zookeeper-1/conf/zoo.cfg </span><br><span class="line">./zkServer.sh status /opt/zookeeper-2/conf/zoo.cfg </span><br><span class="line">./zkServer.sh status /opt/zookeeper-3/conf/zoo.cfg</span><br></pre></td></tr></table></figure><h5 id="åœæ­¢zookeeperæœåŠ¡"><a href="#åœæ­¢zookeeperæœåŠ¡" class="headerlink" title="åœæ­¢zookeeperæœåŠ¡"></a>åœæ­¢zookeeperæœåŠ¡</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">zkServer stop /opt/zookeeper-1/conf/zoo.cfg</span><br><span class="line">zkServer stop /opt/zookeeper-2/conf/zoo.cfg</span><br><span class="line">zkServer stop /opt/zookeeper-3/conf/zoo.cfg</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;å®‰è£…zookeeper&quot;&gt;&lt;a href=&quot;#å®‰è£…zookeeper&quot; class=&quot;headerlink&quot; title=&quot;å®‰è£…zookeeper&quot;&gt;&lt;/a&gt;å®‰è£…zookeeper&lt;/h3&gt;&lt;p&gt;ç¯å¢ƒè¦æ±‚:JDK1.8&lt;/p&gt;
&lt;p&gt;ä¸‹è½½&lt;/p&gt;
&lt;figure </summary>
      
    
    
    
    
    <category term="zookeeper" scheme="https://nmk0718.github.io/tag/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>nexus</title>
    <link href="https://nmk0718.github.io/2020/04/14/Nexus/"/>
    <id>https://nmk0718.github.io/2020/04/14/Nexus/</id>
    <published>2020-04-14T14:30:00.000Z</published>
    <updated>2024-11-29T06:45:20.053Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ä¸‹è½½"><a href="#ä¸‹è½½" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h3><p>å®˜æ–¹ä¸‹è½½åœ°å€:<a href="https://help.sonatype.com/repomanager3/download/download-archives---repository-manager-3" target="_blank" rel="noopener">https://help.sonatype.com/repomanager3/download/download-archives---repository-manager-3</a></p><p>ä¸‹è½½ä¼šå¾ˆæ…¢,è¯·ä½¿ç”¨vpnä¸‹è½½</p><p>ä½¿ç”¨CRTæˆ–Xshellå·¥å…·ä¸Šä¼ åˆ°æœåŠ¡å™¨:/usr/local/nexusç›®å½•ä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tar zxvf nexus-3.15.2-01-unix.tar.gz</span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹é…ç½®"><a href="#ä¿®æ”¹é…ç½®" class="headerlink" title="ä¿®æ”¹é…ç½®"></a>ä¿®æ”¹é…ç½®</h3><p>å¯ä»¥åœ¨nexus-default.propertiesæ–‡ä»¶ä¸­ï¼ˆä½äº/nexus-3.9.0-01/etc/ç›®å½•ä¸‹ï¼‰ä¿®æ”¹WEBè®¿é—®ç«¯å£ç­‰ä¿¡æ¯ï¼Œé»˜è®¤ä¸º8081ç«¯å£ï¼›é˜²ç«å¢™æ”¾è¡Œ8081ç«¯å£ï¼›</p><h3 id="å¯åŠ¨"><a href="#å¯åŠ¨" class="headerlink" title="å¯åŠ¨"></a>å¯åŠ¨</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">./nexus run &amp;</span><br></pre></td></tr></table></figure><h3 id="æ£€éªŒæ˜¯å¦å®‰è£…æˆåŠŸ"><a href="#æ£€éªŒæ˜¯å¦å®‰è£…æˆåŠŸ" class="headerlink" title="æ£€éªŒæ˜¯å¦å®‰è£…æˆåŠŸ"></a>æ£€éªŒæ˜¯å¦å®‰è£…æˆåŠŸ</h3><p>æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®ï¼š<a href="http://localhost:8081/" target="_blank" rel="noopener">http://localhost:8081/</a><br>é»˜è®¤ç”¨æˆ·å admin é»˜è®¤å¯†ç  admin123</p><h3 id="ä»“åº“è¿ç§»"><a href="#ä»“åº“è¿ç§»" class="headerlink" title="ä»“åº“è¿ç§»"></a>ä»“åº“è¿ç§»</h3><p>Nexusçš„æ„ä»¶ä»“åº“éƒ½ä¿å­˜åœ¨sonatype-workç›®å½•ä¸­ï¼Œè¯¥ç›®å½•çš„ä½ç½®ç”±bin/nexus.vmoptionsé…ç½®æ–‡ä»¶æŒ‡å®šï¼ˆDkaraf.dataï¼‰ã€‚<br>ä»“åº“è¿ç§»éœ€è¦ä¸¤ä¸ªè¿‡ç¨‹ï¼šå¤‡ä»½å’Œè¿˜åŸ</p><p>å¤‡ä»½ä»“åº“</p><p>å°†sonatype-workæ–‡ä»¶å¤¹æ•´ä½“å¤‡ä»½å³å¯ã€‚</p><p>è¿˜åŸä»“åº“</p><p>å°†å¤‡ä»½å¥½çš„sonatype-workæ–‡ä»¶æ‹·è´åˆ°æ–°çš„æœåŠ¡å™¨ä¸­ã€‚ç„¶åä¿®æ”¹bin/nexus.vmoptionsé…ç½®æ–‡ä»¶ï¼Œé‡æ–°æŒ‡å®šä»“åº“çš„ç›®å½•ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;ä¸‹è½½&quot;&gt;&lt;a href=&quot;#ä¸‹è½½&quot; class=&quot;headerlink&quot; title=&quot;ä¸‹è½½&quot;&gt;&lt;/a&gt;ä¸‹è½½&lt;/h3&gt;&lt;p&gt;å®˜æ–¹ä¸‹è½½åœ°å€:&lt;a href=&quot;https://help.sonatype.com/repomanager3/download/downlo</summary>
      
    
    
    
    
    <category term="nexus" scheme="https://nmk0718.github.io/tag/nexus/"/>
    
  </entry>
  
  <entry>
    <title>mysql</title>
    <link href="https://nmk0718.github.io/2020/04/09/mysql/"/>
    <id>https://nmk0718.github.io/2020/04/09/mysql/</id>
    <published>2020-04-08T16:20:00.000Z</published>
    <updated>2024-11-29T06:44:17.913Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å®‰è£…mysql"><a href="#å®‰è£…mysql" class="headerlink" title="å®‰è£…mysql"></a>å®‰è£…mysql</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#æ­¤æ¬¡å®‰è£…ä¸ºmysql5.7ç‰ˆæœ¬,ä½¿ç”¨yum install mysqlé»˜è®¤å®‰è£…ä¸ºmariadb</span><br><span class="line"></span><br><span class="line">wget https://repo.mysql.com/mysql80-community-release-el7-3.noarch.rpm</span><br><span class="line">#ä¸‹è½½rpmåŒ…</span><br><span class="line">rpm -ivh mysql80-community-release-el7-3.noarch.rpm</span><br><span class="line">#å®‰è£…rpmåŒ…</span><br><span class="line">yum repolist all | grep mysql </span><br><span class="line">#æŸ¥çœ‹åŒ…ç‰ˆæœ¬</span><br><span class="line">yum-config-manager --disable mysql80-community</span><br><span class="line">#å–æ¶ˆmysql80-communityçš„é»˜è®¤å®‰è£…</span><br><span class="line">yum-config-manager --enable mysql57-community</span><br><span class="line">#æ›´æ”¹ä¸ºmysql57-communityé»˜è®¤å®‰è£…ç‰ˆæœ¬</span><br><span class="line">#å¦‚ä¸èƒ½ä½¿ç”¨ä½¿ç”¨yum-config-managerè¯·ä½¿ç”¨yum -y install yum-utils</span><br><span class="line">yum install mysql-community-server</span><br><span class="line">yum -y install mysql-devel</span><br><span class="line">#å®‰è£…å®Œæ¯•</span><br></pre></td></tr></table></figure><h3 id="mysqlä½¿ç”¨"><a href="#mysqlä½¿ç”¨" class="headerlink" title="mysqlä½¿ç”¨"></a>mysqlä½¿ç”¨</h3><h4 id="mysqlæœåŠ¡"><a href="#mysqlæœåŠ¡" class="headerlink" title="mysqlæœåŠ¡"></a>mysqlæœåŠ¡</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CentOS 7ä¹‹å‰</span><br><span class="line">service mysqld start  â€”â€”å¯åŠ¨mysqlæœåŠ¡</span><br><span class="line">service mysqld stop              â€”â€”åœæ­¢mysqlæœåŠ¡</span><br><span class="line">service mysqld restart   â€”â€”é‡å¯mysqlæœåŠ¡</span><br><span class="line">service mysqld status â€”â€”æŸ¥çœ‹mysqlæœåŠ¡</span><br><span class="line">CentOS 7.xå¼€å§‹ï¼ŒCentOSå¼€å§‹ä½¿ç”¨systemdæœåŠ¡æ¥ä»£æ›¿daemon</span><br><span class="line">systemctl start mysqld.service  â€”â€”å¯åŠ¨mysqlæœåŠ¡</span><br><span class="line">systemctl stop mysqld.service  â€”â€”åœæ­¢mysqlæœåŠ¡</span><br><span class="line">systemctl restart mysqld.service â€”â€”é‡å¯mysqlæœåŠ¡</span><br><span class="line">systemctl status mysqld.service  â€”â€”æŸ¥çœ‹mysqlçŠ¶æ€</span><br><span class="line">mysql -V --æŸ¥çœ‹mysqlç‰ˆæœ¬</span><br></pre></td></tr></table></figure><h4 id="è¿æ¥æ•°æ®åº“"><a href="#è¿æ¥æ•°æ®åº“" class="headerlink" title="è¿æ¥æ•°æ®åº“"></a>è¿æ¥æ•°æ®åº“</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line">#æœ¬åœ°ç™»é™†</span><br><span class="line"></span><br><span class="line">mysql -hä¸»æœºåœ°å€ -Pç«¯å£ -uç”¨æˆ·å ï¼pç”¨æˆ·å¯†ç </span><br><span class="line">#è¿œç¨‹ç™»é™†</span><br><span class="line"></span><br><span class="line">grep &quot;temporary password&quot; /var/log/mysqld.log</span><br><span class="line">#è·å–ä¸´æ—¶å¯†ç </span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹é»˜è®¤å¯†ç "><a href="#ä¿®æ”¹é»˜è®¤å¯†ç " class="headerlink" title="ä¿®æ”¹é»˜è®¤å¯†ç "></a>ä¿®æ”¹é»˜è®¤å¯†ç </h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; ALTER USER USER() IDENTIFIED BY &apos;nmk0718&apos;;</span><br><span class="line">#å¦‚éœ€å¼±å¯†ç è¯·ä½¿ç”¨ä¸€ä¸‹å‘½ä»¤</span><br><span class="line">mysql&gt; set global validate_password_policy=LOW;</span><br><span class="line">mysql&gt; set global validate_password_length=6;</span><br></pre></td></tr></table></figure><h4 id="å¼€å¯è¿œç¨‹è¿æ¥"><a href="#å¼€å¯è¿œç¨‹è¿æ¥" class="headerlink" title="å¼€å¯è¿œç¨‹è¿æ¥"></a>å¼€å¯è¿œç¨‹è¿æ¥</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; grant all privileges on *.* to &apos;root&apos;@&apos;%&apos; identified by &apos;nmk0718&apos;;</span><br><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure><h4 id="é€€å‡ºmysql"><a href="#é€€å‡ºmysql" class="headerlink" title="é€€å‡ºmysql"></a>é€€å‡ºmysql</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; exit/quit;</span><br></pre></td></tr></table></figure><h4 id="å¿˜è®°å¯†ç "><a href="#å¿˜è®°å¯†ç " class="headerlink" title="å¿˜è®°å¯†ç "></a>å¿˜è®°å¯†ç </h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl stop mysqld.service</span><br><span class="line">#åœæ­¢æœåŠ¡</span><br><span class="line"></span><br><span class="line">vi /etc/my.cnf</span><br><span class="line">#ç¼–è¾‘é…ç½®æ–‡ä»¶åœ¨socket=/var/lib/mysql/mysql.sockä¸‹ä¸€è¡ŒåŠ å…¥skip-grant-tables</span><br><span class="line">#ä½œç”¨ä¸ºè·³è¿‡å¯†ç éªŒè¯</span><br><span class="line"></span><br><span class="line">systemctl start mysqld.service</span><br><span class="line">#å¯åŠ¨æœåŠ¡</span><br><span class="line"></span><br><span class="line">mysql -u root</span><br><span class="line">mysql&gt;update mysql.user set authentication_string=password(&apos;nmk0718&apos;) where user=&apos;root&apos;;</span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">mysql&gt; exit</span><br><span class="line">#è¿›å…¥mysqlä¿®æ”¹å¯†ç </span><br><span class="line"></span><br><span class="line">systemctl stop mysqld.service</span><br><span class="line"></span><br><span class="line">vi /etc/my.cnf</span><br><span class="line">#åˆ é™¤åŠ å…¥çš„skip-grant-tables</span><br><span class="line"></span><br><span class="line">systemctl start mysqld.service</span><br></pre></td></tr></table></figure><h4 id="æŸ¥çœ‹å¯†ç ç­–ç•¥"><a href="#æŸ¥çœ‹å¯†ç ç­–ç•¥" class="headerlink" title="æŸ¥çœ‹å¯†ç ç­–ç•¥"></a>æŸ¥çœ‹å¯†ç ç­–ç•¥</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#æŸ¥çœ‹å¯†ç ç­–ç•¥</span><br><span class="line">mysql&gt; show variables like &apos;%validate_password_policy%&apos;;</span><br><span class="line">+--------------------------+--------+</span><br><span class="line">| Variable_name            | Value  |</span><br><span class="line">+--------------------------+--------+</span><br><span class="line">| validate_password_policy | MEDIUM |</span><br><span class="line">+--------------------------+--------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show variables like &apos;%validate_password_length%&apos;;</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">| Variable_name            | Value |</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">| validate_password_length | 8     |</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">#ä¿®æ”¹å¯†ç ç­–ç•¥</span><br><span class="line">set global validate_password_policy=0;</span><br><span class="line">set global validate_password_length=1;</span><br></pre></td></tr></table></figure><p>validate_password.policyï¼ˆæ ¡éªŒè§„åˆ™ï¼‰ï¼Œå–å€¼èŒƒå›´[0,1,2]ï¼Œé»˜è®¤å€¼1ã€‚0ï¼ˆLOWï¼‰ï¼šåªæ ¡éªŒé•¿åº¦ï¼›1ï¼ˆMEDIUMï¼‰ï¼šæ ¡éªŒé•¿åº¦ã€å¤§å°å†™å’Œç‰¹æ®Šå­—ç¬¦ï¼›2ï¼ˆSTRONGï¼‰ï¼šæ ¡éªŒé•¿åº¦ã€å¤§å°å†™ã€ç‰¹æ®Šå­—ç¬¦å’Œdictionary_file</p><p>å¯†ç ç­–ç•¥çš„æ‰€æœ‰å‚æ•°ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; SHOW VARIABLES LIKE &apos;validate_password%&apos;;</span><br><span class="line">+--------------------------------------+-------+</span><br><span class="line">| Variable_name                        | Value |</span><br><span class="line">+--------------------------------------+-------+</span><br><span class="line">| validate_password_check_user_name    | OFF   |</span><br><span class="line">| validate_password_dictionary_file    |       |</span><br><span class="line">| validate_password_length             | 4     |</span><br><span class="line">| validate_password_mixed_case_count   | 1     |</span><br><span class="line">| validate_password_number_count       | 1     |</span><br><span class="line">| validate_password_policy             | LOW   |</span><br><span class="line">| validate_password_special_char_count | 1     |</span><br><span class="line">+--------------------------------------+-------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="mysqlå¸¸ç”¨å‘½ä»¤"><a href="#mysqlå¸¸ç”¨å‘½ä»¤" class="headerlink" title="mysqlå¸¸ç”¨å‘½ä»¤"></a>mysqlå¸¸ç”¨å‘½ä»¤</h3><h4 id="åˆ›å»ºæ•°æ®åº“"><a href="#åˆ›å»ºæ•°æ®åº“" class="headerlink" title="åˆ›å»ºæ•°æ®åº“"></a>åˆ›å»ºæ•°æ®åº“</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; create database &lt;æ•°æ®åº“å&gt; default character set &lt;ç¼–ç æ ¼å¼&gt; collate &lt;æ ¡éªŒé›†&gt;;</span><br></pre></td></tr></table></figure><h4 id="æ˜¾ç¤ºæ‰€æœ‰æ•°æ®åº“"><a href="#æ˜¾ç¤ºæ‰€æœ‰æ•°æ®åº“" class="headerlink" title="æ˜¾ç¤ºæ‰€æœ‰æ•°æ®åº“"></a>æ˜¾ç¤ºæ‰€æœ‰æ•°æ®åº“</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; show databases;</span><br></pre></td></tr></table></figure><h4 id="åˆ é™¤æ•°æ®åº“"><a href="#åˆ é™¤æ•°æ®åº“" class="headerlink" title="åˆ é™¤æ•°æ®åº“"></a>åˆ é™¤æ•°æ®åº“</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; drop database &lt;æ•°æ®åº“å&gt;;</span><br></pre></td></tr></table></figure><h4 id="é€‰æ‹©æ•°æ®åº“"><a href="#é€‰æ‹©æ•°æ®åº“" class="headerlink" title="é€‰æ‹©æ•°æ®åº“"></a>é€‰æ‹©æ•°æ®åº“</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; use &lt;æ•°æ®åº“å&gt;;</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºè¡¨"><a href="#åˆ›å»ºè¡¨" class="headerlink" title="åˆ›å»ºè¡¨"></a>åˆ›å»ºè¡¨</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; create table &lt;è¡¨å&gt; (&lt;å­—æ®µå1&gt; &lt;ç±»å‹1&gt; [,..&lt;å­—æ®µån&gt; &lt;ç±»å‹n&gt;]);</span><br></pre></td></tr></table></figure><h4 id="æ˜¾ç¤ºè¡¨"><a href="#æ˜¾ç¤ºè¡¨" class="headerlink" title="æ˜¾ç¤ºè¡¨"></a>æ˜¾ç¤ºè¡¨</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; show tables;</span><br></pre></td></tr></table></figure><h4 id="æ˜¾ç¤ºè¡¨ç»“æ„"><a href="#æ˜¾ç¤ºè¡¨ç»“æ„" class="headerlink" title="æ˜¾ç¤ºè¡¨ç»“æ„"></a>æ˜¾ç¤ºè¡¨ç»“æ„</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; desc &lt;è¡¨å&gt;ï¼›æˆ–è€…show columns from è¡¨å;</span><br></pre></td></tr></table></figure><h4 id="åˆ é™¤è¡¨"><a href="#åˆ é™¤è¡¨" class="headerlink" title="åˆ é™¤è¡¨"></a>åˆ é™¤è¡¨</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; drop table &lt;è¡¨å&gt;ï¼›</span><br></pre></td></tr></table></figure><h4 id="æ’å…¥è¡¨æ•°æ®"><a href="#æ’å…¥è¡¨æ•°æ®" class="headerlink" title="æ’å…¥è¡¨æ•°æ®"></a>æ’å…¥è¡¨æ•°æ®</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; insert into &lt;è¡¨å&gt; [( &lt;å­—æ®µå1&gt;[,..&lt;å­—æ®µån &gt; ])] values ( å€¼1 )[, ( å€¼n )]</span><br></pre></td></tr></table></figure><h4 id="æŸ¥è¯¢è¡¨æ•°æ®"><a href="#æŸ¥è¯¢è¡¨æ•°æ®" class="headerlink" title="æŸ¥è¯¢è¡¨æ•°æ®"></a>æŸ¥è¯¢è¡¨æ•°æ®</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select &lt;ç›®æ ‡åˆ—è¡¨è¡¨è¾¾å¼åˆ—è¡¨&gt; </span><br><span class="line"> from &lt; è¡¨åæˆ–è§†å›¾å &gt; </span><br><span class="line"> where &lt; æ¡ä»¶ &gt; </span><br><span class="line"> group by &lt;åˆ†ç»„è¡¨è¾¾å¼&gt;</span><br><span class="line"> having &lt;æ¡ä»¶&gt;</span><br><span class="line"> order by &lt;æ’åºè¡¨è¾¾å¼&gt;[ASC|DESC]</span><br></pre></td></tr></table></figure><h4 id="åˆ é™¤è¡¨æ•°æ®"><a href="#åˆ é™¤è¡¨æ•°æ®" class="headerlink" title="åˆ é™¤è¡¨æ•°æ®"></a>åˆ é™¤è¡¨æ•°æ®</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; delete from è¡¨å where è¡¨è¾¾å¼;</span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹è¡¨æ•°æ®"><a href="#ä¿®æ”¹è¡¨æ•°æ®" class="headerlink" title="ä¿®æ”¹è¡¨æ•°æ®"></a>ä¿®æ”¹è¡¨æ•°æ®</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; update è¡¨å set å­—æ®µ=æ–°å€¼,â€¦ where æ¡ä»¶;</span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹è¡¨å"><a href="#ä¿®æ”¹è¡¨å" class="headerlink" title="ä¿®æ”¹è¡¨å"></a>ä¿®æ”¹è¡¨å</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; rename table åŸè¡¨å to æ–°è¡¨å;</span><br></pre></td></tr></table></figure><h4 id="å¢åŠ è¡¨å­—æ®µ"><a href="#å¢åŠ è¡¨å­—æ®µ" class="headerlink" title="å¢åŠ è¡¨å­—æ®µ"></a>å¢åŠ è¡¨å­—æ®µ</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; alter table è¡¨å add å­—æ®µ ç±»å‹ å…¶ä»–;</span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹å­—æ®µç±»å‹"><a href="#ä¿®æ”¹å­—æ®µç±»å‹" class="headerlink" title="ä¿®æ”¹å­—æ®µç±»å‹"></a>ä¿®æ”¹å­—æ®µç±»å‹</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; alter table è¡¨å modify å­—æ®µ æ—§ç±»å‹ æ–°ç±»å‹;</span><br></pre></td></tr></table></figure><h4 id="åˆ é™¤å­—æ®µ"><a href="#åˆ é™¤å­—æ®µ" class="headerlink" title="åˆ é™¤å­—æ®µ"></a>åˆ é™¤å­—æ®µ</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; alter table è¡¨å drop å­—æ®µ;</span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹å­—æ®µçš„æ³¨é‡Š"><a href="#ä¿®æ”¹å­—æ®µçš„æ³¨é‡Š" class="headerlink" title="ä¿®æ”¹å­—æ®µçš„æ³¨é‡Š"></a>ä¿®æ”¹å­—æ®µçš„æ³¨é‡Š</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; alter table `è¡¨å` modify column `id` comment &apos;å­¦å·&apos;;</span><br></pre></td></tr></table></figure><h4 id="åŠ ç´¢å¼•"><a href="#åŠ ç´¢å¼•" class="headerlink" title="åŠ ç´¢å¼•"></a>åŠ ç´¢å¼•</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; alter table è¡¨å add index ç´¢å¼•å (å­—æ®µå1[ï¼Œå­—æ®µå2 â€¦]);</span><br></pre></td></tr></table></figure><h4 id="åŠ ä¸»å…³é”®å­—çš„ç´¢å¼•"><a href="#åŠ ä¸»å…³é”®å­—çš„ç´¢å¼•" class="headerlink" title="åŠ ä¸»å…³é”®å­—çš„ç´¢å¼•"></a>åŠ ä¸»å…³é”®å­—çš„ç´¢å¼•</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; alter table è¡¨å add primary key (å­—æ®µå);</span><br></pre></td></tr></table></figure><h4 id="åŠ å”¯ä¸€é™åˆ¶æ¡ä»¶çš„ç´¢å¼•"><a href="#åŠ å”¯ä¸€é™åˆ¶æ¡ä»¶çš„ç´¢å¼•" class="headerlink" title="åŠ å”¯ä¸€é™åˆ¶æ¡ä»¶çš„ç´¢å¼•"></a>åŠ å”¯ä¸€é™åˆ¶æ¡ä»¶çš„ç´¢å¼•</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; alter table è¡¨å add unique ç´¢å¼•å (å­—æ®µå);</span><br></pre></td></tr></table></figure><h4 id="åˆ é™¤ç´¢å¼•"><a href="#åˆ é™¤ç´¢å¼•" class="headerlink" title="åˆ é™¤ç´¢å¼•"></a>åˆ é™¤ç´¢å¼•</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; alter table è¡¨å drop index ç´¢å¼•å;</span><br></pre></td></tr></table></figure><h4 id="å¤‡ä»½æ•°æ®åº“"><a href="#å¤‡ä»½æ•°æ®åº“" class="headerlink" title="å¤‡ä»½æ•°æ®åº“"></a>å¤‡ä»½æ•°æ®åº“</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#mysqldump åœ¨windowsä¸‹è¿›è¡Œå¤‡ä»½éœ€è¦cmdçš„ç®¡ç†å‘˜èº«ä»½</span><br><span class="line">mysqldump -hä¸»æœºå(ip) -Pç«¯å£ -u ç”¨æˆ·å -på¯†ç  æ•°æ®åº“å1 æ•°æ®åº“å2 &gt; æ–‡ä»¶å.sql</span><br></pre></td></tr></table></figure><h4 id="å¤‡ä»½æ•°æ®åº“çš„æŸå¼ è¡¨"><a href="#å¤‡ä»½æ•°æ®åº“çš„æŸå¼ è¡¨" class="headerlink" title="å¤‡ä»½æ•°æ®åº“çš„æŸå¼ è¡¨"></a>å¤‡ä»½æ•°æ®åº“çš„æŸå¼ è¡¨</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysqldump -hä¸»æœºå(ip) -u ç”¨æˆ·å -p æ•°æ®åº“å è¡¨1 è¡¨2 è¡¨3 &gt; æ–‡ä»¶å.sql</span><br></pre></td></tr></table></figure><h4 id="å¤‡ä»½æ‰€æœ‰æ•°æ®åº“"><a href="#å¤‡ä»½æ‰€æœ‰æ•°æ®åº“" class="headerlink" title="å¤‡ä»½æ‰€æœ‰æ•°æ®åº“"></a>å¤‡ä»½æ‰€æœ‰æ•°æ®åº“</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysqldump -uroot -p --all-databases &gt; æ–‡ä»¶å.sql</span><br></pre></td></tr></table></figure><h4 id="è¿˜åŸæ•°æ®åº“"><a href="#è¿˜åŸæ•°æ®åº“" class="headerlink" title="è¿˜åŸæ•°æ®åº“"></a>è¿˜åŸæ•°æ®åº“</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysqldump -uroot -p æ•°æ®åº“å &lt; æ–‡ä»¶å.sql</span><br></pre></td></tr></table></figure><h4 id="åˆ é™¤æ•°æ®åº“-1"><a href="#åˆ é™¤æ•°æ®åº“-1" class="headerlink" title="åˆ é™¤æ•°æ®åº“"></a>åˆ é™¤æ•°æ®åº“</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; drop database æ•°æ®åº“å</span><br></pre></td></tr></table></figure><h4 id="æ¢å¤æ•°æ®åº“"><a href="#æ¢å¤æ•°æ®åº“" class="headerlink" title="æ¢å¤æ•°æ®åº“"></a>æ¢å¤æ•°æ®åº“</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#å…ˆåˆ›å»ºåŒåæ•°æ®åº“</span><br><span class="line">CREATE DATABASE æ•°æ®åº“å;</span><br><span class="line">use æ•°æ®åº“å;</span><br><span class="line">source å¤‡ä»½æ–‡ä»¶çš„è·¯å¾„ æ–‡ä»¶å.sql</span><br></pre></td></tr></table></figure><h3 id="mysqlå¼€å¯binlog"><a href="#mysqlå¼€å¯binlog" class="headerlink" title="mysqlå¼€å¯binlog"></a>mysqlå¼€å¯binlog</h3><h4 id="æŸ¥çœ‹binlogæ—¥å¿—çš„çŠ¶æ€"><a href="#æŸ¥çœ‹binlogæ—¥å¿—çš„çŠ¶æ€" class="headerlink" title="æŸ¥çœ‹binlogæ—¥å¿—çš„çŠ¶æ€"></a>æŸ¥çœ‹binlogæ—¥å¿—çš„çŠ¶æ€</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like &apos;%log_bin%&apos;;</span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">| Variable_name                   | Value |</span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">| log_bin                         | OFF   |</span><br><span class="line">| log_bin_basename                |       |</span><br><span class="line">| log_bin_index                   |       |</span><br><span class="line">| log_bin_trust_function_creators | OFF   |</span><br><span class="line">| log_bin_use_v1_row_events       | OFF   |</span><br><span class="line">| sql_log_bin                     | ON    |</span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line">å¾—çŸ¥ log_binä¸ºOFF</span><br></pre></td></tr></table></figure><p>é€€å‡ºmysql,ä¿®æ”¹my.cnf</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server-id=1</span><br><span class="line">log-bin=/var/lib/mysql/mysql-bin</span><br><span class="line"># server-idè¡¨ç¤ºå•ä¸ªç»“ç‚¹çš„idï¼Œè¿™é‡Œç”±äºåªæœ‰ä¸€ä¸ªç»“ç‚¹ï¼Œæ‰€ä»¥å¯ä»¥æŠŠidéšæœºæŒ‡å®šä¸ºä¸€ä¸ªæ•°ï¼Œè¿™é‡Œå°†idè®¾ç½®æˆ1ã€‚è‹¥é›†ç¾¤ä¸­æœ‰ä¸ªç»“ç‚¹ï¼Œåˆ™idä¸èƒ½ç›¸åŒ</span><br><span class="line"># ç¬¬äºŒå¥æ˜¯æŒ‡å®šbinlogæ—¥å¿—æ–‡ä»¶çš„åå­—ä¸ºmysql-binï¼Œä»¥åŠå…¶å­˜å‚¨è·¯å¾„</span><br></pre></td></tr></table></figure><h4 id="é‡å¯myql"><a href="#é‡å¯myql" class="headerlink" title="é‡å¯myql"></a>é‡å¯myql</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure><p>è¿›å…¥mysql,æŸ¥çœ‹binlogæ—¥å¿—çš„çŠ¶æ€</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt;  show variables like &apos;%log_bin%&apos;;</span><br><span class="line">+---------------------------------+--------------------------------+</span><br><span class="line">| Variable_name                   | Value                          |</span><br><span class="line">+---------------------------------+--------------------------------+</span><br><span class="line">| log_bin                         | ON                             |</span><br><span class="line">| log_bin_basename                | /var/lib/mysql/mysql-bin       |</span><br><span class="line">| log_bin_index                   | /var/lib/mysql/mysql-bin.index |</span><br><span class="line">| log_bin_trust_function_creators | OFF                            |</span><br><span class="line">| log_bin_use_v1_row_events       | OFF                            |</span><br><span class="line">| sql_log_bin                     | ON                             |</span><br><span class="line">+---------------------------------+--------------------------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="MySQLæ•°æ®åº“-Too-many-connections"><a href="#MySQLæ•°æ®åº“-Too-many-connections" class="headerlink" title="MySQLæ•°æ®åº“ Too many connections"></a>MySQLæ•°æ®åº“ Too many connections</h3><p>ä»å®˜æ–¹æ–‡æ¡£çŸ¥é“Linuxä¸Šé¢ç¼–è¯‘å®‰è£…çš„mysqlé»˜è®¤çš„è¿æ¥ä¸º100ä¸ª</p><p>æ–‡æ¡£ï¼š<a href="http://dev.mysql.com/doc/refman/5.0/en/too-many-connections.html" target="_blank" rel="noopener">http://dev.mysql.com/doc/refman/5.0/en/too-many-connections.html</a></p><p>mysqlå®˜æ–¹å‘Šè¯‰æˆ‘ä»¬éœ€è¦ä¿®æ”¹max_connectionsçš„å€¼,é‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆå»ä¿®æ”¹å‘¢ï¼Ÿæœ‰ä¸¤ç§æ–¹æ³•</p><p><strong>1ã€ä¿®æ”¹é…ç½®æ–‡ä»¶æ–‡ä»¶</strong></p><p>ä¿®æ”¹/etc/my.cnfè¿™ä¸ªæ–‡ä»¶ï¼Œåœ¨[mysqld] ä¸­æ–°å¢max_connections=Nï¼Œå¦‚æœä½ æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶è¯·ä»ç¼–è¯‘æºç ä¸­çš„support-filesæ–‡ä»¶å¤¹ä¸­å¤åˆ¶ä½ æ‰€éœ€è¦çš„*.cnfæ–‡ä»¶ä¸ºåˆ° /etc/my.cnfã€‚æˆ‘ä½¿ç”¨çš„æ˜¯my-medium.cnf,ä¸­å‹æœåŠ¡å™¨é…ç½®ã€‚ä¾‹å¦‚æˆ‘çš„[mysqld]çš„å†…å®¹å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[mysqld]` `port = 3306` `socket = ``/tmp/mysql``.sock` `skip-locking` `key_buffer = 160M` `max_allowed_packet = 1M` `table_cache = 64` `sort_buffer_size = 512K` `net_buffer_length = 8K` `read_buffer_size = 256K` `read_rnd_buffer_size = 512K` `myisam_sort_buffer_size = 8M` `max_connections=1000</span><br></pre></td></tr></table></figure><p>ç”±äºå¯¹mysqlè¿˜ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œæ‰€ä»¥å¾ˆå¤šå‚æ•°æ²¡æœ‰ä¿®æ”¹ã€‚å“ˆå“ˆã€‚ã€‚</p><p><strong>2ã€éä½¿ç”¨mysqldè„šæœ¬è‡ªåŠ¨å¯åŠ¨çš„ç”¨æˆ·ã€‚</strong></p><p>ä¿®æ”¹MYSQLHOME/bin/mysqldsafeæ–‡ä»¶ä¾‹å¦‚ï¼š/usr/local/mysql/bin/mysqldsafeè¿™ä¸ªæ–‡ä»¶grepâˆ’nâ€˜maxconnectionâ€²</p><p>MYSQLHOME/bin/mysqldsafeæ–‡ä»¶ä¾‹å¦‚ï¼š/usr/local/mysql/bin/mysqldsafeè¿™ä¸ªæ–‡ä»¶grepâˆ’nâ€˜maxconnectionâ€²MYSQL_HOME/bin/mysqld_safe</p><p>ä¿®æ”¹å¯¹åº”è¡Œå·çš„max_connectionså‚æ•°å€¼</p><p><strong>3ã€æœåŠ¡å™¨ç™»å½•mysql ï¼š mysql -u root -p</strong></p><p>ç™¾åˆ†ä¹‹ä¹åè¿›ä¸å»ï¼Œè¿›ä¸å»çš„æ‰§è¡Œé‡å¯å‘½ä»¤ ï¼š/etc/init.d/mysql restartï¼ˆcentosç³»ç»Ÿï¼‰</p><p>æ­¤æ—¶é‡å¯mysqlå°±èƒ½è¿æ¥mysqläº†ï¼Œå¦‚æœè¿˜æœ‰æ—¶é—´ï¼Œå¯ä»¥ç»§ç»­ä¸‹ä¸€æ­¥ï¼Œæ²»ç—…è¦æ²»æœ¬</p><p>æ‰“å¼€é…ç½®æ–‡ä»¶ æ·»åŠ ä¸€ä¸‹é…ç½® vi /etc/my.cnf</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wait_timeout = 600` `interactive_timeout = 600</span><br></pre></td></tr></table></figure><p>å†æ¬¡é‡å¯mysqlå³å¯</p><p><strong>åŸç†è§£ç­”</strong></p><p>mysql é»˜è®¤100 è¿æ¥æ•°ï¼Œè¶…è¿‡åˆ™è¿ä¸ä¸Šï¼Œå®é™…å·¥ä½œçš„è¿æ¥æ•°è¿œè¿œæ²¡æœ‰100ï¼Œå¤§éƒ¨åˆ†åœ¨sleep</p><p>æ‰€ä»¥è¦ä¹ˆå¢å¤§è¿æ¥æ•°ï¼Œè¦ä¹ˆæ€æ‰æ— ç”¨è¿æ¥ï¼Œæ¨èåè€…ã€‚</p><p>ä½¿ç”¨Navicatå·¥å…·è¿æ¥&gt;æœåŠ¡å™¨ç›‘æ§&gt;æŸ¥çœ‹è¿›ç¨‹æ•°,æ€æ‰è¿›ç¨‹æ•°åˆ°100ä»¥å†…å³å¯</p><h3 id="Linuxä¸‹é…ç½®mysqlå…è®¸æŒ‡å®šIPè¿œç¨‹è®¿é—®"><a href="#Linuxä¸‹é…ç½®mysqlå…è®¸æŒ‡å®šIPè¿œç¨‹è®¿é—®" class="headerlink" title="Linuxä¸‹é…ç½®mysqlå…è®¸æŒ‡å®šIPè¿œç¨‹è®¿é—®"></a>Linuxä¸‹é…ç½®mysqlå…è®¸æŒ‡å®šIPè¿œç¨‹è®¿é—®</h3><h4 id="ç™»å½•æ•°æ®åº“"><a href="#ç™»å½•æ•°æ®åº“" class="headerlink" title="ç™»å½•æ•°æ®åº“"></a>ç™»å½•æ•°æ®åº“</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@dev-database ~]# mysql -uroot -p</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 10511</span><br><span class="line">Server version: 5.7.32 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br></pre></td></tr></table></figure><h4 id="æŸ¥çœ‹ç”¨æˆ·è¡¨"><a href="#æŸ¥çœ‹ç”¨æˆ·è¡¨" class="headerlink" title="æŸ¥çœ‹ç”¨æˆ·è¡¨"></a>æŸ¥çœ‹ç”¨æˆ·è¡¨</h4><p>è¿›å…¥mysqlæ•°æ®åº“,æŸ¥çœ‹ç”¨æˆ·è¡¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; use mysql;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql&gt;  select Host,User from user;</span><br><span class="line">+-----------+---------------+</span><br><span class="line">| Host      | User          |</span><br><span class="line">+-----------+---------------+</span><br><span class="line">| localhost | root          |</span><br><span class="line">| localhost | exporter      |</span><br><span class="line">| localhost | mysql.session |</span><br><span class="line">| localhost | mysql.sys     |</span><br><span class="line">| localhost | root          |</span><br><span class="line">+-----------+---------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="æ›´æ–°-æˆæƒç”¨æˆ·è¡¨"><a href="#æ›´æ–°-æˆæƒç”¨æˆ·è¡¨" class="headerlink" title="æ›´æ–°/æˆæƒç”¨æˆ·è¡¨"></a>æ›´æ–°/æˆæƒç”¨æˆ·è¡¨</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//æ›´æ–°ç”¨æˆ·è¡¨</span><br><span class="line">mysql&gt; update user  set Host = &apos;%&apos; where Host = &apos;localhost&apos; and user = &apos;root&apos;; </span><br><span class="line">æˆ–</span><br><span class="line">mysql&gt; UPDATE `user` SET `Host` = &apos;192.168.50.*&apos; where `Host` = &apos;localhost&apos; and user = &apos;root&apos;;</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">192.168.50.*æ˜¯å…è®¸è¿œç¨‹è®¿é—®çš„IPçš„å€¼,rootæ˜¯è´¦æˆ·å </span><br><span class="line">å³ï¼Œå…è®¸æ¥è‡ª10.42.*.*çš„è¿æ¥å¹¶ä½¿ç”¨rootè´¦æˆ·è¿›è¡Œè®¿é—®ã€‚ </span><br><span class="line">è€ŒIPè¿™é‡Œï¼Œå¯ä»¥ä½¿ç”¨%æ¥è¡¨ç¤ºæ‰€æœ‰IPã€‚</span><br><span class="line">ç¬¬äºŒè¡Œæ˜¯ä½¿è®¾ç½®ç«‹åˆ»ç”Ÿæ•ˆã€‚</span><br></pre></td></tr></table></figure><h4 id="mysql-åˆ›å»ºåªè¯»è´¦æˆ·"><a href="#mysql-åˆ›å»ºåªè¯»è´¦æˆ·" class="headerlink" title="mysql åˆ›å»ºåªè¯»è´¦æˆ·"></a>mysql åˆ›å»ºåªè¯»è´¦æˆ·</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1ã€åˆ›å»ºè´¦æˆ· å¹¶æˆæƒSELECTæŸ¥è¯¢æƒé™ã€‚ dbnameå¯ä½¿ç”¨*ä»£æ›¿æ‰€æœ‰æ•°æ®åº“</span><br><span class="line"></span><br><span class="line">&gt; GRANT SELECT ON dbname.* TO &apos;onlyread&apos;@&apos;%&apos; IDENTIFIED BY &quot;password&quot;;</span><br><span class="line"></span><br><span class="line">2.åˆ·æ–°mysqlæƒé™ï¼Œä½¿ç”¨æˆ·åˆ›å»ºã€æˆæƒç”Ÿæ•ˆã€‚</span><br><span class="line"></span><br><span class="line">&gt; FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure><h3 id="æ€§èƒ½æµ‹è¯•-â€”â€”-MySQL-åŸºå‡†æµ‹è¯•"><a href="#æ€§èƒ½æµ‹è¯•-â€”â€”-MySQL-åŸºå‡†æµ‹è¯•" class="headerlink" title="æ€§èƒ½æµ‹è¯• â€”â€” MySQL åŸºå‡†æµ‹è¯•"></a>æ€§èƒ½æµ‹è¯• â€”â€” MySQL åŸºå‡†æµ‹è¯•</h3><p>ä¸»è¦æ˜¯ 4 ä¸ªæŒ‡æ ‡ï¼š</p><ul><li>TPS ï¼šTransactions Per Second ï¼Œå³æ•°æ®åº“æ¯ç§’æ‰§è¡Œçš„äº‹åŠ¡æ•°ï¼Œä»¥ commit æˆåŠŸæ¬¡æ•°ä¸ºå‡†ã€‚</li><li>QPS ï¼šQueries Per Second ï¼Œå³æ•°æ®åº“æ¯ç§’æ‰§è¡Œçš„ SQL æ•°ï¼ˆå« insertã€selectã€updateã€delete ç­‰ï¼‰ã€‚</li><li>RT ï¼šResponse Time ï¼Œå“åº”æ—¶é—´ã€‚åŒ…æ‹¬å¹³å‡å“åº”æ—¶é—´ã€æœ€å°å“åº”æ—¶é—´ã€æœ€å¤§å“åº”æ—¶é—´ã€æ¯ä¸ªå“åº”æ—¶é—´çš„æŸ¥è¯¢å æ¯”ã€‚æ¯”è¾ƒéœ€è¦é‡ç‚¹å…³æ³¨çš„æ˜¯ï¼Œå‰ 95-99% çš„æœ€å¤§å“åº”æ—¶é—´ã€‚å› ä¸ºå®ƒå†³å®šäº†å¤§å¤šæ•°æƒ…å†µä¸‹çš„çŸ­æ¿ã€‚</li><li>Concurrency Threads ï¼šå¹¶å‘é‡ï¼Œæ¯ç§’å¯å¤„ç†çš„æŸ¥è¯¢è¯·æ±‚çš„æ•°é‡ã€‚</li></ul><h4 id="sysbench"><a href="#sysbench" class="headerlink" title="sysbench"></a>sysbench</h4><blockquote><p>sysbench æ˜¯ä¸€ä¸ªæ¨¡å—åŒ–çš„ã€è·¨å¹³å°ã€å¤šçº¿ç¨‹åŸºå‡†æµ‹è¯•å·¥å…·ï¼Œä¸»è¦ç”¨äºè¯„ä¼°æµ‹è¯•å„ç§ä¸åŒç³»ç»Ÿå‚æ•°ä¸‹çš„æ•°æ®åº“è´Ÿè½½æƒ…å†µã€‚å®ƒä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ç§æ–¹å¼çš„æµ‹è¯•ï¼š</p></blockquote><ul><li>CPU æ€§èƒ½</li><li>ç£ç›˜ IO æ€§èƒ½</li><li>è°ƒåº¦ç¨‹åºæ€§èƒ½</li><li>å†…å­˜åˆ†é…åŠä¼ è¾“é€Ÿåº¦</li><li>POSIX çº¿ç¨‹æ€§èƒ½</li><li>æ•°æ®åº“æ€§èƒ½(OLTP åŸºå‡†æµ‹è¯•)</li></ul><p>ç›®å‰ sysbench ä¸»è¦æ”¯æŒ MySQLã€PgSQLã€Oracle è¿™ 3 ç§æ•°æ®åº“ã€‚</p><h5 id="å®‰è£…å·¥å…·"><a href="#å®‰è£…å·¥å…·" class="headerlink" title="å®‰è£…å·¥å…·"></a>å®‰è£…å·¥å…·</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl -s https://packagecloud.io/install/repositories/akopytov/sysbench/script.rpm.sh | sudo bash</span><br><span class="line">sudo yum -y install sysbench</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ç‰ˆæœ¬å·</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sysbench --version</span><br><span class="line"></span><br><span class="line">sysbench 1.0.20</span><br></pre></td></tr></table></figure><h5 id="å‡†å¤‡æ•°æ®"><a href="#å‡†å¤‡æ•°æ®" class="headerlink" title="å‡†å¤‡æ•°æ®"></a>å‡†å¤‡æ•°æ®</h5><p>éœ€è¦å…ˆåˆ›å»ºæ•°æ®åº“sbtest</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /usr/share/sysbench/</span><br><span class="line">sysbench oltp_common.lua --time=300 --mysql-host=127.0.0.1 --mysql-port=3306 --mysql-user=root --mysql-password=nmk@0718 --mysql-db=sbtest --table-size=1000000 --tables=10 --threads=32 --events=999999999 prepare</span><br></pre></td></tr></table></figure><p><code>oltp_common.lua</code> ï¼šæ‰§è¡Œçš„æµ‹è¯•è„šæœ¬ã€‚ <code>/usr/share/sysbench/</code> ç›®å½•ä¸‹ï¼Œå¯çœ‹åˆ° sysbench è‡ªå¸¦çš„ lua æµ‹è¯•è„šæœ¬ã€‚</p><p><code>--time</code> ï¼šæœ€å¤§çš„æ€»æ‰§è¡Œæ—¶é—´ï¼Œä»¥ç§’ä¸ºå•ä½ï¼Œé»˜è®¤ä¸º 10 ç§’ã€‚</p><p><code>--events</code> ï¼šæœ€å¤§å…è®¸çš„äº‹ä»¶ä¸ªæ•°ï¼Œé»˜è®¤ä¸º 0 ä¸ªã€‚<br> åº”è¯¥å’Œ <code>--time</code> äº’ç›¸å½¢æˆæœ€å¤§çš„æ‰§è¡Œæ—¶é—´ä¸æ¬¡æ•°ã€‚</p><p><code>--mysql-host</code> ï¼šMySQL server host ã€‚</p><p><code>--mysql-port</code> ï¼šMySQL server port ã€‚</p><p><code>--mysql-user</code> ï¼šMySQL server è´¦å·ã€‚</p><p><code>--mysql-password</code> ï¼šMySQL server å¯†ç ã€‚</p><p><code>--mysql-db</code> ï¼šMySQL Server æ•°æ®åº“åã€‚</p><p><code>--table-size</code> ï¼šè¡¨è®°å½•æ¡æ•°ã€‚</p><p><code>--tables</code> ï¼šè¡¨åã€‚</p><p><code>--threads</code> ï¼šè¦ä½¿ç”¨çš„çº¿ç¨‹æ•°ï¼Œé»˜è®¤ 1 ä¸ªã€‚</p><p><code>--report-interval</code> ï¼šä»¥ç§’ä¸ºå•ä½å®šæœŸæŠ¥å‘Šå…·æœ‰æŒ‡å®šé—´éš”çš„ä¸­é—´ç»Ÿè®¡ä¿¡æ¯ï¼Œé»˜è®¤ä¸º 0 ï¼Œè¡¨ç¤ºç¦ç”¨ä¸­é—´æŠ¥å‘Šã€‚</p><p><code>prepare</code> ï¼šæ‰§è¡Œå‡†å¤‡æ•°æ®ã€‚</p><p>æ‰§è¡Œå‘½ä»¤åï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆæ•°æ®åº“çš„è¡¨ã€å’Œæ•°æ®ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sysbench oltp_common.lua --time=300 --mysql-host=127.0.0.1 --mysql-port=3306 --mysql-user=root --mysql-password=nmk@0718 --mysql-db=sbtest --table-size=1000000 --tables=10 --threads=32 --events=999999999 prepare</span><br><span class="line">sysbench 1.0.20 (using bundled LuaJIT 2.1.0-beta2)</span><br><span class="line"></span><br><span class="line">Initializing worker threads...</span><br><span class="line"></span><br><span class="line">Creating table 'sbtest10'...</span><br><span class="line">Creating table 'sbtest9'...</span><br><span class="line">Creating table 'sbtest1'...</span><br><span class="line">Creating table 'sbtest4'...</span><br><span class="line">Creating table 'sbtest7'...</span><br><span class="line">Creating table 'sbtest3'...</span><br><span class="line">Creating table 'sbtest8'...</span><br><span class="line">Creating table 'sbtest5'...</span><br><span class="line">Creating table 'sbtest6'...</span><br><span class="line">Creating table 'sbtest2'...</span><br><span class="line">Inserting 1000000 records into 'sbtest1'</span><br><span class="line">Inserting 1000000 records into 'sbtest4'</span><br><span class="line">Inserting 1000000 records into 'sbtest8'</span><br><span class="line">Inserting 1000000 records into 'sbtest10'</span><br><span class="line">Inserting 1000000 records into 'sbtest6'</span><br><span class="line">Inserting 1000000 records into 'sbtest9'</span><br><span class="line">Inserting 1000000 records into 'sbtest2'</span><br><span class="line">Inserting 1000000 records into 'sbtest3'</span><br><span class="line">Inserting 1000000 records into 'sbtest7'</span><br><span class="line">Inserting 1000000 records into 'sbtest5'</span><br><span class="line">Creating a secondary index on 'sbtest8'...</span><br><span class="line">Creating a secondary index on 'sbtest10'...</span><br><span class="line">Creating a secondary index on 'sbtest7'...</span><br><span class="line">Creating a secondary index on 'sbtest1'...</span><br><span class="line">Creating a secondary index on 'sbtest5'...</span><br><span class="line">Creating a secondary index on 'sbtest2'...</span><br><span class="line">Creating a secondary index on 'sbtest6'...</span><br><span class="line">Creating a secondary index on 'sbtest3'...</span><br><span class="line">Creating a secondary index on 'sbtest4'...</span><br><span class="line">Creating a secondary index on 'sbtest9'...</span><br></pre></td></tr></table></figure><h5 id="æ‰§è¡Œæµ‹è¯•"><a href="#æ‰§è¡Œæµ‹è¯•" class="headerlink" title="æ‰§è¡Œæµ‹è¯•"></a>æ‰§è¡Œæµ‹è¯•</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sysbench oltp_read_write.lua --time=300 --mysql-host=127.0.0.1 --mysql-port=3306 --mysql-user=root --mysql-password=nmk@0718 --mysql-db=sbtest --table-size=1000000 --tables=10 --threads=16 --events=999999999  --report-interval=10  run</span><br></pre></td></tr></table></figure><p><code>oltp_read_write.lua</code> ï¼šæ‰§è¡Œçš„æµ‹è¯•è„šæœ¬ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬åœ¨ <code>/usr/share/sysbench/</code> ä¸‹ï¼Œå¯»æ‰¾æˆ‘ä»¬æƒ³è¦æµ‹è¯•çš„åœºæ™¯ã€‚<br> <code>oltp_read_write.lua</code> ï¼Œè¡¨ç¤ºæ··åˆè¯»å†™ï¼Œåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œé»˜è®¤æ¯”ä¾‹æ˜¯ï¼š<code>select:update_key:update_non_key:delete:insert = 14:1:1:1:1</code> ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆï¼Œæˆ‘ä»¬æµ‹è¯•å‡ºæ¥çš„ TPS å’Œ QPS çš„æ¯”ä¾‹ï¼Œå¤§æ¦‚åœ¨ 1:18~20 å·¦å³ã€‚ç›¸å½“äºè¯´ï¼Œä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œæœ‰ 18 ä¸ªè¯»å†™æ“ä½œã€‚</p><p><code>run</code> ï¼šæ‰§è¡Œæµ‹è¯•ã€‚</p><p>æ‰§è¡Œåï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sysbench 1.0.20 (using bundled LuaJIT 2.1.0-beta2)</span><br><span class="line"></span><br><span class="line">Running the test with following options:</span><br><span class="line">Number of threads: 16</span><br><span class="line">Report intermediate results every 10 second(s)</span><br><span class="line">Initializing random number generator from current time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Initializing worker threads...</span><br><span class="line"></span><br><span class="line">Threads started!</span><br><span class="line"></span><br><span class="line">[ 10s ] thds: 16 tps: 84.35 qps: 1712.07 (r/w/o: 1199.55/342.21/170.31) lat (ms,95%): 493.24 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 20s ] thds: 16 tps: 81.80 qps: 1636.72 (r/w/o: 1147.52/325.60/163.60) lat (ms,95%): 484.44 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 30s ] thds: 16 tps: 67.11 qps: 1323.22 (r/w/o: 923.59/265.42/134.21) lat (ms,95%): 484.44 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 40s ] thds: 16 tps: 69.40 qps: 1390.70 (r/w/o: 974.00/277.90/138.80) lat (ms,95%): 484.44 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 50s ] thds: 16 tps: 64.80 qps: 1296.69 (r/w/o: 907.10/260.00/129.60) lat (ms,95%): 520.62 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 60s ] thds: 16 tps: 57.20 qps: 1162.30 (r/w/o: 815.80/232.10/114.40) lat (ms,95%): 467.30 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 70s ] thds: 16 tps: 67.50 qps: 1332.64 (r/w/o: 932.26/265.39/134.99) lat (ms,95%): 458.96 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 80s ] thds: 16 tps: 75.90 qps: 1531.58 (r/w/o: 1073.65/306.12/151.81) lat (ms,95%): 493.24 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 90s ] thds: 16 tps: 66.60 qps: 1314.38 (r/w/o: 917.29/263.90/133.20) lat (ms,95%): 511.33 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 100s ] thds: 16 tps: 66.70 qps: 1346.71 (r/w/o: 944.91/268.40/133.40) lat (ms,95%): 442.73 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 110s ] thds: 16 tps: 78.30 qps: 1555.41 (r/w/o: 1086.40/312.40/156.60) lat (ms,95%): 442.73 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 120s ] thds: 16 tps: 67.00 qps: 1335.70 (r/w/o: 934.50/267.20/134.00) lat (ms,95%): 484.44 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 130s ] thds: 16 tps: 79.90 qps: 1602.00 (r/w/o: 1121.60/320.60/159.80) lat (ms,95%): 442.73 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 140s ] thds: 16 tps: 74.50 qps: 1492.78 (r/w/o: 1046.49/297.30/149.00) lat (ms,95%): 493.24 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 150s ] thds: 16 tps: 66.40 qps: 1320.31 (r/w/o: 922.11/265.40/132.80) lat (ms,95%): 502.20 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 160s ] thds: 16 tps: 72.40 qps: 1448.70 (r/w/o: 1014.20/289.70/144.80) lat (ms,95%): 493.24 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 170s ] thds: 16 tps: 61.20 qps: 1228.50 (r/w/o: 860.80/245.30/122.40) lat (ms,95%): 539.71 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 180s ] thds: 16 tps: 71.10 qps: 1421.40 (r/w/o: 994.90/284.30/142.20) lat (ms,95%): 493.24 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 190s ] thds: 16 tps: 85.50 qps: 1728.80 (r/w/o: 1211.20/346.60/171.00) lat (ms,95%): 475.79 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 200s ] thds: 16 tps: 83.10 qps: 1642.10 (r/w/o: 1148.00/327.90/166.20) lat (ms,95%): 484.44 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 210s ] thds: 16 tps: 73.40 qps: 1481.79 (r/w/o: 1040.30/294.70/146.80) lat (ms,95%): 530.08 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 220s ] thds: 16 tps: 66.00 qps: 1302.51 (r/w/o: 908.31/262.20/132.00) lat (ms,95%): 484.44 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 230s ] thds: 16 tps: 78.00 qps: 1560.70 (r/w/o: 1092.70/312.00/156.00) lat (ms,95%): 442.73 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 240s ] thds: 16 tps: 80.20 qps: 1624.76 (r/w/o: 1139.97/324.39/160.40) lat (ms,95%): 493.24 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 250s ] thds: 16 tps: 85.50 qps: 1692.85 (r/w/o: 1183.14/338.71/171.01) lat (ms,95%): 502.20 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 260s ] thds: 16 tps: 81.50 qps: 1627.90 (r/w/o: 1139.10/325.80/163.00) lat (ms,95%): 511.33 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 270s ] thds: 16 tps: 79.00 qps: 1579.80 (r/w/o: 1105.20/316.60/158.00) lat (ms,95%): 502.20 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 280s ] thds: 16 tps: 83.38 qps: 1688.98 (r/w/o: 1185.67/336.54/166.77) lat (ms,95%): 475.79 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 290s ] thds: 16 tps: 71.51 qps: 1412.67 (r/w/o: 986.29/283.35/143.03) lat (ms,95%): 467.30 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 300s ] thds: 16 tps: 87.60 qps: 1759.34 (r/w/o: 1234.26/350.19/174.89) lat (ms,95%): 493.24 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">SQL statistics:</span><br><span class="line">    queries performed:</span><br><span class="line">        read:                            311990</span><br><span class="line">        write:                           89140</span><br><span class="line">        other:                           44570</span><br><span class="line">        total:                           445700</span><br><span class="line">    transactions:                        22285  (74.27 per sec.)</span><br><span class="line">    queries:                             445700 (1485.31 per sec.)</span><br><span class="line">    ignored errors:                      0      (0.00 per sec.)</span><br><span class="line">    reconnects:                          0      (0.00 per sec.)</span><br><span class="line"></span><br><span class="line">General statistics:</span><br><span class="line">    total time:                          300.0677s</span><br><span class="line">    total number of events:              22285</span><br><span class="line"></span><br><span class="line">Latency (ms):</span><br><span class="line">         min:                                    8.23</span><br><span class="line">         avg:                                  215.40</span><br><span class="line">         max:                                 1186.15</span><br><span class="line">         95th percentile:                      493.24</span><br><span class="line">         sum:                              4800079.56</span><br><span class="line"></span><br><span class="line">Threads fairness:</span><br><span class="line">    events (avg/stddev):           1392.8125/8.30</span><br><span class="line">    execution time (avg/stddev):   300.0050/0.01</span><br></pre></td></tr></table></figure><p>æœºæ¢°ç›˜16 çº¿ç¨‹ + æ¯ä¸ªè¡¨ 100w æ•°æ®ï¼š74TPS+1485QPS+215mså»¶è¿Ÿ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SQL statistics:</span><br><span class="line">    queries performed:</span><br><span class="line">        read:                            1076334</span><br><span class="line">        write:                           307524</span><br><span class="line">        other:                           153762</span><br><span class="line">        total:                           1537620</span><br><span class="line">    transactions:                        76881  (256.22 per sec.)</span><br><span class="line">    queries:                             1537620 (5124.31 per sec.)</span><br><span class="line">    ignored errors:                      0      (0.00 per sec.)</span><br><span class="line">    reconnects:                          0      (0.00 per sec.)</span><br><span class="line"></span><br><span class="line">General statistics:</span><br><span class="line">    total time:                          300.0601s</span><br><span class="line">    total number of events:              76881</span><br><span class="line"></span><br><span class="line">Latency (ms):</span><br><span class="line">         min:                                   12.82</span><br><span class="line">         avg:                                   62.43</span><br><span class="line">         max:                                  316.03</span><br><span class="line">         95th percentile:                      125.52</span><br><span class="line">         sum:                              4799650.04</span><br><span class="line"></span><br><span class="line">Threads fairness:</span><br><span class="line">    events (avg/stddev):           4805.0625/25.22</span><br><span class="line">    execution time (avg/stddev):   299.9781/0.01</span><br></pre></td></tr></table></figure><p>SSDç›˜16 çº¿ç¨‹ + æ¯ä¸ªè¡¨ 100w æ•°æ®ï¼š256TPS+5124QPS+62mså»¶è¿Ÿ</p><h5 id="æ¸…ç†æ•°æ®"><a href="#æ¸…ç†æ•°æ®" class="headerlink" title="æ¸…ç†æ•°æ®"></a>æ¸…ç†æ•°æ®</h5><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">sysbench oltp_read_write.lua --time=<span class="number">300</span> --mysql-host=<span class="number">127.0</span>.<span class="number">0.1</span> --mysql-port=<span class="number">3306</span> --mysql-user=root --mysql-password=<span class="type">MyNewPass4!</span> --mysql-db=sbtest --table-size=<span class="number">1000000</span> --tables=<span class="number">10</span> --threads=<span class="number">16</span> --events=<span class="number">999999999</span>  --report-interval=<span class="number">10</span>  cleanup</span><br></pre></td></tr></table></figure><ul><li><code>cleanup</code> ï¼šæ‰§è¡Œæ¸…ç†æ•°æ®ã€‚</li></ul><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">root@iZuf6hci646px19gg3hpuwZ sysbench</span>]<span class="meta"># sysbench oltp_read_write.lua --time=300 --mysql-host=127.0.0.1 --mysql-port=3306 --mysql-user=root --mysql-password=MyNewPass4! --mysql-db=sbtest --table-size=1000000 --tables=10 --threads=16 --events=999999999 --rate=0 --histogram=on  --report-interval=10  runC^C</span></span><br><span class="line">[<span class="meta">root@iZuf6hci646px19gg3hpuwZ sysbench</span>]<span class="meta"># sysbench oltp_read_write.lua --time=300 --mysql-host=127.0.0.1 --mysql-port=3306 --mysql-user=root --mysql-password=MyNewPass4! --mysql-db=sbtest --table-size=1000000 --tables=10 --threads=16 --events=999999999  --report-interval=10  cleanup</span></span><br><span class="line">sysbench <span class="number">1.0</span><span class="number">.17</span> (<span class="keyword">using</span> system LuaJIT <span class="number">2.0</span><span class="number">.4</span>)</span><br><span class="line"></span><br><span class="line">Dropping table <span class="string">'sbtest1'</span>...</span><br><span class="line">Dropping table <span class="string">'sbtest2'</span>...</span><br><span class="line">Dropping table <span class="string">'sbtest3'</span>...</span><br><span class="line">Dropping table <span class="string">'sbtest4'</span>...</span><br><span class="line">Dropping table <span class="string">'sbtest5'</span>...</span><br><span class="line">Dropping table <span class="string">'sbtest6'</span>...</span><br><span class="line">Dropping table <span class="string">'sbtest7'</span>...</span><br><span class="line">Dropping table <span class="string">'sbtest8'</span>...</span><br><span class="line">Dropping table <span class="string">'sbtest9'</span>...</span><br><span class="line">Dropping table <span class="string">'sbtest10'</span>...</span><br></pre></td></tr></table></figure><h5 id="å…¶ä»–å‚æ•°"><a href="#å…¶ä»–å‚æ•°" class="headerlink" title="å…¶ä»–å‚æ•°"></a>å…¶ä»–å‚æ•°</h5><ul><li><code>--warmup_time</code> ï¼šé¢„çƒ­æ—¶é—´ï¼Œé¢„é˜²å†·æ•°æ®å¯¹æµ‹è¯•ç»“æœçš„å½±å“ã€‚</li><li>è¿™ä¸ªå‚æ•°åŠ ä¸‹ä¹Ÿæ˜¯æœ‰å¿…è¦çš„ï¼Œå› ä¸ºçº¿ä¸Šçš„æ•°æ®ï¼Œå®é™…æ˜¯ä¸€ç›´åœ¨è·‘çš„ï¼Œä¸ä¼šå¤„äºå†·æ•°æ®çš„çŠ¶æ€ã€‚</li><li><code>-rate</code> ï¼šæŒ‡å®šæ•°é‡å¤šå°‘äº‹ä»¶(äº‹åŠ¡)å¹³å‡æ¯ç§’é’Ÿåº”è¯¥æ‰§è¡Œçš„æ‰€æœ‰çº¿ç¨‹ã€‚0(é»˜è®¤)æ„å‘³ç€æ— é™çš„é€Ÿç‡ï¼Œå³äº‹ä»¶å°½å¿«æ‰§è¡Œã€‚</li><li>ä¸æ˜¯å¾ˆç†è§£è¿™ä¸ªå‚æ•°ï¼Œä¸è¿‡ç¡®å®å¢åŠ äº†è¿™ä¸ªå‚æ•°ï¼ŒQPS å’Œ TPS éƒ½æœ‰ä¸€å®šçš„æå‡ã€‚</li><li><code>-histogram</code> ï¼šè¾“å‡ºæµ‹è¯•è¿‡ç¨‹ä¸­ç³»ç»Ÿå“åº”æ—¶é—´çš„åˆ†å¸ƒã€‚</li><li>å¢åŠ è¯¥å‚æ•°ï¼Œæ‰§è¡Œç»“æœä¼šå¤šä¸€ä¸ªæŸ±çŠ¶å›¾ç»“æœã€‚</li><li><code>percentile</code> ï¼šåœ¨å»¶è¿Ÿç»Ÿè®¡æ•°æ®ä¸­è®¡ç®—çš„ç™¾åˆ†ç‚¹ (1-100)ï¼Œä½¿ç”¨ç‰¹æ®Šå€¼ 0 æ¥ç¦ç”¨ç™¾åˆ†æ¯”è®¡ç®—ï¼Œé»˜è®¤ä¸º 95 ã€‚</li></ul><h5 id="mysqlslap"><a href="#mysqlslap" class="headerlink" title="mysqlslap"></a>mysqlslap</h5><blockquote><p> mysqlslap æ˜¯ä¸€ä¸ª MySQL å®˜æ–¹æä¾›çš„å‹åŠ›æµ‹è¯•å·¥å…·ã€‚</p></blockquote><p>æ¯”è¾ƒå¤§çš„ä¼˜åŠ¿ï¼Œåœ¨äº mysqlslap æ˜¯ MySQL å®˜æ–¹æ‰€æä¾›ï¼Œå¹¶ä¸”æä¾›å¤šç§å¼•æ“çš„æ€§èƒ½æµ‹è¯•ã€‚</p><h5 id="æµ‹è¯•è¿‡ç¨‹"><a href="#æµ‹è¯•è¿‡ç¨‹" class="headerlink" title="æµ‹è¯•è¿‡ç¨‹"></a>æµ‹è¯•è¿‡ç¨‹</h5><p>ç›¸æ¯” sysbench æ¥è¯´ï¼Œmysqlslap çš„æµ‹è¯•è¿‡ç¨‹è¿˜æ˜¯æ¯”è¾ƒç®€æ´çš„ï¼Œä¸€ä¸ªå‘½ä»¤ï¼Œå³å¯å®Œæˆæ•´ä¸ªè¿‡ç¨‹ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">mysqlslap --concurrency=<span class="number">16</span>,<span class="number">32</span> --iterations=<span class="number">3</span> --number-<span class="keyword">int</span>-cols=<span class="number">1</span> --number-<span class="keyword">char</span>-cols=<span class="number">2</span> --<span class="keyword">auto</span>-generate-sql --<span class="keyword">auto</span>-generate-sql-add-autoincrement --engine=innodb --number-of-queries=<span class="number">10000</span> --create-schema=sbtest2 -uroot -pMyNewPass4!</span><br></pre></td></tr></table></figure><ul><li><code>--concurrency</code> ï¼šå¹¶å‘é‡ï¼Œä¹Ÿå°±æ˜¯æ¨¡æ‹Ÿå¤šå°‘ä¸ªå®¢æˆ·ç«¯åŒæ—¶æ‰§è¡Œå‘½ä»¤ã€‚å¯æŒ‡å®šå¤šä¸ªå€¼ï¼Œä»¥é€—å·æˆ–è€… <code>â€“delimiter</code> å‚æ•°æŒ‡å®šçš„å€¼åšä¸ºåˆ†éš”ç¬¦</li><li><code>--iterations</code> ï¼šæµ‹è¯•æ‰§è¡Œçš„è¿­ä»£æ¬¡æ•°ã€‚</li><li><code>--number-int-cols</code> ï¼šè‡ªåŠ¨ç”Ÿæˆçš„æµ‹è¯•è¡¨ä¸­åŒ…å«å¤šå°‘ä¸ªæ•°å­—ç±»å‹çš„åˆ—ï¼Œé»˜è®¤ 1 ã€‚æ­¤å¤„è®¾ç½®ä¸º 1 çš„åŸå› æ˜¯ï¼Œå› ä¸ºæˆ‘ä»¬ä¸Šé¢ sysbench æˆ‘ä»¬ç”Ÿæˆäº†ä¸€ä¸ª int ç±»å‹çš„å­—æ®µã€‚</li><li><code>--number-char-cols</code> ï¼šè‡ªåŠ¨ç”Ÿæˆçš„æµ‹è¯•è¡¨ä¸­åŒ…å«å¤šå°‘ä¸ªå­—ç¬¦ç±»å‹çš„åˆ—ï¼Œé»˜è®¤ 1 ã€‚æ­¤å¤„è®¾ç½®ä¸º 2 çš„åŸå› æ˜¯ï¼Œå› ä¸ºæˆ‘ä»¬ä¸Šé¢ sysbench æˆ‘ä»¬ç”Ÿæˆäº†ä¸€ä¸ª char ç±»å‹çš„å­—æ®µã€‚</li><li><code>--auto-generate-sql</code> ï¼šè‡ªåŠ¨ç”Ÿæˆæµ‹è¯•è¡¨å’Œæ•°æ®ã€‚è¿™ä¸ªå‘½ä»¤ï¼Œå¸¦æ¥çš„æ•ˆæœï¼Œå°±ç±»ä¼¼ sysbench å‘½ä»¤çš„ prepare æŒ‡ä»¤ã€‚</li><li><code>--auto-generate-sql-add-autoincrement</code> ï¼šå¢åŠ  auto_increment ä¸€åˆ—ã€‚</li><li>å¦‚æœæƒ³çœ‹ï¼Œç”Ÿæˆçš„å…·ä½“è„šæœ¬ï¼Œå¯ä»¥ç”¨ <code>â€“only-print</code> æŒ‡ä»¤ï¼Œåªæ‰“å°æµ‹è¯•è¯­å¥è€Œä¸å®é™…æ‰§è¡Œã€‚</li><li><code>--engine</code> ï¼šåˆ›å»ºæµ‹è¯•è¡¨æ‰€ä½¿ç”¨çš„å­˜å‚¨å¼•æ“ï¼Œå¯æŒ‡å®šå¤šä¸ªã€‚</li><li><code>--number-of-queries</code> ï¼šæ€»çš„æµ‹è¯•æŸ¥è¯¢æ¬¡æ•°(å¹¶å‘å®¢æˆ·æ•°Ã—æ¯å®¢æˆ·æŸ¥è¯¢æ¬¡æ•°)ã€‚</li><li><code>--create-schema</code> ï¼šæµ‹è¯•çš„ schema ï¼ŒMySQLä¸­ schema ä¹Ÿå°±æ˜¯ database æ•°æ®åº“åã€‚</li><li><code>-uroot -pMyNewPass4!</code> ï¼šè®¾ç½® MySQL è´¦å·å’Œå¯†ç ã€‚</li></ul><p>æ‰§è¡Œå‘½ä»¤åï¼Œæ•ˆæœå¦‚ä¸‹å›¾ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@iZuf6hci646px19gg3hpuwZ sysbench]# mysqlslap --concurrency=16,32 --iterations=3 --number-int-cols=1 --number-char-cols=2 --auto-generate-sql --auto-generate-sql-add-autoincrement --engine=innodb --number-of-queries=10000 --create-schema=sbtest2 -uroot -pMyNewPass4!</span><br><span class="line">mysqlslap: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Benchmark</span><br><span class="line">    Running for engine innodb</span><br><span class="line">    Average number of seconds to run all queries: 0.489 seconds</span><br><span class="line">    Minimum number of seconds to run all queries: 0.486 seconds</span><br><span class="line">    Maximum number of seconds to run all queries: 0.496 seconds</span><br><span class="line">    Number of clients running queries: 16</span><br><span class="line">    Average number of queries per client: 625</span><br><span class="line"></span><br><span class="line">Benchmark</span><br><span class="line">    Running for engine innodb</span><br><span class="line">    Average number of seconds to run all queries: 0.379 seconds</span><br><span class="line">    Minimum number of seconds to run all queries: 0.377 seconds</span><br><span class="line">    Maximum number of seconds to run all queries: 0.382 seconds</span><br><span class="line">    Number of clients running queries: 32</span><br><span class="line">    Average number of queries per client: 312</span><br></pre></td></tr></table></figure><ul><li>ç¬¬ä¸€ä¸ªï¼Œä½¿ç”¨ 16 ä¸ªçº¿ç¨‹ï¼ˆå®¢æˆ·ç«¯ï¼‰ï¼Œå¹³å‡å»¶è¿Ÿåœ¨ 0.489 ç§’ã€‚</li><li>ç¬¬äºŒä¸ªï¼Œä½¿ç”¨ 32 ä¸ªçº¿ç¨‹ï¼ˆå®¢æˆ·ç«¯ï¼‰ï¼Œå¹³å‡å»¶è¿Ÿåœ¨ 0.379 ç§’ã€‚</li></ul><p>å‚è€ƒæ–‡æ¡£<br><a href="https://www.jianshu.com/p/d464e51aa026" target="_blank" rel="noopener">https://www.jianshu.com/p/d464e51aa026</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;å®‰è£…mysql&quot;&gt;&lt;a href=&quot;#å®‰è£…mysql&quot; class=&quot;headerlink&quot; title=&quot;å®‰è£…mysql&quot;&gt;&lt;/a&gt;å®‰è£…mysql&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=</summary>
      
    
    
    
    
    <category term="database" scheme="https://nmk0718.github.io/tag/database/"/>
    
    <category term="mysql" scheme="https://nmk0718.github.io/tag/mysql/"/>
    
  </entry>
  
  <entry>
    <title>redis</title>
    <link href="https://nmk0718.github.io/2020/04/08/Tomcat%E5%AE%9E%E7%8E%B0redis%E5%85%B1%E4%BA%AB/"/>
    <id>https://nmk0718.github.io/2020/04/08/Tomcat%E5%AE%9E%E7%8E%B0redis%E5%85%B1%E4%BA%AB/</id>
    <published>2020-04-08T14:30:00.000Z</published>
    <updated>2025-01-05T15:43:07.572Z</updated>
    
    <content type="html"><![CDATA[<p>å®˜ç½‘åœ°å€:<a href="https://redis.io/" target="_blank" rel="noopener">https://redis.io/</a></p><p>ä¸‹è½½</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget http://download.redis.io/releases/redis-5.0.8.tar.gz</span><br></pre></td></tr></table></figure><p>è§£å‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tar zxvf redis-5.0.8.tar.gz</span><br></pre></td></tr></table></figure><p>å®‰è£…</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd redis-5.0.8</span><br><span class="line">make (æ‰§è¡Œmakeï¼Œå‡ºç°é”™è¯¯æ—¶ï¼Œè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼‰</span><br><span class="line"></span><br><span class="line">yum install -y gcc g++ gcc-c++ make</span><br><span class="line">#å› ä¸ºRedisæ˜¯Cå®ç°çš„ï¼Œéœ€è¦gccæ¥è¿›è¡Œç¼–è¯‘ï¼Œæ‰€ä»¥åŸå› æ˜¯ç³»ç»Ÿæœªå®‰è£…gcc</span><br><span class="line">make MALLOC=libc</span><br><span class="line">#å†æ¬¡æ‰§è¡Œmakeï¼Œè‹¥makeå‡ºç°é”™è¯¯ä¸ºï¼šè‡´å‘½é”™è¯¯</span><br><span class="line"></span><br><span class="line">cd src</span><br><span class="line">./redis-server &amp; </span><br><span class="line">#å¯åŠ¨æœåŠ¡ &amp;ä¸ºåå°å¯åŠ¨</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹é…ç½®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd redis-5.0.8</span><br><span class="line">vi redis.conf</span><br><span class="line"></span><br><span class="line">port 9376</span><br><span class="line">#ä¿®æ”¹é»˜è®¤ç«¯å£6379ä¸º9376</span><br><span class="line"></span><br><span class="line">requirepass nmk0718</span><br><span class="line">#æ·»åŠ å¯†ç </span><br><span class="line"></span><br><span class="line">bind 127.0.0.1</span><br><span class="line">#å¦‚ç»‘å®šä¸º127.0.0åªèƒ½æœ¬åœ°èƒ½è¿æ¥,å¦‚æœé…ç½®ä¸ºå†…ç½‘ip,åˆ™å±€åŸŸç½‘éƒ½èƒ½è°ƒç”¨</span><br><span class="line"></span><br><span class="line">databases 10</span><br><span class="line">#è®¾ç½®æ•°æ®åº“ä¸ªæ•°ï¼Œé»˜è®¤ä½¿ç”¨çš„æ•°æ®åº“ä¸º0</span><br><span class="line"></span><br><span class="line">logfile &quot;/home/redis/redis.log&quot;</span><br><span class="line">#ç”¨äºé…ç½®logæ–‡ä»¶åœ°å€</span><br><span class="line"></span><br><span class="line">daemonize yes</span><br><span class="line">#ä¿®æ”¹daemonize noæ”¹ä¸ºdaemonize yes,è®©redisåå°è¿è¡Œ</span><br><span class="line"></span><br><span class="line">å¦‚ä¿®æ”¹redis.conf</span><br><span class="line">éœ€è¦ä½¿ç”¨è¿›å…¥redisç›®å½•ä½¿ç”¨./src/redis-server redis.confè¿›è¡ŒåŠ è½½é…ç½®</span><br></pre></td></tr></table></figure><p>å¼€æœºå¯åŠ¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi /etc/rc.local</span><br><span class="line">/root/redis-4.0.6/src/redis-server /root/redis-4.0.6/src/redis.conf</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹serverè¿›ç¨‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ps -ef |grep redis</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ redis-cli ï¼Œæµ‹è¯•æ˜¯å¦æˆåŠŸï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@nmk src]# ./redis-cli</span><br><span class="line">127.0.0.1:6379&gt; set name nmk</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">&quot;nmk&quot;</span><br></pre></td></tr></table></figure><h3 id="Tomcatå®ç°rediså…±äº«"><a href="#Tomcatå®ç°rediså…±äº«" class="headerlink" title="Tomcatå®ç°rediså…±äº«"></a>Tomcatå®ç°rediså…±äº«</h3><p>jedis.jar:<a href="https://repo1.maven.org/maven2/redis/clients/jedis/2.9.0/jedis-2.9.0.jar" target="_blank" rel="noopener">jedis.jar</a></p><p>commons-pool.jar:<a href="https://repo1.maven.org/maven2/org/apache/commons/commons-pool2/2.4.2/commons-pool2-2.4.2.jar" target="_blank" rel="noopener">commons-pool.jar</a></p><p>TomcatRedisSessionManager.jar:<a href="https://repo1.maven.org/maven2/com/bluejeans/tomcat-redis-session-manager/2.0.0/tomcat-redis-session-manager-2.0.0.jar" target="_blank" rel="noopener">TomcatRedisSessionManager.jar</a></p><p>æŠŠä¸‰ä¸ªæ–‡ä»¶æ”¾å…¥tomcatçš„libæ–‡ä»¶å¤¹ä¸‹</p><p>ä¿®æ”¹tomcat/conf/context.xml,åœ¨å‰åŠ å…¥ä»¥ä¸‹ä»£ç </p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#è¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹</span><br><span class="line">&lt;Valve className=&quot;com.orangefunction.tomcat.redissessions.RedisSessionHandlerValve&quot;/&gt;</span><br><span class="line">&lt;Manager className=&quot;com.orangefunction.tomcat.redissessions.RedisSessionManager&quot; </span><br><span class="line">        host=&quot;127.0.0.1&quot;       </span><br><span class="line">        port=&quot;6379&quot;                 </span><br><span class="line">        password=&quot;nmk@2020&quot;            </span><br><span class="line">        database=&quot;10&quot;                 </span><br><span class="line">        maxInactiveInterval=&quot;60&quot; /&gt;</span><br></pre></td></tr></table></figure><p>å³å¯å®ç°rediså…±äº«</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å®˜ç½‘åœ°å€:&lt;a href=&quot;https://redis.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ä¸‹è½½&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;tabl</summary>
      
    
    
    
    
    <category term="redis" scheme="https://nmk0718.github.io/tag/redis/"/>
    
  </entry>
  
  <entry>
    <title>easyimage</title>
    <link href="https://nmk0718.github.io/2020/04/02/easyimage/"/>
    <id>https://nmk0718.github.io/2020/04/02/easyimage/</id>
    <published>2020-04-02T06:00:00.000Z</published>
    <updated>2024-11-29T06:43:03.823Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç®€å•å›¾åºŠ"><a href="#ç®€å•å›¾åºŠ" class="headerlink" title="ç®€å•å›¾åºŠ"></a>ç®€å•å›¾åºŠ</h2><h3 id="å®‰è£…php"><a href="#å®‰è£…php" class="headerlink" title="å®‰è£…php"></a>å®‰è£…php</h3><p>å¸è½½phpæ—§ç‰ˆæœ¬</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum remove php*</span><br></pre></td></tr></table></figure><p>å®‰è£…æ‹“å±•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install php72w php72w-cli php72w-common php72w-devel php72w-embedded php72w-fpm php72w-gd php72w-mbstring php72w-mysqlnd php72w-opcache php72w-pdo php72w-xml php72w-ldap php72w-mcrypt</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹phpç‰ˆæœ¬</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php -v</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æ‹“å±•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php -m</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹phpçš„é…ç½®æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#æŸ¥çœ‹phpå®‰è£…ä½ç½®</span><br><span class="line">whereis php</span><br><span class="line">#ç¼–è¾‘phpé…ç½®æ–‡ä»¶</span><br><span class="line">vim etc/php.ini</span><br><span class="line">#ä¿®æ”¹upload_max_size: 50Må’Œpost_max_size: 50M</span><br></pre></td></tr></table></figure><p>ä¸‹è½½easyimage</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https://github.com/icret/EasyImages2.0/archive/master.zip</span><br></pre></td></tr></table></figure><p>è§£å‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">unzip master.zip</span><br></pre></td></tr></table></figure><p>æŠŠè§£å‹å‡ºæ¥æ–‡ä»¶å¤¹å†…çš„æ‰€æœ‰æ–‡ä»¶æ”¾åˆ°/var/www/htmlä¸‹</p><p>å®‰è£…Apache</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum -y install httpd httpd-devel</span><br></pre></td></tr></table></figure><p>å¯åŠ¨httpd</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl start httpd</span><br></pre></td></tr></table></figure><p>è®¿é—®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://ip:port/</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ç®€å•å›¾åºŠ&quot;&gt;&lt;a href=&quot;#ç®€å•å›¾åºŠ&quot; class=&quot;headerlink&quot; title=&quot;ç®€å•å›¾åºŠ&quot;&gt;&lt;/a&gt;ç®€å•å›¾åºŠ&lt;/h2&gt;&lt;h3 id=&quot;å®‰è£…php&quot;&gt;&lt;a href=&quot;#å®‰è£…php&quot; class=&quot;headerlink&quot; title=&quot;å®‰è£…php&quot;&gt;</summary>
      
    
    
    
    
    <category term="easyimage" scheme="https://nmk0718.github.io/tag/easyimage/"/>
    
  </entry>
  
  <entry>
    <title>Docker</title>
    <link href="https://nmk0718.github.io/2020/03/31/docker/"/>
    <id>https://nmk0718.github.io/2020/03/31/docker/</id>
    <published>2020-03-31T09:00:00.000Z</published>
    <updated>2024-11-29T06:43:00.553Z</updated>
    
    <content type="html"><![CDATA[<h4 id="å®‰è£…docker"><a href="#å®‰è£…docker" class="headerlink" title="å®‰è£…docker"></a>å®‰è£…docker</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum -y install docker</span><br></pre></td></tr></table></figure><h4 id="æŸ¥çœ‹dockerå®¹å™¨ç‰ˆæœ¬"><a href="#æŸ¥çœ‹dockerå®¹å™¨ç‰ˆæœ¬" class="headerlink" title="æŸ¥çœ‹dockerå®¹å™¨ç‰ˆæœ¬"></a>æŸ¥çœ‹dockerå®¹å™¨ç‰ˆæœ¬</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker version</span><br></pre></td></tr></table></figure><h4 id="æŸ¥çœ‹dockerå®¹å™¨ä¿¡æ¯"><a href="#æŸ¥çœ‹dockerå®¹å™¨ä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹dockerå®¹å™¨ä¿¡æ¯"></a>æŸ¥çœ‹dockerå®¹å™¨ä¿¡æ¯</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker info</span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹å­˜å‚¨è·¯å¾„"><a href="#ä¿®æ”¹å­˜å‚¨è·¯å¾„" class="headerlink" title="ä¿®æ”¹å­˜å‚¨è·¯å¾„"></a>ä¿®æ”¹å­˜å‚¨è·¯å¾„</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#Dockerçš„é•œåƒéœ€åœ¨å¤§é‡çš„å­˜å‚¨ç©ºé—´ï¼Œé»˜è®¤çš„å­˜å‚¨è·¯å¾„åœ¨ /var/lib/docker, å¯ä»¥æŒ‰å®é™…éœ€æ±‚ä¿®æ”¹å­˜å‚¨è·¯å¾„ã€‚</span><br><span class="line">#åœæ­¢docker</span><br><span class="line">service docker stop</span><br><span class="line">#åˆ›å»ºç›®å½•</span><br><span class="line">mkdir -p /data/docker</span><br><span class="line">#ç§»åŠ¨ç›®å½•åˆ°æ–°è·¯å¾„</span><br><span class="line">mv /var/lib/docker /data/docker</span><br><span class="line">#åšä¸ªè½¯é“¾æ¥</span><br><span class="line">ln -s /data/docker /var/lib/docker </span><br><span class="line">#å¯åŠ¨docker</span><br><span class="line">service docker start</span><br></pre></td></tr></table></figure><h4 id="ä¸‹è½½é•œåƒ"><a href="#ä¸‹è½½é•œåƒ" class="headerlink" title="ä¸‹è½½é•œåƒ"></a>ä¸‹è½½é•œåƒ</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker pull tomcat</span><br><span class="line">#ç›¸å½“äº docker pull centos:latest æœ€æ–°ç‰ˆæœ¬,å¯ä»¥æ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬</span><br></pre></td></tr></table></figure><h4 id="æŸ¥çœ‹å®¹å™¨çš„æ‰€æœ‰é•œåƒ"><a href="#æŸ¥çœ‹å®¹å™¨çš„æ‰€æœ‰é•œåƒ" class="headerlink" title="æŸ¥çœ‹å®¹å™¨çš„æ‰€æœ‰é•œåƒ"></a>æŸ¥çœ‹å®¹å™¨çš„æ‰€æœ‰é•œåƒ</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure><h4 id="æŸ¥çœ‹å®¹å™¨çš„è¿è¡ŒçŠ¶æ€"><a href="#æŸ¥çœ‹å®¹å™¨çš„è¿è¡ŒçŠ¶æ€" class="headerlink" title="æŸ¥çœ‹å®¹å™¨çš„è¿è¡ŒçŠ¶æ€"></a>æŸ¥çœ‹å®¹å™¨çš„è¿è¡ŒçŠ¶æ€</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker stats</span><br></pre></td></tr></table></figure><h4 id="æŸ¥çœ‹å®¹å™¨è¿è¡Œçš„é•œåƒ"><a href="#æŸ¥çœ‹å®¹å™¨è¿è¡Œçš„é•œåƒ" class="headerlink" title="æŸ¥çœ‹å®¹å™¨è¿è¡Œçš„é•œåƒ"></a>æŸ¥çœ‹å®¹å™¨è¿è¡Œçš„é•œåƒ</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker ps</span><br><span class="line">#å¯ä»¥ä½¿ç”¨grepè¿‡æ»¤é•œåƒ</span><br><span class="line">docker ps |grep tomcat</span><br></pre></td></tr></table></figure><h4 id="æŸ¥çœ‹å®¹å™¨å†å²è¿è¡Œè¿‡çš„é•œåƒ"><a href="#æŸ¥çœ‹å®¹å™¨å†å²è¿è¡Œè¿‡çš„é•œåƒ" class="headerlink" title="æŸ¥çœ‹å®¹å™¨å†å²è¿è¡Œè¿‡çš„é•œåƒ"></a>æŸ¥çœ‹å®¹å™¨å†å²è¿è¡Œè¿‡çš„é•œåƒ</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker ps -a</span><br></pre></td></tr></table></figure><h4 id="æ˜¾ç¤ºè¿è¡Œå®¹å™¨æ€»æ–‡ä»¶å¤§å°"><a href="#æ˜¾ç¤ºè¿è¡Œå®¹å™¨æ€»æ–‡ä»¶å¤§å°" class="headerlink" title="æ˜¾ç¤ºè¿è¡Œå®¹å™¨æ€»æ–‡ä»¶å¤§å°"></a>æ˜¾ç¤ºè¿è¡Œå®¹å™¨æ€»æ–‡ä»¶å¤§å°</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker ps -s</span><br></pre></td></tr></table></figure><h4 id="é•œåƒå¯åŠ¨"><a href="#é•œåƒå¯åŠ¨" class="headerlink" title="é•œåƒå¯åŠ¨"></a>é•œåƒå¯åŠ¨</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker run -d -p 8080:8080 -v /data:/data --name=mytomcat tomcat </span><br><span class="line">#-d: åå°è¿è¡Œå®¹å™¨ï¼Œå¹¶è¿”å›å®¹å™¨IDï¼›</span><br><span class="line">#-i: ä»¥äº¤äº’æ¨¡å¼è¿è¡Œå®¹å™¨ï¼Œé€šå¸¸ä¸ -t åŒæ—¶ä½¿ç”¨ï¼›</span><br><span class="line">#-t: ä¸ºå®¹å™¨é‡æ–°åˆ†é…ä¸€ä¸ªä¼ªè¾“å…¥ç»ˆç«¯ï¼Œé€šå¸¸ä¸ -i åŒæ—¶ä½¿ç”¨ï¼›</span><br><span class="line">#-pï¼šå‰è€…æ˜¯å¤–å›´è®¿é—®ç«¯å£ï¼šåè€…æ˜¯å®¹å™¨å†…éƒ¨ç«¯å£</span><br><span class="line">#--volume,-v: å®¿ä¸»æœºçš„ç›®å½•/dataæ˜ å°„åˆ°å®¹å™¨çš„/data</span><br><span class="line">#--name=&quot;nginx-lb&quot;: ä¸ºå®¹å™¨æŒ‡å®šä¸€ä¸ªåç§°ï¼›</span><br></pre></td></tr></table></figure><h4 id="è¿›å…¥å®¹å™¨"><a href="#è¿›å…¥å®¹å™¨" class="headerlink" title="è¿›å…¥å®¹å™¨"></a>è¿›å…¥å®¹å™¨</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker exec -it [CONTAINER ID] /bin/bash</span><br></pre></td></tr></table></figure><h4 id="åˆ é™¤é•œåƒ"><a href="#åˆ é™¤é•œåƒ" class="headerlink" title="åˆ é™¤é•œåƒ"></a>åˆ é™¤é•œåƒ</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker rmi [CONTAINER ID]</span><br><span class="line"></span><br><span class="line">å¦‚æœå‡ºç°åº”ç”¨å‡ºé”™ï¼šError response from daemon: conflict: unable to delete CONTAINER ID(cannot be forced) - image has dependent child images</span><br><span class="line">docker rmi REPOSITORY:TAG</span><br></pre></td></tr></table></figure><h4 id="åˆ é™¤è¿è¡Œå¤±è´¥çš„é•œåƒ"><a href="#åˆ é™¤è¿è¡Œå¤±è´¥çš„é•œåƒ" class="headerlink" title="åˆ é™¤è¿è¡Œå¤±è´¥çš„é•œåƒ"></a>åˆ é™¤è¿è¡Œå¤±è´¥çš„é•œåƒ</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker rm [CONTAINER ID]</span><br><span class="line">#åˆ é™¤è¿è¡Œä¸­çš„é•œåƒéœ€è¦å…ˆåœæ­¢è¯¥å®¹å™¨,ç„¶åä½¿ç”¨ä¸Šè¿°å‘½ä»¤ã€‚ä½¿ç”¨-få¯å¼ºåˆ¶åˆ é™¤</span><br></pre></td></tr></table></figure><h4 id="åˆ é™¤æ‰€æœ‰noneé•œåƒ"><a href="#åˆ é™¤æ‰€æœ‰noneé•œåƒ" class="headerlink" title="åˆ é™¤æ‰€æœ‰noneé•œåƒ"></a>åˆ é™¤æ‰€æœ‰noneé•œåƒ</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker rmi `docker images | grep  &quot;&lt;none&gt;&quot; | awk &apos;&#123;print $3&#125;&apos;`</span><br></pre></td></tr></table></figure><h4 id="åˆ é™¤ä¸æ˜¯latestçš„é•œåƒ"><a href="#åˆ é™¤ä¸æ˜¯latestçš„é•œåƒ" class="headerlink" title="åˆ é™¤ä¸æ˜¯latestçš„é•œåƒ"></a>åˆ é™¤ä¸æ˜¯latestçš„é•œåƒ</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker rmi `docker images|grep -v latest |awk &apos;&#123;print $3&#125;&apos;`</span><br></pre></td></tr></table></figure><h4 id="åˆ é™¤ExitedçŠ¶æ€çš„å®¹å™¨"><a href="#åˆ é™¤ExitedçŠ¶æ€çš„å®¹å™¨" class="headerlink" title="åˆ é™¤ExitedçŠ¶æ€çš„å®¹å™¨"></a>åˆ é™¤ExitedçŠ¶æ€çš„å®¹å™¨</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker rm `docker ps -a|grep Exited|awk &apos;&#123;print $1&#125;&apos;`</span><br></pre></td></tr></table></figure><h4 id="æ ¹æ®é•œåƒååˆ é™¤é•œåƒ"><a href="#æ ¹æ®é•œåƒååˆ é™¤é•œåƒ" class="headerlink" title="æ ¹æ®é•œåƒååˆ é™¤é•œåƒ"></a>æ ¹æ®é•œåƒååˆ é™¤é•œåƒ</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker images | grep wecloud | awk &apos;&#123;print $1&quot;:&quot;$2&#125;&apos; | xargs docker rmi</span><br></pre></td></tr></table></figure><h4 id="åˆ é™¤ä¸€å‘¨ä¹‹å‰çš„é•œåƒ-ä¸€ä¸ªæœˆå†…"><a href="#åˆ é™¤ä¸€å‘¨ä¹‹å‰çš„é•œåƒ-ä¸€ä¸ªæœˆå†…" class="headerlink" title="åˆ é™¤ä¸€å‘¨ä¹‹å‰çš„é•œåƒ(ä¸€ä¸ªæœˆå†…)"></a>åˆ é™¤ä¸€å‘¨ä¹‹å‰çš„é•œåƒ(ä¸€ä¸ªæœˆå†…)</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker images | grep weeks | awk &apos;&#123;print $3&#125;&apos;|xargs docker rmi</span><br></pre></td></tr></table></figure><h4 id="åˆ é™¤ä¸€å‘¨ä¹‹å‰çš„æ‰€æœ‰é•œåƒ"><a href="#åˆ é™¤ä¸€å‘¨ä¹‹å‰çš„æ‰€æœ‰é•œåƒ" class="headerlink" title="åˆ é™¤ä¸€å‘¨ä¹‹å‰çš„æ‰€æœ‰é•œåƒ"></a>åˆ é™¤ä¸€å‘¨ä¹‹å‰çš„æ‰€æœ‰é•œåƒ</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">for i in &#123;&quot;weeks&quot;,&quot;months&quot;&#125;;</span><br><span class="line">docker images | grep $i | awk &apos;&#123;print $3&#125;&apos;|xargs docker rmi</span><br><span class="line">docker images | grep $i | awk &apos;&#123;print $3&#125;&apos;|xargs docker rmi</span><br><span class="line">;done</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºdockerfile"><a href="#åˆ›å»ºdockerfile" class="headerlink" title="åˆ›å»ºdockerfile"></a>åˆ›å»ºdockerfile</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from tomcat #tomcatçš„é•œåƒ</span><br><span class="line">MAINTAINER nmk #ä½œè€…</span><br><span class="line">RUN rm -rf /usr/local/tomcat/webapps/*  #è¿è¡Œçš„å‘½ä»¤</span><br><span class="line">COPY nmk.war /usr/local/tomcat/webapps #å¤åˆ¶waråŒ…åˆ°tomcatçš„webappsç›®å½•ä¸‹</span><br><span class="line">EXPOSE 8080  #å¼€æ”¾ç«¯å£</span><br></pre></td></tr></table></figure><h4 id="é•œåƒæ„å»º"><a href="#é•œåƒæ„å»º" class="headerlink" title="é•œåƒæ„å»º"></a>é•œåƒæ„å»º</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker build -f /data/docker/dockerfile -t mytomcat:1.1</span><br><span class="line">#-f :æŒ‡å®šè¦ä½¿ç”¨çš„Dockerfileè·¯å¾„ï¼›</span><br><span class="line">#--tag, -t: é•œåƒçš„åå­—åŠæ ‡ç­¾ï¼Œé€šå¸¸ name:tag æˆ–è€… name æ ¼å¼ï¼›</span><br></pre></td></tr></table></figure><h4 id="æ¨é€åˆ°é˜¿é‡Œäº‘é•œåƒä»“åº“"><a href="#æ¨é€åˆ°é˜¿é‡Œäº‘é•œåƒä»“åº“" class="headerlink" title="æ¨é€åˆ°é˜¿é‡Œäº‘é•œåƒä»“åº“"></a>æ¨é€åˆ°é˜¿é‡Œäº‘é•œåƒä»“åº“</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#ç™»å½•é˜¿é‡Œäº‘Docker Registry</span><br><span class="line">docker login --username=aliyunaccount registry.cn-beijing.aliyuncs.com</span><br><span class="line">#é•œåƒæ‰“tag</span><br><span class="line">docker tag [ImageId] registry.cn-beijing.aliyuncs.com/nmk/tomcat:[é•œåƒç‰ˆæœ¬å·]</span><br><span class="line">#æ¨é€åˆ°é˜¿é‡Œäº‘</span><br><span class="line">docker push registry.cn-beijing.aliyuncs.com/nmk/tomcat:[é•œåƒç‰ˆæœ¬å·]</span><br><span class="line">#æ‹‰å–é˜¿é‡Œäº‘é•œåƒ</span><br><span class="line">docker pull registry.cn-beijing.aliyuncs.com/lepeng/tomcat:[é•œåƒç‰ˆæœ¬å·]</span><br></pre></td></tr></table></figure><h4 id="ä»å®¿ä¸»æœºæ‹·è´åˆ°å®¹å™¨"><a href="#ä»å®¿ä¸»æœºæ‹·è´åˆ°å®¹å™¨" class="headerlink" title="ä»å®¿ä¸»æœºæ‹·è´åˆ°å®¹å™¨"></a>ä»å®¿ä¸»æœºæ‹·è´åˆ°å®¹å™¨</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker cp files.txt [CONTAINER IDæˆ–NAMES]:/home</span><br></pre></td></tr></table></figure><h4 id="ä»å®¹å™¨æ‹·è´åˆ°å®¿ä¸»æœº"><a href="#ä»å®¹å™¨æ‹·è´åˆ°å®¿ä¸»æœº" class="headerlink" title="ä»å®¹å™¨æ‹·è´åˆ°å®¿ä¸»æœº"></a>ä»å®¹å™¨æ‹·è´åˆ°å®¿ä¸»æœº</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker cp [CONTAINER IDæˆ–NAMES]:/home/files.txt  /home/</span><br></pre></td></tr></table></figure><h4 id="é•œåƒå¯¼å…¥å¯¼å‡ºæœ‰ä¸¤ç§æ–¹æ³•"><a href="#é•œåƒå¯¼å…¥å¯¼å‡ºæœ‰ä¸¤ç§æ–¹æ³•" class="headerlink" title="é•œåƒå¯¼å…¥å¯¼å‡ºæœ‰ä¸¤ç§æ–¹æ³•"></a>é•œåƒå¯¼å…¥å¯¼å‡ºæœ‰ä¸¤ç§æ–¹æ³•</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#æŒ‡å®šé•œåƒä¿å­˜æˆtarå½’æ¡£æ–‡ä»¶</span><br><span class="line">docker save -o files.tar tomcat:7.5</span><br><span class="line">#è½½å…¥æ‰“åŒ…çš„é•œåƒ</span><br><span class="line">docker load -i files.tar</span><br><span class="line">#æŒ‡å®šé•œåƒä¿å­˜æˆtarå½’æ¡£æ–‡ä»¶</span><br><span class="line">docker export -o tomcat.tar [CONTAINER ID]</span><br><span class="line">#è½½å…¥æ‰“åŒ…çš„é•œåƒ</span><br><span class="line">docker import tomcat.tar tomcat:latest</span><br><span class="line"></span><br><span class="line">#æ€»ç»“ä¸€ä¸‹docker saveå’Œdocker exportçš„åŒºåˆ«ï¼š</span><br><span class="line">1.docker saveä¿å­˜çš„æ˜¯é•œåƒï¼ˆimageï¼‰ï¼Œdocker exportä¿å­˜çš„æ˜¯å®¹å™¨ï¼ˆcontainerï¼‰ï¼›</span><br><span class="line">2.docker loadç”¨æ¥è½½å…¥é•œåƒåŒ…ï¼Œdocker importç”¨æ¥è½½å…¥å®¹å™¨åŒ…ï¼Œä½†ä¸¤è€…éƒ½ä¼šæ¢å¤ä¸ºé•œåƒï¼›</span><br><span class="line">3.docker loadä¸èƒ½å¯¹è½½å…¥çš„é•œåƒé‡å‘½åï¼Œè€Œdocker importå¯ä»¥ä¸ºé•œåƒæŒ‡å®šæ–°åç§°ã€‚</span><br><span class="line">#æ³¨:docker saveä¿å­˜çš„é•œåƒdocker loadä¸èƒ½è½½å…¥,docker exportä¿å­˜çš„é•œåƒ,docker importä¸èƒ½è½½å…¥</span><br><span class="line">#è¯¦è§£è¯·çœ‹:https://blog.csdn.net/liukuan73/article/details/78089138</span><br></pre></td></tr></table></figure><h4 id="åˆ é™¤repoä¸noneç©ºtagä¸ºnoneçš„é•œåƒ"><a href="#åˆ é™¤repoä¸noneç©ºtagä¸ºnoneçš„é•œåƒ" class="headerlink" title="åˆ é™¤repoä¸noneç©ºtagä¸ºnoneçš„é•œåƒ"></a>åˆ é™¤repoä¸noneç©ºtagä¸ºnoneçš„é•œåƒ</h4><p>åœ¨dockerä¸­ï¼Œä¸€ä¸ªé•œåƒçš„æ‰€æœ‰æ ‡è®°ï¼ˆTAGï¼‰éƒ½è¢«åˆ é™¤ï¼Œè€Œé•œåƒä»ç„¶è¿˜åœ¨æ—¶ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºdanglingçŠ¶æ€ã€‚è¿™ç§é•œåƒï¼Œåœ¨é€šè¿‡docker imagesï¼ˆæˆ–è€…docker image lsï¼‰æ—¶ï¼Œä¼šè¡¨ç°ä¸ºREPOSITORYå’ŒTAGéƒ½æ˜¯<none>ï¼Œä½†æ˜¯IMAGE IDæœ‰æ•ˆã€‚è¦åˆ é™¤è¿™ç§é•œåƒå¾ˆç®€å•ï¼Œç›´æ¥æ‰§è¡Œdocker image pruneå³å¯æ¸…é™¤ã€‚</none></p><p>è¿˜æœ‰å¦å¤–ä¸€ç§çŠ¶æ€çš„é•œåƒï¼Œå°±æ˜¯å…¶REPOSITORYæ˜¯æœ‰æ•ˆçš„ï¼Œä½†æ˜¯å…¶TAGæ˜¯<none>ï¼Œè¿™ä¸ªæ—¶å€™è¿™ç§é•œåƒæ—¢æ— æ³•é€šè¿‡pruneæ¸…é™¤ï¼Œä¹Ÿæ— æ³•é€šè¿‡å¸¸è§„çš„docker image rmæ¥åˆ é™¤ã€‚</none></p><p>åœ¨docker imagesæŸ¥çœ‹é•œåƒåˆ—è¡¨æ—¶ï¼Œé»˜è®¤æ˜¯ä¸ä¼šæ˜¾ç¤ºé•œåƒçš„digestçš„ã€‚éœ€è¦æ‰‹åŠ¨åŠ ä¸Šâ€“digests=trueå‚æ•°ï¼Œæ‰èƒ½çœ‹åˆ°å½¢å¦‚â€œsha256:xxxxxâ€çš„digestä¿¡æ¯ã€‚è¿™ä¸ªæ—¶å€™ï¼Œç”¨é•œåƒçš„REPOSITORYâ•@â•digestå³å¯ç²¾ç¡®å¼•ç”¨åˆ°è¯¥é•œåƒï¼Œä»è€Œåˆ é™¤ã€‚</p><p>æ¯”å¦‚ï¼Œé€šè¿‡docker images â€“digests=trueçœ‹åˆ°å¦‚ä¸‹é•œåƒï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">REPOSITORY TAG DIGEST IMAGE ID CREATED SIZE</span><br><span class="line">node &lt;none&gt; sha256:016052a6780d578fff9ac8822e66dd483db6ffb94573028b36cdd6ea48e98082 993f38da6c6c 11 days ago 677MB</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªnodeé•œåƒï¼Œä»–çš„TAGæ˜¯noneï¼ŒDIGESTæ˜¯sha256:016052a6780d578fff9ac8822e66dd483db6ffb94573028b36cdd6ea48e98082ã€‚è¿™ä¸ªé•œåƒæ— æ³•é€šè¿‡docker rmi nodeæˆ–è€…docker rmi node:<none>åˆ é™¤ã€‚å¦‚æœè¦åˆ é™¤å®ƒï¼Œéœ€è¦æ‰§è¡Œ</none></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker rmi node@sha256:016052a6780d578fff9ac8822e66dd483db6ffb94573028b36cdd6ea48e98082</span><br></pre></td></tr></table></figure><h4 id="æ¸…ç†overlay2"><a href="#æ¸…ç†overlay2" class="headerlink" title="æ¸…ç†overlay2"></a>æ¸…ç†overlay2</h4><h5 id="æŸ¥çœ‹Dockerçš„ç£ç›˜ä½¿ç”¨æƒ…å†µ"><a href="#æŸ¥çœ‹Dockerçš„ç£ç›˜ä½¿ç”¨æƒ…å†µ" class="headerlink" title="æŸ¥çœ‹Dockerçš„ç£ç›˜ä½¿ç”¨æƒ…å†µ"></a>æŸ¥çœ‹Dockerçš„ç£ç›˜ä½¿ç”¨æƒ…å†µ</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@localhost docker]# docker system df</span><br><span class="line">TYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLE</span><br><span class="line">Images              70                  70                  9.231GB             1.601GB (17%)</span><br><span class="line">Containers          200                 138                 4.292GB             0B (0%)</span><br><span class="line">Local Volumes       0                   0                   0B                  0B</span><br><span class="line">Build Cache         0                   0                   0B                  0B</span><br></pre></td></tr></table></figure><h5 id="æŸ¥çœ‹å½“å‰ç›®å½•æœ€å¤§çš„æ–‡ä»¶æˆ–ç›®å½•çš„å‰äº”ä¸ª"><a href="#æŸ¥çœ‹å½“å‰ç›®å½•æœ€å¤§çš„æ–‡ä»¶æˆ–ç›®å½•çš„å‰äº”ä¸ª" class="headerlink" title="æŸ¥çœ‹å½“å‰ç›®å½•æœ€å¤§çš„æ–‡ä»¶æˆ–ç›®å½•çš„å‰äº”ä¸ª"></a>æŸ¥çœ‹å½“å‰ç›®å½•æœ€å¤§çš„æ–‡ä»¶æˆ–ç›®å½•çš„å‰äº”ä¸ª</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /var/lib/docker/containers/</span><br><span class="line">du -h --max-depth=1 |sort -rn |head -n 5</span><br></pre></td></tr></table></figure><h5 id="å¯æ¸…ç†å®¹å™¨çš„å¯åŠ¨æ—¥å¿—"><a href="#å¯æ¸…ç†å®¹å™¨çš„å¯åŠ¨æ—¥å¿—" class="headerlink" title="å¯æ¸…ç†å®¹å™¨çš„å¯åŠ¨æ—¥å¿—"></a>å¯æ¸…ç†å®¹å™¨çš„å¯åŠ¨æ—¥å¿—</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ls -lh #æŸ¥çœ‹å ç”¨æœ€å¤§çš„æ–‡ä»¶ä¸ºid-json.log</span><br><span class="line">cat /dev/null &gt; *-json.log</span><br></pre></td></tr></table></figure><h5 id="è‡ªåŠ¨æ¸…ç†ç£ç›˜"><a href="#è‡ªåŠ¨æ¸…ç†ç£ç›˜" class="headerlink" title="è‡ªåŠ¨æ¸…ç†ç£ç›˜"></a>è‡ªåŠ¨æ¸…ç†ç£ç›˜</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker system prune</span><br><span class="line">è¯¥æŒ‡ä»¤é»˜è®¤ä¼šæ¸…é™¤æ‰€æœ‰å¦‚ä¸‹èµ„æºï¼š</span><br><span class="line">å·²åœæ­¢çš„å®¹å™¨ï¼ˆcontainerï¼‰</span><br><span class="line">æœªè¢«ä»»ä½•å®¹å™¨æ‰€ä½¿ç”¨çš„å·ï¼ˆvolumeï¼‰</span><br><span class="line">æœªè¢«ä»»ä½•å®¹å™¨æ‰€å…³è”çš„ç½‘ç»œï¼ˆnetworkï¼‰</span><br><span class="line">æ‰€æœ‰æ‚¬ç©ºé•œåƒï¼ˆimageï¼‰</span><br><span class="line">è¯¥æŒ‡ä»¤é»˜è®¤åªä¼šæ¸…é™¤æ‚¬ç©ºé•œåƒï¼Œæœªè¢«ä½¿ç”¨çš„é•œåƒä¸ä¼šè¢«åˆ é™¤ã€‚</span><br><span class="line">æ·»åŠ  -a æˆ– --all å‚æ•°åï¼Œå¯ä»¥ä¸€å¹¶æ¸…é™¤æ‰€æœ‰æœªä½¿ç”¨çš„é•œåƒå’Œæ‚¬ç©ºé•œåƒã€‚</span><br><span class="line">å¯ä»¥æ·»åŠ  -f æˆ– --force å‚æ•°ç”¨ä»¥å¿½ç•¥ç›¸å…³å‘Šè­¦ç¡®è®¤ä¿¡æ¯</span><br><span class="line"></span><br><span class="line">æ³¨æ„:docker system prune -aå‘½ä»¤æ¸…ç†å¾—æ›´åŠ å½»åº•ï¼Œå¯ä»¥å°†æ²¡æœ‰å®¹å™¨ä½¿ç”¨Dockeré•œåƒéƒ½åˆ æ‰ã€‚æ³¨æ„ï¼Œè¿™ä¸¤ä¸ªå‘½ä»¤ä¼šæŠŠä½ æš‚æ—¶å…³é—­çš„å®¹å™¨ï¼Œä»¥åŠæš‚æ—¶æ²¡æœ‰ç”¨åˆ°çš„Dockeré•œåƒéƒ½åˆ æ‰äº†ï¼Œæ‰€ä»¥ä½¿ç”¨ä¹‹å‰ä¸€å®šè¦æƒ³æ¸…æ¥šã€‚</span><br></pre></td></tr></table></figure><h5 id="åˆ é™¤æ‰€æœ‰é€€å‡ºçŠ¶æ€çš„å®¹å™¨"><a href="#åˆ é™¤æ‰€æœ‰é€€å‡ºçŠ¶æ€çš„å®¹å™¨" class="headerlink" title="åˆ é™¤æ‰€æœ‰é€€å‡ºçŠ¶æ€çš„å®¹å™¨"></a>åˆ é™¤æ‰€æœ‰é€€å‡ºçŠ¶æ€çš„å®¹å™¨</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker container prune</span><br></pre></td></tr></table></figure><h5 id="åˆ é™¤æœªè¢«ä½¿ç”¨çš„æ•°æ®å·"><a href="#åˆ é™¤æœªè¢«ä½¿ç”¨çš„æ•°æ®å·" class="headerlink" title="åˆ é™¤æœªè¢«ä½¿ç”¨çš„æ•°æ®å·"></a>åˆ é™¤æœªè¢«ä½¿ç”¨çš„æ•°æ®å·</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker volume prune</span><br></pre></td></tr></table></figure><h5 id="åˆ é™¤-dangling-æˆ–æ‰€æœ‰æœªè¢«ä½¿ç”¨çš„é•œåƒ-é•œåƒIDå’Œæ ‡ç­¾éƒ½å·²è¢«åˆ é™¤ï¼Œå¹¶ä»¥none-å…³é”®å­—è¡¨ç¤º-ã€‚ç§°ä¸º-è™šæ‚¬é•œåƒdangling-image"><a href="#åˆ é™¤-dangling-æˆ–æ‰€æœ‰æœªè¢«ä½¿ç”¨çš„é•œåƒ-é•œåƒIDå’Œæ ‡ç­¾éƒ½å·²è¢«åˆ é™¤ï¼Œå¹¶ä»¥none-å…³é”®å­—è¡¨ç¤º-ã€‚ç§°ä¸º-è™šæ‚¬é•œåƒdangling-image" class="headerlink" title="åˆ é™¤ dangling æˆ–æ‰€æœ‰æœªè¢«ä½¿ç”¨çš„é•œåƒ(é•œåƒIDå’Œæ ‡ç­¾éƒ½å·²è¢«åˆ é™¤ï¼Œå¹¶ä»¥none å…³é”®å­—è¡¨ç¤º ã€‚ç§°ä¸º è™šæ‚¬é•œåƒdangling image)"></a>åˆ é™¤ dangling æˆ–æ‰€æœ‰æœªè¢«ä½¿ç”¨çš„é•œåƒ(é•œåƒIDå’Œæ ‡ç­¾éƒ½å·²è¢«åˆ é™¤ï¼Œå¹¶ä»¥none å…³é”®å­—è¡¨ç¤º ã€‚ç§°ä¸º è™šæ‚¬é•œåƒdangling image)</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker image prune #</span><br></pre></td></tr></table></figure><h5 id="æŸ¥çœ‹åƒµå°¸ç›®å½•"><a href="#æŸ¥çœ‹åƒµå°¸ç›®å½•" class="headerlink" title="æŸ¥çœ‹åƒµå°¸ç›®å½•"></a>æŸ¥çœ‹åƒµå°¸ç›®å½•</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker volume ls -qf dangling=true</span><br></pre></td></tr></table></figure><h5 id="åˆ é™¤åƒµå°¸ç›®å½•"><a href="#åˆ é™¤åƒµå°¸ç›®å½•" class="headerlink" title="åˆ é™¤åƒµå°¸ç›®å½•"></a>åˆ é™¤åƒµå°¸ç›®å½•</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker volume rm $(docker volume ls -qf dangling=true</span><br></pre></td></tr></table></figure><h5 id="æŸ¥çœ‹å®¹å™¨çš„logså¤§å°è¿›è¡Œæ¸…ç†"><a href="#æŸ¥çœ‹å®¹å™¨çš„logså¤§å°è¿›è¡Œæ¸…ç†" class="headerlink" title="æŸ¥çœ‹å®¹å™¨çš„logså¤§å°è¿›è¡Œæ¸…ç†"></a>æŸ¥çœ‹å®¹å™¨çš„logså¤§å°è¿›è¡Œæ¸…ç†</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ll /var/lib/docker/overlay2/197c3988758a714fd0affa0dbbc9137f74e92d5e249f58c29f75cf6dcb1f8bb2/diff/workspace/logs</span><br></pre></td></tr></table></figure><h5 id="é€šè¿‡ç›®å½•åidæŸ¥çœ‹å¯¹åº”çš„pod"><a href="#é€šè¿‡ç›®å½•åidæŸ¥çœ‹å¯¹åº”çš„pod" class="headerlink" title="é€šè¿‡ç›®å½•åidæŸ¥çœ‹å¯¹åº”çš„pod"></a>é€šè¿‡ç›®å½•åidæŸ¥çœ‹å¯¹åº”çš„pod</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker ps -q | xargs docker inspect --format &apos;&#123;&#123;.State.Pid&#125;&#125;, &#123;&#123;.Id&#125;&#125;, &#123;&#123;.Name&#125;&#125;, &#123;&#123;.GraphDriver.Data.WorkDir&#125;&#125;&apos; | egrep 8f06b3a04cedc6717e7d3b639d2be75006e6f897d75cc17fbf09f11a39b5d633</span><br></pre></td></tr></table></figure><h4 id="docker-build-å‘½ä»¤è¡Œäº¤äº’"><a href="#docker-build-å‘½ä»¤è¡Œäº¤äº’" class="headerlink" title="docker build å‘½ä»¤è¡Œäº¤äº’"></a>docker build å‘½ä»¤è¡Œäº¤äº’</h4><p>æ„å»ºelasticsearchï¼Œæƒ³ä¸€èµ·æŠŠ ikåˆ†è¯å™¨æ•´åˆè¿›å»ï¼Œå‘ç°æ„å»ºå¤±è´¥</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ubuntu@ubuntu:~/docker/elasticsearch-ik$ docker build -t elastic-ik . --no-cache</span><br><span class="line">Sending build context to Docker daemon  4.507MB</span><br><span class="line">Step 1/3 : FROM docker.elastic.co/elasticsearch/elasticsearch:6.5.4</span><br><span class="line"> ---&gt; 93109ce1d590</span><br><span class="line">Step 2/3 : ENV VERSION=6.5.4</span><br><span class="line"> ---&gt; Running in 520c5b73edc8</span><br><span class="line">Removing intermediate container 520c5b73edc8</span><br><span class="line"> ---&gt; 96e96aa28b66</span><br><span class="line">Step 3/3 : RUN /usr/share/elasticsearch/bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v$&#123;VERSION&#125;/elasticsearch-analysis-ik-$VERSION.zip</span><br><span class="line"> ---&gt; Running in 5fd671edd1eb</span><br><span class="line">-&gt; Downloading https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.5.4/elasticsearch-analysis-ik-6.5.4.zip</span><br><span class="line">[=================================================] 100%?? </span><br><span class="line">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class="line">@     WARNING: plugin requires additional permissions     @</span><br><span class="line">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class="line">* java.net.SocketPermission * connect,resolve</span><br><span class="line">See Permissions in the JDK</span><br><span class="line">for descriptions of what these permissions allow and the associated risks.</span><br><span class="line"></span><br><span class="line">Exception in thread &quot;main&quot; java.lang.IllegalStateException: unable to read from standard input; is standard input open and a tty attached?</span><br><span class="line">at org.elasticsearch.cli.Terminal$SystemTerminal.readText(Terminal.java:173)</span><br><span class="line">at org.elasticsearch.plugins.PluginSecurity.prompt(PluginSecurity.java:74)</span><br><span class="line">at org.elasticsearch.plugins.PluginSecurity.confirmPolicyExceptions(PluginSecurity.java:67)</span><br><span class="line">at org.elasticsearch.plugins.InstallPluginCommand.installPlugin(InstallPluginCommand.java:801)</span><br><span class="line">at org.elasticsearch.plugins.InstallPluginCommand.install(InstallPluginCommand.java:775)</span><br><span class="line">at org.elasticsearch.plugins.InstallPluginCommand.execute(InstallPluginCommand.java:231)</span><br><span class="line">at org.elasticsearch.plugins.InstallPluginCommand.execute(InstallPluginCommand.java:216)</span><br><span class="line">at org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:86)</span><br><span class="line">at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:124)</span><br><span class="line">at org.elasticsearch.cli.MultiCommand.execute(MultiCommand.java:77)</span><br><span class="line">at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:124)</span><br><span class="line">at org.elasticsearch.cli.Command.main(Command.java:90)</span><br><span class="line">at org.elasticsearch.plugins.PluginCli.main(PluginCli.java:47)</span><br><span class="line">The command &apos;/bin/sh -c /usr/share/elasticsearch/bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v$&#123;VERSION&#125;/elasticsearch-analysis-ik-$VERSION.zip&apos; returned a non-zero code: 1</span><br></pre></td></tr></table></figure><p>æ ¹æ®å‘½ä»¤è¡Œæç¤ºå¯ä»¥çœ‹åˆ°ï¼Œ å†ç¬¬ä¸‰æ­¥çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯å®‰è£… ikåˆ†è¯å™¨çš„æ—¶å€™ï¼Œæç¤ºéœ€è¦é¢å¤–çš„æƒé™ <code>WARNING: plugin requires additional permissions</code></p><p>ç„¶åè¿›å…¥åˆ° ç¬¬äºŒæ­¥çš„é•œåƒä¸­æŸ¥çœ‹åŸå›  <code>docker run -it 96e96aa28b66 /bin/bash</code></p><p>å®‰è£… ik åˆ†è¯å™¨çš„æ—¶å€™éœ€è¦ä¸€æ¬¡ç¡®è®¤äº¤äº’</p><p>Dockerfile</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FROM docker.elastic.co/elasticsearch/elasticsearch:6.5.4</span><br><span class="line"></span><br><span class="line">ENV VERSION=6.5.4</span><br><span class="line"></span><br><span class="line">#COPY elasticsearch-analysis-ik-$VERSION.zip /tmp/</span><br><span class="line"></span><br><span class="line">RUN sh -c &apos;/bin/echo -e &quot;y&quot; | /usr/share/elasticsearch/bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v$&#123;VERSION&#125;/elasticsearch-analysis-ik-$VERSION.zip&apos;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;å®‰è£…docker&quot;&gt;&lt;a href=&quot;#å®‰è£…docker&quot; class=&quot;headerlink&quot; title=&quot;å®‰è£…docker&quot;&gt;&lt;/a&gt;å®‰è£…docker&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td cl</summary>
      
    
    
    
    
    <category term="docker" scheme="https://nmk0718.github.io/tag/docker/"/>
    
  </entry>
  
  <entry>
    <title>shadowsocks</title>
    <link href="https://nmk0718.github.io/2020/03/27/shadowsocks/"/>
    <id>https://nmk0718.github.io/2020/03/27/shadowsocks/</id>
    <published>2020-03-27T07:32:00.000Z</published>
    <updated>2024-11-29T06:43:44.801Z</updated>
    
    <content type="html"><![CDATA[<p>æ‰§è¡Œè„šæœ¬</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@iZj10kpmbmyt18Z ~]# wget --no-check-certificate -O shadowsocks-all.sh https://raw.githubusercontent.com/teddysun/shadowsocks_install/master/shadowsocks-all.sh</span><br><span class="line">[root@iZj10kpmbmyt18Z ~]# chmod +x shadowsocks-all.sh</span><br><span class="line">[root@iZj10kpmbmyt18Z ~]# ./shadowsocks-all.sh</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡å¯èƒ½ä¼šå› ä¸ºgithubåŸå› å¤±è´¥,å¯å†æ¬¡å°è¯•,å‡ºç°ä»¥ä¸‹é¡µé¢å³ä¸ºå®‰è£…æˆåŠŸ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Congratulations, Shadowsocks-Python server install completed!</span><br><span class="line">Your Server IP        :  182.92.103.141 </span><br><span class="line">Your Server Port      :  8989 </span><br><span class="line">Your Password         :  teddysun.com </span><br><span class="line">Your Encryption Method:  aes-256-gcm </span><br><span class="line"></span><br><span class="line">Welcome to visit: https://teddysun.com/486.html</span><br><span class="line">Enjoy it!</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹é…ç½®æ–‡ä»¶ /etc/Shadowsocks-Python/config.json</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;server&quot;:&quot;0.0.0.0&quot;,        //é…ç½®æœåŠ¡ç«¯åœ°å€ï¼Œä¸éœ€è¦ä¿®æ”¹</span><br><span class="line">    &quot;server_port&quot;:8989,           //æœåŠ¡ç«¯ç«¯å£ï¼Œå¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹ï¼Œå»ºè®®æ”¹æˆå¤§ç‚¹çš„ä¸ä¼šè¢«å ç”¨çš„ç«¯å£</span><br><span class="line">    &quot;local_address&quot;:&quot;127.0.0.1&quot;, //æœ¬åœ°åœ°å€ï¼Œä¸éœ€è¦ä¿®æ”¹</span><br><span class="line">    &quot;local_port&quot;:1080,           //æœ¬åœ°ç«¯å£ï¼Œå¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹</span><br><span class="line">    &quot;password&quot;:&quot;nmk1234567&quot;,         //å¯†ç </span><br><span class="line">    &quot;timeout&quot;:300,               //è¿æ¥è¶…æ—¶æ—¶é—´</span><br><span class="line">    &quot;method&quot;:&quot;rc4-md5&quot;,          //åŠ å¯†æ–¹å¼</span><br><span class="line">    &quot;auth&quot;: false                //éœ€è¦éªŒè¯</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sslocal -c /etc/shadowsocks-python/config.json</span><br><span class="line"></span><br><span class="line">æˆ–è€…</span><br><span class="line">/etc/init.d/shadowsocks restart</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æ‰§è¡Œè„šæœ¬&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[root@iZj10kpmbmyt18Z ~]# wget --no-check-ce</summary>
      
    
    
    
    
    <category term="shadowsocks" scheme="https://nmk0718.github.io/tag/shadowsocks/"/>
    
  </entry>
  
  <entry>
    <title>SonarQube</title>
    <link href="https://nmk0718.github.io/2020/03/27/SonarQube/"/>
    <id>https://nmk0718.github.io/2020/03/27/SonarQube/</id>
    <published>2020-03-27T07:23:00.000Z</published>
    <updated>2024-11-29T06:43:41.495Z</updated>
    
    <content type="html"><![CDATA[<h4 id="ä¸‹è½½é•œåƒ"><a href="#ä¸‹è½½é•œåƒ" class="headerlink" title="ä¸‹è½½é•œåƒ"></a>ä¸‹è½½é•œåƒ</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker pull sonarqube:8.6-community</span><br></pre></td></tr></table></figure><h4 id="å¯åŠ¨é•œåƒ"><a href="#å¯åŠ¨é•œåƒ" class="headerlink" title="å¯åŠ¨é•œåƒ"></a>å¯åŠ¨é•œåƒ</h4><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line">mkdir -p /data/sonarqube/data</span><br><span class="line">mkdir -p /data/sonarqube/extensions</span><br><span class="line">mkdir -p /data/sonarqube/logs</span><br><span class="line"></span><br><span class="line">docker run -d --name sonarqube --restart=always -p <span class="number">9000</span>:<span class="number">9000</span> -p <span class="number">9092</span>:<span class="number">9092</span> -v /data/sonarqube/data:<span class="regexp">/opt/</span>sonarqube/data -v /data/sonarqube/extensions:<span class="regexp">/opt/</span>sonarqube/extensions -v /data/sonarqube/logs:<span class="regexp">/opt/</span>sonarqube/logs  sonarqube:<span class="number">8.6</span><span class="number">.1</span>-community</span><br></pre></td></tr></table></figure><h4 id="ç™»å½•SonarQube"><a href="#ç™»å½•SonarQube" class="headerlink" title="ç™»å½•SonarQube"></a>ç™»å½•SonarQube</h4><p><a href="http://ip:9000/" target="_blank" rel="noopener">http://ip:9000/</a></p><img src="\image\image-20210220115917934.png"><p>é»˜è®¤è´¦å·å¯†ç  admin,admin</p><p>ä¿®æ”¹é»˜è®¤å¯†ç </p><img src="\image\image-20210220134327991.png"><p>å®‰è£…ä¸­æ–‡æ’ä»¶</p><img src="\image\image-20210220134605819.png"><p>ç‚¹å‡»restartç­‰å¾…é‡å¯å³å¯</p><img src="\image\image-20210220140802803.png"><h4 id="é¡¹ç›®æ£€æµ‹"><a href="#é¡¹ç›®æ£€æµ‹" class="headerlink" title="é¡¹ç›®æ£€æµ‹"></a>é¡¹ç›®æ£€æµ‹</h4><p>åˆ›å»ºé¡¹ç›®</p><img src="\image\image-20210220150454485.png"><p>åˆ›å»ºä»¤ç‰Œ</p><img src="\image\image-20210220150549006.png"><p>åˆ†æé¡¹ç›®</p><img src="\image\image-20210220150614630.png"><p>å¤åˆ¶å‘½ä»¤åœ¨ä»£ç ç›®å½•ä¸‹æ‰§è¡Œ</p><img src="\image\image-20210220151026434.png"><p>çœ‹åˆ°Buiild Successä»£è¡¨ä»£ç æ£€æµ‹å®Œæ¯•</p><img src="\image\image-20210220151048654.png"><p>å¯çœ‹åˆ°é¡¹ç›®å¯¹åº”çš„bugså’Œæ¼æ´</p><img src="\image\image-20210220151126791.png"><h4 id="å¸¸ç”¨æ’ä»¶ï¼š"><a href="#å¸¸ç”¨æ’ä»¶ï¼š" class="headerlink" title="å¸¸ç”¨æ’ä»¶ï¼š"></a>å¸¸ç”¨æ’ä»¶ï¼š</h4><ul><li>Chinese Pack â€“ ä¸­æ–‡è¯­è¨€åŒ…</li><li>Checkstyle â€“ Java ä»£ç è§„èŒƒæ£€æŸ¥</li><li>Crowd â€“ Crowd æ’ä»¶ï¼Œå®ç°ç»Ÿä¸€ç™»å½•</li><li>JaCoCo â€“ Java ä»£ç è¦†ç›–ç‡</li><li>PMD â€“ Java é™æ€ä»£ç æ‰«æ</li><li>ShellCheck Analyzer â€“ Shell ä»£ç è§„èŒƒæ£€æŸ¥</li><li>SonarCSSã€SonarHTMLã€SonarJSç­‰ â€“ Sonar é’ˆå¯¹ä¸åŒç¼–ç¨‹è¯­è¨€ä»£ç åˆ†æ</li></ul><h4 id="è‡ªåŠ¨æ„å»º"><a href="#è‡ªåŠ¨æ„å»º" class="headerlink" title="è‡ªåŠ¨æ„å»º"></a>è‡ªåŠ¨æ„å»º</h4><p>ç”Ÿæˆjenkinsä¸“å±ä»¤ç‰Œ </p><img src="\image\image-20210220153830365.png"><p><strong>jenkinså…³è”SonarQube</strong></p><p>å®‰è£…æ’ä»¶</p><img src="\image\image-20210220154622214.png"><p>æ·»åŠ å‡­æ® Secretå¯¹åº”åˆ›å»ºçš„ä»¤ç‰Œ</p><img src="\image\image-20210220154824249.png"><p>åœ¨ç³»ç»Ÿé…ç½®ä¸­é…ç½®æ’ä»¶</p><img src="\image\image-20210220155101526.png"><p>åœ¨å…¨å±€å·¥å…·é…ç½®ä¸­é…ç½®</p><p>å¯ä½¿ç”¨è‡ªåŠ¨å®‰è£…æˆ–åŒ…,æœ¬æ–‡ä½¿ç”¨æŒ‡å®šæœ¬åœ°åŒ…</p><p>ä¸‹è½½åœ°å€:<a href="https://github.com/SonarSource/sonar-scanner-cli/releases/download/4.4.0.2170/sonar-scanner-cli-4.4.0.2170-linux.zip" target="_blank" rel="noopener">https://github.com/SonarSource/sonar-scanner-cli/releases/download/4.4.0.2170/sonar-scanner-cli-4.4.0.2170-linux.zip</a></p><img src="\image\image-20210220160938832.png"><p>é¡¹ç›®ç»“æ„,è¯¥é¡¹ç›®éœ€è¦è¿›å…¥ymallç›®å½•è¿›è¡Œæ‰“åŒ…</p><img src="\image\image-20210220170855724.png"><p>å¢åŠ æ„å»ºé€‰é¡¹Execute SonarQube Scanner</p><img src="\image\image-20210220171202597.png"><p>æ„å»ºæ§åˆ¶å°è¾“å‡º</p><img src="\image\image-20210220171336353.png"><p>æŸ¥çœ‹SonarQube,<code>æ–°ä»£ç </code>ä»£è¡¨æ›´æ–°çš„ä»£ç æ¼æ´æ˜¯å¦æ–°å¢,å…¨éƒ¨ä»£ç ä¸ºè€ä»£ç </p><img src="\image\image-20210220171358070.png"><h4 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜:"></a>é—®é¢˜:</h4><p>å¯åŠ¨SonarQubeæ—¶MySQLæŠ¥é”™</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; org.sonar.process.MessageException: Unsupported JDBC driver provider: mysql</span><br></pre></td></tr></table></figure><p>åŸå› æ˜¯SonarQube 7.9ä»¥ä¸Šç‰ˆæœ¬å·²ä¸å†æ”¯æŒmysql,å¯åŠ¨è¯­å¥éœ€è¦æ›´æ”¹</p><p>ä»¥å‰ç‰ˆæœ¬çš„å¯åŠ¨å‘½ä»¤</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker run -d --restart=always --name sonarqube -p 9000:9000 -p 9092:9092 -e &quot;SONARQUBE_JDBC_USERNAME=sonar&quot; -e &quot;SONARQUBE_JDBC_PASSWORD=sonar&quot; -e &quot;SONARQUBE_JDBC_URL=jdbc:mysql://192.168.50.57:3306/sonar?useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false&quot;  -v /data/sonarqube/conf:/opt/sonarqube/conf -v /data/sonarqube/data:/opt/sonarqube/data -v /data/sonarqube/extensions:/opt/sonarqube/extensions -v /data/sonarqube/logs:/opt/sonarqube/logs  sonarqube:7.5-community</span><br></pre></td></tr></table></figure><p>ç°åœ¨ç‰ˆæœ¬çš„å¯åŠ¨å‘½ä»¤</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker run -d --name sonarqube --restart=always -p 9000:9000 -p 9092:9092 -v /data/sonarqube/data:/opt/sonarqube/data -v /data/sonarqube/extensions:/opt/sonarqube/extensions -v /data/sonarqube/logs:/opt/sonarqube/logs  sonarqube:8.6.1-community</span><br></pre></td></tr></table></figure><p>jenkinsæ„å»ºæ—¶æŠ¥é”™</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Cannot run program &quot;/opt/sonar-scanner-cli/bin/sonar-scanner&quot; (in directory /root/.jenkins/workspace/ymall&quot;) error=13, Permission denied</span><br></pre></td></tr></table></figure><p>æˆæƒsonar-scanner</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">chmod -R 777 sonar-scanner-cli/</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;ä¸‹è½½é•œåƒ&quot;&gt;&lt;a href=&quot;#ä¸‹è½½é•œåƒ&quot; class=&quot;headerlink&quot; title=&quot;ä¸‹è½½é•œåƒ&quot;&gt;&lt;/a&gt;ä¸‹è½½é•œåƒ&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;</summary>
      
    
    
    
    
    <category term="SonarQube" scheme="https://nmk0718.github.io/tag/SonarQube/"/>
    
  </entry>
  
  <entry>
    <title>Packaging deployment</title>
    <link href="https://nmk0718.github.io/2020/01/21/deployment/"/>
    <id>https://nmk0718.github.io/2020/01/21/deployment/</id>
    <published>2020-01-21T13:00:00.000Z</published>
    <updated>2024-11-29T06:42:57.229Z</updated>
    
    <content type="html"><![CDATA[<h3 id="æ‰“åŒ…å‘½ä»¤"><a href="#æ‰“åŒ…å‘½ä»¤" class="headerlink" title="æ‰“åŒ…å‘½ä»¤"></a>æ‰“åŒ…å‘½ä»¤</h3><p>å‰å°jsæ‰“åŒ…  éœ€è¦:node.js</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm run build</span><br></pre></td></tr></table></figure><p>æ™®é€šWEBé¡¹ç›®  éœ€è¦:ant</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ant -buildfile build.xml</span><br><span class="line">#è¿›å…¥é¡¹ç›®ç›®å½•,åœ¨æœ‰build.xmlçš„ç›®å½•,ä½¿ç”¨å‘½ä»¤æ‰“åŒ…</span><br></pre></td></tr></table></figure><p>mavené¡¹ç›®  éœ€è¦:maven</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">maven clean install -P&#123;profile&#125; -Dmaven.test.skip=true</span><br><span class="line">#cleanæ¸…ç†æœ¬åœ°åº“ installç¼–è¯‘æ‰“åŒ…å¯æ‰§è¡Œçš„war -PæŒ‡å®šå¤šç¯å¢ƒå‚æ•° -Dmaven.test.skip=true è·³è¿‡æµ‹è¯•</span><br></pre></td></tr></table></figure><h3 id="å¯åŠ¨å‘½ä»¤"><a href="#å¯åŠ¨å‘½ä»¤" class="headerlink" title="å¯åŠ¨å‘½ä»¤"></a>å¯åŠ¨å‘½ä»¤</h3><h4 id="springé¡¹ç›®"><a href="#springé¡¹ç›®" class="headerlink" title="springé¡¹ç›®"></a>springé¡¹ç›®</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -jar nmk.jar --spring.profiles.active=dev</span><br><span class="line">#å¯åœ¨javaåé…ç½®å¯åŠ¨å‚æ•° -Xms512m -Xmx1024m é™åˆ¶é¡¹ç›®ä½¿ç”¨å†…å­˜</span><br><span class="line">#--spring.profiles.active æŒ‡å®šå¤šç¯å¢ƒ</span><br><span class="line">#åœ¨linuxå¯åŠ¨è¯·åœ¨å¯åŠ¨å‘½ä»¤æœ€ååŠ &amp; ä»£è¡¨åå°è¿è¡Œ,å¦‚æœé¡¹ç›®åœ¨ä½ æ–­æ‰è¿æ¥æ—¶æŒ‚æ‰è¯·ä½¿ç”¨nohup+&amp;</span><br><span class="line">#ç¤ºä¾‹å¦‚ä¸‹:</span><br><span class="line">#nohup java -Xms512m -Xmx1024m -jar nmk.jar --spring.profiles.active=prod &gt;&gt; catalina.out 2&gt;&amp;1 &amp;</span><br><span class="line">#æŒ‡å®šç¨‹åºåå°å¯åŠ¨,ä½¿ç”¨prodç¯å¢ƒé…ç½®è¿è¡Œ,æœ€å¤§å †å†…å­˜ä¸º1024M,å¯åŠ¨æ—¥å¿—è¾“å‡ºåˆ°catalina.out</span><br></pre></td></tr></table></figure><h4 id="tomcaté¡¹ç›®"><a href="#tomcaté¡¹ç›®" class="headerlink" title="tomcaté¡¹ç›®"></a>tomcaté¡¹ç›®</h4><ul><li><p>windowsä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">æŠŠwaråŒ…æˆ–æ–‡ä»¶å¤¹æ”¾å…¥tomcat/webappsä¸‹,å¯åŠ¨tomcat/binç›®å½•ä¸‹çš„startup.bat</span><br><span class="line">å¯åœ¨catalina.batå¼€å¤´é…ç½®å †å†…å­˜</span><br><span class="line">set JAVA_OPTS=-server -Xms512m -Xmx1024m</span><br></pre></td></tr></table></figure></li><li><p>linuxä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">æŠŠwaråŒ…æˆ–æ–‡ä»¶å¤¹æ”¾å…¥tomcat/webappsä¸‹,è¿›å…¥tomcat/binç›®å½•ä¸‹</span><br><span class="line">chmod +x startup.sh #æˆæƒæ‰§è¡Œæƒé™</span><br><span class="line">chmod +x catalina.sh </span><br><span class="line">./startup.sh æˆ–sh startup.shå¯åŠ¨tomcat</span><br><span class="line">å¯åœ¨catalina.shå¼€å¤´é…ç½®å †å†…å­˜</span><br><span class="line">JAVA_OPTS=&quot;-Xms512m -Xmx1024m&quot;</span><br></pre></td></tr></table></figure></li></ul><p>*é¡¹ç›®ç¯å¢ƒå¿…é¡»æœ‰å®‰è£…JDK</p><h3 id="bug"><a href="#bug" class="headerlink" title="bug:"></a>bug:</h3><h4 id="é¡¹ç›®ä¸­å›¾ç‰‡ä¸­æ–‡åç§°-è®¿é—®é¡µé¢ä¸æ˜¾ç¤ºé—®é¢˜"><a href="#é¡¹ç›®ä¸­å›¾ç‰‡ä¸­æ–‡åç§°-è®¿é—®é¡µé¢ä¸æ˜¾ç¤ºé—®é¢˜" class="headerlink" title="é¡¹ç›®ä¸­å›¾ç‰‡ä¸­æ–‡åç§°,è®¿é—®é¡µé¢ä¸æ˜¾ç¤ºé—®é¢˜"></a>é¡¹ç›®ä¸­å›¾ç‰‡ä¸­æ–‡åç§°,è®¿é—®é¡µé¢ä¸æ˜¾ç¤ºé—®é¢˜</h4><p>ä¿®æ”¹tomcatçš„conf/server.xml,å¢åŠ ç¼–ç æ ¼å¼</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ä¿®æ”¹å‰&lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot;</span><br><span class="line">               connectionTimeout=&quot;20000&quot;</span><br><span class="line">               redirectPort=&quot;18883&quot; URIEncoding=&quot;UTF-8&quot;/&gt;</span><br><span class="line">ä¿®æ”¹å&lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot; URIEncoding=&quot;UTF-8&quot;</span><br><span class="line">               connectionTimeout=&quot;20000&quot;</span><br><span class="line">               redirectPort=&quot;443&quot;/&gt;</span><br></pre></td></tr></table></figure><p>é‡å¯tomcatå³å¯è§£å†³</p><h4 id="mavenå°†jaråŒ…æ·»åŠ åˆ°æœ¬åœ°ä»“åº“"><a href="#mavenå°†jaråŒ…æ·»åŠ åˆ°æœ¬åœ°ä»“åº“" class="headerlink" title="mavenå°†jaråŒ…æ·»åŠ åˆ°æœ¬åœ°ä»“åº“"></a>mavenå°†jaråŒ…æ·»åŠ åˆ°æœ¬åœ°ä»“åº“</h4><p>æƒ…æ™¯æè¿°ï¼šå½“é¡¹ç›®æ‰€éœ€çš„jaråŒ…ï¼Œmavenä¸­å¤®ä»“åº“ä¸­æ²¡æœ‰è¯¥jaråŒ…æ—¶ï¼Œå¦‚ä½•å°†jaråŒ…æ·»åŠ åˆ°æœ¬åœ°ä»“åº“å‘¢ï¼Ÿ</p><p>é”™è¯¯åšæ³•ï¼šç›´æ¥å°†jaråŒ…æ‹·è´åˆ°æœ¬åœ°ä»“åº“ç›®å½•ä¸‹</p><p>æ­£ç¡®åšæ³•ï¼šã€€ã€€1.é¦–å…ˆï¼Œæ­å»ºmavenè¿è¡Œç¯å¢ƒï¼›ã€€ã€€2. ä½¿ç”¨mavenå‘½ä»¤ï¼Œå°†jaråŒ…æ·»åŠ åˆ°æœ¬åœ°ä»“åº“ï¼›</p><p>mavenå®‰è£…jaråŒ…çš„å‘½ä»¤æ˜¯ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mvn install:install-file -Dfile=jaråŒ…çš„ä½ç½® -DgroupId=è®¾ç½®groupId -DartifactId=è®¾ç½®artifactId -Dversion=è®¾ç½®version -Dpackaging=jar</span><br></pre></td></tr></table></figure><h4 id="å‰ç«¯æ‰“åŒ…å¤±è´¥"><a href="#å‰ç«¯æ‰“åŒ…å¤±è´¥" class="headerlink" title="å‰ç«¯æ‰“åŒ…å¤±è´¥"></a>å‰ç«¯æ‰“åŒ…å¤±è´¥</h4><p>åœ¨windowsæ‰“åŒ…æˆåŠŸ,åœ¨jenkinsä¸­æ‰“åŒ…å¤±è´¥,æŸ¥çœ‹npmå’Œnodeå‘ç°ç‰ˆæœ¬ä¸ä¸€è‡´<br>æŸ¥çœ‹å…¶ç‰ˆæœ¬</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">node -v</span><br><span class="line">v15.1.0</span><br><span class="line"></span><br><span class="line">npm -v</span><br><span class="line">7.0.8</span><br></pre></td></tr></table></figure><p>æ›´æ–°</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">æ›´æ–°npm ï¼š</span><br><span class="line">npm install -g npm</span><br><span class="line">æ›´æ–°æŒ‡å®šç‰ˆæœ¬ ï¼š</span><br><span class="line">npm install -g npm@6.9.0</span><br><span class="line">æ›´æ–°nodeç‰ˆæœ¬ï¼š</span><br><span class="line">é¦–å…ˆå®‰è£…næ¨¡å—</span><br><span class="line">npm install -g n</span><br><span class="line">å®‰è£…å¥½næ¨¡å—åå¯ä»¥é€‰æ‹©ä¸‹é¢å…¶ä¸€å‡çº§ï¼š</span><br><span class="line"></span><br><span class="line">é€‰æ‹©ä¸€ï¼šå‡çº§node.jsåˆ°æœ€æ–°ç¨³å®šç‰ˆ</span><br><span class="line">n stable</span><br><span class="line"></span><br><span class="line">é€‰æ‹©äºŒï¼šå‡çº§node.jsåˆ°æœ€æ–°ç‰ˆ</span><br><span class="line">n latest</span><br><span class="line"></span><br><span class="line">é€‰æ‹©ä¸‰ï¼šå‡çº§node.jsåˆ°æŒ‡å®šç‰ˆæœ¬</span><br><span class="line">n v14.16.0</span><br><span class="line">å¦‚æœå‡ºç°æ²¡æœ‰nå‘½ä»¤æç¤º,è¯·è¿›å…¥nodeå®‰è£…ç›®å½•çš„binä¸‹è¿›è¡Œæ‰§è¡Œ</span><br></pre></td></tr></table></figure><p>è¿˜æ˜¯å‡ºç°æŠ¥é”™</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ERROR in ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib/selector.js?type=script&amp;index=0!./src/project/views/hotword/components/recommend.vue</span><br><span class="line">Module not found: Error: Can&apos;t resolve &apos;./RecommendCreate&apos; in &apos;/home/jenkins/workspace/liang_jian_web_dev/src/project/views/hotword/components&apos;</span><br><span class="line"> @ ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib/selector.js?type=script&amp;index=0!./src/project/views/hotword/components/recommend.vue 15:23-51</span><br><span class="line"> @ ./src/project/views/hotword/components/recommend.vue</span><br><span class="line"> @ ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib/selector.js?type=script&amp;index=0!./src/project/views/hotword/list.vue</span><br><span class="line"> @ ./src/project/views/hotword/list.vue</span><br><span class="line"> @ ./src/project/router/hotword.js</span><br><span class="line"> @ ./src/project/router/index.js</span><br><span class="line"> @ ./src/main.js</span><br><span class="line"></span><br><span class="line">ERROR in ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib/selector.js?type=script&amp;index=0!./src/project/views/hotword/components/recommend.vue</span><br><span class="line">Module not found: Error: Can&apos;t resolve &apos;./RecommendEdit&apos; in &apos;/home/jenkins/workspace/liang_jian_web_dev/src/project/views/hotword/components&apos;</span><br><span class="line"> @ ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib/selector.js?type=script&amp;index=0!./src/project/views/hotword/components/recommend.vue 19:21-47</span><br><span class="line"> @ ./src/project/views/hotword/components/recommend.vue</span><br><span class="line"> @ ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib/selector.js?type=script&amp;index=0!./src/project/views/hotword/list.vue</span><br><span class="line"> @ ./src/project/views/hotword/list.vue</span><br><span class="line"> @ ./src/project/router/hotword.js</span><br><span class="line"> @ ./src/project/router/index.js</span><br><span class="line"> @ ./src/main.js</span><br><span class="line"></span><br><span class="line">ERROR in ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib/selector.js?type=script&amp;index=0!./src/project/views/video/list.vue</span><br><span class="line">Module not found: Error: Can&apos;t resolve &apos;./SetAmount&apos; in &apos;/home/jenkins/workspace/liang_jian_web_dev/src/project/views/video&apos;</span><br><span class="line"> @ ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib/selector.js?type=script&amp;index=0!./src/project/views/video/list.vue 31:17-39</span><br><span class="line"> @ ./src/project/views/video/list.vue</span><br><span class="line"> @ ./src/project/router/video.js</span><br><span class="line"> @ ./src/project/router/index.js</span><br><span class="line"> @ ./src/main.js</span><br><span class="line"></span><br><span class="line">ERROR in ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib/selector.js?type=script&amp;index=0!./src/project/views/waterMark/editWord.vue</span><br><span class="line">Module not found: Error: Can&apos;t resolve &apos;@/project/service/watermark&apos; in &apos;/home/jenkins/workspace/liang_jian_web_dev/src/project/views/waterMark&apos;</span><br><span class="line"> @ ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib/selector.js?type=script&amp;index=0!./src/project/views/waterMark/editWord.vue 11:17-55</span><br><span class="line"> @ ./src/project/views/waterMark/editWord.vue</span><br><span class="line"> @ ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib/selector.js?type=script&amp;index=0!./src/project/views/waterMark/list.vue</span><br><span class="line"> @ ./src/project/views/waterMark/list.vue</span><br><span class="line"> @ ./src/project/router/waterMark.js</span><br><span class="line"> @ ./src/project/router/index.js</span><br><span class="line"> @ ./src/main.js</span><br><span class="line"></span><br><span class="line">ERROR in ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib/selector.js?type=script&amp;index=0!./src/project/views/waterMark/editImage.vue</span><br><span class="line">Module not found: Error: Can&apos;t resolve &apos;@/project/service/watermark&apos; in &apos;/home/jenkins/workspace/liang_jian_web_dev/src/project/views/waterMark&apos;</span><br><span class="line"> @ ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib/selector.js?type=script&amp;index=0!./src/project/views/waterMark/editImage.vue 15:17-55</span><br><span class="line"> @ ./src/project/views/waterMark/editImage.vue</span><br><span class="line"> @ ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib/selector.js?type=script&amp;index=0!./src/project/views/waterMark/list.vue</span><br><span class="line"> @ ./src/project/views/waterMark/list.vue</span><br><span class="line"> @ ./src/project/router/waterMark.js</span><br><span class="line"> @ ./src/project/router/index.js</span><br><span class="line"> @ ./src/main.js</span><br><span class="line"></span><br><span class="line">ERROR in ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib/selector.js?type=script&amp;index=0!./src/project/views/waterMark/createWord.vue</span><br><span class="line">Module not found: Error: Can&apos;t resolve &apos;@/project/service/watermark&apos; in &apos;/home/jenkins/workspace/liang_jian_web_dev/src/project/views/waterMark&apos;</span><br><span class="line"> @ ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib/selector.js?type=script&amp;index=0!./src/project/views/waterMark/createWord.vue 11:17-55</span><br><span class="line"> @ ./src/project/views/waterMark/createWord.vue</span><br><span class="line"> @ ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib/selector.js?type=script&amp;index=0!./src/project/views/waterMark/list.vue</span><br><span class="line"> @ ./src/project/views/waterMark/list.vue</span><br><span class="line"> @ ./src/project/router/waterMark.js</span><br><span class="line"> @ ./src/project/router/index.js</span><br><span class="line"> @ ./src/main.js</span><br><span class="line"></span><br><span class="line">ERROR in ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib/selector.js?type=script&amp;index=0!./src/project/views/waterMark/createImage.vue</span><br><span class="line">Module not found: Error: Can&apos;t resolve &apos;@/project/service/watermark&apos; in &apos;/home/jenkins/workspace/liang_jian_web_dev/src/project/views/waterMark&apos;</span><br><span class="line"> @ ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib/selector.js?type=script&amp;index=0!./src/project/views/waterMark/createImage.vue 15:17-55</span><br><span class="line"> @ ./src/project/views/waterMark/createImage.vue</span><br><span class="line"> @ ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib/selector.js?type=script&amp;index=0!./src/project/views/waterMark/list.vue</span><br><span class="line"> @ ./src/project/views/waterMark/list.vue</span><br><span class="line"> @ ./src/project/router/waterMark.js</span><br><span class="line"> @ ./src/project/router/index.js</span><br><span class="line"> @ ./src/main.js</span><br><span class="line"></span><br><span class="line">  Build failed with errors.</span><br><span class="line"></span><br><span class="line">npm ERR! code 1</span><br><span class="line">npm ERR! path /home/jenkins/workspace/liang_jian_web_dev</span><br><span class="line">npm ERR! command failed</span><br><span class="line">npm ERR! command sh -c node build/build.js</span><br><span class="line"></span><br><span class="line">npm ERR! A complete log of this run can be found in:</span><br><span class="line">npm ERR!     /root/.npm/_logs/2021-03-08T06_33_52_235Z-debug.log</span><br></pre></td></tr></table></figure><p>ç™¾åº¦æ‰¾åˆ°é—®é¢˜åŸå› </p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">æ³¨æ„å¤§å°å†™,</span><br><span class="line">windowså¯¹å¤§å°å†™ä¸æ•æ„Ÿ,å¤§å°å†™éƒ½æ˜¯å¯¹çš„,</span><br><span class="line">linuxå¯¹å¤§å°å†™å¾ˆæ•æ„Ÿ,ä¸å¯¹å°±ä¼šæŠ¥é”™</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹é¡¹ç›®ä¸­çš„å¤§å°å†™,å†æ¬¡ç¼–è¯‘æ‰“åŒ…æˆåŠŸ</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;æ‰“åŒ…å‘½ä»¤&quot;&gt;&lt;a href=&quot;#æ‰“åŒ…å‘½ä»¤&quot; class=&quot;headerlink&quot; title=&quot;æ‰“åŒ…å‘½ä»¤&quot;&gt;&lt;/a&gt;æ‰“åŒ…å‘½ä»¤&lt;/h3&gt;&lt;p&gt;å‰å°jsæ‰“åŒ…  éœ€è¦:node.js&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;</summary>
      
    
    
    
    
    <category term="Packaging deployment" scheme="https://nmk0718.github.io/tag/Packaging-deployment/"/>
    
  </entry>
  
  <entry>
    <title>FTP</title>
    <link href="https://nmk0718.github.io/2020/01/06/ftp/"/>
    <id>https://nmk0718.github.io/2020/01/06/ftp/</id>
    <published>2020-01-06T03:30:00.000Z</published>
    <updated>2024-11-29T06:43:21.675Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ä¸€ã€linux"><a href="#ä¸€ã€linux" class="headerlink" title="ä¸€ã€linux"></a>ä¸€ã€linux</h3><ul><li><h4 id="FTP"><a href="#FTP" class="headerlink" title="FTP"></a>FTP</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install vsftpd -y</span><br><span class="line"></span><br><span class="line">touch ftp.sh</span><br><span class="line"></span><br><span class="line">chmod +x ftp.sh</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">name=nmk</span><br><span class="line"></span><br><span class="line">filePath=/sftp/$name</span><br><span class="line">lnPath=/files/sftp/$name</span><br><span class="line"></span><br><span class="line">#groupadd sftp</span><br><span class="line"></span><br><span class="line">echo create $name ....</span><br><span class="line"></span><br><span class="line">useradd -g sftp -s /sbin/nologin -M $name</span><br><span class="line">usermod -d $filePath $name</span><br><span class="line"></span><br><span class="line">#mkdir $filePath</span><br><span class="line"></span><br><span class="line">mkdir $lnPath</span><br><span class="line">mkdir $lnPath/cmpay</span><br><span class="line"></span><br><span class="line">ln -s $lnPath /sftp</span><br><span class="line"></span><br><span class="line">chown root:root  $filePath      </span><br><span class="line">chmod 755 $filePath</span><br><span class="line"></span><br><span class="line">chown $name:sftp  $lnPath/cmpay  </span><br><span class="line">chmod 755 $lnPath/cmpay</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">echo &quot;password&quot; | passwd $name --stdin &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">echo $name &gt;&gt; /etc/vsftpd/chroot_list</span><br><span class="line"></span><br><span class="line">service vsftpd restart</span><br><span class="line"></span><br><span class="line">echo create $name success.</span><br></pre></td></tr></table></figure></li><li><h4 id="SFTP"><a href="#SFTP" class="headerlink" title="SFTP"></a>SFTP</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">touch sftp.sh</span><br><span class="line"></span><br><span class="line">chmod +x sftp.sh</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">name=nmk</span><br><span class="line"></span><br><span class="line">filePath=/sftp/$name/</span><br><span class="line">lnPath=/files/sftp/$name/</span><br><span class="line"></span><br><span class="line">#groupadd sftp</span><br><span class="line"></span><br><span class="line">echo create $name ....</span><br><span class="line"></span><br><span class="line">useradd -g sftp -s /sbin/nologin -M $name</span><br><span class="line">usermod -d $filePath $name</span><br><span class="line"></span><br><span class="line">#mkdir $filePath</span><br><span class="line"></span><br><span class="line">mkdir $lnPath</span><br><span class="line">mkdir $lnPath/cmpay</span><br><span class="line"></span><br><span class="line">ln -s $lnPath /sftp</span><br><span class="line"></span><br><span class="line">chown root:root  $filePath      </span><br><span class="line">chmod 755 $filePath</span><br><span class="line"></span><br><span class="line">chown $name:sftp  $lnPath/cmpay</span><br><span class="line">chmod 755 $lnPath/cmpay</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">echo &quot;password&quot; | passwd $name --stdin &gt; /dev/null 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line">echo create $name success.</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹/etc/ssh/sshd_configé…ç½®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># override default of no subsystems</span><br><span class="line">#Subsystem      sftp    /usr/libexec/openssh/sftp-server</span><br><span class="line"></span><br><span class="line">Subsystem sftp internal-sftp</span><br><span class="line"></span><br><span class="line"># Example of overriding settings on a per-user basis</span><br><span class="line">#Match User anoncvs</span><br><span class="line">#       X11Forwarding no</span><br><span class="line">#       AllowTcpForwarding no</span><br><span class="line">#       PermitTTY no</span><br><span class="line">#       ForceCommand cvs server</span><br><span class="line"></span><br><span class="line">UseDNS no</span><br><span class="line">AddressFamily inet</span><br><span class="line">SyslogFacility AUTHPRIV</span><br><span class="line">PermitRootLogin yes</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line"></span><br><span class="line"># #æ³¨æ„ï¼Œä»¥ä¸‹è¦ æ”¾åœ¨ æœ¬æ–‡ä»¶çš„æœ€åè¡Œï¼Œå¦åˆ™ rootç”¨æˆ·æ— æ³•ç™»é™†</span><br><span class="line">Match Group sftp</span><br><span class="line">X11Forwarding no</span><br><span class="line">AllowTcpForwarding no</span><br><span class="line"></span><br><span class="line">ChrootDirectory %h</span><br><span class="line">ForceCommand internal-sftp</span><br></pre></td></tr></table></figure></li></ul><h3 id="äºŒã€windows"><a href="#äºŒã€windows" class="headerlink" title="äºŒã€windows"></a>äºŒã€windows</h3><ul><li><h4 id="FTP-1"><a href="#FTP-1" class="headerlink" title="FTP"></a>FTP</h4><p>é€šè¿‡å¯ç”¨windowsè‡ªå¸¦çš„IISåŠŸèƒ½å»ºç«‹FTP</p><p><img src="/image/IIS1.png" alt="image-20200107011735061"></p><p>æ·»åŠ FTPç«™ç‚¹</p><p><img src="/image/IIS2.png" alt="image-20200107012103410"></p><p>å®šä¹‰FTPåç§°å’Œæ˜ å°„ç›®å½•</p><p><img src="/image/IIS3.png" alt="image-20200107231204818"></p><p>å®šä¹‰FTPçš„IPå’Œç«¯å£</p><p><img src="/image/IIS4.png" alt="image-20200107231240035"></p><p>å¦‚éœ€ä¸ç”¨è´¦å·è®¿é—®,è¯·å‹¾é€‰åŒ¿å.å¯åœ¨å…è®¸æˆæƒå®šä¹‰å“ªäº›ç”¨æˆ·å¯è®¿é—®å’Œè¯»å†™æƒé™</p><p><img src="/image/IIS5.png" alt="image-20200107231403866"></p><h5 id="FTPæ‹“å±•"><a href="#FTPæ‹“å±•" class="headerlink" title="FTPæ‹“å±•"></a>FTPæ‹“å±•</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#FTPç”¨æˆ·éš”ç¦»</span><br><span class="line">  åˆ›å»ºD:/FTP</span><br><span class="line">  IISä¸­æŒ‡å®šD:/FTPä¸ºftpæ ¹ç›®å½•</span><br><span class="line">  åœ¨D:/FTPä¸‹å»ºç«‹localuser</span><br><span class="line">  åœ¨localuserä¸‹å»ºç«‹jackå’Œroseç›®å½•</span><br><span class="line">  åˆ›å»ºä¸¤ä¸ªç”¨æˆ·</span><br><span class="line">  jackç›®å½•æ·»åŠ jackç”¨æˆ·å®Œå…¨æ§åˆ¶</span><br><span class="line">  roseç›®å½•æ·»åŠ roseç”¨æˆ·å®Œå…¨æ§åˆ¶</span><br><span class="line">  IISæˆæƒè§„åˆ™&gt;å…è®¸ä¸¤ä¸ªç”¨æˆ·</span><br><span class="line">  ç”¨æˆ·éªŒè¯&gt;åŸºæœ¬éªŒè¯å¯ç”¨ åŒ¿åç¦ç”¨</span><br><span class="line">  ç”¨æˆ·éš”ç¦»&gt;ç”¨æˆ·åç›®å½•(ç¦ç”¨å…¨å±€è™šæ‹Ÿç›®å½•)</span><br><span class="line">  </span><br><span class="line">  #æ­¤åŠŸèƒ½å®ç°æ¯ä¸ªç”¨æˆ·è¿›å…¥ç”¨æˆ·è‡ªå·±çš„ç›®å½•</span><br><span class="line">  #æ­¤åœºæ™¯é€‚ç”¨äºwindowsä¸‹å¤šç”¨æˆ·ä½¿ç”¨åŒä¸€ç«¯å£çš„FTP</span><br></pre></td></tr></table></figure></li></ul><ul><li><h4 id="SFTP-1"><a href="#SFTP-1" class="headerlink" title="SFTP"></a>SFTP</h4><p>OpenSSHä¸‹è½½é“¾æ¥:<a href="https://github.com/PowerShell/Win32-OpenSSH/releases" target="_blank" rel="noopener">OpenSSH</a></p></li></ul><p>  1ã€è¿›å…¥é“¾æ¥ä¸‹è½½æœ€æ–° OpenSSH-Win64.zipï¼Œè§£å‹è‡³D:\OpenSSH</p><p>  2ã€æ‰“å¼€cmd,è¿›å…¥å®‰è£…ç›®å½•cd D:\OpenSSHï¼Œæ‰§è¡Œå‘½ä»¤ï¼š</p>  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">powershell.exe -ExecutionPolicy Bypass -File install-sshd.ps1</span><br></pre></td></tr></table></figure><p>  3ã€è®¾ç½®æœåŠ¡è‡ªåŠ¨å¯åŠ¨å¹¶å¯åŠ¨æœåŠ¡ï¼š</p>  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sc config sshd start= auto</span><br><span class="line"></span><br><span class="line">net start sshd</span><br></pre></td></tr></table></figure><p>  æœåŠ¡å®‰è£…å®Œæ¯•ï¼Œé»˜è®¤ç«¯å£æ˜¯22ï¼Œé»˜è®¤ç”¨æˆ·åå¯†ç ä¸ºWindowè´¦æˆ·åå’Œå¯†ç </p><p>  é…ç½®æ–‡ä»¶ä¼šå­˜æ”¾åœ¨C:\ProgramData\ssh\</p><p>  ä¸»è¦é…ç½®æ–‡ä»¶ä¸ºsshd_config</p>  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#æ­¤é…ç½®æŒ‡å®šSFTPè¿æ¥çš„æ ¹ç›®å½•,å¦‚æœé»˜è®¤æ³¨é‡Šåˆ™ä¸ºwindowsçš„ç”¨æˆ·ç›®å½•</span><br><span class="line">ChrootDirectory D:\SFTP\</span><br><span class="line"></span><br><span class="line">#å¯†é’¥è®¿é—®</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line"></span><br><span class="line">#å…è®¸å“ªäº›ç”¨æˆ·è®¿é—®</span><br><span class="line">AllowUsers  nmk</span><br></pre></td></tr></table></figure><p>  å…·ä½“å¯å‚è€ƒsshd_configé…ç½®,æ­¤å¤„åªåˆ—ä¸¾ä½¿ç”¨åˆ°çš„ä¸€éƒ¨åˆ†</p>  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#windowä¸‹SFTPç›®å½•é…ç½®</span><br><span class="line">åˆ›å»ºç”¨æˆ·&gt;ç®¡ç†ç”¨æˆ·&gt;éš¶å±äºçš„ç»„&gt;åˆ é™¤users</span><br><span class="line">å³é”®D:\SFTPç›®å½•&gt;æƒé™&gt;é«˜çº§&gt;ç¦ç”¨ç»§æ‰¿</span><br><span class="line">åªç»™nmkç”¨æˆ·è¯»å†™D:\SFTPæ–‡ä»¶å¤¹æƒé™</span><br><span class="line">è¿™æ ·ç”¨æˆ·å°±è®¿é—®ä¸åˆ°ç³»ç»Ÿç›®å½•,åªèƒ½è®¿é—®D:/SFTPç›®å½•äº†</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;ä¸€ã€linux&quot;&gt;&lt;a href=&quot;#ä¸€ã€linux&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€linux&quot;&gt;&lt;/a&gt;ä¸€ã€linux&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;h4 id=&quot;FTP&quot;&gt;&lt;a href=&quot;#FTP&quot; class=&quot;headerlin</summary>
      
    
    
    
    
    <category term="FTP" scheme="https://nmk0718.github.io/tag/FTP/"/>
    
  </entry>
  
  <entry>
    <title>Rsync</title>
    <link href="https://nmk0718.github.io/2020/01/03/Rsync/"/>
    <id>https://nmk0718.github.io/2020/01/03/Rsync/</id>
    <published>2020-01-03T02:30:00.000Z</published>
    <updated>2024-11-29T06:45:22.642Z</updated>
    
    <content type="html"><![CDATA[<p>1ã€è®¤è¯†</p><p>Rsyncï¼ˆremote synchronizeï¼‰æ˜¯ä¸€ä¸ªè¿œç¨‹æ•°æ®åŒæ­¥å·¥å…·ï¼Œå¯é€šè¿‡LAN/WANå¿«é€ŸåŒæ­¥å¤šå°ä¸»æœºé—´çš„æ–‡ä»¶ã€‚Rsyncä½¿ç”¨æ‰€è°“çš„â€œRsyncç®—æ³•â€æ¥ä½¿æœ¬åœ°å’Œè¿œ ç¨‹ä¸¤ä¸ªä¸»æœºä¹‹é—´çš„æ–‡ä»¶è¾¾åˆ°åŒæ­¥ï¼Œè¿™ä¸ªç®—æ³•åªä¼ é€ä¸¤ä¸ªæ–‡ä»¶çš„ä¸åŒéƒ¨åˆ†ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½æ•´ä»½ä¼ é€ï¼Œå› æ­¤é€Ÿåº¦ç›¸å½“å¿«</p><p>2ã€åŸç†</p><p>Rsyncæœ¬æ¥æ˜¯ç”¨äºæ›¿ä»£rcpçš„ä¸€ä¸ªå·¥å…·ï¼Œç›®å‰ç”±rsync.samba.orgç»´æŠ¤ï¼Œæ‰€ä»¥rsync.confæ–‡ä»¶çš„æ ¼å¼ç±»ä¼¼äºsambaçš„ä¸»é… ç½®æ–‡ä»¶ï¼›Rsyncå¯ä»¥é€šè¿‡rshæˆ–sshä½¿ç”¨ï¼Œä¹Ÿèƒ½ä»¥daemonæ¨¡å¼å»è¿è¡Œ</p><p>åœ¨ä»¥daemonæ–¹å¼è¿è¡Œæ—¶Rsync serverä¼šæ‰“å¼€ä¸€ä¸ª873 ç«¯å£ï¼Œç­‰å¾…å®¢æˆ·ç«¯å»è¿æ¥ã€‚è¿æ¥æ—¶ï¼ŒRsync serverä¼šæ£€æŸ¥å£ä»¤æ˜¯å¦ç›¸ç¬¦ï¼Œè‹¥é€šè¿‡å£ä»¤æŸ¥æ ¸ï¼Œåˆ™å¯ä»¥å¼€å§‹è¿›è¡Œæ–‡ä»¶ä¼ è¾“ã€‚ç¬¬ä¸€æ¬¡è¿é€šå®Œæˆæ—¶ï¼Œä¼šæŠŠæ•´ä»½æ–‡ä»¶ä¼ è¾“ä¸€æ¬¡ï¼Œä»¥ååˆ™å°±åªéœ€è¿›è¡Œå¢é‡å¤‡ä»½</p><p>3ã€ç‰¹ç‚¹</p><p>1ã€å¯ä»¥é•œåƒä¿å­˜æ•´ä¸ªç›®å½•æ ‘å’Œæ–‡ä»¶ç³»ç»Ÿï¼›</p><p>2ã€å¯ä»¥å¾ˆå®¹æ˜“åšåˆ°ä¿æŒåŸæ¥æ–‡ä»¶çš„æƒé™ã€æ—¶é—´ã€è½¯ç¡¬é“¾æ¥ç­‰ï¼›</p><p>3ã€æ— é¡»ç‰¹æ®Šæƒé™å³å¯å®‰è£…ï¼›</p><p>4ã€ä¼˜åŒ–çš„æµç¨‹ï¼Œæ–‡ä»¶ä¼ è¾“æ•ˆç‡é«˜ï¼›</p><p>5ã€å¯ä»¥ä½¿ç”¨rshã€sshç­‰æ–¹å¼æ¥ä¼ è¾“æ–‡ä»¶ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡ç›´æ¥çš„socketè¿æ¥ï¼›</p><p>6ã€æ”¯æŒåŒ¿åä¼ è¾“</p><p><strong>rsyncå‘½ä»¤</strong></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-vï¼šæ˜¾ç¤ºrsyncè¿‡ç¨‹ä¸­è¯¦ç»†ä¿¡æ¯ã€‚å¯ä»¥ä½¿ç”¨&quot;-vvvv&quot;è·å–æ›´è¯¦ç»†ä¿¡æ¯ã€‚</span><br><span class="line">-a --archive  ï¼šå½’æ¡£æ¨¡å¼ï¼Œè¡¨ç¤ºé€’å½’ä¼ è¾“å¹¶ä¿æŒæ–‡ä»¶å±æ€§ã€‚ç­‰åŒäº&quot;-rtopgDl&quot;ã€‚</span><br><span class="line">-r --recursiveï¼šé€’å½’åˆ°ç›®å½•ä¸­å»ã€‚</span><br><span class="line">-t --timesï¼šä¿æŒmtimeå±æ€§ã€‚å¼ºçƒˆå»ºè®®ä»»ä½•æ—¶å€™éƒ½åŠ ä¸Š&quot;-t&quot;ï¼Œå¦åˆ™ç›®æ ‡æ–‡ä»¶mtimeä¼šè®¾ç½®ä¸ºç³»ç»Ÿæ—¶é—´ï¼Œå¯¼è‡´ä¸‹æ¬¡æ›´æ–°</span><br><span class="line">-zï¼šä¼ è¾“æ—¶è¿›è¡Œå‹ç¼©æé«˜æ•ˆç‡ã€‚</span><br></pre></td></tr></table></figure><p>æœ€å¸¸ç”¨çš„é€‰é¡¹ç»„åˆæ˜¯â€avzâ€ï¼Œå³å‹ç¼©å’Œæ˜¾ç¤ºéƒ¨åˆ†ä¿¡æ¯ï¼Œå¹¶ä»¥å½’æ¡£æ¨¡å¼ä¼ è¾“ã€‚</p><ul><li><h4 id="linuxä¸‹ä½¿ç”¨rsyncåŒæ­¥"><a href="#linuxä¸‹ä½¿ç”¨rsyncåŒæ­¥" class="headerlink" title="linuxä¸‹ä½¿ç”¨rsyncåŒæ­¥"></a>linuxä¸‹ä½¿ç”¨rsyncåŒæ­¥</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#æ–°å»ºè„šæœ¬</span><br><span class="line">touch rsync.sh</span><br><span class="line">#æˆäºˆæ‰§è¡Œæƒé™</span><br><span class="line">chmod +x rsync.sh</span><br></pre></td></tr></table></figure><p>è„šæœ¬å†…å®¹å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line"></span><br><span class="line">#å®‰è£…rsync</span><br><span class="line">yum -y install rsync   </span><br><span class="line"></span><br><span class="line">#ä¿®æ”¹rsyncé…ç½®æ–‡ä»¶</span><br><span class="line">cat &gt;&gt;/etc/rsyncd.conf&lt;&lt;MUL  </span><br><span class="line">uid = root</span><br><span class="line">gid = root</span><br><span class="line">use chroot = no</span><br><span class="line">max connections = 100</span><br><span class="line">address=127.0.0.1</span><br><span class="line">port=8173</span><br><span class="line">log file = /var/log/rsyncd.log</span><br><span class="line">pid file = /var/run/rsyncd.pid</span><br><span class="line">lock file = /var/run/rsync.lock</span><br><span class="line">MUL</span><br><span class="line"></span><br><span class="line">#è·å–æœ¬åœ°ip,æ›¿æ¢addressä¸ºæœ¬åœ°ip</span><br><span class="line">eth0_ip=`ip addr |grep inet |grep eth0|awk &apos;&#123;print $2&#125;&apos; |awk -F &quot;/&quot; &apos;&#123;print $1&#125;&apos;`</span><br><span class="line">sed  -i  &quot;s/127.0.0.1/$eth0_ip/g&quot;     /etc/rsyncd.conf </span><br><span class="line"></span><br><span class="line">#å¯åŠ¨rsync</span><br><span class="line">/usr/bin/rsync --daemon</span><br><span class="line">cat&gt;&gt;/etc/rc.local&lt;&lt;&apos;MUL&apos;</span><br><span class="line">/usr/bin/rsync --daemon</span><br><span class="line">MUL</span><br><span class="line"></span><br><span class="line">#å®šä¹‰å¯†é’¥configä¾›å®¢æˆ·ç«¯è¿æ¥</span><br><span class="line">rsync_datalogs=`grep  -rn  &quot;/data/logs&quot;  /etc/rsyncd.conf |wc  -l`</span><br><span class="line">if   [  &quot;$rsync_datalogs&quot; -eq &quot;0&quot;  ] ;then</span><br><span class="line">cat &gt;&gt;/etc/rsyncd.conf&lt;&lt;&apos;MUL&apos;</span><br><span class="line">[config]</span><br><span class="line">path = /data/logs/</span><br><span class="line">ignore errors = yes</span><br><span class="line">read only = no</span><br><span class="line">MUL</span><br><span class="line">fi</span><br></pre></td></tr></table></figure></li><li><h4 id="windowsä¸‹ä½¿ç”¨rsyncåŒæ­¥"><a href="#windowsä¸‹ä½¿ç”¨rsyncåŒæ­¥" class="headerlink" title="windowsä¸‹ä½¿ç”¨rsyncåŒæ­¥"></a>windowsä¸‹ä½¿ç”¨rsyncåŒæ­¥</h4><p>serverä¸‹è½½åœ°å€:<a href="https://nmk0718.github.io/Rsync/cwRsyncServer_4.1.0_Installer.exe">Rsync server</a><br>clientä¸‹è½½åœ°å€:<a href="https://nmk0718.github.io/Rsync/cwRsync_4.1.0_Installer.exe">Rsync client</a></p></li></ul><p>  serverç«¯å¯è‡ªå®šä¹‰ç”¨æˆ·åå¯†ç </p><p>  windows serveré»˜è®¤å®‰è£…serverç«¯æ‰å¯å‡ºç°rsync serveræœåŠ¡,windowsä½¿ç”¨æœåŠ¡æ¥å¯åŠ¨å’Œåœæ­¢rsync</p><p>  clientç«¯ç›´æ¥å®‰è£…å³å¯</p>  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#serverç«¯é…ç½®æ–‡ä»¶ç¤ºä¾‹</span><br><span class="line"></span><br><span class="line">use chroot = false</span><br><span class="line">strict modes = false</span><br><span class="line">hosts allow = *</span><br><span class="line">log file = rsyncd.log</span><br><span class="line">uid = 0 #ä¸æŒ‡å®šuidï¼Œä¸åŠ è¿™ä¸€è¡Œå°†æ— æ³•ä½¿ç”¨ä»»ä½•è´¦æˆ· </span><br><span class="line">gid = 0 #ä¸æŒ‡å®šgid </span><br><span class="line">max connections = 10 #æœ€å¤§è¿æ¥æ•°10 </span><br><span class="line">port =8173</span><br><span class="line"></span><br><span class="line">[config]</span><br><span class="line">path = /cygdrive/e/log</span><br><span class="line">read only = false</span><br><span class="line">transfer logging = yes</span><br><span class="line">lock file = rsyncd.lock</span><br></pre></td></tr></table></figure><ul><li><h4 id="å®¢æˆ·ç«¯æ‹‰å–"><a href="#å®¢æˆ·ç«¯æ‹‰å–" class="headerlink" title="å®¢æˆ·ç«¯æ‹‰å–"></a>å®¢æˆ·ç«¯æ‹‰å–</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#åŒæ­¥è¯­å¥</span><br><span class="line">rsync -av rsync://172.17.30.7:8173/config /cygdrive/e/logs</span><br><span class="line"></span><br><span class="line">#ç«¯å£åçš„configå¯¹åº”serverç«¯çš„configæ¨¡å—å¹¶ä¸æ˜¯ç›®å½•,å¯åŠ å…¥å®šæ—¶ä»»åŠ¡æ¯1åˆ†é’Ÿè¿è¡Œ</span><br><span class="line">#/cygdrive/e/logs å› ä¸ºwindowsç«¯ä¸ºç›˜ç¬¦,æ‰€ä»¥ç”¨/cygdrive/e/</span><br><span class="line">#rsync://ip:port/æ¨¡å—  /æœ¬åœ°ä¿å­˜ç›®å½•</span><br><span class="line">#linuxå¯ç›´æ¥è¿è¡Œrsyncæ‹‰å–,windowséœ€è¦è¿›å…¥rsync/binç›®å½•ä¸‹è¿è¡Œæˆ–åŠ å…¥ç¯å¢ƒå˜é‡</span><br><span class="line">rsync -vrt rsync://172.17.30.7:8173/config /cygdrive/e/logs</span><br><span class="line">#æ¨èä½¿ç”¨-vrtæ‹‰å–,å¦‚æœwindowsåŒæ­¥linuxçš„æ•°æ®ä½¿ç”¨-aä¼šä¿æŒæ–‡ä»¶å±æ€§,ä½†windowsæ²¡æœ‰rootï¼Œæ•…ä¼šæŠ¥é”™</span><br></pre></td></tr></table></figure></li></ul><h4 id="sersync-rsync-å®ç°æœåŠ¡å™¨æ–‡ä»¶å®æ—¶åŒå‘åŒæ­¥"><a href="#sersync-rsync-å®ç°æœåŠ¡å™¨æ–‡ä»¶å®æ—¶åŒå‘åŒæ­¥" class="headerlink" title="sersync+rsync å®ç°æœåŠ¡å™¨æ–‡ä»¶å®æ—¶åŒå‘åŒæ­¥"></a>sersync+rsync å®ç°æœåŠ¡å™¨æ–‡ä»¶å®æ—¶åŒå‘åŒæ­¥</h4><p>å®ç°åŒå‘åŒæ­¥ï¼Œä¸å­˜åœ¨æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯ã€‚ä¹Ÿå¯ä»¥è¯´ï¼Œæ˜¯æœåŠ¡ç«¯çš„åŒæ—¶ï¼Œä¹Ÿæ˜¯å®¢æˆ·ç«¯ï¼›ä»–ä»¬æ˜¯ç›¸äº’ä½œç”¨çš„ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦è®©æœåŠ¡å™¨çš„rsyncæœåŠ¡å³å¯è¢«è®¿é—®ï¼Œä¹Ÿå¯ä»¥è®¿é—®å…¶ä»–æœåŠ¡å™¨çš„rsyncæœåŠ¡ï¼›</p><p>æˆ‘ä»¬åˆ†ä¸‰æ­¥å®‰è£…ã€‚</p><p>ç¬¬ä¸€æ­¥ ï¼Œ rsyncæœåŠ¡ç«¯é…ç½®ã€‚</p><p>ç¬¬äºŒæ­¥ï¼Œ rsyncå®¢æˆ·ç«¯é…ç½®ã€‚</p><p>ç¬¬ä¸‰æ­¥ï¼Œå®‰è£… sersync</p><h5 id="å®‰è£…éƒ¨ç½²rsyncæœåŠ¡ç«¯é…ç½®ï¼ˆæœåŠ¡ç«¯ï¼‰"><a href="#å®‰è£…éƒ¨ç½²rsyncæœåŠ¡ç«¯é…ç½®ï¼ˆæœåŠ¡ç«¯ï¼‰" class="headerlink" title="å®‰è£…éƒ¨ç½²rsyncæœåŠ¡ç«¯é…ç½®ï¼ˆæœåŠ¡ç«¯ï¼‰"></a>å®‰è£…éƒ¨ç½²rsyncæœåŠ¡ç«¯é…ç½®ï¼ˆæœåŠ¡ç«¯ï¼‰</h5><p>1.å®‰è£…rsync</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-work3 ~]# yum install rsync -y</span><br></pre></td></tr></table></figure><p>2.åˆ›å»ºç”¨æˆ·è®¤è¯æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-work3 ~]# echo  &quot;root:123456&quot;&gt;/etc/rsync.servicePwd</span><br></pre></td></tr></table></figure><p>3.è®¾ç½®ç”¨æˆ·è®¤è¯æ–‡ä»¶æƒé™</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-work3 ~]# chmod 600 /etc/rsync.servicePwd</span><br></pre></td></tr></table></figure><p>4.åˆ›å»ºé…ç½®æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-work3 ~]# vi /etc/rsyncd.conf</span><br><span class="line">#Rsync server</span><br><span class="line">uid = root</span><br><span class="line">gid = root</span><br><span class="line">port = 873</span><br><span class="line">use chroot = no</span><br><span class="line">max connections = 2000</span><br><span class="line">timeout = 600</span><br><span class="line">pid file = /var/run/rsyncd.pid</span><br><span class="line">lock file = /var/run/rsync.lock</span><br><span class="line">log file = /var/log/rsyncd.log</span><br><span class="line">ignore errors</span><br><span class="line">read only = false</span><br><span class="line">list = false</span><br><span class="line">hosts allow = 192.168.233.10</span><br><span class="line">hosts deny = 0.0.0.0/32</span><br><span class="line">auth users = root</span><br><span class="line">secrets file = /etc/rsync.servicePwd</span><br><span class="line">[www]</span><br><span class="line">comment = www</span><br><span class="line">path = /data/</span><br></pre></td></tr></table></figure><p>5.å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹å¹¶åŠ å…¥å¼€æœºè‡ªå¯ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-work3 ~]# rsync --daemon --config=/etc/rsyncd.conf</span><br><span class="line">[root@k8s-work3 ~]# vi /etc/rc.local</span><br><span class="line">/usr/bin/rsync --daemon</span><br></pre></td></tr></table></figure><p>6.åˆ›å»ºç›¸å…³å¾…åŒæ­¥çš„ç›®å½•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@S1 ~]# mkdir -p /data   #æ­¤ç›®å½•å°±æ˜¯ä¸é…ç½®æ–‡ä»¶ä¸­ æ¨¡æ¿www å¯¹åº”çš„ç›®å½•</span><br><span class="line">[root@M1 ~]# touch /data/test.log</span><br></pre></td></tr></table></figure><h5 id="rsyncå®¢æˆ·ç«¯é…ç½®"><a href="#rsyncå®¢æˆ·ç«¯é…ç½®" class="headerlink" title="rsyncå®¢æˆ·ç«¯é…ç½®"></a>rsyncå®¢æˆ·ç«¯é…ç½®</h5><p>1.åˆ›å»ºå®¢æˆ·ç«¯å¯†ç æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-work3 ~]# echo &quot;123456&quot;&gt;/etc/rsync.clientPwd</span><br></pre></td></tr></table></figure><p>2.è®¾ç½®å¯†ç æ–‡ä»¶æƒé™</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-work3 ~]# chmod 600 /etc/rsync.clientPwd</span><br></pre></td></tr></table></figure><h5 id="rsyncæµ‹è¯•"><a href="#rsyncæµ‹è¯•" class="headerlink" title="rsyncæµ‹è¯•"></a>rsyncæµ‹è¯•</h5><p>1.æœåŠ¡å™¨A ä½œä¸ºå®¢æˆ·ç«¯ï¼Œä»æœåŠ¡å™¨Bçš„æ¨¡æ¿wwwä¸­ åŒæ­¥æ•°æ®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-work2 data]# rsync -av  root@192.168.50.54::www/ /data/ --password-file=/etc/rsync.clientPwd</span><br><span class="line">receiving incremental file list</span><br><span class="line">qrcode/</span><br><span class="line">qrcode/permanent_34_service_seniorPartner20201228102732.jpg</span><br><span class="line"></span><br><span class="line">sent 51 bytes  received 29,081 bytes  19,421.33 bytes/sec</span><br><span class="line">total size is 28,854  speedup is 0.99</span><br></pre></td></tr></table></figure><p>2.æ˜¾ç¤ºæˆåŠŸ,æŸ¥çœ‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-work2 data]# ls</span><br><span class="line">qrcode  test.log</span><br></pre></td></tr></table></figure><h5 id="å®‰è£…éƒ¨ç½²sersyncæœåŠ¡"><a href="#å®‰è£…éƒ¨ç½²sersyncæœåŠ¡" class="headerlink" title="å®‰è£…éƒ¨ç½²sersyncæœåŠ¡"></a>å®‰è£…éƒ¨ç½²sersyncæœåŠ¡</h5><p>1.ä¸‹è½½</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https://storage.googleapis.com/google-code-archive-downloads/v2/code.google.com/sersync/sersync2.5_64bit_binary_stable_final.tar.gz</span><br></pre></td></tr></table></figure><p>2.é…ç½®sersync</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-work3 data]# mkdir /usr/local/sersync/</span><br><span class="line">[root@k8s-work3 data]# cd /usr/local/sersync/</span><br><span class="line">[root@k8s-work3 sersync]# mv /root/sersync2.5_64bit_binary_stable_final.tar.gz .</span><br><span class="line">[root@k8s-work3 sersync]# tar zxvf sersync2.5_64bit_binary_stable_final.tar.gz </span><br><span class="line">GNU-Linux-x86/</span><br><span class="line">GNU-Linux-x86/confxml.xml</span><br><span class="line">GNU-Linux-x86/sersync2</span><br><span class="line">[root@k8s-work3 sersync]# mkdir -p conf bin log</span><br><span class="line">[root@k8s-work3 sersync]# mv GNU-Linux-x86/confxml.xml  conf/ </span><br><span class="line">[root@k8s-work3 sersync]# cp conf/confxml.xml conf/confxml.xml.bak</span><br><span class="line">[root@k8s-work3 sersync]# mv GNU-Linux-x86/sersync2  bin/</span><br></pre></td></tr></table></figure><p>3.ä¿®æ”¹é…ç½®æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi  /usr/local/sersync/conf/confxml.xml</span><br><span class="line">ä¿®æ”¹24--28è¡Œ</span><br><span class="line"> 24         &lt;localpath watch=&quot;/opt/tongbu&quot;&gt;</span><br><span class="line"> 25             &lt;remote ip=&quot;127.0.0.1&quot; name=&quot;tongbu1&quot;/&gt;</span><br><span class="line"> 26             &lt;!--&lt;remote ip=&quot;192.168.8.39&quot; name=&quot;tongbu&quot;/&gt;--&gt;</span><br><span class="line"> 27             &lt;!--&lt;remote ip=&quot;192.168.8.40&quot; name=&quot;tongbu&quot;/&gt;--&gt;</span><br><span class="line"> 28         &lt;/localpath&gt;</span><br><span class="line">ä¿®æ”¹åçš„å†…å®¹ä¸ºï¼š watch:ä¸ºæ¨¡å—å¯¹åº”çš„ç›®å½•ã€‚ä¼šå°†æœåŠ¡å™¨ ip:xxxx æ¨¡å—wwwä¸‹çš„æ–‡ä»¶ åŒæ­¥åˆ° watch=â€œ/data/wwwâ€ä¸‹ </span><br><span class="line">å¦‚æœæœ‰å¤šä¸ªåŒæ­¥æ¨¡å—ï¼Œåˆ™æŒ‰ä¸‹é¢æ ¼å¼ä¾æ¬¡å»å†™ï¼Œä»…æ›´æ”¹</span><br><span class="line">24         &lt;localpath watch=&quot;/data&quot;&gt;</span><br><span class="line">25             &lt;remote ip=&quot;192.168.50.54&quot; name=&quot;www&quot;/&gt;</span><br><span class="line">26             &lt;remote ip=&quot;192.168.50.55&quot; name=&quot;www&quot;/&gt;</span><br><span class="line">27         &lt;/localpath&gt;</span><br><span class="line">ä¿®æ”¹29--35è¡Œï¼Œè®¤è¯éƒ¨åˆ†(rsyncå¯†ç è®¤è¯)</span><br><span class="line">29         &lt;rsync&gt;</span><br><span class="line">30             &lt;commonParams params=&quot;-artuz&quot;/&gt;</span><br><span class="line">31             &lt;auth start=&quot;false&quot; users=&quot;root&quot; passwordfile=&quot;/etc/rsync.pas&quot;/&gt;</span><br><span class="line">32             &lt;userDefinedPort start=&quot;false&quot; port=&quot;874&quot;/&gt;&lt;!-- port=874 --&gt;</span><br><span class="line">33             &lt;timeout start=&quot;false&quot; time=&quot;100&quot;/&gt;&lt;!-- timeout=100 --&gt;</span><br><span class="line">34             &lt;ssh start=&quot;false&quot;/&gt;</span><br><span class="line">35         &lt;/rsync&gt;</span><br><span class="line">ä¿®æ”¹åçš„å†…å®¹å¦‚ä¸‹ï¼šstartæ”¹å®Œtrueæ‰“å¼€ç”¨æˆ·è®¤è¯ã€‚ usersä¸ºæœåŠ¡ç«¯é…ç½®æ–‡ä»¶ä¸­çš„users passwordfileå¯†ç æ–‡ä»¶ æ­¤å¤„ä¸ºï¼š/etc/rsync.clientPwd å®¢æˆ·ç«¯å¯†ç æ–‡ä»¶</span><br><span class="line">27         &lt;rsync&gt;</span><br><span class="line">28             &lt;commonParams params=&quot;-artuz&quot;/&gt;</span><br><span class="line">29             &lt;auth start=&quot;true&quot; users=&quot;root&quot; passwordfile=&quot;/etc/rsync.clientPwd&quot;/&gt;</span><br><span class="line">30             &lt;userDefinedPort start=&quot;false&quot; port=&quot;874&quot;/&gt;&lt;!-- port=874 --&gt;</span><br><span class="line">31             &lt;timeout start=&quot;true&quot; time=&quot;100&quot;/&gt;&lt;!-- timeout=100 --&gt;</span><br><span class="line">32             &lt;ssh start=&quot;false&quot;/&gt;</span><br><span class="line">33         &lt;/rsync&gt;</span><br><span class="line">ä¿®æ”¹åŒæ­¥å¤±è´¥æ—¥å¿—ä½ç½®ï¼Œå¹¶ä¸”æ¯60åˆ†é’Ÿå¯¹å¤±è´¥çš„logè¿›è¡Œé‡æ–°åŒæ­¥</span><br><span class="line"></span><br><span class="line">&lt;failLog path=&quot;/usr/local/sersync/logs/rsync_fail_log.sh&quot; timeToExecute=&quot;60&quot;/&gt;&lt;!--default ev    ery 60mins execute once--&gt;</span><br></pre></td></tr></table></figure><p>4.åˆ›å»ºç›¸å…³æ–‡ä»¶:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-work3 sersync]# mkdir logs</span><br><span class="line">[root@k8s-work3 sersync]# touch /usr/local/sersync/log/rsync_fail_log.sh</span><br></pre></td></tr></table></figure><p>5.å¼€å¯sersyncå®ˆæŠ¤è¿›ç¨‹åŒæ­¥æ•°æ®</p><p>âš æ‰§è¡Œå‘½ä»¤å‰,è¯·è¿›è¡Œå¤‡ä»½æ•°æ®,è¯¥å‘½ä»¤ä¼šåˆ é™¤è¿œç¨‹çš„èµ„æºæ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-work3 sersync]# /usr/local/sersync/bin/sersync2 -d -r -o /usr/local/sersync/conf/confxml.xml</span><br><span class="line">set the system param</span><br><span class="line">executeï¼šecho 50000000 &gt; /proc/sys/fs/inotify/max_user_watches</span><br><span class="line">executeï¼šecho 327679 &gt; /proc/sys/fs/inotify/max_queued_events</span><br><span class="line">parse the command param</span><br><span class="line">option: -d      run as a daemon</span><br><span class="line">option: -r      rsync all the local files to the remote servers before the sersync work</span><br><span class="line">option: -o      config xml nameï¼š  /usr/local/sersync/conf/confxml.xml</span><br><span class="line">daemon thread num: 10</span><br><span class="line">parse xml config file</span><br><span class="line">host ip : localhost     host port: 8008</span><br><span class="line">daemon startï¼Œsersync run behind the console </span><br><span class="line">use rsync password-file :</span><br><span class="line">user is root</span><br><span class="line">passwordfile is         /etc/rsync.clientPwd</span><br><span class="line">config xml parse success</span><br><span class="line">please set /etc/rsyncd.conf max connections=0 Manually</span><br><span class="line">sersync working thread 12  = 1(primary thread) + 1(fail retry thread) + 10(daemon sub threads) </span><br><span class="line">Max threads numbers is: 32 = 12(Thread pool nums) + 20(Sub threads)</span><br><span class="line">please according your cpu ï¼Œuse -n param to adjust the cpu rate</span><br><span class="line">------------------------------------------</span><br><span class="line">rsync the directory recursivly to the remote servers once</span><br><span class="line">working please wait...</span><br><span class="line">execute command: cd /data &amp;&amp; rsync -artuz -R --delete ./ root@192.168.50.54::www --password-file=/etc/rsync.clientPwd &gt;/dev/null 2&gt;&amp;1 </span><br><span class="line">run the sersync: </span><br><span class="line">watch path is: /data</span><br><span class="line">[root@k8s-work3 sersync]# echo &quot;PATH=$PATH:/usr/local/sersync&quot; &gt; /etc/profile.d/sersync.sh</span><br><span class="line">[root@k8s-work3 sersync]# source /etc/profile.d/sersync.sh</span><br></pre></td></tr></table></figure><p>å‚è€ƒæ–‡æ¡£ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https://blog.csdn.net/weixin_40134742/article/details/110950845</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;1ã€è®¤è¯†&lt;/p&gt;
&lt;p&gt;Rsyncï¼ˆremote synchronizeï¼‰æ˜¯ä¸€ä¸ªè¿œç¨‹æ•°æ®åŒæ­¥å·¥å…·ï¼Œå¯é€šè¿‡LAN/WANå¿«é€ŸåŒæ­¥å¤šå°ä¸»æœºé—´çš„æ–‡ä»¶ã€‚Rsyncä½¿ç”¨æ‰€è°“çš„â€œRsyncç®—æ³•â€æ¥ä½¿æœ¬åœ°å’Œè¿œ ç¨‹ä¸¤ä¸ªä¸»æœºä¹‹é—´çš„æ–‡ä»¶è¾¾åˆ°åŒæ­¥ï¼Œè¿™ä¸ªç®—æ³•åªä¼ é€ä¸¤ä¸ªæ–‡ä»¶çš„ä¸åŒéƒ¨åˆ†ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½æ•´</summary>
      
    
    
    
    
    <category term="Rsync" scheme="https://nmk0718.github.io/tag/Rsync/"/>
    
  </entry>
  
  <entry>
    <title>oracle</title>
    <link href="https://nmk0718.github.io/2019/09/30/oracle/"/>
    <id>https://nmk0718.github.io/2019/09/30/oracle/</id>
    <published>2019-09-30T01:15:45.000Z</published>
    <updated>2024-11-29T06:44:13.201Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ç®¡ç†å‘˜æ“ä½œæ•°æ®åº“"><a href="#ç®¡ç†å‘˜æ“ä½œæ•°æ®åº“" class="headerlink" title="ç®¡ç†å‘˜æ“ä½œæ•°æ®åº“"></a>ç®¡ç†å‘˜æ“ä½œæ•°æ®åº“</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt; sqlplus / as sysdba  --æœ¬åœ°systemç™»é™†æ•°æ®</span><br><span class="line">&gt; shutdown immediate;  --ç«‹å³å…³é—­æ•°æ®åº“</span><br><span class="line">&gt; startup;             --å¯åŠ¨æ•°æ®åº“</span><br><span class="line">&gt; startup force;       --å¼ºåˆ¶é‡å¯æ•°æ®åº“</span><br><span class="line">&gt; <span class="built_in">exit</span>;                --é€€å‡ºsqlplus</span><br></pre></td></tr></table></figure><p>å½“ä½¿ç”¨linuxæ—¶è¯·ä½¿ç”¨<br></p><ul><li>su - oracle  åˆ‡æ¢oracleç”¨æˆ·<br></li></ul><ul><li>lsnrctl stop  åœæ­¢ç›‘å¬<br></li></ul><ul><li>lsnrctl start  å¯åŠ¨ç›‘å¬</li></ul><h3 id="ç”¨æˆ·"><a href="#ç”¨æˆ·" class="headerlink" title="ç”¨æˆ·"></a>ç”¨æˆ·</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt; select  *ã€€from dba_users;                                --æŸ¥æ‰¾ç”¨æˆ·</span><br><span class="line">&gt; create user username identified by password;              --åˆ›å»ºç”¨æˆ· </span><br><span class="line">&gt; grant connect to username;                                --æˆäºˆè¿æ¥æƒé™</span><br><span class="line">&gt; grant resource to username;                               --æˆäºˆå¼€å‘æƒé™</span><br><span class="line">&gt; grant dba to username;                                    --æˆäºˆæœ€é«˜æƒé™</span><br><span class="line">&gt; grant resource,connect,dba to username;                   --æˆäºˆæ‰€æœ‰æƒé™</span><br><span class="line">&gt; drop user name cascade;                                   --åˆ é™¤ç”¨æˆ·</span><br><span class="line">&gt; select username,account_status,lock_date from dba_users;  --æŸ¥çœ‹è¢«é”ç”¨æˆ·</span><br><span class="line">&gt; alter user username account unlock;                       --è§£é”ç”¨æˆ·</span><br><span class="line">&gt; alter user username account lock;                         --é”å®šç”¨æˆ·</span><br></pre></td></tr></table></figure><p>åˆ›å»ºç”¨æˆ·æ—¶å¦‚éœ€é»˜è®¤è¡¨ç©ºé—´,ç¤ºä¾‹:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt; create user username identified by password default tablespace tablespacename;</span><br></pre></td></tr></table></figure><details><summary>æ·±å…¥äº†è§£</summary><pre><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GRANTæˆæƒ</span><br><span class="line">GRANT èµ‹äºˆä¸€ä¸ªç”¨æˆ·ï¼Œä¸€ä¸ªç»„æˆ–æ‰€æœ‰ç”¨æˆ·è®¿é—®æƒé™</span><br><span class="line">GRANT privilege [, ...] ON object [, ...]    TO &#123; PUBLIC | GROUP group | username &#125;</span><br><span class="line"></span><br><span class="line">privilegeçš„æƒé™æœ‰:  </span><br><span class="line">  SELECT è®¿é—®å£°æ˜çš„è¡¨/è§†å›¾çš„æ‰€æœ‰åˆ—/å­—æ®µï¼</span><br><span class="line">  INSERT å‘å£°æ˜çš„è¡¨ä¸­æ’å…¥æ‰€æœ‰åˆ—å­—æ®µï¼</span><br><span class="line">  UPDATE æ›´æ–°å£°æ˜çš„æ‰€æœ‰åˆ—/å­—æ®µï¼</span><br><span class="line">  DELETE ä»å£°æ˜çš„è¡¨ä¸­åˆ é™¤æ‰€æœ‰è¡Œï¼</span><br><span class="line">  RULE   åœ¨è¡¨/è§†å›¾ä¸Šå®šä¹‰è§„åˆ™ ï¼ˆå‚è§ CREATE RULE è¯­å¥ï¼‰ï¼</span><br><span class="line">  ALL    èµ‹äºˆæ‰€æœ‰æƒé™ï¼</span><br><span class="line">objectèµ‹äºˆæƒé™çš„å¯¹è±¡å.å¯èƒ½çš„å¯¹è±¡æ˜¯:  </span><br><span class="line">                                      table     (è¡¨)</span><br><span class="line">                                      view      (è§†å›¾)</span><br><span class="line">                                      sequence  (åºåˆ—)</span><br><span class="line">                                      index     (ç´¢å¼•)</span><br><span class="line">PUBLIC      ä»£è¡¨æ˜¯æ‰€æœ‰ç”¨æˆ·çš„ç®€å†™.</span><br><span class="line">GROUP group å°†è¦èµ‹äºˆæƒé™çš„ç»„ </span><br><span class="line">username    å°†è¦èµ‹äºˆæƒé™çš„ç”¨æˆ·åï¼</span><br><span class="line"></span><br><span class="line">ç¤ºä¾‹: GRANT SELECT,DELETE,UPDATE,INSERT ON TABLENAME TO USERNAME;  --æˆæƒç”¨æˆ·å¯¹è¡¨çš„å¢åˆ æ”¹æŸ¥</span><br><span class="line">      GRANT ALL PRIVILEGES ON TABLENAME to USERNAME;               --æˆæƒç”¨æˆ·å¯¹è¡¨çš„æ‰€æœ‰æƒé™</span><br><span class="line"></span><br><span class="line">å¦‚æœæˆåŠŸ,è¾“å‡º CHANGE</span><br><span class="line">å¦‚æœæ‰€å£°æ˜çš„å¯¹è±¡ä¸å¯ç”¨æˆ–ä¸å¯èƒ½å¯¹å£°æ˜çš„ç»„æˆ–ç”¨æˆ·èµ‹äºˆæƒé™ï¼</span><br><span class="line">è¾“å‡º ERROR: ChangeAcl: class <span class="string">"object"</span> not found</span><br><span class="line">æè¿°ï¼šGRANTå…è®¸å¯¹è±¡çš„åˆ›å»ºè€…ç»™æŸç”¨æˆ·æˆ–æŸç»„æˆ–æ‰€æœ‰ç”¨æˆ·ï¼ˆPUBLICï¼‰æŸäº›ç‰¹å®šçš„æƒé™ï¼å¯¹è±¡åˆ›å»ºå,</span><br><span class="line">  é™¤äº†åˆ›å»ºè€…å¤–ï¼Œé™¤éåˆ›å»ºè€…èµ‹äºˆï¼ˆGRANTï¼‰æƒé™ï¼Œå…¶ä»–äººæ²¡æœ‰è®¿é—®å¯¹è±¡çš„æƒé™ï¼</span><br><span class="line">  ä¸€æ—¦ç”¨æˆ·æœ‰æŸå¯¹è±¡çš„æƒé™ï¼Œä»–å°±å¯ä»¥ä½¿ç”¨é‚£ä¸ªç‰¹æƒï¼ä¸éœ€è¦ç»™åˆ›å»ºè€…èµ‹äºˆï¼ˆGRANTï¼‰å¯¹è±¡çš„æƒé™ï¼Œ</span><br><span class="line">  åˆ›å»ºè€…è‡ªåŠ¨æ‹¥æœ‰å¯¹è±¡çš„æ‰€æœ‰æƒé™ï¼ŒåŒ…æ‹¬åˆ é™¤å®ƒçš„æƒé™.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">REVOKEå›æ”¶æƒé™</span><br><span class="line">REVOKE INSERT ON TABLENAME FROM USERNAME         å›æ”¶USERNAMEåœ¨TABLENAMEä¸Šçš„æ’å…¥æƒé™</span><br><span class="line">REVOKE ALL PRIVILEGES ON TABLENAME FROM USERNAME å›æ”¶ç”¨æˆ·USERNAMEå¯¹TABLENAMEçš„æ‰€æœ‰æƒé™</span><br></pre></td></tr></table></figure><p></p></pre></details><p></p><h3 id="è¡¨ç©ºé—´"><a href="#è¡¨ç©ºé—´" class="headerlink" title="è¡¨ç©ºé—´"></a>è¡¨ç©ºé—´</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt; select *from DBA_TABLESPACES <span class="built_in">where</span> TABLESPACE_NAME =<span class="string">'TABLESPACENAME'</span>; æŸ¥çœ‹è¡¨ç©ºé—´</span><br><span class="line">&gt; drop tablespace TABLESPACENAME including contents and datafiles cascade constraint; åˆ é™¤è¡¨ç©ºé—´</span><br><span class="line">&gt; CREATE TABLESPACE TABLESPACENAME DATAFILE <span class="string">'D:\APP\ADMINISTRATOR\ORADATA\oracle\TABLESPACENAME.DBF'</span></span><br><span class="line">  SIZE 500M AUTOEXTEND ON NEXT 100M MAXSIZE UNLIMITED; windowsåˆ›å»ºè¡¨ç©ºé—´</span><br><span class="line">&gt; CREATE TABLESPACE TABLESPACENAME DATAFILE <span class="string">'/u01/oracle/oradata/wlzy/ECMSSTATS.DBF'</span></span><br><span class="line">  SIZE 500M AUTOEXTEND ON NEXT 100M MAXSIZE UNLIMITED;  linuxåˆ›å»ºè¡¨ç©ºé—´ è¡¨ç©ºé—´å¤§å°è‡ªåŠ¨å¢é•¿</span><br><span class="line"></span><br><span class="line">æ•°æ®åº“æ‰€æœ‰è¡¨ç©ºé—´ä½¿ç”¨ç‡</span><br><span class="line">&gt; SELECT to_date(sysdate),</span><br><span class="line">      Upper(F.TABLESPACE_NAME)         <span class="string">"è¡¨ç©ºé—´å"</span>,</span><br><span class="line">      D.TOT_GROOTTE_MB                 <span class="string">"è¡¨ç©ºé—´å¤§å°M)"</span>,</span><br><span class="line">      D.TOT_GROOTTE_MB - F.TOTAL_BYTES <span class="string">"å·²ä½¿ç”¨ç©ºé—´M)"</span>,</span><br><span class="line">      To_char(Round(( D.TOT_GROOTTE_MB - F.TOTAL_BYTES ) / D.TOT_GROOTTE_MB * 100, 2), <span class="string">'990.99'</span>)</span><br><span class="line">      || <span class="string">'%'</span>                           <span class="string">"ä½¿ç”¨ç‡"</span>,</span><br><span class="line">      F.TOTAL_BYTES                    <span class="string">"ç©ºé—²ç©ºé—´(M)"</span>,</span><br><span class="line">      F.MAX_BYTES                      <span class="string">"æœ€å¤§å—(M)"</span></span><br><span class="line"> FROM (SELECT TABLESPACE_NAME,</span><br><span class="line">             Round(Sum(BYTES) / ( 1024 * 1024 ), 2) TOTAL_BYTES,</span><br><span class="line">             Round(Max(BYTES) / ( 1024 * 1024 ), 2) MAX_BYTES</span><br><span class="line">      FROM   SYS.DBA_FREE_SPACE</span><br><span class="line">       GROUP  BY TABLESPACE_NAME) F,</span><br><span class="line">      (SELECT DD.TABLESPACE_NAME,</span><br><span class="line">              Round(Sum(DD.BYTES) / ( 1024 * 1024 ), 2) TOT_GROOTTE_MB</span><br><span class="line">       FROM   SYS.DBA_DATA_FILES DD</span><br><span class="line">       GROUP  BY DD.TABLESPACE_NAME) D</span><br><span class="line"> WHERE  D.TABLESPACE_NAME = F.TABLESPACE_NAME</span><br><span class="line"> ORDER  BY 1;</span><br><span class="line"></span><br><span class="line">è¡¨ç©ºé—´å¤§å°</span><br><span class="line">&gt; select</span><br><span class="line"> b.file_name ç‰©ç†æ–‡ä»¶å,</span><br><span class="line"> b.tablespace_name è¡¨ç©ºé—´,</span><br><span class="line"> b.bytes/1024/1024 å¤§å°M,</span><br><span class="line"> (b.bytes-sum(nvl(a.bytes,0)))/1024/1024 å·²ä½¿ç”¨M,</span><br><span class="line"> substr((b.bytes-sum(nvl(a.bytes,0)))/(b.bytes)*100,1,5) åˆ©ç”¨ç‡</span><br><span class="line"> from dba_free_space a,dba_data_files b</span><br><span class="line"> <span class="built_in">where</span> a.file_id=b.file_id</span><br><span class="line"> group by b.tablespace_name,b.file_name,b.bytes</span><br><span class="line"> order by b.tablespace_name</span><br></pre></td></tr></table></figure><h3 id="å¤‡ä»½å’Œè¿˜åŸ"><a href="#å¤‡ä»½å’Œè¿˜åŸ" class="headerlink" title="å¤‡ä»½å’Œè¿˜åŸ"></a>å¤‡ä»½å’Œè¿˜åŸ</h3><p>æŸ¥æ‰¾æ•°æ®æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">select * from dba_data_files; </span><br><span class="line">select * from dba_tablespaces;</span><br><span class="line">select * from dba_directories æŸ¥çœ‹å¤‡ä»½ç›®å½•</span><br></pre></td></tr></table></figure><p>å¯¼å‡º</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt; expdp username/password  directory=manualbackup dumpfile=dumpname.dmp schemas=username;</span><br><span class="line">&gt; expdp username/password tables=tablename dumpfile=dumpname.dmp directory=manualbackup; å¯¼å‡ºæ•°æ®åº“ä¸­ä¸€ä¸ªè¡¨çš„æ•°æ®</span><br><span class="line">&gt; expdp username/password directory=manualbackup dumpfile=dumpname.dmp tables=tablename query=â€™<span class="built_in">where</span> ID=123â€™; å¯¼å‡ºæ•°æ®åº“ä¸­ä¸€ä¸ªè¡¨ä¸­çš„ä¸€è¡Œæ•°æ®</span><br></pre></td></tr></table></figure><p>å¯¼å…¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt; impdp ecmsintf/ecms  directory= manualbackup dumpfile=ecms_dp_20190401.dmp schemas=ecms TABLE_EXISTS_ACTION=replace å¯¼å…¥æ•°æ®åº“</span><br><span class="line">&gt; impdp ecms/ecms directory=manualbackup dumpfile=ELECTRICITY_BILL_FILE.dmp tables=ELECTRICITY_BILL_FILE remap_schema=ecms:ecms; å¯¼å…¥æ•°æ®åº“ä¸­ä¸€ä¸ªè¡¨çš„æ•°æ®</span><br></pre></td></tr></table></figure><p>oracleå¤‡ä»½åˆ†ä¸ºexpå’Œexpdp</p><h3 id="æ‚è°ˆ"><a href="#æ‚è°ˆ" class="headerlink" title="æ‚è°ˆ"></a>æ‚è°ˆ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">åˆ›å»ºè¡¨æ¥è‡ªå¦å¤–ä¸€ä¸ªè¡¨</span><br><span class="line">Create table a as select field from b</span><br><span class="line"></span><br><span class="line">åœ¨è¡¨ä¸­å¢åŠ åˆ—</span><br><span class="line">alter table a add å­—æ®µå ç±»å‹</span><br><span class="line"></span><br><span class="line">åˆ é™¤è¡¨ä¸­çš„åˆ—</span><br><span class="line">alter table a drop cloumnc åˆ—å</span><br><span class="line"></span><br><span class="line">æ›´æ–°è¡¨å†…å®¹</span><br><span class="line">update a <span class="built_in">set</span> åˆ—å  = null</span><br><span class="line"></span><br><span class="line">åˆ›å»ºç´¢å¼•</span><br><span class="line">create index ç´¢å¼•å on è¡¨(å­—æ®µ) tablespace è¡¨ç©ºé—´</span><br><span class="line"></span><br><span class="line">å»é‡å‡½æ•° distinct</span><br><span class="line">ç›¸åŠ å‡½æ•° sum</span><br><span class="line"><span class="keyword">case</span> when ç¬¦åˆæ¡ä»¶åˆ™ä¸º1 å¦åˆ™ä¸º0</span><br><span class="line"></span><br><span class="line">æŸ¥çœ‹ç¬¦åˆæ¡ä»¶çš„æœ‰å¤šå°‘æ¡</span><br><span class="line">select sum(<span class="keyword">case</span> when æ¡ä»¶ <span class="keyword">then</span> 1 <span class="keyword">else</span> 0 end) from a</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æ–°å¢è¡¨åˆ—å¯¹åº”çš„å€¼</span><br><span class="line">insert into è¡¨å (åˆ—å) values (å€¼)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">select * from (select a.*,rownum rn from (select * from table_name)a <span class="built_in">where</span> rownum &lt;= 40) <span class="built_in">where</span> rn &gt;=21</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">select jcwdm from (select row_number() over(partition by jcwdm order by jcwdm) rn,a.* from tablename a</span><br><span class="line">) <span class="built_in">where</span> rn =1</span><br><span class="line"></span><br><span class="line"> DBLink</span><br><span class="line"></span><br><span class="line">create database link cnjzzsp</span><br><span class="line">    connect  to admin identified password</span><br><span class="line">     using <span class="string">'(DESCRIPTION=</span></span><br><span class="line"><span class="string">         (ADDRESS_LIST=</span></span><br><span class="line"><span class="string">               (ADDRESS=(PROTOCOL = TCP)(HOST =10.16.163.41)(PORT=1521))</span></span><br><span class="line"><span class="string">)</span></span><br><span class="line"><span class="string">(CONNECT_DATA =</span></span><br><span class="line"><span class="string">        (SERVICE =Oracle)</span></span><br><span class="line"><span class="string">   ) </span></span><br><span class="line"><span class="string">)'</span>; </span><br><span class="line"></span><br><span class="line">Â æŸ¥çœ‹é”è¡¨è¿›ç¨‹SQLè¯­å¥ï¼šÂ </span><br><span class="line">Â Â Â Â Â Â selectÂ sess.sid,Â </span><br><span class="line">Â Â Â Â Â Â sess.serial<span class="comment">#,Â </span></span><br><span class="line">Â Â Â Â Â Â lo.oracle_username,Â </span><br><span class="line">Â Â Â Â Â Â lo.os_user_name,Â </span><br><span class="line">Â Â Â Â Â Â ao.object_name,Â </span><br><span class="line">Â Â Â Â Â Â lo.locked_modeÂ </span><br><span class="line">Â Â Â Â Â Â fromÂ v<span class="variable">$locked_object</span>Â lo,Â </span><br><span class="line">Â Â Â Â Â Â dba_objectsÂ ao,Â </span><br><span class="line">Â Â Â Â Â Â v<span class="variable">$session</span>Â sessÂ </span><br><span class="line">Â Â Â Â Â Â <span class="built_in">where</span>Â ao.object_idÂ =Â lo.object_idÂ andÂ lo.session_idÂ =Â sess.sid;Â </span><br><span class="line"></span><br><span class="line">å¦‚æœ‰è®°å½•åˆ™è¡¨ç¤ºæœ‰lockï¼Œè®°å½•ä¸‹SIDå’Œserial<span class="comment">#Â ï¼Œå°†è®°å½•çš„IDæ›¿æ¢ä¸‹é¢çš„xx,xxxï¼Œå³å¯è§£é™¤LOCKÂ </span></span><br><span class="line">Â Â Â Â Â Â alterÂ systemÂ <span class="built_in">kill</span>Â sessionÂ <span class="string">'xx,xxx'</span></span><br><span class="line"></span><br><span class="line">ç©ºé—²ç‡</span><br><span class="line">select sum(m.all_g),sum(n.free_g),</span><br><span class="line">sum(n.free_g)/sum(m.all_g) from</span><br><span class="line">(select tablespace_name,sum(bytes)/1024/1024 as all_g from dba_data_files group by tablespace_name) m,</span><br><span class="line">(select tablespace_name,sum(bytes)/1024/1024 as free_g from dba_free_space group by tablespace_name) n</span><br><span class="line"><span class="built_in">where</span> m.tablespace_name = n.tablespace_name</span><br><span class="line"></span><br><span class="line">ä½¿ç”¨ç‡</span><br><span class="line">select m.tablespace_name,m.all_g,</span><br><span class="line">n.free_g ,n.free_g/m.all_g from</span><br><span class="line">(select tablespace_name,sum(bytes)/1024/1024 as all_g from dba_data_files group by tablespace_name) m,</span><br><span class="line">(select tablespace_name,sum(bytes)/1024/1024 as free_g from dba_free_space group by tablespace_name) n</span><br><span class="line"><span class="built_in">where</span> m.tablespace_name = n.tablespace_name</span><br></pre></td></tr></table></figure><h3 id="æ•°æ®åº“å‘½ä»¤"><a href="#æ•°æ®åº“å‘½ä»¤" class="headerlink" title="æ•°æ®åº“å‘½ä»¤"></a>æ•°æ®åº“å‘½ä»¤</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt; oracle SGAä½¿ç”¨æƒ…å†µ</span><br><span class="line">&gt; select * from v<span class="variable">$sga</span>;</span><br><span class="line">å›ºå®šSGA(MB)  Fixed Size </span><br><span class="line">æ•°æ®ç¼“å†²åŒº(MB) Database Buffers</span><br><span class="line">æ—¥å¿—ç¼“å†²åŒº(MB) Redo Buffers</span><br><span class="line">&gt; select * from v<span class="variable">$logfile</span>;  æ—¥å¿—è¡¨</span><br><span class="line">&gt; select count(*) from v<span class="variable">$session</span>; --æ•°æ®åº“å½“å‰é…ç½®ä¼šè¯æ•°</span><br><span class="line">&gt; select * from dba_jobs  æ•°æ®åº“æ‰€æœ‰çš„job</span><br><span class="line">&gt; select * from dba_jobs_running æ­£åœ¨è¿è¡Œçš„job</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;ç®¡ç†å‘˜æ“ä½œæ•°æ®åº“&quot;&gt;&lt;a href=&quot;#ç®¡ç†å‘˜æ“ä½œæ•°æ®åº“&quot; class=&quot;headerlink&quot; title=&quot;ç®¡ç†å‘˜æ“ä½œæ•°æ®åº“&quot;&gt;&lt;/a&gt;ç®¡ç†å‘˜æ“ä½œæ•°æ®åº“&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td cla</summary>
      
    
    
    
    
    <category term="database" scheme="https://nmk0718.github.io/tag/database/"/>
    
    <category term="oracle" scheme="https://nmk0718.github.io/tag/oracle/"/>
    
  </entry>
  
</feed>
