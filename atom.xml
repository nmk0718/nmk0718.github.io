<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title></title>
  
  
  <link href="http://nmk0718.github.io/atom.xml" rel="self"/>
  
  <link href="http://nmk0718.github.io/"/>
  <updated>2025-01-17T03:28:24.882Z</updated>
  <id>http://nmk0718.github.io/</id>
  
  <author>
    <name>kk</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>OpenTelemetry</title>
    <link href="http://nmk0718.github.io/2025/01/14/OpenTelemetry/"/>
    <id>http://nmk0718.github.io/2025/01/14/OpenTelemetry/</id>
    <published>2025-01-14T03:09:00.000Z</published>
    <updated>2025-01-17T03:28:24.882Z</updated>
    
    <content type="html"><![CDATA[<p>OpenTelemetry（简称OTel）是一个开源可观测性框架，用于仪表化、生成、收集和导出诸如跟踪、度量、日志等遥测数据<br><image src="https://opentelemetry.io/docs/collector/img/otel-collector.svg" alt="Collector"></image></p><p>部署参考文档：<br><a href="https://opentelemetry.io/zh/docs" target="_blank" rel="noopener">https://opentelemetry.io/zh/docs</a><br><a href="https://www.zhihu.com/question/545762884/answer/3323681028" target="_blank" rel="noopener">https://www.zhihu.com/question/545762884/answer/3323681028</a></p><h3 id="Instrumentation"><a href="#Instrumentation" class="headerlink" title="Instrumentation"></a>Instrumentation</h3><p>Instrumentation 是 OpenTelemetry 中用于对应用程序进行监控和数据收集。它包括手动仪表化（Manual Instrumentation）和自动仪表化（Automatic Instrumentation）两种方式。通过 Instrumentation，开发人员可以将应用程序的运行数据（如追踪、指标、日志）收集并发送到后端系统进行分析和可视化。</p><ol><li>手动仪表化：<ul><li>开发者通过在代码中显式地添加 OpenTelemetry API 调用，来创建和管理追踪、指标等遥测数据。</li><li>可以对应用程序的特定部分进行详细的监控和分析，获取更深入的性能和行为信息。</li><li>在关键的业务逻辑处手动创建 span 来记录操作的开始和结束时间，从而精确地监控特定代码段的执行情况。</li></ul></li><li>自动仪表化：<ul><li>无需修改应用程序源代码，通过特定的机制（如字节码注入、代理等）自动对应用程序中的各种库、框架等进行监控，收集遥测数据。</li><li>减少手动添加监控代码的工作量，快速为应用程序添加基本的监控能力。例如，OpenTelemetry 的 Java 自动仪表化可以通过一个 agent 自动收集日志、指标、trace 并上报。</li></ul></li></ol><h3 id="Collector"><a href="#Collector" class="headerlink" title="Collector"></a>Collector</h3><p>Collector 是一个开源的、可扩展的代理，用于接收、处理和导出遥测数据（如 traces、metrics 和 logs）。它提供了一种厂商中立的方式来收集、处理和导出遥测数据，消除了运行、操作和维护多个代理/收集器的需要。</p><h4 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h4><p>在不修改应用程序代码的情况下，收集和处理遥测数据。</p><ol><li>Agent：<ul><li>部署方式：每个客户端SDK或下游采集器都配置一个collector。收集器实例与应用程序在同一主机上运行，例如sidecar或者daemonset方式。</li><li>工作方式：应用程序中的SDK以OTLP协议发送遥测数据给collector。然后collector处理遥测数据并对接到可观测性后端。<image src="https://opentelemetry.io/zh/docs/collector/img/otel-agent-sdk.svg" alt="Agent形态"></image></li></ul></li><li>Gateway：<ul><li>部署方式：使用开箱即用的负载均衡器（比如nginx）在otel-collector之间分配负载。</li><li>工作方式：应用程序中的SDK以OTLP协议发送遥测数据给负载均衡器，负载均衡器根据算法选择其中一个collector实例进行处理并对接到可观测性后端<image src="https://opentelemetry.io/zh/docs/collector/img/otel-gateway-sdk.svg" alt="Gateway形态"></image></li></ul></li></ol><h4 id="Pipeline-components"><a href="#Pipeline-components" class="headerlink" title="Pipeline components"></a>Pipeline components</h4><ul><li><p>receiver：负责按照对应的协议格式监听接收遥测数据，并把数据转给一个或者多个processor。</p></li><li><p>processor：负责做遥测数据加工处理，如丢弃数据，增加信息，转批处理等，并把数据传递给下一个processor或者传递给一个或多个exporter。</p></li><li><p>exporter：负责把数据往下一个接收端发送（一般是遥测后端），exporter可以定义同时从多个不同的processor中获取遥测数据。</p></li></ul><p>Collector 除了提供让遥测数据收集与业务逻辑处理正交的能力，还充当了遥测数据对接遥测后端的适配器。Collector可以接收 Otlp、Zipkin、Jaeger等任意格式的数据，然后以 Otlp、Zipkin、Jaeger等任意格式的数据转发出去。这一切只取决于你需要输入或输出的格式是否有对应的 receiver 和 exporter 实现</p><h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h3><h4 id="Jaeger"><a href="#Jaeger" class="headerlink" title="Jaeger"></a>Jaeger</h4><p>为了便于演示这里使用  jaegertracing/all-in-one 镜像来部署 Jaeger，这个镜像包含了 Jaeger 收集器、内存存储、查询服务和 UI 等组件，非常适合开发和测试使用。通过环境变量 <code>COLLECTOR_OTLP_ENABLED</code> 启动对 OTLP（OpenTelemetry Protocol） 的支持。</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="bullet">-</span> <span class="string">&lt;&lt;EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jaeger</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">jaeger</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">jaeger</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jaeger</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">jaegertracing/all-in-one:latest</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">COLLECTOR_OTLP_ENABLED</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"true"</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">16686</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">14268</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jaeger</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">jaeger</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ui</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">16686</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">16686</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">collector</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">14268</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">14268</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">4318</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">4318</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grpc</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">4317</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">4317</span>      </span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h4 id="​​OpenTelemetry-Operator"><a href="#​​OpenTelemetry-Operator" class="headerlink" title="​​OpenTelemetry Operator"></a>​​OpenTelemetry Operator</h4><p>OpenTelemetry Operator用于管理OpenTelemetry 收集器(OpenTelemetry Collectors)和工作负载的自动检测(auto-instrumentation)<br>安装OpenTelemetry Operator</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm repo add open-telemetry https://open-telemetry.github.io/opentelemetry-helm-charts</span><br><span class="line"></span><br><span class="line">helm install opentelemetry-operator open-telemetry/opentelemetry-operator \</span><br><span class="line">  --<span class="built_in">set</span> <span class="string">"manager.collectorImage.repository=otel/opentelemetry-collector-k8s"</span> \</span><br><span class="line">  --<span class="built_in">set</span> admissionWebhooks.certManager.enabled=<span class="literal">false</span> \</span><br><span class="line">  --<span class="built_in">set</span> admissionWebhooks.autoGenerateCert.enabled=<span class="literal">true</span></span><br></pre></td></tr></table></figure><ul><li><code>otel/opentelemetry-collector-k8s</code>专门为Kubernetes环境优化的，包含了在Kubernetes中运行所需的基本功能和插件。</li><li><code>opentelemetry-collector-contrib</code>包含了大量的扩展功能和实验性组件。这些组件包括各种接收器、处理器、导出器以及扩展功能，旨在提供更广泛的遥测数据处理能力<br>可以看到对应的 Pod 已经正常运行：<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  ~ kubectl --namespace default get pods -l <span class="string">"app.kubernetes.io/name=opentelemetry-operator"</span></span><br><span class="line">NAME                                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">opentelemetry-operator-f78f45ffc-sgns7   2/2     Running   0          2m44s</span><br></pre></td></tr></table></figure></li></ul><p>还会自动为我们添加OpenTelemetry 相关的 CRD：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  ~ kubectl get crd |grep opentelemetry</span><br><span class="line">instrumentations.opentelemetry.io                    2025-01-14T07:32:04Z</span><br><span class="line">opampbridges.opentelemetry.io                        2025-01-14T07:32:04Z</span><br><span class="line">opentelemetrycollectors.opentelemetry.io             2025-01-14T07:32:04Z</span><br></pre></td></tr></table></figure><h4 id="OpenTelemetry-Collector"><a href="#OpenTelemetry-Collector" class="headerlink" title="OpenTelemetry Collector"></a>OpenTelemetry Collector</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="bullet">-</span> <span class="string">&lt;&lt;EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">opentelemetry.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">OpenTelemetryCollector</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">otel</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">config:</span> <span class="string">|</span></span><br><span class="line">    <span class="attr">receivers:</span></span><br><span class="line">      <span class="attr">otlp:</span></span><br><span class="line">        <span class="attr">protocols:</span></span><br><span class="line">          <span class="attr">grpc:</span></span><br><span class="line">          <span class="attr">http:</span></span><br><span class="line">    <span class="attr">processors:</span></span><br><span class="line">      <span class="attr">memory_limiter:</span></span><br><span class="line">        <span class="attr">check_interval:</span> <span class="string">1s</span></span><br><span class="line">        <span class="attr">limit_percentage:</span> <span class="number">75</span></span><br><span class="line">        <span class="attr">spike_limit_percentage:</span> <span class="number">15</span></span><br><span class="line">      <span class="attr">batch:</span></span><br><span class="line">        <span class="attr">send_batch_size:</span> <span class="number">10000</span></span><br><span class="line">        <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">exporters:</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">otlp/jaeger:</span></span><br><span class="line">        <span class="attr">endpoint:</span> <span class="string">"jaeger.default:4317"</span></span><br><span class="line">        <span class="attr">tls:</span></span><br><span class="line">          <span class="attr">insecure:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">pipelines:</span></span><br><span class="line">        <span class="attr">traces:</span></span><br><span class="line">          <span class="attr">receivers:</span> <span class="string">[otlp]</span></span><br><span class="line">          <span class="attr">processors:</span> <span class="string">[]</span></span><br><span class="line">          <span class="attr">exporters:</span> <span class="string">[debug,otlp/jaeger]</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>创建 CR OpenTelemetryCollector 后，Otel Operator 会创建一个 deployment 和 多个 service。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  ~</span><br><span class="line">kubectl get deployment,service -l app.kubernetes.io/component=opentelemetry-collector</span><br><span class="line"></span><br><span class="line">NAME                             READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/otel-collector   1/1     1            1           3m37s</span><br><span class="line"></span><br><span class="line">NAME                                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE</span><br><span class="line">service/otel-collector              ClusterIP   10.111.0.124     &lt;none&gt;        4317/TCP,4318/TCP   3m36s</span><br><span class="line">service/otel-collector-headless     ClusterIP   None             &lt;none&gt;        4317/TCP,4318/TCP   3m36s</span><br><span class="line">service/otel-collector-monitoring   ClusterIP   10.111.151.111   &lt;none&gt;        8888/TCP            3m36s</span><br></pre></td></tr></table></figure><h4 id="Auto-instrumentation"><a href="#Auto-instrumentation" class="headerlink" title="Auto-instrumentation"></a>Auto-instrumentation</h4><p>创建一个Java 服务的基本检测资源</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="bullet">-</span> <span class="string">&lt;&lt;EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">opentelemetry.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Instrumentation</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">instrumentation-sample</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">propagators:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tracecontext</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">baggage</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">b3</span></span><br><span class="line">  <span class="attr">sampler:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">parentbased_traceidratio</span></span><br><span class="line">    <span class="attr">argument:</span> <span class="string">"1"</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_EXPORTER_OTLP_ENDPOINT</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">otel-collector.default:4318</span></span><br><span class="line">  <span class="attr">java:</span>    </span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_EXPORTER_OTLP_ENDPOINT</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">http://otel-collector.default:4317</span>   </span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>​Instrumentation​​ 由以下属性组成：<br><code>​​exporter.endpoint​</code>​ -（可选）将遥测数据发送到 OTLP 格式的地址。<br><code>​​propagators</code>​​ - 使所有数据源能够共享底层上下文机制，用于在事务的整个生命周期中存储状态和访问数据。<br>​<code>​sampler</code>​​​ - 通过减少收集和发送到后端的跟踪样本数量来引入的噪音和开销的机制。 OpenTelemetry 提供两种类型：​​StaticSampler​​​ 和 ​TraceIDRatioBased​​。<br>语言属性，即​​java​​​、​​nodejs​​​、​​python​​​ 和​​dotnet​​ - 根据 pod 注解中设置的语言，使用自动插桩的自定义镜像</p><p>默认情况下，自动检测 Java 服务的 Instrumentation 资源与协议otlp一起使用http/protobuf。这意味着配置的端点必须能够通过http有效protobuf负载接收 OTLP。因此，示例使用otel-collector.default:4318，它连接到 http上一步中创建的 Collector 的 otlpreceiver 的端口。</p><p>创建java示例应用</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="bullet">-</span> <span class="string">&lt;&lt;EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-sample</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">java-sample</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">java-sample</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="comment">#spec.template.metadata.annotations特定于语言的注解来完成自动检测</span></span><br><span class="line">        <span class="attr">instrumentation.opentelemetry.io/inject-java:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">java-sample</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">pinakispecial/spring-boot-rest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>可用注解：<br>​<code>​true</code>​​ - 从命名空间注入和埋点资源。<br>​<code>​my-instrumentation​​</code>​ - 当前命名空间中注入​​Instrumentation​​ CR 实例的名称。<br>​<code>​my-other-namespace/my-instrumentation</code>​​​ - 另一个命名空间中​​Instrumentation​​ CR 实例的名称和命名空间。<br><code>​​false</code>​​ -不注入。</p><p>可以看到 Otel Operator 向 Pod 中注入了一个 otel 的初始化容器</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  ~ kubectl get pod java-sample-6f688ffb4f-gq95j -o jsonpath=<span class="string">'&#123;.spec.initContainers[*].image&#125; &#123;.spec.containers[*].image&#125;'</span></span><br><span class="line">ghcr.io/open-telemetry/opentelemetry-operator/autoinstrumentation-java:1.33.6 pinakispecial/spring-boot-rest%</span><br></pre></td></tr></table></figure><p>以及在 java 容器中注入了一系列的环境变量进行配置</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_NODE_IP</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">status.hostIP</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_POD_IP</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_EXPORTER_OTLP_ENDPOINT</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">http://otel-collector.default:4317</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_TOOL_OPTIONS</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">' -javaagent:/otel-auto-instrumentation-java/javaagent.jar'</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_SERVICE_NAME</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">java-sample</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_RESOURCE_ATTRIBUTES_POD_NAME</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_RESOURCE_ATTRIBUTES_NODE_NAME</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_PROPAGATORS</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">tracecontext,baggage,b3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_TRACES_SAMPLER</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">parentbased_traceidratio</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_TRACES_SAMPLER_ARG</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">"1"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_RESOURCE_ATTRIBUTES</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">k8s.container.name=java-sample,k8s.deployment.name=java-sample,k8s.namespace.name=default,k8s.node.name=$(OTEL_RESOURCE_ATTRIBUTES_NODE_NAME),k8s.pod.name=$(OTEL_RESOURCE_ATTRIBUTES_POD_NAME),k8s.replicaset.name=java-sample-6f688ffb4f,service.instance.id=default.$(OTEL_RESOURCE_ATTRIBUTES_POD_NAME).java-sample</span></span><br></pre></td></tr></table></figure><p>请求服务接口</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#开放Java服务的端口访问</span></span><br><span class="line">➜  ~ kubectl port-forward java-sample-6f688ffb4f-gq95j 8080:8080</span><br><span class="line">Forwarding from 127.0.0.1:8080 -&gt; 8080</span><br><span class="line">Forwarding from [::1]:8080 -&gt; 8080</span><br><span class="line"><span class="comment">#请求接口</span></span><br><span class="line">➜  ~ curl localhost:8080</span><br><span class="line">OK%</span><br><span class="line"></span><br><span class="line"><span class="comment">#开放Jaeger UI的端口访问</span></span><br><span class="line">➜  ~ kubectl port-forward svc/jaeger 16686:16686</span><br><span class="line">Forwarding from 127.0.0.1:16686 -&gt; 16686</span><br><span class="line">Forwarding from [::1]:16686 -&gt; 16686</span><br></pre></td></tr></table></figure><p>访问 Jaeger UI 查看访问的链路信息<br><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/JaegerUI.png"></p><h4 id="接入prometheus"><a href="#接入prometheus" class="headerlink" title="接入prometheus"></a>接入prometheus</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">helm repo add prometheus-community https://prometheus-community.github.io/helm-charts</span><br><span class="line"></span><br><span class="line">helm show values  prometheus-community/prometheus &gt; values.yaml</span><br><span class="line"></span><br><span class="line">helm install prometheus prometheus-community/prometheus -f values.yaml</span><br><span class="line"></span><br><span class="line">kubectl port-forward svc/prometheus-server 9090:80</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">opentelemetry.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">OpenTelemetryCollector</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">otel-prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">config:</span> <span class="string">|</span></span><br><span class="line">    <span class="attr">receivers:</span></span><br><span class="line">      <span class="attr">otlp:</span></span><br><span class="line">        <span class="attr">protocols:</span></span><br><span class="line">          <span class="attr">grpc:</span></span><br><span class="line">          <span class="attr">http:</span></span><br><span class="line">    <span class="attr">processors:</span></span><br><span class="line">      <span class="attr">memory_limiter:</span></span><br><span class="line">        <span class="attr">check_interval:</span> <span class="string">1s</span></span><br><span class="line">        <span class="attr">limit_percentage:</span> <span class="number">75</span></span><br><span class="line">        <span class="attr">spike_limit_percentage:</span> <span class="number">15</span></span><br><span class="line">      <span class="attr">batch:</span></span><br><span class="line">        <span class="attr">send_batch_size:</span> <span class="number">10000</span></span><br><span class="line">        <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">    <span class="attr">exporters:</span></span><br><span class="line">      <span class="attr">prometheus:</span></span><br><span class="line">        <span class="attr">endpoint:</span> <span class="string">"localhost:9090"</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">pipelines:</span></span><br><span class="line">        <span class="attr">metrics:</span></span><br><span class="line">          <span class="attr">receivers:</span> <span class="string">[otlp]</span></span><br><span class="line">          <span class="attr">processors:</span> <span class="string">[memory_limiter,</span> <span class="string">batch]</span></span><br><span class="line">          <span class="attr">exporters:</span> <span class="string">[prometheus]</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;OpenTelemetry（简称OTel）是一个开源可观测性框架，用于仪表化、生成、收集和导出诸如跟踪、度量、日志等遥测数据&lt;br&gt;&lt;image src=&quot;https://opentelemetry.io/docs/collector/img/otel-collector.</summary>
      
    
    
    
    
    <category term="k8s" scheme="http://nmk0718.github.io/tag/k8s/"/>
    
    <category term="OpenTelemetry" scheme="http://nmk0718.github.io/tag/OpenTelemetry/"/>
    
  </entry>
  
  <entry>
    <title>Tampermonkey屏蔽腾讯云广告</title>
    <link href="http://nmk0718.github.io/2025/01/04/Tampermonkey%E5%B1%8F%E8%94%BD%E8%85%BE%E8%AE%AF%E4%BA%91%E5%B9%BF%E5%91%8A/"/>
    <id>http://nmk0718.github.io/2025/01/04/Tampermonkey%E5%B1%8F%E8%94%BD%E8%85%BE%E8%AE%AF%E4%BA%91%E5%B9%BF%E5%91%8A/</id>
    <published>2025-01-04T03:00:00.000Z</published>
    <updated>2025-01-15T07:32:01.704Z</updated>
    
    <content type="html"><![CDATA[<p>在使用腾讯云控制台过程中遇到很多广告，每次点x后还会弹🤮，影响页面展示。通过油猴脚本进行过滤广告<br>腾讯云原页面<br><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/tencent_ads_cvm.png"><br><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/tencent_ads_cdn.png"><br>通过kimi进行编写脚本，一开始想对接口直接拦截，但是配置后不生效，后续通过页面隐藏元素实现<br>通过F12检查元素查看广告对应的元素<br><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/check_web_element.png"><br>让kimi通过元素进行隐藏，编写油猴脚本，最终脚本如下：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ==UserScript==</span></span><br><span class="line"><span class="comment">// @name         屏蔽特定页面的广告和提示</span></span><br><span class="line"><span class="comment">// @namespace    http://tampermonkey.net/</span></span><br><span class="line"><span class="comment">// @version      0.1</span></span><br><span class="line"><span class="comment">// @description  屏蔽特定页面的广告和提示</span></span><br><span class="line"><span class="comment">// @author       Kimi</span></span><br><span class="line"><span class="comment">// @match        https://console.cloud.tencent.com/*</span></span><br><span class="line"><span class="comment">// @grant        none</span></span><br><span class="line"><span class="comment">// @run-at       document-body</span></span><br><span class="line"><span class="comment">// ==/UserScript==</span></span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="meta">    'use strict'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义一个函数来隐藏元素</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">hideElements</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> currentUrl = <span class="built_in">window</span>.location.href;</span><br><span class="line">        <span class="comment">// 隐藏具有 data-sid="opc-ads" 属性的 ins 元素</span></span><br><span class="line">        <span class="keyword">const</span> ads = <span class="built_in">document</span>.querySelectorAll(<span class="string">'ins[data-sid="opc-ads"]'</span>);</span><br><span class="line">        ads.forEach(<span class="function"><span class="params">ad</span> =&gt;</span> &#123;</span><br><span class="line">            ad.style.display = <span class="string">'none'</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 隐藏所有以 app- 开头并包含 alert 的 div 元素</span></span><br><span class="line">        <span class="keyword">const</span> alerts = <span class="built_in">document</span>.querySelectorAll(<span class="string">'div[class^="app-"][class*="alert"]'</span>);</span><br><span class="line">        alerts.forEach(<span class="function"><span class="params">alert</span> =&gt;</span> &#123;</span><br><span class="line">            alert.style.display = <span class="string">'none'</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (currentUrl.includes(<span class="string">'/cvm/instance/index?rid=1'</span>)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 隐藏具有 class="app-cvm-alert" 的 div 元素</span></span><br><span class="line">            <span class="keyword">const</span> alerts = <span class="built_in">document</span>.querySelectorAll(<span class="string">'div.app-cvm-alert'</span>);</span><br><span class="line">            alerts.forEach(<span class="function"><span class="params">alert</span> =&gt;</span> &#123;</span><br><span class="line">                alert.style.display = <span class="string">'none'</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currentUrl.includes(<span class="string">'/cdn'</span>)) &#123;</span><br><span class="line">            <span class="comment">// 隐藏具有 class="streams-to-eo-ads-bar" 的 div 元素</span></span><br><span class="line">            <span class="keyword">const</span> adsBar = <span class="built_in">document</span>.querySelector(<span class="string">'div.streams-to-eo-ads-bar'</span>);</span><br><span class="line">            <span class="keyword">if</span> (adsBar) &#123;</span><br><span class="line">                adsBar.style.display = <span class="string">'none'</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 隐藏具有 class="streams-to-eo-ads-content" 的 div 元素</span></span><br><span class="line">            <span class="keyword">const</span> adsContent = <span class="built_in">document</span>.querySelector(<span class="string">'div.streams-to-eo-ads-content'</span>);</span><br><span class="line">            <span class="keyword">if</span> (adsContent) &#123;</span><br><span class="line">                adsContent.style.display = <span class="string">'none'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始检查</span></span><br><span class="line">    hideElements();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 MutationObserver 监控 DOM 变化</span></span><br><span class="line">    <span class="keyword">const</span> observer = <span class="keyword">new</span> MutationObserver(<span class="function">(<span class="params">mutations</span>) =&gt;</span> &#123;</span><br><span class="line">        mutations.forEach(<span class="function">(<span class="params">mutation</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (mutation.addedNodes) &#123;</span><br><span class="line">                mutation.addedNodes.forEach(<span class="function">(<span class="params">node</span>) =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (node.nodeType === <span class="number">1</span>) &#123;</span><br><span class="line">                        hideElements();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置观察器选项</span></span><br><span class="line">    <span class="keyword">const</span> config = &#123;</span><br><span class="line">        childList: <span class="literal">true</span>,</span><br><span class="line">        subtree: <span class="literal">true</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始观察整个文档</span></span><br><span class="line">    observer.observe(<span class="built_in">document</span>.body, config);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><p>开启油猴插件后，重新访问腾讯云控制台，可看到屏蔽后效果图<br><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/tencent_cvm.png"><br><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/tencent_cdn.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;在使用腾讯云控制台过程中遇到很多广告，每次点x后还会弹🤮，影响页面展示。通过油猴脚本进行过滤广告&lt;br&gt;腾讯云原页面&lt;br&gt;&lt;img src=&quot;data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcm</summary>
      
    
    
    
    
    <category term="windows" scheme="http://nmk0718.github.io/tag/windows/"/>
    
  </entry>
  
  <entry>
    <title>iterm2</title>
    <link href="http://nmk0718.github.io/2025/01/03/iterm2/"/>
    <id>http://nmk0718.github.io/2025/01/03/iterm2/</id>
    <published>2025-01-03T03:37:00.000Z</published>
    <updated>2025-01-03T05:47:03.891Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h3><ol><li><p>iterm2—&gt;Preferences—&gt;Profiles，配置一个新的profile</p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/jumpserver_profile.png"></li><li><p>iterm2—&gt;Window—&gt;Password Manager，AccountName只是提示，Password配置正确即可</p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/jumpserver_password.png"></li><li><p>对应Profiles里面的Advanced选项，找到Triggers，点击Edit</p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/jumpserver_triggers.png">配置触发打开Password Manager<img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/jumpserver_open_password.png"></li><li><p>配置SSH会话复制、会话保持<br>在~/.ssh/config文件里添加几行配置即可。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 会话复制相关配置</span></span><br><span class="line">Host *</span><br><span class="line">ControlMaster auto</span><br><span class="line">ControlPath ~/.ssh/%r@%h:%p.socket</span><br><span class="line"></span><br><span class="line">ControlPersist yes</span><br><span class="line">ServerAliveInterval 10 <span class="comment"># 每隔10s发一次心跳</span></span><br><span class="line">ServerAliveCountMax 3  <span class="comment"># 三次心跳没响应则关闭连接</span></span><br></pre></td></tr></table></figure></li><li><p><code>command + o</code>选择服务器连接，配置自动关闭窗口</p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/closewindow.png"></li></ol><p>参考文档：<a href="https://blog.csdn.net/weixin_52777294/article/details/112410350" target="_blank" rel="noopener">https://blog.csdn.net/weixin_52777294/article/details/112410350</a></p><h3 id="rzsz"><a href="#rzsz" class="headerlink" title="rzsz"></a>rzsz</h3><ol><li><p>在mac上安装lrzsz</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">brew install lrzsz</span><br></pre></td></tr></table></figure></li><li><p>将iterm2-send-zmodem.sh和iterm2-recv-zmodem.sh脚本保存在/usr/local/bin/<br>iterm2-recv-zmodem.sh</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Author: Matt Mastracci (matthew@mastracci.com)</span></span><br><span class="line"><span class="comment"># AppleScript from http://stackoverflow.com/questions/4309087/cancel-button-on-osascript-in-a-bash-script</span></span><br><span class="line"><span class="comment"># licensed under cc-wiki with attribution required </span></span><br><span class="line"><span class="comment"># Remainder of script public domain</span></span><br><span class="line"></span><br><span class="line">osascript -e <span class="string">'tell application "iTerm2" to version'</span> &gt; /dev/null 2&gt;&amp;1 &amp;&amp; NAME=iTerm2 || NAME=iTerm</span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$NAME</span> = <span class="string">"iTerm"</span> ]]; <span class="keyword">then</span></span><br><span class="line">FILE=$(osascript -e <span class="string">'tell application "iTerm" to activate'</span> -e <span class="string">'tell application "iTerm" to set thefile to choose folder with prompt "Choose a folder to place received files in"'</span> -e <span class="string">"do shell script (\"echo \"&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\"\")"</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">FILE=$(osascript -e <span class="string">'tell application "iTerm2" to activate'</span> -e <span class="string">'tell application "iTerm2" to set thefile to choose folder with prompt "Choose a folder to place received files in"'</span> -e <span class="string">"do shell script (\"echo \"&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\"\")"</span>)</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$FILE</span> = <span class="string">""</span> ]]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> Cancelled.</span><br><span class="line"><span class="comment"># Send ZModem cancel</span></span><br><span class="line"><span class="built_in">echo</span> -e \\x18\\x18\\x18\\x18\\x18</span><br><span class="line">sleep 1</span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> \<span class="comment"># Cancelled transfer</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">cd</span> <span class="string">"<span class="variable">$FILE</span>"</span></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/rz --rename --escape --binary --bufsize 4096 </span><br><span class="line">sleep 1</span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> \<span class="comment"># Sent \-\&gt; $FILE</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p> iterm2-send-zmodem.sh</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Author: Matt Mastracci (matthew@mastracci.com)</span></span><br><span class="line"><span class="comment"># AppleScript from http://stackoverflow.com/questions/4309087/cancel-button-on-osascript-in-a-bash-script</span></span><br><span class="line"><span class="comment"># licensed under cc-wiki with attribution required </span></span><br><span class="line"><span class="comment"># Remainder of script public domain</span></span><br><span class="line"></span><br><span class="line">osascript -e <span class="string">'tell application "iTerm2" to version'</span> &gt; /dev/null 2&gt;&amp;1 &amp;&amp; NAME=iTerm2 || NAME=iTerm</span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$NAME</span> = <span class="string">"iTerm"</span> ]]; <span class="keyword">then</span></span><br><span class="line">FILE=$(osascript -e <span class="string">'tell application "iTerm" to activate'</span> -e <span class="string">'tell application "iTerm" to set thefile to choose file with prompt "Choose a file to send"'</span> -e <span class="string">"do shell script (\"echo \"&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\"\")"</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">FILE=$(osascript -e <span class="string">'tell application "iTerm2" to activate'</span> -e <span class="string">'tell application "iTerm2" to set thefile to choose file with prompt "Choose a file to send"'</span> -e <span class="string">"do shell script (\"echo \"&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\"\")"</span>)</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$FILE</span> = <span class="string">""</span> ]]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> Cancelled.</span><br><span class="line"><span class="comment"># Send ZModem cancel</span></span><br><span class="line"><span class="built_in">echo</span> -e \\x18\\x18\\x18\\x18\\x18</span><br><span class="line">sleep 1</span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> \<span class="comment"># Cancelled transfer</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/sz <span class="string">"<span class="variable">$FILE</span>"</span> --escape --binary --bufsize 4096</span><br><span class="line">sleep 1</span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> \<span class="comment"># Received "$FILE"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></li><li><p>在 iTerm 2 中设置触发器<br>Setting &gt;&gt; Profiles &gt;&gt; 自定义的Profile &gt;&gt; Advanced &gt;&gt; Tiggers &gt;&gt; Edit</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Regular expression: rz waiting to receive.\*\*B0100</span><br><span class="line">Action: Run Silent Coprocess</span><br><span class="line">Parameters: /usr/local/bin/iterm2-send-zmodem.sh</span><br><span class="line">Instant: checked</span><br><span class="line">Enabled: checked</span><br><span class="line"></span><br><span class="line">Regular expression: \*\*B00000000000000</span><br><span class="line">Action: Run Silent Coprocess</span><br><span class="line">Parameters: /usr/local/bin/iterm2-recv-zmodem.sh</span><br><span class="line">Instant: checked</span><br><span class="line">Enabled: checked</span><br></pre></td></tr></table></figure></li></ol><p>在控制台输入rz，选择本地机器上要发送的文件，即可上传文件到服务器,sz filename，在本地机器上选择要接收的文件夹，即可下载到本地<br>参考文档：<a href="https://github.com/robberphex/iTerm2-zmodem" target="_blank" rel="noopener">https://github.com/robberphex/iTerm2-zmodem</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;ssh&quot;&gt;&lt;a href=&quot;#ssh&quot; class=&quot;headerlink&quot; title=&quot;ssh&quot;&gt;&lt;/a&gt;ssh&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;iterm2—&amp;gt;Preferences—&amp;gt;Profiles，配置一个新的profile&lt;/p&gt;
&lt;im</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Windows热点共享5Ghz</title>
    <link href="http://nmk0718.github.io/2024/12/24/Windows%E7%83%AD%E7%82%B9%E5%85%B1%E4%BA%AB5Ghz/"/>
    <id>http://nmk0718.github.io/2024/12/24/Windows%E7%83%AD%E7%82%B9%E5%85%B1%E4%BA%AB5Ghz/</id>
    <published>2024-12-24T05:34:00.000Z</published>
    <updated>2025-02-10T02:35:49.454Z</updated>
    
    <content type="html"><![CDATA[<p>背景：</p><ul><li>办公电脑连接office网络共享热点，自带MacBook Pro连接热点内网办公，实现直接访问内网也不被监控。遇到的问题为连接共享热点后chrome访问页面很慢.</li></ul><p>解决方案:</p><ul><li>MacBook Pro按住option键,点击右上角wifi按钮,可看到为2.4Ghz频率</li><li>Windows打开设备管理器,找到wifi的设备，右键属性,更改为5Ghz<img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/change5g.jpg"></li><li>热点共享,编辑频率,改为5Ghz,打开热点<img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/frequency.jpg"></li><li>MacBook Pro连接后,打开页面很快,查看频率<img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/wifi5Ghz.png"></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;背景：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;办公电脑连接office网络共享热点，自带MacBook Pro连接热点内网办公，实现直接访问内网也不被监控。遇到的问题为连接共享热点后chrome访问页面很慢.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;解决方案:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;MacBo</summary>
      
    
    
    
    
    <category term="windows" scheme="http://nmk0718.github.io/tag/windows/"/>
    
  </entry>
  
  <entry>
    <title>docker容器监控</title>
    <link href="http://nmk0718.github.io/2024/11/26/docker%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7/"/>
    <id>http://nmk0718.github.io/2024/11/26/docker%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7/</id>
    <published>2024-11-26T07:45:00.000Z</published>
    <updated>2024-12-27T06:07:20.063Z</updated>
    
    <content type="html"><![CDATA[<h3 id="背景信息："><a href="#背景信息：" class="headerlink" title="背景信息："></a>背景信息：</h3><blockquote><p>在现代企业运营中，Prometheus 已被广泛部署用于监控 Kubernetes 集群、中间件以及服务器，以实现快速的问题定位和预警。尽管 Prometheus 与 cAdvisor 结合使用可以收集一台机器上所有运行的容器信息，对节点机器上的 CPU 使用情况、内存使用情况、网络吞吐量及文件系统使用情况进行实时监控和性能数据采集，但这种监控方式存在一定的局限性。在监控单个主机内运行容器的服务健康状态方面存在不足。这种局限性可能导致在服务出现故障时无法及时感知，影响服务的连续性和稳定性</p></blockquote><h3 id="目的"><a href="#目的" class="headerlink" title="目的:"></a>目的:</h3><blockquote><p>有效地监控主机内运行的 Docker 容器运行状态，建立一个全面的监控和告警系统，预防服务中断，确保服务的高可用性和业务连续性</p></blockquote><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案:"></a>解决方案:</h3><p>编写GO脚本使用Docker Engine API的/stats端点来获取获取CPU,内存,容器运行状态,进程数。结合 nvidia_gpu_exporter 收集 GPU 指标，并通过 VictoriaMetrics 和 Grafana 实现监控与告警（因有的容器内需要手动激活环境后，启动服务，所以只监控容器状态不能确保容器存活，启动服务不是主进程容器不会挂掉，采用进程的方式更合理）<br>废弃方案:通过cAdvisor的container_processes指标获取进程数量进行监控，但是发现手动安装的没有该指标，k8s的kubelet是有该指标的。</p><h4 id="部署Docker-process-exporter"><a href="#部署Docker-process-exporter" class="headerlink" title="部署Docker_process_exporter"></a>部署Docker_process_exporter</h4><p>机器ip和docker版本：<br>10.1.16.250 Version: 24.0.7</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#把脚本上传到服务器上执行</span></span><br><span class="line">root@VM-ubuntu:~<span class="comment"># rz</span></span><br><span class="line">root@VM-ubuntu:~<span class="comment"># chmod +x Docker_process_exporter_v24.0.7</span></span><br><span class="line">root@VM-ubuntu:~<span class="comment"># nohup ./Docker_process_exporter_v24.0.7  &amp;</span></span><br></pre></td></tr></table></figure><h4 id="采集的指标格式"><a href="#采集的指标格式" class="headerlink" title="采集的指标格式"></a>采集的指标格式</h4><p>使用curl <a href="http://localhost:9190/metrics" target="_blank" rel="noopener">http://localhost:9190/metrics</a> 可以看到当前采集的指标</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#cpu使用率</span></span><br><span class="line">docker_container_cpu_usage&#123;</span><br><span class="line">    containerId=<span class="string">"142b0b391a1862f101623ba4739afa7e2dd45254fef4344fdf1d37cc2adde3e0"</span>, </span><br><span class="line">    containerName=<span class="string">"ailabel"</span>, </span><br><span class="line">    image=<span class="string">"ailabel:v1.9.5"</span>, </span><br><span class="line">    instance=<span class="string">"10.1.16.250:9190"</span>, </span><br><span class="line">    job=<span class="string">"go-process-exporter"</span>, </span><br><span class="line">    status=<span class="string">"running"</span>, </span><br><span class="line">    vmagent_ha=<span class="string">"victoria-metrics/vmagent-ha"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#内存使用率</span></span><br><span class="line">docker_container_mem_usage&#123;</span><br><span class="line">    containerId=<span class="string">"142b0b391a1862f101623ba4739afa7e2dd45254fef4344fdf1d37cc2adde3e0"</span>, </span><br><span class="line">    containerName=<span class="string">"ailabel"</span>, </span><br><span class="line">    image=<span class="string">"ailabel:v1.9.5"</span>, </span><br><span class="line">    instance=<span class="string">"10.1.16.250:9190"</span>, </span><br><span class="line">    job=<span class="string">"go-process-exporter"</span>, </span><br><span class="line">    status=<span class="string">"running"</span>, </span><br><span class="line">    vmagent_ha=<span class="string">"victoria-metrics/vmagent-ha"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#磁盘使用率</span></span><br><span class="line">docker_instance_disk_usage&#123;</span><br><span class="line">    device=<span class="string">"/dev/vda1"</span>, </span><br><span class="line">    instance=<span class="string">"10.1.16.250:9190"</span>, </span><br><span class="line">    job=<span class="string">"go-process-exporter"</span>, </span><br><span class="line">    mountPath=<span class="string">"/"</span>, </span><br><span class="line">    vmagent_ha=<span class="string">"victoria-metrics/vmagent-ha"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#容器运行状态</span></span><br><span class="line">docker_container_info&#123;</span><br><span class="line">    containerId=<span class="string">"142b0b391a1862f101623ba4739afa7e2dd45254fef4344fdf1d37cc2adde3e0"</span>, </span><br><span class="line">    containerName=<span class="string">"ailabel"</span>, </span><br><span class="line">    image=<span class="string">"ailabel:v1.9.5"</span>, </span><br><span class="line">    instance=<span class="string">"10.1.16.250:9190"</span>, </span><br><span class="line">    job=<span class="string">"go-process-exporter"</span>,</span><br><span class="line">    status=<span class="string">"running"</span>, </span><br><span class="line">    vmagent_ha=<span class="string">"victoria-metrics/vmagent-ha"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#容器进程信息</span></span><br><span class="line">docker_container_process_info&#123;</span><br><span class="line">    <span class="built_in">command</span>=<span class="string">"python OpenPCDet/tools/predict_openpcdet_produce.py"</span> </span><br><span class="line">    containerId=<span class="string">"142b0b391a1862f101623ba4739afa7e2dd45254fef4344fdf1d37cc2adde3e0"</span>, </span><br><span class="line">    containerName=<span class="string">"ailabel"</span>, </span><br><span class="line">    image=<span class="string">"ailabel:v1.9.5"</span>, </span><br><span class="line">    instance=<span class="string">"10.1.16.250:9190"</span>, </span><br><span class="line">    job=<span class="string">"go-process-exporter"</span>, </span><br><span class="line">    pid=<span class="string">"14781"</span>, </span><br><span class="line">    vmagent_ha=<span class="string">"victoria-metrics/vmagent-ha"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="配置采集"><a href="#配置采集" class="headerlink" title="配置采集"></a>配置采集</h4><p>新建job,把需要监控的主机和采集间隔填写进去</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">root@VM-victoria-metrics:~#</span> <span class="string">vi</span> <span class="string">/data/victoria-metrics/vmagent-victoriametrics.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">go-process-exporter</span></span><br><span class="line">      <span class="attr">scrape_interval:</span> <span class="string">15s</span></span><br><span class="line">      <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">['10.1.7.151:9190','10.1.7.67:9190','10.1.16.154:9190','10.1.16.250:9190']</span></span><br></pre></td></tr></table></figure><p>加载配置文件</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@VM-victoria-metrics:~<span class="comment"># kubectl apply -f vmagent-victoriametrics.yaml -n victoria-metrics</span></span><br><span class="line">vmagent.operator.victoriametrics.com/vmagent-ha unchanged</span><br></pre></td></tr></table></figure><p>验证是否采集</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">使用victoriametrics的vmui页面进行查询</span><br><span class="line">http://&lt;vmselect&gt;:8481/select/&lt;accountID&gt;/vmui/</span><br><span class="line"></span><br><span class="line">或者使用grafana的Explore进行查询</span><br></pre></td></tr></table></figure><h4 id="配置图表"><a href="#配置图表" class="headerlink" title="配置图表"></a>配置图表</h4><ul><li><p>配置变量<br>通过CVM变量来过滤监控的机器,ContainerName变量来过滤机器内运行的容器<br><br><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image\grafana-cvm.png"><br></p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image\grafana-containername.png"></li><li><p>配置面板<br>CPU使用率</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker_container_cpu_usage&#123;instance=<span class="string">"<span class="variable">$CVM</span>:9190"</span>,status=<span class="string">"running"</span>,containerName=<span class="string">"<span class="variable">$ContainerName</span>"</span>&#125;</span><br></pre></td></tr></table></figure><p>  内存使用率</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker_container_mem_usage&#123;instance=<span class="string">"<span class="variable">$CVM</span>:9190"</span>,status=<span class="string">"running"</span>,containerName=<span class="string">"<span class="variable">$ContainerName</span>"</span>&#125;</span><br></pre></td></tr></table></figure><p>  磁盘使用率</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sum(docker_instance_disk_usage&#123;instance=<span class="string">"<span class="variable">$CVM</span>:9190"</span>&#125;) by (device,mountPath)</span><br></pre></td></tr></table></figure><p>  GPU</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#GPU温度</span></span><br><span class="line">nvidia_smi_temperature_gpu&#123;instance=<span class="string">"<span class="variable">$CVM</span>:9835"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#GPU显存使用量</span></span><br><span class="line">nvidia_smi_memory_used_bytes&#123;instance=<span class="string">"<span class="variable">$CVM</span>:9835"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#GPU显存总量</span></span><br><span class="line">nvidia_smi_memory_total_bytes&#123;instance=<span class="string">"<span class="variable">$CVM</span>:9835"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#GPU使用率</span></span><br><span class="line">(nvidia_smi_memory_used_bytes&#123;instance=<span class="string">"<span class="variable">$CVM</span>:9835"</span>&#125; / nvidia_smi_memory_total_bytes&#123;instance=<span class="string">"<span class="variable">$CVM</span>:9835"</span>&#125;)* 100</span><br></pre></td></tr></table></figure><p>  容器异常运行状态</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#退出状态的容器条数</span></span><br><span class="line">count(docker_container_info&#123;instance=<span class="string">"<span class="variable">$CVM</span>:9190"</span>,status=<span class="string">"exited"</span>&#125;) by (status)</span><br><span class="line"></span><br><span class="line"><span class="comment">#运行中状态的容器条数</span></span><br><span class="line">count(docker_container_info&#123;instance=<span class="string">"<span class="variable">$CVM</span>:9190"</span>,status=<span class="string">"running"</span>&#125;) by (status)</span><br></pre></td></tr></table></figure><p>  容器运行进程数</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#容器内启动的命令+pid+容器名称</span></span><br><span class="line">count(docker_container_process_info&#123;instance=<span class="string">"<span class="variable">$CVM</span>:9190"</span>,containerName=<span class="string">"<span class="variable">$ContainerName</span>"</span>&#125;) by (<span class="built_in">command</span>,pid,containerName)</span><br></pre></td></tr></table></figure></li></ul><h3 id="最终效果图："><a href="#最终效果图：" class="headerlink" title="最终效果图："></a>最终效果图：</h3><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image\grafana.png">]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;背景信息：&quot;&gt;&lt;a href=&quot;#背景信息：&quot; class=&quot;headerlink&quot; title=&quot;背景信息：&quot;&gt;&lt;/a&gt;背景信息：&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;在现代企业运营中，Prometheus 已被广泛部署用于监控 Kubernetes 集群、</summary>
      
    
    
    
    
    <category term="docker" scheme="http://nmk0718.github.io/tag/docker/"/>
    
  </entry>
  
  <entry>
    <title>VictoriaMetrics</title>
    <link href="http://nmk0718.github.io/2024/11/25/VictoriaMetrics/"/>
    <id>http://nmk0718.github.io/2024/11/25/VictoriaMetrics/</id>
    <published>2024-11-25T08:30:00.000Z</published>
    <updated>2025-01-03T08:49:11.655Z</updated>
    
    <content type="html"><![CDATA[<p>VictoriaMetrics 是一款快速、经济高效且可扩展的时间序列数据库。可用作 Prometheus 的长期远程存储。如果提取率低于每秒​​一百万个数据点，建议使用单节点版本，而不是集群版本。</p><p>VictoriaMetrics集群由以下服务组成：</p><ul><li><code>vmstorage</code> 存储原始数据并返回给定标签过滤器在给定时间范围内的查询数据</li><li><code>vminsert</code> 接受采集的数据，并根据指标名称及其所有标签的一致性哈希，将其传播到 vmstorage 节点之间</li><li><code>vmselect</code> 通过从所有配置的 vmstorage 节点获取所需数据来执行传入查询</li><li><code>vmalert</code> 负责告警，和 Prometheus 一样支持纪录、告警两种规则配置与发送告警通知，允许在注解中使用 Go 模板来格式化数据、迭代或执行表达式，支持跨租户发送警报和记录规则</li><li><code>vmagent</code> 负责数据采集，重新标记和过滤收集到的指标，并通过 Prometheus 协议或通过 VictoriaMetrics 协议将它们存储在 VictoriaMetrics 或任何其他存储系统中。<img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://docs.victoriametrics.com/Cluster-VictoriaMetrics_cluster-scheme.webp"></li></ul><p>部署参考文档：<br><a href="https://docs.victoriametrics.com/helm/victoriametrics-operator/" target="_blank" rel="noopener">https://docs.victoriametrics.com/helm/victoriametrics-operator/</a><br><a href="https://docs.victoriametrics.com/cluster-victoriametrics/" target="_blank" rel="noopener">https://docs.victoriametrics.com/cluster-victoriametrics/</a><br><a href="https://zhuanlan.zhihu.com/p/715516533" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/715516533</a></p><p>⚠️本文档中的操作均在本地进行，如需生产部署，请把port-forward转换为ingress转发，vmcluster调整合适的配置.</p><h2 id="VictoriaMetrics-Helm-存储库"><a href="#VictoriaMetrics-Helm-存储库" class="headerlink" title="VictoriaMetrics Helm 存储库"></a>VictoriaMetrics Helm 存储库</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#helm添加repo</span></span><br><span class="line">➜  ~ helm repo add vm https://victoriametrics.github.io/helm-charts/</span><br><span class="line"><span class="string">"vm"</span> has been added to your repositories</span><br><span class="line"></span><br><span class="line"><span class="comment">#helm更新repo</span></span><br><span class="line">➜  ~ helm repo update</span><br><span class="line">Hang tight <span class="keyword">while</span> we grab the latest from your chart repositories...</span><br><span class="line">...Successfully got an update from the <span class="string">"aliyun"</span> chart repository</span><br><span class="line">...Successfully got an update from the <span class="string">"vm"</span> chart repository</span><br><span class="line">Update Complete. ⎈Happy Helming!⎈</span><br><span class="line"></span><br><span class="line"><span class="comment">#helm查看相关服务和版本</span></span><br><span class="line">➜  ~ helm search repo vm/</span><br><span class="line">NAME                           CHART VERSIONAPP VERSIONDESCRIPTION</span><br><span class="line">vm/victoria-logs-single        0.8.2        v1.0.0     Victoria Logs Single version - high-performance...</span><br><span class="line">vm/victoria-metrics-agent      0.14.9       v1.106.1   Victoria Metrics Agent - collects metrics from ...</span><br><span class="line">vm/victoria-metrics-alert      0.12.6       v1.106.1   Victoria Metrics Alert - executes a list of giv...</span><br><span class="line">vm/victoria-metrics-anomaly    1.6.7        v1.18.4    Victoria Metrics Anomaly Detection - a service ...</span><br><span class="line">vm/victoria-metrics-auth       0.7.7        v1.106.1   Victoria Metrics Auth - is a simple auth proxy ...</span><br><span class="line">vm/victoria-metrics-cluster    0.14.12      v1.106.1   Victoria Metrics Cluster version - high-perform...</span><br><span class="line">vm/victoria-metrics-common     0.0.31                  Victoria Metrics Common - contains shared templ...</span><br><span class="line">vm/victoria-metrics-distributed0.5.0        v1.106.1   A Helm chart <span class="keyword">for</span> Running VMCluster on Multiple ...</span><br><span class="line">vm/victoria-metrics-gateway    0.5.7        v1.106.1   Victoria Metrics Gateway - Auth &amp; Rate-Limittin...</span><br><span class="line">vm/victoria-metrics-k8s-stack  0.28.4       v1.106.1   Kubernetes monitoring on VictoriaMetrics stack....</span><br><span class="line">vm/victoria-metrics-operator   0.38.0       v0.49.1    Victoria Metrics Operator</span><br><span class="line">vm/victoria-metrics-single     0.12.7       v1.106.1   Victoria Metrics Single version - high-performa...</span><br></pre></td></tr></table></figure><h2 id="安装-VictoriaMetrics-Operator"><a href="#安装-VictoriaMetrics-Operator" class="headerlink" title="安装 VictoriaMetrics-Operator"></a>安装 VictoriaMetrics-Operator</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#使用命令安装</span></span><br><span class="line">➜  ~ helm install vmo vm/victoria-metrics-operator</span><br><span class="line">NAME: vmo</span><br><span class="line">LAST DEPLOYED: Tue Dec 24 14:38:21 2024</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">victoria-metrics-operator has been installed. Check its status by running:</span><br><span class="line">  kubectl --namespace default get pods -l <span class="string">"app.kubernetes.io/instance=vmo"</span></span><br><span class="line"></span><br><span class="line">Get more information on https://github.com/VictoriaMetrics/helm-charts/tree/master/charts/victoria-metrics-operator.</span><br><span class="line">See <span class="string">"Getting started guide for VM Operator"</span> on https://docs.victoriametrics.com/guides/getting-started-with-vm-operator</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看pod状态</span></span><br><span class="line">➜  ~ kubectl get pods -A | grep <span class="string">'vmo'</span></span><br><span class="line">default       vmo-victoria-metrics-operator-54bf97548f-fj8j7   1/1     Running   0             1m</span><br></pre></td></tr></table></figure><h2 id="安装VictoriaMetrics-Cluster"><a href="#安装VictoriaMetrics-Cluster" class="headerlink" title="安装VictoriaMetrics Cluster"></a>安装VictoriaMetrics Cluster</h2><p>Operator 会根据我们的定义去部署集群,可以通过 kubectl explain VMCluster.spec 来查看对象可配置的属性</p><h4 id="vmcluster-yaml"><a href="#vmcluster-yaml" class="headerlink" title="vmcluster.yaml"></a>vmcluster.yaml</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">operator.victoriametrics.com/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VMCluster</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vmcluster</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">victoria-metrics</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment">#数据保留的时长,默认保留期为 1 个月， 默认单位为 m(月)，支持的单位有 h (hour), d (day), w (week), y (year)</span></span><br><span class="line">  <span class="attr">retentionPeriod:</span> <span class="string">"1w"</span></span><br><span class="line">  <span class="comment">#开启副本，并控制副本数量，会往多个vmstorage插入同一份样本数据</span></span><br><span class="line">  <span class="comment">#replicationFactor: 2</span></span><br><span class="line">  <span class="attr">vmstorage:</span></span><br><span class="line">    <span class="comment">#副本数</span></span><br><span class="line">    <span class="attr">replicaCount:</span> <span class="number">2</span></span><br><span class="line">    <span class="comment">#数据持久化</span></span><br><span class="line">    <span class="attr">storageDataPath:</span> <span class="string">/vm-data</span></span><br><span class="line">    <span class="attr">storage:</span></span><br><span class="line">      <span class="attr">volumeClaimTemplate:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">storageClassName:</span> <span class="string">cbs</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line">    <span class="comment">#资源大小</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">"0.5"</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">500Mi</span></span><br><span class="line">  <span class="attr">vmselect:</span></span><br><span class="line">    <span class="attr">replicaCount:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">cacheMountPath:</span> <span class="string">"/select-cache"</span></span><br><span class="line">    <span class="attr">storage:</span></span><br><span class="line">      <span class="attr">volumeClaimTemplate:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">storageClassName:</span> <span class="string">cbs</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">storage:</span> <span class="string">"2Gi"</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">"0.3"</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">"300Mi"</span></span><br><span class="line">  <span class="attr">vminsert:</span></span><br><span class="line">    <span class="attr">replicaCount:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure><p><code>注意</code>：</p><ul><li>开启replicationFactor，vmagent会产生replicationFactor份冗余数据，需要dedup.minScrapeInterval参数，来去除重复数据。</li><li>开启或修改replicationFactor,可能造成数据部分丢失。</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#根据自定义的配置进行安装</span></span><br><span class="line">➜  ~ kubectl apply -f vmcluster.yaml</span><br><span class="line">vmcluster.operator.victoriametrics.com/vmcluster created</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看是否正常启动</span></span><br><span class="line">➜  ~ kubectl get pods</span><br><span class="line">NAME                                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">vminsert-vmcluster-8587774678-2xxt6              1/1     Running   0          12s</span><br><span class="line">vminsert-vmcluster-8587774678-mplrr              1/1     Running   0          12s</span><br><span class="line">vmo-victoria-metrics-operator-5d4ff4d8f4-gk4gj   1/1     Running   0          3m58s</span><br><span class="line">vmselect-vmcluster-0                             1/1     Running   0          17s</span><br><span class="line">vmselect-vmcluster-1                             1/1     Running   0          17s</span><br><span class="line">vmstorage-vmcluster-0                            1/1     Running   0          23s</span><br><span class="line">vmstorage-vmcluster-1                            1/1     Running   0          23s</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看集群状态信息</span></span><br><span class="line">➜  ~ kubectl get vmclusters</span><br><span class="line">NAME        INSERT COUNT   STORAGE COUNT   SELECT COUNT   AGE   STATUS</span><br><span class="line">vmcluster   2              2               2              63s   operational</span><br><span class="line"></span><br><span class="line"><span class="comment">#获取vminsert服务名</span></span><br><span class="line">➜  ~ kubectl get svc | grep vminsert</span><br><span class="line">vminsert-vmcluster              ClusterIP   10.105.160.47    &lt;none&gt;        8480/TCP                     6m49s</span><br></pre></td></tr></table></figure><h3 id="vmagent-yaml"><a href="#vmagent-yaml" class="headerlink" title="vmagent.yaml"></a>vmagent.yaml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">operator.victoriametrics.com/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VMAgent</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vmagent</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceScrapeNamespaceSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">podScrapeNamespaceSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">podScrapeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">serviceScrapeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">nodeScrapeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">nodeScrapeNamespaceSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">staticScrapeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">staticScrapeNamespaceSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">replicaCount:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">remoteWrite:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">"http://vminsert-vmcluster.default.svc.cluster.local:8480/insert/0/prometheus/api/v1/write"</span></span><br></pre></td></tr></table></figure><blockquote><p>VMAgent的<code>remoteWrite.url</code> 由以下部分组成：</p><ul><li>“service_name.VMCluster_namespace.svc.kubernetes_cluster_domain”<br>在例子中，它是vminsert-vmcluster.default.svc.cluster.local</li></ul></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#根据自定义的配置进行安装</span></span><br><span class="line">➜  ~ kubectl apply -f vmagent.yaml</span><br><span class="line">vmagent.operator.victoriametrics.com/vmagent created</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置本地端口转发访问(生产环境可使用ingress或nodeport转发访问)</span></span><br><span class="line">➜  ~ kubectl port-forward svc/vmagent-vmagent 8429:8429</span><br><span class="line">Forwarding from 127.0.0.1:8429 -&gt; 8429</span><br><span class="line">Forwarding from [::1]:8429 -&gt; 8429</span><br><span class="line">Handling connection <span class="keyword">for</span> 8429</span><br><span class="line">Handling connection <span class="keyword">for</span> 8429</span><br></pre></td></tr></table></figure><p>在浏览器中打开<a href="http://127.0.0.1:8429/targets" target="_blank" rel="noopener">http://127.0.0.1:8429/targets</a> 查看VMAgent是否从 K8s 集群收集指标</p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://docs.victoriametrics.com/guides/getting-started-with-vm-operator/vmcluster.webp"><h2 id="验证-VictoriaMetrics-Cluster"><a href="#验证-VictoriaMetrics-Cluster" class="headerlink" title="验证 VictoriaMetrics Cluster"></a>验证 VictoriaMetrics Cluster</h2><p>获取vmselect服务名</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">➜  ~ kubectl get svc | grep vmselect</span><br><span class="line">vmselect-vmcluster              ClusterIP   None             &lt;none&gt;        8481/TCP                     31m</span><br></pre></td></tr></table></figure><h3 id="安装Grafana"><a href="#安装Grafana" class="headerlink" title="安装Grafana"></a>安装Grafana</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">|</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">grafana</span> <span class="string">grafana/grafana</span> <span class="string">-f</span> <span class="bullet">-</span></span><br><span class="line">  <span class="attr">datasources:</span></span><br><span class="line">    <span class="attr">datasources.yaml:</span></span><br><span class="line">      <span class="attr">apiVersion:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">datasources:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">victoriametrics</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">prometheus</span></span><br><span class="line">          <span class="attr">orgId:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">url:</span> <span class="string">http://vmselect-vmcluster.default.svc.cluster.local:8481/select/0/prometheus/</span></span><br><span class="line">          <span class="attr">access:</span> <span class="string">proxy</span></span><br><span class="line">          <span class="attr">isDefault:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">updateIntervalSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">editable:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">dashboardProviders:</span></span><br><span class="line">   <span class="attr">dashboardproviders.yaml:</span></span><br><span class="line">     <span class="attr">apiVersion:</span> <span class="number">1</span></span><br><span class="line">     <span class="attr">providers:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">'default'</span></span><br><span class="line">       <span class="attr">orgId:</span> <span class="number">1</span></span><br><span class="line">       <span class="attr">folder:</span> <span class="string">''</span></span><br><span class="line">       <span class="attr">type:</span> <span class="string">file</span></span><br><span class="line">       <span class="attr">disableDeletion:</span> <span class="literal">true</span></span><br><span class="line">       <span class="attr">editable:</span> <span class="literal">true</span></span><br><span class="line">       <span class="attr">options:</span></span><br><span class="line">         <span class="attr">path:</span> <span class="string">/var/lib/grafana/dashboards/default</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">dashboards:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">victoriametrics:</span></span><br><span class="line">        <span class="attr">gnetId:</span> <span class="number">11176</span></span><br><span class="line">        <span class="attr">revision:</span> <span class="number">18</span></span><br><span class="line">        <span class="attr">datasource:</span> <span class="string">victoriametrics</span></span><br><span class="line">      <span class="attr">vmagent:</span></span><br><span class="line">        <span class="attr">gnetId:</span> <span class="number">12683</span></span><br><span class="line">        <span class="attr">revision:</span> <span class="number">7</span></span><br><span class="line">        <span class="attr">datasource:</span> <span class="string">victoriametrics</span></span><br><span class="line">      <span class="attr">kubernetes:</span></span><br><span class="line">        <span class="attr">gnetId:</span> <span class="number">14205</span></span><br><span class="line">        <span class="attr">revision:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">datasource:</span> <span class="string">victoriametrics</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h2 id="浏览器验证"><a href="#浏览器验证" class="headerlink" title="浏览器验证"></a>浏览器验证</h2><h3 id="grafana"><a href="#grafana" class="headerlink" title="grafana"></a>grafana</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#查看admin密码</span></span><br><span class="line">➜  ~ kubectl get secret --namespace default grafana -o jsonpath=<span class="string">"&#123;.data.admin-password&#125;"</span> | base64 --decode ; <span class="built_in">echo</span></span><br><span class="line">wVj5Rdl1BuPClRy5qgxrztsaoE8v0e4m05DU1cUW</span><br><span class="line"><span class="comment">#转发配置本地端口转发访问</span></span><br><span class="line">➜  ~ <span class="built_in">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span class="string">"app.kubernetes.io/name=grafana,app.kubernetes.io/instance=grafana"</span> -o jsonpath=<span class="string">"&#123;.items[0].metadata.name&#125;"</span>)</span><br><span class="line">➜  ~ kubectl --namespace default port-forward <span class="variable">$POD_NAME</span> 3000</span><br><span class="line">Forwarding from 127.0.0.1:3000 -&gt; 3000</span><br><span class="line">Forwarding from [::1]:3000 -&gt; 3000</span><br></pre></td></tr></table></figure><p>访问:<code>http://localhost:3000</code><br><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://docs.victoriametrics.com/guides/getting-started-with-vm-operator/vmcluster-grafana1.webp"><br><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://docs.victoriametrics.com/guides/getting-started-with-vm-operator/vmcluster-grafana2.webp"></p><h3 id="vmui"><a href="#vmui" class="headerlink" title="vmui"></a>vmui</h3><p>VictoriaMetrics Cluster提供了用于查询故障排除和探索的 UI</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">➜  ~ kubectl port-forward svc/vmselect-vmcluster 8481:8481</span><br><span class="line">Forwarding from 127.0.0.1:8481 -&gt; 8481</span><br><span class="line">Forwarding from [::1]:8481 -&gt; 8481</span><br></pre></td></tr></table></figure><p>访问:<code>http://localhost:8481/select/0/vmui/</code><br><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/vmui.png"></p><h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><h3 id="监控jvm"><a href="#监控jvm" class="headerlink" title="监控jvm"></a>监控jvm</h3><h4 id="在dce集群创建命名空间"><a href="#在dce集群创建命名空间" class="headerlink" title="在dce集群创建命名空间"></a>在dce集群创建命名空间</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#创建monitor的命名空间</span></span><br><span class="line">➜  ~ kubectl create ns monitor</span><br><span class="line">namespace/monitor created</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看k8s版本</span></span><br><span class="line">➜  ~ kubectl version --short</span><br><span class="line">Flag --short has been deprecated, and will be removed <span class="keyword">in</span> the future. The --short output will become the default.</span><br><span class="line">Client Version: v1.24.0</span><br><span class="line">Kustomize Version: v4.5.4</span><br><span class="line">Server Version: v1.18.20</span><br><span class="line">WARNING: version difference between client (1.24) and server (1.18) exceeds the supported minor version skew of +/-1</span><br></pre></td></tr></table></figure><h4 id="在monitor命名空间中创建serviceaccount："><a href="#在monitor命名空间中创建serviceaccount：" class="headerlink" title="在monitor命名空间中创建serviceaccount："></a>在monitor命名空间中创建serviceaccount：</h4><p>ServiceAccount.yaml</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">k8s</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">kube-prometheus</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">1.18</span><span class="number">.20</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br></pre></td></tr></table></figure><h4 id="创建secret-会自动创建token"><a href="#创建secret-会自动创建token" class="headerlink" title="创建secret,会自动创建token"></a>创建secret,会自动创建token</h4><p>（k8s在1.24版本后创建serviceaccount不会自动创建绑定secret，需要事先创建secret来绑定到serviceaccount）<br>Secret.yaml</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/service-account.name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-k8s-secret</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/service-account-token</span></span><br></pre></td></tr></table></figure><h4 id="创建cluster-role"><a href="#创建cluster-role" class="headerlink" title="创建cluster role"></a>创建cluster role</h4><p>ClusterRole.yaml</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">k8s</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">kube-prometheus</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">1.18</span><span class="number">.20</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/metrics</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="comment">#- endpointslices  对于需要处理数千甚至数万个端点的大型服务，使用EndpointSlice可以提供更好的性能和可扩展性</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br></pre></td></tr></table></figure><h4 id="授权给serviceaccount"><a href="#授权给serviceaccount" class="headerlink" title="授权给serviceaccount"></a>授权给serviceaccount</h4><p>ClusterRoleBinding.yaml</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">k8s</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">kube-prometheus</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">1.18</span><span class="number">.20</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br></pre></td></tr></table></figure><h4 id="在vm集群中创建好dce集群的comfigmap并部署"><a href="#在vm集群中创建好dce集群的comfigmap并部署" class="headerlink" title="在vm集群中创建好dce集群的comfigmap并部署"></a>在vm集群中创建好dce集群的comfigmap并部署</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#查看prometheus-k8s-secret中的token</span></span><br><span class="line">➜  ~ kubectl get secret prometheus-k8s-secret -n monitor -o yaml | grep token</span><br><span class="line">  token: ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNkltUnVibTFSYUVkbVdtTlBUR2hzZHpVd1dEZE9UVWhhZFdKdlJVZHpaMDV2Y1hOcmFqTnNTM1ZVYUhNaWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUp0YjI1cGRHOXlJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbkJ5YjIxbGRHaGxkWE10YXpoekxYTmxZM0psZENJc0ltdDFZbVZ5Ym1WMFpYTXVhVzh2YzJWeWRtbGpaV0ZqWTI5MWJuUXZjMlZ5ZG1salpTMWhZMk52ZFc1MExtNWhiV1VpT2lKd2NtOXRaWFJvWlhWekxXczRjeUlzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJak5rTWpJd01qQm1MVEZsTXpjdE5EaGxaQzFpTVRkbExUazVOMlEwWVRSbVpUUTVOU0lzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwdGIyNXBkRzl5T25CeWIyMWxkR2hsZFhNdGF6aHpJbjAuaVFGRjI3N3U5MGEtODR4aGR0dXVPeUdvWWdZRGpTNWJOQkhEVm1lSUZ3blVqMy1zY3U1RkJfTjhjYVc3d1JhUXNjaDN6Tk0tbWwwSVZUbXRSNjVFREZxVTNiRV85SGlKS1R1UlFfb2NUTVRjQUJKT3I5YnotY19IMFNsSlJlSUN6dlVlM0M1SUxhV2JERkJSRGxfVlRKTXBhVjMxZTlacXN6YTVMRGE5MkJDYldoaldzd2tOR1pSOUppeFVwTW1Mb2dKZFN2Nm0wcjFxelQwU2NjeEw2STRSa2JEUkhDZ1p5ZlhKc1Y3T1d5cmdoT0dwX2FJYTdJUHItbC00dEV0cGhoTFd4MjJMTWFFOW5odkJCZ2dHUVR4a2VDcEY1MWRjSzAtQ3phTjNWV1htckNHajJyT1BzTXdzaVdsOHJ3bk1BdmhYdmVaSGRCVFYwT2dQYkVkWXF3</span><br><span class="line">      &#123;<span class="string">"apiVersion"</span>:<span class="string">"v1"</span>,<span class="string">"kind"</span>:<span class="string">"Secret"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;<span class="string">"kubernetes.io/service-account.name"</span>:<span class="string">"prometheus-k8s"</span>&#125;,<span class="string">"name"</span>:<span class="string">"prometheus-k8s-secret"</span>,<span class="string">"namespace"</span>:<span class="string">"monitor"</span>&#125;,<span class="string">"type"</span>:<span class="string">"kubernetes.io/service-account-token"</span>&#125;</span><br><span class="line"><span class="built_in">type</span>: kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line"><span class="comment">#对token进行base64解密</span></span><br><span class="line">➜  ~ <span class="built_in">echo</span> <span class="string">"ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNkltUnVibTFSYUVkbVdtTlBUR2hzZHpVd1dEZE9UVWhhZFdKdlJVZHpaMDV2Y1hOcmFqTnNTM1ZVYUhNaWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUp0YjI1cGRHOXlJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbkJ5YjIxbGRHaGxkWE10YXpoekxYTmxZM0psZENJc0ltdDFZbVZ5Ym1WMFpYTXVhVzh2YzJWeWRtbGpaV0ZqWTI5MWJuUXZjMlZ5ZG1salpTMWhZMk52ZFc1MExtNWhiV1VpT2lKd2NtOXRaWFJvWlhWekxXczRjeUlzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJak5rTWpJd01qQm1MVEZsTXpjdE5EaGxaQzFpTVRkbExUazVOMlEwWVRSbVpUUTVOU0lzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwdGIyNXBkRzl5T25CeWIyMWxkR2hsZFhNdGF6aHpJbjAuaVFGRjI3N3U5MGEtODR4aGR0dXVPeUdvWWdZRGpTNWJOQkhEVm1lSUZ3blVqMy1zY3U1RkJfTjhjYVc3d1JhUXNjaDN6Tk0tbWwwSVZUbXRSNjVFREZxVTNiRV85SGlKS1R1UlFfb2NUTVRjQUJKT3I5YnotY19IMFNsSlJlSUN6dlVlM0M1SUxhV2JERkJSRGxfVlRKTXBhVjMxZTlacXN6YTVMRGE5MkJDYldoaldzd2tOR1pSOUppeFVwTW1Mb2dKZFN2Nm0wcjFxelQwU2NjeEw2STRSa2JEUkhDZ1p5ZlhKc1Y3T1d5cmdoT0dwX2FJYTdJUHItbC00dEV0cGhoTFd4MjJMTWFFOW5odkJCZ2dHUVR4a2VDcEY1MWRjSzAtQ3phTjNWV1htckNHajJyT1BzTXdzaVdsOHJ3bk1BdmhYdmVaSGRCVFYwT2dQYkVkWXF3"</span> |base64 --decode</span><br></pre></td></tr></table></figure><p>把上面base64 解密后文件写在如下 token里<br>dce-token-configmap.yaml</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">token:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">eyJhbGciOiJSUzI1NiIsImtpZCI6ImRubm1RaEdmWmNPTGhsdzUwWDdOTUhadWJvRUdzZ05vcXNrajNsS3VUaHMifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJtb25pdG9yIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6InByb21ldGhldXMtazhzLXNlY3JldCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJwcm9tZXRoZXVzLWs4cyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjNkMjIwMjBmLTFlMzctNDhlZC1iMTdlLTk5N2Q0YTRmZTQ5NSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDptb25pdG9yOnByb21ldGhldXMtazhzIn0.iQFF277u90a-84xhdtuuOyGoYgYDjS5bNBHDVmeIFwnUj3-scu5FB_N8caW7wRaQsch3zNM-ml0IVTmtR65EDFqU3bE_9HiJKTuRQ_ocTMTcABJOr9bz-c_H0SlJReICzvUe3C5ILaWbDFBRDl_VTJMpaV31e9Zqsza5LDa92BCbWhjWswkNGZR9JixUpMmLogJdSv6m0r1qzT0SccxL6I4RkbDRHCgZyfXJsV7OWyrghOGp_aIa7IPr-l-4tEtphhLWx22LMaE9nhvBBggGQTxkeCpF51dcK0-CzaN3VWXmrCGj2rOPsMwsiWl8rwnMAvhXveZHdBTV0OgPbEdYqw</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dce-token-configmap</span></span><br></pre></td></tr></table></figure><p>部署dce-token-configmap </p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  ~ kubectl apply -f dce-token-configmap.yaml</span><br><span class="line">configmap/dce-token-configmap created</span><br></pre></td></tr></table></figure><h4 id="在vmagent-yaml文件配置采集指标策略"><a href="#在vmagent-yaml文件配置采集指标策略" class="headerlink" title="在vmagent.yaml文件配置采集指标策略"></a>在vmagent.yaml文件配置采集指标策略</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">operator.victoriametrics.com/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VMAgent</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vmagent</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment">#抓取指标的时间间隔</span></span><br><span class="line">  <span class="attr">scrapeInterval:</span> <span class="string">20s</span></span><br><span class="line">  <span class="comment">#vmagent副本数量</span></span><br><span class="line">  <span class="attr">replicaCount:</span> <span class="number">1</span></span><br><span class="line">  <span class="comment">#资源大小</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="number">4</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">8Gi</span></span><br><span class="line">    <span class="attr">limits:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="number">4</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">8Gi</span></span><br><span class="line">  <span class="comment">#挂载dce-token</span></span><br><span class="line">  <span class="attr">volumeMounts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/dce-token/</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dce-token</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">dce-token-configmap</span> </span><br><span class="line">    <span class="attr">name:</span> <span class="string">dce-token</span></span><br><span class="line">  <span class="comment">#远程写入</span></span><br><span class="line">  <span class="attr">remoteWrite:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">"http://vminsert-vmcluster.default.svc.cluster.local:8480/insert/0/prometheus/api/v1/write"</span></span><br><span class="line">  <span class="attr">inlineScrapeConfig:</span> <span class="string">|</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">dce-jvm-exporter</span></span><br><span class="line">      <span class="comment">#是否尊重指标的时间戳</span></span><br><span class="line">      <span class="attr">honor_timestamps:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment">#抓取指标的时间间隔</span></span><br><span class="line">      <span class="attr">scrape_interval:</span> <span class="string">20s</span></span><br><span class="line">      <span class="comment">#抓取指标的超时时间</span></span><br><span class="line">      <span class="attr">scrape_timeout:</span> <span class="string">30s</span></span><br><span class="line">      <span class="comment">#抓取的指标路径</span></span><br><span class="line">      <span class="attr">metrics_path:</span> <span class="string">/actuator/prometheus</span></span><br><span class="line">      <span class="comment">#抓取协议</span></span><br><span class="line">      <span class="attr">scheme:</span> <span class="string">http</span></span><br><span class="line">      <span class="comment">#指定认证的用户名和密码</span></span><br><span class="line">      <span class="attr">basic_auth:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">'actuator'</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">'actuator%2@nmk!@#'</span></span><br><span class="line">      <span class="comment">#跳过 TLS 证书验证</span></span><br><span class="line">      <span class="attr">tls_config:</span></span><br><span class="line">        <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="comment">#Kubernetes API 服务器地址</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">api_server:</span> <span class="string">https://10.30.150.11:16443</span></span><br><span class="line">        <span class="comment">#指定要发现的资源类型(endpoints，service，pod，node，ingress)</span></span><br><span class="line">        <span class="attr">role:</span> <span class="string">pod</span></span><br><span class="line">        <span class="comment">#配置访问 Kubernetes API 的认证和 TLS 设置</span></span><br><span class="line">        <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/dce-token/token</span></span><br><span class="line">        <span class="attr">tls_config:</span></span><br><span class="line">          <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span></span><br><span class="line">          <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">"true"</span></span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">          <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_pod_annotation_prometheus_io_path]</span></span><br><span class="line">          <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__address__,</span> <span class="string">__meta_kubernetes_pod_annotation_prometheus_io_port]</span></span><br><span class="line">          <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1:$2</span></span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">__meta_kubernetes_pod_label_(.+)</span></span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">          <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_namespace]</span></span><br><span class="line">          <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">(.*)</span></span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_pod_name]</span></span><br><span class="line">          <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">(.*)</span></span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">kubernetes_pod_name</span></span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span></span><br></pre></td></tr></table></figure><p>relabel_configs: 过滤和重写目标标签</p><ol><li>source_labels: 指定用于匹配的源标签列表</li><li>separator: 指定分隔符</li><li>regex: 用于匹配 source_labels 提取的值的正则表达式，默认为匹配任意值（.*）</li><li>replacement: 用于替换操作的值</li><li>action：定义了对标签的处理方式，包括：<ul><li>replace：根据 regex 匹配 source_labels 的值，并将其写入 target_label</li><li>keep：仅保留匹配 regex 的标签，其余的将被丢弃</li><li>drop：丢弃匹配 regex 的标签，保留其余的</li><li>labelmap：根据 regex 匹配 Target 实例所有标签的名称，并以匹配到的内容为新的标签名称，其值作为新标签的值</li><li>labeldrop：移除匹配 regex 规则的标签</li><li>labelkeep：移除不匹配 regex 规则的标签，保留匹配的</li></ul></li></ol><p>要监控的Pod 中需要有以下注解才能正常采集</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">annotations:</span><br><span class="line">        prometheus.io/path: /actuator/prometheus</span><br><span class="line">        prometheus.io/port: &quot;20001&quot;</span><br><span class="line">        prometheus.io/scrape: &quot;true&quot;</span><br></pre></td></tr></table></figure><h4 id="加载配置文件："><a href="#加载配置文件：" class="headerlink" title="加载配置文件："></a>加载配置文件：</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  ~ kubectl apply -f vmagent.yaml</span><br><span class="line">vmagent.operator.victoriametrics.com/vmagent configured</span><br></pre></td></tr></table></figure><h4 id="vmagent查看配置是否生效："><a href="#vmagent查看配置是否生效：" class="headerlink" title="vmagent查看配置是否生效："></a>vmagent查看配置是否生效：</h4><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/vmagent-jvm.jpg"><h4 id="Grafana查看面板"><a href="#Grafana查看面板" class="headerlink" title="Grafana查看面板"></a>Grafana查看面板</h4><p>打开Grafana,在Dashboards中import面板ID:4701<br><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/vm-jvm.png"></p><h3 id="监控k8s集群状态"><a href="#监控k8s集群状态" class="headerlink" title="监控k8s集群状态"></a>监控k8s集群状态</h3><h4 id="kube-state-metrics"><a href="#kube-state-metrics" class="headerlink" title="kube-state-metrics"></a>kube-state-metrics</h4><p>选择合适的版本，进行安装部署<br><a href="https://github.com/kubernetes/kube-state-metrics" target="_blank" rel="noopener">https://github.com/kubernetes/kube-state-metrics</a></p><p>采集外部集群需要把kube-state-metrics的service改为NodePort</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- job_name: dce-kube-state-metrics</span><br><span class="line">  honor_timestamps: true</span><br><span class="line">  scrape_interval: 15s</span><br><span class="line">  metrics_path: &apos;/metrics&apos;</span><br><span class="line">  scheme: http</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets: [&apos;10.30.150.1:33987&apos;]</span><br><span class="line">  #指标过大时可使用</span><br><span class="line">  params:</span><br><span class="line">  max_scrape_size: 33554432</span><br></pre></td></tr></table></figure><h4 id="cAdvisor"><a href="#cAdvisor" class="headerlink" title="cAdvisor"></a>cAdvisor</h4><p>⚠️必须要两个bearer_token_file，一个认证apiserver，一个通过apiserver进行cAdvisor采集指标</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- job_name: dce-cadvisor</span><br><span class="line">  metrics_path: /metrics</span><br><span class="line">  scheme: https</span><br><span class="line">  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/dce-token/token</span><br><span class="line">  tls_config:</span><br><span class="line">    insecure_skip_verify: true</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - api_server: https://10.30.150.11:16443</span><br><span class="line">    role: node</span><br><span class="line">    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/dce-token/token</span><br><span class="line">    tls_config:</span><br><span class="line">      insecure_skip_verify: true</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_node_label_(.*)</span><br><span class="line">  - target_label: __address__</span><br><span class="line">    action: replace</span><br><span class="line">    regex: (.*)</span><br><span class="line">    source_labels: [&quot;__address__&quot;]</span><br><span class="line">    replacement: 10.30.150.11:16443</span><br><span class="line">  - source_labels: [__meta_kubernetes_node_name]</span><br><span class="line">    regex: (.*)</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: __metrics_path__</span><br><span class="line">    replacement: /api/v1/nodes/$&#123;1&#125;/proxy/metrics/cadvisor</span><br><span class="line">  metric_relabel_configs:</span><br><span class="line">  - source_labels: [instance]</span><br><span class="line">    separator: ;</span><br><span class="line">    regex: (.+)</span><br><span class="line">    target_label: node</span><br><span class="line">    replacement: $1</span><br><span class="line">    action: replace</span><br></pre></td></tr></table></figure><p>查看大盘<br>打开Grafana,在Dashboards中import面板ID:13105<br><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/vm-k8s.png"></p><h4 id="Node-Exporter"><a href="#Node-Exporter" class="headerlink" title="Node-Exporter"></a>Node-Exporter</h4><p>集群内部可通过VMNodeScrape资源对象进行配置,该资源对象不支持apiserver参数，所以无法采集外部集群的信息<br>VMNodeScrape.yaml</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">operator.victoriametrics.com/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VMNodeScrape</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/metrics</span></span><br><span class="line">  <span class="attr">port:</span> <span class="string">"9111"</span> <span class="comment"># 指定 node-exporter 的端口</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">15s</span></span><br><span class="line">  <span class="comment"># relabelConfigs：  # relabel配置（如果需要）</span></span><br><span class="line">  <span class="comment"># selector:  # 过滤节点（如果需要）'</span></span><br></pre></td></tr></table></figure><p>集群外部通过Vmagent进行采集<br>⚠️通过node-exporter的service改为nodeport进行采集只有一台实例数据，所以改为多targets采集</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- job_name: dce-node-exporter</span><br><span class="line">      honor_timestamps: true</span><br><span class="line">      scrape_interval: 15s</span><br><span class="line">      metrics_path: &apos;/metrics&apos;</span><br><span class="line">      scheme: http</span><br><span class="line">      static_configs:</span><br><span class="line">      - targets: [&apos;10.30.150.1:12921&apos;,&apos;10.30.150.2:12921&apos;,&apos;10.30.150.3:12921&apos;,&apos;10.30.150.4:12921&apos;,&apos;10.30.150.5:12921&apos;,&apos;10.30.150.6:12921&apos;,&apos;10.30.150.8:12921&apos;,&apos;10.30.150.9:12921&apos;,&apos;10.30.150.10:12921&apos;]</span><br></pre></td></tr></table></figure><p>查看大盘<br>打开Grafana,在Dashboards中import面板ID:16098<br><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/vm-nodeexporter.png"></p><h3 id="Vmalert"><a href="#Vmalert" class="headerlink" title="Vmalert"></a>Vmalert</h3><p>vmalert在内存中保存警报状态。重新启动该vmalert进程将重置内存中所有活动警报的状态。为防止vmalert在重新启动时丢失,通过<code>-remote.write.url</code>和<code>-remote.read.url</code>将其配置为将状态持久保存到远程数据库</p><h4 id="安装vmalert和alert-manager"><a href="#安装vmalert和alert-manager" class="headerlink" title="安装vmalert和alert manager"></a>安装vmalert和alert manager</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">|</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">vma</span> <span class="string">vm/victoria-metrics-alert</span> <span class="string">-f</span> <span class="bullet">-</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">datasource:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">http://vmselect-vmcluster.default.svc:8481/select/0/prometheus</span></span><br><span class="line">    <span class="attr">remote:</span></span><br><span class="line">      <span class="attr">write:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">http://vminsert-vmcluster.default.svc:8480/insert/0/prometheus</span></span><br><span class="line">      <span class="attr">read:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">http://vmselect-vmcluster.default.svc:8481/select/0/prometheus</span></span><br><span class="line">      <span class="attr">notifier:</span></span><br><span class="line">        <span class="attr">alertmanager:</span></span><br><span class="line">          <span class="attr">url:</span> <span class="string">http://vma-victoria-metrics-alert-alertmanager.default.svc:9093</span></span><br><span class="line">  <span class="attr">alertmanager:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h4 id="配置alert-manager"><a href="#配置alert-manager" class="headerlink" title="配置alert manager"></a>配置alert manager</h4><p>kubectl edit configmap vma-victoria-metrics-alert-alertmanager-config</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">global:</span><br><span class="line">  smtp_smarthost: &apos;smtp.qq.com:465&apos;</span><br><span class="line">  smtp_from: &apos;2977358239@qq.com&apos;</span><br><span class="line">  smtp_auth_username: &apos;2977358239@qq.com&apos;</span><br><span class="line">  smtp_auth_password: &apos;jgigqzrlhycddhcf&apos; # 这里是邮箱的授权密码，不是登录密码</span><br><span class="line">  smtp_require_tls: false</span><br><span class="line">templates:</span><br><span class="line">  - &apos;/alertmanager/template/*.tmpl&apos;</span><br><span class="line">route:</span><br><span class="line">  group_by: [&apos;severity&apos;, &apos;source&apos;]</span><br><span class="line">  group_wait: 30s</span><br><span class="line">  group_interval: 5m</span><br><span class="line">  repeat_interval: 10m</span><br><span class="line">  receiver: email</span><br><span class="line">receivers:</span><br><span class="line">- name: &apos;email&apos;</span><br><span class="line">  email_configs:</span><br><span class="line">  - to: &apos;nimingkun@ruqimobility.com&apos;</span><br><span class="line">    send_resolved: true</span><br></pre></td></tr></table></figure><h4 id="配置vmalert"><a href="#配置vmalert" class="headerlink" title="配置vmalert"></a>配置vmalert</h4><p>kubectl edit configmap vma-victoria-metrics-alert-server-alert-rules-config</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">groups:</span><br><span class="line">- name: record</span><br><span class="line">  rules:</span><br><span class="line">  - record: job:node_memory_MemFree_bytes:percent  # 记录规则名称</span><br><span class="line">    expr: 100 - (100 * node_memory_MemFree_bytes / node_memory_MemTotal_bytes)</span><br><span class="line">- name: node</span><br><span class="line">  rules:  # 具体的报警规则</span><br><span class="line">  - alert: NodeMemoryUsage  # 报警规则的名称</span><br><span class="line">    expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100 &gt; 30</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      source: node</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Node &#123;&#123;$labels.instance&#125;&#125; High Memory usage detected&quot;</span><br><span class="line">      description: &quot;&#123;&#123;$labels.instance&#125;&#125;: Memory usage is above 30% (current value is: &#123;&#123; $value &#125;&#125;)&quot;</span><br></pre></td></tr></table></figure><p>record规则单独使用，不能与alert规则混合，record规则不需要alert、for、labels和annotations字段<br>record 记录规则的主要作用是将一个给定的表达式的结果保存为一个新的时间序列，这样可以在Grafana等可视化工具中直接使用这些数据，而不需要每次都重新计算表达式。</p><h4 id="alert页面查看是否正常"><a href="#alert页面查看是否正常" class="headerlink" title="alert页面查看是否正常"></a>alert页面查看是否正常</h4><p>kubectl port-forward svc/vma-victoria-metrics-alert-server 8880:8880</p><p>查看所有的 Groups<br><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/vmalert_group.png"><br>查看报警规则列表的状态<br><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/vmalert_state.png"><br>查看报警规则的详细信息<br><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/vmalert_details.png"><br>查看邮箱(⚠️需确保发件邮箱的验证码正确)<br><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/alertmanager_mail.png"></p><p>我们添加的记录规则会通过 remote write 传递给 vminsert 保留下来，我们也可以通过 vmselect 查询到<br><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/vmui_select_record.png"></p><h4 id="排查过滤某些抓取指标过长导致卡主问题"><a href="#排查过滤某些抓取指标过长导致卡主问题" class="headerlink" title="排查过滤某些抓取指标过长导致卡主问题"></a>排查过滤某些抓取指标过长导致卡主问题</h4><p>先去查看vmstorage-vmcluster  vmstorage组件的日志，找到那条指标影响了<br>过滤customer服务的指标收集，在相应的job采集任务下添加如下配置即可</p><ul><li>source_labels: [__meta_kubernetes_pod_label_ruqi_app]<br>action: drop<br>regex: travel-platform-customerservice</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;VictoriaMetrics 是一款快速、经济高效且可扩展的时间序列数据库。可用作 Prometheus 的长期远程存储。如果提取率低于每秒​​一百万个数据点，建议使用单节点版本，而不是集群版本。&lt;/p&gt;
&lt;p&gt;VictoriaMetrics集群由以下服务组成：&lt;/p&gt;
</summary>
      
    
    
    
    
    <category term="k8s" scheme="http://nmk0718.github.io/tag/k8s/"/>
    
    <category term="VictoriaMetrics" scheme="http://nmk0718.github.io/tag/VictoriaMetrics/"/>
    
  </entry>
  
  <entry>
    <title>nginx-ingress配置</title>
    <link href="http://nmk0718.github.io/2024/11/18/nginx-ingress%E9%85%8D%E7%BD%AE%E8%B7%A8%E5%9F%9F/"/>
    <id>http://nmk0718.github.io/2024/11/18/nginx-ingress%E9%85%8D%E7%BD%AE%E8%B7%A8%E5%9F%9F/</id>
    <published>2024-11-18T03:46:00.000Z</published>
    <updated>2024-11-18T07:42:57.730Z</updated>
    
    <content type="html"><![CDATA[<h4 id="配置微信小程序或公众号认证"><a href="#配置微信小程序或公众号认证" class="headerlink" title="配置微信小程序或公众号认证"></a>配置微信小程序或公众号认证</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/configuration-snippet:</span> <span class="string">|</span></span><br><span class="line">      <span class="string">location</span> <span class="string">/MP_verify_CwtbVLWfGpMDmrcy.txt</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">add_header</span> <span class="string">Content-Type</span> <span class="string">text/plain;</span></span><br><span class="line">        <span class="string">return</span> <span class="number">200</span> <span class="string">"CwtbVLWfGpMDmrcy"</span><span class="string">;</span></span><br><span class="line">      <span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="跨域配置"><a href="#跨域配置" class="headerlink" title="跨域配置"></a>跨域配置</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/cors-allow-credentials:</span> <span class="string">'true'</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/cors-allow-headers:</span> <span class="string">&gt;-</span></span><br><span class="line">      <span class="string">DNT,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,X-Forwarded-For,X-CustomHeader,X-Token</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/cors-allow-methods:</span> <span class="string">GET,</span> <span class="string">PUT,</span> <span class="string">POST,</span> <span class="string">DELETE,</span> <span class="string">PATCH,</span> <span class="string">OPTIONS</span></span><br><span class="line">    <span class="comment">#如果cors-allow-origin不能为*，可写死为对应的域名，也可使用下面的方案</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/cors-allow-origin:</span> <span class="string">'*'</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/cors-expose-headers:</span> <span class="string">Version,</span> <span class="string">X-CustomResponseHeader</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/enable-cors:</span> <span class="string">'true'</span></span><br></pre></td></tr></table></figure><p>或</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/server-snippet:</span> <span class="string">&gt;</span></span><br><span class="line">      <span class="string">if</span> <span class="string">($http_origin</span> <span class="string">=</span> <span class="string">''</span><span class="string">)&#123;</span></span><br><span class="line">            <span class="string">set</span> <span class="string">$http_origin</span> <span class="string">"*"</span><span class="string">;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">      <span class="string">add_header</span> <span class="string">Access-Control-Allow-Origin</span> <span class="string">$http_origin;</span></span><br><span class="line"></span><br><span class="line">      <span class="string">add_header</span> <span class="string">'Access-Control-Allow-Credentials'</span> <span class="string">'true'</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line">      <span class="string">add_header</span> <span class="string">'Access-Control-Allow-Headers'</span></span><br><span class="line">      <span class="string">DNT,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,X-Forwarded-For,X-CustomHeader,X-Token;</span></span><br><span class="line"></span><br><span class="line">      <span class="string">add_header</span> <span class="string">'Access-Control-Allow-Methods'</span> <span class="string">'GET, PUT, POST, DELETE,PATCH,OPTIONS'</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line">      <span class="string">add_header</span> <span class="string">'Access-Control-Expose-Headers'</span> <span class="string">'Version,X-CustomResponseHeader'</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line">      <span class="string">proxy_hide_header</span> <span class="string">'Access-Control-Allow-Origin'</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line">      <span class="string">proxy_hide_header</span> <span class="string">'Access-Control-Allow-Credentials'</span><span class="string">;</span></span><br></pre></td></tr></table></figure><h4 id="常用配置"><a href="#常用配置" class="headerlink" title="常用配置"></a>常用配置</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">annotations:</span>    </span><br><span class="line">    <span class="comment">#http请求不会重定向到https</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/proxy-body-size:</span> <span class="string">10m</span></span><br><span class="line">    <span class="comment">#请求允许的最大请求体大小</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">'false'</span></span><br><span class="line">    <span class="comment">#使用默认的后端返回头</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/configuration-snippet:</span> <span class="string">proxy_hide_header</span> <span class="string">none;</span></span><br><span class="line">    <span class="comment">#配置超时等信息</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/server-snippet:</span> <span class="string">|</span> </span><br><span class="line">      <span class="string">client_body_timeout</span> <span class="string">120s;</span></span><br><span class="line">      <span class="string">client_max_body_size</span> <span class="string">1024M;</span></span><br><span class="line">      <span class="string">client_header_buffer_size</span> <span class="string">10k;</span></span><br><span class="line">      <span class="string">proxy_request_buffering</span> <span class="string">off;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;配置微信小程序或公众号认证&quot;&gt;&lt;a href=&quot;#配置微信小程序或公众号认证&quot; class=&quot;headerlink&quot; title=&quot;配置微信小程序或公众号认证&quot;&gt;&lt;/a&gt;配置微信小程序或公众号认证&lt;/h4&gt;&lt;figure class=&quot;highlight yaml</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>限制直连pod访问</title>
    <link href="http://nmk0718.github.io/2024/10/24/%E9%99%90%E5%88%B6%E7%9B%B4%E8%BF%9Epod%E8%AE%BF%E9%97%AE/"/>
    <id>http://nmk0718.github.io/2024/10/24/%E9%99%90%E5%88%B6%E7%9B%B4%E8%BF%9Epod%E8%AE%BF%E9%97%AE/</id>
    <published>2024-10-24T03:30:00.000Z</published>
    <updated>2024-10-24T05:42:28.544Z</updated>
    
    <content type="html"><![CDATA[<p>问题：因公司通过专线与腾讯云打通，导致本地办公网络能直连集群内的pod ip和port进行访问</p><p>解决方案：</p><h4 id="使用NetworkPolicy限制"><a href="#使用NetworkPolicy限制" class="headerlink" title="使用NetworkPolicy限制"></a>使用NetworkPolicy限制</h4><p>进入tke&gt;组件管理&gt;新建&gt;勾选NetworkPolicy组件，进行保存，使用yaml文件创建限制策略</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: NetworkPolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: test-network-policy</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  podSelector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      app: test-app #服务的标签</span><br><span class="line">  policyTypes:</span><br><span class="line">  - Ingress</span><br><span class="line">  ingress:</span><br><span class="line">  - from:</span><br><span class="line">    - ipBlock:</span><br><span class="line">        cidr: 10.3.0.0/16 #允许网段访问</span><br><span class="line">        except:</span><br><span class="line">        - 10.80.0.0/16 #不允许网段访问</span><br><span class="line">    ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 4000</span><br></pre></td></tr></table></figure><p>⚠️如果没有配置组件，创建yaml是不生效的<br>具体参考<br><a href="https://cloud.tencent.com/document/product/457/19793" target="_blank" rel="noopener">https://cloud.tencent.com/document/product/457/19793</a></p><h4 id="给VPC-CNI绑定安全组"><a href="#给VPC-CNI绑定安全组" class="headerlink" title="给VPC-CNI绑定安全组"></a>给VPC-CNI绑定安全组</h4><p>进入tke&gt;组件管理&gt;eniipamd的右侧更新配置&gt;勾选安全组，配置安全组即可<br><a href="https://cloud.tencent.com/document/product/457/50360" target="_blank" rel="noopener">https://cloud.tencent.com/document/product/457/50360</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;问题：因公司通过专线与腾讯云打通，导致本地办公网络能直连集群内的pod ip和port进行访问&lt;/p&gt;
&lt;p&gt;解决方案：&lt;/p&gt;
&lt;h4 id=&quot;使用NetworkPolicy限制&quot;&gt;&lt;a href=&quot;#使用NetworkPolicy限制&quot; class=&quot;headerlin</summary>
      
    
    
    
    
    <category term="k8s" scheme="http://nmk0718.github.io/tag/k8s/"/>
    
  </entry>
  
  <entry>
    <title>Adhell3 阻止广告（三星）</title>
    <link href="http://nmk0718.github.io/2024/09/29/Adhell3/"/>
    <id>http://nmk0718.github.io/2024/09/29/Adhell3/</id>
    <published>2024-09-29T05:35:00.000Z</published>
    <updated>2024-09-29T06:53:17.011Z</updated>
    
    <content type="html"><![CDATA[<h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><ol><li>需要先对三星手机进行adb授权启动黑域</li><li>NotifyRDS-Add-on-Samsung.apk,Adhell3.apk,三星手机</li></ol><p>⚠️本文尝试参考链接中的炼妖壶方案无法激活Adhell3,仅列出安全文件夹的激活步骤</p><h4 id="激活"><a href="#激活" class="headerlink" title="激活"></a>激活</h4><ol><li><p>启用 klms agent</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#黑域内运行命令</span><br><span class="line">pm enable com.samsung.klmsagent</span><br></pre></td></tr></table></figure></li><li><p>安装NotifyRDS-Add-on-Samsung</p></li><li><p>手机设置中开启安全文件夹，把NotifyRDS-Add-on-Samsung安装到安全文件夹中<br>安全文件夹：右上角加号——添加NotifyRDS-Add-on-Samsung</p></li><li><p>卸载手机自身安装的NotifyRDS-Add-on-Samsung<br>手机设置内搜索 <code>设备管理应用程序</code> 对第一个NotifyRDS-Add-on-Samsung进行取消激活和卸载</p></li><li><p>禁用 klms agent</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#黑域内运行命令</span><br><span class="line">pm disable-user com.samsung.klmsagent</span><br></pre></td></tr></table></figure></li><li><p>卸载安全文件夹中的NotifyRDS-Add-on-Samsung<br>安全文件夹：右上角三个点——设置——更多设置——卸载，【取消】将媒体文件移出安全文件</p></li><li><p>安装 Adhell<br>先安装Adhell3到手机内<br>黑域内运行命令</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pm enable com.samsung.klmsagent</span><br></pre></td></tr></table></figure></li></ol><p>手机设置内搜索 <code>设备管理应用程序</code> 对Adhell3进行激活<br>启动Adhell3即可</p><h4 id="配置作用域"><a href="#配置作用域" class="headerlink" title="配置作用域"></a>配置作用域</h4><p>在作用域的订阅源中配置</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https://raw.githubusercontent.com/VeleSila/yhosts/master/hosts</span><br><span class="line">https://raw.githubusercontent.com/AdAway/adaway.github.io/master/hosts.txt</span><br><span class="line">https://hblock.molinero.dev/hosts</span><br></pre></td></tr></table></figure><p>在作用域的白名单中配置</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">errnewlog.umeng.com</span><br><span class="line">errlog.umeng.com</span><br><span class="line">beacon.qq.com</span><br><span class="line">ssl.google-analytics.com</span><br><span class="line">loggw.alipay.com.cn</span><br><span class="line">dataflow.biliapi.com</span><br></pre></td></tr></table></figure><p>在主页启用作用域即可</p><p>参考文档:<br><a href="https://zhuanlan.zhihu.com/p/670139739" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/670139739</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;准备工作&quot;&gt;&lt;a href=&quot;#准备工作&quot; class=&quot;headerlink&quot; title=&quot;准备工作&quot;&gt;&lt;/a&gt;准备工作&lt;/h4&gt;&lt;ol&gt;
&lt;li&gt;需要先对三星手机进行adb授权启动黑域&lt;/li&gt;
&lt;li&gt;NotifyRDS-Add-on-Samsung.ap</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>腾讯云只授权用户tke登陆容器权限</title>
    <link href="http://nmk0718.github.io/2024/09/23/%E8%85%BE%E8%AE%AF%E4%BA%91%E5%8F%AA%E6%8E%88%E6%9D%83%E7%94%A8%E6%88%B7tke%E7%99%BB%E9%99%86%E5%AE%B9%E5%99%A8%E6%9D%83%E9%99%90/"/>
    <id>http://nmk0718.github.io/2024/09/23/%E8%85%BE%E8%AE%AF%E4%BA%91%E5%8F%AA%E6%8E%88%E6%9D%83%E7%94%A8%E6%88%B7tke%E7%99%BB%E9%99%86%E5%AE%B9%E5%99%A8%E6%9D%83%E9%99%90/</id>
    <published>2024-09-23T08:00:00.000Z</published>
    <updated>2025-02-10T02:38:37.772Z</updated>
    
    <content type="html"><![CDATA[<h3 id="授权只读权限"><a href="#授权只读权限" class="headerlink" title="授权只读权限"></a>授权只读权限</h3><h4 id="选择策略生成器"><a href="#选择策略生成器" class="headerlink" title="选择策略生成器"></a>选择策略生成器</h4><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image\RBAC-create.png"><h4 id="选择要授权的账号"><a href="#选择要授权的账号" class="headerlink" title="选择要授权的账号"></a>选择要授权的账号</h4><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image\RBAC-auth-user.png"><h4 id="授权只读权限-1"><a href="#授权只读权限-1" class="headerlink" title="授权只读权限"></a>授权只读权限</h4><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image\RBAC-auth.png"><h3 id="授权容器登录权限"><a href="#授权容器登录权限" class="headerlink" title="授权容器登录权限"></a>授权容器登录权限</h3><h4 id="创建ClusterRole"><a href="#创建ClusterRole" class="headerlink" title="创建ClusterRole"></a>创建ClusterRole</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">cloud.tencent.com/tke-rbac-generated:</span> <span class="string">"true"</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tke:pod-exec</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods/attach</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods/exec</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br></pre></td></tr></table></figure><h4 id="创建RoleBinging授权给用户"><a href="#创建RoleBinging授权给用户" class="headerlink" title="创建RoleBinging授权给用户"></a>创建RoleBinging授权给用户</h4><p>复制只读权限中的相关信息<br><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image\ClusterRoleBinding-yaml.png"></p><p>对账号进行授权容器登录权限</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">cloud.tencent.com/tke-account-nickname:</span> <span class="string">nmk</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">cloud.tencent.com/tke-account:</span> <span class="string">"100023199976"</span></span><br><span class="line">  <span class="attr">name:</span> <span class="number">100023199976</span><span class="string">-Role-pod-exec</span>    </span><br><span class="line">  <span class="comment">#namespace: no-critical-service #填写namespace为针对某个命令空间</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tke:pod-exec</span>    <span class="comment">#指定刚创建的ClusterRole</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="number">100023199976</span><span class="number">-1682220970</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;授权只读权限&quot;&gt;&lt;a href=&quot;#授权只读权限&quot; class=&quot;headerlink&quot; title=&quot;授权只读权限&quot;&gt;&lt;/a&gt;授权只读权限&lt;/h3&gt;&lt;h4 id=&quot;选择策略生成器&quot;&gt;&lt;a href=&quot;#选择策略生成器&quot; class=&quot;headerlink&quot; ti</summary>
      
    
    
    
    
    <category term="k8s" scheme="http://nmk0718.github.io/tag/k8s/"/>
    
  </entry>
  
  <entry>
    <title>arthas</title>
    <link href="http://nmk0718.github.io/2024/09/05/arthas/"/>
    <id>http://nmk0718.github.io/2024/09/05/arthas/</id>
    <published>2024-09-05T03:30:00.000Z</published>
    <updated>2024-09-23T08:42:39.656Z</updated>
    
    <content type="html"><![CDATA[<p>下载</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@platform-green-5d77977ffc-nw8dm:/<span class="comment"># curl -O https://arthas.aliyun.com/arthas-boot.jar</span></span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100  138k  100  138k    0     0   367k      0 --:--:-- --:--:-- --:--:--  367k</span><br></pre></td></tr></table></figure><p>启动</p><p>启动后按1，1为进程ID</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@platform-green-5d77977ffc-nw8dm:/<span class="comment"># java -jar arthas-boot.jar</span></span><br><span class="line">[INFO] JAVA_HOME: /usr/<span class="built_in">local</span>/openjdk-11</span><br><span class="line">[INFO] arthas-boot version: 3.7.2</span><br><span class="line">[INFO] Found existing java process, please choose one and input the serial number of the process, eg : 1. Then hit ENTER.</span><br><span class="line">* [1]: 1 platform-0.5.6-SNAPSHOT.jar</span><br><span class="line">1</span><br><span class="line">[INFO] Start download arthas from remote server: https://arthas.aliyun.com/download/3.7.2?mirror=aliyun</span><br><span class="line">[INFO] Download arthas success.</span><br><span class="line">[INFO] arthas home: /root/.arthas/lib/3.7.2/arthas</span><br><span class="line">[INFO] Try to attach process 1</span><br><span class="line">Picked up JAVA_TOOL_OPTIONS: </span><br><span class="line">[INFO] Attach process 1 success.</span><br><span class="line">[INFO] arthas-client connect 127.0.0.1 3658</span><br><span class="line">  ,---.  ,------. ,--------.,--.  ,--.  ,---.   ,---.                           </span><br><span class="line"> /  O  \ |  .--. <span class="string">''</span>--.  .--<span class="string">'|  '</span>--<span class="string">'  | /  O  \ '</span>   .-<span class="string">'                          </span></span><br><span class="line"><span class="string">|  .-.  ||  '</span>--<span class="string">'.'</span>   |  |   |  .--.  ||  .-.  |`.  `-.                          </span><br><span class="line">|  | |  ||  |\  \    |  |   |  |  |  ||  | |  |.-<span class="string">'    |                         </span></span><br><span class="line"><span class="string">`--'</span> `--<span class="string">'`--'</span> <span class="string">'--'</span>   `--<span class="string">'   `--'</span>  `--<span class="string">'`--'</span> `--<span class="string">'`-----'</span>                          </span><br><span class="line"></span><br><span class="line">wiki       https://arthas.aliyun.com/doc                                        </span><br><span class="line">tutorials  https://arthas.aliyun.com/doc/arthas-tutorials.html                  </span><br><span class="line">version    3.7.2                                                                </span><br><span class="line">main_class                                                                      </span><br><span class="line">pid        1                                                                    </span><br><span class="line">time       2024-09-05 11:31:56</span><br></pre></td></tr></table></figure><p>查看内存信息</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[arthas@1]$ memory</span><br><span class="line">Memory                                                                    used                    total                    max                     usage                    </span><br><span class="line">heap                                                                      2819M                   10240M                   10240M                  27.54%                   </span><br><span class="line">g1_eden_space                                                             816M                    6220M                    -1                      13.12%                   </span><br><span class="line">g1_old_gen                                                                1771M                   3788M                    10240M                  17.30%                   </span><br><span class="line">g1_survivor_space                                                         232M                    232M                     -1                      100.00%                  </span><br><span class="line">nonheap                                                                   349M                    367M                     1256M                   27.85%                   </span><br><span class="line">codeheap_<span class="string">'non-nmethods'</span>                                                   1M                      2M                       5M                      31.82%                   </span><br><span class="line">metaspace                                                                 204M                    215M                     512M                    39.98%                   </span><br><span class="line">codeheap_<span class="string">'profiled_nmethods'</span>                                              65M                     67M                      117M                    56.26%                   </span><br><span class="line">compressed_class_space                                                    23M                     27M                      504M                    4.62%                    </span><br><span class="line">codeheap_<span class="string">'non-profiled_nmethods'</span>                                          54M                     54M                      117M                    46.12%                   </span><br><span class="line">mapped                                                                    0K                      0K                       -                       0.00%                    </span><br><span class="line">direct                                                                    69M                     69M                      -                       100.00%</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;下载&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;root@platform-green-5d77977ffc-nw8dm:/&lt;span cla</summary>
      
    
    
    
    
    <category term="arthas" scheme="http://nmk0718.github.io/tag/arthas/"/>
    
  </entry>
  
  <entry>
    <title>hexo更换字体</title>
    <link href="http://nmk0718.github.io/2024/08/27/hexo%E6%9B%B4%E6%8D%A2%E5%AD%97%E4%BD%93/"/>
    <id>http://nmk0718.github.io/2024/08/27/hexo%E6%9B%B4%E6%8D%A2%E5%AD%97%E4%BD%93/</id>
    <published>2024-08-27T03:30:00.000Z</published>
    <updated>2024-09-20T03:00:25.793Z</updated>
    
    <content type="html"><![CDATA[<h3 id="下载字体"><a href="#下载字体" class="headerlink" title="下载字体"></a>下载字体</h3><p>开源字体</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https://github.com/fontworks-fonts/Klee/tree/master/fonts/ttf</span><br></pre></td></tr></table></figure><p>下载后格式转换 </p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https://www.fontsquirrel.com/tools/webfont-generator</span><br></pre></td></tr></table></figure><p>参考文档：<br><a href="https://blog.csdn.net/qq_30997503/article/details/109551074" target="_blank" rel="noopener">https://blog.csdn.net/qq_30997503/article/details/109551074</a></p><p>下载后复制到 hexo项目的themes/nmk_hexo/source/fonts下</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">➜ ~ tree  Klee_One</span><br><span class="line">Klee_One</span><br><span class="line">├── kleeone-regular-webfont.eot</span><br><span class="line">├── kleeone-regular-webfont.svg</span><br><span class="line">├── kleeone-regular-webfont.ttf</span><br><span class="line">├── kleeone-regular-webfont.woff</span><br><span class="line">└── kleeone-regular-webfont.woff2</span><br></pre></td></tr></table></figure><p>修改themes/nmk_hexo/source/css/font.styl的配置为</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@font-face &#123;</span><br><span class="line">    font-family: &apos;klee_oneregular&apos;;</span><br><span class="line">    src: url(&apos;../fonts/Klee_One/kleeone-regular-webfont.eot&apos;);</span><br><span class="line">    src: url(&apos;../fonts/Klee_One/kleeone-regular-webfont.eot?#iefix&apos;) format(&apos;embedded-opentype&apos;),</span><br><span class="line">         url(&apos;../fonts/Klee_One/kleeone-regular-webfont.woff2&apos;) format(&apos;woff2&apos;),</span><br><span class="line">         url(&apos;../fonts/Klee_One/kleeone-regular-webfont.woff&apos;) format(&apos;woff&apos;),</span><br><span class="line">         url(&apos;../fonts/Klee_One/kleeone-regular-webfont.ttf&apos;) format(&apos;truetype&apos;),</span><br><span class="line">         url(&apos;../fonts/Klee_One/kleeone-regular-webfont.svg#klee_oneregular&apos;) format(&apos;svg&apos;);</span><br><span class="line">    font-weight 300;</span><br><span class="line">    font-style: normal;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$font-family = klee_oneregular</span><br></pre></td></tr></table></figure><p>或者直接使用系统的</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$font-family = Helvetica Neue, Helvetica, PingFang SC, Hiragino Sans GB, Microsoft YaHei, Arial, sans-serif</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;下载字体&quot;&gt;&lt;a href=&quot;#下载字体&quot; class=&quot;headerlink&quot; title=&quot;下载字体&quot;&gt;&lt;/a&gt;下载字体&lt;/h3&gt;&lt;p&gt;开源字体&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=</summary>
      
    
    
    
    
    <category term="hexo" scheme="http://nmk0718.github.io/tag/hexo/"/>
    
  </entry>
  
  <entry>
    <title>helm</title>
    <link href="http://nmk0718.github.io/2024/08/23/helm/"/>
    <id>http://nmk0718.github.io/2024/08/23/helm/</id>
    <published>2024-08-23T08:29:00.000Z</published>
    <updated>2024-11-29T06:44:26.887Z</updated>
    
    <content type="html"><![CDATA[<h3 id="安装helm"><a href="#安装helm" class="headerlink" title="安装helm"></a>安装helm</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mac下载</span></span><br><span class="line">wget https://get.helm.sh/helm-v3.14.3-darwin-amd64.tar.gz</span><br><span class="line"><span class="comment"># linux下载</span></span><br><span class="line">wget https://get.helm.sh/helm-v3.14.3-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">tar zxvf helm-v3.14.3-darwin-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">sudo mv darwin-amd64/helm /usr/<span class="built_in">local</span>/bin/helm</span><br><span class="line"></span><br><span class="line">helm version</span><br><span class="line">version.BuildInfo&#123;Version:<span class="string">"v3.14.3"</span>, GitCommit:<span class="string">"f03cc04caaa8f6d7c3e67cf918929150cf6f3f12"</span>, GitTreeState:<span class="string">"clean"</span>,GoVersion:<span class="string">"go1.21.7"</span>&#125;</span><br></pre></td></tr></table></figure><p>mac需要去 <code>系统设置&gt;隐私与安全性&gt;安全性</code> 允许helm运行</p><h3 id="helm命令"><a href="#helm命令" class="headerlink" title="helm命令"></a>helm命令</h3><h4 id="helm-create"><a href="#helm-create" class="headerlink" title="helm create"></a>helm create</h4><p>该命令用于初始化一个新的 Helm Chart。Helm Chart 是 Kubernetes 应用的包，包含了运行应用所需的所有资源定义。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm create nmk-app</span><br><span class="line">➜ ~ tree nmk-app</span><br><span class="line">nmk-app</span><br><span class="line">├── Chart.yaml</span><br><span class="line">├── charts</span><br><span class="line">├── templates</span><br><span class="line">│   ├── NOTES.txt</span><br><span class="line">│   ├── _helpers.tpl</span><br><span class="line">│   ├── deployment.yaml</span><br><span class="line">│   ├── hpa.yaml</span><br><span class="line">│   ├── ingress.yaml</span><br><span class="line">│   ├── service.yaml</span><br><span class="line">│   ├── serviceaccount.yaml</span><br><span class="line">│   └── tests</span><br><span class="line">│       └── <span class="built_in">test</span>-connection.yaml</span><br><span class="line">└── values.yaml</span><br></pre></td></tr></table></figure><h4 id="helm-install"><a href="#helm-install" class="headerlink" title="helm install"></a>helm install</h4><p>用于将 Helm Chart 安装到 Kubernetes 集群中。它会创建所有定义在 Chart 中的资源。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜ ~ helm install nmk-app nmk-app</span><br><span class="line">NAME: nmk-app</span><br><span class="line">LAST DEPLOYED: Mon Aug 23 16:06:14 2024</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br></pre></td></tr></table></figure><h4 id="helm-upgrade"><a href="#helm-upgrade" class="headerlink" title="helm upgrade"></a>helm upgrade</h4><p>用于升级已安装的 Helm Chart 到新版本。可以修改 Chart 的配置和资源。</p><p>将已有的 release 升级到一个新版本的 chart</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜ ~ helm upgrade nmk-app nmk-app</span><br><span class="line">Release <span class="string">"nmk-app"</span> has been upgraded. Happy Helming!</span><br><span class="line">NAME: nmk-app</span><br><span class="line">LAST DEPLOYED: Mon Aug 26 16:07:57 2024</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 2</span><br><span class="line">TEST SUITE: None</span><br></pre></td></tr></table></figure><h4 id="helm-rollback"><a href="#helm-rollback" class="headerlink" title="helm rollback"></a>helm rollback</h4><p>当 Helm Chart 升级后出现问题时，可以使用该命令回滚到之前的版本。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜ ~ helm rollback nmk-app 1</span><br><span class="line">Rollback was a success! Happy Helming!</span><br><span class="line">➜ ~ kubectl get pod  -n tke-docker-test -l app=nmk-app</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE</span><br><span class="line">nmk-app   1/1     Running   0          8m49s</span><br></pre></td></tr></table></figure><h4 id="helm-lint"><a href="#helm-lint" class="headerlink" title="helm lint"></a>helm lint</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜ ~ helm lint nmk-app</span><br><span class="line">==&gt; Linting nmk-app</span><br><span class="line">[INFO] Chart.yaml: icon is recommended</span><br><span class="line"></span><br><span class="line">1 chart(s) linted, 0 chart(s) failed</span><br><span class="line"><span class="comment">#对1个chart进行了linting（代码审查），并且在审查过程中没有发现任何失败的问题</span></span><br></pre></td></tr></table></figure><h4 id="helm-show"><a href="#helm-show" class="headerlink" title="helm show"></a>helm show</h4><p>用于查看 Helm Chart 的内容，包括模板、配置文件和其他资源的定义。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">显示Chart的信息和元数据</span><br><span class="line"></span><br><span class="line">➜ ~ helm show chart nmk-app</span><br><span class="line">apiVersion: v2</span><br><span class="line">appVersion: 1.16.0</span><br><span class="line">description: A Helm chart <span class="keyword">for</span> Kubernetes</span><br><span class="line">name: nmk-app</span><br><span class="line"><span class="built_in">type</span>: application</span><br><span class="line">version: 0.1.0</span><br></pre></td></tr></table></figure><h4 id="helm-uninstall"><a href="#helm-uninstall" class="headerlink" title="helm uninstall"></a>helm uninstall</h4><p>移除已安装的 Helm Chart。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜ ~ helm uninstall nmk-app</span><br><span class="line">release <span class="string">"nmk-app"</span> uninstalled</span><br></pre></td></tr></table></figure><h4 id="helm-pull"><a href="#helm-pull" class="headerlink" title="helm pull"></a>helm pull</h4><p>从远程仓库下载或拉取一个 Helm Chart 到本地。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜ ~ helm repo add stable https://charts.helm.sh/stable</span><br><span class="line">➜ ~ helm pull stable/mysql --version 1.6.9</span><br><span class="line">常用参数：</span><br><span class="line"></span><br><span class="line">--version：允许指定一个版本约束，用于下载特定版本的 Helm 图表。默认使用latest版本；</span><br><span class="line">--untar：下载Chart后是否自动解压缩。如果设置为<span class="literal">true</span>，则Helm会在下载后自动解压缩</span><br><span class="line">--untardir：指定图表提取到的目录；</span><br><span class="line">--repo：指定从中下载图表的存储库的 URL；</span><br><span class="line">--username和--password：提供访问私人存储库的凭证；</span><br><span class="line">--verify：可以在使用图表之前对其进行验证，确保图表的完整性和安全性。</span><br></pre></td></tr></table></figure><h3 id="制作helm-chart"><a href="#制作helm-chart" class="headerlink" title="制作helm chart"></a>制作helm chart</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm create nmk-app</span><br><span class="line">➜  Downloads tree nmk-app</span><br><span class="line">nmk-test</span><br><span class="line">├── Chart.yaml</span><br><span class="line">├── charts</span><br><span class="line">├── templates</span><br><span class="line">│   ├── NOTES.txt</span><br><span class="line">│   ├── _helpers.tpl</span><br><span class="line">│   ├── deployment.yaml</span><br><span class="line">│   ├── hpa.yaml</span><br><span class="line">│   ├── ingress.yaml</span><br><span class="line">│   ├── service.yaml</span><br><span class="line">│   ├── serviceaccount.yaml</span><br><span class="line">│   └── tests</span><br><span class="line">│       └── <span class="built_in">test</span>-connection.yaml</span><br><span class="line">└── values.yaml</span><br></pre></td></tr></table></figure><p>删除没用的配置文件，只保留以下文件</p><h4 id="deployment-yaml"><a href="#deployment-yaml" class="headerlink" title="deployment.yaml"></a>deployment.yaml</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.appname</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.namespace</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.appname</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.appname</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.appname</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.imagepullsecrets</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.appname</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.env.javaoptions</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">"<span class="template-variable">&#123;&#123; .Values.image.repository &#125;&#125;</span><span class="template-variable">&#123;&#123; .Values.appname &#125;&#125;</span>:<span class="template-variable">&#123;&#123; .Values.image.tag &#125;&#125;</span>"</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.image.pullPolicy</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">lifecycle:</span></span><br><span class="line">            <span class="attr">preStop:</span></span><br><span class="line">              <span class="attr">exec:</span></span><br><span class="line">                <span class="attr">command:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">20s</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/actuator/</span></span><br><span class="line">              <span class="attr">port:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.service.port</span> <span class="string">&#125;&#125;</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">15</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">startupProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/actuator/</span></span><br><span class="line">              <span class="attr">port:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.service.port</span> <span class="string">&#125;&#125;</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.resource.limitCpu</span> <span class="string">&#125;&#125;</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.resource.limitMemory</span> <span class="string">&#125;&#125;</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.resource.requestCpu</span> <span class="string">&#125;&#125;</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.resource.requestMemory</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><h4 id="service-yaml"><a href="#service-yaml" class="headerlink" title="service.yaml"></a>service.yaml</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.appname</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.namespace</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.service.type</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.service.port</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.service.port</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.appname</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.appname</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br></pre></td></tr></table></figure><h4 id="ingress-yaml"><a href="#ingress-yaml" class="headerlink" title="ingress.yaml"></a>ingress.yaml</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">.Values.ingress.enabled</span> <span class="string">-&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">$fullName</span> <span class="string">:=</span> <span class="string">.Values.appName</span> <span class="string">-&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">$svcPort</span> <span class="string">:=</span> <span class="string">.Values.service.port</span> <span class="string">-&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">and</span> <span class="string">.Values.ingress.className</span> <span class="string">(not</span> <span class="string">(semverCompare</span> <span class="string">"&gt;=1.18-0"</span> <span class="string">.Capabilities.KubeVersion.GitVersion))</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">not</span> <span class="string">(hasKey</span> <span class="string">.Values.ingress.annotations</span> <span class="string">"kubernetes.io/ingress.class"</span><span class="string">)</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">$_</span> <span class="string">:=</span> <span class="string">set</span> <span class="string">.Values.ingress.annotations</span> <span class="string">"kubernetes.io/ingress.class"</span> <span class="string">.Values.ingress.className&#125;&#125;</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">semverCompare</span> <span class="string">"&gt;=1.19-0"</span> <span class="string">.Capabilities.KubeVersion.GitVersion</span> <span class="string">-&#125;&#125;</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">else</span> <span class="string">if</span> <span class="string">semverCompare</span> <span class="string">"&gt;=1.14-0"</span> <span class="string">.Capabilities.KubeVersion.GitVersion</span> <span class="string">-&#125;&#125;</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">else</span> <span class="string">-&#125;&#125;</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&#123;&#123;</span> <span class="string">$fullName</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.namespace</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">and</span> <span class="string">.Values.ingress.className</span> <span class="string">(semverCompare</span> <span class="string">"&gt;=1.18-0"</span> <span class="string">.Capabilities.KubeVersion.GitVersion)</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.ingress.className</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">.Values.ingress.tls</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">    <span class="string">&#123;&#123;-</span> <span class="string">range</span> <span class="string">.Values.ingress.tls</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">        <span class="string">&#123;&#123;-</span> <span class="string">range</span> <span class="string">.hosts</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#123;&#123;</span> <span class="string">.</span> <span class="string">|</span> <span class="string">quote</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">&#123;&#123;</span> <span class="string">.secretName</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="string">&#123;&#123;-</span> <span class="string">range</span> <span class="string">.Values.ingress.hosts</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">&#123;&#123;</span> <span class="string">.host</span> <span class="string">|</span> <span class="string">quote</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="string">&#123;&#123;-</span> <span class="string">range</span> <span class="string">.paths</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&#123;&#123;</span> <span class="string">.path</span> <span class="string">&#125;&#125;</span></span><br><span class="line">            <span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">and</span> <span class="string">.pathType</span> <span class="string">(semverCompare</span> <span class="string">"&gt;=1.18-0"</span> <span class="string">$.Capabilities.KubeVersion.GitVersion)</span> <span class="string">&#125;&#125;</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">&#123;&#123;</span> <span class="string">.pathType</span> <span class="string">&#125;&#125;</span></span><br><span class="line">            <span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">semverCompare</span> <span class="string">"&gt;=1.19-0"</span> <span class="string">$.Capabilities.KubeVersion.GitVersion</span> <span class="string">&#125;&#125;</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">&#123;&#123;</span> <span class="string">$fullName</span> <span class="string">&#125;&#125;</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="string">&#123;&#123;</span> <span class="string">$svcPort</span> <span class="string">&#125;&#125;</span></span><br><span class="line">              <span class="string">&#123;&#123;-</span> <span class="string">else</span> <span class="string">&#125;&#125;</span></span><br><span class="line">              <span class="attr">serviceName:</span> <span class="string">&#123;&#123;</span> <span class="string">$fullName</span> <span class="string">&#125;&#125;</span></span><br><span class="line">              <span class="attr">servicePort:</span> <span class="string">&#123;&#123;</span> <span class="string">$svcPort</span> <span class="string">&#125;&#125;</span></span><br><span class="line">              <span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><h4 id="values-yaml"><a href="#values-yaml" class="headerlink" title="values.yaml"></a>values.yaml</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">appname:</span> <span class="string">nmk-app</span></span><br><span class="line"></span><br><span class="line"><span class="attr">namespace:</span> <span class="string">tke-docker-test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">replicaCount:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">image:</span></span><br><span class="line">  <span class="attr">repository:</span> <span class="string">helm-hub.com/nmk/</span></span><br><span class="line">  <span class="attr">pullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">tag:</span> <span class="string">app-20240806110148</span></span><br><span class="line"></span><br><span class="line"><span class="attr">imagepullsecrets:</span> <span class="string">qcloudregistrykey</span></span><br><span class="line"></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="attr">javaoptions:</span> <span class="string">-Xms2g</span> <span class="string">-Xmx2g</span> <span class="string">-XX:MetaspaceSize=512M</span> <span class="string">-XX:MaxMetaspaceSize=512M</span> <span class="string">-Dspring.profiles.active=test</span> <span class="string">-Dspring.cloud.consul.enabled=false</span> <span class="string">-Dtsf.discovery.ribbon.enabled=false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">resource:</span></span><br><span class="line">  <span class="attr">limitCpu:</span> <span class="string">'2'</span></span><br><span class="line">  <span class="attr">limitMemory:</span> <span class="string">2Gi</span></span><br><span class="line">  <span class="attr">requestCpu:</span> <span class="string">'1'</span></span><br><span class="line">  <span class="attr">requestMemory:</span> <span class="string">1Gi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">ingress:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">className:</span> <span class="string">"nginx"</span></span><br><span class="line">  <span class="attr">annotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="comment">#kubernetes.io/ingress.class: nginx</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">nmk.com</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">          <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">  <span class="attr">tls:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">secretName:</span> <span class="string">ssl-2024</span></span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">nmk.com</span></span><br></pre></td></tr></table></figure><h4 id="Chart-yaml"><a href="#Chart-yaml" class="headerlink" title="Chart.yaml"></a>Chart.yaml</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">nmk-app</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">A</span> <span class="string">Helm</span> <span class="string">chart</span> <span class="string">for</span> <span class="string">Kubernetes</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">application</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br><span class="line"><span class="attr">appVersion:</span> <span class="string">"1.16.0"</span></span><br></pre></td></tr></table></figure><h4 id="安装后查看"><a href="#安装后查看" class="headerlink" title="安装后查看"></a>安装后查看</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜ ~ Downloads helm list</span><br><span class="line">nmk-app        default  1       2024-08-26 16:06:14.735267 +0800 CST   deployednmk-app-0.1.0 1.16.0</span><br><span class="line"></span><br><span class="line">➜ ~ Downloads kubectl get pods -n tke-docker-test</span><br><span class="line">nmk-app-6fdc57bd55-gx6mn                                    1/1     Running            0          117s</span><br><span class="line"></span><br><span class="line">➜ ~ Downloads kubectl get service -n tke-docker-test</span><br><span class="line">nmk-app                                    ClusterIP      172.31.159.244   &lt;none&gt;         8080/TCP                        4m14s</span><br><span class="line"></span><br><span class="line">➜ ~ Downloads kubectl get ingress -n tke-docker-test</span><br><span class="line">nmk-app                                 nginx    nmk.com                          10.30.150.3   80, 443   4m24s</span><br></pre></td></tr></table></figure><p>可使用以下参数指定变量进行多应用部署使用</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">--<span class="built_in">set</span> appName=demo --<span class="built_in">set</span> version=v1.1</span><br></pre></td></tr></table></figure><p>参考文献：<br><a href="https://blog.csdn.net/dhf880913/article/details/138125561" target="_blank" rel="noopener">https://blog.csdn.net/dhf880913/article/details/138125561</a><br><a href="https://blog.csdn.net/zhuganlai168/article/details/131483308" target="_blank" rel="noopener">https://blog.csdn.net/zhuganlai168/article/details/131483308</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;安装helm&quot;&gt;&lt;a href=&quot;#安装helm&quot; class=&quot;headerlink&quot; title=&quot;安装helm&quot;&gt;&lt;/a&gt;安装helm&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code</summary>
      
    
    
    
    
    <category term="helm" scheme="http://nmk0718.github.io/tag/helm/"/>
    
  </entry>
  
  <entry>
    <title>容器内安装基础工具</title>
    <link href="http://nmk0718.github.io/2024/07/22/%E5%AE%B9%E5%99%A8%E5%86%85%E5%AE%89%E8%A3%85%E5%9F%BA%E7%A1%80%E5%B7%A5%E5%85%B7/"/>
    <id>http://nmk0718.github.io/2024/07/22/%E5%AE%B9%E5%99%A8%E5%86%85%E5%AE%89%E8%A3%85%E5%9F%BA%E7%A1%80%E5%B7%A5%E5%85%B7/</id>
    <published>2024-07-22T06:25:00.000Z</published>
    <updated>2024-11-29T06:42:37.451Z</updated>
    
    <content type="html"><![CDATA[<p>使用openjdk:8和openjdk:11作为基础镜像构建业务镜像，但是使用中发现镜像里面没有ping、telnet等基础命令</p><h3 id="在容器中使用"><a href="#在容器中使用" class="headerlink" title="在容器中使用:"></a>在容器中使用:</h3><h4 id="将源更换为清华源"><a href="#将源更换为清华源" class="headerlink" title="将源更换为清华源"></a>将源更换为清华源</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &gt; /etc/apt/sources.list &lt;&lt; EOF</span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye main contrib non-free</span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-updates main contrib non-free</span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-backports main contrib non-free</span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/debian-security bullseye-security main contrib non-free</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="安装软件"><a href="#安装软件" class="headerlink" title="安装软件"></a>安装软件</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apt-get clean</span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y curl telnet vim iputils-ping net-tools</span><br></pre></td></tr></table></figure><h4 id="Dockerfile中使用"><a href="#Dockerfile中使用" class="headerlink" title="Dockerfile中使用:"></a>Dockerfile中使用:</h4><figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye main contrib non-free"</span> &gt;/etc/apt/sources.list </span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-updates main contrib non-free"</span> &gt;&gt;/etc/apt/sources.list </span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-backports main contrib non-free"</span> &gt;&gt;/etc/apt/sources.list </span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"deb https://mirrors.tuna.tsinghua.edu.cn/debian-security bullseye-security main contrib non-free"</span> &gt;&gt;/etc/apt/sources.list</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash">  apt-get clean</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash">  apt-get update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash">  apt-get install -y curl telnet vim iputils-ping net-tools</span></span><br></pre></td></tr></table></figure><h3 id="alpine安装telnet、curl等命令"><a href="#alpine安装telnet、curl等命令" class="headerlink" title="alpine安装telnet、curl等命令"></a>alpine安装telnet、curl等命令</h3><p>很多镜像是使用alpine作为基础镜像，体积小，但apline精简了很多基础组件因此调试起来很麻烦，下方总结了常用的alpine组件安装方法：</p><table><thead><tr><th align="center">功能</th><th align="center">命令</th><th align="center">备注</th></tr></thead><tbody><tr><td align="center">镜像加速</td><td align="center">sed -i ‘s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g’ /etc/apk/repositories</td><td align="center">将原装的alpine库替换成国内的ustc库</td></tr><tr><td align="center">apk库更新</td><td align="center">apk update</td><td align="center"></td></tr><tr><td align="center">安装curl</td><td align="center">apk add curl</td><td align="center"></td></tr><tr><td align="center">安装telnet</td><td align="center">apk add busybox-extras</td><td align="center"></td></tr><tr><td align="center">偷懒N合1</td><td align="center">sed -i ‘s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g’ /etc/apk/repositories &amp;&amp; apk update &amp;&amp; apk add curl &amp;&amp; apk add busybox-extras</td><td align="center"></td></tr></tbody></table>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;使用openjdk:8和openjdk:11作为基础镜像构建业务镜像，但是使用中发现镜像里面没有ping、telnet等基础命令&lt;/p&gt;
&lt;h3 id=&quot;在容器中使用&quot;&gt;&lt;a href=&quot;#在容器中使用&quot; class=&quot;headerlink&quot; title=&quot;在容器中使用:&quot;</summary>
      
    
    
    
    
    <category term="k8s" scheme="http://nmk0718.github.io/tag/k8s/"/>
    
    <category term="docker" scheme="http://nmk0718.github.io/tag/docker/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu安装Docker和GPU驱动</title>
    <link href="http://nmk0718.github.io/2023/12/05/Ubuntu%E5%AE%89%E8%A3%85Docker%E5%92%8CGPU%E9%A9%B1%E5%8A%A8/"/>
    <id>http://nmk0718.github.io/2023/12/05/Ubuntu%E5%AE%89%E8%A3%85Docker%E5%92%8CGPU%E9%A9%B1%E5%8A%A8/</id>
    <published>2023-12-05T07:30:00.000Z</published>
    <updated>2024-11-29T06:41:49.378Z</updated>
    
    <content type="html"><![CDATA[<h4 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get install     ca-certificates     curl     gnupg     lsb-release -y</span><br><span class="line">sudo mkdir -p /etc/apt/keyrings</span><br></pre></td></tr></table></figure><h4 id="添加官方GPG密钥："><a href="#添加官方GPG密钥：" class="headerlink" title="添加官方GPG密钥："></a>添加官方GPG密钥：</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</span><br></pre></td></tr></table></figure><h4 id="添加Docker的稳定版本仓库："><a href="#添加Docker的稳定版本仓库：" class="headerlink" title="添加Docker的稳定版本仓库："></a>添加Docker的稳定版本仓库：</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo add-apt-repository &quot;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable&quot;</span><br></pre></td></tr></table></figure><h4 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo useradd docker</span><br><span class="line">sudo usermod -aG docker $USER</span><br></pre></td></tr></table></figure><h4 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h4><p>腾讯云使用</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install docker.io -y</span><br></pre></td></tr></table></figure><h4 id="挂载磁盘"><a href="#挂载磁盘" class="headerlink" title="挂载磁盘"></a>挂载磁盘</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@ubuntu:/var/lib# fdisk -l</span><br><span class="line"></span><br><span class="line">Disk /dev/vda: 50 GiB, 53687091200 bytes, 104857600 sectors</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disklabel type: gpt</span><br><span class="line">Disk identifier: 884D39AE-2030-4231-B486-520515A9ADD7</span><br><span class="line"></span><br><span class="line">Device     Start       End   Sectors Size Type</span><br><span class="line">/dev/vda1   2048      4095      2048   1M BIOS boot</span><br><span class="line">/dev/vda2   4096 104857566 104853471  50G Linux filesystem</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk /dev/vdb: 200 GiB, 214748364800 bytes, 419430400 sectors</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">root@ubuntu:/var/lib# fdisk /dev/vdb</span><br><span class="line"></span><br><span class="line">Welcome to fdisk (util-linux 2.34).</span><br><span class="line">Changes will remain in memory only, until you decide to write them.</span><br><span class="line">Be careful before using the write command.</span><br><span class="line"></span><br><span class="line">Device does not contain a recognized partition table.</span><br><span class="line">Created a new DOS disklabel with disk identifier 0x1c765732.</span><br><span class="line"></span><br><span class="line">Command (m for help): `p`</span><br><span class="line">Disk /dev/vdb: 200 GiB, 214748364800 bytes, 419430400 sectors</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disklabel type: dos</span><br><span class="line">Disk identifier: 0x1c765732</span><br><span class="line"></span><br><span class="line">Command (m for help): `n`</span><br><span class="line">Partition type</span><br><span class="line">   p   primary (0 primary, 0 extended, 4 free)</span><br><span class="line">   e   extended (container for logical partitions)</span><br><span class="line">Select (default p): `p`</span><br><span class="line">Partition number (1-4, default 1):</span><br><span class="line">First sector (2048-419430399, default 2048):</span><br><span class="line">Last sector, +/-sectors or +/-size&#123;K,M,G,T,P&#125; (2048-419430399, default 419430399):</span><br><span class="line"></span><br><span class="line">Created a new partition 1 of type &apos;Linux&apos; and of size 200 GiB.</span><br><span class="line"></span><br><span class="line">Command (m for help): `w`</span><br><span class="line">The partition table has been altered.</span><br><span class="line">Calling ioctl() to re-read partition table.</span><br><span class="line">Syncing disks.</span><br><span class="line"></span><br><span class="line">root@ubuntu:/var/lib# mkfs.ext4 /dev/vdb1</span><br><span class="line">mke2fs 1.45.5 (07-Jan-2020)</span><br><span class="line">Creating filesystem with 52428544 4k blocks and 13107200 inodes</span><br><span class="line">Filesystem UUID: a75b2a51-daa1-4d05-a6ee-0871fb0cf059</span><br><span class="line">Superblock backups stored on blocks:</span><br><span class="line">32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208,</span><br><span class="line">4096000, 7962624, 11239424, 20480000, 23887872</span><br><span class="line"></span><br><span class="line">Allocating group tables: done</span><br><span class="line">Writing inode tables: done</span><br><span class="line">Creating journal (262144 blocks): done</span><br><span class="line">Writing superblocks and filesystem accounting information: done</span><br><span class="line"></span><br><span class="line">root@ubuntu:/var/lib# mkdir /data</span><br><span class="line">root@ubuntu:/# mount /dev/vdb1 /data</span><br><span class="line">root@ubuntu:/# df -h</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">udev             16G     0   16G   0% /dev</span><br><span class="line">tmpfs           3.1G  808K  3.1G   1% /run</span><br><span class="line">/dev/vda2        50G   19G   29G  39% /</span><br><span class="line">tmpfs            16G   24K   16G   1% /dev/shm</span><br><span class="line">tmpfs           5.0M     0  5.0M   0% /run/lock</span><br><span class="line">tmpfs            16G     0   16G   0% /sys/fs/cgroup</span><br><span class="line">tmpfs           3.1G     0  3.1G   0% /run/user/1000</span><br><span class="line">/dev/vdb1       196G   28K  186G   1% /data</span><br></pre></td></tr></table></figure><h4 id="修改存储路径"><a href="#修改存储路径" class="headerlink" title="修改存储路径"></a>修改存储路径</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#Docker的镜像需在大量的存储空间，默认的存储路径在 /var/lib/docker, 可以按实际需求修改存储路径。</span><br><span class="line">#停止docker</span><br><span class="line">systemctl stop docker</span><br><span class="line">#移动目录到新路径</span><br><span class="line">sudo mv /var/lib/docker /data/docker</span><br><span class="line">#做个软链接</span><br><span class="line">ln -s /data/docker /var/lib/docker </span><br><span class="line">#启动docker</span><br><span class="line">systemctl start docker</span><br></pre></td></tr></table></figure><h4 id="安装GPU驱动"><a href="#安装GPU驱动" class="headerlink" title="安装GPU驱动"></a>安装GPU驱动</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">distribution=$(. /etc/os-release;echo $ID$VERSION_ID)</span><br><span class="line">curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -</span><br><span class="line">curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list</span><br><span class="line">sudo apt-get update &amp;&amp; sudo apt-get install -y nvidia-container-toolkit</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><h4 id="验证驱动"><a href="#验证驱动" class="headerlink" title="验证驱动"></a>验证驱动</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo nvidia-smi</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;安装依赖&quot;&gt;&lt;a href=&quot;#安装依赖&quot; class=&quot;headerlink&quot; title=&quot;安装依赖&quot;&gt;&lt;/a&gt;安装依赖&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;</summary>
      
    
    
    
    
    <category term="ubuntu" scheme="http://nmk0718.github.io/tag/ubuntu/"/>
    
    <category term="docker" scheme="http://nmk0718.github.io/tag/docker/"/>
    
  </entry>
  
  <entry>
    <title>coredns域名解析</title>
    <link href="http://nmk0718.github.io/2023/10/12/coredns%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90/"/>
    <id>http://nmk0718.github.io/2023/10/12/coredns%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90/</id>
    <published>2023-10-12T10:20:00.000Z</published>
    <updated>2024-11-29T06:42:53.041Z</updated>
    
    <content type="html"><![CDATA[<p>编辑coredns的配置文件</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl edit configmap coredns -n kube-system</span><br></pre></td></tr></table></figure><p>增加解析</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">hosts</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="string">nacos.com</span></span><br><span class="line">        <span class="string">fallthrough</span></span><br><span class="line">        <span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>以下为示例</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">coredns</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">selfLink:</span> <span class="string">/api/v1/namespaces/kube-system/configmaps/coredns</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">afe82210-48ab-4e74-a190-7d401a8af49a</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">'240420099'</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">'2022-09-29T03:44:33Z'</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">forward_config:</span> <span class="string">''</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">Corefile:</span> <span class="string">|-</span></span><br><span class="line">    <span class="string">.:53</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">errors</span></span><br><span class="line">        <span class="string">health</span></span><br><span class="line">        <span class="string">ready</span></span><br><span class="line">        <span class="string">hosts</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="string">nacos.com</span></span><br><span class="line">        <span class="string">fallthrough</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">        <span class="string">kubernetes</span> <span class="string">cluster.local</span> <span class="string">in-addr.arpa</span> <span class="string">ip6.arpa</span> <span class="string">&#123;</span></span><br><span class="line">           <span class="string">pods</span> <span class="string">insecure</span></span><br><span class="line">           <span class="string">upstream</span></span><br><span class="line">           <span class="string">fallthrough</span> <span class="string">in-addr.arpa</span> <span class="string">ip6.arpa</span></span><br><span class="line">           <span class="string">ttl</span> <span class="number">30</span></span><br><span class="line">        <span class="string">&#125;</span>      </span><br><span class="line">       <span class="string">prometheus</span> <span class="string">:9153</span></span><br><span class="line">        <span class="string">log</span> <span class="string">.</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="string">class</span> <span class="string">all</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">        <span class="string">cache</span> <span class="number">30</span></span><br><span class="line">        <span class="string">loop</span></span><br><span class="line">        <span class="string">reload</span></span><br><span class="line">        <span class="string">loadbalance</span></span><br><span class="line">        <span class="string">forward</span> <span class="string">.</span> <span class="string">/etc/resolv.conf</span></span><br><span class="line">    <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;编辑coredns的配置文件&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl edit configmap coredns -n k</summary>
      
    
    
    
    
    <category term="k8s" scheme="http://nmk0718.github.io/tag/k8s/"/>
    
  </entry>
  
  <entry>
    <title>istio</title>
    <link href="http://nmk0718.github.io/2022/08/11/istio/"/>
    <id>http://nmk0718.github.io/2022/08/11/istio/</id>
    <published>2022-08-11T06:43:00.000Z</published>
    <updated>2024-11-29T06:44:33.324Z</updated>
    
    <content type="html"><![CDATA[<p>安装 Istio</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@master-01 ~]# istioctl install --set profile=demo -y</span><br><span class="line">✔ Istio core installed</span><br><span class="line">✔ Istiod installed</span><br><span class="line">✔ Egress gateways installed</span><br><span class="line">✔ Ingress gateways installed</span><br><span class="line">✔ Installation complete</span><br></pre></td></tr></table></figure><p>创建命名空间</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@master-01 ~]# kubectl create ns tnmk</span><br><span class="line">namespace/tnmk created</span><br></pre></td></tr></table></figure><p>Istio 默认<a href="https://istio.io/latest/zh/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection" target="_blank" rel="noopener">自动注入 Sidecar</a>. 为 tnmk 命名空间打上标签 <code>istio-injection=enabled</code>：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@master-01 ~]# kubectl label namespace tnmk istio-injection=enabled</span><br><span class="line">namespace/tnmk labeled</span><br></pre></td></tr></table></figure><p><a href="https://raw.githubusercontent.com/istio/istio/release-1.14/samples/bookinfo/platform/kube/bookinfo.yaml" target="_blank" rel="noopener">bookinfo.yaml</a></p><p>使用 <code>kubectl</code> 部署应用</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@master-01 ~]# kubectl apply -f bookinfo.yaml -n tnmk</span><br><span class="line">service/details created</span><br><span class="line">serviceaccount/bookinfo-details created</span><br><span class="line">deployment.apps/details-v1 created</span><br><span class="line">service/ratings created</span><br><span class="line">serviceaccount/bookinfo-ratings created</span><br><span class="line">deployment.apps/ratings-v1 created</span><br><span class="line">service/reviews created</span><br><span class="line">serviceaccount/bookinfo-reviews created</span><br><span class="line">deployment.apps/reviews-v1 created</span><br><span class="line">deployment.apps/reviews-v2 created</span><br><span class="line">deployment.apps/reviews-v3 created</span><br><span class="line">service/productpage created</span><br><span class="line">serviceaccount/bookinfo-productpage created</span><br><span class="line">deployment.apps/productpage-v1 created</span><br></pre></td></tr></table></figure><p>确认所有的服务和 Pod 都已经启动</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@master-01 ~]# kubectl get services -n tnmk</span><br><span class="line">NAME          TYPE        CLUSTER-IP        EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">details       ClusterIP   172.101.98.173    &lt;none&gt;        9080/TCP   112s</span><br><span class="line">productpage   ClusterIP   172.101.139.235   &lt;none&gt;        9080/TCP   112s</span><br><span class="line">ratings       ClusterIP   172.101.24.172    &lt;none&gt;        9080/TCP   112s</span><br><span class="line">reviews       ClusterIP   172.101.40.212    &lt;none&gt;        9080/TCP   112s</span><br><span class="line">[root@master-01 ~]# kubectl get pods -n tnmk</span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">details-v1-7d88846999-hggx9       2/2     Running   0          3m23s</span><br><span class="line">productpage-v1-7795568889-tqjrv   2/2     Running   0          3m23s</span><br><span class="line">ratings-v1-754f9c4975-tqrqj       2/2     Running   0          3m23s</span><br><span class="line">reviews-v1-55b668fc65-nns2c       2/2     Running   0          3m23s</span><br><span class="line">reviews-v2-858f99c99-l8vv5        2/2     Running   0          3m23s</span><br><span class="line">reviews-v3-7886dd86b9-wpkkl       2/2     Running   0          3m23s</span><br></pre></td></tr></table></figure><p>要确认 Bookinfo 应用是否正在运行，请在某个 Pod 中用 <code>curl</code> 命令对应用发送请求，例如 <code>ratings</code>：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@master-01 ~]# kubectl exec -it -n tnmk $(kubectl get pod -l app=ratings -n tnmk -o jsonpath=&apos;&#123;.items[0].metadata.name&#125;&apos;) -c ratings -- curl productpage:9080/productpage | grep -o &quot;&lt;title&gt;.*&lt;/title&gt;&quot;</span><br><span class="line">&lt;title&gt;Simple Bookstore App&lt;/title&gt;</span><br></pre></td></tr></table></figure><p>为应用程序定义 Ingress 网关</p><p><a href="https://raw.githubusercontent.com/istio/istio/release-1.14/samples/bookinfo/networking/bookinfo-gateway.yaml" target="_blank" rel="noopener">bookinfo-gateway.yaml</a></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@master-01 ~]# kubectl apply -f bookinfo-gateway.yaml -n tnmk</span><br><span class="line">gateway.networking.istio.io/bookinfo-gateway created</span><br><span class="line">virtualservice.networking.istio.io/bookinfo created</span><br></pre></td></tr></table></figure><p>查看规则</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl get VirtualService -A</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;安装 Istio&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[root@master-01 ~]# istioctl install --s</summary>
      
    
    
    
    
    <category term="istio" scheme="http://nmk0718.github.io/tag/istio/"/>
    
  </entry>
  
  <entry>
    <title>verdaccio</title>
    <link href="http://nmk0718.github.io/2022/06/20/verdaccio/"/>
    <id>http://nmk0718.github.io/2022/06/20/verdaccio/</id>
    <published>2022-06-20T11:20:00.000Z</published>
    <updated>2024-11-29T06:41:44.874Z</updated>
    
    <content type="html"><![CDATA[<p>yum指定node版本</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl --silent --location https://rpm.nodesource.com/setup_12.x | sudo bash -</span><br></pre></td></tr></table></figure><p>安装node</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum -y install nodejs</span><br></pre></td></tr></table></figure><p>查看node版本</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">node -v</span><br></pre></td></tr></table></figure><p>全局安装verdaccio</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install verdaccio -g</span><br></pre></td></tr></table></figure><p>查看版本号</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">verdaccio  -v</span><br></pre></td></tr></table></figure><p>复制两个配置文件到/root/.config/下</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">config.yaml  htpasswd</span><br></pre></td></tr></table></figure><p>拷贝私服库的包到服务器的/data下 解压</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tar zxvf /data/npm-storage.tar</span><br></pre></td></tr></table></figure><p>启动</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">verdaccio</span><br><span class="line"></span><br><span class="line"> info --- Creating default config file in /root/.config/verdaccio/config.yaml</span><br><span class="line"> warn --- config file  - /root/.config/verdaccio/config.yaml</span><br><span class="line">(node:1835) Warning: Verdaccio doesn't need superuser privileges. don't run it under root</span><br><span class="line">(node:1835) Warning: Verdaccio doesn't need superuser privileges. don't run it under root</span><br><span class="line"> warn --- "crypt" algorithm is deprecated consider switch to "bcrypt". Read more: https://github.com/verdaccio/monorepo/pull/580</span><br><span class="line"> info --- plugin successfully loaded: verdaccio-htpasswd</span><br><span class="line"> info --- plugin successfully loaded: verdaccio-audit</span><br><span class="line"> warn --- http address - http://localhost:4873/ - verdaccio/5.13.0</span><br></pre></td></tr></table></figure><p>访问页面</p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/image-20220620192826502.png"><p>注册成服务</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> vi /etc/systemd/system/verdaccio.service</span><br><span class="line"> </span><br><span class="line">[Unit]</span><br><span class="line">Description=Verdaccio lightweight npm proxy registry</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">Restart=on-failure</span><br><span class="line">#User=root</span><br><span class="line">ExecStart=/usr/bin/verdaccio --config /root/.config/verdaccio/config.yaml</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>重新加载,配置开机启动</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable verdaccio.service</span><br></pre></td></tr></table></figure><p>使用服务启动</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl start verdaccio.service</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;yum指定node版本&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;curl --silent --location https://rpm.</summary>
      
    
    
    
    
    <category term="verdaccio" scheme="http://nmk0718.github.io/tag/verdaccio/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes查看pod关联的pvc</title>
    <link href="http://nmk0718.github.io/2022/06/13/Kubernetes%E6%9F%A5%E7%9C%8Bpod%E5%85%B3%E8%81%94%E7%9A%84pvc/"/>
    <id>http://nmk0718.github.io/2022/06/13/Kubernetes%E6%9F%A5%E7%9C%8Bpod%E5%85%B3%E8%81%94%E7%9A%84pvc/</id>
    <published>2022-06-13T09:20:00.000Z</published>
    <updated>2025-01-05T15:55:13.020Z</updated>
    
    <content type="html"><![CDATA[<h3 id="kubernetes-查看哪些-pod-正在使用-pvc"><a href="#kubernetes-查看哪些-pod-正在使用-pvc" class="headerlink" title="kubernetes 查看哪些 pod 正在使用 pvc"></a>kubernetes 查看哪些 pod 正在使用 pvc</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s ~]<span class="comment"># cat pvc-pod.sh</span></span><br><span class="line">kubectl get pods --all-namespaces -o=json | jq -c <span class="string">'.items[] | &#123;name: .metadata.name, namespace: .metadata.namespace, claimName:.spec.volumes[] | select( has ("persistentVolumeClaim") ).persistentVolumeClaim.claimName &#125;'</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s ~]# sh pvc-pod.sh</span><br><span class="line">&#123;&quot;name&quot;:&quot;archery-mysql-master-0&quot;,&quot;namespace&quot;:&quot;archery&quot;,&quot;claimName&quot;:&quot;data-archery-mysql-master-0&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;clash-d59b74867-rlj7j&quot;,&quot;namespace&quot;:&quot;default&quot;,&quot;claimName&quot;:&quot;ruleset-cache&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;sonarqube-postgresql-postgresql-0&quot;,&quot;namespace&quot;:&quot;default&quot;,&quot;claimName&quot;:&quot;data-sonarqube-postgresql-postgresql-0&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;sonarqube-sonarqube-7b548fdb4f-45ww8&quot;,&quot;namespace&quot;:&quot;default&quot;,&quot;claimName&quot;:&quot;sonarqube-sonarqube&quot;&#125;</span><br></pre></td></tr></table></figure><h3 id="查看k8s集群有哪些在使用的端口对应的服务"><a href="#查看k8s集群有哪些在使用的端口对应的服务" class="headerlink" title="查看k8s集群有哪些在使用的端口对应的服务"></a>查看k8s集群有哪些在使用的端口对应的服务</h3><p>导出所有svc到文本</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl get svc --all-namespaces &gt;svc.txt</span><br></pre></td></tr></table></figure><p>过滤nodeport显示</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">grep NodePort svc.txt</span><br></pre></td></tr></table></figure><p>通过NodePort可知道映射的服务</p><h4 id="缩减所有空间的pod副本数为0"><a href="#缩减所有空间的pod副本数为0" class="headerlink" title="缩减所有空间的pod副本数为0"></a>缩减所有空间的pod副本数为0</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl get ns -o name | awk &apos;&#123;print $1&#125;&apos; |awk -F &apos;/&apos; &apos;&#123;print $2&#125;&apos; &gt;ns.txt</span><br></pre></td></tr></table></figure><h4 id="缩减所有空间的deployment副本数为0"><a href="#缩减所有空间的deployment副本数为0" class="headerlink" title="缩减所有空间的deployment副本数为0"></a>缩减所有空间的deployment副本数为0</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat start.sh</span><br><span class="line"></span><br><span class="line">while read line</span><br><span class="line"></span><br><span class="line">do</span><br><span class="line"></span><br><span class="line">echo $line</span><br><span class="line">kubectl scale --replicas=0 $(kubectl get deploy -o name -n $line) -n $line</span><br><span class="line"></span><br><span class="line">done &lt; ns.txt</span><br></pre></td></tr></table></figure><p>./start.sh</p><h3 id="缩减所有空间的statefulsets副本数为0"><a href="#缩减所有空间的statefulsets副本数为0" class="headerlink" title="缩减所有空间的statefulsets副本数为0"></a>缩减所有空间的statefulsets副本数为0</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat start.sh</span><br><span class="line"></span><br><span class="line">while read line</span><br><span class="line"></span><br><span class="line">do</span><br><span class="line"></span><br><span class="line">echo $line</span><br><span class="line">kubectl scale --replicas=0 $(kubectl get statefulsets -o name -n $line) -n $line</span><br><span class="line"></span><br><span class="line">done &lt; ns.txt</span><br></pre></td></tr></table></figure><p>./start.sh</p><p><a href="https://www.e-learn.cn/topic/3816776" target="_blank" rel="noopener">https://www.e-learn.cn/topic/3816776</a></p><p>使用<code>kubectl delete jobs --all</code>可以删除当前namespaces下所有的job</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;kubernetes-查看哪些-pod-正在使用-pvc&quot;&gt;&lt;a href=&quot;#kubernetes-查看哪些-pod-正在使用-pvc&quot; class=&quot;headerlink&quot; title=&quot;kubernetes 查看哪些 pod 正在使用 pvc&quot;&gt;&lt;/a&gt;ku</summary>
      
    
    
    
    
    <category term="k8s" scheme="http://nmk0718.github.io/tag/k8s/"/>
    
  </entry>
  
  <entry>
    <title>Flutter中使用SetState无效</title>
    <link href="http://nmk0718.github.io/2022/03/08/flutter%E6%9B%B4%E6%96%B0%E7%8A%B6%E6%80%81%E6%97%A0%E6%95%88/"/>
    <id>http://nmk0718.github.io/2022/03/08/flutter%E6%9B%B4%E6%96%B0%E7%8A%B6%E6%80%81%E6%97%A0%E6%95%88/</id>
    <published>2022-03-08T06:21:48.575Z</published>
    <updated>2022-03-08T06:21:48.575Z</updated>
    
    <content type="html"><![CDATA[<h3 id="在Flutter中使用SetState无效？可能是忽略了这个！"><a href="#在Flutter中使用SetState无效？可能是忽略了这个！" class="headerlink" title="在Flutter中使用SetState无效？可能是忽略了这个！"></a>在Flutter中使用SetState无效？可能是忽略了这个！</h3><p>问题：在某个组件中调用setState()方法更新该组件状态，结果是无法做到更新效果，组件仍然维持原状。<br>下面我们用代码示例还原问题场景：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class _MyHomePageState extends State&lt;MyHomePage&gt; &#123;</span><br><span class="line">  bool isChecked = false;</span><br><span class="line"></span><br><span class="line">  showTestDialog() &#123;</span><br><span class="line">    showDialog(</span><br><span class="line">      context: context,</span><br><span class="line">      builder: (BuildContext context) &#123;</span><br><span class="line">        return SimpleDialog(title: Text(&quot;测试对话框标题&quot;), children: &lt;Widget&gt;[</span><br><span class="line">          Row(children: &lt;Widget&gt;[</span><br><span class="line">            Checkbox(</span><br><span class="line">                value: this.isChecked,</span><br><span class="line">                onChanged: (bool val) &#123;</span><br><span class="line">                  setState(() &#123;</span><br><span class="line">                    this.isChecked = !this.isChecked;</span><br><span class="line">                  &#125;);</span><br><span class="line">                  debugPrint(this.isChecked.toString());</span><br><span class="line">                &#125;),</span><br><span class="line">            Text(&quot;测试复选框&quot;)</span><br><span class="line">          ])</span><br><span class="line">        ]);</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    return Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(widget.title),</span><br><span class="line">      ),</span><br><span class="line">      body: Center(</span><br><span class="line">          child: RaisedButton(</span><br><span class="line">        child: Text(&quot;点击出现弹窗&quot;),</span><br><span class="line">        onPressed: () &#123;</span><br><span class="line">          showTestDialog();</span><br><span class="line">        &#125;,</span><br><span class="line">      )),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为了突出问题点，减少不必要的干扰，我简化了原有代码内容。通过阅读上述代码，我们得知整个Demo的界面有一个按钮构成，当按钮被点击时，showTestDialog()方法被执行。界面将显示一个小窗口，里面有一个复选框。<br>我们要实现的效果当然是用户点击复选框的时候，改变复选框的状态。因此，在复选框的onChanged()方法中改变了决定复选框状态的布尔值，并setState()。<br>然而真实的运行结果并非像预期那样产生效果。<br>究其原因，我们还需从setState()说起。<br>顾名思义，setState()要求其作用对象必须是一个有状态的组件。如果作用对象本身无状态，那么setState()将无法起作用。<br>因此，我们找到原因：SimpleDialog()中的子组件默认是无状态的。<br>接下来的解决办法就简单了，只需要在SimpleDialog组件外部“套”一个StatefulBuilder组件即可。参考下面的代码：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class _MyHomePageState extends State&lt;MyHomePage&gt; &#123;</span><br><span class="line">  bool isChecked = false;</span><br><span class="line"></span><br><span class="line">  showTestDialog() &#123;</span><br><span class="line">    showDialog(</span><br><span class="line">      context: context,</span><br><span class="line">      builder: (BuildContext context) &#123;</span><br><span class="line">        return StatefulBuilder(</span><br><span class="line">          builder:</span><br><span class="line">              (BuildContext context, void Function(void Function()) setState) &#123;</span><br><span class="line">            return SimpleDialog(title: Text(&quot;测试对话框标题&quot;), children: &lt;Widget&gt;[</span><br><span class="line">              Row(children: &lt;Widget&gt;[</span><br><span class="line">                Checkbox(</span><br><span class="line">                    value: this.isChecked,</span><br><span class="line">                    onChanged: (bool val) &#123;</span><br><span class="line">                      setState(() &#123;</span><br><span class="line">                        this.isChecked = !this.isChecked;</span><br><span class="line">                      &#125;);</span><br><span class="line">                      debugPrint(this.isChecked.toString());</span><br><span class="line">                    &#125;),</span><br><span class="line">                Text(&quot;测试复选框&quot;)</span><br><span class="line">              ])</span><br><span class="line">            ]);</span><br><span class="line">          &#125;,</span><br><span class="line">        );</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    return Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(widget.title),</span><br><span class="line">      ),</span><br><span class="line">      body: Center(</span><br><span class="line">          child: RaisedButton(</span><br><span class="line">        child: Text(&quot;点击出现弹窗&quot;),</span><br><span class="line">        onPressed: () &#123;</span><br><span class="line">          showTestDialog();</span><br><span class="line">        &#125;,</span><br><span class="line">      )),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再次运行，对话框中的复选框可以正常响应。至此，问题解决。</p><p>参考链接：<a href="https://juejin.cn/post/6844904195531735048" target="_blank" rel="noopener">https://juejin.cn/post/6844904195531735048</a>  </p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;在Flutter中使用SetState无效？可能是忽略了这个！&quot;&gt;&lt;a href=&quot;#在Flutter中使用SetState无效？可能是忽略了这个！&quot; class=&quot;headerlink&quot; title=&quot;在Flutter中使用SetState无效？可能是忽略了这个</summary>
      
    
    
    
    
    <category term="flutter" scheme="http://nmk0718.github.io/tag/flutter/"/>
    
  </entry>
  
</feed>
