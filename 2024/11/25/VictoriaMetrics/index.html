<!DOCTYPE html>
<html lang>
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="kk">





<title>VictoriaMetrics</title>



    <link rel="icon" href="/favicon.png">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    

</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">kk&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">kk&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">VictoriaMetrics</h1>
            
                <div class="post-meta">
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2024-11-25&nbsp;&nbsp;16:30</a>
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <p>VictoriaMetrics 是一款快速、经济高效且可扩展的时间序列数据库。可用作 Prometheus 的长期远程存储。如果提取率低于每秒​​一百万个数据点，建议使用单节点版本，而不是集群版本。</p>
<p>VictoriaMetrics集群由以下服务组成：</p>
<ul>
<li><code>vmstorage</code> 存储原始数据并返回给定标签过滤器在给定时间范围内的查询数据</li>
<li><code>vminsert</code> 接受采集的数据，并根据指标名称及其所有标签的一致性哈希，将其传播到 vmstorage 节点之间</li>
<li><code>vmselect</code> 通过从所有配置的 vmstorage 节点获取所需数据来执行传入查询</li>
<li><code>vmalert</code> 负责告警，和 Prometheus 一样支持纪录、告警两种规则配置与发送告警通知，允许在注解中使用 Go 模板来格式化数据、迭代或执行表达式，支持跨租户发送警报和记录规则</li>
<li><code>vmagent</code> 负责数据采集，重新标记和过滤收集到的指标，并通过 Prometheus 协议或通过 VictoriaMetrics 协议将它们存储在 VictoriaMetrics 或任何其他存储系统中。<img src="/image/placeholder.jpg" data-original="https://docs.victoriametrics.com/Cluster-VictoriaMetrics_cluster-scheme.webp">

</li>
</ul>
<p>部署参考文档：<br><a href="https://docs.victoriametrics.com/helm/victoriametrics-operator/" target="_blank" rel="noopener">https://docs.victoriametrics.com/helm/victoriametrics-operator/</a><br><a href="https://docs.victoriametrics.com/cluster-victoriametrics/" target="_blank" rel="noopener">https://docs.victoriametrics.com/cluster-victoriametrics/</a><br><a href="https://zhuanlan.zhihu.com/p/715516533" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/715516533</a></p>
<p>⚠️本文档中的操作均在本地进行，如需生产部署，请把port-forward转换为ingress转发，vmcluster调整合适的配置.</p>
<h2 id="VictoriaMetrics-Helm-存储库"><a href="#VictoriaMetrics-Helm-存储库" class="headerlink" title="VictoriaMetrics Helm 存储库"></a>VictoriaMetrics Helm 存储库</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#helm添加repo</span></span><br><span class="line">➜  ~ helm repo add vm https://victoriametrics.github.io/helm-charts/</span><br><span class="line"><span class="string">"vm"</span> has been added to your repositories</span><br><span class="line"></span><br><span class="line"><span class="comment">#helm更新repo</span></span><br><span class="line">➜  ~ helm repo update</span><br><span class="line">Hang tight <span class="keyword">while</span> we grab the latest from your chart repositories...</span><br><span class="line">...Successfully got an update from the <span class="string">"aliyun"</span> chart repository</span><br><span class="line">...Successfully got an update from the <span class="string">"vm"</span> chart repository</span><br><span class="line">Update Complete. ⎈Happy Helming!⎈</span><br><span class="line"></span><br><span class="line"><span class="comment">#helm查看相关服务和版本</span></span><br><span class="line">➜  ~ helm search repo vm/</span><br><span class="line">NAME                           	CHART VERSION	APP VERSION	DESCRIPTION</span><br><span class="line">vm/victoria-logs-single        	0.8.2        	v1.0.0     	Victoria Logs Single version - high-performance...</span><br><span class="line">vm/victoria-metrics-agent      	0.14.9       	v1.106.1   	Victoria Metrics Agent - collects metrics from ...</span><br><span class="line">vm/victoria-metrics-alert      	0.12.6       	v1.106.1   	Victoria Metrics Alert - executes a list of giv...</span><br><span class="line">vm/victoria-metrics-anomaly    	1.6.7        	v1.18.4    	Victoria Metrics Anomaly Detection - a service ...</span><br><span class="line">vm/victoria-metrics-auth       	0.7.7        	v1.106.1   	Victoria Metrics Auth - is a simple auth proxy ...</span><br><span class="line">vm/victoria-metrics-cluster    	0.14.12      	v1.106.1   	Victoria Metrics Cluster version - high-perform...</span><br><span class="line">vm/victoria-metrics-common     	0.0.31       	           	Victoria Metrics Common - contains shared templ...</span><br><span class="line">vm/victoria-metrics-distributed	0.5.0        	v1.106.1   	A Helm chart <span class="keyword">for</span> Running VMCluster on Multiple ...</span><br><span class="line">vm/victoria-metrics-gateway    	0.5.7        	v1.106.1   	Victoria Metrics Gateway - Auth &amp; Rate-Limittin...</span><br><span class="line">vm/victoria-metrics-k8s-stack  	0.28.4       	v1.106.1   	Kubernetes monitoring on VictoriaMetrics stack....</span><br><span class="line">vm/victoria-metrics-operator   	0.38.0       	v0.49.1    	Victoria Metrics Operator</span><br><span class="line">vm/victoria-metrics-single     	0.12.7       	v1.106.1   	Victoria Metrics Single version - high-performa...</span><br></pre></td></tr></table></figure>

<h2 id="安装-VictoriaMetrics-Operator"><a href="#安装-VictoriaMetrics-Operator" class="headerlink" title="安装 VictoriaMetrics-Operator"></a>安装 VictoriaMetrics-Operator</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#使用命令安装</span></span><br><span class="line">➜  ~ helm install vmo vm/victoria-metrics-operator</span><br><span class="line">NAME: vmo</span><br><span class="line">LAST DEPLOYED: Tue Dec 24 14:38:21 2024</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">victoria-metrics-operator has been installed. Check its status by running:</span><br><span class="line">  kubectl --namespace default get pods -l <span class="string">"app.kubernetes.io/instance=vmo"</span></span><br><span class="line"></span><br><span class="line">Get more information on https://github.com/VictoriaMetrics/helm-charts/tree/master/charts/victoria-metrics-operator.</span><br><span class="line">See <span class="string">"Getting started guide for VM Operator"</span> on https://docs.victoriametrics.com/guides/getting-started-with-vm-operator</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看pod状态</span></span><br><span class="line">➜  ~ kubectl get pods -A | grep <span class="string">'vmo'</span></span><br><span class="line">default       vmo-victoria-metrics-operator-54bf97548f-fj8j7   1/1     Running   0             1m</span><br></pre></td></tr></table></figure>

<h2 id="安装VictoriaMetrics-Cluster"><a href="#安装VictoriaMetrics-Cluster" class="headerlink" title="安装VictoriaMetrics Cluster"></a>安装VictoriaMetrics Cluster</h2><p>Operator 会根据我们的定义去部署集群,可以通过 kubectl explain VMCluster.spec 来查看对象可配置的属性</p>
<h4 id="vmcluster-yaml"><a href="#vmcluster-yaml" class="headerlink" title="vmcluster.yaml"></a>vmcluster.yaml</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">operator.victoriametrics.com/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VMCluster</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">vmcluster</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">victoria-metrics</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment">#数据保留的时长,默认保留期为 1 个月， 默认单位为 m(月)，支持的单位有 h (hour), d (day), w (week), y (year)</span></span><br><span class="line"><span class="attr">  retentionPeriod:</span> <span class="string">"1w"</span></span><br><span class="line">  <span class="comment">#开启副本，并控制副本数量，会往多个vmstorage插入同一份样本数据</span></span><br><span class="line">  <span class="comment">#replicationFactor: 2</span></span><br><span class="line"><span class="attr">  vmstorage:</span></span><br><span class="line">    <span class="comment">#副本数</span></span><br><span class="line"><span class="attr">    replicaCount:</span> <span class="number">2</span></span><br><span class="line">    <span class="comment">#数据持久化</span></span><br><span class="line"><span class="attr">    storageDataPath:</span> <span class="string">/vm-data</span></span><br><span class="line"><span class="attr">    storage:</span></span><br><span class="line"><span class="attr">      volumeClaimTemplate:</span></span><br><span class="line"><span class="attr">        spec:</span></span><br><span class="line"><span class="attr">          storageClassName:</span> <span class="string">cbs</span></span><br><span class="line"><span class="attr">          resources:</span></span><br><span class="line"><span class="attr">            requests:</span></span><br><span class="line"><span class="attr">              storage:</span> <span class="number">10</span><span class="string">Gi</span></span><br><span class="line">    <span class="comment">#资源大小</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      limits:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="string">"0.5"</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">500</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">  vmselect:</span></span><br><span class="line"><span class="attr">    replicaCount:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">    cacheMountPath:</span> <span class="string">"/select-cache"</span></span><br><span class="line"><span class="attr">    storage:</span></span><br><span class="line"><span class="attr">      volumeClaimTemplate:</span></span><br><span class="line"><span class="attr">        spec:</span></span><br><span class="line"><span class="attr">          storageClassName:</span> <span class="string">cbs</span></span><br><span class="line"><span class="attr">          resources:</span></span><br><span class="line"><span class="attr">            requests:</span></span><br><span class="line"><span class="attr">              storage:</span> <span class="string">"2Gi"</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      limits:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="string">"0.3"</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="string">"300Mi"</span></span><br><span class="line"><span class="attr">  vminsert:</span></span><br><span class="line"><span class="attr">    replicaCount:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p><code>注意</code>：</p>
<ul>
<li>开启replicationFactor，vmagent会产生replicationFactor份冗余数据，需要dedup.minScrapeInterval参数，来去除重复数据。</li>
<li>开启或修改replicationFactor,可能造成数据部分丢失。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#根据自定义的配置进行安装</span></span><br><span class="line">➜  ~ kubectl apply -f vmcluster.yaml</span><br><span class="line">vmcluster.operator.victoriametrics.com/vmcluster created</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看是否正常启动</span></span><br><span class="line">➜  ~ kubectl get pods</span><br><span class="line">NAME                                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">vminsert-vmcluster-8587774678-2xxt6              1/1     Running   0          12s</span><br><span class="line">vminsert-vmcluster-8587774678-mplrr              1/1     Running   0          12s</span><br><span class="line">vmo-victoria-metrics-operator-5d4ff4d8f4-gk4gj   1/1     Running   0          3m58s</span><br><span class="line">vmselect-vmcluster-0                             1/1     Running   0          17s</span><br><span class="line">vmselect-vmcluster-1                             1/1     Running   0          17s</span><br><span class="line">vmstorage-vmcluster-0                            1/1     Running   0          23s</span><br><span class="line">vmstorage-vmcluster-1                            1/1     Running   0          23s</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看集群状态信息</span></span><br><span class="line">➜  ~ kubectl get vmclusters</span><br><span class="line">NAME        INSERT COUNT   STORAGE COUNT   SELECT COUNT   AGE   STATUS</span><br><span class="line">vmcluster   2              2               2              63s   operational</span><br><span class="line"></span><br><span class="line"><span class="comment">#获取vminsert服务名</span></span><br><span class="line">➜  ~ kubectl get svc | grep vminsert</span><br><span class="line">vminsert-vmcluster              ClusterIP   10.105.160.47    &lt;none&gt;        8480/TCP                     6m49s</span><br></pre></td></tr></table></figure>

<h3 id="vmagent-yaml"><a href="#vmagent-yaml" class="headerlink" title="vmagent.yaml"></a>vmagent.yaml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">operator.victoriametrics.com/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VMAgent</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">vmagent</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  serviceScrapeNamespaceSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  podScrapeNamespaceSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  podScrapeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  serviceScrapeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  nodeScrapeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  nodeScrapeNamespaceSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  staticScrapeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  staticScrapeNamespaceSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  replicaCount:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  remoteWrite:</span></span><br><span class="line"><span class="attr">    - url:</span> <span class="string">"http://vminsert-vmcluster.default.svc.cluster.local:8480/insert/0/prometheus/api/v1/write"</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>VMAgent的<code>remoteWrite.url</code> 由以下部分组成：</p>
<ul>
<li>“service_name.VMCluster_namespace.svc.kubernetes_cluster_domain”<br>在例子中，它是vminsert-vmcluster.default.svc.cluster.local</li>
</ul>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#根据自定义的配置进行安装</span></span><br><span class="line">➜  ~ kubectl apply -f vmagent.yaml</span><br><span class="line">vmagent.operator.victoriametrics.com/vmagent created</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置本地端口转发访问(生产环境可使用ingress或nodeport转发访问)</span></span><br><span class="line">➜  ~ kubectl port-forward svc/vmagent-vmagent 8429:8429</span><br><span class="line">Forwarding from 127.0.0.1:8429 -&gt; 8429</span><br><span class="line">Forwarding from [::1]:8429 -&gt; 8429</span><br><span class="line">Handling connection <span class="keyword">for</span> 8429</span><br><span class="line">Handling connection <span class="keyword">for</span> 8429</span><br></pre></td></tr></table></figure>

<p>在浏览器中打开<a href="http://127.0.0.1:8429/targets" target="_blank" rel="noopener">http://127.0.0.1:8429/targets</a> 查看VMAgent是否从 K8s 集群收集指标</p>
<img src="/image/placeholder.jpg" data-original="https://docs.victoriametrics.com/guides/getting-started-with-vm-operator/vmcluster.webp">


<h2 id="验证-VictoriaMetrics-Cluster"><a href="#验证-VictoriaMetrics-Cluster" class="headerlink" title="验证 VictoriaMetrics Cluster"></a>验证 VictoriaMetrics Cluster</h2><p>获取vmselect服务名</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">➜  ~ kubectl get svc | grep vmselect</span><br><span class="line">vmselect-vmcluster              ClusterIP   None             &lt;none&gt;        8481/TCP                     31m</span><br></pre></td></tr></table></figure>

<h3 id="安装Grafana"><a href="#安装Grafana" class="headerlink" title="安装Grafana"></a>安装Grafana</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">| helm install grafana grafana/grafana -f -</span></span><br><span class="line"><span class="string"></span><span class="attr">  datasources:</span></span><br><span class="line">    <span class="string">datasources.yaml:</span></span><br><span class="line"><span class="attr">      apiVersion:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      datasources:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">victoriametrics</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">          orgId:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          url:</span> <span class="attr">http://vmselect-vmcluster.default.svc.cluster.local:8481/select/0/prometheus/</span></span><br><span class="line"><span class="attr">          access:</span> <span class="string">proxy</span></span><br><span class="line"><span class="attr">          isDefault:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">          updateIntervalSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">          editable:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  dashboardProviders:</span></span><br><span class="line">   <span class="string">dashboardproviders.yaml:</span></span><br><span class="line"><span class="attr">     apiVersion:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">     providers:</span></span><br><span class="line"><span class="attr">     - name:</span> <span class="string">'default'</span></span><br><span class="line"><span class="attr">       orgId:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">       folder:</span> <span class="string">''</span></span><br><span class="line"><span class="attr">       type:</span> <span class="string">file</span></span><br><span class="line"><span class="attr">       disableDeletion:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">       editable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">       options:</span></span><br><span class="line"><span class="attr">         path:</span> <span class="string">/var/lib/grafana/dashboards/default</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  dashboards:</span></span><br><span class="line"><span class="attr">    default:</span></span><br><span class="line"><span class="attr">      victoriametrics:</span></span><br><span class="line"><span class="attr">        gnetId:</span> <span class="number">11176</span></span><br><span class="line"><span class="attr">        revision:</span> <span class="number">18</span></span><br><span class="line"><span class="attr">        datasource:</span> <span class="string">victoriametrics</span></span><br><span class="line"><span class="attr">      vmagent:</span></span><br><span class="line"><span class="attr">        gnetId:</span> <span class="number">12683</span></span><br><span class="line"><span class="attr">        revision:</span> <span class="number">7</span></span><br><span class="line"><span class="attr">        datasource:</span> <span class="string">victoriametrics</span></span><br><span class="line"><span class="attr">      kubernetes:</span></span><br><span class="line"><span class="attr">        gnetId:</span> <span class="number">14205</span></span><br><span class="line"><span class="attr">        revision:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        datasource:</span> <span class="string">victoriametrics</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h2 id="浏览器验证"><a href="#浏览器验证" class="headerlink" title="浏览器验证"></a>浏览器验证</h2><h3 id="grafana"><a href="#grafana" class="headerlink" title="grafana"></a>grafana</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#查看admin密码</span></span><br><span class="line">➜  ~ kubectl get secret --namespace default grafana -o jsonpath=<span class="string">"&#123;.data.admin-password&#125;"</span> | base64 --decode ; <span class="built_in">echo</span></span><br><span class="line">wVj5Rdl1BuPClRy5qgxrztsaoE8v0e4m05DU1cUW</span><br><span class="line"><span class="comment">#转发配置本地端口转发访问</span></span><br><span class="line">➜  ~ <span class="built_in">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span class="string">"app.kubernetes.io/name=grafana,app.kubernetes.io/instance=grafana"</span> -o jsonpath=<span class="string">"&#123;.items[0].metadata.name&#125;"</span>)</span><br><span class="line">➜  ~ kubectl --namespace default port-forward <span class="variable">$POD_NAME</span> 3000</span><br><span class="line">Forwarding from 127.0.0.1:3000 -&gt; 3000</span><br><span class="line">Forwarding from [::1]:3000 -&gt; 3000</span><br></pre></td></tr></table></figure>

<p>访问:<code>http://localhost:3000</code><br><img src="/image/placeholder.jpg" data-original="https://docs.victoriametrics.com/guides/getting-started-with-vm-operator/vmcluster-grafana1.webp"><br><img src="/image/placeholder.jpg" data-original="https://docs.victoriametrics.com/guides/getting-started-with-vm-operator/vmcluster-grafana2.webp"></p>
<h3 id="vmui"><a href="#vmui" class="headerlink" title="vmui"></a>vmui</h3><p>VictoriaMetrics Cluster提供了用于查询故障排除和探索的 UI</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">➜  ~ kubectl port-forward svc/vmselect-vmcluster 8481:8481</span><br><span class="line">Forwarding from 127.0.0.1:8481 -&gt; 8481</span><br><span class="line">Forwarding from [::1]:8481 -&gt; 8481</span><br></pre></td></tr></table></figure>

<p>访问:<code>http://localhost:8481/select/0/vmui/</code><br><img src="/image/placeholder.jpg" data-original="\image/vmui.png"></p>
<h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><h3 id="监控jvm"><a href="#监控jvm" class="headerlink" title="监控jvm"></a>监控jvm</h3><h4 id="在dce集群创建命名空间"><a href="#在dce集群创建命名空间" class="headerlink" title="在dce集群创建命名空间"></a>在dce集群创建命名空间</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#创建monitor的命名空间</span></span><br><span class="line">➜  ~ kubectl create ns monitor</span><br><span class="line">namespace/monitor created</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看k8s版本</span></span><br><span class="line">➜  ~ kubectl version --short</span><br><span class="line">Flag --short has been deprecated, and will be removed <span class="keyword">in</span> the future. The --short output will become the default.</span><br><span class="line">Client Version: v1.24.0</span><br><span class="line">Kustomize Version: v4.5.4</span><br><span class="line">Server Version: v1.18.20</span><br><span class="line">WARNING: version difference between client (1.24) and server (1.18) exceeds the supported minor version skew of +/-1</span><br></pre></td></tr></table></figure>

<h4 id="在monitor命名空间中创建serviceaccount："><a href="#在monitor命名空间中创建serviceaccount：" class="headerlink" title="在monitor命名空间中创建serviceaccount："></a>在monitor命名空间中创建serviceaccount：</h4><p>ServiceAccount.yaml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="string">app.kubernetes.io/component:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="string">app.kubernetes.io/instance:</span> <span class="string">k8s</span></span><br><span class="line">    <span class="string">app.kubernetes.io/name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="string">app.kubernetes.io/part-of:</span> <span class="string">kube-prometheus</span></span><br><span class="line">    <span class="string">app.kubernetes.io/version:</span> <span class="number">1.18</span><span class="number">.20</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">monitor</span></span><br></pre></td></tr></table></figure>


<h4 id="创建secret-会自动创建token"><a href="#创建secret-会自动创建token" class="headerlink" title="创建secret,会自动创建token"></a>创建secret,会自动创建token</h4><p>（k8s在1.24版本后创建serviceaccount不会自动创建绑定secret，需要事先创建secret来绑定到serviceaccount）<br>Secret.yaml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">kubernetes.io/service-account.name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">prometheus-k8s-secret</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/service-account-token</span></span><br></pre></td></tr></table></figure>

<h4 id="创建cluster-role"><a href="#创建cluster-role" class="headerlink" title="创建cluster role"></a>创建cluster role</h4><p>ClusterRole.yaml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="string">app.kubernetes.io/component:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="string">app.kubernetes.io/instance:</span> <span class="string">k8s</span></span><br><span class="line">    <span class="string">app.kubernetes.io/name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="string">app.kubernetes.io/part-of:</span> <span class="string">kube-prometheus</span></span><br><span class="line">    <span class="string">app.kubernetes.io/version:</span> <span class="number">1.18</span><span class="number">.20</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nodes</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nodes/metrics</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">services</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="comment">#- endpointslices  对于需要处理数千甚至数万个端点的大型服务，使用EndpointSlice可以提供更好的性能和可扩展性</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">pods</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br></pre></td></tr></table></figure>

<h4 id="授权给serviceaccount"><a href="#授权给serviceaccount" class="headerlink" title="授权给serviceaccount"></a>授权给serviceaccount</h4><p>ClusterRoleBinding.yaml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="string">app.kubernetes.io/component:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="string">app.kubernetes.io/instance:</span> <span class="string">k8s</span></span><br><span class="line">    <span class="string">app.kubernetes.io/name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="string">app.kubernetes.io/part-of:</span> <span class="string">kube-prometheus</span></span><br><span class="line">    <span class="string">app.kubernetes.io/version:</span> <span class="number">1.18</span><span class="number">.20</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">monitor</span></span><br></pre></td></tr></table></figure>

<h4 id="在vm集群中创建好dce集群的comfigmap并部署"><a href="#在vm集群中创建好dce集群的comfigmap并部署" class="headerlink" title="在vm集群中创建好dce集群的comfigmap并部署"></a>在vm集群中创建好dce集群的comfigmap并部署</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#查看prometheus-k8s-secret中的token</span></span><br><span class="line">➜  ~ kubectl get secret prometheus-k8s-secret -n monitor -o yaml | grep token</span><br><span class="line">  token: ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNkltUnVibTFSYUVkbVdtTlBUR2hzZHpVd1dEZE9UVWhhZFdKdlJVZHpaMDV2Y1hOcmFqTnNTM1ZVYUhNaWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUp0YjI1cGRHOXlJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbkJ5YjIxbGRHaGxkWE10YXpoekxYTmxZM0psZENJc0ltdDFZbVZ5Ym1WMFpYTXVhVzh2YzJWeWRtbGpaV0ZqWTI5MWJuUXZjMlZ5ZG1salpTMWhZMk52ZFc1MExtNWhiV1VpT2lKd2NtOXRaWFJvWlhWekxXczRjeUlzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJak5rTWpJd01qQm1MVEZsTXpjdE5EaGxaQzFpTVRkbExUazVOMlEwWVRSbVpUUTVOU0lzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwdGIyNXBkRzl5T25CeWIyMWxkR2hsZFhNdGF6aHpJbjAuaVFGRjI3N3U5MGEtODR4aGR0dXVPeUdvWWdZRGpTNWJOQkhEVm1lSUZ3blVqMy1zY3U1RkJfTjhjYVc3d1JhUXNjaDN6Tk0tbWwwSVZUbXRSNjVFREZxVTNiRV85SGlKS1R1UlFfb2NUTVRjQUJKT3I5YnotY19IMFNsSlJlSUN6dlVlM0M1SUxhV2JERkJSRGxfVlRKTXBhVjMxZTlacXN6YTVMRGE5MkJDYldoaldzd2tOR1pSOUppeFVwTW1Mb2dKZFN2Nm0wcjFxelQwU2NjeEw2STRSa2JEUkhDZ1p5ZlhKc1Y3T1d5cmdoT0dwX2FJYTdJUHItbC00dEV0cGhoTFd4MjJMTWFFOW5odkJCZ2dHUVR4a2VDcEY1MWRjSzAtQ3phTjNWV1htckNHajJyT1BzTXdzaVdsOHJ3bk1BdmhYdmVaSGRCVFYwT2dQYkVkWXF3</span><br><span class="line">      &#123;<span class="string">"apiVersion"</span>:<span class="string">"v1"</span>,<span class="string">"kind"</span>:<span class="string">"Secret"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;<span class="string">"kubernetes.io/service-account.name"</span>:<span class="string">"prometheus-k8s"</span>&#125;,<span class="string">"name"</span>:<span class="string">"prometheus-k8s-secret"</span>,<span class="string">"namespace"</span>:<span class="string">"monitor"</span>&#125;,<span class="string">"type"</span>:<span class="string">"kubernetes.io/service-account-token"</span>&#125;</span><br><span class="line"><span class="built_in">type</span>: kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line"><span class="comment">#对token进行base64解密</span></span><br><span class="line">➜  ~ <span class="built_in">echo</span> <span class="string">"ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNkltUnVibTFSYUVkbVdtTlBUR2hzZHpVd1dEZE9UVWhhZFdKdlJVZHpaMDV2Y1hOcmFqTnNTM1ZVYUhNaWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUp0YjI1cGRHOXlJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbkJ5YjIxbGRHaGxkWE10YXpoekxYTmxZM0psZENJc0ltdDFZbVZ5Ym1WMFpYTXVhVzh2YzJWeWRtbGpaV0ZqWTI5MWJuUXZjMlZ5ZG1salpTMWhZMk52ZFc1MExtNWhiV1VpT2lKd2NtOXRaWFJvWlhWekxXczRjeUlzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJak5rTWpJd01qQm1MVEZsTXpjdE5EaGxaQzFpTVRkbExUazVOMlEwWVRSbVpUUTVOU0lzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwdGIyNXBkRzl5T25CeWIyMWxkR2hsZFhNdGF6aHpJbjAuaVFGRjI3N3U5MGEtODR4aGR0dXVPeUdvWWdZRGpTNWJOQkhEVm1lSUZ3blVqMy1zY3U1RkJfTjhjYVc3d1JhUXNjaDN6Tk0tbWwwSVZUbXRSNjVFREZxVTNiRV85SGlKS1R1UlFfb2NUTVRjQUJKT3I5YnotY19IMFNsSlJlSUN6dlVlM0M1SUxhV2JERkJSRGxfVlRKTXBhVjMxZTlacXN6YTVMRGE5MkJDYldoaldzd2tOR1pSOUppeFVwTW1Mb2dKZFN2Nm0wcjFxelQwU2NjeEw2STRSa2JEUkhDZ1p5ZlhKc1Y3T1d5cmdoT0dwX2FJYTdJUHItbC00dEV0cGhoTFd4MjJMTWFFOW5odkJCZ2dHUVR4a2VDcEY1MWRjSzAtQ3phTjNWV1htckNHajJyT1BzTXdzaVdsOHJ3bk1BdmhYdmVaSGRCVFYwT2dQYkVkWXF3"</span> |base64 --decode</span><br></pre></td></tr></table></figure>

<p>把上面base64 解密后文件写在如下 token里<br>dce-token-configmap.yaml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  token:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    eyJhbGciOiJSUzI1NiIsImtpZCI6ImRubm1RaEdmWmNPTGhsdzUwWDdOTUhadWJvRUdzZ05vcXNrajNsS3VUaHMifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJtb25pdG9yIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6InByb21ldGhldXMtazhzLXNlY3JldCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJwcm9tZXRoZXVzLWs4cyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjNkMjIwMjBmLTFlMzctNDhlZC1iMTdlLTk5N2Q0YTRmZTQ5NSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDptb25pdG9yOnByb21ldGhldXMtazhzIn0.iQFF277u90a-84xhdtuuOyGoYgYDjS5bNBHDVmeIFwnUj3-scu5FB_N8caW7wRaQsch3zNM-ml0IVTmtR65EDFqU3bE_9HiJKTuRQ_ocTMTcABJOr9bz-c_H0SlJReICzvUe3C5ILaWbDFBRDl_VTJMpaV31e9Zqsza5LDa92BCbWhjWswkNGZR9JixUpMmLogJdSv6m0r1qzT0SccxL6I4RkbDRHCgZyfXJsV7OWyrghOGp_aIa7IPr-l-4tEtphhLWx22LMaE9nhvBBggGQTxkeCpF51dcK0-CzaN3VWXmrCGj2rOPsMwsiWl8rwnMAvhXveZHdBTV0OgPbEdYqw</span></span><br><span class="line"><span class="string"></span><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">dce-token-configmap</span></span><br></pre></td></tr></table></figure>

<p>部署dce-token-configmap </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  ~ kubectl apply -f dce-token-configmap.yaml</span><br><span class="line">configmap/dce-token-configmap created</span><br></pre></td></tr></table></figure>

<h4 id="在vmagent-yaml文件配置采集指标策略"><a href="#在vmagent-yaml文件配置采集指标策略" class="headerlink" title="在vmagent.yaml文件配置采集指标策略"></a>在vmagent.yaml文件配置采集指标策略</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">operator.victoriametrics.com/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VMAgent</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">vmagent</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment">#抓取指标的时间间隔</span></span><br><span class="line"><span class="attr">  scrapeInterval:</span> <span class="number">20</span><span class="string">s</span></span><br><span class="line">  <span class="comment">#vmagent副本数量</span></span><br><span class="line"><span class="attr">  replicaCount:</span> <span class="number">1</span></span><br><span class="line">  <span class="comment">#资源大小</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="number">4</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="number">8</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">    limits:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="number">4</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="number">8</span><span class="string">Gi</span></span><br><span class="line">  <span class="comment">#挂载dce-token</span></span><br><span class="line"><span class="attr">  volumeMounts:</span></span><br><span class="line"><span class="attr">  - mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/dce-token/</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">dce-token</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">  - configMap:</span></span><br><span class="line"><span class="attr">      defaultMode:</span> <span class="number">420</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">dce-token-configmap</span> </span><br><span class="line"><span class="attr">    name:</span> <span class="string">dce-token</span></span><br><span class="line">  <span class="comment">#远程写入</span></span><br><span class="line"><span class="attr">  remoteWrite:</span></span><br><span class="line"><span class="attr">    - url:</span> <span class="string">"http://vminsert-vmcluster.default.svc.cluster.local:8480/insert/0/prometheus/api/v1/write"</span></span><br><span class="line"><span class="attr">  inlineScrapeConfig:</span> <span class="string">|</span></span><br><span class="line"><span class="string"></span><span class="attr">    - job_name:</span> <span class="string">dce-jvm-exporter</span></span><br><span class="line">      <span class="comment">#是否尊重指标的时间戳</span></span><br><span class="line"><span class="attr">      honor_timestamps:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment">#抓取指标的时间间隔</span></span><br><span class="line"><span class="attr">      scrape_interval:</span> <span class="number">20</span><span class="string">s</span></span><br><span class="line">      <span class="comment">#抓取指标的超时时间</span></span><br><span class="line"><span class="attr">      scrape_timeout:</span> <span class="number">30</span><span class="string">s</span></span><br><span class="line">      <span class="comment">#抓取的指标路径</span></span><br><span class="line"><span class="attr">      metrics_path:</span> <span class="string">/actuator/prometheus</span></span><br><span class="line">      <span class="comment">#抓取协议</span></span><br><span class="line"><span class="attr">      scheme:</span> <span class="string">http</span></span><br><span class="line">      <span class="comment">#指定认证的用户名和密码</span></span><br><span class="line"><span class="attr">      basic_auth:</span></span><br><span class="line"><span class="attr">        username:</span> <span class="string">'actuator'</span></span><br><span class="line"><span class="attr">        password:</span> <span class="string">'actuator%2@nmk!@#'</span></span><br><span class="line">      <span class="comment">#跳过 TLS 证书验证</span></span><br><span class="line"><span class="attr">      tls_config:</span></span><br><span class="line"><span class="attr">        insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      kubernetes_sd_configs:</span></span><br><span class="line">      <span class="comment">#Kubernetes API 服务器地址</span></span><br><span class="line"><span class="attr">      - api_server:</span> <span class="attr">https://10.30.150.11:16443</span></span><br><span class="line">        <span class="comment">#指定要发现的资源类型(endpoints，service，pod，node，ingress)</span></span><br><span class="line"><span class="attr">        role:</span> <span class="string">pod</span></span><br><span class="line">        <span class="comment">#配置访问 Kubernetes API 的认证和 TLS 设置</span></span><br><span class="line"><span class="attr">        bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/dce-token/token</span></span><br><span class="line"><span class="attr">        tls_config:</span></span><br><span class="line"><span class="attr">          insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      relabel_configs:</span></span><br><span class="line"><span class="attr">        - source_labels:</span> <span class="string">[__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span></span><br><span class="line"><span class="attr">          separator:</span> <span class="string">;</span></span><br><span class="line"><span class="attr">          regex:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">          replacement:</span> <span class="string">$1</span></span><br><span class="line"><span class="attr">          action:</span> <span class="string">keep</span></span><br><span class="line"><span class="attr">        - source_labels:</span> <span class="string">[__meta_kubernetes_pod_annotation_prometheus_io_path]</span></span><br><span class="line"><span class="attr">          separator:</span> <span class="string">;</span></span><br><span class="line"><span class="attr">          regex:</span> <span class="string">(.+)</span></span><br><span class="line"><span class="attr">          target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line"><span class="attr">          replacement:</span> <span class="string">$1</span></span><br><span class="line"><span class="attr">          action:</span> <span class="string">replace</span></span><br><span class="line"><span class="attr">        - source_labels:</span> <span class="string">[__address__,</span> <span class="string">__meta_kubernetes_pod_annotation_prometheus_io_port]</span></span><br><span class="line"><span class="attr">          separator:</span> <span class="string">;</span></span><br><span class="line"><span class="attr">          regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line"><span class="attr">          target_label:</span> <span class="string">__address__</span></span><br><span class="line"><span class="attr">          replacement:</span> <span class="string">$1:$2</span></span><br><span class="line"><span class="attr">          action:</span> <span class="string">replace</span></span><br><span class="line"><span class="attr">        - separator:</span> <span class="string">;</span></span><br><span class="line"><span class="attr">          regex:</span> <span class="string">__meta_kubernetes_pod_label_(.+)</span></span><br><span class="line"><span class="attr">          replacement:</span> <span class="string">$1</span></span><br><span class="line"><span class="attr">          action:</span> <span class="string">labelmap</span></span><br><span class="line"><span class="attr">        - source_labels:</span> <span class="string">[__meta_kubernetes_namespace]</span></span><br><span class="line"><span class="attr">          separator:</span> <span class="string">;</span></span><br><span class="line"><span class="attr">          regex:</span> <span class="string">(.*)</span></span><br><span class="line"><span class="attr">          target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line"><span class="attr">          replacement:</span> <span class="string">$1</span></span><br><span class="line"><span class="attr">          action:</span> <span class="string">replace</span></span><br><span class="line"><span class="attr">        - source_labels:</span> <span class="string">[__meta_kubernetes_pod_name]</span></span><br><span class="line"><span class="attr">          separator:</span> <span class="string">;</span></span><br><span class="line"><span class="attr">          regex:</span> <span class="string">(.*)</span></span><br><span class="line"><span class="attr">          target_label:</span> <span class="string">kubernetes_pod_name</span></span><br><span class="line"><span class="attr">          replacement:</span> <span class="string">$1</span></span><br><span class="line"><span class="attr">          action:</span> <span class="string">replace</span></span><br></pre></td></tr></table></figure>

<p>relabel_configs: 过滤和重写目标标签</p>
<ol>
<li>source_labels: 指定用于匹配的源标签列表</li>
<li>separator: 指定分隔符</li>
<li>regex: 用于匹配 source_labels 提取的值的正则表达式，默认为匹配任意值（.*）</li>
<li>replacement: 用于替换操作的值</li>
<li>action：定义了对标签的处理方式，包括：<ul>
<li>replace：根据 regex 匹配 source_labels 的值，并将其写入 target_label</li>
<li>keep：仅保留匹配 regex 的标签，其余的将被丢弃</li>
<li>drop：丢弃匹配 regex 的标签，保留其余的</li>
<li>labelmap：根据 regex 匹配 Target 实例所有标签的名称，并以匹配到的内容为新的标签名称，其值作为新标签的值</li>
<li>labeldrop：移除匹配 regex 规则的标签</li>
<li>labelkeep：移除不匹配 regex 规则的标签，保留匹配的</li>
</ul>
</li>
</ol>
<p>要监控的Pod 中需要有以下注解才能正常采集</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">annotations:</span><br><span class="line">        prometheus.io/path: /actuator/prometheus</span><br><span class="line">        prometheus.io/port: &quot;20001&quot;</span><br><span class="line">        prometheus.io/scrape: &quot;true&quot;</span><br></pre></td></tr></table></figure>

<h4 id="加载配置文件："><a href="#加载配置文件：" class="headerlink" title="加载配置文件："></a>加载配置文件：</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  ~ kubectl apply -f vmagent.yaml</span><br><span class="line">vmagent.operator.victoriametrics.com/vmagent configured</span><br></pre></td></tr></table></figure>

<h4 id="vmagent查看配置是否生效："><a href="#vmagent查看配置是否生效：" class="headerlink" title="vmagent查看配置是否生效："></a>vmagent查看配置是否生效：</h4><img src="/image/placeholder.jpg" data-original="\image/vmagent-jvm.jpg">


<h4 id="Grafana查看面板"><a href="#Grafana查看面板" class="headerlink" title="Grafana查看面板"></a>Grafana查看面板</h4><p>打开Grafana,在Dashboards中import面板ID:4701<br><img src="/image/placeholder.jpg" data-original="\image/vm-jvm.png"></p>
<h3 id="监控k8s集群状态"><a href="#监控k8s集群状态" class="headerlink" title="监控k8s集群状态"></a>监控k8s集群状态</h3><h4 id="kube-state-metrics"><a href="#kube-state-metrics" class="headerlink" title="kube-state-metrics"></a>kube-state-metrics</h4><p>选择合适的版本，进行安装部署<br><a href="https://github.com/kubernetes/kube-state-metrics" target="_blank" rel="noopener">https://github.com/kubernetes/kube-state-metrics</a></p>
<p>采集外部集群需要把kube-state-metrics的service改为NodePort</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- job_name: dce-kube-state-metrics</span><br><span class="line">  honor_timestamps: true</span><br><span class="line">  scrape_interval: 15s</span><br><span class="line">  metrics_path: &apos;/metrics&apos;</span><br><span class="line">  scheme: http</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets: [&apos;10.30.150.1:33987&apos;]</span><br><span class="line">  #指标过大时可使用</span><br><span class="line">  params:</span><br><span class="line">  max_scrape_size: 33554432</span><br></pre></td></tr></table></figure>

<h4 id="cAdvisor"><a href="#cAdvisor" class="headerlink" title="cAdvisor"></a>cAdvisor</h4><p>⚠️必须要两个bearer_token_file，一个认证apiserver，一个通过apiserver进行cAdvisor采集指标</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- job_name: dce-cadvisor</span><br><span class="line">  metrics_path: /metrics</span><br><span class="line">  scheme: https</span><br><span class="line">  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/dce-token/token</span><br><span class="line">  tls_config:</span><br><span class="line">    insecure_skip_verify: true</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - api_server: https://10.30.150.11:16443</span><br><span class="line">    role: node</span><br><span class="line">    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/dce-token/token</span><br><span class="line">    tls_config:</span><br><span class="line">      insecure_skip_verify: true</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_node_label_(.*)</span><br><span class="line">  - target_label: __address__</span><br><span class="line">    action: replace</span><br><span class="line">    regex: (.*)</span><br><span class="line">    source_labels: [&quot;__address__&quot;]</span><br><span class="line">    replacement: 10.30.150.11:16443</span><br><span class="line">  - source_labels: [__meta_kubernetes_node_name]</span><br><span class="line">    regex: (.*)</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: __metrics_path__</span><br><span class="line">    replacement: /api/v1/nodes/$&#123;1&#125;/proxy/metrics/cadvisor</span><br><span class="line">  metric_relabel_configs:</span><br><span class="line">  - source_labels: [instance]</span><br><span class="line">    separator: ;</span><br><span class="line">    regex: (.+)</span><br><span class="line">    target_label: node</span><br><span class="line">    replacement: $1</span><br><span class="line">    action: replace</span><br></pre></td></tr></table></figure>

<p>查看大盘<br>打开Grafana,在Dashboards中import面板ID:13105<br><img src="/image/placeholder.jpg" data-original="\image/vm-k8s.png"></p>
<h4 id="Node-Exporter"><a href="#Node-Exporter" class="headerlink" title="Node-Exporter"></a>Node-Exporter</h4><p>集群内部可通过VMNodeScrape资源对象进行配置,该资源对象不支持apiserver参数，所以无法采集外部集群的信息<br>VMNodeScrape.yaml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">operator.victoriametrics.com/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VMNodeScrape</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">node-exporter</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  path:</span> <span class="string">/metrics</span></span><br><span class="line"><span class="attr">  port:</span> <span class="string">"9111"</span> <span class="comment"># 指定 node-exporter 的端口</span></span><br><span class="line"><span class="attr">  scrape_interval:</span> <span class="number">15</span><span class="string">s</span></span><br><span class="line">  <span class="comment"># relabelConfigs：  # relabel配置（如果需要）</span></span><br><span class="line">  <span class="comment"># selector:  # 过滤节点（如果需要）'</span></span><br></pre></td></tr></table></figure>

<p>集群外部通过Vmagent进行采集<br>⚠️通过node-exporter的service改为nodeport进行采集只有一台实例数据，所以改为多targets采集</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- job_name: dce-node-exporter</span><br><span class="line">      honor_timestamps: true</span><br><span class="line">      scrape_interval: 15s</span><br><span class="line">      metrics_path: &apos;/metrics&apos;</span><br><span class="line">      scheme: http</span><br><span class="line">      static_configs:</span><br><span class="line">      - targets: [&apos;10.30.150.1:12921&apos;,&apos;10.30.150.2:12921&apos;,&apos;10.30.150.3:12921&apos;,&apos;10.30.150.4:12921&apos;,&apos;10.30.150.5:12921&apos;,&apos;10.30.150.6:12921&apos;,&apos;10.30.150.8:12921&apos;,&apos;10.30.150.9:12921&apos;,&apos;10.30.150.10:12921&apos;]</span><br></pre></td></tr></table></figure>

<p>查看大盘<br>打开Grafana,在Dashboards中import面板ID:16098<br><img src="/image/placeholder.jpg" data-original="\image/vm-nodeexporter.png"></p>
<h3 id="Vmalert"><a href="#Vmalert" class="headerlink" title="Vmalert"></a>Vmalert</h3><p>vmalert在内存中保存警报状态。重新启动该vmalert进程将重置内存中所有活动警报的状态。为防止vmalert在重新启动时丢失,通过<code>-remote.write.url</code>和<code>-remote.read.url</code>将其配置为将状态持久保存到远程数据库</p>
<h4 id="安装vmalert和alert-manager"><a href="#安装vmalert和alert-manager" class="headerlink" title="安装vmalert和alert manager"></a>安装vmalert和alert manager</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">| helm install vma vm/victoria-metrics-alert -f -</span></span><br><span class="line"><span class="string"></span><span class="attr">  server:</span></span><br><span class="line"><span class="attr">    datasource:</span></span><br><span class="line"><span class="attr">      url:</span> <span class="attr">http://vmselect-vmcluster.default.svc:8481/select/0/prometheus</span></span><br><span class="line"><span class="attr">    remote:</span></span><br><span class="line"><span class="attr">      write:</span></span><br><span class="line"><span class="attr">        url:</span> <span class="attr">http://vminsert-vmcluster.default.svc:8480/insert/0/prometheus</span></span><br><span class="line"><span class="attr">      read:</span></span><br><span class="line"><span class="attr">        url:</span> <span class="attr">http://vmselect-vmcluster.default.svc:8481/select/0/prometheus</span></span><br><span class="line"><span class="attr">      notifier:</span></span><br><span class="line"><span class="attr">        alertmanager:</span></span><br><span class="line"><span class="attr">          url:</span> <span class="attr">http://vma-victoria-metrics-alert-alertmanager.default.svc:9093</span></span><br><span class="line"><span class="attr">  alertmanager:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h4 id="配置alert-manager"><a href="#配置alert-manager" class="headerlink" title="配置alert manager"></a>配置alert manager</h4><p>kubectl edit configmap vma-victoria-metrics-alert-alertmanager-config</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">global:</span><br><span class="line">  smtp_smarthost: &apos;smtp.qq.com:465&apos;</span><br><span class="line">  smtp_from: &apos;2977358239@qq.com&apos;</span><br><span class="line">  smtp_auth_username: &apos;2977358239@qq.com&apos;</span><br><span class="line">  smtp_auth_password: &apos;jgigqzrlhycddhcf&apos; # 这里是邮箱的授权密码，不是登录密码</span><br><span class="line">  smtp_require_tls: false</span><br><span class="line">templates:</span><br><span class="line">  - &apos;/alertmanager/template/*.tmpl&apos;</span><br><span class="line">route:</span><br><span class="line">  group_by: [&apos;severity&apos;, &apos;source&apos;]</span><br><span class="line">  group_wait: 30s</span><br><span class="line">  group_interval: 5m</span><br><span class="line">  repeat_interval: 10m</span><br><span class="line">  receiver: email</span><br><span class="line">receivers:</span><br><span class="line">- name: &apos;email&apos;</span><br><span class="line">  email_configs:</span><br><span class="line">  - to: &apos;nimingkun@ruqimobility.com&apos;</span><br><span class="line">    send_resolved: true</span><br></pre></td></tr></table></figure>

<h4 id="配置vmalert"><a href="#配置vmalert" class="headerlink" title="配置vmalert"></a>配置vmalert</h4><p>kubectl edit configmap vma-victoria-metrics-alert-server-alert-rules-config</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">groups:</span><br><span class="line">- name: record</span><br><span class="line">  rules:</span><br><span class="line">  - record: job:node_memory_MemFree_bytes:percent  # 记录规则名称</span><br><span class="line">    expr: 100 - (100 * node_memory_MemFree_bytes / node_memory_MemTotal_bytes)</span><br><span class="line">- name: node</span><br><span class="line">  rules:  # 具体的报警规则</span><br><span class="line">  - alert: NodeMemoryUsage  # 报警规则的名称</span><br><span class="line">    expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100 &gt; 30</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      source: node</span><br><span class="line">      severity: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Node &#123;&#123;$labels.instance&#125;&#125; High Memory usage detected&quot;</span><br><span class="line">      description: &quot;&#123;&#123;$labels.instance&#125;&#125;: Memory usage is above 30% (current value is: &#123;&#123; $value &#125;&#125;)&quot;</span><br></pre></td></tr></table></figure>

<p>record规则单独使用，不能与alert规则混合，record规则不需要alert、for、labels和annotations字段<br>record 记录规则的主要作用是将一个给定的表达式的结果保存为一个新的时间序列，这样可以在Grafana等可视化工具中直接使用这些数据，而不需要每次都重新计算表达式。</p>
<h4 id="alert页面查看是否正常"><a href="#alert页面查看是否正常" class="headerlink" title="alert页面查看是否正常"></a>alert页面查看是否正常</h4><p>kubectl port-forward svc/vma-victoria-metrics-alert-server 8880:8880</p>
<p>查看所有的 Groups<br><img src="/image/placeholder.jpg" data-original="\image/vmalert_group.png"><br>查看报警规则列表的状态<br><img src="/image/placeholder.jpg" data-original="\image/vmalert_state.png"><br>查看报警规则的详细信息<br><img src="/image/placeholder.jpg" data-original="\image/vmalert_details.png"><br>查看邮箱(⚠️需确保发件邮箱的验证码正确)<br><img src="/image/placeholder.jpg" data-original="\image/alertmanager_mail.png"></p>
<p>我们添加的记录规则会通过 remote write 传递给 vminsert 保留下来，我们也可以通过 vmselect 查询到<br><img src="/image/placeholder.jpg" data-original="\image/vmui_select_record.png"></p>
<h4 id="排查过滤某些抓取指标过长导致卡主问题"><a href="#排查过滤某些抓取指标过长导致卡主问题" class="headerlink" title="排查过滤某些抓取指标过长导致卡主问题"></a>排查过滤某些抓取指标过长导致卡主问题</h4><p>先去查看vmstorage-vmcluster  vmstorage组件的日志，找到那条指标影响了<br>过滤customer服务的指标收集，在相应的job采集任务下添加如下配置即可</p>
<ul>
<li>source_labels: [__meta_kubernetes_pod_label_ruqi_app]<br>action: drop<br>regex: travel-platform-customerservice</li>
</ul>

        </div>

        
            <section class="post-copyright">
                
                
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tag/k8s/"># k8s</a>
                    
                        <a href="/tag/VictoriaMetrics/"># VictoriaMetrics</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">Back</a>
                <span>· </span>
                <a href="/">Home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2024/11/26/docker容器监控/">docker容器监控</a>
            
            
            <a class="next" rel="next" href="/2024/11/18/nginx-ingress配置跨域/">nginx-ingress配置</a>
            
        </section>

        <script src="https://giscus.app/client.js" data-repo="nmk0718/nmk0718.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkyMTE0NDU3NDY=" data-category="Announcements" data-category-id="DIC_kwDODJpn8s4Clzt8" data-mapping="title" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="noborder_light" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async>
</script>
    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© kk | Powered by <a href="https://hexo.io" target="_blank">Hexo</a></span>
    </div>
</footer>

    </div>

        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z\d\-\.\+]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(t.test(e.href)||r.test(e.href))&&(e.href=a.dataset.original)})});</script><script>(r=>{r.imageLazyLoadSetting.processImages=t;var a=r.imageLazyLoadSetting.isSPA,o=r.imageLazyLoadSetting.preloadRatio||1,d=i();function i(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(t){(a||t)&&(d=i());for(var e,n=0;n<d.length;n++)0<=(e=(e=d[n]).getBoundingClientRect()).bottom&&0<=e.left&&e.top<=(r.innerHeight*o||document.documentElement.clientHeight*o)&&(()=>{var t,e,a,o,i=d[n];e=function(){d=d.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).dataset.loaded||(t.hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(a=new Image,o=t.getAttribute("data-original"),a.onload=function(){t.src=o,t.removeAttribute("data-original"),t.setAttribute("data-loaded",!0),e&&e()},a.onerror=function(){t.removeAttribute("data-original"),t.setAttribute("data-loaded",!1),t.src=o},t.src!==o&&(a.src=o)))})()}function e(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",e),r.addEventListener("resize",e),r.addEventListener("orientationchange",e)})(this);</script></body>
</html>
