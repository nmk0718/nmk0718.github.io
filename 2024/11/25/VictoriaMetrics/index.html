<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">



<title>VictoriaMetrics | K&#39;s Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">kk&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">kk&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">VictoriaMetrics</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">nmk</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2024-11-25&nbsp;&nbsp;16:30:00</a>
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <p>VictoriaMetrics 是一款快速、经济高效且可扩展的时间序列数据库。可用作 Prometheus 的长期远程存储。如果提取率低于每秒​​一百万个数据点，建议使用单节点版本，而不是集群版本。</p>
<p>VictoriaMetrics集群由以下服务组成：</p>
<ul>
<li><code>vmstorage</code> 存储原始数据并返回给定标签过滤器在给定时间范围内的查询数据</li>
<li><code>vminsert</code> 接受采集的数据，并根据指标名称及其所有标签的一致性哈希，将其传播到 vmstorage 节点之间</li>
<li><code>vmselect</code> 通过从所有配置的 vmstorage 节点获取所需数据来执行传入查询</li>
<li><code>vmalert</code> 负责告警，和 Prometheus 一样支持纪录、告警两种规则配置与发送告警通知，允许在注解中使用 Go 模板来格式化数据、迭代或执行表达式，支持跨租户发送警报和记录规则</li>
<li><code>vmagent</code> 负责数据采集，重新标记和过滤收集到的指标，并通过 Prometheus 协议或通过 VictoriaMetrics 协议将它们存储在 VictoriaMetrics 或任何其他存储系统中。<img src="https://docs.victoriametrics.com/Cluster-VictoriaMetrics_cluster-scheme.webp">

</li>
</ul>
<p>部署参考文档：<br><a href="https://docs.victoriametrics.com/helm/victoriametrics-operator/" target="_blank" rel="noopener">https://docs.victoriametrics.com/helm/victoriametrics-operator/</a><br><a href="https://docs.victoriametrics.com/cluster-victoriametrics/" target="_blank" rel="noopener">https://docs.victoriametrics.com/cluster-victoriametrics/</a></p>
<h3 id="VictoriaMetrics-Helm-存储库"><a href="#VictoriaMetrics-Helm-存储库" class="headerlink" title="VictoriaMetrics Helm 存储库"></a>VictoriaMetrics Helm 存储库</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#helm添加repo</span></span><br><span class="line">➜  ~ helm repo add vm https://victoriametrics.github.io/helm-charts/</span><br><span class="line"><span class="string">"vm"</span> has been added to your repositories</span><br><span class="line"></span><br><span class="line"><span class="comment">#helm更新repo</span></span><br><span class="line">➜  ~ helm repo update</span><br><span class="line">Hang tight <span class="keyword">while</span> we grab the latest from your chart repositories...</span><br><span class="line">...Successfully got an update from the <span class="string">"aliyun"</span> chart repository</span><br><span class="line">...Successfully got an update from the <span class="string">"vm"</span> chart repository</span><br><span class="line">Update Complete. ⎈Happy Helming!⎈</span><br><span class="line"></span><br><span class="line"><span class="comment">#helm查看相关服务和版本</span></span><br><span class="line">➜  ~ helm search repo vm/</span><br><span class="line">NAME                           	CHART VERSION	APP VERSION	DESCRIPTION</span><br><span class="line">vm/victoria-logs-single        	0.8.2        	v1.0.0     	Victoria Logs Single version - high-performance...</span><br><span class="line">vm/victoria-metrics-agent      	0.14.9       	v1.106.1   	Victoria Metrics Agent - collects metrics from ...</span><br><span class="line">vm/victoria-metrics-alert      	0.12.6       	v1.106.1   	Victoria Metrics Alert - executes a list of giv...</span><br><span class="line">vm/victoria-metrics-anomaly    	1.6.7        	v1.18.4    	Victoria Metrics Anomaly Detection - a service ...</span><br><span class="line">vm/victoria-metrics-auth       	0.7.7        	v1.106.1   	Victoria Metrics Auth - is a simple auth proxy ...</span><br><span class="line">vm/victoria-metrics-cluster    	0.14.12      	v1.106.1   	Victoria Metrics Cluster version - high-perform...</span><br><span class="line">vm/victoria-metrics-common     	0.0.31       	           	Victoria Metrics Common - contains shared templ...</span><br><span class="line">vm/victoria-metrics-distributed	0.5.0        	v1.106.1   	A Helm chart <span class="keyword">for</span> Running VMCluster on Multiple ...</span><br><span class="line">vm/victoria-metrics-gateway    	0.5.7        	v1.106.1   	Victoria Metrics Gateway - Auth &amp; Rate-Limittin...</span><br><span class="line">vm/victoria-metrics-k8s-stack  	0.28.4       	v1.106.1   	Kubernetes monitoring on VictoriaMetrics stack....</span><br><span class="line">vm/victoria-metrics-operator   	0.38.0       	v0.49.1    	Victoria Metrics Operator</span><br><span class="line">vm/victoria-metrics-single     	0.12.7       	v1.106.1   	Victoria Metrics Single version - high-performa...</span><br></pre></td></tr></table></figure>

<h3 id="安装-VictoriaMetrics-Operator"><a href="#安装-VictoriaMetrics-Operator" class="headerlink" title="安装 VictoriaMetrics-Operator"></a>安装 VictoriaMetrics-Operator</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#使用命令安装</span></span><br><span class="line">➜  ~ helm install vmo vm/victoria-metrics-operator</span><br><span class="line">NAME: vmo</span><br><span class="line">LAST DEPLOYED: Tue Dec 24 14:38:21 2024</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">victoria-metrics-operator has been installed. Check its status by running:</span><br><span class="line">  kubectl --namespace default get pods -l <span class="string">"app.kubernetes.io/instance=vmo"</span></span><br><span class="line"></span><br><span class="line">Get more information on https://github.com/VictoriaMetrics/helm-charts/tree/master/charts/victoria-metrics-operator.</span><br><span class="line">See <span class="string">"Getting started guide for VM Operator"</span> on https://docs.victoriametrics.com/guides/getting-started-with-vm-operator</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看pod状态</span></span><br><span class="line">➜  ~ kubectl get pods -A | grep <span class="string">'vmo'</span></span><br><span class="line">default       vmo-victoria-metrics-operator-54bf97548f-fj8j7   1/1     Running   0             1m</span><br></pre></td></tr></table></figure>

<h3 id="安装VictoriaMetrics-Cluster"><a href="#安装VictoriaMetrics-Cluster" class="headerlink" title="安装VictoriaMetrics Cluster"></a>安装VictoriaMetrics Cluster</h3><p>Operator 会根据我们的定义去部署集群,可以通过 kubectl explain VMCluster.spec 来查看对象可配置的属性</p>
<h4 id="vmcluster-yaml"><a href="#vmcluster-yaml" class="headerlink" title="vmcluster.yaml"></a>vmcluster.yaml</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">operator.victoriametrics.com/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VMCluster</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">vmcluster</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">victoria-metrics</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment">#数据保留的时长,默认保留期为 1 个月， 默认单位为 m(月)，支持的单位有 h (hour), d (day), w (week), y (year)</span></span><br><span class="line"><span class="attr">  retentionPeriod:</span> <span class="string">"1w"</span></span><br><span class="line">  <span class="comment">#开启副本，并控制副本数量，会往多个vmstorage插入同一份样本数据</span></span><br><span class="line">  <span class="comment">#replicationFactor: 2</span></span><br><span class="line"><span class="attr">  vmstorage:</span></span><br><span class="line">    <span class="comment">#副本数</span></span><br><span class="line"><span class="attr">    replicaCount:</span> <span class="number">2</span></span><br><span class="line">    <span class="comment">#数据持久化</span></span><br><span class="line"><span class="attr">    storageDataPath:</span> <span class="string">/vm-data</span></span><br><span class="line"><span class="attr">    storage:</span></span><br><span class="line"><span class="attr">      volumeClaimTemplate:</span></span><br><span class="line"><span class="attr">        spec:</span></span><br><span class="line"><span class="attr">          storageClassName:</span> <span class="string">cbs</span></span><br><span class="line"><span class="attr">          resources:</span></span><br><span class="line"><span class="attr">            requests:</span></span><br><span class="line"><span class="attr">              storage:</span> <span class="number">10</span><span class="string">Gi</span></span><br><span class="line">    <span class="comment">#资源大小</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      limits:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="string">"0.5"</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">500</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">  vmselect:</span></span><br><span class="line"><span class="attr">    replicaCount:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">    cacheMountPath:</span> <span class="string">"/select-cache"</span></span><br><span class="line"><span class="attr">    storage:</span></span><br><span class="line"><span class="attr">      volumeClaimTemplate:</span></span><br><span class="line"><span class="attr">        spec:</span></span><br><span class="line"><span class="attr">          storageClassName:</span> <span class="string">cbs</span></span><br><span class="line"><span class="attr">          resources:</span></span><br><span class="line"><span class="attr">            requests:</span></span><br><span class="line"><span class="attr">              storage:</span> <span class="string">"2Gi"</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      limits:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="string">"0.3"</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="string">"300Mi"</span></span><br><span class="line"><span class="attr">  vminsert:</span></span><br><span class="line"><span class="attr">    replicaCount:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p><code>注意</code>：</p>
<ul>
<li>开启replicationFactor，vmagent会产生replicationFactor份冗余数据，需要dedup.minScrapeInterval参数，来去除重复数据。</li>
<li>开启或修改replicationFactor,可能造成数据部分丢失。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#根据自定义的配置进行安装</span></span><br><span class="line">➜  ~ kubectl apply -f vmcluster.yaml</span><br><span class="line">vmcluster.operator.victoriametrics.com/vmcluster created</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看是否正常启动</span></span><br><span class="line">➜  ~ kubectl get pods</span><br><span class="line">NAME                                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">vminsert-vmcluster-8587774678-2xxt6              1/1     Running   0          12s</span><br><span class="line">vminsert-vmcluster-8587774678-mplrr              1/1     Running   0          12s</span><br><span class="line">vmo-victoria-metrics-operator-5d4ff4d8f4-gk4gj   1/1     Running   0          3m58s</span><br><span class="line">vmselect-vmcluster-0                             1/1     Running   0          17s</span><br><span class="line">vmselect-vmcluster-1                             1/1     Running   0          17s</span><br><span class="line">vmstorage-vmcluster-0                            1/1     Running   0          23s</span><br><span class="line">vmstorage-vmcluster-1                            1/1     Running   0          23s</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看集群状态信息</span></span><br><span class="line">➜  ~ kubectl get vmclusters</span><br><span class="line">NAME        INSERT COUNT   STORAGE COUNT   SELECT COUNT   AGE   STATUS</span><br><span class="line">vmcluster   2              2               2              63s   operational</span><br><span class="line"></span><br><span class="line"><span class="comment">#获取vminsert服务名</span></span><br><span class="line">➜  ~ kubectl get svc | grep vminsert</span><br><span class="line">vminsert-vmcluster              ClusterIP   10.105.160.47    &lt;none&gt;        8480/TCP                     6m49s</span><br></pre></td></tr></table></figure>

<h4 id="vmagent-yaml"><a href="#vmagent-yaml" class="headerlink" title="vmagent.yaml"></a>vmagent.yaml</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">operator.victoriametrics.com/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VMAgent</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">vmagent</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  serviceScrapeNamespaceSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  podScrapeNamespaceSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  podScrapeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  serviceScrapeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  nodeScrapeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  nodeScrapeNamespaceSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  staticScrapeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  staticScrapeNamespaceSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  replicaCount:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  remoteWrite:</span></span><br><span class="line"><span class="attr">    - url:</span> <span class="string">"http://vminsert-vmcluster.default.svc.cluster.local:8480/insert/0/prometheus/api/v1/write"</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>VMAgent的<code>remoteWrite.url</code> 由以下部分组成：</p>
<ul>
<li>“service_name.VMCluster_namespace.svc.kubernetes_cluster_domain”<br>在例子中，它是vminsert-vmcluster.default.svc.cluster.local</li>
</ul>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#根据自定义的配置进行安装</span></span><br><span class="line">➜  ~ kubectl apply -f vmagent.yaml</span><br><span class="line">vmagent.operator.victoriametrics.com/vmagent created</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置本地端口转发访问(生产环境可使用ingress或nodeport转发访问)</span></span><br><span class="line">➜  ~ kubectl port-forward svc/vmagent-vmagent 8429:8429</span><br><span class="line">Forwarding from 127.0.0.1:8429 -&gt; 8429</span><br><span class="line">Forwarding from [::1]:8429 -&gt; 8429</span><br><span class="line">Handling connection <span class="keyword">for</span> 8429</span><br><span class="line">Handling connection <span class="keyword">for</span> 8429</span><br></pre></td></tr></table></figure>

<p>在浏览器中打开<a href="http://127.0.0.1:8429/targets" target="_blank" rel="noopener">http://127.0.0.1:8429/targets</a> 查看VMAgent是否从 K8s 集群收集指标</p>
<img src="https://docs.victoriametrics.com/guides/getting-started-with-vm-operator/vmcluster.webp">


<h3 id="验证-VictoriaMetrics-Cluster"><a href="#验证-VictoriaMetrics-Cluster" class="headerlink" title="验证 VictoriaMetrics Cluster"></a>验证 VictoriaMetrics Cluster</h3><p>获取vmselect服务名</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">➜  ~ kubectl get svc | grep vmselect</span><br><span class="line">vmselect-vmcluster              ClusterIP   None             &lt;none&gt;        8481/TCP                     31m</span><br></pre></td></tr></table></figure>

<h4 id="安装Grafana"><a href="#安装Grafana" class="headerlink" title="安装Grafana"></a>安装Grafana</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">| helm install grafana grafana/grafana -f -</span></span><br><span class="line"><span class="string"></span><span class="attr">  datasources:</span></span><br><span class="line">    <span class="string">datasources.yaml:</span></span><br><span class="line"><span class="attr">      apiVersion:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      datasources:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">victoriametrics</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">          orgId:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          url:</span> <span class="attr">http://vmselect-vmcluster.default.svc.cluster.local:8481/select/0/prometheus/</span></span><br><span class="line"><span class="attr">          access:</span> <span class="string">proxy</span></span><br><span class="line"><span class="attr">          isDefault:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">          updateIntervalSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">          editable:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  dashboardProviders:</span></span><br><span class="line">   <span class="string">dashboardproviders.yaml:</span></span><br><span class="line"><span class="attr">     apiVersion:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">     providers:</span></span><br><span class="line"><span class="attr">     - name:</span> <span class="string">'default'</span></span><br><span class="line"><span class="attr">       orgId:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">       folder:</span> <span class="string">''</span></span><br><span class="line"><span class="attr">       type:</span> <span class="string">file</span></span><br><span class="line"><span class="attr">       disableDeletion:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">       editable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">       options:</span></span><br><span class="line"><span class="attr">         path:</span> <span class="string">/var/lib/grafana/dashboards/default</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  dashboards:</span></span><br><span class="line"><span class="attr">    default:</span></span><br><span class="line"><span class="attr">      victoriametrics:</span></span><br><span class="line"><span class="attr">        gnetId:</span> <span class="number">11176</span></span><br><span class="line"><span class="attr">        revision:</span> <span class="number">18</span></span><br><span class="line"><span class="attr">        datasource:</span> <span class="string">victoriametrics</span></span><br><span class="line"><span class="attr">      vmagent:</span></span><br><span class="line"><span class="attr">        gnetId:</span> <span class="number">12683</span></span><br><span class="line"><span class="attr">        revision:</span> <span class="number">7</span></span><br><span class="line"><span class="attr">        datasource:</span> <span class="string">victoriametrics</span></span><br><span class="line"><span class="attr">      kubernetes:</span></span><br><span class="line"><span class="attr">        gnetId:</span> <span class="number">14205</span></span><br><span class="line"><span class="attr">        revision:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        datasource:</span> <span class="string">victoriametrics</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h3 id="浏览器验证"><a href="#浏览器验证" class="headerlink" title="浏览器验证"></a>浏览器验证</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#查看admin密码</span></span><br><span class="line">➜  ~ kubectl get secret --namespace default grafana -o jsonpath=<span class="string">"&#123;.data.admin-password&#125;"</span> | base64 --decode ; <span class="built_in">echo</span></span><br><span class="line">wVj5Rdl1BuPClRy5qgxrztsaoE8v0e4m05DU1cUW</span><br><span class="line"><span class="comment">#转发配置本地端口转发访问</span></span><br><span class="line">➜  ~ <span class="built_in">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span class="string">"app.kubernetes.io/name=grafana,app.kubernetes.io/instance=grafana"</span> -o jsonpath=<span class="string">"&#123;.items[0].metadata.name&#125;"</span>)</span><br><span class="line">➜  ~ kubectl --namespace default port-forward <span class="variable">$POD_NAME</span> 3000</span><br><span class="line">Forwarding from 127.0.0.1:3000 -&gt; 3000</span><br><span class="line">Forwarding from [::1]:3000 -&gt; 3000</span><br></pre></td></tr></table></figure>

<p>访问:<code>http://localhost:3000</code><br><img src="https://docs.victoriametrics.com/guides/getting-started-with-vm-operator/vmcluster-grafana1.webp"><br><img src="https://docs.victoriametrics.com/guides/getting-started-with-vm-operator/vmcluster-grafana2.webp"></p>
<p>默认情况下 VMAgent 会采集 VM 集群相关组件的指标，但是没有采集其他的指标，比如 node-exporter，我们可以通过 VMNodeScrape 这个 CRD 对象来进行定义，VMNodeScrape 对象可以用来自动发现 Kubernetes 节点，创建资源对象来采集 node-exporter 指标，在 Grafana 中导入 16098 这个 dashboard来查看</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">➜  ~ vi vmnode-exporter-scrape.yaml</span><br><span class="line">➜  ~ kubectl apply -f vmnode-exporter-scrape.yaml</span><br><span class="line">vmnodescrape.operator.victoriametrics.com/node-exporter created</span><br><span class="line">➜  ~ kubectl get vmnodescrape</span><br><span class="line">NAME            AGE   STATUS        SYNC ERROR</span><br><span class="line">node-exporter   6s    operational</span><br></pre></td></tr></table></figure>

<h4 id="vmui"><a href="#vmui" class="headerlink" title="vmui"></a>vmui</h4><p>VictoriaMetrics Cluster提供了用于查询故障排除和探索的 UI</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">➜  ~ kubectl --namespace default port-forward $POD_NAME 8481</span><br><span class="line">Forwarding from 127.0.0.1:3000 -&gt; 3000</span><br><span class="line">Forwarding from [::1]:3000 -&gt; 3000</span><br></pre></td></tr></table></figure>

<p>访问:<code>http://localhost:8481/select/0/vmui/</code></p>
<h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h3><p>容器K8S接入victoria操作步骤</p>
<p>1，首先在集群控制台上</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#创建monitor的命名空间</span></span><br><span class="line">➜  ~ kubectl create ns monitor</span><br><span class="line">namespace/monitor created</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看k8s版本</span></span><br><span class="line">➜  ~ kubectl version --short</span><br><span class="line">Flag --short has been deprecated, and will be removed <span class="keyword">in</span> the future. The --short output will become the default.</span><br><span class="line">Client Version: v1.24.0</span><br><span class="line">Kustomize Version: v4.5.4</span><br><span class="line">Server Version: v1.18.20</span><br><span class="line">WARNING: version difference between client (1.24) and server (1.18) exceeds the supported minor version skew of +/-1</span><br></pre></td></tr></table></figure>

<p>2，在该命名空间中创建prometheus-k8s的serviceaccount：<br>ServiceAccount.yaml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="string">app.kubernetes.io/component:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="string">app.kubernetes.io/instance:</span> <span class="string">k8s</span></span><br><span class="line">    <span class="string">app.kubernetes.io/name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="string">app.kubernetes.io/part-of:</span> <span class="string">kube-prometheus</span></span><br><span class="line">    <span class="string">app.kubernetes.io/version:</span> <span class="number">1.18</span><span class="number">.20</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">monitor</span></span><br></pre></td></tr></table></figure>


<p>3，创建secret,会自动创建token（k8s在1.24版本后创建serviceaccount不会自动创建绑定secret，需要事先创建secret来绑定到serviceaccount）：<br>Secret.yaml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">kubernetes.io/service-account.name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">prometheus-k8s-secret</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/service-account-token</span></span><br></pre></td></tr></table></figure>

<p>4，创建cluster role<br>ClusterRole.yaml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="string">app.kubernetes.io/component:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="string">app.kubernetes.io/instance:</span> <span class="string">k8s</span></span><br><span class="line">    <span class="string">app.kubernetes.io/name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="string">app.kubernetes.io/part-of:</span> <span class="string">kube-prometheus</span></span><br><span class="line">    <span class="string">app.kubernetes.io/version:</span> <span class="number">1.18</span><span class="number">.20</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">pods</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br></pre></td></tr></table></figure>

<p>5，授权给serviceaccount<br>ClusterRoleBinding.yaml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="string">app.kubernetes.io/component:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="string">app.kubernetes.io/instance:</span> <span class="string">k8s</span></span><br><span class="line">    <span class="string">app.kubernetes.io/name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="string">app.kubernetes.io/part-of:</span> <span class="string">kube-prometheus</span></span><br><span class="line">    <span class="string">app.kubernetes.io/version:</span> <span class="number">1.18</span><span class="number">.20</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">monitor</span></span><br></pre></td></tr></table></figure>

<p>6，在vm集群中创建好dce集群的comfigmap</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#查看prometheus-k8s-secret中的token</span></span><br><span class="line">➜  ~ kubectl get secret prometheus-k8s-secret -n monitor -o yaml | grep token</span><br><span class="line">  token: ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNkltUnVibTFSYUVkbVdtTlBUR2hzZHpVd1dEZE9UVWhhZFdKdlJVZHpaMDV2Y1hOcmFqTnNTM1ZVYUhNaWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUp0YjI1cGRHOXlJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbkJ5YjIxbGRHaGxkWE10YXpoekxYTmxZM0psZENJc0ltdDFZbVZ5Ym1WMFpYTXVhVzh2YzJWeWRtbGpaV0ZqWTI5MWJuUXZjMlZ5ZG1salpTMWhZMk52ZFc1MExtNWhiV1VpT2lKd2NtOXRaWFJvWlhWekxXczRjeUlzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJak5rTWpJd01qQm1MVEZsTXpjdE5EaGxaQzFpTVRkbExUazVOMlEwWVRSbVpUUTVOU0lzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwdGIyNXBkRzl5T25CeWIyMWxkR2hsZFhNdGF6aHpJbjAuaVFGRjI3N3U5MGEtODR4aGR0dXVPeUdvWWdZRGpTNWJOQkhEVm1lSUZ3blVqMy1zY3U1RkJfTjhjYVc3d1JhUXNjaDN6Tk0tbWwwSVZUbXRSNjVFREZxVTNiRV85SGlKS1R1UlFfb2NUTVRjQUJKT3I5YnotY19IMFNsSlJlSUN6dlVlM0M1SUxhV2JERkJSRGxfVlRKTXBhVjMxZTlacXN6YTVMRGE5MkJDYldoaldzd2tOR1pSOUppeFVwTW1Mb2dKZFN2Nm0wcjFxelQwU2NjeEw2STRSa2JEUkhDZ1p5ZlhKc1Y3T1d5cmdoT0dwX2FJYTdJUHItbC00dEV0cGhoTFd4MjJMTWFFOW5odkJCZ2dHUVR4a2VDcEY1MWRjSzAtQ3phTjNWV1htckNHajJyT1BzTXdzaVdsOHJ3bk1BdmhYdmVaSGRCVFYwT2dQYkVkWXF3</span><br><span class="line">      &#123;<span class="string">"apiVersion"</span>:<span class="string">"v1"</span>,<span class="string">"kind"</span>:<span class="string">"Secret"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;<span class="string">"kubernetes.io/service-account.name"</span>:<span class="string">"prometheus-k8s"</span>&#125;,<span class="string">"name"</span>:<span class="string">"prometheus-k8s-secret"</span>,<span class="string">"namespace"</span>:<span class="string">"monitor"</span>&#125;,<span class="string">"type"</span>:<span class="string">"kubernetes.io/service-account-token"</span>&#125;</span><br><span class="line"><span class="built_in">type</span>: kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line"><span class="comment">#对token进行base64解密</span></span><br><span class="line">➜  ~ <span class="built_in">echo</span> <span class="string">"ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNkltUnVibTFSYUVkbVdtTlBUR2hzZHpVd1dEZE9UVWhhZFdKdlJVZHpaMDV2Y1hOcmFqTnNTM1ZVYUhNaWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUp0YjI1cGRHOXlJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbkJ5YjIxbGRHaGxkWE10YXpoekxYTmxZM0psZENJc0ltdDFZbVZ5Ym1WMFpYTXVhVzh2YzJWeWRtbGpaV0ZqWTI5MWJuUXZjMlZ5ZG1salpTMWhZMk52ZFc1MExtNWhiV1VpT2lKd2NtOXRaWFJvWlhWekxXczRjeUlzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJak5rTWpJd01qQm1MVEZsTXpjdE5EaGxaQzFpTVRkbExUazVOMlEwWVRSbVpUUTVOU0lzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwdGIyNXBkRzl5T25CeWIyMWxkR2hsZFhNdGF6aHpJbjAuaVFGRjI3N3U5MGEtODR4aGR0dXVPeUdvWWdZRGpTNWJOQkhEVm1lSUZ3blVqMy1zY3U1RkJfTjhjYVc3d1JhUXNjaDN6Tk0tbWwwSVZUbXRSNjVFREZxVTNiRV85SGlKS1R1UlFfb2NUTVRjQUJKT3I5YnotY19IMFNsSlJlSUN6dlVlM0M1SUxhV2JERkJSRGxfVlRKTXBhVjMxZTlacXN6YTVMRGE5MkJDYldoaldzd2tOR1pSOUppeFVwTW1Mb2dKZFN2Nm0wcjFxelQwU2NjeEw2STRSa2JEUkhDZ1p5ZlhKc1Y3T1d5cmdoT0dwX2FJYTdJUHItbC00dEV0cGhoTFd4MjJMTWFFOW5odkJCZ2dHUVR4a2VDcEY1MWRjSzAtQ3phTjNWV1htckNHajJyT1BzTXdzaVdsOHJ3bk1BdmhYdmVaSGRCVFYwT2dQYkVkWXF3"</span> |base64 --decode</span><br></pre></td></tr></table></figure>

<p>把上面base64 解密后文件写在如下 token里<br>dec-token-configmap.yaml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  token:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    eyJhbGciOiJSUzI1NiIsImtpZCI6ImRubm1RaEdmWmNPTGhsdzUwWDdOTUhadWJvRUdzZ05vcXNrajNsS3VUaHMifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJtb25pdG9yIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6InByb21ldGhldXMtazhzLXNlY3JldCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJwcm9tZXRoZXVzLWs4cyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjNkMjIwMjBmLTFlMzctNDhlZC1iMTdlLTk5N2Q0YTRmZTQ5NSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDptb25pdG9yOnByb21ldGhldXMtazhzIn0.iQFF277u90a-84xhdtuuOyGoYgYDjS5bNBHDVmeIFwnUj3-scu5FB_N8caW7wRaQsch3zNM-ml0IVTmtR65EDFqU3bE_9HiJKTuRQ_ocTMTcABJOr9bz-c_H0SlJReICzvUe3C5ILaWbDFBRDl_VTJMpaV31e9Zqsza5LDa92BCbWhjWswkNGZR9JixUpMmLogJdSv6m0r1qzT0SccxL6I4RkbDRHCgZyfXJsV7OWyrghOGp_aIa7IPr-l-4tEtphhLWx22LMaE9nhvBBggGQTxkeCpF51dcK0-CzaN3VWXmrCGj2rOPsMwsiWl8rwnMAvhXveZHdBTV0OgPbEdYqw</span></span><br><span class="line"><span class="string"></span><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">dec-token-configmap</span></span><br></pre></td></tr></table></figure>

<p>部署dce-token-configmap </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  ~ kubectl apply -f dec-token-configmap.yaml</span><br><span class="line">configmap/dec-token-configmap created</span><br></pre></td></tr></table></figure>

<p>7，在vmagent.yaml文件配置</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">operator.victoriametrics.com/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VMAgent</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">vmagent</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  scrapeInterval:</span> <span class="number">20</span><span class="string">s</span></span><br><span class="line"><span class="attr">  replicaCount:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="number">4</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="number">8</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">    limits:</span></span><br><span class="line"><span class="attr">      cpu:</span> <span class="number">4</span></span><br><span class="line"><span class="attr">      memory:</span> <span class="number">8</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  volumeMounts:</span></span><br><span class="line"><span class="attr">  - mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/dec-token/</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">dec-token</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">  - configMap:</span></span><br><span class="line"><span class="attr">      defaultMode:</span> <span class="number">420</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">dec-token-configmap</span> </span><br><span class="line"><span class="attr">    name:</span> <span class="string">dec-token</span></span><br><span class="line"><span class="attr">  remoteWrite:</span></span><br><span class="line"><span class="attr">    - url:</span> <span class="string">"http://vminsert-vmcluster.default.svc.cluster.local:8480/insert/0/prometheus/api/v1/write"</span></span><br><span class="line"><span class="attr">  inlineScrapeConfig:</span> <span class="string">|</span></span><br><span class="line"><span class="string"></span><span class="attr">    - job_name:</span> <span class="string">dce-exporter</span></span><br><span class="line"><span class="attr">      honor_timestamps:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment">#间隔时间</span></span><br><span class="line"><span class="attr">      scrape_interval:</span> <span class="number">20</span><span class="string">s</span></span><br><span class="line">      <span class="comment">#超时时间</span></span><br><span class="line"><span class="attr">      scrape_timeout:</span> <span class="number">30</span><span class="string">s</span></span><br><span class="line"><span class="attr">      metrics_path:</span> <span class="string">/actuator/prometheus</span></span><br><span class="line"><span class="attr">      scheme:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">      tls_config:</span></span><br><span class="line"><span class="attr">        insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="attr">      - api_server:</span> <span class="attr">http://10.30.150.11:16443</span></span><br><span class="line"><span class="attr">        role:</span> <span class="string">pod</span></span><br><span class="line"><span class="attr">        bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/marketing-token/token</span></span><br><span class="line"><span class="attr">        tls_config:</span></span><br><span class="line"><span class="attr">          insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      relabel_configs:</span></span><br><span class="line"><span class="attr">        - source_labels:</span> <span class="string">[__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span></span><br><span class="line"><span class="attr">          separator:</span> <span class="string">;</span></span><br><span class="line"><span class="attr">          regex:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">          replacement:</span> <span class="string">$1</span></span><br><span class="line"><span class="attr">          action:</span> <span class="string">keep</span></span><br><span class="line"><span class="attr">        - source_labels:</span> <span class="string">[__meta_kubernetes_pod_annotation_prometheus_io_path]</span></span><br><span class="line"><span class="attr">          separator:</span> <span class="string">;</span></span><br><span class="line"><span class="attr">          regex:</span> <span class="string">(.+)</span></span><br><span class="line"><span class="attr">          target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line"><span class="attr">          replacement:</span> <span class="string">$1</span></span><br><span class="line"><span class="attr">          action:</span> <span class="string">replace</span></span><br><span class="line"><span class="attr">        - source_labels:</span> <span class="string">[__address__,</span> <span class="string">__meta_kubernetes_pod_annotation_prometheus_io_port]</span></span><br><span class="line"><span class="attr">          separator:</span> <span class="string">;</span></span><br><span class="line"><span class="attr">          regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line"><span class="attr">          target_label:</span> <span class="string">__address__</span></span><br><span class="line"><span class="attr">          replacement:</span> <span class="string">$1:$2</span></span><br><span class="line"><span class="attr">          action:</span> <span class="string">replace</span></span><br><span class="line"><span class="attr">        - separator:</span> <span class="string">;</span></span><br><span class="line"><span class="attr">          regex:</span> <span class="string">__meta_kubernetes_pod_label_(.+)</span></span><br><span class="line"><span class="attr">          replacement:</span> <span class="string">$1</span></span><br><span class="line"><span class="attr">          action:</span> <span class="string">labelmap</span></span><br><span class="line"><span class="attr">        - source_labels:</span> <span class="string">[__meta_kubernetes_namespace]</span></span><br><span class="line"><span class="attr">          separator:</span> <span class="string">;</span></span><br><span class="line"><span class="attr">          regex:</span> <span class="string">(.*)</span></span><br><span class="line"><span class="attr">          target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line"><span class="attr">          replacement:</span> <span class="string">$1</span></span><br><span class="line"><span class="attr">          action:</span> <span class="string">replace</span></span><br><span class="line"><span class="attr">        - source_labels:</span> <span class="string">[__meta_kubernetes_pod_name]</span></span><br><span class="line"><span class="attr">          separator:</span> <span class="string">;</span></span><br><span class="line"><span class="attr">          regex:</span> <span class="string">(.*)</span></span><br><span class="line"><span class="attr">          target_label:</span> <span class="string">kubernetes_pod_name</span></span><br><span class="line"><span class="attr">          replacement:</span> <span class="string">$1</span></span><br><span class="line"><span class="attr">          action:</span> <span class="string">replace</span></span><br></pre></td></tr></table></figure>

<p>加载配置文件：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  ~ kubectl apply -f vmagent.yaml</span><br><span class="line">vmagent.operator.victoriametrics.com/vmagent configured</span><br></pre></td></tr></table></figure>

<p>vmagent 查看配置是否生效及相关日志：<br>去TKE集群控制台看日志</p>
<h4 id="排查过滤某些抓取指标过长导致卡主问题"><a href="#排查过滤某些抓取指标过长导致卡主问题" class="headerlink" title="排查过滤某些抓取指标过长导致卡主问题"></a>排查过滤某些抓取指标过长导致卡主问题</h4><p>先去查看vmstorage-vmcluster  vmstorage组件的日志，找到那条指标影响了<br>过滤customer服务的指标收集，在相应的job采集任务下添加如下配置即可</p>
<ul>
<li>source_labels: [__meta_kubernetes_pod_label_ruqi_app]<br>action: drop<br>regex: travel-platform-customerservice</li>
</ul>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>nmk</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://nmk0718.github.io/2024/11/25/VictoriaMetrics/">http://nmk0718.github.io/2024/11/25/VictoriaMetrics/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2020 <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tag/k8s/"># k8s</a>
                    
                        <a href="/tag/VictoriaMetrics/"># VictoriaMetrics</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2024/11/26/docker容器监控/">docker容器监控</a>
            
            
            <a class="next" rel="next" href="/2024/11/18/nginx-ingress配置跨域/">nginx-ingress配置</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© nmk | Powered by <a href="https://hexo.io" target="_blank">Hexo</a></span>
	</div>
</footer>

    </div>
</body>
</html>
