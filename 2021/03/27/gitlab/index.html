<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">



<title>GitLab | K&#39;s Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">nimingkun&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">nimingkun&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">GitLab</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">nmk</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2021-3-27&nbsp;&nbsp;15:23:00</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <h3 id="GitLab-CI-CD"><a href="#GitLab-CI-CD" class="headerlink" title="GitLab CI/CD"></a>GitLab CI/CD</h3><h4 id="使用docker下载gitlab镜像"><a href="#使用docker下载gitlab镜像" class="headerlink" title="使用docker下载gitlab镜像"></a>使用docker下载gitlab镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull gitlab&#x2F;gitlab-ce</span><br></pre></td></tr></table></figure>

<h4 id="检查镜像下载是否成功"><a href="#检查镜像下载是否成功" class="headerlink" title="检查镜像下载是否成功"></a>检查镜像下载是否成功</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@public ~]# docker images</span><br><span class="line">REPOSITORY                                TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">gitlab&#x2F;gitlab-ce                          latest              85ef0c92d667        3 days ago          1.98GB</span><br></pre></td></tr></table></figure>

<h4 id="创建数据存储目录"><a href="#创建数据存储目录" class="headerlink" title="创建数据存储目录"></a>创建数据存储目录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@public ~]# mkdir -p &#x2F;opt&#x2F;gitlab&#x2F;data</span><br><span class="line">[root@public ~]# mkdir &#x2F;opt&#x2F;gitlab&#x2F;logs</span><br><span class="line">[root@public ~]# mkdir &#x2F;opt&#x2F;gitlab&#x2F;config</span><br></pre></td></tr></table></figure>

<h4 id="启动gitlab"><a href="#启动gitlab" class="headerlink" title="启动gitlab"></a>启动gitlab</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@public gitlab]# docker run --detach \</span><br><span class="line">       --hostname 192.168.229.8 \</span><br><span class="line">       --publish 8443:443 --publish 9080:80 --publish 2222:22 \</span><br><span class="line">       --name gitlab \</span><br><span class="line">       --restart always \</span><br><span class="line">       --privileged&#x3D;true \</span><br><span class="line">       --volume &#x2F;file&#x2F;gitlab&#x2F;config:&#x2F;etc&#x2F;gitlab \</span><br><span class="line">	   --volume &#x2F;file&#x2F;gitlab&#x2F;logs:&#x2F;var&#x2F;log&#x2F;gitlab \</span><br><span class="line">       --volume &#x2F;file&#x2F;gitlab&#x2F;data:&#x2F;var&#x2F;opt&#x2F;gitlab \</span><br><span class="line">   	   docker.io&#x2F;gitlab&#x2F;gitlab-ce:latest</span><br></pre></td></tr></table></figure>

<p><strong>gitlab如使用单台服务器可使用默认配置,若跟别的服务放一起会出现gitlab占用内存过多问题</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;file&#x2F;gitlab&#x2F;config&#x2F;gitlab.rb</span><br><span class="line"></span><br><span class="line">#去掉下面的注释</span><br><span class="line"></span><br><span class="line">unicorn[&#39;worker_processes&#39;] &#x3D; 2</span><br><span class="line"></span><br><span class="line">#之后执行</span><br><span class="line"></span><br><span class="line">docker exec -it gitlab gitlab-ctl reconfigure</span><br><span class="line"></span><br><span class="line">docker exec -it gitlab gitlab-ctl restart</span><br></pre></td></tr></table></figure>

<p>gitlab初始用户名密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@deployment &#x2F;]# cat &#x2F;opt&#x2F;gitlab&#x2F;config&#x2F;initial_root_password </span><br><span class="line"># WARNING: This value is valid only in the following conditions</span><br><span class="line">#          1. If provided manually (either via &#96;GITLAB_ROOT_PASSWORD&#96; environment variable or via &#96;gitlab_rails[&#39;initial_root_password&#39;]&#96; setting in &#96;gitlab.rb&#96;, it was provided before database was seeded for the first time (usually, the first reconfigure run).</span><br><span class="line">#          2. Password hasn&#39;t been changed manually, either via UI or via command line.</span><br><span class="line">#</span><br><span class="line">#          If the password shown here doesn&#39;t work, you must reset the admin password following https:&#x2F;&#x2F;docs.gitlab.com&#x2F;ee&#x2F;security&#x2F;reset_user_password.html#reset-your-root-password.</span><br><span class="line"></span><br><span class="line">Password: GHztfkIk0eg4qdTTNn5owN+7jK3ojlUHLrXMibB5Pj8&#x3D;</span><br><span class="line"></span><br><span class="line"># NOTE: This file will be automatically deleted in the first reconfigure run after 24 hours.</span><br></pre></td></tr></table></figure>

<h4 id="安装GitLab-Runner"><a href="#安装GitLab-Runner" class="headerlink" title="安装GitLab Runner"></a>安装GitLab Runner</h4><p>下载并安装二进制文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># Download the binary for your system</span><br><span class="line">curl -L --output &#x2F;usr&#x2F;local&#x2F;bin&#x2F;gitlab-runner https:&#x2F;&#x2F;gitlab-runner-downloads.s3.amazonaws.com&#x2F;latest&#x2F;binaries&#x2F;gitlab-runner-linux-amd64</span><br><span class="line"></span><br><span class="line"># Give it permissions to execute</span><br><span class="line">chmod +x &#x2F;usr&#x2F;local&#x2F;bin&#x2F;gitlab-runner</span><br><span class="line"></span><br><span class="line"># Create a GitLab CI user</span><br><span class="line">useradd --comment &#39;GitLab Runner&#39; --create-home gitlab-runner --shell &#x2F;bin&#x2F;bash</span><br><span class="line"></span><br><span class="line"># Install and run as service</span><br><span class="line">gitlab-runner install --user&#x3D;gitlab-runner --working-directory&#x3D;&#x2F;home&#x2F;gitlab-runner</span><br><span class="line">gitlab-runner start</span><br></pre></td></tr></table></figure>

<h4 id="注册runner的命令"><a href="#注册runner的命令" class="headerlink" title="注册runner的命令"></a>注册runner的命令</h4><p>注册的地址要填写为ip+port.不要使用web页面展示的<a href="http://ip//" target="_blank" rel="noopener">http://ip//</a> 否则注册失败</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@deployment &#x2F;]# gitlab-runner register</span><br><span class="line">Runtime platform                                    arch&#x3D;amd64 os&#x3D;linux pid&#x3D;86642 revision&#x3D;58ba2b95 version&#x3D;14.2.0</span><br><span class="line">Running in system-mode.                            </span><br><span class="line">                                                   </span><br><span class="line">Enter the GitLab instance URL (for example, https:&#x2F;&#x2F;gitlab.com&#x2F;):</span><br><span class="line">http:&#x2F;&#x2F;192.168.50.52:9090&#x2F;</span><br><span class="line">Enter the registration token:</span><br><span class="line">cZ8xxddc9zciAHAsJpqB</span><br><span class="line">Enter a description for the runner:</span><br><span class="line">[deployment]: test</span><br><span class="line">Enter tags for the runner (comma-separated):</span><br><span class="line">test</span><br><span class="line">Registering runner... succeeded                     runner&#x3D;cZ8xxddc</span><br><span class="line">Enter an executor: docker, docker-ssh, parallels, shell, virtualbox, kubernetes, custom, ssh, docker+machine, docker-ssh+machine:</span><br><span class="line">shell</span><br><span class="line">Runner registered successfully. Feel free to start it, but if it&#39;s running already the config should be automatically reloaded!</span><br></pre></td></tr></table></figure>

<p>Runner连接</p>
<p>不要把Runner和gitlab部署在一台机器 不然会一直显示未连接</p>
<img src="\image/image-20210830152258004.png">

<p>Runner的构建目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;home&#x2F;gitlab-runner&#x2F;builds&#x2F;ymVX6kY7&#x2F;0&#x2F;</span><br></pre></td></tr></table></figure>

<p>Runner的注册后的配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;gitlab-runner&#x2F;config.toml</span><br></pre></td></tr></table></figure>

<p>GitLab-CI.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">variables:</span><br><span class="line">  GIT_STRATEGY: clone</span><br><span class="line"></span><br><span class="line">before_script:</span><br><span class="line">  - pwd</span><br><span class="line">  </span><br><span class="line">stages:</span><br><span class="line">  - build</span><br><span class="line">  - deploy</span><br><span class="line">  </span><br><span class="line">build-job:</span><br><span class="line">  stage: build</span><br><span class="line">  tags:</span><br><span class="line">    - nimingkun</span><br><span class="line">  only:</span><br><span class="line">    - release</span><br><span class="line">  script:</span><br><span class="line">    - mvn clean install -Dmaven.test.skip&#x3D;true</span><br><span class="line">    - cp ymall&#x2F;target&#x2F;ymall-0.0.1-SNAPSHOT.jar  dockerfile&#x2F;</span><br><span class="line">    - cd dockerfile &amp;&amp; sh build.sh ymall</span><br><span class="line">  artifacts:</span><br><span class="line">    paths:</span><br><span class="line">      - ymall&#x2F;target&#x2F;ymall-0.0.1-SNAPSHOT.jar</span><br><span class="line"></span><br><span class="line">deploy-job:</span><br><span class="line">  stage: deploy</span><br><span class="line">  tags:</span><br><span class="line">    - nimingkun</span><br><span class="line">  only:</span><br><span class="line">    - release</span><br><span class="line">  script:</span><br><span class="line">    - sh CD.sh</span><br></pre></td></tr></table></figure>

<p>会出现报错,因为git版本告知的错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fatal: git fetch-pack: expected shallow list</span><br><span class="line">fatal: The remote end hung up unexpectedly</span><br></pre></td></tr></table></figure>

<p>解决方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install  http:&#x2F;&#x2F;opensource.wandisco.com&#x2F;centos&#x2F;7&#x2F;git&#x2F;x86_64&#x2F;wandisco-git-release-7-2.noarch.rpm</span><br><span class="line">yum update git</span><br></pre></td></tr></table></figure>

<p>CI中出现打包镜像错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Got permission denied while trying to connect to the Docker daemon socket at unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker.sock: Post http:&#x2F;&#x2F;%2Fvar%2Frun%2Fdocker.sock&#x2F;v1.24&#x2F;build?buildargs&#x3D;%7B%7D&amp;cachefrom&#x3D;%5B%5D&amp;cgroupparent&#x3D;&amp;cpuperiod&#x3D;0&amp;cpuquota&#x3D;0&amp;cpusetcpus&#x3D;&amp;cpusetmems&#x3D;&amp;cpushares&#x3D;0&amp;dockerfile&#x3D;Dockerfile&amp;labels&#x3D;%7B%7D&amp;memory&#x3D;0&amp;memswap&#x3D;0&amp;networkmode&#x3D;default&amp;rm&#x3D;1&amp;shmsize&#x3D;0&amp;t&#x3D;192.168.50.52%3A8551%2Fymall%3Alatest&amp;target&#x3D;&amp;ulimits&#x3D;null&amp;version&#x3D;1: dial unix &#x2F;var&#x2F;run&#x2F;docker.sock: connect: permission denied</span><br></pre></td></tr></table></figure>

<p>原因:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">使用root账户直接yum安装docker，然后service docker start启动docker服务。Gitlab-CI默认以gitlab-runner用户执行，因此对&#x2F;var&#x2F;run&#x2F;docker.sock无访问权限，无法与docker daemon通信</span><br></pre></td></tr></table></figure>

<p>解决方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">groupadd -r docker</span><br><span class="line">useradd -g docker -r docker -p &#39;password&#39;</span><br><span class="line"></span><br><span class="line">usermod -aG docker gitlab-runner</span><br><span class="line"></span><br><span class="line">service docker stop</span><br><span class="line">su docker </span><br><span class="line">sudo service docker start</span><br></pre></td></tr></table></figure>

<p>我这里仅为测试GitLab-CI,故直接添加docker到gitlab-runner组</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">usermod -aG  docker gitlab-runner</span><br></pre></td></tr></table></figure>

<p>拉取Git仓库时报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Initialized empty Git repository in &#x2F;private&#x2F;var&#x2F;folders&#x2F;g5&#x2F;8twmk1xj481_6btvppyw5j4h0000gp&#x2F;T&#x2F;.tmpNYVg6H&#x2F;.git&#x2F;</span><br><span class="line">hint: Using &#39;master&#39; as the name for the initial branch. This default branch name</span><br><span class="line">hint: is subject to change. To configure the initial branch name to use in all</span><br><span class="line">hint: of your new repositories, which will suppress this warning, call:</span><br><span class="line">hint: </span><br><span class="line">hint:   git config --global init.defaultBranch &lt;name&gt;</span><br><span class="line">hint: </span><br><span class="line">hint: Names commonly chosen instead of &#39;master&#39; are &#39;main&#39;, &#39;trunk&#39; and</span><br><span class="line">hint: &#39;development&#39;. The just-created branch can be renamed via this command:</span><br><span class="line">hint: </span><br><span class="line">hint:   git branch -m &lt;name&gt;</span><br></pre></td></tr></table></figure>

<p>解决方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global init.defaultBranch master</span><br></pre></td></tr></table></figure>

<h4 id="GitLab-CI-文件详解"><a href="#GitLab-CI-文件详解" class="headerlink" title="GitLab-CI 文件详解"></a>GitLab-CI 文件详解</h4><table>
<thead>
<tr>
<th>关键字</th>
<th>是否必须</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>variables</td>
<td>非必须</td>
<td>在job级别上定义的变量</td>
</tr>
<tr>
<td>before_script</td>
<td>非必须</td>
<td>提前执行的脚本</td>
</tr>
<tr>
<td>stages</td>
<td>必须</td>
<td>指定一组job在不同场景阶段执行。在相同<strong>stage</strong>下的job(任务)将会被<strong>并行的</strong>执行</td>
</tr>
<tr>
<td>job-name</td>
<td>必须</td>
<td>流水线的任务的名称</td>
</tr>
<tr>
<td>stage</td>
<td>必须</td>
<td>与stages内的场景阶段对应</td>
</tr>
<tr>
<td>tags</td>
<td>非必须</td>
<td>定义了哪些runner适用该job</td>
</tr>
<tr>
<td>only</td>
<td>非必须</td>
<td>定义哪些git引用（分支）适用该job</td>
</tr>
<tr>
<td>except</td>
<td>非必须</td>
<td>定义了哪些git引用(分支)不适用该job</td>
</tr>
<tr>
<td>script</td>
<td>必须</td>
<td>定义Runner需要执行的脚本或命令</td>
</tr>
<tr>
<td>artifacts</td>
<td>非必须</td>
<td>产物,通过paths指定文件后,可在gitlab页面下载改产物</td>
</tr>
<tr>
<td>after_script</td>
<td>非必须</td>
<td>后执行的脚本</td>
</tr>
<tr>
<td>environment</td>
<td>非必须</td>
<td>定义让job完成部署的环境名称</td>
</tr>
</tbody></table>
<p><strong>only</strong>和<strong>except</strong>两个参数说明了job什么时候将会被创建:</p>
<ol>
<li><strong>only</strong>定义了job需要执行的所在分支或者标签</li>
<li><strong>except</strong>定义了job不会执行的所在分支或者标签</li>
</ol>
<p>以下是这两个参数的几条用法规则：</p>
<ol>
<li><strong>only</strong>和<strong>except</strong>如果都存在在一个job声明中，则所需引用将会被<strong>only</strong>和<strong>except</strong>所定义的分支过滤.</li>
<li><strong>only</strong>和<strong>except</strong>允许使用正则</li>
<li><strong>only</strong>和<strong>except</strong>允许使用指定仓库地址，但是不forks仓库</li>
</ol>
<p>此外，<strong>only</strong>和<strong>except</strong>允许使用以下一些特殊关键字：</p>
<table>
<thead>
<tr>
<th align="center">值</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">branches</td>
<td align="center">当一个分支被push上来</td>
</tr>
<tr>
<td align="center">tags</td>
<td align="center">当一个打了tag的分支被push上来</td>
</tr>
<tr>
<td align="center">api</td>
<td align="center">当一个pipline被piplines api所触发调起，详见<a href="https://link.segmentfault.com/?url=https%3A%2F%2Fdocs.gitlab.com%2Fce%2Fapi%2Fpipelines.html" target="_blank" rel="noopener">piplines api</a></td>
</tr>
<tr>
<td align="center">external</td>
<td align="center">当使用了GitLab以外的CI服务</td>
</tr>
<tr>
<td align="center">pipelines</td>
<td align="center">针对多项目触发器而言，当使用CI_JOB_TOKEN并使用gitlab所提供的api创建多个pipelines的时候</td>
</tr>
<tr>
<td align="center">pushes</td>
<td align="center">当pipeline被用户的git push操作所触发的时候</td>
</tr>
<tr>
<td align="center">schedules</td>
<td align="center">针对预定好的pipline而言（每日构建一类~，具体请看<a href="https://link.segmentfault.com/?url=https%3A%2F%2Fdocs.gitlab.com%2Fce%2Fuser%2Fproject%2Fpipelines%2Fschedules.html" target="_blank" rel="noopener">链接</a>）</td>
</tr>
<tr>
<td align="center">triggers</td>
<td align="center">用token创建piplines的时候</td>
</tr>
<tr>
<td align="center">web</td>
<td align="center">在GitLab页面上Pipelines标签页下，你按了<strong>run pipline</strong>的时候</td>
</tr>
</tbody></table>
<p>下面的例子，<strong>job</strong>将会只在<strong>issue-</strong>开头的refs下执行，反之则其他所有分支被跳过：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">job:</span><br><span class="line">  <span class="comment"># use regexp</span></span><br><span class="line">  only:</span><br><span class="line">    - /^issue-.*$/</span><br><span class="line">  <span class="comment"># use special keyword</span></span><br><span class="line">  except:</span><br><span class="line">    - branches</span><br></pre></td></tr></table></figure>

<p>在这个例子中，<strong>job</strong>只会在打了tag的分支，或者被api所触发，或者每日构建任务上运行，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">job:</span><br><span class="line">  <span class="comment"># use special keywords</span></span><br><span class="line">  only:</span><br><span class="line">    - tags</span><br><span class="line">    - triggers</span><br><span class="line">    - schedules</span><br></pre></td></tr></table></figure>

<p>Git Strategy（git策略）</p>
<p>你可以通过在全局变量设置位置或者job局部变量设置位置来设置<strong>GIT_STRATEGY</strong>用以获取应用最近更新的代码。如果没有指定，默认的项目设置将会被使用。</p>
<p>该选项有三个可能的值：clone,fetch和none</p>
<p>clone是最慢的选项，如果设置该值，每个job将会都克隆一遍仓库，确保项目工作空间总是原始的正确的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">variables:</span><br><span class="line">  GIT_STRATEGY: <span class="built_in">clone</span></span><br></pre></td></tr></table></figure>

<p>fetch是更快的操作选项，因为他重用了项目的工作空间（如果没有的话，会去clone）, git clean用于撤销上一个job的任何操作，git fetch是用来重新获取上一个job运行到当前job产生的commit</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">variables:</span><br><span class="line">  GIT_STRATEGY: fetch</span><br></pre></td></tr></table></figure>

<p>none也同样重用了项目空间（但是他会跳过所有git操作，包括如果存在的gitlab runner的预克隆脚本）。其主要用于只是为了操作artifacts的job上（例如depoly部署行为）。此时Git仓库的数据可能是存在的，但它一定不是最新的。所以在设置了none的job里你应该依赖从cache或者artifacts来的数据，而不是仓库数据。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">variables:</span><br><span class="line">  GIT_STRATEGY: none</span><br></pre></td></tr></table></figure>

<p>Shallow cloning (浅克隆)</p>
<p>抓取或者克隆最新三条commits:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">variables:</span><br><span class="line">  GIT_DEPTH: <span class="string">"3"</span></span><br></pre></td></tr></table></figure>

<p>查看流水线阶段完成情况</p>
<img src="\image/image-20210830152017883.png">

<p>查看每个阶段的运行日志</p>
<img src="\image/image-20210830152103621.png">

<p>下载yml中定义的产物</p>
<img src="\image/image-20210830152157654.png">

<p>后续可深入了解 gitlab集成Kubernetes,Prometheus和Grafana.可在gitlab查看部署情况,查看Kubernetes日志,审核是否发布等操作</p>
<h4 id="备份gitlab"><a href="#备份gitlab" class="headerlink" title="备份gitlab"></a>备份gitlab</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ2zeaxvb40ng4w24tpogoZ file]# crontab -l</span><br><span class="line">0 0 *&#x2F;3 * * sh &#x2F;file&#x2F;backup.sh</span><br><span class="line"></span><br><span class="line">[root@iZ2zeaxvb40ng4w24tpogoZ file]# cat &#x2F;file&#x2F;gitlab&#x2F;push_aliyun.sh   </span><br><span class="line">docker commit -m &quot;gitlab&quot; 5f36554b62b3 registry-vpc.cn-beijing.aliyuncs.com&#x2F;lepeng&#x2F;gitlab:&#96;date +%F&#96;</span><br><span class="line">docker push registry-vpc.cn-beijing.aliyuncs.com&#x2F;lepeng&#x2F;gitlab:&#96;date +%F&#96;</span><br><span class="line"></span><br><span class="line">[root@iZ2zeaxvb40ng4w24tpogoZ file]# cat &#x2F;file&#x2F;backup.sh</span><br><span class="line">cd &#x2F;file&#x2F;</span><br><span class="line">tar zcvf gitlabconfig&#96;date +%F&#96;.tar config</span><br><span class="line">tar zcvf gitlabdata&#96;date +%F&#96;.tar data</span><br><span class="line">mv *.tar &#x2F;data1&#x2F;gitlab&#x2F;backup&#x2F;</span><br></pre></td></tr></table></figure>

<h4 id="gitlab配置ldap"><a href="#gitlab配置ldap" class="headerlink" title="gitlab配置ldap"></a>gitlab配置ldap</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;file&#x2F;config&#x2F;gitlab.rb</span><br><span class="line">gitlab_rails[&#39;ldap_enabled&#39;] &#x3D; true</span><br><span class="line">gitlab_rails[&#39;ldap_servers&#39;] &#x3D; YAML.load &lt;&lt;-&#39;EOS&#39;</span><br><span class="line">   main: # &#39;main&#39; is the GitLab &#39;provider ID&#39; of this LDAP server</span><br><span class="line">     label: &#39;LDAP&#39;</span><br><span class="line">     host: &#39;39.107.142.154&#39;</span><br><span class="line">     port: 389</span><br><span class="line">     uid: &#39;cn&#39;</span><br><span class="line">     bind_dn: &#39;cn&#x3D;admin,dc&#x3D;gzlplink,dc&#x3D;com&#39;</span><br><span class="line">     password: &#39;Lpldap123456&#39;</span><br><span class="line">     encryption: &#39;plain&#39; # &quot;start_tls&quot; or &quot;simple_tls&quot; or &quot;plain&quot;</span><br><span class="line">     verify_certificates: true</span><br><span class="line">     active_directory: true</span><br><span class="line">     #邮箱 用户名均可登录</span><br><span class="line">     allow_username_or_email_login: true</span><br><span class="line">     lowercase_usernames: false</span><br><span class="line">     #不允许用户注册</span><br><span class="line">     block_auto_created_users: false</span><br><span class="line">     base: &#39;ou&#x3D;研发部,cn&#x3D;admin,dc&#x3D;gzlplink,dc&#x3D;com&#39;</span><br><span class="line">     user_filter: &#39;&#39;</span><br><span class="line">     attributes:</span><br><span class="line">       username: [&#39;cn&#39;]</span><br><span class="line">       email:    [&#39;mail&#39;]</span><br><span class="line">       name:     &#39;description&#39;</span><br><span class="line">       first_name: &#39;givenName&#39;</span><br><span class="line">       last_name:  &#39;sn&#39;</span><br><span class="line">EOS</span><br></pre></td></tr></table></figure>

<ul>
<li><code>host</code> 和 <code>port</code> 是 LDAP 服务的主机地址及端口</li>
<li><code>bind_dn</code> 和 <code>password</code> 是一个管理 LDAP 的 dn 及密码</li>
<li><code>base</code> 表示 LDAP 将以该 dn 为 节点，向下查找用户</li>
<li><code>user_filter</code> 表示以某种过滤条件筛选用户，比如假设我们只希望所属组为 Developers 的用户来访问 GitLab，则可以在这里设置 <code>(memberOf=cn=Developers,cn=Groups,dc=xinhua,dc=org)</code></li>
<li><code>attributes</code> 表示 GitLab 中的字段与 LDAP 中哪些字段可以相互对应，比如可以用 LDAP 中的 <code>uid</code> 来作为 GitLab 用户名</li>
</ul>
<p>配置修改完成之后，运行下面命令重启 GitLab 服务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure>

<img src="\image\20180726164123668.png">

<p><strong>开启 HTTPS</strong></p>
<p>GitLab 默认没有开启 HTTPS，如果需要开启的话，需要按照下面的步骤执行：</p>
<p>首先，在配置文件 <code>/etc/gitlab/gitlab.rb</code> 中将下面一行中的协议由 HTTP 改成 HTTPS，并设置从 HTTP 到 HTTPS 的重定向：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">external_url &quot;https:&#x2F;&#x2F;gitlab.example.com&quot;</span><br><span class="line"></span><br><span class="line"># Redirect HTTP requests to HTTPS</span><br><span class="line">nginx[&#39;redirect_http_to_https&#39;] &#x3D; true</span><br></pre></td></tr></table></figure>

<p>然后创建一个 SSL 目录，并将网站证书导入进去：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># mkdir -p &#x2F;etc&#x2F;gitlab&#x2F;ssl</span><br><span class="line"># chmod 700 &#x2F;etc&#x2F;gitlab&#x2F;ssl</span><br><span class="line"># cp gitlab.xinhua.io.key gitlab.xinhua.io.crt &#x2F;etc&#x2F;gitlab&#x2F;ssl&#x2F;</span><br></pre></td></tr></table></figure>

<p>注意上面的证书必须以配置中的域名（如本文中的 <code>gitlab.xinhua.io</code>）为其文件名。</p>
<p>最后再执行 <code>gitlab-ctl reconfigure</code> 命令，即可通过 HTTPS 方式访问 GitLab 了</p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>nmk</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://nmk0718.github.io/2021/03/27/gitlab/">http://nmk0718.github.io/2021/03/27/gitlab/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2020 <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tag/GitLab/"># GitLab</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2021/03/27/skywalking/">Skywalking</a>
            
            
            <a class="next" rel="next" href="/2021/03/27/数据库备份与恢复/">数据库备份与恢复</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© nmk | Powered by <a href="https://hexo.io" target="_blank">Hexo</a></span>
	</div>
</footer>

    </div>
</body>
</html>
