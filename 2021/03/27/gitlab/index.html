<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">



<title>GitLab | K&#39;s Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">kk&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">kk&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">GitLab</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">nmk</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2021-3-27&nbsp;&nbsp;15:23:00</a>
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h3 id="GitLab-CI-CD"><a href="#GitLab-CI-CD" class="headerlink" title="GitLab CI/CD"></a>GitLab CI/CD</h3><h4 id="使用docker下载gitlab镜像"><a href="#使用docker下载gitlab镜像" class="headerlink" title="使用docker下载gitlab镜像"></a>使用docker下载gitlab镜像</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker</span> pull gitlab/gitlab-ce</span><br></pre></td></tr></table></figure>

<h4 id="检查镜像下载是否成功"><a href="#检查镜像下载是否成功" class="headerlink" title="检查镜像下载是否成功"></a>检查镜像下载是否成功</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@public ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY                                <span class="keyword">TAG</span>                 <span class="title">IMAGE</span> ID            CREATED             SIZE</span><br><span class="line">gitlab/gitlab-ce                          latest              <span class="number">85</span>ef0c92d667        <span class="number">3</span> days ago          <span class="number">1.98</span>GB</span><br></pre></td></tr></table></figure>

<h4 id="创建数据存储目录"><a href="#创建数据存储目录" class="headerlink" title="创建数据存储目录"></a>创建数据存储目录</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span><span class="keyword">public</span> ~]# mkdir -p /opt/gitlab/<span class="keyword">data</span></span><br><span class="line">[<span class="symbol">root@</span><span class="keyword">public</span> ~]# mkdir /opt/gitlab/logs</span><br><span class="line">[<span class="symbol">root@</span><span class="keyword">public</span> ~]# mkdir /opt/gitlab/config</span><br></pre></td></tr></table></figure>

<h4 id="启动gitlab"><a href="#启动gitlab" class="headerlink" title="启动gitlab"></a>启动gitlab</h4><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@public gitlab]<span class="comment"># docker run --detach \</span></span><br><span class="line">       <span class="params">--hostname</span> 192.168.229.8 \</span><br><span class="line">       <span class="params">--publish</span> 8443<span class="function">:443</span> <span class="params">--publish</span> 9080<span class="function">:80</span> <span class="params">--publish</span> 2222<span class="function">:22</span> \</span><br><span class="line">       <span class="params">--name</span> gitlab \</span><br><span class="line">       <span class="params">--restart</span> always \</span><br><span class="line">       <span class="params">--privileged=true</span> \</span><br><span class="line">       <span class="params">--volume</span> <span class="string">/file/gitlab/config</span>:<span class="string">/etc/gitlab</span> \</span><br><span class="line">	   <span class="params">--volume</span> <span class="string">/file/gitlab/logs</span>:<span class="string">/var/log/gitlab</span> \</span><br><span class="line">       <span class="params">--volume</span> <span class="string">/file/gitlab/data</span>:<span class="string">/var/opt/gitlab</span> \</span><br><span class="line">   	   docker.io/gitlab/gitlab-ce<span class="function">:latest</span></span><br></pre></td></tr></table></figure>

<p><strong>gitlab如使用单台服务器可使用默认配置,若跟别的服务放一起会出现gitlab占用内存过多问题</strong></p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vi /<span class="built_in">file</span>/gitlab/config/gitlab.rb</span><br><span class="line"></span><br><span class="line"><span class="comment">#去掉下面的注释</span></span><br><span class="line"></span><br><span class="line">unicorn[<span class="string">'worker_processes'</span>] = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#之后执行</span></span><br><span class="line"></span><br><span class="line">docker exec -<span class="keyword">it</span> gitlab gitlab-ctl reconfigure</span><br><span class="line"></span><br><span class="line">docker exec -<span class="keyword">it</span> gitlab gitlab-ctl restart</span><br></pre></td></tr></table></figure>

<p>gitlab初始用户名密码</p>
<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@deployment /]# cat /opt/gitlab/config/initial_root_password </span><br><span class="line"># <span class="literal">WARNING</span>: This value <span class="keyword">is</span> valid only <span class="keyword">in</span> the following conditions</span><br><span class="line">#          <span class="number">1</span>. <span class="keyword">If</span> provided manually (either via `GITLAB_ROOT_PASSWORD` environment <span class="keyword">variable</span> <span class="keyword">or</span> via `gitlab_rails[<span class="symbol">'initial_root_password</span>']` setting <span class="keyword">in</span> `gitlab.rb`, it was provided before database was seeded <span class="keyword">for</span> the first <span class="built_in">time</span> (usually, the first reconfigure run).</span><br><span class="line">#          <span class="number">2</span>. Password hasn<span class="symbol">'t</span> been changed manually, either via UI <span class="keyword">or</span> via command <span class="literal">line</span>.</span><br><span class="line">#</span><br><span class="line">#          <span class="keyword">If</span> the password shown here doesn<span class="symbol">'t</span> work, you must reset the admin password following https://docs.gitlab.com/ee/security/reset_user_password.html#reset-your-root-password.</span><br><span class="line"></span><br><span class="line">Password: GHztfkIk0eg4qdTTNn5owN+<span class="number">7</span>jK3ojlUHLrXMibB5Pj8=</span><br><span class="line"></span><br><span class="line"># <span class="literal">NOTE</span>: This <span class="keyword">file</span> will be automatically deleted <span class="keyword">in</span> the first reconfigure run <span class="keyword">after</span> <span class="number">24</span> hours.</span><br></pre></td></tr></table></figure>

<h4 id="安装GitLab-Runner"><a href="#安装GitLab-Runner" class="headerlink" title="安装GitLab Runner"></a>安装GitLab Runner</h4><p>下载并安装二进制文件</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Download the binary for your system</span></span><br><span class="line">curl -L <span class="params">--output</span> <span class="string">/usr/local/bin/gitlab-runner</span> https:<span class="string">//gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Give it permissions to execute</span></span><br><span class="line">chmod +x <span class="string">/usr/local/bin/gitlab-runner</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a GitLab CI user</span></span><br><span class="line">useradd <span class="params">--comment</span> 'GitLab Runner' <span class="params">--create-home</span> gitlab-runner <span class="params">--shell</span> <span class="string">/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Install and run as service</span></span><br><span class="line">gitlab-runner install <span class="params">--user=gitlab-runner</span> <span class="params">--working-directory=/home/gitlab-runner</span></span><br><span class="line">gitlab-runner start</span><br></pre></td></tr></table></figure>

<h4 id="注册runner的命令"><a href="#注册runner的命令" class="headerlink" title="注册runner的命令"></a>注册runner的命令</h4><p>注册的地址要填写为ip+port.不要使用web页面展示的<a href="http://ip//" target="_blank" rel="noopener">http://ip//</a> 否则注册失败</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@deployment /]# gitlab-runner register</span><br><span class="line">Runtime platform                                    <span class="keyword">arch</span>=amd64 os=linux pid=86642 revision=58ba2b95 <span class="keyword">version</span>=14.2.0</span><br><span class="line">Running <span class="keyword">in</span> system-mode.                            </span><br><span class="line">                                                   </span><br><span class="line">Enter the GitLab instance URL (<span class="keyword">for</span> example, https:<span class="comment">//gitlab.com/):</span></span><br><span class="line">http:<span class="comment">//192.168.50.52:9090/</span></span><br><span class="line">Enter the registration <span class="keyword">token</span>:</span><br><span class="line">cZ8xxddc9zciAHAsJpqB</span><br><span class="line">Enter a description <span class="keyword">for</span> the runner:</span><br><span class="line">[deployment]: <span class="keyword">test</span></span><br><span class="line">Enter tags <span class="keyword">for</span> the runner (comma-separated):</span><br><span class="line"><span class="keyword">test</span></span><br><span class="line">Registering runner... succeeded                     runner=cZ8xxddc</span><br><span class="line">Enter <span class="keyword">an</span> executor: docker, docker-ssh, parallels, <span class="keyword">shell</span>, virtualbox, kubernetes, custom, ssh, docker+machine, docker-ssh+machine:</span><br><span class="line"><span class="keyword">shell</span></span><br><span class="line">Runner registered successfully. Feel free to start it, but <span class="keyword">if</span> it's running already the config should be automatically reloaded!</span><br></pre></td></tr></table></figure>

<p>Runner连接</p>
<p>不要把Runner和gitlab部署在一台机器 不然会一直显示未连接</p>
<img src="\image/image-20210830152258004.png">

<p>Runner的构建目录</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/home/gi</span>tlab-runner<span class="regexp">/builds/ym</span>VX6kY7<span class="regexp">/0/</span></span><br></pre></td></tr></table></figure>

<p>Runner的注册后的配置文件</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/gitlab-runner/<span class="built_in">config</span>.toml</span><br></pre></td></tr></table></figure>

<p>GitLab-CI.yml</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">variable<span class="variable">s:</span></span><br><span class="line">  GIT_STRATEGY: clone</span><br><span class="line"></span><br><span class="line">before_scrip<span class="variable">t:</span></span><br><span class="line">  - <span class="keyword">pwd</span></span><br><span class="line">  </span><br><span class="line">stage<span class="variable">s:</span></span><br><span class="line">  - build</span><br><span class="line">  - deploy</span><br><span class="line">  </span><br><span class="line">build-jo<span class="variable">b:</span></span><br><span class="line">  stage: build</span><br><span class="line">  <span class="keyword">tag</span><span class="variable">s:</span></span><br><span class="line">    - nimingkun</span><br><span class="line">  <span class="keyword">only</span>:</span><br><span class="line">    - release</span><br><span class="line">  <span class="keyword">scrip</span><span class="variable">t:</span></span><br><span class="line">    - mvn clean install -Dmaven.test.skip=true</span><br><span class="line">    - <span class="keyword">cp</span> ymall/target/ymall-<span class="number">0.0</span>.<span class="number">1</span>-SNAPSHOT.jar  dockerfile/</span><br><span class="line">    - <span class="keyword">cd</span> dockerfile &amp;&amp; <span class="keyword">sh</span> build.<span class="keyword">sh</span> ymall</span><br><span class="line">  artifact<span class="variable">s:</span></span><br><span class="line">    path<span class="variable">s:</span></span><br><span class="line">      - ymall/target/ymall-<span class="number">0.0</span>.<span class="number">1</span>-SNAPSHOT.jar</span><br><span class="line"></span><br><span class="line">deploy-jo<span class="variable">b:</span></span><br><span class="line">  stage: deploy</span><br><span class="line">  <span class="keyword">tag</span><span class="variable">s:</span></span><br><span class="line">    - nimingkun</span><br><span class="line">  <span class="keyword">only</span>:</span><br><span class="line">    - release</span><br><span class="line">  <span class="keyword">scrip</span><span class="variable">t:</span></span><br><span class="line">    - <span class="keyword">sh</span> CD.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure>

<p>会出现报错,因为git版本告知的错误</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fata<span class="variable">l:</span> git fetch-pack: expected shallow <span class="keyword">list</span></span><br><span class="line">fata<span class="variable">l:</span> The remote end hung <span class="keyword">up</span> unexpectedly</span><br></pre></td></tr></table></figure>

<p>解决方法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span>  <span class="keyword">http</span>://opensource.wandisco.com/centos/<span class="number">7</span>/git/x86_64/wandisco-git-<span class="keyword">release</span><span class="number">-7</span><span class="number">-2.</span>noarch.rpm</span><br><span class="line">yum <span class="keyword">update</span> git</span><br></pre></td></tr></table></figure>

<p>CI中出现打包镜像错误</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Got permission denied while trying <span class="keyword">to</span> connect <span class="keyword">to</span> the Docker daemon socket at unix:///var/run/docker.sock: Post http://<span class="symbol">%2</span>Fvar<span class="symbol">%2</span>Frun<span class="symbol">%2</span>Fdocker.sock/v<span class="number">1.24</span>/build?buildargs=<span class="symbol">%7</span>B<span class="symbol">%7</span>D&amp;cachefrom=<span class="symbol">%5</span>B<span class="symbol">%5</span>D&amp;cgroupparent=&amp;cpuperiod=<span class="number">0</span>&amp;cpuquota=<span class="number">0</span>&amp;cpusetcpus=&amp;cpusetmems=&amp;cpushares=<span class="number">0</span>&amp;dockerfile=Dockerfile&amp;labels=<span class="symbol">%7</span>B<span class="symbol">%7</span>D&amp;memory=<span class="number">0</span>&amp;memswap=<span class="number">0</span>&amp;networkmode=<span class="keyword">default</span>&amp;rm=<span class="number">1</span>&amp;shmsize=<span class="number">0</span>&amp;t=<span class="number">192.168</span>.<span class="number">50.52</span><span class="symbol">%3</span>A<span class="number">8551</span><span class="symbol">%2</span>Fymall<span class="symbol">%3</span>Alatest&amp;<span class="keyword">target</span>=&amp;ulimits=<span class="keyword">null</span>&amp;version=<span class="number">1</span>: dial unix /var/run/docker.sock: connect: permission denied</span><br></pre></td></tr></table></figure>

<p>原因:</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">使用root账户直接yum安装docker，然后service docker start启动docker服务。Gitlab-<span class="keyword">CI</span>默认以gitlab-runner用户执行，因此对/<span class="keyword">var</span>/<span class="keyword">run</span>/docker.sock无访问权限，无法与docker daemon通信</span><br></pre></td></tr></table></figure>

<p>解决方法</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">groupadd -r docker</span><br><span class="line">useradd -g docker -r docker -p <span class="string">'password'</span></span><br><span class="line"></span><br><span class="line">usermod -aG docker gitlab-runner</span><br><span class="line"></span><br><span class="line">service docker <span class="built_in">stop</span></span><br><span class="line">su docker </span><br><span class="line">sudo service docker <span class="built_in">start</span></span><br></pre></td></tr></table></figure>

<p>我这里仅为测试GitLab-CI,故直接添加docker到gitlab-runner组</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">usermod -aG  docker gitlab-runner</span></span><br></pre></td></tr></table></figure>

<p>拉取Git仓库时报错</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Initialized <span class="built_in">empty</span> Git repository in /private/var/folders/g5/<span class="number">8</span>twmk1xj481_6btvppyw5j4h0000gp/T/.tmpNYVg6H/.git/</span><br><span class="line">hin<span class="variable">t:</span> Using <span class="string">'master'</span> <span class="keyword">as</span> the name <span class="keyword">for</span> the initial branch. This default branch name</span><br><span class="line">hin<span class="variable">t:</span> <span class="keyword">is</span> subject <span class="keyword">to</span> <span class="keyword">change</span>. To configure the initial branch name <span class="keyword">to</span> use in <span class="keyword">all</span></span><br><span class="line">hin<span class="variable">t:</span> of your <span class="keyword">new</span> repositories, which will suppress this warning, <span class="keyword">cal</span><span class="variable">l:</span></span><br><span class="line">hin<span class="variable">t:</span> </span><br><span class="line">hin<span class="variable">t:</span>   git config --<span class="keyword">global</span> init.defaultBranch <span class="symbol">&lt;name&gt;</span></span><br><span class="line">hin<span class="variable">t:</span> </span><br><span class="line">hin<span class="variable">t:</span> Names commonly chosen instead of <span class="string">'master'</span> are <span class="string">'main'</span>, <span class="string">'trunk'</span> <span class="built_in">and</span></span><br><span class="line">hin<span class="variable">t:</span> <span class="string">'development'</span>. The just-created branch can <span class="keyword">be</span> renamed via this <span class="keyword">command</span>:</span><br><span class="line">hin<span class="variable">t:</span> </span><br><span class="line">hin<span class="variable">t:</span>   git branch -<span class="keyword">m</span> <span class="symbol">&lt;name&gt;</span></span><br></pre></td></tr></table></figure>

<p>解决方法</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git<span class="built_in"> config </span>--global init.defaultBranch master</span><br></pre></td></tr></table></figure>

<h4 id="GitLab-CI-文件详解"><a href="#GitLab-CI-文件详解" class="headerlink" title="GitLab-CI 文件详解"></a>GitLab-CI 文件详解</h4><table>
<thead>
<tr>
<th>关键字</th>
<th>是否必须</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>variables</td>
<td>非必须</td>
<td>在job级别上定义的变量</td>
</tr>
<tr>
<td>before_script</td>
<td>非必须</td>
<td>提前执行的脚本</td>
</tr>
<tr>
<td>stages</td>
<td>必须</td>
<td>指定一组job在不同场景阶段执行。在相同<strong>stage</strong>下的job(任务)将会被<strong>并行的</strong>执行</td>
</tr>
<tr>
<td>job-name</td>
<td>必须</td>
<td>流水线的任务的名称</td>
</tr>
<tr>
<td>stage</td>
<td>必须</td>
<td>与stages内的场景阶段对应</td>
</tr>
<tr>
<td>tags</td>
<td>非必须</td>
<td>定义了哪些runner适用该job</td>
</tr>
<tr>
<td>only</td>
<td>非必须</td>
<td>定义哪些git引用（分支）适用该job</td>
</tr>
<tr>
<td>except</td>
<td>非必须</td>
<td>定义了哪些git引用(分支)不适用该job</td>
</tr>
<tr>
<td>script</td>
<td>必须</td>
<td>定义Runner需要执行的脚本或命令</td>
</tr>
<tr>
<td>artifacts</td>
<td>非必须</td>
<td>产物,通过paths指定文件后,可在gitlab页面下载改产物</td>
</tr>
<tr>
<td>after_script</td>
<td>非必须</td>
<td>后执行的脚本</td>
</tr>
<tr>
<td>environment</td>
<td>非必须</td>
<td>定义让job完成部署的环境名称</td>
</tr>
</tbody></table>
<p><strong>only</strong>和<strong>except</strong>两个参数说明了job什么时候将会被创建:</p>
<ol>
<li><strong>only</strong>定义了job需要执行的所在分支或者标签</li>
<li><strong>except</strong>定义了job不会执行的所在分支或者标签</li>
</ol>
<p>以下是这两个参数的几条用法规则：</p>
<ol>
<li><strong>only</strong>和<strong>except</strong>如果都存在在一个job声明中，则所需引用将会被<strong>only</strong>和<strong>except</strong>所定义的分支过滤.</li>
<li><strong>only</strong>和<strong>except</strong>允许使用正则</li>
<li><strong>only</strong>和<strong>except</strong>允许使用指定仓库地址，但是不forks仓库</li>
</ol>
<p>此外，<strong>only</strong>和<strong>except</strong>允许使用以下一些特殊关键字：</p>
<table>
<thead>
<tr>
<th align="center">值</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">branches</td>
<td align="center">当一个分支被push上来</td>
</tr>
<tr>
<td align="center">tags</td>
<td align="center">当一个打了tag的分支被push上来</td>
</tr>
<tr>
<td align="center">api</td>
<td align="center">当一个pipline被piplines api所触发调起，详见<a href="https://link.segmentfault.com/?url=https%3A%2F%2Fdocs.gitlab.com%2Fce%2Fapi%2Fpipelines.html" target="_blank" rel="noopener">piplines api</a></td>
</tr>
<tr>
<td align="center">external</td>
<td align="center">当使用了GitLab以外的CI服务</td>
</tr>
<tr>
<td align="center">pipelines</td>
<td align="center">针对多项目触发器而言，当使用CI_JOB_TOKEN并使用gitlab所提供的api创建多个pipelines的时候</td>
</tr>
<tr>
<td align="center">pushes</td>
<td align="center">当pipeline被用户的git push操作所触发的时候</td>
</tr>
<tr>
<td align="center">schedules</td>
<td align="center">针对预定好的pipline而言（每日构建一类~，具体请看<a href="https://link.segmentfault.com/?url=https%3A%2F%2Fdocs.gitlab.com%2Fce%2Fuser%2Fproject%2Fpipelines%2Fschedules.html" target="_blank" rel="noopener">链接</a>）</td>
</tr>
<tr>
<td align="center">triggers</td>
<td align="center">用token创建piplines的时候</td>
</tr>
<tr>
<td align="center">web</td>
<td align="center">在GitLab页面上Pipelines标签页下，你按了<strong>run pipline</strong>的时候</td>
</tr>
</tbody></table>
<p>下面的例子，<strong>job</strong>将会只在<strong>issue-</strong>开头的refs下执行，反之则其他所有分支被跳过：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">job:</span><br><span class="line">  <span class="comment"># use regexp</span></span><br><span class="line">  only:</span><br><span class="line">    - /^issue-.*$/</span><br><span class="line">  <span class="comment"># use special keyword</span></span><br><span class="line">  except:</span><br><span class="line">    - branches</span><br></pre></td></tr></table></figure>

<p>在这个例子中，<strong>job</strong>只会在打了tag的分支，或者被api所触发，或者每日构建任务上运行，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">job:</span><br><span class="line">  <span class="comment"># use special keywords</span></span><br><span class="line">  only:</span><br><span class="line">    - tags</span><br><span class="line">    - triggers</span><br><span class="line">    - schedules</span><br></pre></td></tr></table></figure>

<p>Git Strategy（git策略）</p>
<p>你可以通过在全局变量设置位置或者job局部变量设置位置来设置<strong>GIT_STRATEGY</strong>用以获取应用最近更新的代码。如果没有指定，默认的项目设置将会被使用。</p>
<p>该选项有三个可能的值：clone,fetch和none</p>
<p>clone是最慢的选项，如果设置该值，每个job将会都克隆一遍仓库，确保项目工作空间总是原始的正确的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">variables:</span><br><span class="line">  GIT_STRATEGY: <span class="built_in">clone</span></span><br></pre></td></tr></table></figure>

<p>fetch是更快的操作选项，因为他重用了项目的工作空间（如果没有的话，会去clone）, git clean用于撤销上一个job的任何操作，git fetch是用来重新获取上一个job运行到当前job产生的commit</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">variables:</span><br><span class="line">  GIT_STRATEGY: fetch</span><br></pre></td></tr></table></figure>

<p>none也同样重用了项目空间（但是他会跳过所有git操作，包括如果存在的gitlab runner的预克隆脚本）。其主要用于只是为了操作artifacts的job上（例如depoly部署行为）。此时Git仓库的数据可能是存在的，但它一定不是最新的。所以在设置了none的job里你应该依赖从cache或者artifacts来的数据，而不是仓库数据。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">variables:</span><br><span class="line">  GIT_STRATEGY: none</span><br></pre></td></tr></table></figure>

<p>Shallow cloning (浅克隆)</p>
<p>抓取或者克隆最新三条commits:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">variables:</span><br><span class="line">  GIT_DEPTH: <span class="string">"3"</span></span><br></pre></td></tr></table></figure>

<p>查看流水线阶段完成情况</p>
<img src="\image/image-20210830152017883.png">

<p>查看每个阶段的运行日志</p>
<img src="\image/image-20210830152103621.png">

<p>下载yml中定义的产物</p>
<img src="\image/image-20210830152157654.png">

<p>后续可深入了解 gitlab集成Kubernetes,Prometheus和Grafana.可在gitlab查看部署情况,查看Kubernetes日志,审核是否发布等操作</p>
<h4 id="备份gitlab"><a href="#备份gitlab" class="headerlink" title="备份gitlab"></a>备份gitlab</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ2zeaxvb40ng4w24tpogoZ <span class="keyword">file</span>]# crontab -<span class="keyword">l</span></span><br><span class="line"><span class="number">0</span> <span class="number">0</span> */<span class="number">3</span> * * <span class="keyword">sh</span> /<span class="keyword">file</span>/backup.<span class="keyword">sh</span></span><br><span class="line"></span><br><span class="line">[root@iZ2zeaxvb40ng4w24tpogoZ <span class="keyword">file</span>]# <span class="keyword">cat</span> /<span class="keyword">file</span>/gitlab/push_aliyun.<span class="keyword">sh</span>   </span><br><span class="line">docker commit -<span class="keyword">m</span> <span class="string">"gitlab"</span> <span class="number">5</span>f36554b62b3 registry-vpc.<span class="keyword">cn</span>-beijing.aliyuncs.<span class="keyword">com</span>/lepeng/gitla<span class="variable">b:</span>`date +%F`</span><br><span class="line">docker push registry-vpc.<span class="keyword">cn</span>-beijing.aliyuncs.<span class="keyword">com</span>/lepeng/gitla<span class="variable">b:</span>`date +%F`</span><br><span class="line"></span><br><span class="line">[root@iZ2zeaxvb40ng4w24tpogoZ <span class="keyword">file</span>]# <span class="keyword">cat</span> /<span class="keyword">file</span>/backup.<span class="keyword">sh</span></span><br><span class="line"><span class="keyword">cd</span> /<span class="keyword">file</span>/</span><br><span class="line">tar zcvf gitlabconfig`date +%F`.tar config</span><br><span class="line">tar zcvf gitlabdata`date +%F`.tar data</span><br><span class="line">mv *.tar /data1/gitlab/backup/</span><br></pre></td></tr></table></figure>

<h4 id="gitlab配置ldap"><a href="#gitlab配置ldap" class="headerlink" title="gitlab配置ldap"></a>gitlab配置ldap</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">/file/config/gitlab.rb</span></span><br><span class="line"><span class="string">gitlab_rails['ldap_enabled']</span> <span class="string">=</span> <span class="literal">true</span></span><br><span class="line"><span class="string">gitlab_rails['ldap_servers']</span> <span class="string">=</span> <span class="string">YAML.load</span> <span class="string">&lt;&lt;-'EOS'</span></span><br><span class="line"><span class="attr">   main:</span> <span class="comment"># 'main' is the GitLab 'provider ID' of this LDAP server</span></span><br><span class="line"><span class="attr">     label:</span> <span class="string">'LDAP'</span></span><br><span class="line"><span class="attr">     host:</span> <span class="string">'39.107.142.154'</span></span><br><span class="line"><span class="attr">     port:</span> <span class="number">389</span></span><br><span class="line"><span class="attr">     uid:</span> <span class="string">'cn'</span></span><br><span class="line"><span class="attr">     bind_dn:</span> <span class="string">'cn=admin,dc=gzlplink,dc=com'</span></span><br><span class="line"><span class="attr">     password:</span> <span class="string">'Lpldap123456'</span></span><br><span class="line"><span class="attr">     encryption:</span> <span class="string">'plain'</span> <span class="comment"># "start_tls" or "simple_tls" or "plain"</span></span><br><span class="line"><span class="attr">     verify_certificates:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">     active_directory:</span> <span class="literal">true</span></span><br><span class="line">     <span class="comment">#邮箱 用户名均可登录</span></span><br><span class="line"><span class="attr">     allow_username_or_email_login:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">     lowercase_usernames:</span> <span class="literal">false</span></span><br><span class="line">     <span class="comment">#不允许用户注册</span></span><br><span class="line"><span class="attr">     block_auto_created_users:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">     base:</span> <span class="string">'ou=研发部,cn=admin,dc=gzlplink,dc=com'</span></span><br><span class="line"><span class="attr">     user_filter:</span> <span class="string">''</span></span><br><span class="line"><span class="attr">     attributes:</span></span><br><span class="line"><span class="attr">       username:</span> <span class="string">['cn']</span></span><br><span class="line"><span class="attr">       email:</span>    <span class="string">['mail']</span></span><br><span class="line"><span class="attr">       name:</span>     <span class="string">'description'</span></span><br><span class="line"><span class="attr">       first_name:</span> <span class="string">'givenName'</span></span><br><span class="line"><span class="attr">       last_name:</span>  <span class="string">'sn'</span></span><br><span class="line"><span class="string">EOS</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>host</code> 和 <code>port</code> 是 LDAP 服务的主机地址及端口</li>
<li><code>bind_dn</code> 和 <code>password</code> 是一个管理 LDAP 的 dn 及密码</li>
<li><code>base</code> 表示 LDAP 将以该 dn 为 节点，向下查找用户</li>
<li><code>user_filter</code> 表示以某种过滤条件筛选用户，比如假设我们只希望所属组为 Developers 的用户来访问 GitLab，则可以在这里设置 <code>(memberOf=cn=Developers,cn=Groups,dc=xinhua,dc=org)</code></li>
<li><code>attributes</code> 表示 GitLab 中的字段与 LDAP 中哪些字段可以相互对应，比如可以用 LDAP 中的 <code>uid</code> 来作为 GitLab 用户名</li>
</ul>
<p>配置修改完成之后，运行下面命令重启 GitLab 服务：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">gitlab-ctl reconfigure</span></span><br></pre></td></tr></table></figure>

<img src="\image\20180726164123668.png">

<p><strong>开启 HTTPS</strong></p>
<p>GitLab 默认没有开启 HTTPS，如果需要开启的话，需要按照下面的步骤执行：</p>
<p>首先，在配置文件 <code>/etc/gitlab/gitlab.rb</code> 中将下面一行中的协议由 HTTP 改成 HTTPS，并设置从 HTTP 到 HTTPS 的重定向：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">external_url</span> <span class="string">"https://gitlab.example.com"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Redirect HTTP requests to HTTPS</span></span><br><span class="line">nginx[<span class="string">'redirect_http_to_https'</span>] = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>然后创建一个 SSL 目录，并将网站证书导入进去：</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># mkdir -p /etc/gitlab/ssl</span></span><br><span class="line"><span class="meta"># chmod 700 /etc/gitlab/ssl</span></span><br><span class="line"><span class="meta"># cp gitlab.xinhua.io.key gitlab.xinhua.io.crt /etc/gitlab/ssl/</span></span><br></pre></td></tr></table></figure>

<p>注意上面的证书必须以配置中的域名（如本文中的 <code>gitlab.xinhua.io</code>）为其文件名。</p>
<p>最后再执行 <code>gitlab-ctl reconfigure</code> 命令，即可通过 HTTPS 方式访问 GitLab 了</p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>nmk</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://nmk0718.github.io/2021/03/27/gitlab/">http://nmk0718.github.io/2021/03/27/gitlab/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2020 <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tag/GitLab/"># GitLab</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2021/03/27/skywalking/">Skywalking</a>
            
            
            <a class="next" rel="next" href="/2021/03/27/数据库备份与恢复/">数据库备份与恢复</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© nmk | Powered by <a href="https://hexo.io" target="_blank">Hexo</a></span>
	</div>
</footer>

    </div>
</body>
</html>
