<!DOCTYPE html>
<html lang>
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="kk">





<title>GitLab</title>



    <link rel="icon" href="/favicon.png">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    

</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">kk&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">kk&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">GitLab</h1>
            
                <div class="post-meta">
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2021-03-27&nbsp;&nbsp;15:23</a>
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h3 id="GitLab-CI-CD"><a href="#GitLab-CI-CD" class="headerlink" title="GitLab CI/CD"></a>GitLab CI/CD</h3><h4 id="使用docker下载gitlab镜像"><a href="#使用docker下载gitlab镜像" class="headerlink" title="使用docker下载gitlab镜像"></a>使用docker下载gitlab镜像</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker pull gitlab/gitlab-ce</span><br></pre></td></tr></table></figure>

<h4 id="检查镜像下载是否成功"><a href="#检查镜像下载是否成功" class="headerlink" title="检查镜像下载是否成功"></a>检查镜像下载是否成功</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@public ~]# docker images</span><br><span class="line">REPOSITORY                                TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">gitlab/gitlab-ce                          latest              85ef0c92d667        3 days ago          1.98GB</span><br></pre></td></tr></table></figure>

<h4 id="创建数据存储目录"><a href="#创建数据存储目录" class="headerlink" title="创建数据存储目录"></a>创建数据存储目录</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@public ~]# mkdir -p /opt/gitlab/data</span><br><span class="line">[root@public ~]# mkdir /opt/gitlab/logs</span><br><span class="line">[root@public ~]# mkdir /opt/gitlab/config</span><br></pre></td></tr></table></figure>

<h4 id="启动gitlab"><a href="#启动gitlab" class="headerlink" title="启动gitlab"></a>启动gitlab</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@public gitlab]# docker run --detach \</span><br><span class="line">       --hostname 192.168.229.8 \</span><br><span class="line">       --publish 8443:443 --publish 9080:80 --publish 2222:22 \</span><br><span class="line">       --name gitlab \</span><br><span class="line">       --restart always \</span><br><span class="line">       --privileged=true \</span><br><span class="line">       --volume /file/gitlab/config:/etc/gitlab \</span><br><span class="line">	   --volume /file/gitlab/logs:/var/log/gitlab \</span><br><span class="line">       --volume /file/gitlab/data:/var/opt/gitlab \</span><br><span class="line">   	   docker.io/gitlab/gitlab-ce:latest</span><br></pre></td></tr></table></figure>

<p><strong>gitlab如使用单台服务器可使用默认配置,若跟别的服务放一起会出现gitlab占用内存过多问题</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi /file/gitlab/config/gitlab.rb</span><br><span class="line"></span><br><span class="line">#去掉下面的注释</span><br><span class="line"></span><br><span class="line">unicorn[&apos;worker_processes&apos;] = 2</span><br><span class="line"></span><br><span class="line">#之后执行</span><br><span class="line"></span><br><span class="line">docker exec -it gitlab gitlab-ctl reconfigure</span><br><span class="line"></span><br><span class="line">docker exec -it gitlab gitlab-ctl restart</span><br></pre></td></tr></table></figure>

<p>gitlab初始用户名密码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@deployment /]# cat /opt/gitlab/config/initial_root_password </span><br><span class="line"># WARNING: This value is valid only in the following conditions</span><br><span class="line">#          1. If provided manually (either via `GITLAB_ROOT_PASSWORD` environment variable or via `gitlab_rails[&apos;initial_root_password&apos;]` setting in `gitlab.rb`, it was provided before database was seeded for the first time (usually, the first reconfigure run).</span><br><span class="line">#          2. Password hasn&apos;t been changed manually, either via UI or via command line.</span><br><span class="line">#</span><br><span class="line">#          If the password shown here doesn&apos;t work, you must reset the admin password following https://docs.gitlab.com/ee/security/reset_user_password.html#reset-your-root-password.</span><br><span class="line"></span><br><span class="line">Password: GHztfkIk0eg4qdTTNn5owN+7jK3ojlUHLrXMibB5Pj8=</span><br><span class="line"></span><br><span class="line"># NOTE: This file will be automatically deleted in the first reconfigure run after 24 hours.</span><br></pre></td></tr></table></figure>

<h4 id="安装GitLab-Runner"><a href="#安装GitLab-Runner" class="headerlink" title="安装GitLab Runner"></a>安装GitLab Runner</h4><p>下载并安装二进制文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># Download the binary for your system</span><br><span class="line">curl -L --output /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64</span><br><span class="line"></span><br><span class="line"># Give it permissions to execute</span><br><span class="line">chmod +x /usr/local/bin/gitlab-runner</span><br><span class="line"></span><br><span class="line"># Create a GitLab CI user</span><br><span class="line">useradd --comment &apos;GitLab Runner&apos; --create-home gitlab-runner --shell /bin/bash</span><br><span class="line"></span><br><span class="line"># Install and run as service</span><br><span class="line">gitlab-runner install --user=gitlab-runner --working-directory=/home/gitlab-runner</span><br><span class="line">gitlab-runner start</span><br></pre></td></tr></table></figure>

<h4 id="注册runner的命令"><a href="#注册runner的命令" class="headerlink" title="注册runner的命令"></a>注册runner的命令</h4><p>注册的地址要填写为ip+port.不要使用web页面展示的<a href="http://ip//" target="_blank" rel="noopener">http://ip//</a> 否则注册失败</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@deployment /]# gitlab-runner register</span><br><span class="line">Runtime platform                                    arch=amd64 os=linux pid=86642 revision=58ba2b95 version=14.2.0</span><br><span class="line">Running in system-mode.                            </span><br><span class="line">                                                   </span><br><span class="line">Enter the GitLab instance URL (for example, https://gitlab.com/):</span><br><span class="line">http://192.168.50.52:9090/</span><br><span class="line">Enter the registration token:</span><br><span class="line">cZ8xxddc9zciAHAsJpqB</span><br><span class="line">Enter a description for the runner:</span><br><span class="line">[deployment]: test</span><br><span class="line">Enter tags for the runner (comma-separated):</span><br><span class="line">test</span><br><span class="line">Registering runner... succeeded                     runner=cZ8xxddc</span><br><span class="line">Enter an executor: docker, docker-ssh, parallels, shell, virtualbox, kubernetes, custom, ssh, docker+machine, docker-ssh+machine:</span><br><span class="line">shell</span><br><span class="line">Runner registered successfully. Feel free to start it, but if it&apos;s running already the config should be automatically reloaded!</span><br></pre></td></tr></table></figure>

<p>Runner连接</p>
<p>不要把Runner和gitlab部署在一台机器 不然会一直显示未连接</p>
<img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/image-20210830152258004.png">

<p>Runner的构建目录</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/home/gitlab-runner/builds/ymVX6kY7/0/</span><br></pre></td></tr></table></figure>

<p>Runner的注册后的配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/etc/gitlab-runner/config.toml</span><br></pre></td></tr></table></figure>

<p>GitLab-CI.yml</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">variables:</span><br><span class="line">  GIT_STRATEGY: clone</span><br><span class="line"></span><br><span class="line">before_script:</span><br><span class="line">  - pwd</span><br><span class="line">  </span><br><span class="line">stages:</span><br><span class="line">  - build</span><br><span class="line">  - deploy</span><br><span class="line">  </span><br><span class="line">build-job:</span><br><span class="line">  stage: build</span><br><span class="line">  tags:</span><br><span class="line">    - nimingkun</span><br><span class="line">  only:</span><br><span class="line">    - release</span><br><span class="line">  script:</span><br><span class="line">    - mvn clean install -Dmaven.test.skip=true</span><br><span class="line">    - cp ymall/target/ymall-0.0.1-SNAPSHOT.jar  dockerfile/</span><br><span class="line">    - cd dockerfile &amp;&amp; sh build.sh ymall</span><br><span class="line">  artifacts:</span><br><span class="line">    paths:</span><br><span class="line">      - ymall/target/ymall-0.0.1-SNAPSHOT.jar</span><br><span class="line"></span><br><span class="line">deploy-job:</span><br><span class="line">  stage: deploy</span><br><span class="line">  tags:</span><br><span class="line">    - nimingkun</span><br><span class="line">  only:</span><br><span class="line">    - release</span><br><span class="line">  script:</span><br><span class="line">    - sh CD.sh</span><br></pre></td></tr></table></figure>

<p>会出现报错,因为git版本告知的错误</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">fatal: git fetch-pack: expected shallow list</span><br><span class="line">fatal: The remote end hung up unexpectedly</span><br></pre></td></tr></table></figure>

<p>解决方法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install  http://opensource.wandisco.com/centos/7/git/x86_64/wandisco-git-release-7-2.noarch.rpm</span><br><span class="line">yum update git</span><br></pre></td></tr></table></figure>

<p>CI中出现打包镜像错误</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Post http://%2Fvar%2Frun%2Fdocker.sock/v1.24/build?buildargs=%7B%7D&amp;cachefrom=%5B%5D&amp;cgroupparent=&amp;cpuperiod=0&amp;cpuquota=0&amp;cpusetcpus=&amp;cpusetmems=&amp;cpushares=0&amp;dockerfile=Dockerfile&amp;labels=%7B%7D&amp;memory=0&amp;memswap=0&amp;networkmode=default&amp;rm=1&amp;shmsize=0&amp;t=192.168.50.52%3A8551%2Fymall%3Alatest&amp;target=&amp;ulimits=null&amp;version=1: dial unix /var/run/docker.sock: connect: permission denied</span><br></pre></td></tr></table></figure>

<p>原因:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">使用root账户直接yum安装docker，然后service docker start启动docker服务。Gitlab-CI默认以gitlab-runner用户执行，因此对/var/run/docker.sock无访问权限，无法与docker daemon通信</span><br></pre></td></tr></table></figure>

<p>解决方法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">groupadd -r docker</span><br><span class="line">useradd -g docker -r docker -p &apos;password&apos;</span><br><span class="line"></span><br><span class="line">usermod -aG docker gitlab-runner</span><br><span class="line"></span><br><span class="line">service docker stop</span><br><span class="line">su docker </span><br><span class="line">sudo service docker start</span><br></pre></td></tr></table></figure>

<p>我这里仅为测试GitLab-CI,故直接添加docker到gitlab-runner组</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">usermod -aG  docker gitlab-runner</span><br></pre></td></tr></table></figure>

<p>拉取Git仓库时报错</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Initialized empty Git repository in /private/var/folders/g5/8twmk1xj481_6btvppyw5j4h0000gp/T/.tmpNYVg6H/.git/</span><br><span class="line">hint: Using &apos;master&apos; as the name for the initial branch. This default branch name</span><br><span class="line">hint: is subject to change. To configure the initial branch name to use in all</span><br><span class="line">hint: of your new repositories, which will suppress this warning, call:</span><br><span class="line">hint: </span><br><span class="line">hint:   git config --global init.defaultBranch &lt;name&gt;</span><br><span class="line">hint: </span><br><span class="line">hint: Names commonly chosen instead of &apos;master&apos; are &apos;main&apos;, &apos;trunk&apos; and</span><br><span class="line">hint: &apos;development&apos;. The just-created branch can be renamed via this command:</span><br><span class="line">hint: </span><br><span class="line">hint:   git branch -m &lt;name&gt;</span><br></pre></td></tr></table></figure>

<p>解决方法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git config --global init.defaultBranch master</span><br></pre></td></tr></table></figure>

<h4 id="GitLab-CI-文件详解"><a href="#GitLab-CI-文件详解" class="headerlink" title="GitLab-CI 文件详解"></a>GitLab-CI 文件详解</h4><table>
<thead>
<tr>
<th>关键字</th>
<th>是否必须</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>variables</td>
<td>非必须</td>
<td>在job级别上定义的变量</td>
</tr>
<tr>
<td>before_script</td>
<td>非必须</td>
<td>提前执行的脚本</td>
</tr>
<tr>
<td>stages</td>
<td>必须</td>
<td>指定一组job在不同场景阶段执行。在相同<strong>stage</strong>下的job(任务)将会被<strong>并行的</strong>执行</td>
</tr>
<tr>
<td>job-name</td>
<td>必须</td>
<td>流水线的任务的名称</td>
</tr>
<tr>
<td>stage</td>
<td>必须</td>
<td>与stages内的场景阶段对应</td>
</tr>
<tr>
<td>tags</td>
<td>非必须</td>
<td>定义了哪些runner适用该job</td>
</tr>
<tr>
<td>only</td>
<td>非必须</td>
<td>定义哪些git引用（分支）适用该job</td>
</tr>
<tr>
<td>except</td>
<td>非必须</td>
<td>定义了哪些git引用(分支)不适用该job</td>
</tr>
<tr>
<td>script</td>
<td>必须</td>
<td>定义Runner需要执行的脚本或命令</td>
</tr>
<tr>
<td>artifacts</td>
<td>非必须</td>
<td>产物,通过paths指定文件后,可在gitlab页面下载改产物</td>
</tr>
<tr>
<td>after_script</td>
<td>非必须</td>
<td>后执行的脚本</td>
</tr>
<tr>
<td>environment</td>
<td>非必须</td>
<td>定义让job完成部署的环境名称</td>
</tr>
</tbody></table>
<p><strong>only</strong>和<strong>except</strong>两个参数说明了job什么时候将会被创建:</p>
<ol>
<li><strong>only</strong>定义了job需要执行的所在分支或者标签</li>
<li><strong>except</strong>定义了job不会执行的所在分支或者标签</li>
</ol>
<p>以下是这两个参数的几条用法规则：</p>
<ol>
<li><strong>only</strong>和<strong>except</strong>如果都存在在一个job声明中，则所需引用将会被<strong>only</strong>和<strong>except</strong>所定义的分支过滤.</li>
<li><strong>only</strong>和<strong>except</strong>允许使用正则</li>
<li><strong>only</strong>和<strong>except</strong>允许使用指定仓库地址，但是不forks仓库</li>
</ol>
<p>此外，<strong>only</strong>和<strong>except</strong>允许使用以下一些特殊关键字：</p>
<table>
<thead>
<tr>
<th align="center">值</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">branches</td>
<td align="center">当一个分支被push上来</td>
</tr>
<tr>
<td align="center">tags</td>
<td align="center">当一个打了tag的分支被push上来</td>
</tr>
<tr>
<td align="center">api</td>
<td align="center">当一个pipline被piplines api所触发调起，详见<a href="https://link.segmentfault.com/?url=https%3A%2F%2Fdocs.gitlab.com%2Fce%2Fapi%2Fpipelines.html" target="_blank" rel="noopener">piplines api</a></td>
</tr>
<tr>
<td align="center">external</td>
<td align="center">当使用了GitLab以外的CI服务</td>
</tr>
<tr>
<td align="center">pipelines</td>
<td align="center">针对多项目触发器而言，当使用CI_JOB_TOKEN并使用gitlab所提供的api创建多个pipelines的时候</td>
</tr>
<tr>
<td align="center">pushes</td>
<td align="center">当pipeline被用户的git push操作所触发的时候</td>
</tr>
<tr>
<td align="center">schedules</td>
<td align="center">针对预定好的pipline而言（每日构建一类~，具体请看<a href="https://link.segmentfault.com/?url=https%3A%2F%2Fdocs.gitlab.com%2Fce%2Fuser%2Fproject%2Fpipelines%2Fschedules.html" target="_blank" rel="noopener">链接</a>）</td>
</tr>
<tr>
<td align="center">triggers</td>
<td align="center">用token创建piplines的时候</td>
</tr>
<tr>
<td align="center">web</td>
<td align="center">在GitLab页面上Pipelines标签页下，你按了<strong>run pipline</strong>的时候</td>
</tr>
</tbody></table>
<p>下面的例子，<strong>job</strong>将会只在<strong>issue-</strong>开头的refs下执行，反之则其他所有分支被跳过：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">job:</span><br><span class="line">  <span class="comment"># use regexp</span></span><br><span class="line">  only:</span><br><span class="line">    - /^issue-.*$/</span><br><span class="line">  <span class="comment"># use special keyword</span></span><br><span class="line">  except:</span><br><span class="line">    - branches</span><br></pre></td></tr></table></figure>

<p>在这个例子中，<strong>job</strong>只会在打了tag的分支，或者被api所触发，或者每日构建任务上运行，</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">job:</span><br><span class="line">  <span class="comment"># use special keywords</span></span><br><span class="line">  only:</span><br><span class="line">    - tags</span><br><span class="line">    - triggers</span><br><span class="line">    - schedules</span><br></pre></td></tr></table></figure>

<p>Git Strategy（git策略）</p>
<p>你可以通过在全局变量设置位置或者job局部变量设置位置来设置<strong>GIT_STRATEGY</strong>用以获取应用最近更新的代码。如果没有指定，默认的项目设置将会被使用。</p>
<p>该选项有三个可能的值：clone,fetch和none</p>
<p>clone是最慢的选项，如果设置该值，每个job将会都克隆一遍仓库，确保项目工作空间总是原始的正确的。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">variables:</span><br><span class="line">  GIT_STRATEGY: <span class="built_in">clone</span></span><br></pre></td></tr></table></figure>

<p>fetch是更快的操作选项，因为他重用了项目的工作空间（如果没有的话，会去clone）, git clean用于撤销上一个job的任何操作，git fetch是用来重新获取上一个job运行到当前job产生的commit</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">variables:</span><br><span class="line">  GIT_STRATEGY: fetch</span><br></pre></td></tr></table></figure>

<p>none也同样重用了项目空间（但是他会跳过所有git操作，包括如果存在的gitlab runner的预克隆脚本）。其主要用于只是为了操作artifacts的job上（例如depoly部署行为）。此时Git仓库的数据可能是存在的，但它一定不是最新的。所以在设置了none的job里你应该依赖从cache或者artifacts来的数据，而不是仓库数据。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">variables:</span><br><span class="line">  GIT_STRATEGY: none</span><br></pre></td></tr></table></figure>

<p>Shallow cloning (浅克隆)</p>
<p>抓取或者克隆最新三条commits:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">variables:</span><br><span class="line">  GIT_DEPTH: <span class="string">"3"</span></span><br></pre></td></tr></table></figure>

<p>查看流水线阶段完成情况</p>
<img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/image-20210830152017883.png">

<p>查看每个阶段的运行日志</p>
<img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/image-20210830152103621.png">

<p>下载yml中定义的产物</p>
<img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image/image-20210830152157654.png">

<p>后续可深入了解 gitlab集成Kubernetes,Prometheus和Grafana.可在gitlab查看部署情况,查看Kubernetes日志,审核是否发布等操作</p>
<h4 id="备份gitlab"><a href="#备份gitlab" class="headerlink" title="备份gitlab"></a>备份gitlab</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@iZ2zeaxvb40ng4w24tpogoZ file]# crontab -l</span><br><span class="line">0 0 */3 * * sh /file/backup.sh</span><br><span class="line"></span><br><span class="line">[root@iZ2zeaxvb40ng4w24tpogoZ file]# cat /file/gitlab/push_aliyun.sh   </span><br><span class="line">docker commit -m &quot;gitlab&quot; 5f36554b62b3 registry-vpc.cn-beijing.aliyuncs.com/lepeng/gitlab:`date +%F`</span><br><span class="line">docker push registry-vpc.cn-beijing.aliyuncs.com/lepeng/gitlab:`date +%F`</span><br><span class="line"></span><br><span class="line">[root@iZ2zeaxvb40ng4w24tpogoZ file]# cat /file/backup.sh</span><br><span class="line">cd /file/</span><br><span class="line">tar zcvf gitlabconfig`date +%F`.tar config</span><br><span class="line">tar zcvf gitlabdata`date +%F`.tar data</span><br><span class="line">mv *.tar /data1/gitlab/backup/</span><br></pre></td></tr></table></figure>

<h4 id="gitlab配置ldap"><a href="#gitlab配置ldap" class="headerlink" title="gitlab配置ldap"></a>gitlab配置ldap</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim /file/config/gitlab.rb</span><br><span class="line">gitlab_rails[&apos;ldap_enabled&apos;] = true</span><br><span class="line">gitlab_rails[&apos;ldap_servers&apos;] = YAML.load &lt;&lt;-&apos;EOS&apos;</span><br><span class="line">   main: # &apos;main&apos; is the GitLab &apos;provider ID&apos; of this LDAP server</span><br><span class="line">     label: &apos;LDAP&apos;</span><br><span class="line">     host: &apos;39.107.142.154&apos;</span><br><span class="line">     port: 389</span><br><span class="line">     uid: &apos;cn&apos;</span><br><span class="line">     bind_dn: &apos;cn=admin,dc=gzlplink,dc=com&apos;</span><br><span class="line">     password: &apos;Lpldap123456&apos;</span><br><span class="line">     encryption: &apos;plain&apos; # &quot;start_tls&quot; or &quot;simple_tls&quot; or &quot;plain&quot;</span><br><span class="line">     verify_certificates: true</span><br><span class="line">     active_directory: true</span><br><span class="line">     #邮箱 用户名均可登录</span><br><span class="line">     allow_username_or_email_login: true</span><br><span class="line">     lowercase_usernames: false</span><br><span class="line">     #不允许用户注册</span><br><span class="line">     block_auto_created_users: false</span><br><span class="line">     base: &apos;ou=研发部,cn=admin,dc=gzlplink,dc=com&apos;</span><br><span class="line">     user_filter: &apos;&apos;</span><br><span class="line">     attributes:</span><br><span class="line">       username: [&apos;cn&apos;]</span><br><span class="line">       email:    [&apos;mail&apos;]</span><br><span class="line">       name:     &apos;description&apos;</span><br><span class="line">       first_name: &apos;givenName&apos;</span><br><span class="line">       last_name:  &apos;sn&apos;</span><br><span class="line">EOS</span><br></pre></td></tr></table></figure>

<ul>
<li><code>host</code> 和 <code>port</code> 是 LDAP 服务的主机地址及端口</li>
<li><code>bind_dn</code> 和 <code>password</code> 是一个管理 LDAP 的 dn 及密码</li>
<li><code>base</code> 表示 LDAP 将以该 dn 为 节点，向下查找用户</li>
<li><code>user_filter</code> 表示以某种过滤条件筛选用户，比如假设我们只希望所属组为 Developers 的用户来访问 GitLab，则可以在这里设置 <code>(memberOf=cn=Developers,cn=Groups,dc=xinhua,dc=org)</code></li>
<li><code>attributes</code> 表示 GitLab 中的字段与 LDAP 中哪些字段可以相互对应，比如可以用 LDAP 中的 <code>uid</code> 来作为 GitLab 用户名</li>
</ul>
<p>配置修改完成之后，运行下面命令重启 GitLab 服务：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure>

<img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image\20180726164123668.png">

<p><strong>开启 HTTPS</strong></p>
<p>GitLab 默认没有开启 HTTPS，如果需要开启的话，需要按照下面的步骤执行：</p>
<p>首先，在配置文件 <code>/etc/gitlab/gitlab.rb</code> 中将下面一行中的协议由 HTTP 改成 HTTPS，并设置从 HTTP 到 HTTPS 的重定向：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">external_url &quot;https://gitlab.example.com&quot;</span><br><span class="line"></span><br><span class="line"># Redirect HTTP requests to HTTPS</span><br><span class="line">nginx[&apos;redirect_http_to_https&apos;] = true</span><br></pre></td></tr></table></figure>

<p>然后创建一个 SSL 目录，并将网站证书导入进去：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># mkdir -p /etc/gitlab/ssl</span><br><span class="line"># chmod 700 /etc/gitlab/ssl</span><br><span class="line"># cp gitlab.xinhua.io.key gitlab.xinhua.io.crt /etc/gitlab/ssl/</span><br></pre></td></tr></table></figure>

<p>注意上面的证书必须以配置中的域名（如本文中的 <code>gitlab.xinhua.io</code>）为其文件名。</p>
<p>最后再执行 <code>gitlab-ctl reconfigure</code> 命令，即可通过 HTTPS 方式访问 GitLab 了</p>

        </div>

        
            <section class="post-copyright">
                
                
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tag/GitLab/"># GitLab</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">Back</a>
                <span>· </span>
                <a href="/">Home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2021/03/27/skywalking/">Skywalking</a>
            
            
            <a class="next" rel="next" href="/2021/03/27/数据库备份与恢复/">数据库备份与恢复</a>
            
        </section>

        <script src="https://giscus.app/client.js" data-repo="nmk0718/nmk0718.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkyMTE0NDU3NDY=" data-category="Announcements" data-category-id="DIC_kwDODJpn8s4Clzt8" data-mapping="title" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="noborder_light" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async>
</script>
<script src="/js/clipboard.min.js"></script>
<script>
    // 更新 giscus 主题
    function updateGiscusTheme() {
        // 添加短暂延时，确保在主题切换后执行
        setTimeout(() => {
            const isDark = document.body.classList.contains('dark-theme');
            const theme = isDark ? 'noborder_dark' : 'noborder_light';
            const iframe = document.querySelector('.giscus-frame');
            
            if (iframe) {
                iframe.contentWindow.postMessage(
                    { giscus: { setConfig: { theme: theme } } },
                    'https://giscus.app'
                );
            }
        }, 100);  // 100ms 延时
    }

    // 监听主题变化
    const toggleBtn = document.getElementsByClassName('toggleBtn')[0];
    if (toggleBtn) {
        toggleBtn.addEventListener('click', updateGiscusTheme);
    }

    // 移动端主题切换监听
    const mobileToggle = document.getElementById('mobile-toggle-theme');
    if (mobileToggle) {
        mobileToggle.addEventListener('click', updateGiscusTheme);
    }

    // 初始化主题
    document.addEventListener('DOMContentLoaded', updateGiscusTheme);

    document.addEventListener('DOMContentLoaded', function () {
        var codeBlocks = document.querySelectorAll('article .code pre');

        codeBlocks.forEach(function (codeBlock) {
            var copyButton = document.createElement('button');
            copyButton.className = 'copy-button';

            // Check if the code block is in the article content
            if (codeBlock.closest('article')) {
                codeBlock.parentNode.parentNode.style.position = 'relative'; // Update this line to select parent of span (pre)
                codeBlock.parentNode.parentNode.appendChild(copyButton); // Update this line to select parent of span (pre) 

                var isCopying = false;

                copyButton.addEventListener('click', function () {
                    if (!isCopying) {
                        var codeText = codeBlock.innerText;
                        navigator.clipboard.writeText(codeText).then(function () {
                            isCopying = true;
                            setTimeout(function () {
                                isCopying = false;
                            }, 1500);
                        }).catch(function (err) {
                            console.error('Copy failed', err);
                        });
                    }
                });
            }
        });
    });
</script>
    </article>
</div>


        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© kk | Powered by <a href="https://hexo.io" target="_blank">Hexo</a></span>
    </div>
</footer>

    </div>

        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z\d\-\.\+]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(t.test(e.href)||r.test(e.href))&&(e.href=a.dataset.original)})});</script><script>(r=>{r.imageLazyLoadSetting.processImages=t;var a=r.imageLazyLoadSetting.isSPA,o=r.imageLazyLoadSetting.preloadRatio||1,d=i();function i(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(t){(a||t)&&(d=i());for(var e,n=0;n<d.length;n++)0<=(e=(e=d[n]).getBoundingClientRect()).bottom&&0<=e.left&&e.top<=(r.innerHeight*o||document.documentElement.clientHeight*o)&&(()=>{var t,e,a,o,i=d[n];e=function(){d=d.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).dataset.loaded||(t.hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(a=new Image,o=t.getAttribute("data-original"),a.onload=function(){t.src=o,t.removeAttribute("data-original"),t.setAttribute("data-loaded",!0),e&&e()},a.onerror=function(){t.removeAttribute("data-original"),t.setAttribute("data-loaded",!1),t.src=o},t.src!==o&&(a.src=o)))})()}function e(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",e),r.addEventListener("resize",e),r.addEventListener("orientationchange",e)})(this);</script></body>
</html>
