<!DOCTYPE html>
<html lang>
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="kk">





<title>数据库备份与恢复</title>



    <link rel="icon" href="/favicon.png">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    

</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">kk&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">kk&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">数据库备份与恢复</h1>
            
                <div class="post-meta">
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2021-03-27&nbsp;&nbsp;15:20</a>
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h4 id="备份Mysql"><a href="#备份Mysql" class="headerlink" title="备份Mysql"></a>备份Mysql</h4><p>创建备份文件夹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir -p /data/mysqlbackup/</span><br></pre></td></tr></table></figure>

<p>创建备份的脚本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@prod-ghospital mysqlbackup]# cat backup.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line">mysqldump -upraise -pAf9Ed1Bb827b.4@9eB=&#123;9c4f --all-databases &gt;/data/mysqlbackup/praise-`date &quot;+%y-%m-%d&quot;`.sql</span><br><span class="line">mysqldump -umessage -p4666dd3a@79.d24=9cD&#123;b382 --all-databases &gt;/data/mysqlbackup/message-`date &quot;+%y-%m-%d&quot;`.sql</span><br><span class="line">mysqldump -uvideo -pDd0&#123;A9e2026c=94d13b@.62f --all-databases &gt;/data/mysqlbackup/video-`date &quot;+%y-%m-%d&quot;`.sql</span><br><span class="line">mysqldump --single-transaction -unethospital -p97@9EbeA7.=1Fb04&#123;e87998d --all-databases &gt;/data/mysqlbackup/nethospital-`date &quot;+%y-%m-%d&quot;`.sql</span><br><span class="line">mysqldump -uhospunion -p76984a&#125;74aE964e69b4Ce31,.ff&#123;2f02 --all-databases &gt;/data/mysqlbackup/hospunion-`date &quot;+%y-%m-%d&quot;`.sql</span><br><span class="line">find /data/mysqlbackup -type f -name &quot;*.sql&quot; -mtime +7 -exec rm -rf &#123;&#125; \;</span><br></pre></td></tr></table></figure>

<p>加入定时任务</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@prod-ghospital mysqlbackup]# crontab -l</span><br><span class="line">*/10 1 * * * /bin/sh /data/mysqlbackup/backup.sh</span><br></pre></td></tr></table></figure>

<p>备份公众号数据库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysqldump -ucdh -pCDH360lj#com2019 -h139.159.192.185 --all-databases &gt;/home/mysql.sql</span><br></pre></td></tr></table></figure>

<h4 id="备份Postgresql"><a href="#备份Postgresql" class="headerlink" title="备份Postgresql"></a>备份Postgresql</h4><p>更改为postgres用户</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">su postgres</span><br></pre></td></tr></table></figure>

<p>创建备份文件夹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bash-4.2$ cd /var/lib/pgsql/</span><br><span class="line">bash-4.2$ mkdir -p postgres/backups</span><br></pre></td></tr></table></figure>

<p>创建备份脚本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bash-4.2$ cat backup.sh </span><br><span class="line">pg_dumpall &gt; ~/postgres/backups/pgbackup-`date &quot;+%Y-%m-%d&quot;`.bak</span><br><span class="line">find ~/postgres/backups/ -type f -name &quot;*.bak&quot; -mtime +7 -exec rm -rf &#123;&#125; \;</span><br></pre></td></tr></table></figure>

<p>加入定时任务</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bash-4.2$ crontab -l</span><br><span class="line">*/10 1 * * * /bin/sh ~/postgres/backups/backup.sh</span><br></pre></td></tr></table></figure>

<h4 id="备份sqlserver"><a href="#备份sqlserver" class="headerlink" title="备份sqlserver"></a>备份sqlserver</h4><p><strong>linux备份</strong></p>
<p>安装sqlcmd</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl https://packages.microsoft.com/config/rhel/8/prod.repo &gt; /etc/yum.repos.d/msprod.repo</span><br><span class="line">sudo yum install mssql-tools unixODBC-devel</span><br><span class="line">echo &apos;export PATH=&quot;$PATH:/opt/mssql-tools/bin&quot;&apos; &gt;&gt; ~/.bash_profile</span><br><span class="line">echo &apos;export PATH=&quot;$PATH:/opt/mssql-tools/bin&quot;&apos; &gt;&gt; ~/.bashrc</span><br><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure>

<p>备份</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#创建数据库备份文件夹 </span><br><span class="line">mkdir -p /data/sqlserverbackup</span><br><span class="line">#给mussql授予/data/sqlserverbackup文件夹的权限 </span><br><span class="line">chown -R mssql:mssql /data/sqlserverbackup </span><br><span class="line">#登录数据库 </span><br><span class="line">sqlcmd -S 127.0.0.1 -U sa</span><br><span class="line">#备份数据库到指定路径</span><br><span class="line">1&gt; backup database appauth to disk=&apos;/data/sqlserverbackup/appauth.bak&apos; </span><br><span class="line">2&gt; go</span><br></pre></td></tr></table></figure>

<p><strong>windows备份</strong></p>
<p>windows任务计划定时备份sqlserver数据库</p>
<p>在E盘下新建文件夹DBbackup，在DBbackup下创建一个sql的备份脚本，文件命名为dbback.sql</p>
<p>sql脚本如下:(DBname就是你所需要备份的数据库名)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GO</span><br><span class="line"></span><br><span class="line">DECLARE</span><br><span class="line"></span><br><span class="line">@backuptime varchar(20)</span><br><span class="line"></span><br><span class="line">DECLARE</span><br><span class="line"></span><br><span class="line">@filename varchar(100)</span><br><span class="line"></span><br><span class="line">select @backuptime=(convert(varchar(8),getdate(),112)+replace(convert(varchar(5),getdate(),114),&apos;:&apos;,&apos; &apos;))</span><br><span class="line"></span><br><span class="line">select @filename=&apos;E:\DBbackup\db_&apos;+@backuptime+&apos;.bak&apos;</span><br><span class="line"></span><br><span class="line">backup database DBname to disk=@filename</span><br></pre></td></tr></table></figure>

<p>写一个批处理文件执行sql语句：</p>
<p>例如：backup_database.bat</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.bat文件内容为：sqlcmd -S . -i E:\DBbackup\dbback.sql</span><br></pre></td></tr></table></figure>

<p>.bat文件内的语句可以在cmd控制台执行测试是否正确；</p>
<p>可以使用winrar加入环境变量进行压缩</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">set date_str=%date:~,4%%date:~5,2%%date:~8,2%</span><br><span class="line">set time_hh=%time:~0,2%</span><br><span class="line">if /i %time_hh% LSS 10 (set time_hh=0%time:~1,1%)</span><br><span class="line">set data_time_str=%date:~,4%%date:~5,2%%date:~8,2%_%time_hh%%time:~3,2%%time:~6,2%</span><br><span class="line">rar a db_%data_time_str%.rar -m5 -s -r *.bak</span><br></pre></td></tr></table></figure>

<p>在windows-控制面板-管理工具下，打开任务计划，创建基本任务，输入任务名称描述、设置备份时间、选择启动程序。需要注意的是在起始于选项里输入程序执行路径，完成。</p>
<img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image\bat.png" alt="bat" style="zoom: 50%;">

<p>删除大于7天的备份</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">delete.bat</span><br><span class="line"></span><br><span class="line">@echo off&amp;setlocal enabledelayedexpansion</span><br><span class="line">pushd E:\DBbackup</span><br><span class="line">set n=0</span><br><span class="line">for /f &quot;delims=&quot; %%a in (&apos;dir /a-d-h /b /o-d shop_lepeng*.rar&apos;) do (</span><br><span class="line">if !n! geq 7  del &quot;%%~a&quot;</span><br><span class="line">set /a n+=1 </span><br><span class="line">)</span><br><span class="line">popd</span><br></pre></td></tr></table></figure>

<h4 id="备份mongodb"><a href="#备份mongodb" class="headerlink" title="备份mongodb"></a>备份mongodb</h4><p>备份命令格式</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mongodump -h IP --port 端口 -u 用户名 -p 密码 -d 数据库 -o 文件</span><br></pre></td></tr></table></figure>

<p>无密码备份</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@database data]# mongodump -h 192.168.50.51 -d B2BMall -o /data/mongodbbackup/mongodbbackup-`date &quot;+%Y-%m-%d&quot;`</span><br><span class="line">2020-12-23T15:01:09.747+0800    writing B2BMall.VLoginToken to </span><br><span class="line">2020-12-23T15:01:09.747+0800    writing B2BMall.SmallProgramUserAccount to </span><br><span class="line">2020-12-23T15:01:09.748+0800    writing B2BMall.VLoginAccount to </span><br><span class="line">2020-12-23T15:01:09.759+0800    done dumping B2BMall.VLoginToken (3324 documents)</span><br><span class="line">2020-12-23T15:01:09.759+0800    done dumping B2BMall.SmallProgramUserAccount (18 documents)</span><br><span class="line">2020-12-23T15:01:09.761+0800    done dumping B2BMall.VLoginAccount (0 documents)</span><br><span class="line">[root@database mongodbbackup]# ll mongodbbackup-2020-12-23/B2BMall/</span><br><span class="line">SmallProgramUserAccount.bson           VLoginAccount.bson                     VLoginToken.bson                       </span><br><span class="line">SmallProgramUserAccount.metadata.json  VLoginAccount.metadata.json            VLoginToken.metadata.json</span><br></pre></td></tr></table></figure>

<h4 id="恢复Mysql"><a href="#恢复Mysql" class="headerlink" title="恢复Mysql"></a>恢复Mysql</h4><p>安装mysql</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https://repo.mysql.com/mysql80-community-release-el7-3.noarch.rpm</span><br><span class="line">rpm -ivh mysql80-community-release-el7-3.noarch.rpm</span><br><span class="line">yum-config-manager --disable mysql80-community</span><br><span class="line">yum-config-manager --enable mysql57-community</span><br><span class="line">#如不能使用使用yum-config-manager请使用yum -y install yum-utils</span><br><span class="line">yum install mysql-community-server</span><br><span class="line">yum -y install mysql-devel</span><br></pre></td></tr></table></figure>

<p>启动mysql</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@dev-database ~]# systemctl start mysqld</span><br></pre></td></tr></table></figure>

<p>查看临时密码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@dev-database ~]# grep &quot;temporary password&quot; /var/log/mysqld.log</span><br><span class="line">2020-10-27T08:30:11.011852Z 1 [Note] A temporary password is generated for root@localhost: iEOu+Tz47m-)</span><br></pre></td></tr></table></figure>

<p>登录mysql</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@dev-database ~]# mysql -u root -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 5</span><br><span class="line">Server version: 5.7.32</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; ALTER USER USER() IDENTIFIED BY &apos;Liangjian@360&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; grant all privileges on *.* to &apos;root&apos;@&apos;%&apos; identified by &apos;Liangjian@360&apos;;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>创建用户</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE USER &apos;hospitalTest&apos;@&apos;%&apos; IDENTIFIED BY &apos;Liangjian123360@8899&apos;;</span><br></pre></td></tr></table></figure>

<p>授权</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GRANT ALL ON *.* TO &apos;hospitalTest&apos;@&apos;%&apos;;</span><br></pre></td></tr></table></figure>

<p>恢复数据库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql -uhospitalTest -pLiangjian123360@8899</span><br><span class="line">CREATE DATABASE hospunion;</span><br><span class="line">use hospunion;</span><br><span class="line">source /home/hospunion-20-10-27.sql</span><br></pre></td></tr></table></figure>

<h5 id="恢复单个库"><a href="#恢复单个库" class="headerlink" title="恢复单个库"></a>恢复单个库</h5><p>方法一:</p>
<p>从全备中直接导入单个库 </p>
<p>格式：mysql -u用户 -p密码 单个数据库名  –one-database &lt; 全备的sql文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql -uroot -p&apos;nmk@0718&apos;  test  -o  &lt; databases-2022-07-08.sql</span><br></pre></td></tr></table></figure>

<p>方法二:</p>
<p>从全备中直接导出库数据到新的sql文件</p>
<p>格式：sed -n ‘/^– Current Database: <code>表名</code>/,/^– Current Database: `/p’  全备sql文件 &gt; 新sql文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sed -n &apos;/^-- Current Database: `test`/,/^-- Current Database: `/p&apos; databases-2022-07-08.sql &gt; test.sql</span><br></pre></td></tr></table></figure>

<p>将提取出的新的sql数据导入数据库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql -uroot -p&apos;nmk@0718&apos;  &lt; test.sql</span><br></pre></td></tr></table></figure>

<h5 id="恢复单个表"><a href="#恢复单个表" class="headerlink" title="恢复单个表"></a>恢复单个表</h5><p>方法一:</p>
<p>从全备份中导出该表的建表语句到新的sql文件中</p>
<p>格式：sed -e’/./{H;$!d;}’ -e ‘x;/CREATE TABLE <code>表名</code>/!d;q’  全备sql文件 &gt; 新sql文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sed -e&apos;/./&#123;H;$!d;&#125;&apos; -e &apos;x;/CREATE TABLE `test`/!d;q&apos; databases-2022-07-08.sql &gt; test.sql</span><br></pre></td></tr></table></figure>

<p>从全备份中导出该表的insert into语句追加到上一个sql文件中</p>
<p>格式：grep -i ‘INSERT INTO <code>表名</code>‘  全备sql文件 &gt;&gt; 含建表语句的sql文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">grep -i &apos;INSERT INTO `test`&apos; databases-2022-07-08.sql &gt;&gt; test.sql</span><br></pre></td></tr></table></figure>

<p>导入到对应的库中</p>
<p>格式：<br>use 对应的库名；<br>source 导出的sql文件；</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">use test;</span><br><span class="line">source /root/test.sql;</span><br></pre></td></tr></table></figure>

<p>mysql问题</p>
<p><strong>ERROR 1805 (HY000): Column count of mysql.user is wrong. Expected 45, found 43. The table is probabl</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; create user &apos;turn123&apos;@&apos;localhost&apos; identified by &apos;abc123&apos;; </span><br><span class="line">ERROR 1805 (HY000): Column count of mysql.user is wrong. Expected 45, found 43. The table is probably corrupted</span><br></pre></td></tr></table></figure>

<p>解决</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/usr/bin/mysql_upgrade -uroot -p -S /var/lib/mysql/mysql.sock</span><br><span class="line">不能本地登录使用/usr/bin/mysql_upgrade -S /var/lib/mysql/mysql.sock</span><br></pre></td></tr></table></figure>

<h4 id="恢复Postgresql"><a href="#恢复Postgresql" class="headerlink" title="恢复Postgresql"></a>恢复Postgresql</h4><p>安装postgresql</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm</span><br><span class="line">yum install -y postgresql12-server</span><br><span class="line">/usr/pgsql-12/bin/postgresql-12-setup initdb</span><br><span class="line">systemctl enable postgresql-12</span><br><span class="line">systemctl start postgresql-12</span><br></pre></td></tr></table></figure>

<p>切换至postgres用户</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">su postgres</span><br></pre></td></tr></table></figure>

<p>连接数据库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">psql</span><br></pre></td></tr></table></figure>

<p>修改密码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">postgres=# ALTER ROLE postgres WITH PASSWORD &apos;Liangjian@360&apos;;</span><br><span class="line">ALTER ROLE</span><br></pre></td></tr></table></figure>

<p>将认证方式修改为密码认证，打开</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/var/lib/pgsql/12/data/pg_hba.conf</span><br><span class="line"></span><br><span class="line">更改为以下配置</span><br><span class="line"># TYPE  DATABASE        USER            ADDRESS                 METHOD</span><br><span class="line"></span><br><span class="line"># &quot;local&quot; is for Unix domain socket connections only</span><br><span class="line">local   all             all                                     peer</span><br><span class="line"># IPv4 local connections:</span><br><span class="line">host    all             all             127.0.0.1/32            ident</span><br><span class="line"># IPv6 local connections:</span><br><span class="line">host    all             all             ::1/128                 ident</span><br><span class="line"># Allow replication connections from localhost, by a user with the</span><br><span class="line"># replication privilege.</span><br><span class="line">#local   replication     all                                     peer</span><br><span class="line">#host    replication     all             127.0.0.1/32            ident</span><br><span class="line">#host    replication     all             ::1/128                 ident</span><br><span class="line">host    all             all             0.0.0.0/0              md5</span><br></pre></td></tr></table></figure>

<p>开放远程连接</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/var/lib/pgsql/12/data/postgresql.conf </span><br><span class="line"></span><br><span class="line">加入以下配置</span><br><span class="line">listen_addresses = &apos;*&apos;</span><br></pre></td></tr></table></figure>

<p>重载配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">postgres=# SELECT pg_reload_conf();</span><br><span class="line"> pg_reload_conf </span><br><span class="line">----------------</span><br><span class="line"> t</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>

<p>连接数据库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">psql -U postgres -W</span><br></pre></td></tr></table></figure>

<p>创建数据库</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">createdb dbname</span><br></pre></td></tr></table></figure>

<p>删除数据库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dropdb dbname</span><br></pre></td></tr></table></figure>

<p>恢复数据库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">psql -U postgres -f pgbackup-2020-10-27.bak</span><br></pre></td></tr></table></figure>

<p>数据库恢复完,postgres远程连接密码会默认变为生产数据库密码,需要手动进行修改才可远程连接,本地连接密码不变</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">alter user postgres with password &apos;Liangjian@360&apos;;</span><br></pre></td></tr></table></figure>

<h4 id="恢复sqlserver"><a href="#恢复sqlserver" class="headerlink" title="恢复sqlserver"></a>恢复sqlserver</h4><p>下载sql server的源，便于通过yum命令来安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@dev-database home]# curl https://packages.microsoft.com/config/rhel/7/mssql-server-2017.repo &gt; /etc/yum.repos.d/mssql-server.repo</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100   232  100   232    0     0    153      0  0:00:01  0:00:01 --:--:--   153</span><br><span class="line">[root@dev-database home]# cat /etc/yum.repos.d/mssql-server.repo</span><br><span class="line">[packages-microsoft-com-mssql-server-2017]</span><br><span class="line">name=packages-microsoft-com-mssql-server-2017</span><br><span class="line">baseurl=https://packages.microsoft.com/rhel/7/mssql-server-2017/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://packages.microsoft.com/keys/microsoft.asc</span><br></pre></td></tr></table></figure>

<p>安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install -y mssql-server</span><br></pre></td></tr></table></figure>

<p>配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@dev-database home]# /opt/mssql/bin/mssql-conf setup</span><br><span class="line">Choose an edition of SQL Server:</span><br><span class="line">  1) Evaluation (free, no production use rights, 180-day limit)</span><br><span class="line">  2) Developer (free, no production use rights)</span><br><span class="line">  3) Express (free)</span><br><span class="line">  4) Web (PAID)</span><br><span class="line">  5) Standard (PAID)</span><br><span class="line">  6) Enterprise (PAID)</span><br><span class="line">  7) Enterprise Core (PAID)</span><br><span class="line">  8) I bought a license through a retail sales channel and have a product key to enter.</span><br><span class="line"></span><br><span class="line">Details about editions can be found at</span><br><span class="line">https://go.microsoft.com/fwlink/?LinkId=852748&amp;clcid=0x409</span><br><span class="line"></span><br><span class="line">Use of PAID editions of this software requires separate licensing through a</span><br><span class="line">Microsoft Volume Licensing program.</span><br><span class="line">By choosing a PAID edition, you are verifying that you have the appropriate</span><br><span class="line">number of licenses in place to install and run this software.</span><br><span class="line"></span><br><span class="line">Enter your edition(1-8): 2</span><br><span class="line">The license terms for this product can be found in</span><br><span class="line">/usr/share/doc/mssql-server or downloaded from:</span><br><span class="line">https://go.microsoft.com/fwlink/?LinkId=855862&amp;clcid=0x409</span><br><span class="line"></span><br><span class="line">The privacy statement can be viewed at:</span><br><span class="line">https://go.microsoft.com/fwlink/?LinkId=853010&amp;clcid=0x409</span><br><span class="line"></span><br><span class="line">Do you accept the license terms? [Yes/No]:</span><br><span class="line">yes</span><br><span class="line"></span><br><span class="line">Enter the SQL Server system administrator password: </span><br><span class="line">Confirm the SQL Server system administrator password: </span><br><span class="line">Configuring SQL Server...</span><br><span class="line"></span><br><span class="line">ForceFlush is enabled for this instance. </span><br><span class="line">ForceFlush feature is enabled for log durability.</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/mssql-server.service to /usr/lib/systemd/system/mssql-server.service.</span><br><span class="line">Setup has completed successfully. SQL Server is now starting.</span><br></pre></td></tr></table></figure>

<p>查看状态</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@dev-database home]# systemctl status mssql-server</span><br><span class="line">● mssql-server.service - Microsoft SQL Server Database Engine</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/mssql-server.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Sun 2021-01-31 16:30:10 CST; 28s ago</span><br><span class="line">     Docs: https://docs.microsoft.com/en-us/sql/linux</span><br><span class="line"> Main PID: 34727 (sqlservr)</span><br><span class="line">   CGroup: /system.slice/mssql-server.service</span><br><span class="line">           ├─34727 /opt/mssql/bin/sqlservr</span><br><span class="line">           └─34747 /opt/mssql/bin/sqlservr</span><br><span class="line"></span><br><span class="line">Jan 31 16:30:15 dev-database sqlservr[34727]: 2021-01-31 16:30:15.47 spid19s     SQL Server is now ready for client connections. This is an informational message; no user action is required.</span><br><span class="line">Jan 31 16:30:15 dev-database sqlservr[34727]: 2021-01-31 16:30:15.48 spid8s      0 transactions rolled back in database &apos;msdb&apos; (4:0). This is an informational message only. No user action is required.</span><br><span class="line">Jan 31 16:30:15 dev-database sqlservr[34727]: 2021-01-31 16:30:15.51 spid11s     Polybase feature disabled.</span><br><span class="line">Jan 31 16:30:15 dev-database sqlservr[34727]: 2021-01-31 16:30:15.51 spid11s     Clearing tempdb database.</span><br><span class="line">Jan 31 16:30:15 dev-database sqlservr[34727]: 2021-01-31 16:30:15.87 spid11s     Starting up database &apos;tempdb&apos;.</span><br><span class="line">Jan 31 16:30:16 dev-database sqlservr[34727]: 2021-01-31 16:30:16.06 spid11s     The tempdb database has 1 data file(s).</span><br><span class="line">Jan 31 16:30:16 dev-database sqlservr[34727]: 2021-01-31 16:30:16.08 spid22s     The Service Broker endpoint is in disabled or stopped state.</span><br><span class="line">Jan 31 16:30:16 dev-database sqlservr[34727]: 2021-01-31 16:30:16.09 spid22s     The Database Mirroring endpoint is in disabled or stopped state.</span><br><span class="line">Jan 31 16:30:16 dev-database sqlservr[34727]: 2021-01-31 16:30:16.11 spid22s     Service Broker manager has started.</span><br><span class="line">Jan 31 16:30:16 dev-database sqlservr[34727]: 2021-01-31 16:30:16.11 spid8s      Recovery is complete. This is an informational message only. No user action is required.</span><br></pre></td></tr></table></figure>

<p>开机启动</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo systemctl enable mssql-server</span><br></pre></td></tr></table></figure>

<p>连接sqlserver</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install -y mssql-tools unixODBC-devel</span><br><span class="line"></span><br><span class="line">echo &quot;export PATH=$PATH:/opt/mssql-tools/bin&quot; &gt;&gt; /etc/profile</span><br><span class="line"></span><br><span class="line">[root@dev-database home]# sqlcmd -S localhost -U sa</span><br><span class="line">Password: </span><br><span class="line">1&gt; select db_name();</span><br><span class="line">2&gt; go</span><br><span class="line">                                                                                                                                </span><br><span class="line">--------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">master                                                                                                                          </span><br><span class="line"></span><br><span class="line">(1 rows affected)</span><br><span class="line">1&gt;</span><br></pre></td></tr></table></figure>

<p>还原数据库<br><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image\image-20210131165156539.png"><br><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image\image-20210131165233729.png"><br><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="\image\image-20210131165242088.png"></p>
<h4 id="恢复mongdb"><a href="#恢复mongdb" class="headerlink" title="恢复mongdb"></a>恢复mongdb</h4><p><strong>配置系统yum源</strong></p>
<ul>
<li><p>创建.repo文件，生成mongodb的源</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi /etc/yum.repos.d/mongodb-org-4.0.repo</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加以下配置信息：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[mongodb-org-4.0]</span><br><span class="line">name=MongoDB Repository</span><br><span class="line">baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/4.0/x86_64/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://www.mongodb.org/static/pgp/server-4.0.asc</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装MongoDB</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install -y mongodb-org</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动MongoDB</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl start mongod.service</span><br></pre></td></tr></table></figure>
</li>
<li><p>MongoDB默认端口是27017，查看是否开启</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">netstat -natp | grep 27017</span><br></pre></td></tr></table></figure>
</li>
<li><p>验证服务开启</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mongo</span><br></pre></td></tr></table></figure>
</li>
<li><p>远程连接Mongodb</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi /etc/mongod.conf</span><br><span class="line"></span><br><span class="line"># network interfaces</span><br><span class="line">net:</span><br><span class="line">  port: 27017</span><br><span class="line">  bindIp: 0.0.0.0  # Enter 0.0.0.0,:: to bind to all IPv4 and IPv6 addresses or, alternatively, use the net.bindIpAll setting.</span><br><span class="line">#修改绑定ip默认127.0.0.1只允许本地连接， 所以修改为bindIp:0.0.0.0</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启mongodb服务</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">service mongod restart</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="PostgreSQL-慢查询SQL语句跟踪"><a href="#PostgreSQL-慢查询SQL语句跟踪" class="headerlink" title="PostgreSQL 慢查询SQL语句跟踪"></a>PostgreSQL 慢查询SQL语句跟踪</h4><p>开启日志跟踪</p>
<p>进入postgresql的安装目录下修改配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /var/lib/pgsql/12/data</span><br><span class="line">vi postgresql.conf </span><br><span class="line"></span><br><span class="line">logging_collector = on</span><br><span class="line">log_destination = &apos;stderr&apos;</span><br><span class="line">log_directory = &apos;log&apos;</span><br><span class="line">log_filename = &apos;postgresql-%Y-%m-%d_%H%M%S.log&apos;</span><br></pre></td></tr></table></figure>

<p>默认的跟踪日志记录在 data/log 中,例如:/var/lib/pgsql/12/data/log</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">log_rotation_age = 1440    #minute,多长时间创建新的文件记录日志。0 表示禁扩展。</span><br><span class="line">log_rotation_size = 10240    #kb,文件多大后创建新的文件记录日志。0 表示禁扩展。</span><br><span class="line">log_truncate_on_rotation = on #可重用同名日志文件</span><br></pre></td></tr></table></figure>

<p>需要跟踪SQL语句或者慢语句，得需要设置以下参数：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">log_statement = all    #需设置跟踪所有语句，否则只能跟踪出错信息</span><br><span class="line">log_min_duration_statement = 5000    #单位为毫秒,记录执行5秒及以上的SQL语句。</span><br></pre></td></tr></table></figure>

<p>postgresql.conf参数 配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">log_directory</span><br><span class="line">默认： log_directory = &apos;log&apos;</span><br><span class="line">决定存放数据库运行日志文件的目录。可以是绝对路径，也可是相对路径(相对于数据库文件所在的路径)</span><br><span class="line"></span><br><span class="line">log_filename:</span><br><span class="line">默认： log_filename = &apos;postgresql-%a.log&apos;</span><br><span class="line">数据库运行日志文件的名称。</span><br><span class="line">%Y、%m、%d、%H、%M和%S，分别表示年、月、日、小时、分和秒。</span><br><span class="line">没有指定时间信息，系统会自动在log_filename值的末尾加上文件创建时间戳作为文件名</span><br><span class="line"></span><br><span class="line">log_truncate_on_rotation</span><br><span class="line">默认： log_truncate_on_rotation = on</span><br><span class="line">系统在创建一个新的数据库运行日志文件时，如果发现存在一个同名的文件，当log_truncate_on_rotation的值是on时，系统覆盖这个同名文件。</span><br><span class="line">当log_truncate_on_rotation的值是off时，系统将重用这个同名文件，在它的末尾添加新的日志信息。</span><br><span class="line">要注意的是，只有在log_rotation_age非零时，系统才创建新的日志文件的情况下，才会覆盖同名的日志文件。</span><br><span class="line"></span><br><span class="line">log_rotation_age</span><br><span class="line">默认： log_rotation_age = 1d ，单位是分钟。</span><br><span class="line">日志轮询时间</span><br><span class="line">为0不是禁用该功能。</span><br><span class="line"></span><br><span class="line">log_rotation_size</span><br><span class="line">默认： log_rotation_size = 0 ， 单位是KB。</span><br><span class="line">日志轮询大小，当文件大小超过该值时进行切换。</span><br><span class="line">如果一个日志文件写入的数据量超过log_rotation_size的值，数据库将创建一个新的日志文件。</span><br><span class="line">为0表示禁用该功能。</span><br><span class="line"></span><br><span class="line">logfilemode</span><br><span class="line">默认： log_file_mode = 0600                   </span><br><span class="line">创建日志文件的权限</span><br><span class="line"></span><br><span class="line">log_min_duration_statement</span><br><span class="line">默认： log_min_duration_statement = -1</span><br><span class="line">只log执行时间大于设定值的语句，类似与慢查询</span><br><span class="line">0表示log所有语句；-1表示不log任何语句。</span><br><span class="line"></span><br><span class="line">log_duration</span><br><span class="line">默认： log_duration = off</span><br><span class="line">控制是否记录每个完成的SQL语句的执行时间。</span><br><span class="line">对于使用扩展协议与数据库通信的客户端，会记载Parse、Bind和Execute的执行时间。</span><br><span class="line"></span><br><span class="line">log_statement</span><br><span class="line">默认： log_statement = &apos;none&apos;                </span><br><span class="line">有效的取值是none、ddl、mod和all</span><br><span class="line">控制记录哪种SQL语句的执行信息。</span><br><span class="line">ddl包括所有数据定义语句，如CREATE、ALTER和DROP语句。</span><br><span class="line">mod包括所有ddl语句和更新数据的语句，例如INSERT、UPDATE、DELETE、TRUNCATE、 COPY FROM、PREPARE和 EXECUTE。</span><br><span class="line">All包括所有的语句。</span><br></pre></td></tr></table></figure>

<p>当 log_statement=all 和 log_min_duration_statement 同时设置时，将跟踪所有语句，忽略log_min_duration_statement 设置。所以需按情况设置其中一个或两个值。</p>
<p>加载配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select pg_reload_conf();</span><br><span class="line">show log_min_duration_statement;</span><br></pre></td></tr></table></figure>

<p>针对某个用户或者某数据库进行设置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">alter database test set log_min_duration_statement=5000;</span><br></pre></td></tr></table></figure>

<p>捕获正在查询的慢SQL</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from pg_stat_activity where state&lt;&gt;&apos;idle&apos; and now()-query_start &gt; interval &apos;5 s&apos; order by query_start ;</span><br></pre></td></tr></table></figure>

<p>查看最大连接数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">show max_connections;</span><br></pre></td></tr></table></figure>

<p>查看连接数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select count(1) from pg_stat_activity;</span><br></pre></td></tr></table></figure>

<p>参考链接:<a href="https://www.cnblogs.com/VicLiu/p/12017704.html" target="_blank" rel="noopener">https://www.cnblogs.com/VicLiu/p/12017704.html</a><br>                <a href="https://blog.csdn.net/liyingke112/article/details/84913510" target="_blank" rel="noopener">https://blog.csdn.net/liyingke112/article/details/84913510</a></p>
<h4 id="pgsql断开数据库连接"><a href="#pgsql断开数据库连接" class="headerlink" title="pgsql断开数据库连接"></a>pgsql断开数据库连接</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from pg_stat_activity</span><br><span class="line"></span><br><span class="line">SELECT </span><br><span class="line">    pg_terminate_backend(pid) </span><br><span class="line">FROM </span><br><span class="line">    pg_stat_activity </span><br><span class="line">WHERE </span><br><span class="line">    -- don&apos;t kill my own connection!</span><br><span class="line">    pid &lt;&gt; pg_backend_pid()</span><br><span class="line">    -- don&apos;t kill the connections to other databases</span><br><span class="line">    AND datname = &apos;databasename&apos;</span><br></pre></td></tr></table></figure>

<p>pgsql创建排序规则和字符分类为zh_CN.UTF-8的数据库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE DATABASE ymall TEMPLATE template0 ENCODING UTF8 LC_COLLATE &apos;zh_CN.UTF-8&apos; LC_CTYPE &apos;zh_CN.UTF-8&apos;;</span><br></pre></td></tr></table></figure>


        </div>

        
            <section class="post-copyright">
                
                
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tag/database/"># database</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">Back</a>
                <span>· </span>
                <a href="/">Home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2021/03/27/gitlab/">GitLab</a>
            
            
            <a class="next" rel="next" href="/2021/03/27/Prometheus/">Prometheus</a>
            
        </section>

        <script src="https://giscus.app/client.js" data-repo="nmk0718/nmk0718.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkyMTE0NDU3NDY=" data-category="Announcements" data-category-id="DIC_kwDODJpn8s4Clzt8" data-mapping="title" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="noborder_light" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async>
</script>
<script src="/js/clipboard.min.js"></script>
<script>
    // 更新 giscus 主题
    function updateGiscusTheme() {
        // 添加短暂延时，确保在主题切换后执行
        setTimeout(() => {
            const isDark = document.body.classList.contains('dark-theme');
            const theme = isDark ? 'noborder_dark' : 'noborder_light';
            const iframe = document.querySelector('.giscus-frame');
            
            if (iframe) {
                iframe.contentWindow.postMessage(
                    { giscus: { setConfig: { theme: theme } } },
                    'https://giscus.app'
                );
            }
        }, 100);  // 100ms 延时
    }

    // 监听主题变化
    const toggleBtn = document.getElementsByClassName('toggleBtn')[0];
    if (toggleBtn) {
        toggleBtn.addEventListener('click', updateGiscusTheme);
    }

    // 移动端主题切换监听
    const mobileToggle = document.getElementById('mobile-toggle-theme');
    if (mobileToggle) {
        mobileToggle.addEventListener('click', updateGiscusTheme);
    }

    // 初始化主题
    document.addEventListener('DOMContentLoaded', updateGiscusTheme);

    document.addEventListener('DOMContentLoaded', function () {
        var codeBlocks = document.querySelectorAll('article .code pre');

        codeBlocks.forEach(function (codeBlock) {
            var copyButton = document.createElement('button');
            copyButton.className = 'copy-button';
            copyButton.innerText = 'Copy';

            // Check if the code block is in the article content
            if (codeBlock.closest('article')) {
                codeBlock.parentNode.parentNode.style.position = 'relative'; // Update this line to select parent of span (pre)
                codeBlock.parentNode.parentNode.appendChild(copyButton); // Update this line to select parent of span (pre) 

                var isCopying = false;

                copyButton.addEventListener('click', function () {
                    if (!isCopying) {
                        var codeText = codeBlock.innerText;
                        navigator.clipboard.writeText(codeText).then(function () {
                            copyButton.innerText = 'Copied!';
                            isCopying = true;
                            setTimeout(function () {
                                copyButton.innerText = 'Copy';
                                isCopying = false;
                            }, 1500);
                        }).catch(function (err) {
                            console.error('Copy failed', err);
                        });
                    }
                });
            }
        });
    });
</script>
    </article>
</div>


        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© kk | Powered by <a href="https://hexo.io" target="_blank">Hexo</a></span>
    </div>
</footer>

    </div>

        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z\d\-\.\+]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(t.test(e.href)||r.test(e.href))&&(e.href=a.dataset.original)})});</script><script>(r=>{r.imageLazyLoadSetting.processImages=t;var a=r.imageLazyLoadSetting.isSPA,o=r.imageLazyLoadSetting.preloadRatio||1,d=i();function i(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(t){(a||t)&&(d=i());for(var e,n=0;n<d.length;n++)0<=(e=(e=d[n]).getBoundingClientRect()).bottom&&0<=e.left&&e.top<=(r.innerHeight*o||document.documentElement.clientHeight*o)&&(()=>{var t,e,a,o,i=d[n];e=function(){d=d.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).dataset.loaded||(t.hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(a=new Image,o=t.getAttribute("data-original"),a.onload=function(){t.src=o,t.removeAttribute("data-original"),t.setAttribute("data-loaded",!0),e&&e()},a.onerror=function(){t.removeAttribute("data-original"),t.setAttribute("data-loaded",!1),t.src=o},t.src!==o&&(a.src=o)))})()}function e(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",e),r.addEventListener("resize",e),r.addEventListener("orientationchange",e)})(this);</script></body>
</html>
