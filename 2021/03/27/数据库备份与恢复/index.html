<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">



<title>数据库备份与恢复 | K&#39;s Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">nimingkun&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">nimingkun&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">数据库备份与恢复</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">nmk</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2021-3-27&nbsp;&nbsp;15:20:00</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <h4 id="备份Mysql"><a href="#备份Mysql" class="headerlink" title="备份Mysql"></a>备份Mysql</h4><p>创建备份文件夹</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">mkdir</span> -p /<span class="class"><span class="keyword">data</span>/mysqlbackup/</span></span><br></pre></td></tr></table></figure>

<p>创建备份的脚本</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@prod-ghospital mysqlbackup]<span class="comment"># cat backup.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">mysqldump -upraise -pAf9Ed1Bb827b.4@9eB=&#123;9c4f <span class="params">--all-databases</span> &gt;<span class="string">/data/mysqlbackup/praise-</span>`date <span class="string">"+%y-%m-%d"</span>`<span class="string">.sql</span></span><br><span class="line">mysqldump -umessage -p4666dd3a@79.d24=9cD&#123;b382 <span class="params">--all-databases</span> &gt;<span class="string">/data/mysqlbackup/message-</span>`date <span class="string">"+%y-%m-%d"</span>`<span class="string">.sql</span></span><br><span class="line">mysqldump -uvideo -pDd0&#123;A9e2026c=94d13b@<span class="string">.62f</span> <span class="params">--all-databases</span> &gt;<span class="string">/data/mysqlbackup/video-</span>`date <span class="string">"+%y-%m-%d"</span>`<span class="string">.sql</span></span><br><span class="line">mysqldump <span class="params">--single-transaction</span> -unethospital -p97@9EbeA7.=1Fb04&#123;e87998d <span class="params">--all-databases</span> &gt;<span class="string">/data/mysqlbackup/nethospital-</span>`date <span class="string">"+%y-%m-%d"</span>`<span class="string">.sql</span></span><br><span class="line">mysqldump -uhospunion -p76984a&#125;74aE964e69b4Ce31,<span class="string">.ff</span>&#123;2f02 <span class="params">--all-databases</span> &gt;<span class="string">/data/mysqlbackup/hospunion-</span>`date <span class="string">"+%y-%m-%d"</span>`<span class="string">.sql</span></span><br><span class="line">find <span class="string">/data/mysqlbackup</span> -type f -name <span class="string">"*.sql"</span> -mtime +7 -exec rm -rf &#123;&#125; \;</span><br></pre></td></tr></table></figure>

<p>加入定时任务</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@prod</span>-ghospital mysqlbackup]<span class="comment"># crontab -l</span></span><br><span class="line">*<span class="regexp">/10 1 * * * /bin</span><span class="regexp">/sh /data</span><span class="regexp">/mysqlbackup/backup</span>.sh</span><br></pre></td></tr></table></figure>

<p>备份公众号数据库</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -ucdh -pCDH360lj#com2019 -h139<span class="number">.159</span><span class="number">.192</span><span class="number">.185</span> --all-databases &gt;/home/mysql.sql</span><br></pre></td></tr></table></figure>

<h4 id="备份Postgresql"><a href="#备份Postgresql" class="headerlink" title="备份Postgresql"></a>备份Postgresql</h4><p>更改为postgres用户</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">su postgres</span></span><br></pre></td></tr></table></figure>

<p>创建备份文件夹</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bash-<span class="number">4.2</span>$ cd /var/<span class="class"><span class="keyword">lib</span>/<span class="title">pgsql</span>/</span></span><br><span class="line">bash-<span class="number">4.2</span>$ mkdir -p postgres/backups</span><br></pre></td></tr></table></figure>

<p>创建备份脚本</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bash-4.2$ </span>cat <span class="keyword">backup.sh </span></span><br><span class="line"><span class="symbol">pg_dumpall</span> &gt; ~/postgres/<span class="keyword">backups/pgbackup-`date </span><span class="string">"+%Y-%m-%d"</span>`.<span class="keyword">bak</span></span><br><span class="line"><span class="keyword">find </span>~/postgres/<span class="keyword">backups/ </span>-type f -name <span class="string">"*.bak"</span> -mtime +<span class="number">7</span> -exec rm -rf &#123;&#125; \<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>加入定时任务</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bash-<span class="number">4.2</span><span class="variable">$ </span>crontab -l</span><br><span class="line">*<span class="regexp">/10 1 * * * /bin</span><span class="regexp">/sh ~/postgres</span><span class="regexp">/backups/backup</span>.sh</span><br></pre></td></tr></table></figure>

<h4 id="备份sqlserver"><a href="#备份sqlserver" class="headerlink" title="备份sqlserver"></a>备份sqlserver</h4><p><strong>linux备份</strong></p>
<p>安装sqlcmd</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl https:<span class="string">//packages.microsoft.com/config/rhel/8/prod.repo</span> &gt; <span class="string">/etc/yum.repos.d/msprod.repo</span></span><br><span class="line">sudo yum install mssql-tools unixODBC-devel</span><br><span class="line"><span class="keyword">echo</span> 'export PATH=<span class="string">"$PATH:/opt/mssql-tools/bin"</span>' &gt;&gt; ~<span class="string">/.bash_profile</span></span><br><span class="line"><span class="keyword">echo</span> 'export PATH=<span class="string">"$PATH:/opt/mssql-tools/bin"</span>' &gt;&gt; ~<span class="string">/.bashrc</span></span><br><span class="line">source ~<span class="string">/.bashrc</span></span><br></pre></td></tr></table></figure>

<p>备份</p>
<figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#创建数据库备份文件夹 </span><br><span class="line">mkdir -p /data/sqlserverbackup</span><br><span class="line">#给mussql授予/data/sqlserverbackup文件夹的权限 </span><br><span class="line">chown -R mssql:mssql /data/sqlserverbackup </span><br><span class="line">#登录数据库 </span><br><span class="line">sqlcmd -S <span class="number">127.0</span>.<span class="number">0.1</span> -U sa</span><br><span class="line">#备份数据库到指定路径</span><br><span class="line"><span class="meta">1&gt; </span>backup database appauth to disk=<span class="string">'/data/sqlserverbackup/appauth.bak'</span> </span><br><span class="line"><span class="meta">2&gt; </span>go</span><br></pre></td></tr></table></figure>

<p><strong>windows备份</strong></p>
<p>windows任务计划定时备份sqlserver数据库</p>
<p>在E盘下新建文件夹DBbackup，在DBbackup下创建一个sql的备份脚本，文件命名为dbback.sql</p>
<p>sql脚本如下:(DBname就是你所需要备份的数据库名)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GO</span><br><span class="line"></span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line"></span><br><span class="line">@backuptime <span class="built_in">varchar</span>(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line"></span><br><span class="line">@filename <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> @backuptime=(<span class="keyword">convert</span>(<span class="built_in">varchar</span>(<span class="number">8</span>),<span class="keyword">getdate</span>(),<span class="number">112</span>)+<span class="keyword">replace</span>(<span class="keyword">convert</span>(<span class="built_in">varchar</span>(<span class="number">5</span>),<span class="keyword">getdate</span>(),<span class="number">114</span>),<span class="string">':'</span>,<span class="string">' '</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> @filename=<span class="string">'E:\DBbackup\db_'</span>+@backuptime+<span class="string">'.bak'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">backup</span> <span class="keyword">database</span> DBname <span class="keyword">to</span> disk=@filename</span><br></pre></td></tr></table></figure>

<p>写一个批处理文件执行sql语句：</p>
<p>例如：backup_database.bat</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.bat</span>文件内容为：<span class="selector-tag">sqlcmd</span> <span class="selector-tag">-S</span> . <span class="selector-tag">-i</span> <span class="selector-tag">E</span>:\<span class="selector-tag">DBbackup</span>\<span class="selector-tag">dbback</span><span class="selector-class">.sql</span></span><br></pre></td></tr></table></figure>

<p>.bat文件内的语句可以在cmd控制台执行测试是否正确；</p>
<p>可以使用winrar加入环境变量进行压缩</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set date_str=<span class="meta">%</span>date:~,<span class="number">4</span><span class="meta">%</span><span class="meta">%</span>date:~<span class="number">5</span>,<span class="number">2</span><span class="meta">%</span><span class="meta">%</span>date:~<span class="number">8</span>,<span class="number">2</span><span class="meta">%</span></span><br><span class="line">set time_hh=<span class="meta">%</span>time:~<span class="number">0</span>,<span class="number">2</span><span class="meta">%</span></span><br><span class="line"><span class="keyword">if</span> /i <span class="meta">%</span>time_hh<span class="meta">%</span> LSS <span class="number">10</span> <span class="comment">(set time_hh=0%time:~1,1%)</span></span><br><span class="line">set data_time_str=<span class="meta">%</span>date:~,<span class="number">4</span><span class="meta">%</span><span class="meta">%</span>date:~<span class="number">5</span>,<span class="number">2</span><span class="meta">%</span><span class="meta">%</span>date:~<span class="number">8</span>,<span class="number">2</span><span class="meta">%</span>_<span class="meta">%</span>time_hh<span class="meta">%</span><span class="meta">%</span>time:~<span class="number">3</span>,<span class="number">2</span><span class="meta">%</span><span class="meta">%</span>time:~<span class="number">6</span>,<span class="number">2</span><span class="meta">%</span></span><br><span class="line">rar a db_<span class="meta">%</span>data_time_str<span class="meta">%</span>.rar -<span class="name">m5</span> -s -r *.bak</span><br></pre></td></tr></table></figure>

<p>在windows-控制面板-管理工具下，打开任务计划，创建基本任务，输入任务名称描述、设置备份时间、选择启动程序。需要注意的是在起始于选项里输入程序执行路径，完成。</p>
<img src="\image\bat.png" alt="bat" style="zoom: 50%;">

<p>删除大于7天的备份</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">delete.bat</span><br><span class="line"></span><br><span class="line">@<span class="built_in">echo</span> off&amp;<span class="built_in">setlocal</span> enabledelayedexpansion</span><br><span class="line"><span class="built_in">pushd</span> E:\DBbackup</span><br><span class="line"><span class="built_in">set</span> n=<span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> /f "delims=" <span class="variable">%%a</span> <span class="keyword">in</span> ('<span class="built_in">dir</span> /a-d-h /b /o-d shop_lepeng*.rar') <span class="keyword">do</span> (</span><br><span class="line"><span class="keyword">if</span> <span class="variable">!n!</span> <span class="keyword">geq</span> <span class="number">7</span>  <span class="built_in">del</span> "<span class="variable">%%~</span>a"</span><br><span class="line"><span class="built_in">set</span> /a n+=<span class="number">1</span> </span><br><span class="line">)</span><br><span class="line"><span class="built_in">popd</span></span><br></pre></td></tr></table></figure>

<h4 id="备份mongodb"><a href="#备份mongodb" class="headerlink" title="备份mongodb"></a>备份mongodb</h4><p>备份命令格式</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongodump -h<span class="built_in"> IP </span>--port 端口 -u 用户名 -p 密码 -d 数据库 -o 文件</span><br></pre></td></tr></table></figure>

<p>无密码备份</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@database data]# mongodump -h 192.168.50.51 -d B2BMall -o /data/mongodbbackup/mongodbbackup-`date "+%Y-%m-%d"`</span><br><span class="line">2020<span class="string">-12</span><span class="string">-23</span>T15:01:09.747<span class="string">+0800</span>    writing B2BMall.VLoginToken to </span><br><span class="line">2020<span class="string">-12</span><span class="string">-23</span>T15:01:09.747<span class="string">+0800</span>    writing B2BMall.SmallProgramUserAccount to </span><br><span class="line">2020<span class="string">-12</span><span class="string">-23</span>T15:01:09.748<span class="string">+0800</span>    writing B2BMall.VLoginAccount to </span><br><span class="line">2020<span class="string">-12</span><span class="string">-23</span>T15:01:09.759<span class="string">+0800</span>    done dumping B2BMall.VLoginToken (3324 documents)</span><br><span class="line">2020<span class="string">-12</span><span class="string">-23</span>T15:01:09.759<span class="string">+0800</span>    done dumping B2BMall.SmallProgramUserAccount (18 documents)</span><br><span class="line">2020<span class="string">-12</span><span class="string">-23</span>T15:01:09.761<span class="string">+0800</span>    done dumping B2BMall.VLoginAccount (0 documents)</span><br><span class="line">[root@database mongodbbackup]# ll mongodbbackup<span class="string">-2020</span><span class="string">-12</span><span class="string">-23</span>/B2BMall/</span><br><span class="line">SmallProgramUserAccount.bson           VLoginAccount.bson                     VLoginToken.bson                       </span><br><span class="line">SmallProgramUserAccount.metadata.json  VLoginAccount.metadata.json            VLoginToken.metadata.json</span><br></pre></td></tr></table></figure>

<h4 id="恢复Mysql"><a href="#恢复Mysql" class="headerlink" title="恢复Mysql"></a>恢复Mysql</h4><p>安装mysql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget https://repo.mysql.com/mysql80-community-<span class="keyword">release</span>-el7<span class="number">-3.</span>noarch.rpm</span><br><span class="line">rpm -ivh mysql80-community-<span class="keyword">release</span>-el7<span class="number">-3.</span>noarch.rpm</span><br><span class="line">yum-config-manager <span class="comment">--disable mysql80-community</span></span><br><span class="line">yum-config-manager <span class="comment">--enable mysql57-community</span></span><br><span class="line"><span class="comment">#如不能使用使用yum-config-manager请使用yum -y install yum-utils</span></span><br><span class="line">yum <span class="keyword">install</span> mysql-community-<span class="keyword">server</span></span><br><span class="line">yum -y <span class="keyword">install</span> mysql-devel</span><br></pre></td></tr></table></figure>

<p>启动mysql</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@dev</span>-database ~]<span class="meta"># systemctl start mysqld</span></span><br></pre></td></tr></table></figure>

<p>查看临时密码</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@dev-database ~]# <span class="keyword">grep</span> <span class="string">"temporary password"</span> /var/<span class="built_in">log</span>/mysqld.<span class="built_in">log</span></span><br><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">27</span>T08:<span class="number">30</span>:<span class="number">11.011852</span>Z <span class="number">1</span> [Note] A temporary password <span class="keyword">is</span> generated <span class="keyword">for</span> root@localhos<span class="variable">t:</span> iEOu+Tz47m-)</span><br></pre></td></tr></table></figure>

<p>登录mysql</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@dev-database ~]# mysql -u root -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">5</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">32</span></span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2020</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; ALTER USER USER() IDENTIFIED <span class="keyword">BY</span> <span class="string">'Liangjian@360'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; grant all privileges <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'root'</span>@<span class="string">'%'</span> identified <span class="keyword">by</span> <span class="string">'Liangjian@360'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>创建用户</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">'hospitalTest'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'Liangjian123360@8899'</span>;</span><br></pre></td></tr></table></figure>

<p>授权</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'hospitalTest'</span>@<span class="string">'%'</span>;</span><br></pre></td></tr></table></figure>

<p>恢复数据库</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql -uhospitalTest -pLiangjian123360@8899</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> hospunion;</span><br><span class="line"><span class="keyword">use</span> hospunion;</span><br><span class="line">source /home/hospunion-20-10-27.sql</span><br></pre></td></tr></table></figure>

<h5 id="恢复单个库"><a href="#恢复单个库" class="headerlink" title="恢复单个库"></a>恢复单个库</h5><p>方法一:</p>
<p>从全备中直接导入单个库 </p>
<p>格式：mysql -u用户 -p密码 单个数据库名  –one-database &lt; 全备的sql文件</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p'nmk@<span class="number">0718</span>'  test  -o  &lt; databases<span class="number">-2022</span><span class="number">-07</span><span class="number">-08.</span>sql</span><br></pre></td></tr></table></figure>

<p>方法二:</p>
<p>从全备中直接导出库数据到新的sql文件</p>
<p>格式：sed -n ‘/^– Current Database: <code>表名</code>/,/^– Current Database: `/p’  全备sql文件 &gt; 新sql文件</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -n <span class="string">'/^-- Current Database: `test`/,/^-- Current Database: `/p'</span> databases-<span class="number">2022</span>-<span class="number">07</span>-<span class="number">08</span><span class="selector-class">.sql</span> &gt; test.sql</span><br></pre></td></tr></table></figure>

<p>将提取出的新的sql数据导入数据库</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p'nmk@<span class="number">0718</span>'  &lt; test.sql</span><br></pre></td></tr></table></figure>

<h5 id="恢复单个表"><a href="#恢复单个表" class="headerlink" title="恢复单个表"></a>恢复单个表</h5><p>方法一:</p>
<p>从全备份中导出该表的建表语句到新的sql文件中</p>
<p>格式：sed -e’/./{H;$!d;}’ -e ‘x;/CREATE TABLE <code>表名</code>/!d;q’  全备sql文件 &gt; 新sql文件</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e'/./&#123;H;$!d;&#125;' -e 'x;/<span class="keyword">CREATE</span> TABLE <span class="symbol">`test`</span>/!d;q' databases-2022-07-08.sql &gt; test.sql</span><br></pre></td></tr></table></figure>

<p>从全备份中导出该表的insert into语句追加到上一个sql文件中</p>
<p>格式：grep -i ‘INSERT INTO <code>表名</code>‘  全备sql文件 &gt;&gt; 含建表语句的sql文件</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -<span class="selector-tag">i</span> <span class="string">'INSERT INTO `test`'</span> databases-<span class="number">2022</span>-<span class="number">07</span>-<span class="number">08</span><span class="selector-class">.sql</span> &gt;&gt; test.sql</span><br></pre></td></tr></table></figure>

<p>导入到对应的库中</p>
<p>格式：<br>use 对应的库名；<br>source 导出的sql文件；</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="keyword">test</span>;</span><br><span class="line">source /root/test.sql;</span><br></pre></td></tr></table></figure>

<p>mysql问题</p>
<p><strong>ERROR 1805 (HY000): Column count of mysql.user is wrong. Expected 45, found 43. The table is probabl</strong></p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create user 'turn123'@'localhost' identified by 'abc123'; </span><br><span class="line"><span class="keyword">ERROR </span>1805 (HY000): Column count of mysql.user is wrong. Expected 45, found 43. The table is probably corrupted</span><br></pre></td></tr></table></figure>

<p>解决</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/mysql_upgrade -uroot -p -S /var/<span class="class"><span class="keyword">lib</span>/<span class="title">mysql</span>/<span class="title">mysql</span>.<span class="title">sock</span></span></span><br><span class="line">不能本地登录使用/usr/bin/mysql_upgrade -S /var/<span class="class"><span class="keyword">lib</span>/<span class="title">mysql</span>/<span class="title">mysql</span>.<span class="title">sock</span></span></span><br></pre></td></tr></table></figure>

<h4 id="恢复Postgresql"><a href="#恢复Postgresql" class="headerlink" title="恢复Postgresql"></a>恢复Postgresql</h4><p>安装postgresql</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install -y https:<span class="regexp">//</span>download.postgresql.org<span class="regexp">/pub/</span>repos<span class="regexp">/yum/</span>reporpms<span class="regexp">/EL-7-x86_64/</span>pgdg-redhat-repo-latest.noarch.rpm</span><br><span class="line">yum install -y postgresql12-server</span><br><span class="line"><span class="regexp">/usr/</span>pgsql-<span class="number">12</span><span class="regexp">/bin/</span>postgresql-<span class="number">12</span>-setup initdb</span><br><span class="line">systemctl enable postgresql-<span class="number">12</span></span><br><span class="line">systemctl start postgresql-<span class="number">12</span></span><br></pre></td></tr></table></figure>

<p>切换至postgres用户</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">su postgres</span></span><br></pre></td></tr></table></figure>

<p>连接数据库</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">psql</span></span><br></pre></td></tr></table></figure>

<p>修改密码</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">postgres</span>=# ALTER ROLE postgres WITH PASSWORD <span class="string">'Liangjian@360'</span>;</span><br><span class="line"><span class="attribute">ALTER ROLE</span></span><br></pre></td></tr></table></figure>

<p>将认证方式修改为密码认证，打开</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/var/<span class="class"><span class="keyword">lib</span>/<span class="title">pgsql</span>/12/<span class="title">data</span>/<span class="title">pg_hba</span>.<span class="title">conf</span></span></span><br><span class="line"></span><br><span class="line">更改为以下配置</span><br><span class="line"><span class="comment"># TYPE  DATABASE        USER            ADDRESS                 METHOD</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># "local" is for Unix domain socket connections only</span></span><br><span class="line">local   all             all                                     peer</span><br><span class="line"><span class="comment"># IPv4 local connections:</span></span><br><span class="line">host    all             all             <span class="number">127.0</span>.<span class="number">0.1</span>/<span class="number">32</span>            ident</span><br><span class="line"><span class="comment"># IPv6 local connections:</span></span><br><span class="line">host    all             all             ::<span class="number">1</span>/<span class="number">128</span>                 ident</span><br><span class="line"><span class="comment"># Allow replication connections from localhost, by a user with the</span></span><br><span class="line"><span class="comment"># replication privilege.</span></span><br><span class="line"><span class="comment">#local   replication     all                                     peer</span></span><br><span class="line"><span class="comment">#host    replication     all             127.0.0.1/32            ident</span></span><br><span class="line"><span class="comment">#host    replication     all             ::1/128                 ident</span></span><br><span class="line">host    all             all             <span class="number">0.0</span>.<span class="number">0.0</span>/<span class="number">0</span>              md5</span><br></pre></td></tr></table></figure>

<p>开放远程连接</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/var/<span class="class"><span class="keyword">lib</span>/<span class="title">pgsql</span>/12/<span class="title">data</span>/<span class="title">postgresql</span>.<span class="title">conf</span> </span></span><br><span class="line"></span><br><span class="line">加入以下配置</span><br><span class="line">listen_addresses = <span class="string">'*'</span></span><br></pre></td></tr></table></figure>

<p>重载配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">postgres=# SELECT pg_reload_conf();</span><br><span class="line"> pg_reload_conf </span><br><span class="line">----------------</span><br><span class="line"> t</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>

<p>连接数据库</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">psql -U postgres -W</span></span><br></pre></td></tr></table></figure>

<p>创建数据库</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">createdb dbname</span><br></pre></td></tr></table></figure>

<p>删除数据库</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">dropdb dbname</span></span><br></pre></td></tr></table></figure>

<p>恢复数据库</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres -f pgbackup<span class="number">-2020</span><span class="number">-10</span><span class="number">-27.</span>bak</span><br></pre></td></tr></table></figure>

<p>数据库恢复完,postgres远程连接密码会默认变为生产数据库密码,需要手动进行修改才可远程连接,本地连接密码不变</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">user</span> postgres <span class="keyword">with</span> <span class="keyword">password</span> <span class="string">'Liangjian@360'</span>;</span><br></pre></td></tr></table></figure>

<h4 id="恢复sqlserver"><a href="#恢复sqlserver" class="headerlink" title="恢复sqlserver"></a>恢复sqlserver</h4><p>下载sql server的源，便于通过yum命令来安装</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@dev-database home]<span class="comment"># curl https://packages.microsoft.com/config/rhel/7/mssql-server-2017.repo &gt; /etc/yum.repos.d/mssql-server.repo</span></span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100   232  100   232    0     0    153      0  0:00:01  0:00:01 --:--:--   153</span><br><span class="line">[root@dev-database home]<span class="comment"># cat /etc/yum.repos.d/mssql-server.repo</span></span><br><span class="line">[packages-microsoft-com-mssql-server-2017]</span><br><span class="line">name=packages-microsoft-com-mssql-server-2017</span><br><span class="line">baseurl=https://packages.microsoft.com/rhel/7/mssql-server-2017/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://packages.microsoft.com/keys/microsoft.asc</span><br></pre></td></tr></table></figure>

<p>安装</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> -y mssql-<span class="keyword">server</span></span><br></pre></td></tr></table></figure>

<p>配置</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@dev-database home]<span class="comment"># /opt/mssql/bin/mssql-conf setup</span></span><br><span class="line">Choose an edition of SQL Server:</span><br><span class="line">  1) Evaluation (free, no production <span class="keyword">use</span> rights, <span class="number">180</span>-<span class="keyword">day</span> <span class="keyword">limit</span>)</span><br><span class="line">  <span class="number">2</span>) Developer (free, <span class="keyword">no</span> production <span class="keyword">use</span> rights)</span><br><span class="line">  <span class="number">3</span>) Express (free)</span><br><span class="line">  <span class="number">4</span>) Web (PAID)</span><br><span class="line">  <span class="number">5</span>) Standard (PAID)</span><br><span class="line">  <span class="number">6</span>) <span class="keyword">Enterprise</span> (PAID)</span><br><span class="line">  <span class="number">7</span>) <span class="keyword">Enterprise</span> Core (PAID)</span><br><span class="line">  <span class="number">8</span>) I bought a license <span class="keyword">through</span> a retail sales channel <span class="keyword">and</span> have a product <span class="keyword">key</span> <span class="keyword">to</span> enter.</span><br><span class="line"></span><br><span class="line">Details about <span class="keyword">editions</span> can be <span class="keyword">found</span> <span class="keyword">at</span></span><br><span class="line">https://go.microsoft.com/fwlink/?LinkId=<span class="number">852748</span>&amp;clcid=<span class="number">0x409</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Use</span> <span class="keyword">of</span> PAID <span class="keyword">editions</span> <span class="keyword">of</span> this software requires separate licensing <span class="keyword">through</span> a</span><br><span class="line">Microsoft Volume Licensing program.</span><br><span class="line"><span class="keyword">By</span> choosing a PAID <span class="keyword">edition</span>, you <span class="keyword">are</span> verifying that you have the appropriate</span><br><span class="line"><span class="built_in">number</span> <span class="keyword">of</span> licenses <span class="keyword">in</span> place <span class="keyword">to</span> <span class="keyword">install</span> <span class="keyword">and</span> run this software.</span><br><span class="line"></span><br><span class="line">Enter your <span class="keyword">edition</span>(<span class="number">1</span><span class="number">-8</span>): <span class="number">2</span></span><br><span class="line">The license terms <span class="keyword">for</span> this product can be <span class="keyword">found</span> <span class="keyword">in</span></span><br><span class="line">/usr/<span class="keyword">share</span>/doc/mssql-<span class="keyword">server</span> <span class="keyword">or</span> downloaded <span class="keyword">from</span>:</span><br><span class="line">https://go.microsoft.com/fwlink/?LinkId=<span class="number">855862</span>&amp;clcid=<span class="number">0x409</span></span><br><span class="line"></span><br><span class="line">The privacy <span class="keyword">statement</span> can be viewed <span class="keyword">at</span>:</span><br><span class="line">https://go.microsoft.com/fwlink/?LinkId=<span class="number">853010</span>&amp;clcid=<span class="number">0x409</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Do</span> you <span class="keyword">accept</span> the license terms? [Yes/<span class="keyword">No</span>]:</span><br><span class="line">yes</span><br><span class="line"></span><br><span class="line">Enter the <span class="keyword">SQL</span> <span class="keyword">Server</span> <span class="keyword">system</span> administrator <span class="keyword">password</span>: </span><br><span class="line"><span class="keyword">Confirm</span> the <span class="keyword">SQL</span> <span class="keyword">Server</span> <span class="keyword">system</span> administrator <span class="keyword">password</span>: </span><br><span class="line">Configuring <span class="keyword">SQL</span> Server...</span><br><span class="line"></span><br><span class="line">ForceFlush <span class="keyword">is</span> enabled <span class="keyword">for</span> this instance. </span><br><span class="line">ForceFlush feature <span class="keyword">is</span> enabled <span class="keyword">for</span> <span class="keyword">log</span> durability.</span><br><span class="line">Created symlink <span class="keyword">from</span> /etc/systemd/<span class="keyword">system</span>/multi-user.target.wants/mssql-server.service <span class="keyword">to</span> /usr/lib/systemd/<span class="keyword">system</span>/mssql-server.service.</span><br><span class="line">Setup has completed successfully. <span class="keyword">SQL</span> <span class="keyword">Server</span> <span class="keyword">is</span> <span class="keyword">now</span> starting.</span><br></pre></td></tr></table></figure>

<p>查看状态</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@dev-database home]# systemctl status mssql-server</span><br><span class="line">● mssql-server.service - Microsoft SQL Server Database Engine</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/mssql-server.service<span class="comment">; enabled; vendor preset: disabled)</span></span><br><span class="line">   Active: active (running) since Sun <span class="number">2021-01-31</span> <span class="number">16</span>:<span class="number">30</span>:<span class="number">10</span> CST<span class="comment">; 28s ago</span></span><br><span class="line">     Docs: https://docs.microsoft.com/en-us/sql/linux</span><br><span class="line"> Main PID: <span class="number">34727</span> (sqlservr)</span><br><span class="line">   CGroup: /system.slice/mssql-server.service</span><br><span class="line">           ├─<span class="number">34727</span> /opt/mssql/bin/sqlservr</span><br><span class="line">           └─<span class="number">34747</span> /opt/mssql/bin/sqlservr</span><br><span class="line"></span><br><span class="line">Jan <span class="number">31 16:30:15</span> dev-database sqlservr[<span class="number">34727</span>]: <span class="number">2021-01-31</span> <span class="number">16:30:15.47</span> spid19s     SQL Server is now ready for client connections. This is an informational message<span class="comment">; no user action is required.</span></span><br><span class="line">Jan <span class="number">31 16:30:15</span> dev-database sqlservr[<span class="number">34727</span>]: <span class="number">2021-01-31</span> <span class="number">16:30:15.48</span> spid8s      <span class="number">0</span> transactions rolled back in database 'msdb' (<span class="number">4</span>:<span class="number">0</span>). This is an informational message only. No user action is required.</span><br><span class="line">Jan <span class="number">31 16:30:15</span> dev-database sqlservr[<span class="number">34727</span>]: <span class="number">2021-01-31</span> <span class="number">16:30:15.51</span> spid11s     Polybase feature disabled.</span><br><span class="line">Jan <span class="number">31 16:30:15</span> dev-database sqlservr[<span class="number">34727</span>]: <span class="number">2021-01-31</span> <span class="number">16:30:15.51</span> spid11s     Clearing tempdb database.</span><br><span class="line">Jan <span class="number">31 16:30:15</span> dev-database sqlservr[<span class="number">34727</span>]: <span class="number">2021-01-31</span> <span class="number">16:30:15.87</span> spid11s     Starting up database 'tempdb'.</span><br><span class="line">Jan <span class="number">31 16:30:16</span> dev-database sqlservr[<span class="number">34727</span>]: <span class="number">2021-01-31</span> <span class="number">16:30:16.06</span> spid11s     The tempdb database has <span class="number">1</span> data file(s).</span><br><span class="line">Jan <span class="number">31 16:30:16</span> dev-database sqlservr[<span class="number">34727</span>]: <span class="number">2021-01-31</span> <span class="number">16:30:16.08</span> spid22s     The Service Broker endpoint is in disabled or stopped state.</span><br><span class="line">Jan <span class="number">31 16:30:16</span> dev-database sqlservr[<span class="number">34727</span>]: <span class="number">2021-01-31</span> <span class="number">16:30:16.09</span> spid22s     The Database Mirroring endpoint is in disabled or stopped state.</span><br><span class="line">Jan <span class="number">31 16:30:16</span> dev-database sqlservr[<span class="number">34727</span>]: <span class="number">2021-01-31</span> <span class="number">16:30:16.11</span> spid22s     Service Broker manager has started.</span><br><span class="line">Jan <span class="number">31 16:30:16</span> dev-database sqlservr[<span class="number">34727</span>]: <span class="number">2021-01-31</span> <span class="number">16:30:16.11</span> spid8s      Recovery is complete. This is an informational message only. No user action is required.</span><br></pre></td></tr></table></figure>

<p>开机启动</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl <span class="builtin-name">enable</span> mssql-server</span><br></pre></td></tr></table></figure>

<p>连接sqlserver</p>
<figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">yum install -y mssql-tools unixODBC-devel</span><br><span class="line"></span><br><span class="line">echo <span class="string">"export PATH=$PATH:/opt/mssql-tools/bin"</span> &gt;&gt; /etc/profile</span><br><span class="line"></span><br><span class="line">[root@dev-database home]# sqlcmd -S localhost -U sa</span><br><span class="line">Password: </span><br><span class="line"><span class="meta">1&gt; </span>select db_name();</span><br><span class="line"><span class="meta">2&gt; </span>go</span><br><span class="line">                                                                                                                                </span><br><span class="line">--------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">master                                                                                                                          </span><br><span class="line"></span><br><span class="line">(<span class="number">1</span> rows affected)</span><br><span class="line"><span class="number">1</span>&gt;</span><br></pre></td></tr></table></figure>

<p>还原数据库<br><img src="\image\image-20210131165156539.png"><br><img src="\image\image-20210131165233729.png"><br><img src="\image\image-20210131165242088.png"></p>
<h4 id="恢复mongdb"><a href="#恢复mongdb" class="headerlink" title="恢复mongdb"></a>恢复mongdb</h4><p><strong>配置系统yum源</strong></p>
<ul>
<li><p>创建.repo文件，生成mongodb的源</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/yum<span class="selector-class">.repos</span><span class="selector-class">.d</span>/mongodb-org-<span class="number">4.0</span>.repo</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加以下配置信息：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mongodb-org-4.0]</span></span><br><span class="line"><span class="attr">name</span>=MongoDB Repository</span><br><span class="line"><span class="attr">baseurl</span>=https://repo.mongodb.org/yum/redhat/<span class="variable">$releasever</span>/mongodb-org/<span class="number">4.0</span>/x<span class="number">86_64</span>/</span><br><span class="line"><span class="attr">gpgcheck</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">enabled</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">gpgkey</span>=https://www.mongodb.org/static/pgp/server-<span class="number">4.0</span>.asc</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装MongoDB</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> -y mongodb-org</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动MongoDB</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="literal">start</span> mongod.service</span><br></pre></td></tr></table></figure>
</li>
<li><p>MongoDB默认端口是27017，查看是否开启</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -natp <span class="string">| grep 27017</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>验证服务开启</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mongo</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>远程连接Mongodb</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/mongod.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># network interfaces</span></span><br><span class="line">net:</span><br><span class="line">  port: 27017</span><br><span class="line">  bindIp: 0.0.0.0  # Enter 0.0.0.0,:: <span class="keyword">to</span> bind <span class="keyword">to</span> all IPv4 <span class="keyword">and</span><span class="built_in"> IPv6 </span>addresses <span class="keyword">or</span>, alternatively, use the net.bindIpAll setting.</span><br><span class="line"><span class="comment">#修改绑定ip默认127.0.0.1只允许本地连接， 所以修改为bindIp:0.0.0.0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>重启mongodb服务</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">service mongod restart</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="PostgreSQL-慢查询SQL语句跟踪"><a href="#PostgreSQL-慢查询SQL语句跟踪" class="headerlink" title="PostgreSQL 慢查询SQL语句跟踪"></a>PostgreSQL 慢查询SQL语句跟踪</h4><p>开启日志跟踪</p>
<p>进入postgresql的安装目录下修改配置文件</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /var/<span class="class"><span class="keyword">lib</span>/<span class="title">pgsql</span>/12/<span class="title">data</span></span></span><br><span class="line">vi postgresql.conf </span><br><span class="line"></span><br><span class="line">logging_collector = on</span><br><span class="line">log_destination = <span class="string">'stderr'</span></span><br><span class="line">log_directory = <span class="string">'log'</span></span><br><span class="line">log_filename = <span class="string">'postgresql-%Y-%m-%d_%H%M%S.log'</span></span><br></pre></td></tr></table></figure>

<p>默认的跟踪日志记录在 data/log 中,例如:/var/lib/pgsql/12/data/log</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">log_rotation_age</span> = <span class="number">1440</span>    <span class="comment">#minute,多长时间创建新的文件记录日志。0 表示禁扩展。</span></span><br><span class="line"><span class="attr">log_rotation_size</span> = <span class="number">10240</span>    <span class="comment">#kb,文件多大后创建新的文件记录日志。0 表示禁扩展。</span></span><br><span class="line"><span class="attr">log_truncate_on_rotation</span> = <span class="literal">on</span> <span class="comment">#可重用同名日志文件</span></span><br></pre></td></tr></table></figure>

<p>需要跟踪SQL语句或者慢语句，得需要设置以下参数：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">log_statement</span> = all    <span class="comment">#需设置跟踪所有语句，否则只能跟踪出错信息</span></span><br><span class="line"><span class="attr">log_min_duration_statement</span> = <span class="number">5000</span>    <span class="comment">#单位为毫秒,记录执行5秒及以上的SQL语句。</span></span><br></pre></td></tr></table></figure>

<p>postgresql.conf参数 配置</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">log_directory</span><br><span class="line">默认： log_directory = 'log'</span><br><span class="line">决定存放数据库运行日志文件的目录。可以是绝对路径，也可是相对路径(相对于数据库文件所在的路径)</span><br><span class="line"></span><br><span class="line">log_filename:</span><br><span class="line">默认： log_filename = 'postgresql-%a.log'</span><br><span class="line">数据库运行日志文件的名称。</span><br><span class="line">%Y、%m、%d、%H、%M和%S，分别表示年、月、日、小时、分和秒。</span><br><span class="line">没有指定时间信息，系统会自动在log_filename值的末尾加上文件创建时间戳作为文件名</span><br><span class="line"></span><br><span class="line">log_truncate_on_rotation</span><br><span class="line">默认： log_truncate_on_rotation = on</span><br><span class="line">系统在创建一个新的数据库运行日志文件时，如果发现存在一个同名的文件，当log_truncate_on_rotation的值是on时，系统覆盖这个同名文件。</span><br><span class="line">当log_truncate_on_rotation的值是off时，系统将重用这个同名文件，在它的末尾添加新的日志信息。</span><br><span class="line">要注意的是，只有在log_rotation_age非零时，系统才创建新的日志文件的情况下，才会覆盖同名的日志文件。</span><br><span class="line"></span><br><span class="line">log_rotation_age</span><br><span class="line">默认： log_rotation_age = 1d ，单位是分钟。</span><br><span class="line">日志轮询时间</span><br><span class="line">为0不是禁用该功能。</span><br><span class="line"></span><br><span class="line">log_rotation_size</span><br><span class="line">默认： log_rotation_size = 0 ， 单位是KB。</span><br><span class="line">日志轮询大小，当文件大小超过该值时进行切换。</span><br><span class="line">如果一个日志文件写入的数据量超过log_rotation_size的值，数据库将创建一个新的日志文件。</span><br><span class="line">为0表示禁用该功能。</span><br><span class="line"></span><br><span class="line">logfilemode</span><br><span class="line">默认： log_file_mode = 0600                   </span><br><span class="line">创建日志文件的权限</span><br><span class="line"></span><br><span class="line">log_min_duration_statement</span><br><span class="line">默认： log_min_duration_statement = -1</span><br><span class="line">只log执行时间大于设定值的语句，类似与慢查询</span><br><span class="line">0表示log所有语句；-1表示不log任何语句。</span><br><span class="line"></span><br><span class="line">log_duration</span><br><span class="line">默认： log_duration = off</span><br><span class="line">控制是否记录每个完成的SQL语句的执行时间。</span><br><span class="line">对于使用扩展协议与数据库通信的客户端，会记载Parse、Bind和<span class="keyword">Execute</span>的执行时间。</span><br><span class="line"></span><br><span class="line">log_statement</span><br><span class="line">默认： log_statement = <span class="string">'none'</span>                </span><br><span class="line">有效的取值是<span class="keyword">none</span>、<span class="keyword">ddl</span>、<span class="keyword">mod</span>和<span class="keyword">all</span></span><br><span class="line">控制记录哪种<span class="keyword">SQL</span>语句的执行信息。</span><br><span class="line"><span class="keyword">ddl</span>包括所有数据定义语句，如<span class="keyword">CREATE</span>、<span class="keyword">ALTER</span>和<span class="keyword">DROP</span>语句。</span><br><span class="line"><span class="keyword">mod</span>包括所有<span class="keyword">ddl</span>语句和更新数据的语句，例如<span class="keyword">INSERT</span>、<span class="keyword">UPDATE</span>、<span class="keyword">DELETE</span>、<span class="keyword">TRUNCATE</span>、 COPY <span class="keyword">FROM</span>、<span class="keyword">PREPARE</span>和 <span class="keyword">EXECUTE</span>。</span><br><span class="line"><span class="keyword">All</span>包括所有的语句。</span><br></pre></td></tr></table></figure>

<p>当 log_statement=all 和 log_min_duration_statement 同时设置时，将跟踪所有语句，忽略log_min_duration_statement 设置。所以需按情况设置其中一个或两个值。</p>
<p>加载配置</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> pg_reload_conf();</span><br><span class="line"><span class="keyword">show</span> log_min_duration_statement;</span><br></pre></td></tr></table></figure>

<p>针对某个用户或者某数据库进行设置</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">database</span> <span class="keyword">test</span> <span class="keyword">set</span> log_min_duration_statement=<span class="number">5000</span>;</span><br></pre></td></tr></table></figure>

<p>捕获正在查询的慢SQL</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> pg_stat_activity <span class="keyword">where</span> state&lt;&gt;<span class="string">'idle'</span> <span class="keyword">and</span> <span class="keyword">now</span>()-query_start &gt; <span class="built_in">interval</span> <span class="string">'5 s'</span> <span class="keyword">order</span> <span class="keyword">by</span> query_start ;</span><br></pre></td></tr></table></figure>

<p>查看最大连接数</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show </span>max_connections<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>查看连接数</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">from</span> pg_stat_activity;</span><br></pre></td></tr></table></figure>

<p>参考链接:<a href="https://www.cnblogs.com/VicLiu/p/12017704.html" target="_blank" rel="noopener">https://www.cnblogs.com/VicLiu/p/12017704.html</a><br>                <a href="https://blog.csdn.net/liyingke112/article/details/84913510" target="_blank" rel="noopener">https://blog.csdn.net/liyingke112/article/details/84913510</a></p>
<h4 id="pgsql断开数据库连接"><a href="#pgsql断开数据库连接" class="headerlink" title="pgsql断开数据库连接"></a>pgsql断开数据库连接</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> pg_stat_activity</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    pg_terminate_backend(pid) </span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">    pg_stat_activity </span><br><span class="line"><span class="keyword">WHERE</span> </span><br><span class="line">    <span class="comment">-- don't kill my own connection!</span></span><br><span class="line">    pid &lt;&gt; pg_backend_pid()</span><br><span class="line">    <span class="comment">-- don't kill the connections to other databases</span></span><br><span class="line">    <span class="keyword">AND</span> datname = <span class="string">'databasename'</span></span><br></pre></td></tr></table></figure>

<p>pgsql创建排序规则和字符分类为zh_CN.UTF-8的数据库</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> ymall <span class="keyword">TEMPLATE</span> template0 <span class="keyword">ENCODING</span> UTF8 LC_COLLATE <span class="string">'zh_CN.UTF-8'</span> LC_CTYPE <span class="string">'zh_CN.UTF-8'</span>;</span><br></pre></td></tr></table></figure>


        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>nmk</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://nmk0718.github.io/2021/03/27/数据库备份与恢复/">http://nmk0718.github.io/2021/03/27/数据库备份与恢复/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2020 <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tag/database/"># database</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2021/03/27/gitlab/">GitLab</a>
            
            
            <a class="next" rel="next" href="/2021/03/27/Prometheus/">Prometheus</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© nmk | Powered by <a href="https://hexo.io" target="_blank">Hexo</a></span>
	</div>
</footer>

    </div>
</body>
</html>
