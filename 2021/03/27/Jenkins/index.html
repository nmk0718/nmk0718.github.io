<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">



<title>Jenkins | K&#39;s Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">kk&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">kk&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">Jenkins</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">nmk</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2021-3-27&nbsp;&nbsp;15:03:00</a>
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h4 id="Jenkins是什么？"><a href="#Jenkins是什么？" class="headerlink" title="Jenkins是什么？"></a>Jenkins是什么？</h4><p>Jenkins是一个开源的、提供友好操作界面的持续集成(CI)工具，起源于Hudson（Hudson是商用的），主要用于持续、自动的构建/测试软件项目、监控外部任务的运行（这个比较抽象，暂且写上，不做解释）。Jenkins用Java语言编写，可在Tomcat等流行的servlet容器中运行，也可独立运行。通常与版本管理工具(SCM)、构建工具结合使用。常用的版本控制工具有SVN、GIT，构建工具有Maven、Ant、Gradle。</p>
<h4 id="CI-CD是什么"><a href="#CI-CD是什么" class="headerlink" title="CI/CD是什么?"></a>CI/CD是什么?</h4><p>CI(Continuous integration，中文意思是持续集成)是一种软件开发时间。持续集成强调开发人员提交了新代码之后，立刻进行构建、（单元）测试。根据测试结果，我们可以确定新代码和原有代码能否正确地集成在一起。借用网络图片对CI加以理解。<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a6ec3fdcc.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a6ec3fdcc.png&quot;</a> /&gt;<br>CD(Continuous Delivery， 中文意思持续交付)是在持续集成的基础上，将集成后的代码部署到更贴近真实运行环境(类生产环境)中。比如，我们完成单元测试后，可以把代码部署到连接数据库的Staging环境中更多的测试。如果代码没有问题，可以继续手动部署到生产环境。下图反应的是CI/CD 的大概工作模式。<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a6f001677.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a6f001677.png&quot;</a> /&gt;</p>
<h4 id="Jenkins安装及配置"><a href="#Jenkins安装及配置" class="headerlink" title="Jenkins安装及配置"></a>Jenkins安装及配置</h4><ul>
<li><p>前置要求<br>操作系统为可以Linux或Windows，JDK 1.8或以上。</p>
</li>
<li><p>安装<br>到官网下载 <a href="https://jenkins.io/download/" target="_blank" rel="noopener">https://jenkins.io/download/</a> ，这里下载的war包文件，<br>执行以下命令启动jenkins:<br>java -Dfile.encoding=GBK -jar jenkins.war —httpPort=8080</p>
<p>进入Jenkins初始化页面，第一次启动时间可能有点长，耐心等待。进入成功后会看到如下画面，按提示路径打开密码文件，输入密码：<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a734c2714.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a734c2714.png&quot;</a> /&gt;<br>解锁后又是一长段时间等待，此后可能出现如下图所示界面：<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a73e4c064.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a73e4c064.png&quot;</a> /&gt;</p>
<p>表示无法下载Jenkins插件，可能是因为防火墙导致，而Jenkins插件的安装非常重要，建议翻墙。如无法翻墙，则选择Skip Plugin Installations跳过插件安装。进入以下页面，设置登陆用户<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7464192f.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7464192f.png&quot;</a> /&gt;</p>
<p>设置成功后即进入Jenkins主界面：<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a74c410bd.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a74c410bd.png&quot;</a> /&gt;</p>
<h5 id="常用配置"><a href="#常用配置" class="headerlink" title="常用配置"></a>常用配置</h5><p>在正式创建部署项目前，需要配置常用构建工具如Ant， Maven ， JDK等 。点击“系统管理”=》“全局工具配置”，进入配置界面：<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7756835e.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7756835e.png&quot;</a> /&gt;</p>
</li>
</ul>
<ol>
<li>JDK配置<br>配置构建项目需要JDK，在Linux系统下安装好JDK后，在Jenkins的配置相关的安装路径：<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a779d2ea5.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a779d2ea5.png&quot;</a> /&gt;</li>
<li>Maven配置<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a787caeb7.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a787caeb7.png&quot;</a> /&gt;</li>
<li>Ant配置<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a78ecb195.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a78ecb195.png&quot;</a> /&gt;</li>
</ol>
<ul>
<li>常用插件<br>点击“系统管理”=》“插件管理”，进入插件配置界面：<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7943ba46.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7943ba46.png&quot;</a> /&gt;<br>以下是建议安装列表(黑色选中的为可选插件):<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a79abe902.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a79abe902.png&quot;</a> /&gt;<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a79ee84e5.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a79ee84e5.png&quot;</a> /&gt;<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7a3f3637.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7a3f3637.png&quot;</a> /&gt;<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7a8be55c.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7a8be55c.png&quot;</a> /&gt;</li>
<li>Publish Over FTP插件配置<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7b1145af.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7b1145af.png&quot;</a> /&gt;</li>
<li>Publish over SSH插件配置<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7b826bb4.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7b826bb4.png&quot;</a> /&gt;<br>配置SSH,如使用ssh key 可在Passphrase使用私钥。如使用密码请删除Passphrase的密码,点击高级<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7c0ed1b3.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7c0ed1b3.png&quot;</a> /&gt;<br>点击Test configuration测试, Success表示成功</li>
<li>项目构建</li>
</ul>
<ol>
<li>Ant 项目构建<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7c5cc0f6.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7c5cc0f6.png&quot;</a> /&gt;</li>
</ol>
<p>填写描述<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7e526664.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7e526664.png&quot;</a> /&gt;<br>源码管理输和SVN地址，账号和密码：<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7ea14e34.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7ea14e34.png&quot;</a> /&gt;</p>
<p>构建环境选择“Invoke Ant”<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7eedaa9d.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7eedaa9d.png&quot;</a> /&gt;<br>设置ant构建文件<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7f32e43f.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7f32e43f.png&quot;</a> /&gt;<br>构建后选择“Send build artifacts over FTP”<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7ff8f204.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a7ff8f204.png&quot;</a> /&gt;<br>文件复制参数设置如下：<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a804a75a7.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a804a75a7.png&quot;</a> /&gt;<br>项目保存后，点“立即构建”开始项目的构建：<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a80b4393c.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a80b4393c.png&quot;</a> /&gt;</p>
<p>项目构建完成，可以在目标的FTP目录找到构建后的文件：<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a8105dfb5.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a8105dfb5.png&quot;</a> /&gt;</p>
<ul>
<li><p>项目使用<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a82b84ca3.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a82b84ca3.png&quot;</a> /&gt;</p>
<h5 id="源码配置"><a href="#源码配置" class="headerlink" title="源码配置"></a>源码配置</h5></li>
<li><p>选择SVN<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a83121a8e.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a83121a8e.png&quot;</a> /&gt;<br>URL为项目路径 Credentials为用户身份,添加<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a868d30f8.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a868d30f8.png&quot;</a> /&gt;<br>常用类型1.username with password(用户名密码)2.SSH username with private key(ssh公私钥)<br>选择1输入用户名 密码添加即可 选择2在Private Key输入私钥<br>如需在控制台输出里显示代码更新 Quiet check-out取消勾选即可</p>
</li>
<li><p>选择Git<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a86fd75b5.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a86fd75b5.png&quot;</a> /&gt;<br>URL项目库,Credentials用户名密码 Branch为分支名例如master,qa</p>
</li>
<li><p>项目打包编译<br>![img](<a href="http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a874c79c5.png&quot;" target="_blank" rel="noopener">http://showdoc.gzlplink.com/Public/Uploads/2020-08-12/5f33a874c79c5.png&quot;</a> /&gt;</p>
</li>
</ul>
<h5 id="jenkins通过ssh启动服务失败"><a href="#jenkins通过ssh启动服务失败" class="headerlink" title="jenkins通过ssh启动服务失败"></a>jenkins通过ssh启动服务失败</h5><p>查看tomcat启动日志发现报错:war包拒绝访问</p>
<p>因jenkins配置的ssh对应的windows账号不是administrator会出现没权限问题</p>
<p>方案1.更改jenkins的ssh用户为administrator</p>
<p>方案2.给需要权限的文件夹或文件授权</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">windows命令给用户授权</span><br><span class="line">cacls E:\tomcat <span class="string">/t</span> <span class="string">/e</span> <span class="string">/c</span> <span class="string">/r</span> nmk   拒绝</span><br><span class="line">Cacls E:\tomcat <span class="string">/t</span> <span class="string">/e</span> <span class="string">/c</span> <span class="string">/g</span> nmk<span class="function">:F</span>   允许</span><br><span class="line"></span><br><span class="line">多用户情况下可以给everyone</span><br><span class="line">Cacls E:\SFTP\sftp\nmk.war <span class="string">/t</span> <span class="string">/e</span> <span class="string">/c</span> <span class="string">/g</span> everyone<span class="function">:F</span></span><br></pre></td></tr></table></figure>

<h4 id="自动部署脚本"><a href="#自动部署脚本" class="headerlink" title="自动部署脚本"></a>自动部署脚本</h4><h5 id="windows自动部署war包脚本"><a href="#windows自动部署war包脚本" class="headerlink" title="windows自动部署war包脚本"></a>windows自动部署war包脚本</h5><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> /f "tokens=<span class="number">5</span>" <span class="variable">%%e</span> <span class="keyword">in</span> ('netstat -aon ^| <span class="built_in">findstr</span> ":<span class="number">9021</span>"') <span class="keyword">do</span> (<span class="built_in">set</span> f=<span class="variable">%%e</span>)</span><br><span class="line"><span class="built_in">taskkill</span> /t /f /pid <span class="variable">%f%</span> </span><br><span class="line"></span><br><span class="line"><span class="built_in">rd</span> /s /q "E:\tomcat-<span class="number">9021</span>\webapps\cmpay"</span><br><span class="line"><span class="built_in">del</span> "E:\tomcat-<span class="number">9021</span>\webapps\cmpay.war"</span><br><span class="line"><span class="built_in">move</span> cmpay.war "E:\tomcat-<span class="number">9021</span>\webapps\"</span><br><span class="line"><span class="built_in">net</span> <span class="built_in">start</span> tomcat9021</span><br></pre></td></tr></table></figure>

<p>因windows启动tomcat会被jenkins杀掉,所以要把tomcat做成服务</p>
<h5 id="windows自动部署jar包脚本"><a href="#windows自动部署jar包脚本" class="headerlink" title="windows自动部署jar包脚本"></a>windows自动部署jar包脚本</h5><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> /f <span class="string">"tokens=5"</span> %%i <span class="built_in">in</span> ('netstat -aon ^| <span class="type">findstr</span> <span class="string">":8081"</span>') <span class="built_in">do</span> (<span class="built_in">set</span> j=%%i)</span><br><span class="line">taskkill /t /f /pid %j% </span><br><span class="line"></span><br><span class="line">del E:\gzlp_red_package\lepeng-<span class="built_in">red</span>-package-coupon.jar</span><br><span class="line"><span class="built_in">move</span> lepeng-<span class="built_in">red</span>-package-coupon<span class="number">-1.0</span>-SNAPSHOT.jar <span class="string">"E:\gzlp_red_package\lepeng-red-package-coupon.jar"</span></span><br><span class="line">javaw -Xms256m -Xmx512m -jar <span class="string">"E:\gzlp_red_package\lepeng-red-package-coupon.jar"</span> --spring.profiles.active=dev</span><br></pre></td></tr></table></figure>

<h5 id="linux自动部署war包脚本"><a href="#linux自动部署war包脚本" class="headerlink" title="linux自动部署war包脚本"></a>linux自动部署war包脚本</h5><p>jenkins配置</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh <span class="regexp">/home/</span>tomcat<span class="regexp">/upload/</span>omall.sh</span><br></pre></td></tr></table></figure>

<p>omall.sh脚本如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Java Env</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/java</span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/lib/dt.jar:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin</span><br><span class="line"></span><br><span class="line">port=19181</span><br><span class="line"><span class="comment">#根据端口号查询对应的pid</span></span><br><span class="line">pid=$(netstat -nlp | grep :<span class="variable">$port</span> | awk <span class="string">'&#123;print $7&#125;'</span> | awk -F<span class="string">"/"</span> <span class="string">'&#123; print $1 &#125;'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">#杀掉对应的进程，如果pid不存在，则不执行</span></span><br><span class="line"><span class="keyword">if</span> [  -n  <span class="string">"<span class="variable">$pid</span>"</span>  ];  <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">kill</span>  -9  <span class="variable">$pid</span>;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">rm -rf /home/tomcat/omall/webapps/omall.war</span><br><span class="line">rm -rf /home/tomcat/omall/webapps/omall</span><br><span class="line">mv /home/tomcat/upload/omall.war /home/tomcat/omall/webapps</span><br><span class="line"><span class="built_in">cd</span> /home/tomcat/omall/bin</span><br><span class="line">./startup.sh</span><br></pre></td></tr></table></figure>

<h5 id="linux自动部署jar包脚本"><a href="#linux自动部署jar包脚本" class="headerlink" title="linux自动部署jar包脚本"></a>linux自动部署jar包脚本</h5><p>jenkins配置</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd <span class="meta-keyword">/home/</span>tomcat<span class="meta-keyword">/app/</span>admin-core</span><br><span class="line">nohup sh <span class="meta-keyword">/home/</span>tomcat<span class="meta-keyword">/upload/</span>admin-core.sh &gt;&gt; catalina.out <span class="number">2</span>&gt;<span class="variable">&amp;1</span></span><br></pre></td></tr></table></figure>

<p>admin-core.sh脚本如下</p>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Java Env</span></span><br><span class="line">export JAVA_HOME=/usr/java</span><br><span class="line">export CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/lib/dt.jar:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</span><br><span class="line">export PATH=<span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin</span><br><span class="line"></span><br><span class="line">port=<span class="number">48094</span></span><br><span class="line"><span class="comment">#根据端口号查询对应的pid</span></span><br><span class="line">pid=$(netstat -nlp | grep :<span class="variable">$port</span> | awk <span class="string">'&#123;print <span class="variable">$7</span>&#125;'</span> | awk -F<span class="string">"/"</span> <span class="string">'&#123; print <span class="variable">$1</span> &#125;'</span>)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#杀掉对应的进程，如果pid不存在，则不执行</span></span><br><span class="line">if [  -n  <span class="string">"<span class="variable">$pid</span>"</span>  ]<span class="comment">;  then</span></span><br><span class="line">    kill  -<span class="number">9</span>  <span class="variable">$pid</span><span class="comment">;</span></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">rm -r /home/tomcat/app/<span class="literal">admin</span>-core/<span class="literal">admin</span>-core-<span class="number">0.0</span>.<span class="number">1</span>-SNAPSHOT.jar</span><br><span class="line">mv /home/tomcat/upload/<span class="literal">admin</span>-core-<span class="number">0.0</span>.<span class="number">1</span>-SNAPSHOT.jar /home/tomcat/app/<span class="literal">admin</span>-core</span><br><span class="line">cd /home/tomcat/app/<span class="literal">admin</span>-core</span><br><span class="line">java -Xms256m -Xmx512m -jar /home/tomcat/app/<span class="literal">admin</span>-core/<span class="literal">admin</span>-core-<span class="number">0.0</span>.<span class="number">1</span>-SNAPSHOT.jar --spring.profiles.active=dev  &amp;</span><br></pre></td></tr></table></figure>

<h5 id="k8s自动部署后端脚本"><a href="#k8s自动部署后端脚本" class="headerlink" title="k8s自动部署后端脚本"></a>k8s自动部署后端脚本</h5><p><strong>执行shell</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd admin-core</span><br><span class="line">chmod +x ./build.sh</span><br><span class="line">./build<span class="selector-class">.sh</span> prod <span class="variable">$BUILD_NUMBER</span></span><br></pre></td></tr></table></figure>

<p><strong>gitlab配置</strong></p>
<p>build.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#构建有版本号的镜像，以防需要回滚，而且是从镜像创建服务</span></span><br><span class="line">docker build -t registry-vpc.cn-beijing.aliyuncs.com/lepeng-<span class="variable">$1</span>/admin-core-<span class="variable">$1</span>:<span class="variable">$2</span>     . -f Dockerfile_<span class="variable">$1</span></span><br><span class="line">docker push     registry-vpc.cn-beijing.aliyuncs.com/lepeng-<span class="variable">$1</span>/admin-core-<span class="variable">$1</span>:<span class="variable">$2</span></span><br><span class="line"><span class="comment">#构建latest版本，用于自动部署</span></span><br><span class="line">docker build -t registry-vpc.cn-beijing.aliyuncs.com/lepeng-<span class="variable">$1</span>/admin-core-<span class="variable">$1</span>:latest . -f Dockerfile_<span class="variable">$1</span></span><br><span class="line">docker push     registry-vpc.cn-beijing.aliyuncs.com/lepeng-<span class="variable">$1</span>/admin-core-<span class="variable">$1</span>:latest</span><br></pre></td></tr></table></figure>

<p>start.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">JARFILE=/home/App.jar</span><br><span class="line">LOGPATH=/home/logs</span><br><span class="line">LOG=/home/logs/App.log</span><br><span class="line"></span><br><span class="line"><span class="comment">#日志挂载</span></span><br><span class="line">ip=`ip addr |grep inet |grep eth0|awk <span class="string">'&#123;print $2&#125;'</span> |awk -F <span class="string">"/"</span> <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line">mkdir -p /home/<span class="built_in">log</span>/gzlp_equity/<span class="variable">$ip</span></span><br><span class="line"><span class="built_in">cd</span> /var/<span class="built_in">log</span></span><br><span class="line">ln -s  /home/<span class="built_in">log</span>/gzlp_equity/<span class="variable">$ip</span> java</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="variable">$LOGPATH</span> ];<span class="keyword">then</span></span><br><span class="line">   mkdir -p <span class="variable">$LOGPATH</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">java -jar -Xms512m -Xmx1024m -Dskywalking.agent.namespace=prod -Dskywalking.agent.service_name=prod-admin-core -javaagent:/home/skywalking-agent-plugins/agent-prod-bj/skywalking-agent.jar <span class="variable">$JARFILE</span> -Djava.security.egd=file:/dev/./urandom --spring.profiles.active=<span class="variable">$ACTIVE</span>  &gt;&gt; <span class="variable">$LOG</span> &amp;</span><br><span class="line"></span><br><span class="line">tail  -100f <span class="variable">$LOG</span></span><br></pre></td></tr></table></figure>

<p>Dockerfile_prod</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">FROM   registry-vpc<span class="selector-class">.cn-beijing</span><span class="selector-class">.aliyuncs</span><span class="selector-class">.com</span>/lepeng/centos:latest</span><br><span class="line">MAINTAINER nmk</span><br><span class="line"></span><br><span class="line">COPY  target/admin-core-<span class="number">0.0</span>.<span class="number">1</span>-SNAPSHOT<span class="selector-class">.jar</span> /home/App.jar</span><br><span class="line">COPY  start<span class="selector-class">.sh</span> /home/start.sh</span><br><span class="line">RUN  mkdir /home/tomcat/</span><br><span class="line">RUN chmod +x /home/start.sh</span><br><span class="line">ENV  JAVA_HOME=/usr/local/java</span><br><span class="line">ENV  PATH <span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line">ENV  CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/lib/<span class="selector-tag">dt</span><span class="selector-class">.jar</span>:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</span><br><span class="line">ENV LC_ALL=<span class="string">"en_US.UTF-8"</span></span><br><span class="line">ENV LANG=<span class="string">"en_US.UTF-8"</span></span><br><span class="line">ENV ACTIVE=prod</span><br><span class="line"></span><br><span class="line">EXPOSE <span class="number">48094</span></span><br><span class="line">CMD [<span class="string">"/home/start.sh"</span>]</span><br></pre></td></tr></table></figure>

<h5 id="k8s自动部署前端脚本"><a href="#k8s自动部署前端脚本" class="headerlink" title="k8s自动部署前端脚本"></a>k8s自动部署前端脚本</h5><p><strong>执行shell</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd ..</span><br><span class="line">tar zcvf mps-admin-ui<span class="selector-class">.tar</span> mps-admin-ui_tdev</span><br><span class="line">mv mps-admin-ui<span class="selector-class">.tar</span> mps-admin-ui_tdev/docker/</span><br><span class="line">cd mps-admin-ui_tdev/docker/</span><br><span class="line">chmod +x ./build.sh</span><br><span class="line">./build<span class="selector-class">.sh</span> test <span class="variable">$BUILD_NUMBER</span></span><br></pre></td></tr></table></figure>

<p><strong>gitlab配置</strong></p>
<p>Dockerfile_test</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FROM   registry-vpc<span class="selector-class">.cn-beijing</span><span class="selector-class">.aliyuncs</span><span class="selector-class">.com</span>/lepeng/nginx:latest</span><br><span class="line">MAINTAINER nmk</span><br><span class="line"></span><br><span class="line">COPY mps-admin-ui<span class="selector-class">.tar</span> /home/mps-admin-ui.tar</span><br><span class="line">RUN mv /usr/local/nginx/conf/nginx<span class="selector-class">.conf</span> /usr/local/nginx/conf/nginx<span class="selector-class">.conf</span><span class="selector-class">.default</span></span><br><span class="line">RUN tar zxvf /home/mps-admin-ui<span class="selector-class">.tar</span> -C /home/</span><br><span class="line">RUN mv /home/mps-admin-ui_tdev/docker/nginx<span class="selector-class">.conf</span> /usr/local/nginx/conf/nginx.conf</span><br><span class="line">COPY start<span class="selector-class">.sh</span> /home/start.sh</span><br><span class="line">RUN chmod +x /home/start.sh</span><br><span class="line"></span><br><span class="line">EXPOSE <span class="number">80</span></span><br><span class="line">CMD [<span class="string">"/home/start.sh"</span>]</span><br></pre></td></tr></table></figure>

<p>build.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#构建有版本号的镜像，以防需要回滚，而且是从镜像创建服务</span></span><br><span class="line">docker build -t registry-vpc.cn-beijing.aliyuncs.com/lepeng-<span class="variable">$1</span>/mps-admin-ui-<span class="variable">$1</span>:<span class="variable">$2</span>     . -f Dockerfile_<span class="variable">$1</span></span><br><span class="line">docker push     registry-vpc.cn-beijing.aliyuncs.com/lepeng-<span class="variable">$1</span>/mps-admin-ui-<span class="variable">$1</span>:<span class="variable">$2</span></span><br><span class="line"><span class="comment">#构建latest版本，用于自动部署</span></span><br><span class="line">docker build -t registry-vpc.cn-beijing.aliyuncs.com/lepeng-<span class="variable">$1</span>/mps-admin-ui-<span class="variable">$1</span>:latest . -f Dockerfile_<span class="variable">$1</span></span><br><span class="line">docker push     registry-vpc.cn-beijing.aliyuncs.com/lepeng-<span class="variable">$1</span>/mps-admin-ui-<span class="variable">$1</span>:latest</span><br></pre></td></tr></table></figure>

<p>start.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">mv /home/mps-admin-ui_tdev /home/mps-admin-ui</span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/nginx</span><br><span class="line">./sbin/nginx</span><br><span class="line">./sbin/nginx -t</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"nginx Start successfully"</span> &gt;&gt; nginx.log</span><br><span class="line">tail -10f nginx.log</span><br></pre></td></tr></table></figure>

<p>nginx.conf</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">user</span> nginx nginx;</span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">8</span>;</span><br><span class="line"><span class="attribute">error_log</span>   logs/error_log;</span><br><span class="line"><span class="comment">#error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line"><span class="attribute">pid</span>         /usr/local/nginx/logs/nginx.pid;</span><br><span class="line"><span class="attribute">worker_rlimit_nofile</span> <span class="number">51200</span>;</span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">use</span> <span class="literal">epoll</span>;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">51200</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line">         <span class="attribute">server_names_hash_bucket_size</span> <span class="number">512</span>;</span><br><span class="line">         <span class="attribute">client_header_buffer_size</span> <span class="number">512k</span>;</span><br><span class="line">         <span class="attribute">large_client_header_buffers</span> <span class="number">4</span> <span class="number">256k</span>;</span><br><span class="line">         <span class="attribute">client_max_body_size</span>             <span class="number">100m</span>;</span><br><span class="line">         <span class="attribute">client_body_buffer_size</span>        <span class="number">10m</span>;</span><br><span class="line">         <span class="attribute">client_header_timeout</span>     <span class="number">3m</span>;</span><br><span class="line">         <span class="attribute">client_body_timeout</span> <span class="number">3m</span>;</span><br><span class="line">         <span class="attribute">send_timeout</span>             <span class="number">3m</span>;</span><br><span class="line"> <span class="attribute">server_tokens</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">      <span class="comment">#tcp_nopush     on;</span></span><br><span class="line">      <span class="attribute">keepalive_timeout</span> <span class="number">120</span>;</span><br><span class="line">      <span class="attribute">tcp_nodelay</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">proxy_buffering</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="comment"># 开启gzip</span></span><br><span class="line">    <span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="comment"># 启用gzip压缩的最小文件，小于设置值的文件将不会压缩</span></span><br><span class="line">    <span class="attribute">gzip_min_length</span> <span class="number">1k</span>;</span><br><span class="line">    <span class="comment"># gzip 压缩级别，1-10，数字越大压缩的越好，也越占用CPU时间。一般设置1和2</span></span><br><span class="line">    <span class="attribute">gzip_comp_level</span> <span class="number">2</span>;</span><br><span class="line">    <span class="attribute">gzip_buffers</span> <span class="number">4</span> <span class="number">8k</span>;</span><br><span class="line">    <span class="attribute">gzip_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">    <span class="comment"># 进行压缩的文件类型。javascript有多种形式。其中的值可以在 mime.types 文件中找到。</span></span><br><span class="line">    <span class="attribute">gzip_types</span> text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png;</span><br><span class="line">    <span class="comment"># 是否在http header中添加Vary: Accept-Encoding，建议开启</span></span><br><span class="line">    <span class="attribute">gzip_vary</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="comment"># 禁用IE 6 gzip</span></span><br><span class="line">    <span class="attribute">gzip_disable</span> <span class="string">"MSIE [1-6]\."</span>;</span><br><span class="line">    <span class="comment">#设置缓存路径并且使用一块最大100M的共享内存，用于硬盘上的文件索引，包括文件名和请求次数，每个文件在1天内若不活跃（无请求）则从硬盘上淘汰，硬盘缓存最大10G，满了则根据LRU算法自动清除缓存。</span></span><br><span class="line">    <span class="attribute">proxy_connect_timeout</span> <span class="number">10</span>;</span><br><span class="line">    <span class="attribute">proxy_read_timeout</span> <span class="number">180</span>;</span><br><span class="line">    <span class="attribute">proxy_send_timeout</span> <span class="number">5</span>;</span><br><span class="line">    <span class="attribute">proxy_buffer_size</span> <span class="number">16k</span>;</span><br><span class="line">    <span class="attribute">proxy_buffers</span> <span class="number">4</span> <span class="number">32k</span>;</span><br><span class="line">    <span class="attribute">proxy_busy_buffers_size</span> <span class="number">96k</span>;</span><br><span class="line">    <span class="attribute">proxy_temp_file_write_size</span> <span class="number">96k</span>;</span><br><span class="line">    <span class="attribute">proxy_temp_path</span> /tmp/temp_dir;</span><br><span class="line">    <span class="comment">#proxy_cache_path /var/cache/nginx/cache levels=1:2 keys_zone=imgcache:100m inactive=1d max_size=10g;</span></span><br><span class="line"><span class="attribute">log_format</span>  main  <span class="string">'[<span class="variable">$remote_addr</span>] - [<span class="variable">$remote_user</span>] [<span class="variable">$time_local</span>] [<span class="variable">$request</span>] [<span class="variable">$status</span>] [<span class="variable">$body_bytes_sent</span>] [<span class="variable">$http_referer</span>] [<span class="variable">$http_user_agent</span>] [<span class="variable">$http_x_forwarded_for</span>] [<span class="variable">$request_time</span>] [<span class="variable">$upstream_response_time</span>] [<span class="variable">$upstream_addr</span>] [<span class="variable">$upstream_status</span>]'</span>;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  tdev.gzlplink.com;</span><br><span class="line">                <span class="attribute">add_header</span> backendIP <span class="variable">$upstream_addr</span>;   <span class="comment">#把后端具体的 upstream 返回给前端 header</span></span><br><span class="line">                <span class="attribute">add_header</span> backendCode <span class="variable">$upstream_status</span>;</span><br><span class="line">                <span class="attribute">include</span> proxy.conf;</span><br><span class="line">                <span class="attribute">access_log</span> /data1/logs/nginx/tdev.gzlplink.com-access_log main;</span><br><span class="line">                <span class="attribute">error_log</span> /data1/logs/nginx/tdev.gzlplink.com-error_log;</span><br><span class="line">        </span><br><span class="line">        <span class="attribute">location</span> /mps-admin-ui &#123;</span><br><span class="line">                <span class="attribute">root</span> /home/;</span><br><span class="line">                <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">                <span class="attribute">if</span> ( -d <span class="variable">$request_filename</span> )&#123;</span><br><span class="line">			    <span class="attribute">rewrite</span><span class="regexp"> ^/(.*)([^/])$</span> <span class="variable">$scheme</span>://<span class="variable">$host</span>/<span class="variable">$1</span><span class="variable">$2</span>/ <span class="literal">permanent</span>;</span><br><span class="line">	        	&#125;</span><br><span class="line">                <span class="attribute">log_not_found</span> <span class="literal">off</span>;</span><br><span class="line">                <span class="comment"># 关闭日志</span></span><br><span class="line">                <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">                <span class="comment"># 缓存时间7天</span></span><br><span class="line">                <span class="attribute">expires</span> <span class="number">7d</span>;</span><br><span class="line">                <span class="comment"># 指定上面设置的缓存区域</span></span><br><span class="line">                <span class="comment">#proxy_cache imgcache;</span></span><br><span class="line">                <span class="comment"># 缓存过期管理</span></span><br><span class="line">                <span class="attribute">proxy_cache_valid</span> <span class="number">200</span> <span class="number">302</span> <span class="number">1d</span>;</span><br><span class="line">                <span class="attribute">proxy_cache_valid</span> <span class="number">404</span> <span class="number">10m</span>;</span><br><span class="line">                <span class="attribute">proxy_cache_valid</span> any <span class="number">1h</span>;</span><br><span class="line">                <span class="attribute">proxy_cache_use_stale</span> <span class="literal">error</span> timeout invalid_header updating http_500 http_502 http_503 http_504;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="通过jenkins更新生产的nginx"><a href="#通过jenkins更新生产的nginx" class="headerlink" title="通过jenkins更新生产的nginx"></a>通过jenkins更新生产的nginx</h5><img src="\image\image-20200828165059543.png">

<img src="\image\image-20200824111256188.png">

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ2ze18q1ojbig8zevjrbuZ nginx]<span class="comment"># cat nginx_reload </span></span><br><span class="line"><span class="comment">#/bin/bash</span></span><br><span class="line">check_status=<span class="string">"`/usr/local/nginx/sbin/nginx -t  2&gt;&amp;1`"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">     <span class="comment">#echo "nginx configure file ok"</span></span><br><span class="line">     <span class="built_in">echo</span> <span class="variable">$check_status</span></span><br><span class="line">    /usr/<span class="built_in">local</span>/nginx/sbin/nginx  -s reload</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment">#echo "nginx configure file failed"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$check_stutus</span></span><br><span class="line"><span class="built_in">exit</span>    </span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>


        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>nmk</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://nmk0718.github.io/2021/03/27/Jenkins/">http://nmk0718.github.io/2021/03/27/Jenkins/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2020 <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tag/Jenkins/"># Jenkins</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2021/03/27/Prometheus/">Prometheus</a>
            
            
            <a class="next" rel="next" href="/2021/03/27/Flutter/">Flutter</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© nmk | Powered by <a href="https://hexo.io" target="_blank">Hexo</a></span>
	</div>
</footer>

    </div>
</body>
</html>
