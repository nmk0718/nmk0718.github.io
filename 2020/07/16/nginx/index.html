<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">



<title>nginx | K&#39;s Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">kk&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">kk&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">nginx</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">nmk</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2020-7-16&nbsp;&nbsp;16:47:00</a>
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p>Nginx 是开源、高性能、高可靠的HTTP服务器,也可作为反向代理服务器,邮件服务器，支持热部署，占用内存少、并发能力强、能支持高达 5w 个并发连接数，最重要的是Nginx 是免费的并可以商业化，配置使用也比较简单。支持FastCGI、SSL、Virtual Host、URL Rewrite、Gzip等功能。并且支持很多第三方的模块扩展。</p>
<h4 id="Nginx常用功能"><a href="#Nginx常用功能" class="headerlink" title="Nginx常用功能"></a>Nginx常用功能</h4><p>Nginx在做反向代理时,提供性能稳定,并且能够提供配置灵活的转发功能。Nginx可以根据不同的正则匹配,采取不同的转发策略,比如图片文件结尾的走文件服务器,动态页面走web服务器。并且Nginx对返回结果进行错误页跳转,异常判断等。如果被分发的服务器存在异常,他可以将请求重新转发给另外一台服务器,然后自动去除异常服务器。</p>
<h4 id="正向代理和反向代理"><a href="#正向代理和反向代理" class="headerlink" title="正向代理和反向代理"></a>正向代理和反向代理</h4><p>反向代理（Reverse Proxy）对应的是正向代理（Forward Proxy）,他们的区别：<br>正向代理： 内网服务器主动要去请求外网的地址或服务，所进行的一种行为。内网服务&gt;代理服务器&gt;外网<br>反向代理：外网要访问内网服务而进行的一种行为。 外网&gt;代理服务器&gt;内网服务<br><img src="/image/proxy.png" alt="proxy"></p>
<h4 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h4><p>请求爆发式增长的情况下,单个机器性能再强劲也无法满足要求了,这个时候集群的概念产生了,单个服务器解决不了的问题,可以使用多个服务器,然后将请求分发到各个服务器上,将负载分发到不同的服务器,这就是负载均衡,核心是「分摊压力」。Nginx 实现负载均衡,一般来说指的是将请求转发给服务器集群。<br><img src="/image/balancer.png" alt="balancer"></p>
<h4 id="动静分离"><a href="#动静分离" class="headerlink" title="动静分离"></a>动静分离</h4><p>为了加快网站的解析速度,可以把动态页面和静态页面由不同的服务器来解析,加快解析速度,降低原来单个服务器的压力。<br>一般来说,都需要将动态资源和静态资源分开,由于 Nginx 的高并发和静态资源缓存等特性,经常将静态资源部署在 Nginx 上。如果请求的是静态资源,直接到静态资源目录获取资源,如果是动态资源的请求,则利用反向代理的原理,把请求转发给对应后台应用去处理,从而实现动静分离。<br>使用前后端分离后,可以很大程度提升静态资源的访问速度,即使动态服务不可用,静态资源的访问也不会受到影响。<br><img src="/image/DynamicAndStaticSeparation.png" alt="DynamicAndStaticSeparation"></p>
<h4 id="Master-Worker模式"><a href="#Master-Worker模式" class="headerlink" title="Master-Worker模式"></a>Master-Worker模式</h4><p>启动Nginx后，其实就是在80端口启动了Socket服务进行监听</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@service nginx]</span># <span class="selector-tag">ps</span> <span class="selector-tag">-ef</span>|<span class="selector-tag">grep</span> <span class="selector-tag">nginx</span></span><br><span class="line"><span class="selector-tag">root</span>     <span class="selector-tag">146987</span>      <span class="selector-tag">1</span>  <span class="selector-tag">0</span> <span class="selector-tag">11</span><span class="selector-pseudo">:18</span> ?        <span class="selector-tag">00</span><span class="selector-pseudo">:00</span><span class="selector-pseudo">:00</span> <span class="selector-tag">nginx</span>: <span class="selector-tag">master</span> <span class="selector-tag">process</span> ./<span class="selector-tag">sbin</span>/<span class="selector-tag">nginx</span></span><br><span class="line"><span class="selector-tag">nobody</span>   <span class="selector-tag">152247</span> <span class="selector-tag">146987</span>  <span class="selector-tag">0</span> <span class="selector-tag">14</span><span class="selector-pseudo">:55</span> ?        <span class="selector-tag">00</span><span class="selector-pseudo">:00</span><span class="selector-pseudo">:00</span> <span class="selector-tag">nginx</span>: <span class="selector-tag">worker</span> <span class="selector-tag">process</span></span><br></pre></td></tr></table></figure>

<p><strong>Master进程</strong>:<br>读取并验证配置文件nginx.conf,管理worker进程。1024以下的端口只有root用户可以使用</p>
<p><strong>Worker进程</strong>:<br>真正处理请求的进程,是以普通用户的身份进行运行的,这样就可以极大增加程序的安全性。就算是万一有一个进程被劫持，那也不会有管理员权限.注意Worker进程的个数由配置文件决定，一般和CPU个数相关（有利于进程切换），配置几个就有几个Worker进程。</p>
<p><strong>热部署原理</strong>:<br>修改配置文件nginx.conf后，重新加载，master进程会进行语法错误的判断。如果存在语法错误的话，返回错误，不进行装载，如果配置文件没有语法错误，那么ngnix也不会将新的配置调整到所有worker中。而是，先不改变已经建立连接的worker，等待worker将所有请求结束之后，将原先在旧的配置下启动的worker杀死，然后使用新的配置创建新的worker。</p>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>nginx 配置文件主要分成四部分：</p>
<p><code>main</code>(全局设置): 设置的指令影响其他所有部分的设置<br><code>server</code>(主机设置):主要用于制定虚拟主机域名 IP 和端口号<br><code>upstream</code>(上游服务器设置):设置一系列的后端服务器,设置反向代理及后端服务器的负载均衡<br><code>location</code>(URL匹配特定位置后的设置):用于匹配网页位置（比如,根目录“/”,“/images”,等等）。</p>
<p>他们之间的关系：server 继承 main,location 继承 server；upstream 既不会继承指令也不会被继承。</p>
<p>配置文件的语法规则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1.配置文件由指令与指令块构成；</span><br><span class="line">2.每条指令以 ; 分号结尾,指令与参数间以空格符号分隔；</span><br><span class="line">3.指令块以 &#123;&#125; 大括号将多条指令组织在一起；</span><br><span class="line">4.include 语句允许组合多个配置文件以提升可维护性；</span><br><span class="line">5.使用 # 符号添加注释,提高可读性；</span><br><span class="line">6.使用 $ 符号使用变量；</span><br><span class="line">7.部分指令的参数支持正则表达式；</span><br></pre></td></tr></table></figure>

<p>Nginx 的配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#定义Nginx运行的用户和用户组</span></span><br><span class="line"><span class="attribute">user</span>  nginx; </span><br><span class="line"></span><br><span class="line"><span class="comment">#nginx进程数,通常设置成和cpu的数量相等,也可以设置为auto</span></span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#全局错误日志定义类型,[debug | info | notice | warn | error | crit]</span></span><br><span class="line"><span class="attribute">error_log</span>  /var/log/nginx/error.log;  </span><br><span class="line"><span class="comment">#error_log  /var/log/nginx/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  /var/log/nginx/error.log  info;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#进程pid文件</span></span><br><span class="line"><span class="attribute">pid</span>        /run/nginx.pid;</span><br><span class="line"></span><br><span class="line"><span class="comment">#指定进程可以打开的最大描述符：数目</span></span><br><span class="line"><span class="comment">#工作模式与连接数上限</span></span><br><span class="line"><span class="comment">##这个指令是指当一个nginx进程打开的最多文件描述符数目,理论值应该是最多打开文件数（ulimit -n）与nginx进程数相除,但是nginx分配请求并不是那么均匀,所以最好与ulimit -n 的值保持一致。</span></span><br><span class="line"><span class="comment">#这是因为nginx调度时分配请求到进程并不是那么的均衡,所以假如填写10240,总并发量达到3-4万时就有进程可能超过10240了,这时会返回502错误。</span></span><br><span class="line"><span class="attribute">worker_rlimit_nofile</span> <span class="number">65535</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">include</span> /etc/nginx/conf.modules.d/<span class="regexp">*.conf</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line"><span class="comment">#单个进程最大连接数（最大连接数=连接数+进程数） 默认为1024</span></span><br><span class="line"><span class="comment">#根据硬件调整,和前面工作进程配合起来用,尽量大,但是别把cup跑到100%就行。</span></span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line"><span class="comment">#当连接数过大时可设置为worker_connections  51200;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#设定http服务器</span></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line"></span><br><span class="line"> 	<span class="comment"># 文件扩展名与类型映射表</span></span><br><span class="line">    <span class="attribute">include</span>       /etc/nginx/mime.types;</span><br><span class="line">    </span><br><span class="line">	<span class="comment"># 默认文件类型</span></span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">#nginx的日志格式</span></span><br><span class="line">    <span class="attribute">log_format</span>  main  <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></span><br><span class="line">                      <span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line">                      <span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</span><br><span class="line">	<span class="comment"># Nginx访问日志存放位置</span></span><br><span class="line">    <span class="attribute">access_log</span>  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">	<span class="comment">#允许客户端请求的最大单文件字节数。如果有上传较大文件，请设置它的限制值</span></span><br><span class="line">	<span class="attribute">client_max_body_size</span>             <span class="number">100m</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">#缓冲区代理缓冲用户端请求的最大字节数</span></span><br><span class="line">    <span class="attribute">client_body_buffer_size</span>        <span class="number">10m</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">#客户端向服务端发送一个完整的 request header 的超时时间</span></span><br><span class="line">	<span class="attribute">client_header_timeout</span>     <span class="number">3m</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">#客户端与服务端建立连接后发送 request body 的超时时间</span></span><br><span class="line">	<span class="attribute">client_body_timeout</span> <span class="number">3m</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#服务端向客户端传输数据的超时时间</span></span><br><span class="line">    <span class="attribute">send_timeout</span>             <span class="number">3m</span>;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">#开启高效文件传输模式,sendfile指令指定nginx是否调用sendfile函数来输出文件,对于普通应用设为 on,如果用来进行下载等应用磁盘IO重负载应用,可设置为off,以平衡磁盘与网络I/O处理速	度,降低系统的负载。注意：如果图片显示不正常把这个改 成off。</span></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">#防止网络阻塞</span></span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#长连接超时时间,单位是秒</span></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">#开启gzip压缩</span></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment"># 加载子配置项</span></span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">index</span>   index.html index.htm;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">    	<span class="attribute">listen</span>       <span class="number">80</span>;       <span class="comment">#监听端口，默认80，小于1024的要以root启动</span></span><br><span class="line">    	<span class="attribute">server_name</span>  localhost;  <span class="comment">#服务器名，如localhost、http://www.example.com，可以通过正则匹配。</span></span><br><span class="line">    	</span><br><span class="line">    	<span class="attribute">location</span> / &#123;</span><br><span class="line">    		<span class="attribute">root</span>   /usr/share/nginx/html;  <span class="comment"># 网站根目录</span></span><br><span class="line">    		<span class="attribute">index</span>  index.html index.htm;   <span class="comment"># 默认首页文件</span></span><br><span class="line">    		<span class="attribute">deny</span> <span class="number">172.168.22.11</span>;   <span class="comment"># 禁止访问的ip地址,可以为all</span></span><br><span class="line">    		<span class="attribute">allow</span> <span class="number">172.168.33.44</span>； <span class="comment"># 允许访问的ip地址,可以为all</span></span><br><span class="line">    	&#125;</span><br><span class="line">    	</span><br><span class="line">    	error_page <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> /50x.html;  <span class="comment"># 默认50x对应的访问页面</span></span><br><span class="line">    	<span class="attribute">error_page</span> <span class="number">400</span> <span class="number">404</span> <span class="literal">error</span>.html;   <span class="comment"># 同上</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>server 块可以包含多个 location 块,location 指令用于匹配 uri,语法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> [ = | <span class="regexp">~ |</span> <span class="regexp">~* |</span><span class="regexp"> ^~]</span> uri &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>指令后面：</p>
<p>1.<code>=</code>精确匹配路径,用于不含正则表达式的 uri 前,如果匹配成功,不再进行后续的查找；<br>2.<code>^<del></del></code>用于不含正则表达式的 uri； 前,表示如果该符号后面的字符是最佳匹配,采用该规则,不再进行后续的查找；<br>3.<code></code> 表示用该符号后面的正则去匹配路径,区分大小写；<br>4.<code>~*</code>表示用该符号后面的正则去匹配路径,不区分大小写。跟 ~ 优先级都比较低,如有多个location的正则能匹配的话,则使用正则表达式最长的那个；</p>
<p>如果 uri 包含正则表达式,则必须要有 ~ 或 ~* 标志。</p>
<h4 id="常用的全局变量"><a href="#常用的全局变量" class="headerlink" title="常用的全局变量"></a>常用的全局变量</h4><table>
<thead>
<tr>
<th>全局变量名</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>$host</td>
<td>请求信息中的 Host,如果请求中没有 Host 行,则等于设置的服务器名,不包含端口</td>
</tr>
<tr>
<td>$request_method</td>
<td>客户端请求类型,如 GET、POST</td>
</tr>
<tr>
<td>$remote_addr</td>
<td>客户端的 IP 地址</td>
</tr>
<tr>
<td>$args</td>
<td>请求中的参数</td>
</tr>
<tr>
<td>$arg_PARAMETER</td>
<td>GET 请求中变量名 PARAMETER 参数的值,例如：$http_user_agent(Uaer-Agent 值), $http_referer…</td>
</tr>
<tr>
<td>$content_length</td>
<td>请求头中的 Content-length 字段</td>
</tr>
<tr>
<td>$http_user_agent</td>
<td>客户端agent信息</td>
</tr>
<tr>
<td>$http_cookie</td>
<td>客户端cookie信息</td>
</tr>
<tr>
<td>$remote_addr</td>
<td>客户端的IP地址</td>
</tr>
<tr>
<td>$remote_port</td>
<td>客户端的端口</td>
</tr>
<tr>
<td>$http_user_agent</td>
<td>客户端agent信息</td>
</tr>
<tr>
<td>$server_protocol</td>
<td>请求使用的协议,如 HTTP/1.0、HTTP/1.1</td>
</tr>
<tr>
<td>$server_addr</td>
<td>服务器地址</td>
</tr>
<tr>
<td>$server_name</td>
<td>服务器名称</td>
</tr>
<tr>
<td>$server_port</td>
<td>服务器的端口号</td>
</tr>
<tr>
<td>$scheme</td>
<td>HTTP 方法（如http,https）</td>
</tr>
</tbody></table>
<h4 id="配置正向代理"><a href="#配置正向代理" class="headerlink" title="配置正向代理"></a>配置正向代理</h4><p>代理服务器:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">resolver</span> <span class="number">8.8.8.8</span>;    <span class="comment"># 必需</span></span><br><span class="line">    <span class="attribute">resolver_timeout</span> <span class="number">5s</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 监听端口</span></span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8088</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="comment"># 配置正向代理参数</span></span><br><span class="line">        <span class="attribute">proxy_pass</span> <span class="variable">$scheme</span>://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">        <span class="comment"># 解决如果URL中带"."后Nginx 503错误</span></span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$http_host</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>linux客户端</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">一次代理，直接在shell执行：</span><br><span class="line">export http_proxy=http://192.168.10.117:8088</span><br><span class="line"></span><br><span class="line">永久使用：</span><br><span class="line">vim .bashrc</span><br><span class="line">export http_proxy=http://192.168.10.117:8088</span><br><span class="line">source  .bashrc</span><br></pre></td></tr></table></figure>

<p>配置代理后,查看出口是否变为白名单ip</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export http_proxy=http://192.168.10.117:8088</span><br><span class="line">curl http://myip.ipip.net/</span><br><span class="line">当前 IP：119.130.113.243  来自于：中国 广东 广州  电信</span><br></pre></td></tr></table></figure>

<h4 id="配置反向代理"><a href="#配置反向代理" class="headerlink" title="配置反向代理"></a>配置反向代理</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  <span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">linsten</span> <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">server_name</span> localhost;</span><br><span class="line">    </span><br><span class="line">	<span class="attribute">location</span> / &#123;</span><br><span class="line">    	<span class="attribute">proxy_pass</span> http://myserver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以将请求转发到另一个服务器上,也可以根据访问的路径跳转到不同端口的服务中。<br>比如我们监听 9001 端口,然后把访问不同路径的请求进行反向代理：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#把访问 http://127.0.0.1:9001/a 的请求转发到 http://127.0.0.1:8080</span></span><br><span class="line"><span class="comment">#把访问 http://127.0.0.1:9001/b 的请求转发到 http://127.0.0.1:8081</span></span><br><span class="line"></span><br><span class="line">在 http 模块下增加一个 server 块：</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">9001</span>;</span><br><span class="line">  <span class="attribute">server_name</span> localhost;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">location</span> /a/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:8080;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">location</span> /b/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:8081;</span><br><span class="line">	<span class="comment">#proxy_set_header 客户端请求发送给后端服务器之前,更改来自客户端的请求头信息</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment">#把原请求的Header中的Host字段也放到转发里,如果不加后端获取的请求为nginx的IP</span></span><br><span class="line">    <span class="attribute">proxy_set_header</span>   Host    <span class="variable">$host</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#获得用户的真实ip</span></span><br><span class="line">    <span class="attribute">proxy_set_header</span>   X-Real-IP   <span class="variable">$remote_addr</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span>   X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#识别协议HTTP或HTTPS</span></span><br><span class="line">    <span class="attribute">proxy_set_header</span>   X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#配置Nginx与后端代理服务器尝试建立连接的超时时间</span></span><br><span class="line">    <span class="attribute">proxy_connect_timeout</span> <span class="number">300</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#连接成功后_等候后端服务器响应时间</span></span><br><span class="line">	<span class="attribute">proxy_send_timeout</span> <span class="number">300</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#后端服务器数据回传时间</span></span><br><span class="line">	<span class="attribute">proxy_read_timeout</span> <span class="number">300</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#修改后端服务器返回的响应头中的Location和Refresh</span></span><br><span class="line">	<span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="配置负载均衡"><a href="#配置负载均衡" class="headerlink" title="配置负载均衡"></a>配置负载均衡</h4><p>Nginx 提供了好几种分配方式,默认为轮询,就是轮流来。有以下几种分配方式：</p>
<p>1.轮询,默认方式,每个请求按时间顺序逐一分配到不同的后端服务器,如果后端服务挂了,能自动剔除；</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="attribute">upstream</span> myserver &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8081</span>;  <span class="comment"># 负载均衡目的服务地址</span></span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1</span>:8082p;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.weight,权重分配,指定轮询几率,权重越高,在被访问的概率越大,用于后端服务器性能不均的情况；</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="attribute">upstream</span> myserver &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8081</span> weight=<span class="number">1</span>;  <span class="comment"># 负载均衡目的服务地址</span></span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8080</span> weight=<span class="number">1</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8082</span> weight=<span class="number">10</span>;  <span class="comment"># weight 方式,不写默认为 1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.ip_hash,对客户端请求的ip进行hash操作,然后根据hash结果将同一个客户端ip的请求分发给同一台服务器进行处理,可以解决session不共享的问题。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="attribute">upstream</span> myserver &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8081</span>;  <span class="comment"># 负载均衡目的服务地址</span></span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8082</span>;</span><br><span class="line">    ip_hash;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/image/iphash.png" alt="iphash"></p>
<p>4.fair（第三方）,按后端服务器的响应时间分配,响应时间短的优先分配,依赖第三方插件 nginx-upstream-fair,需要先安装；</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="attribute">upstream</span> myserver &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8081</span>;  <span class="comment"># 负载均衡目的服务地址</span></span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8082</span>;</span><br><span class="line">    fair;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5.backup,携带backup代表此server为备用,nginx只有在转发到主server出现问题,才会切换到backup的server</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="attribute">upstream</span> myserver &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8081</span>;  <span class="comment"># 负载均衡目的服务地址</span></span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8082</span> backup;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>开启gzip</strong></p>
<p>gzip 是一种常用的网页压缩技术,传输的网页经过 gzip 压缩之后大小通常可以变为原来的一半甚至更小（官网原话）,更小的网页体积也就意味着带宽的节约和传输速度的提升,特别是对于访问量巨大大型网站来说,每一个静态资源体积的减小,都会带来可观的流量与带宽的节省。</p>
<p>使用 gzip 不仅需要 Nginx 配置,浏览器端也需要配合,需要在请求消息头中包含 Accept-Encoding: gzip（IE5 之后所有的浏览器都支持了,是现代浏览器的默认设置）。一般在请求 html 和 css 等静态资源的时候,支持的浏览器在 request 请求静态资源的时候,会加上 Accept-Encoding: gzip 这个 header,表示自己支持 gzip 的压缩方式,Nginx 在拿到这个请求的时候,如果有相应配置,就会返回经过 gzip 压缩过的文件给浏览器,并在 response 相应的时候加上 content-encoding: gzip 来告诉浏览器自己采用的压缩方式（因为浏览器在传给服务器的时候一般还告诉服务器自己支持好几种压缩方式）,浏览器拿到压缩的文件后,根据自己的解压方式进行解析。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#进行压缩的文件类型。javascript有多种形式。其中的值可以在 mime.types 文件中找到。</span></span><br><span class="line"><span class="attribute">gzip_types</span> text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;</span><br><span class="line"></span><br><span class="line"><span class="comment">#默认 off,该模块启用后,Nginx 首先检查是否存在请求静态文件的 gz 结尾的文件,如果有则直接返回该 .gz 文件内容;</span></span><br><span class="line"><span class="attribute">gzip_static</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#默认 off,nginx做为反向代理时启用,用于设置启用或禁用从代理服务器上收到相应内容 gzip 压缩；</span></span><br><span class="line"><span class="attribute">gzip_proxied</span> any;</span><br><span class="line"></span><br><span class="line"><span class="comment">#用于在响应消息头中添加 Vary：Accept-Encoding,使代理服务器根据请求头中的 Accept-Encoding 识别是否启用 gzip 压缩</span></span><br><span class="line"><span class="attribute">gzip_vary</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#gzip 压缩比,压缩级别是 1-9,1 压缩级别最低,9 最高,数字越大压缩的越好,也越占用CPU时间。一般设置1和2；</span></span><br><span class="line"><span class="attribute">gzip_comp_level</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#获取多少内存用于缓存压缩结果,4 8k 表示以 8k*4 为单位获得；</span></span><br><span class="line"><span class="attribute">gzip_buffers</span> <span class="number">4</span> <span class="number">8k</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#启用gzip压缩的最小文件,小于设置值的文件将不会压缩</span></span><br><span class="line"><span class="attribute">gzip_min_length</span> <span class="number">1k</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#默认 1.1,启用 gzip 所需的 HTTP 最低版本;这个配置可以插入到 http 模块整个服务器的配置里,也可以插入到需要使用的虚拟主机的 server 或者下面的 location 模块中</span></span><br><span class="line"><span class="attribute">gzip_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h4 id="配置-HTTPS"><a href="#配置-HTTPS" class="headerlink" title="配置 HTTPS"></a>配置 HTTPS</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">443</span> ssl http2 default_server;   <span class="comment"># SSL 访问端口号为 443</span></span><br><span class="line">  <span class="attribute">server_name</span> www.nmk0718.com;         <span class="comment"># 填写绑定证书的域名</span></span><br><span class="line">  <span class="attribute">add_header</span> backendIP <span class="variable">$upstream_addr</span>;   <span class="comment">#把后端具体的 upstream 返回给前端 header</span></span><br><span class="line">  <span class="attribute">add_header</span> backendCode <span class="variable">$upstream_status</span>;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">ssl_certificate</span> /etc/nginx/https/nm0718.crt;   <span class="comment"># 证书文件地址</span></span><br><span class="line">  <span class="attribute">ssl_certificate_key</span> /etc/nginx/https/nm0718.key;      <span class="comment"># 私钥文件地址</span></span><br><span class="line">  <span class="attribute">ssl_session_timeout</span> <span class="number">10m</span>;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>;      <span class="comment">#请按照以下协议配置</span></span><br><span class="line">  <span class="attribute">ssl_ciphers</span> ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE; </span><br><span class="line">  <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">root</span>         /usr/share/nginx/html;</span><br><span class="line">    <span class="attribute">index</span>        index.html index.htm;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="跨域-CORS-配置"><a href="#跨域-CORS-配置" class="headerlink" title="跨域 CORS 配置"></a>跨域 CORS 配置</h4><p><strong>使用反向代理解决跨域</strong></p>
<p>在前端服务地址为 <code>prod.nmk0718.com</code> 的页面请求 <code>api.nmk0718.com</code> 的后端服务导致的跨域，可以这样配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">	<span class="attribute">server_name</span> prod.nmk0718.com;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="attribute">location</span> / &#123;</span><br><span class="line"></span><br><span class="line">	<span class="attribute">proxy_pass</span> api.nmk0718.com;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样前端调用prod.nmk0718.com的接口会被转发后api.nmk0718.com,前后端都是prod.nmk0718.com的情况下就不存在跨域了</p>
<p><strong>配置 header 解决跨域</strong></p>
<p>在请求的接口location中加入以下配置进行解决跨域</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">	<span class="attribute">server_name</span> api.nmk0718.com;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="attribute">location</span> / &#123;</span><br><span class="line"></span><br><span class="line">	<span class="attribute">proxy_pass</span> http://localhost:8081;</span><br><span class="line"></span><br><span class="line">	<span class="comment">#接受所有跨域的请求</span></span><br><span class="line">	<span class="attribute">add_header</span> Access-Control-Allow-Origin *;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#允许的请求方法</span></span><br><span class="line">    <span class="attribute">add_header</span> Access-Control-Allow-Methods <span class="string">'GET, POST, OPTIONS'</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#允许请求的header</span></span><br><span class="line">    <span class="attribute">add_header</span> Access-Control-Allow-Headers <span class="string">'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$request_method</span> = <span class="string">'OPTIONS'</span>) &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">204</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="http请求转发到https"><a href="#http请求转发到https" class="headerlink" title="http请求转发到https"></a>http请求转发到https</h4><p>配置完 HTTPS 后，浏览器还是可以访问 HTTP 的地址的，可以做一个 301 跳转，把对应域名的 HTTP 请求重定向到 HTTPS 上</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">	<span class="attribute">listen</span>   <span class="number">80</span>;</span><br><span class="line">	<span class="attribute">servername</span> www.nmk0718.com;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#单域名重定向</span></span><br><span class="line">	if ($host = 'www.sherlocked93.club';)&#123;</span><br><span class="line">		<span class="attribute">return</span> <span class="number">301</span> https://www.sherlocked93.club<span class="variable">$request_uri</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#全局非 https 协议时重定向</span></span><br><span class="line">	if ($scheme != 'https';)&#123;</span><br><span class="line">		<span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#或者全部重定向</span></span><br><span class="line">	<span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#以上配置选择自己需要的即可,不用全部加</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="转发websocket"><a href="#转发websocket" class="headerlink" title="转发websocket"></a>转发websocket</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">	map $http_upgrade $connection_upgrade &#123; default upgrade; '' close;&#125; </span><br><span class="line"><span class="section">server</span> &#123; </span><br><span class="line">	<span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="comment">#… </span></span><br><span class="line">    <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>; </span><br><span class="line">    <span class="attribute">proxy_set_header</span> Connection <span class="variable">$connection_upgrade</span>; </span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="静态文件转发"><a href="#静态文件转发" class="headerlink" title="静态文件转发"></a>静态文件转发</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#请求/web时访问的文件为/home/test/index.html</span></span><br><span class="line"><span class="attribute">location</span> /web &#123;</span><br><span class="line">	<span class="attribute">alias</span> /home/test/;</span><br><span class="line">	<span class="attribute">index</span> index.html;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#请求/web/时访问的文件为/home/web/index.html</span></span><br><span class="line"><span class="attribute">location</span> /web/ &#123;</span><br><span class="line">	<span class="attribute">root</span> /home/;</span><br><span class="line">	<span class="attribute">index</span> index.html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">##Vue路由模式需要加入try_files</span></span><br><span class="line"><span class="attribute">location</span> /app &#123;</span><br><span class="line">	<span class="attribute">alias</span> /home/test/app/;</span><br><span class="line">	<span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html <span class="literal">last</span>;</span><br><span class="line">	<span class="attribute">index</span> index.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>静态文件缓存</strong><br>由于图片、字体、音频、视频等静态文件在打包的时候通常会增加了 hash，所以缓存可以设置的长一点，先设置强制缓存，再设置协商缓存；如果存在没有 hash 值的静态文件，建议不设置强制缓存，仅通过协商缓存判断是否需要使用缓存</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> <span class="regexp">~ .*\.(css|js|jpg|png|gif|swf|woff|woff2|eot|svg|ttf|otf|mp3|m4a|aac|txt)$</span> &#123;</span><br><span class="line"><span class="attribute">expires</span> <span class="number">10d</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 如果不希望缓存</span></span><br><span class="line"><span class="attribute">expires</span> -<span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h4 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#转发 域名/api/后的任意字符 到 https://www.nmk0718.com/api/后面</span></span><br><span class="line"><span class="attribute">rewrite</span><span class="regexp"> ^/api/(.*)</span>    https://www.nmk0718.com/api/<span class="variable">$1</span> <span class="literal">permanent</span>;</span><br><span class="line">例如访问 test.nmk0718/api/abc 转发到 https://www.nmk0718.com/api/abc</span><br><span class="line"></span><br><span class="line"><span class="comment">#转发 域名/nmk0718/index后的任意字符 到error.jpg</span></span><br><span class="line"><span class="attribute">rewrite</span><span class="regexp"> ^/nmk0718/index(.*)</span> http://nmk0718.com/error.jpg;</span><br><span class="line">	</span><br><span class="line"><span class="comment">#转发 域名/nmk0718/index后字符跟systemId和&amp;shops匹配的链接 到error.jpg(因nginx不支持and故使用set参数的方式进行转发)</span></span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~/nmk0718/index</span> &#123;</span><br><span class="line">	        </span><br><span class="line">	<span class="attribute">set</span> <span class="variable">$foo</span> <span class="string">""</span>;</span><br><span class="line">	<span class="attribute">if</span> (<span class="variable">$args</span> <span class="regexp">~* "systemId=202006117621654047")</span> &#123;</span><br><span class="line">		<span class="attribute">set</span> <span class="variable">$foo</span> <span class="string">"<span class="variable">$&#123;foo&#125;</span>1"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="attribute">if</span> (<span class="variable">$args</span> <span class="regexp">~* "&amp;shops=102")</span> &#123;</span><br><span class="line">		<span class="attribute">set</span> <span class="variable">$foo</span> <span class="string">"<span class="variable">$&#123;foo&#125;</span>1"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="attribute">if</span> (<span class="variable">$foo</span> <span class="regexp">~* "11")</span> &#123;</span><br><span class="line">	<span class="attribute">rewrite</span>  /nmk0718/index    http://nmk0718.com/error.jpg;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="attribute">root</span>   html;</span><br><span class="line">	<span class="comment">#定义首页索引文件的名称</span></span><br><span class="line">	<span class="attribute">index</span>  index.html index.htm index.jsp;</span><br><span class="line">	<span class="comment">#定义后端负载服务器组</span></span><br><span class="line">	<span class="attribute">proxy_pass</span> http://nmk/nmk0718/index;</span><br><span class="line">	<span class="attribute">proxy_set_header</span>   Host    <span class="variable">$host</span>;  </span><br><span class="line">	<span class="attribute">proxy_set_header</span>   X-Real-IP   <span class="variable">$remote_addr</span>;  </span><br><span class="line">	<span class="attribute">proxy_set_header</span>   X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="操作命令"><a href="#操作命令" class="headerlink" title="操作命令"></a>操作命令</h4><p>使用nginx -h 查看完整的nginx命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@deployment nginx]# ./sbin/nginx -h</span><br><span class="line">nginx version: nginx/1.16.0</span><br><span class="line">Usage: nginx [-?hvVtTq] [-s signal] [-c filename] [-p prefix] [-g directives]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -?,-h         : this help</span><br><span class="line">  -v            : show version and exit</span><br><span class="line">  -V            : show version and configure options then exit</span><br><span class="line">  -t            : test configuration and exit</span><br><span class="line">  -T            : test configuration, dump it and exit</span><br><span class="line">  -q            : suppress non-error messages during configuration testing</span><br><span class="line">  -s signal     : send signal to a master process: stop, quit, reopen, reload</span><br><span class="line">  -p prefix     : set prefix path (default: /usr/local/nginx/)</span><br><span class="line">  -c filename   : set configuration file (default: conf/nginx.conf)</span><br><span class="line">  -g directives : set global directives out of configuration file</span><br><span class="line">  </span><br><span class="line"><span class="meta">#</span><span class="bash">nginx命令参数</span></span><br><span class="line">-c &lt;/path/to/config&gt; 为 Nginx 指定一个配置文件,来代替缺省的。</span><br><span class="line">-t 如需检查配置文件的语法的正确性</span><br><span class="line">-v 显示 nginx 的版本</span><br><span class="line">-V 显示 nginx 的版本,编译器版本和配置参数(可查看nginx使用的模块)。</span><br><span class="line">-s reload  # 向主进程发送信号,重新加载配置文件</span><br><span class="line">-s reopen	 # 重启 Nginx</span><br><span class="line">-s stop    # 快速关闭</span><br><span class="line">-s quit    # 等待工作进程处理完成后关闭</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">---windows下nginx命令---</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查看nginx进程</span></span><br><span class="line">tasklist /fi "imagename eq nginx.exe"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">强制结束所有nginx进程</span></span><br><span class="line">taskkill /F /IM nginx.exe</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">---linux下nginx命令---</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">使用yum安装的目录</span></span><br><span class="line">/etc/nginx</span><br><span class="line"><span class="meta">#</span><span class="bash">自己编译或包安装的目录</span></span><br><span class="line">/usr/local/nginx</span><br><span class="line"><span class="meta">#</span><span class="bash">如果两种都没找到nginx使用以下命令可查看到目录</span></span><br><span class="line"><span class="meta">#</span><span class="bash">centos7之前</span></span><br><span class="line">service nginx status</span><br><span class="line"><span class="meta">#</span><span class="bash">centos7之后</span></span><br><span class="line">systemctl status nginx</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查看nginx进程</span></span><br><span class="line">ps -ef|grep nginx</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">强制结束所有nginx进程</span></span><br><span class="line">killalll nginx</span><br></pre></td></tr></table></figure>

<h4 id="proxy-pass中url末尾带-与不带-的区别"><a href="#proxy-pass中url末尾带-与不带-的区别" class="headerlink" title="proxy_pass中url末尾带/与不带/的区别"></a>proxy_pass中url末尾带/与不带/的区别</h4><p><strong>proxy_pass配置中url末尾带/时，nginx转发时，会将原uri去除location匹配表达式后的内容拼接在proxy_pass中url之后。</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">测试地址:http://192.168.171.129/test/tes.jsp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">场景一:</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /test/ &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">proxy_pass</span> http://192.168.171.129:8080/server/;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">代理后实际访问地址: http://192.168.171.129:8080/server/tes.jsp</span><br><span class="line"></span><br><span class="line">场景二:</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /test &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">proxy_pass</span> http://192.168.171.129:8080/server/;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">代理后实际访问地址: http://192.168.171.129:8080/server//tes.jsp</span><br><span class="line"></span><br><span class="line">场景三:</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /test/ &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">proxy_pass</span> http://192.168.171.129:8080/;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">代理后实际访问地址: http://192.168.171.129:8080/tes.jsp</span><br><span class="line"></span><br><span class="line">场景四:</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /test &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">proxy_pass</span> http://192.168.171.129:8080/;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">代理后实际访问地址: http://192.168.171.129:8080//tes.jsp</span><br></pre></td></tr></table></figure>

<p><strong>proxy_pass配置中url末尾不带/时，如url中不包含path，则直接将原uri拼接在proxy_pass中url之后；如url中包含path，则将原uri去除location匹配表达式后的内容拼接在proxy_pass中的url之后。</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">测试地址:http://192.168.171.129/test/tes.jsp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">场景一:</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /test/ &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">proxy_pass</span> http://192.168.171.129:8080/server;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">代理后实际访问地址: http://192.168.171.129:8080/servertes.jsp</span><br><span class="line"></span><br><span class="line">场景二:</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /test &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">proxy_pass</span> http://192.168.171.129:8080/server;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">代理后实际访问地址: http://192.168.171.129:8080/server/tes.jsp</span><br><span class="line"></span><br><span class="line">场景三:</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /test/ &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">proxy_pass</span> http://192.168.171.129:8080;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">代理后实际访问地址: http://192.168.171.129:8080/test/tes.jsp</span><br><span class="line"></span><br><span class="line">场景四:</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /test &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">proxy_pass</span> http://192.168.171.129:8080;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">代理后实际访问地址: http://192.168.171.129:8080/test/tes.jsp</span><br></pre></td></tr></table></figure>

<h4 id="适配-PC-或移动设备"><a href="#适配-PC-或移动设备" class="headerlink" title="适配 PC 或移动设备"></a>适配 PC 或移动设备</h4><p>根据用户设备不同返回不同样式的站点，以前经常使用的是纯前端的自适应布局，但无论是复杂性和易用性上面还是不如分开编写的好，比如我们常见的淘宝、京东……这些大型网站就都没有采用自适应，而是用分开制作的方式，根据用户请求的 user-agent 来判断是返回 PC 还是 H5 站点。<br>使用<code>$http_user_agent</code> 全局变量来判断用户请求的 <code>user-agent</code>，指向不同的 root 路径，返回对应站点。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">	<span class="attribute">server_name</span> www.nmk0718.com;</span><br><span class="line"></span><br><span class="line">	<span class="attribute">location</span> / &#123;</span><br><span class="line"></span><br><span class="line">	<span class="attribute">root</span> /usr/share/nginx/html/pc;</span><br><span class="line"></span><br><span class="line">	<span class="attribute">if</span> (<span class="variable">$http_user_agent</span> <span class="regexp">~* '(Android|webOS|iPhone|iPod|BlackBerry)')</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="attribute">root</span> /usr/share/nginx/html/mobile;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="attribute">index</span> index.html;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="泛域名转发"><a href="#泛域名转发" class="headerlink" title="泛域名转发"></a>泛域名转发</h4><p>和之前的功能类似,有时候我们希望把二级或者三级域名链接重写到我们希望的路径,让后端就可以根据路由解析不同的规则：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">test1.nmk0718.com/api?name=a 自动转发到 127.0.0.1:8080/test1/api?name=a；</span><br><span class="line">test2.nmk0718.com/api?name=a 自动转发到 127.0.0.1:8080/test2/api?name=a ；</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> ~^([\w-]+)\.nmk0718\.com$;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_set_header</span>        X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span>        X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span>        Host <span class="variable">$http_host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span>        X-NginX-Proxy <span class="literal">true</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span>              http://127.0.0.1:8080/<span class="variable">$1</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="泛域名路径分离"><a href="#泛域名路径分离" class="headerlink" title="泛域名路径分离"></a>泛域名路径分离</h4><p>这是一个非常实用的技能,经常有时候我们可能需要配置一些二级或者三级域名,希望通过 Nginx 自动指向对应目录,比如：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">test1.nmk0718.com 自动指向 /usr/share/nginx/html/test1 服务器地址；</span><br><span class="line">test2.nmk0718.com 自动指向 /usr/share/nginx/html/test2 服务器地址；</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  ~^([\w-]+)\.nmk0718\.com$;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">root</span> /usr/share/nginx/html/<span class="variable">$1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.为了使 Nginx 配置更易于维护,建议为每个服务创建一个单独的配置文件,存储在 /etc/nginx/conf/website 目录,根据需求可以创建任意多个独立的配置文件。<br>2.独立的配置文件,建议遵循以下命名约定 &lt;服务&gt;.conf,比如域名是www. nmk0718.com”,那么你的配置文件的应该是这样的./etc/nginx/conf/website/www. nmk0718.com.conf,如果部署多个服务,也可以在文件名中加上 Nginx 转发的端口号。<br>3.Nginx 日志相关目录,内以 域名.type.log 命名（比如www. nmk0718.com.access.log 和 www. nmk0718.com.error.log ）位于 /var/log/nginx/ 目录中,为每个独立的服务配置不同的访问权限和错误日志文件,这样查找错误时,会更加方便快捷。<br>日志相关目录,内以 域名.type.log 命名（比如 www. nmk0718.com.access.log 和 www. nmk0718.com.error.log ）位于 /var/log/nginx/ 目录中,为每个独立的服务配置不同的访问权限和错误日志文件,这样查找错误时,会更加方便快捷。</p>
<h4 id="转发物理机-容器流量10-1"><a href="#转发物理机-容器流量10-1" class="headerlink" title="转发物理机:容器流量10:1"></a>转发物理机:容器流量10:1</h4><p>转发思路:user&gt;master-nginx&gt;upstream&gt;slave-nginx或ingress</p>
<p>最后效果:用户访问域名,域名进入nginx的upstream 10次有1次进入ingress转发给容器,另外就此转发给slave-nginx,再转给物理机</p>
<p>master-nginx</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#物理机双节点</span></span><br><span class="line"><span class="attribute">upstream</span> nmk&#123;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">172.17.53.153:19151</span>;</span><br><span class="line">	    <span class="attribute">server</span> <span class="number">172.17.53.154:19151</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> 改为</span><br><span class="line"><span class="comment">#148为slave-nginx的ip,172为ingress的ip</span></span><br><span class="line"><span class="attribute">upstream</span> nmkhttp &#123;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">172.17.53.148:80</span> weight=<span class="number">10</span> fail_timeout=<span class="number">10</span>;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">172.17.53.172:80</span> weight=<span class="number">1</span> fail_timeout=<span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">upstream</span> nmkhttps &#123;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">172.17.53.148:443</span> weight=<span class="number">10</span> fail_timeout=<span class="number">10</span>;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">172.17.53.172:443</span> weight=<span class="number">1</span> fail_timeout=<span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span> default;</span><br><span class="line">		<span class="attribute">server_name</span>  www.nmk0718.com</span><br><span class="line">	</span><br><span class="line">location /nmk &#123;</span><br><span class="line">			<span class="attribute">root</span>   html;</span><br><span class="line">			<span class="comment">#定义首页索引文件的名称</span></span><br><span class="line">			<span class="attribute">index</span>  index.html index.htm index.jsp;</span><br><span class="line">			<span class="comment">#定义后端负载服务器组</span></span><br><span class="line">			<span class="attribute">proxy_pass</span> http://nmkhttp;</span><br><span class="line">			<span class="attribute">proxy_set_header</span>   Host   <span class="variable">$host</span>:<span class="variable">$server_port</span>;  </span><br><span class="line">			<span class="attribute">proxy_set_header</span>   X-Real-IP   <span class="variable">$remote_addr</span>;  </span><br><span class="line">			<span class="attribute">proxy_set_header</span>   X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>; </span><br><span class="line">			&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">            <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">	        <span class="attribute">listen</span> <span class="number">8443</span> ssl;</span><br><span class="line">            <span class="attribute">server_name</span> www.nmk0718.com</span><br><span class="line"></span><br><span class="line">location /nmk &#123;</span><br><span class="line">			<span class="attribute">root</span>   html;</span><br><span class="line">			<span class="comment">#定义首页索引文件的名称</span></span><br><span class="line">			<span class="attribute">index</span>  index.html index.htm index.jsp;</span><br><span class="line">			<span class="comment">#定义后端负载服务器组</span></span><br><span class="line">			<span class="attribute">proxy_pass</span> https://nmkhttps;</span><br><span class="line">			<span class="attribute">proxy_set_header</span>   Host   <span class="variable">$host</span>:<span class="variable">$server_port</span>;  </span><br><span class="line">			<span class="attribute">proxy_set_header</span>   X-Real-IP   <span class="variable">$remote_addr</span>;  </span><br><span class="line">			<span class="attribute">proxy_set_header</span>   X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">			&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>slave-nginx</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">upstream</span> nmk&#123;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">172.17.53.153:19151</span>;</span><br><span class="line">	    <span class="attribute">server</span> <span class="number">172.17.53.154:19151</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span> default;</span><br><span class="line">		<span class="attribute">server_name</span>  www.nmk0718.com</span><br><span class="line">	</span><br><span class="line">location /nmk &#123;</span><br><span class="line">			<span class="attribute">root</span>   html;</span><br><span class="line">			<span class="comment">#定义首页索引文件的名称</span></span><br><span class="line">			<span class="attribute">index</span>  index.html index.htm index.jsp;</span><br><span class="line">			<span class="comment">#定义后端负载服务器组</span></span><br><span class="line">			<span class="attribute">proxy_pass</span> http://nmk;</span><br><span class="line">			<span class="attribute">proxy_set_header</span>   Host   <span class="variable">$host</span>:<span class="variable">$server_port</span>;  </span><br><span class="line">			<span class="attribute">proxy_set_header</span>   X-Real-IP   <span class="variable">$remote_addr</span>;  </span><br><span class="line">			<span class="attribute">proxy_set_header</span>   X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>; </span><br><span class="line">			&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="后端健康检查"><a href="#后端健康检查" class="headerlink" title="后端健康检查"></a>后端健康检查</h4><p>nginx自带健康检查的缺陷：</p>
<ol>
<li>Nginx只有当有访问时后，才发起对后端节点探测。</li>
<li>如果本次请求中，节点正好出现故障，Nginx依然将请求转交给故障的节点,然后再转交给健康的节点处理。所以不会影响到这次请求的正常进行。但是会影响效率,因为多了一次转发</li>
<li>自带模块无法做到预警</li>
<li>被动健康检查</li>
</ol>
<p>使用第三访模块nginx_upstream_check_module：</p>
<ol>
<li>区别于nginx自带的非主动式的心跳检测，淘宝开发的tengine自带了一个提供主动式后端服务器心跳检测模块</li>
<li>若健康检查包类型为http，在开启健康检查功能后，nginx会根据设置的间隔向指定的后端服务器端口发送健康检查包，并根据期望的HTTP回复状态码来判断服务是否健康。</li>
<li>后端真实节点不可用，则请求不会转发到故障节点</li>
<li>故障节点恢复后，请求正常转发</li>
</ol>
<p>主动地健康检查，nignx定时主动地去ping后端的服务列表，当发现某服务出现异常时，把该服务从健康列表中移除，当发现某服务恢复时，又能够将该服务加回健康列表中。淘宝有一个开源的实现nginx_upstream_check_module模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">github地址：https://github.com/yaoweibin/nginx_upstream_check_module</span><br><span class="line">taobao官网：http://tengine.taobao.org/document_cn/http_upstream_check_cn.html</span><br></pre></td></tr></table></figure>


<p>安装nginx_upstream_check_module </p>
<p>安装扩展模块，需要编译安装的nginx，版本自己选择</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">获取安装包</span></span><br><span class="line">wget https://codeload.github.com/yaoweibin/nginx_upstream_check_module/zip/master</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">给nginx打补丁</span></span><br><span class="line">unzip master</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">进入nginx-1.16.1，进行打该模块的补丁</span></span><br><span class="line">yum install patch-2.7.1-12.el7_7.x86_64 -y</span><br><span class="line">patch -p1 &lt; ../nginx_upstream_check_module-master/check_1.16.1+.patch</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">编译安装</span></span><br><span class="line">./configure --prefix=/usr/local/nginx --add-module=/usr/local/nginx_upstream_check_module-master/</span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">make upgrade</span><br><span class="line"></span><br><span class="line">[root@service nginx]# ./sbin/nginx -V</span><br><span class="line">nginx version: nginx/1.16.1</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) </span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --add-module=/usr/local/nginx_upstream_check_module-master/</span><br></pre></td></tr></table></figure>

<p>服务治理的一个重要任务是感知服务节点变更，完成服务自动注册及异常节点的自动摘除。这就需要服务治理平台能够：<code>及时</code>、<code>准确</code>的感知service节点的健康状况。</p>
<p>Nginx 提供了三种HTTP服务健康检查方案供用户选择：</p>
<ol>
<li>TCP层默认检查方案：<br>定时与后端服务建立一条<code>tcp连接</code>，链接建立成功则认为服务节点是健康的。</li>
<li>HTTP层默认检查方案：<br>TCP层检查有一定的局限性：<ol>
<li>很多HTTP服务是带状态的，端口处于listen状态并不能代表服务已经完成预热；</li>
<li>不能真实反映服务内部处理逻辑是否产生拥堵。</li>
<li>这时可以选择<code>http层</code>健康检查，会向服务发送一个http请求<code>GET / HTTP/1.0\r\n\r\n</code>，返回状态是2xx或3xx时认为后端服务正常。</li>
</ol>
</li>
<li>自定义方案：（nginx_upstream_check_module模块）<br>可根据下文描述自定义检查方案。</li>
</ol>
<h4 id="指令"><a href="#指令" class="headerlink" title="指令"></a>指令</h4><blockquote>
<p>Syntax: <strong>check</strong> <code>interval=milliseconds [fall=count] [rise=count] [timeout=milliseconds] [default_down=true|false] [type=tcp|http|ssl_hello|mysql|ajp] [port=check_port]</code><br>Default: 如果没有配置参数，默认值是：<code>interval=30000 fall=5 rise=2 timeout=1000 default_down=true type=tcp</code><br>Context: <code>upstream</code></p>
</blockquote>
<p>指令后面的参数意义是：</p>
<ul>
<li><code>interval</code>：向后端发送的健康检查包的间隔。</li>
<li><code>fall</code>(fall_count): 如果连续失败次数达到fall_count，服务器就被认为是down。</li>
<li><code>rise</code>(rise_count): 如果连续成功次数达到rise_count，服务器就被认为是up。</li>
<li><code>timeout</code>: 后端健康请求的超时时间。</li>
<li><code>default_down</code>: 设定初始时服务器的状态，如果是true，就说明默认是down的，如果是false，就是up的。默认值是true，也就是一开始服务器认为是不可用，要等健康检查包达到一定成功次数以后才会被认为是健康的。</li>
<li><code>type</code>：健康检查包的类型，现在支持以下多种类型<ul>
<li><code>tcp</code>：简单的tcp连接，如果连接成功，就说明后端正常。</li>
<li><code>ssl_hello</code>：发送一个初始的SSL hello包并接受服务器的SSL hello包。</li>
<li><code>http</code>：发送HTTP请求，通过后端的回复包的状态来判断后端是否存活。</li>
<li><code>mysql</code>: 向mysql服务器连接，通过接收服务器的greeting包来判断后端是否存活。</li>
<li><code>ajp</code>：向后端发送AJP协议的Cping包，通过接收Cpong包来判断后端是否存活。</li>
</ul>
</li>
<li><code>port</code>: 指定后端服务器的检查端口。你可以指定不同于真实服务的后端服务器的端口，比如后端提供的是443端口的应用，你可以去检查80端口的状态来判断后端健康状况。默认是0，表示跟后端server提供真实服务的端口一样。该选项出现于Tengine-1.4.0。</li>
</ul>
<blockquote>
<p>Syntax: <strong>check_http_expect_alive</strong> <code>[ http_2xx | http_3xx | http_4xx | http_5xx ]</code><br>Default: <code>http_2xx | http_3xx</code><br>Context: <code>upstream</code></p>
</blockquote>
<p>该指令指定HTTP回复的成功状态，默认认为2XX和3XX的状态是健康的。</p>
<blockquote>
<p>Syntax: <strong>check_http_send</strong> <code>http_packet</code><br>Default: <code>&quot;GET / HTTP/1.0\r\n\r\n&quot;</code><br>Context: <code>upstream</code></p>
</blockquote>
<p>该指令可以配置http健康检查包发送的请求内容。为了减少传输数据量，推荐采用<code>&quot;HEAD&quot;</code>方法。</p>
<p>当采用长连接进行健康检查时，需在该指令中添加keep-alive请求头，如：<code>&quot;HEAD / HTTP/1.1\r\nConnection: keep-alive\r\n\r\n&quot;</code>。<br>同时，在采用<code>&quot;GET&quot;</code>方法的情况下，请求uri的size不宜过大，确保可以在1个<code>interval</code>内传输完成，否则会被健康检查模块视为后端服务器或网络异常。</p>
<p>完整参数配置:<br><a href="http://tengine.taobao.org/document_cn/http_upstream_check_cn.html" target="_blank" rel="noopener">http://tengine.taobao.org/document_cn/http_upstream_check_cn.html</a></p>
<p>官方示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">upstream</span> cluster1 &#123;</span><br><span class="line">        <span class="comment"># simple round-robin</span></span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.0.1:80</span>;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.0.2:80</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">check</span> interval=<span class="number">3000</span> rise=<span class="number">2</span> fall=<span class="number">5</span> timeout=<span class="number">1000</span> type=http;</span><br><span class="line">        <span class="attribute">check_http_send</span> <span class="string">"HEAD / HTTP/1.0\r\n\r\n"</span>;</span><br><span class="line">        <span class="attribute">check_http_expect_alive</span> http_2xx http_3xx;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">upstream</span> cluster2 &#123;</span><br><span class="line">        <span class="comment"># simple round-robin</span></span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.0.3:80</span>;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.0.4:80</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">check</span> interval=<span class="number">3000</span> rise=<span class="number">2</span> fall=<span class="number">5</span> timeout=<span class="number">1000</span> type=http;</span><br><span class="line">        <span class="attribute">check_keepalive_requests</span> <span class="number">100</span>;</span><br><span class="line">        <span class="attribute">check_http_send</span> <span class="string">"HEAD / HTTP/1.1\r\nConnection: keep-alive\r\n\r\n"</span>;</span><br><span class="line">        <span class="attribute">check_http_expect_alive</span> http_2xx http_3xx;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> /<span class="number">1</span> &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://cluster1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> /<span class="number">2</span> &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://cluster2;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> /status &#123;</span><br><span class="line">            check_status;</span><br><span class="line"></span><br><span class="line">            <span class="attribute">access_log</span>   <span class="literal">off</span>;</span><br><span class="line">            <span class="attribute">allow</span> SOME.IP.ADD.RESS;</span><br><span class="line">            <span class="attribute">deny</span> all;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用demo:</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">upstream apiservice&#123;</span><br><span class="line">    server <span class="number">192.168.50.55:8087</span>;</span><br><span class="line"></span><br><span class="line">    #对http主动检测，2XX,3XX为up,4XX,5xx为down</span><br><span class="line">    check interval=<span class="number">3000</span> rise=<span class="number">2</span> fall=<span class="number">5</span> timeout=<span class="number">1000</span> type=http;</span><br><span class="line">    check_http_send <span class="string">"<span class="keyword">HEAD</span> /health/check HTTP/1.0\r\n\r\n"</span>;</span><br><span class="line">    check_http_expect_alive http_2xx http_3xx;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       <span class="number">80</span>;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    #charset koi8-r;</span><br><span class="line"></span><br><span class="line">    #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">    location /check-status &#123;</span><br><span class="line">    check_status;</span><br><span class="line">    &#125;</span><br><span class="line">    location /doctor-api/ &#123;</span><br><span class="line">            proxy_pass http://apiservice;</span><br><span class="line">            proxy_set_header   Host    $host;</span><br><span class="line">            proxy_set_header   X-Real-IP   $remote_addr;</span><br><span class="line">            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">            proxy_set_header   X-Forwarded-Proto $scheme;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>访问健康检测的页面<br><img src="/image/check_up.png" alt="check_up"><br>可看到服务为up,把服务下线后再次查看<br><img src="/image/check_down.png" alt="check_down"><br>服务为down,此时后端服务已下线</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server number是后端服务器的数量</span><br><span class="line">Index是服务器的索引 </span><br><span class="line">Upstream是在配置中upstream的名称 </span><br><span class="line">Name是服务器IP </span><br><span class="line">Status是服务器的状态 </span><br><span class="line">Rise counts是服务器连续检查成功的次数 </span><br><span class="line">Fall counts是连续检查失败的次数 </span><br><span class="line">Check type是检查的方式 </span><br><span class="line">Check port是后端专门为健康检查设置的端口</span><br></pre></td></tr></table></figure>

<h4 id="四层负载均衡"><a href="#四层负载均衡" class="headerlink" title="四层负载均衡"></a>四层负载均衡</h4><p>七层负载均衡：只识别域名，是http层。</p>
<p>四层负载均衡：不识别域名，是tcp层，类似于端口转发。</p>
<p>可用于ftp,sftp,database等端口的转发</p>
<p>查看当前模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@service nginx]# ./sbin/nginx -V</span><br><span class="line">nginx version: nginx/1.16.1</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) </span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --add-module=/usr/local/nginx_upstream_check_module-master/</span><br></pre></td></tr></table></figure>

<p>进入源码目录,重新编译</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/nginx-1.16.1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">在当前模块命令后添加--with-stream</span></span><br><span class="line">./configure --prefix=/usr/local/nginx --add-module=/usr/local/nginx_upstream_check_module-master/ --with-stream</span><br><span class="line"></span><br><span class="line">make &amp; make install</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">再次查看添加模块是否成功</span></span><br><span class="line">[root@service nginx]# ./sbin/nginx -V</span><br><span class="line">nginx version: nginx/1.16.1</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) </span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --add-module=/usr/local/nginx_upstream_check_module-master/ --with-stream</span><br></pre></td></tr></table></figure>

<p>示例配置:<br>stream段的配置要与http段在同级</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">	···</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">stream</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">upstream</span> mysql &#123;</span><br><span class="line">       <span class="attribute">server</span> <span class="number">192.168.50.51:3306</span> max_fails=<span class="number">2</span> fail_timeout=<span class="number">120s</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">3307</span>;</span><br><span class="line">        <span class="attribute">proxy_connect_timeout</span> <span class="number">10s</span>;</span><br><span class="line">        <span class="attribute">proxy_timeout</span> <span class="number">300s</span>;<span class="comment">#设置客户端和代理服务之间的超时时间，如果5分钟内没操作将自动断开。</span></span><br><span class="line">        <span class="attribute">proxy_pass</span> mysql;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试连接是否正常<br><img src="/image/teststream.png" alt="teststream"></p>
<h4 id="nginx增加kafka模块"><a href="#nginx增加kafka模块" class="headerlink" title="nginx增加kafka模块"></a>nginx增加kafka模块</h4><p>模块地址</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/brg-liuwei/</span>ngx_kafka_module<span class="regexp">/tree/m</span>aster</span><br></pre></td></tr></table></figure>

<p>下载源码</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="comment">//nginx.org/download/nginx-1.20.1.tar.gz</span></span><br><span class="line">tar -zxvf  nginx-<span class="number">1.20</span>.<span class="number">1</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line">cd nginx-<span class="number">1.20</span>.<span class="number">1</span>/</span><br></pre></td></tr></table></figure>

<p>配置编译使用的模块</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure  <span class="attr">--prefix=/usr/share/nginx</span> <span class="attr">--sbin-path=/usr/sbin/nginx</span> <span class="attr">--modules-path=/usr/lib64/nginx/modules</span> <span class="attr">--conf-path=/etc/nginx/nginx.conf</span> <span class="attr">--error-log-path=/var/log/nginx/error.log</span> <span class="attr">--http-log-path=/var/log/nginx/access.log</span> <span class="attr">--http-client-body-temp-path=/var/lib/nginx/tmp/client_body</span> <span class="attr">--http-proxy-temp-path=/var/lib/nginx/tmp/proxy</span> <span class="attr">--http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi</span> <span class="attr">--http-uwsgi-temp-path=/var/lib/nginx/tmp/uwsgi</span> <span class="attr">--http-scgi-temp-path=/var/lib/nginx/tmp/scgi</span> <span class="attr">--pid-path=/run/nginx.pid</span> <span class="attr">--lock-path=/run/lock/subsys/nginx</span> <span class="attr">--user=nginx</span> <span class="attr">--group=nginx</span> --<span class="keyword">with</span>-file-aio --<span class="keyword">with</span>-ipv6 --<span class="keyword">with</span>-http_auth_request_module --<span class="keyword">with</span>-http_ssl_module --<span class="keyword">with</span>-http_v2_module --<span class="keyword">with</span>-http_realip_module --<span class="keyword">with</span>-http_addition_module <span class="attr">--with-http_xslt_module=dynamic</span> <span class="attr">--with-http_image_filter_module=dynamic</span> <span class="attr">--with-http_geoip_module=dynamic</span> --<span class="keyword">with</span>-http_sub_module --<span class="keyword">with</span>-http_dav_module --<span class="keyword">with</span>-http_flv_module --<span class="keyword">with</span>-http_mp4_module --<span class="keyword">with</span>-http_gunzip_module --<span class="keyword">with</span>-http_gzip_static_module --<span class="keyword">with</span>-http_random_index_module --<span class="keyword">with</span>-http_secure_link_module --<span class="keyword">with</span>-http_degradation_module --<span class="keyword">with</span>-http_slice_module --<span class="keyword">with</span>-http_stub_status_module <span class="attr">--with-http_perl_module=dynamic</span> <span class="attr">--with-mail=dynamic</span> --<span class="keyword">with</span>-mail_ssl_module --<span class="keyword">with</span>-pcre --<span class="keyword">with</span>-pcre-jit <span class="attr">--with-stream=dynamic</span> --<span class="keyword">with</span>-stream_ssl_module --<span class="keyword">with</span>-google_perftools_module --<span class="keyword">with</span>-debug <span class="attr">--with-cc-opt='-O2</span> -g -pipe -Wall -Wp,<span class="attr">-D_FORTIFY_SOURCE=2</span> -fexceptions -fstack-protector-strong <span class="attr">--param=ssp-buffer-size=4</span> -grecord-gcc-switches <span class="attr">-specs=/usr/lib/rpm/redhat/redhat-hardened-cc1</span> -m64 <span class="attr">-mtune=generic'</span> <span class="attr">--with-ld-opt='-Wl,-z,relro</span> <span class="attr">-specs=/usr/lib/rpm/redhat/redhat-hardened-ld</span> -Wl,-E' --<span class="keyword">with</span>-compat --<span class="keyword">with</span>-stream_ssl_preread_module --<span class="keyword">with</span>-threads <span class="attr">--add-dynamic-module=/root/ngx_kafka_module</span></span><br></pre></td></tr></table></figure>

<p>编译</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">make</span></span><br></pre></td></tr></table></figure>

<p>此处不进行install安装</p>
<p>进入编译的目录</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> objs</span><br><span class="line">[root@idt01 objs]# ./nginx -<span class="keyword">c</span> /etc/nginx/nginx.<span class="keyword">conf</span> -t</span><br><span class="line">nginx: [emerg] module <span class="string">"/usr/lib64/nginx/modules/ngx_http_image_filter_module.so"</span> <span class="keyword">is</span> not binary compatible in /usr/share/nginx/modules/<span class="keyword">mod</span>-http-image-<span class="built_in">filter</span>.<span class="keyword">conf</span>:<span class="number">1</span></span><br><span class="line">nginx: configuration <span class="keyword">file</span> /etc/nginx/nginx.<span class="keyword">conf</span> test failed</span><br></pre></td></tr></table></figure>

<p>拷贝so文件到原目录进行加载</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp *.so <span class="regexp">/usr/</span>lib64<span class="regexp">/nginx/m</span>odules<span class="regexp">/</span></span><br></pre></td></tr></table></figure>

<p>再次测试</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">the <span class="string">"ssl"</span> directive <span class="keyword">is</span> deprecated, <span class="keyword">use</span> the <span class="string">"listen ... ssl"</span> directive instead</span><br></pre></td></tr></table></figure>

<p>注释配置文件中的ssl on；同时在listen 443; 后面加上 ssl</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute"><span class="nomarkup">listen</span></span> 443  ssl;</span><br><span class="line"><span class="comment">#ssl on;</span></span><br></pre></td></tr></table></figure>

<p>再次测试</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">version</span> 1<span class="selector-class">.20</span><span class="selector-class">.1</span> <span class="selector-tag">of</span> <span class="selector-tag">nginx</span><span class="selector-class">.pm</span> <span class="selector-tag">is</span> <span class="selector-tag">required</span>, <span class="selector-tag">but</span> 1<span class="selector-class">.12</span><span class="selector-class">.2</span> <span class="selector-tag">was</span> <span class="selector-tag">found</span></span><br></pre></td></tr></table></figure>

<p>find nginx.pm发现，这个perl文件，在make install的时候，也会安装，如果不指定安装目录，这个文件会默认安装到/usr/local/lib64/perl5/nginx.pm。<br>而nginx.pm里面记录了nginx的版本号。所以，如果启动nginx的时候，运行的nginx与nginx.pm版本号不一致就有问题</p>
<p>在测试的机器进行上述操作并进行install安装,把perl5下载到本服务器,把本地的目录进行备份,使用下载的perl5文件夹</p>
<p>再次测试</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@idt01 objs]# nginx -t</span><br><span class="line">nginx: the configuration <span class="keyword">file</span> /etc/nginx/nginx.<span class="keyword">conf</span> <span class="keyword">syntax</span> <span class="keyword">is</span> ok</span><br><span class="line">nginx: configuration <span class="keyword">file</span> /etc/nginx/nginx.<span class="keyword">conf</span> test <span class="keyword">is</span> successful</span><br></pre></td></tr></table></figure>

<p>./configure: error: C compiler cc is not found</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">yum</span> <span class="literal">-</span><span class="comment">y</span> <span class="comment">install</span> <span class="comment">gcc</span> <span class="comment">gcc</span><span class="literal">-</span><span class="comment">c</span><span class="literal">+</span><span class="literal">+</span> <span class="comment">autoconf</span> <span class="comment">automake</span> <span class="comment">make</span></span><br></pre></td></tr></table></figure>

<p>./configure: error: the invalid value in –with-ld-opt=”-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-E”</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y <span class="keyword">install </span>redhat-rpm-<span class="built_in">config</span>.noarch</span><br></pre></td></tr></table></figure>

<p>./configure: error: the HTTP rewrite module requires the PCRE library.</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y <span class="keyword">install</span> pcre-devel</span><br></pre></td></tr></table></figure>

<p>./configure: error: SSL modules require the OpenSSL library.</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y <span class="keyword">install</span> openssl openssl-devel</span><br></pre></td></tr></table></figure>

<p>./configure: error: the HTTP XSLT module requires the libxml2/libxslt</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y <span class="keyword">install</span> libxml2 libxml2-dev libxslt-devel</span><br></pre></td></tr></table></figure>

<p>./configure: error: the HTTP image filter module requires the GD library.</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y <span class="keyword">install</span> gd-devel</span><br></pre></td></tr></table></figure>

<p>./configure: error: perl module ExtUtils::Embed is required</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -<span class="keyword">y</span> install <span class="keyword">perl</span>-devel <span class="keyword">perl</span>-ExtUtils-Embed</span><br></pre></td></tr></table></figure>

<p>./configure: error: the GeoIP module requires the GeoIP library.</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">yum</span> -y install <span class="type">GeoIP</span> <span class="type">GeoIP</span>-devel <span class="type">GeoIP</span>-<span class="class"><span class="keyword">data</span></span></span><br></pre></td></tr></table></figure>

<p>./configure: error: the Google perftools module requires the Google perftools</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y <span class="keyword">install</span> gperftools</span><br></pre></td></tr></table></figure>

<p>[root@rancher modules]# nginx -t<br>nginx: [emerg] dlopen() “/usr/lib64/nginx/modules/ngx_http_kafka_module.so” failed (librdkafka.so.1: cannot open shared object file: No such file or directory) in /usr/share/nginx/modules/mod-kafka.conf:1</p>
<p><a href="https://www.jianshu.com/p/635e8cde4cbc" target="_blank" rel="noopener">https://www.jianshu.com/p/635e8cde4cbc</a></p>
<p>参考文档:<br><a href="https://blog.csdn.net/stormwolf/article/details/123371698" target="_blank" rel="noopener">https://blog.csdn.net/stormwolf/article/details/123371698</a></p>
<p><a href="http://t.zoukankan.com/damon-blogs-p-14158831.html" target="_blank" rel="noopener">http://t.zoukankan.com/damon-blogs-p-14158831.html</a></p>
<p><a href="https://blog.csdn.net/sayyy/article/details/121179039?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~aggregatepage~first_rank_ecpm_v1~rank_v31_ecpm-6-121179039-null-null.pc_agg_new_rank&amp;utm_term=nginx%E6%B7%BB%E5%8A%A0%E6%A8%A1%E5%9D%97stream&amp;spm=1000.2123.3001.4430" target="_blank" rel="noopener">https://blog.csdn.net/sayyy/article/details/121179039?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~aggregatepage~first_rank_ecpm_v1~rank_v31_ecpm-6-121179039-null-null.pc_agg_new_rank&amp;utm_term=nginx%E6%B7%BB%E5%8A%A0%E6%A8%A1%E5%9D%97stream&amp;spm=1000.2123.3001.4430</a></p>
<p>为了使 Nginx 配置更易于维护，建议为每个服务创建一个单独的配置文件，存储在 /usr/local/nginx/website 目录，根据需求可以创建任意多个独立的配置文件。</p>
<p>独立的配置文件，建议遵循以下命名约定 &lt;域名&gt;.conf，比如域名是 nmk0718.com，那么你的配置文件的应该是这样的 /usr/local/nginx/website/<a href="http://www.nmk0718.com.conf,把location单独抽出放在/usr/local/nginx/include/www.nmk0718.com.conf中进行存储.再通过include进行引用" target="_blank" rel="noopener">www.nmk0718.com.conf,把location单独抽出放在/usr/local/nginx/include/www.nmk0718.com.conf中进行存储.再通过include进行引用</a><br>新增服务时,只需更改include中的配置文件机即可</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@deployment nginx]# ll conf/website/</span><br><span class="line">-rw-r--r--. 1 root root   416 Jun 10  2021 dev.nmk0718.com.conf</span><br><span class="line">-rw-r--r--. 1 root root  7189 Mar 10 15:19 test.nmk0718.com.conf</span><br><span class="line">[root@deployment nginx]# ll conf/include/</span><br><span class="line">-rw-r--r--. 1 root root 13398 Mar 14 17:38 dev.nmk0718.com.conf</span><br><span class="line">-rw-r--r--. 1 root root 14987 Feb 22 15:01 test.nmk0718.com.conf</span><br></pre></td></tr></table></figure>

<p>Nginx 日志相关目录，内以 域名.type.log 命名（比如<a href="http://www.nmk0718.com.access.log" target="_blank" rel="noopener">www.nmk0718.com.access.log</a> 和<a href="http://www.nmk0718.com.error.log" target="_blank" rel="noopener">www.nmk0718.com.error.log</a> ）位于 /usr/local/nginx/log/ 目录中，为每个独立的服务配置不同的访问权限和错误日志文件，这样查找错误时，会更加方便快捷。</p>
<p>参考文档:<br><a href="https://blog.csdn.net/Janson_Lin/article/details/105954705" target="_blank" rel="noopener">https://blog.csdn.net/Janson_Lin/article/details/105954705</a><br><a href="https://www.cnblogs.com/cheyunhua/p/14011800.html" target="_blank" rel="noopener">https://www.cnblogs.com/cheyunhua/p/14011800.html</a><br><a href="https://www.cnblogs.com/cuishuai/p/8073748.html" target="_blank" rel="noopener">https://www.cnblogs.com/cuishuai/p/8073748.html</a><br><a href="https://blog.csdn.net/zhanghui200920061988/article/details/105132167" target="_blank" rel="noopener">https://blog.csdn.net/zhanghui200920061988/article/details/105132167</a></p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>nmk</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://nmk0718.github.io/2020/07/16/nginx/">http://nmk0718.github.io/2020/07/16/nginx/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2020 <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tag/nginx/"># nginx</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2020/07/30/elasticsearch/">elasticsearch</a>
            
            
            <a class="next" rel="next" href="/2020/07/01/Rocketchat/">Rocketchat</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© nmk | Powered by <a href="https://hexo.io" target="_blank">Hexo</a></span>
	</div>
</footer>

    </div>
</body>
</html>
