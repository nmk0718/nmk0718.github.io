<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">



<title>elasticsearch | K&#39;s Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 4.2.0"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">nimingkun&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">nimingkun&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">elasticsearch</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">nmk</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2020-7-30&nbsp;&nbsp;22:55:00</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/category/tools/">tools</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h3 id="elasticsearch集群搭建"><a href="#elasticsearch集群搭建" class="headerlink" title="elasticsearch集群搭建"></a>elasticsearch集群搭建</h3><p>通过filebeat采集日志传给logstash,logstash传给elasticsearch</p>
<p>elasticsearch下载:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;mirrors.huaweicloud.com&#x2F;elasticsearch&#x2F;7.8.0&#x2F;elasticsearch-7.8.0-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>

<p>拷贝到安装目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp elasticsearch-7.8.0-linux-x86_64.tar.gz &#x2F;opt&#x2F;es</span><br></pre></td></tr></table></figure>

<p>解压:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;es</span><br><span class="line">tar -zxvf elasticsearch-7.8.0-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>

<p>修改配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim elasticsearch-7.8.0&#x2F;config&#x2F;elasticsearch.yml</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>cluster.name</strong>: 集群名称,集群名称用于跟其他相同名字的节点构成整个集群.</li>
<li><strong>node.name</strong>: 节点名称, 是该elasticsearch实例的唯一标识</li>
<li><strong>path.data</strong>: 数据路径,指定文档，索引存放的位置。</li>
<li><strong>path.logs</strong>:日志路径，指定运行日志的存放目录</li>
<li><strong>network.host</strong>: 绑定地址</li>
<li><strong>http.port</strong>: http端口,默认9200</li>
<li><strong>discovery.seed_hosts</strong>: 集群主机列表</li>
<li><strong>cluster.initial_master_nodes</strong>: 初始化一个新的集群时选举master(第一个启动为master)</li>
<li><strong>http.cors.enabled</strong>: 是否支持跨域,是：true，在使用head插件时需要此配置</li>
<li><strong>node.master</strong>: 是否是master节点</li>
</ul>
<p>配置如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"># &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; Elasticsearch Configuration &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">#</span><br><span class="line"># NOTE: Elasticsearch comes with reasonable defaults for most settings.</span><br><span class="line">#       Before you set out to tweak and tune the configuration, make sure you</span><br><span class="line">#       understand what are you trying to accomplish and the consequences.</span><br><span class="line">#</span><br><span class="line"># The primary way of configuring a node is via this file. This template lists</span><br><span class="line"># the most important settings you may want to configure for a production cluster.</span><br><span class="line">#</span><br><span class="line"># Please consult the documentation for further information on configuration options:</span><br><span class="line"># https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;elasticsearch&#x2F;reference&#x2F;index.html</span><br><span class="line">#</span><br><span class="line"># ---------------------------------- Cluster -----------------------------------</span><br><span class="line">#</span><br><span class="line"># Use a descriptive name for your cluster:</span><br><span class="line">#</span><br><span class="line">cluster.name: gzlp-elasticsearch</span><br><span class="line">#</span><br><span class="line"># ------------------------------------ Node ------------------------------------</span><br><span class="line">#</span><br><span class="line"># Use a descriptive name for the node:</span><br><span class="line">#</span><br><span class="line">node.name: node-100</span><br><span class="line">#</span><br><span class="line"># Add custom attributes to the node:</span><br><span class="line">#</span><br><span class="line">#node.attr.rack: r1</span><br><span class="line">#</span><br><span class="line"># ----------------------------------- Paths ------------------------------------</span><br><span class="line">#</span><br><span class="line"># Path to directory where to store the data (separate multiple locations by comma):</span><br><span class="line">#</span><br><span class="line">path.data: &#x2F;home&#x2F;elasticsearch&#x2F;data</span><br><span class="line">#</span><br><span class="line"># Path to log files:</span><br><span class="line">#</span><br><span class="line">path.logs: &#x2F;home&#x2F;elasticsearch&#x2F;logs</span><br><span class="line">#</span><br><span class="line"># ----------------------------------- Memory -----------------------------------</span><br><span class="line">#</span><br><span class="line"># Lock the memory on startup:</span><br><span class="line">#</span><br><span class="line">#bootstrap.memory_lock: true</span><br><span class="line">#</span><br><span class="line"># Make sure that the heap size is set to about half the memory available</span><br><span class="line"># on the system and that the owner of the process is allowed to use this</span><br><span class="line"># limit.</span><br><span class="line">#</span><br><span class="line"># Elasticsearch performs poorly when the system is swapping the memory.</span><br><span class="line">#</span><br><span class="line"># ---------------------------------- Network -----------------------------------</span><br><span class="line">#</span><br><span class="line"># Set the bind address to a specific IP (IPv4 or IPv6):</span><br><span class="line">#</span><br><span class="line">network.host: 172.17.53.225</span><br><span class="line">#</span><br><span class="line"># Set a custom port for HTTP:</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">http.port: 9100</span><br><span class="line">#</span><br><span class="line"># For more information, consult the network module documentation.</span><br><span class="line">#</span><br><span class="line"># --------------------------------- Discovery ----------------------------------</span><br><span class="line">#</span><br><span class="line"># Pass an initial list of hosts to perform discovery when this node is started:</span><br><span class="line"># The default list of hosts is [&quot;127.0.0.1&quot;, &quot;[::1]&quot;]</span><br><span class="line">#</span><br><span class="line">discovery.seed_hosts: [&quot;172.17.53.225:9300&quot;,&quot;172.17.53.226:9300&quot;,&quot;172.17.53.227:9300&quot;]</span><br><span class="line">#ES7.x前使用discovery.zen.ping.unicast.hosts: [&quot;192.168.1.130&quot;, &quot;192.168.1.134&quot;] </span><br><span class="line">#</span><br><span class="line"># Bootstrap the cluster using an initial set of master-eligible nodes:</span><br><span class="line">#</span><br><span class="line">cluster.initial_master_nodes: [&quot;node-100&quot;, &quot;node-101&quot;,&quot;node-102&quot;]</span><br><span class="line">#</span><br><span class="line"># For more information, consult the discovery and cluster formation module documentation.</span><br><span class="line">#</span><br><span class="line"># ---------------------------------- Gateway -----------------------------------</span><br><span class="line">#</span><br><span class="line"># Block initial recovery after a full cluster restart until N nodes are started:</span><br><span class="line">#</span><br><span class="line">#gateway.recover_after_nodes: 3</span><br><span class="line">#</span><br><span class="line"># For more information, consult the gateway module documentation.</span><br><span class="line">#</span><br><span class="line"># ---------------------------------- Various -----------------------------------</span><br><span class="line">#</span><br><span class="line"># Require explicit names when deleting indices:</span><br><span class="line">#</span><br><span class="line">#action.destructive_requires_name: true</span><br><span class="line">http.cors.enabled: true</span><br><span class="line">#</span><br><span class="line">node.master: true</span><br></pre></td></tr></table></figure>

<p>⚠️注意discovery.seed_hosts处为集群交互端口,默认为9300,如需更改请把下面参数加入配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#TCP的默认监听端口，默认 9300</span><br><span class="line">transport.tcp.port: 9300</span><br></pre></td></tr></table></figure>

<p>配置完成后，将整个文件copy到另外两个机器</p>
<p>Elasticsearch不允许使用root账号启动，因此需要建一个专用的账号。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adduser es</span><br><span class="line">passwd gzlp</span><br><span class="line">chown -R es .&#x2F;elasticsearch-7.8.0</span><br></pre></td></tr></table></figure>

<p>修改数据路径和日志路径的权限:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chown -R es &#x2F;home&#x2F;elasticsearch&#x2F;data</span><br><span class="line">chown -R es &#x2F;home&#x2F;elasticsearch&#x2F;logs</span><br></pre></td></tr></table></figure>

<p>增加插件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;medcl&#x2F;elasticsearch-analysis-ik&#x2F;releases</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;medcl&#x2F;elasticsearch-analysis-pinyin&#x2F;releases</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;medcl&#x2F;elasticsearch-analysis-stconvert&#x2F;releases</span><br><span class="line">下载es版本一致的包,解压.移动到elasticsearch-7.8.0&#x2F;plugins里</span><br><span class="line">重命名elasticsearch-analysis-ik为ik</span><br><span class="line">重命名elasticsearch-analysis-pinyin为pinyin</span><br><span class="line">重命名elasticsearch-analysis-stconvert为stconvert</span><br></pre></td></tr></table></figure>

<p>修改配置sysctl.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;etc&#x2F;sysctl.conf</span><br></pre></td></tr></table></figure>

<p>添加配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c</span><br></pre></td></tr></table></figure>

<p>执行命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<p>启动elasticsearch</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#后台启动</span><br><span class="line">.&#x2F;elasticsearch -d</span><br></pre></td></tr></table></figure>

<p>验证是否启动成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;172.17.53.255:9100</span><br></pre></td></tr></table></figure>

<p>验证是否为集群</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;172.17.53.255:9100&#x2F;_cluster&#x2F;stats?pretty</span><br></pre></td></tr></table></figure>

<p>验证是否为主节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;172.17.53.226:9200&#x2F;_cat&#x2F;nodes?v</span><br><span class="line"></span><br><span class="line">#带*星号表明该节点是主节点。带-表明该节点是从节点。</span><br><span class="line">#另外还是heap.percent堆内存使用情况，ram.percent运行内存使用情况，cpu使用情况。</span><br><span class="line"></span><br><span class="line">ip            heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name</span><br><span class="line">172.17.53.227           61          78   0    0.04    0.30     0.38 dimr      *      node-3</span><br><span class="line">172.17.53.226           69          90   1    0.21    0.84     1.03 dimr      -      node-2</span><br><span class="line">172.17.53.225           34          92   1    0.20    0.32     0.18 dimr      -      node-1</span><br></pre></td></tr></table></figure>



<h5 id="安装可视化工具"><a href="#安装可视化工具" class="headerlink" title="安装可视化工具"></a>安装可视化工具</h5><p>下载cerebro</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;lmenezes&#x2F;cerebro&#x2F;releases&#x2F;download&#x2F;v0.9.2&#x2F;cerebro-0.9.2.tgz</span><br></pre></td></tr></table></figure>

<p>解压</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf cerebro-0.9.2.tgz</span><br></pre></td></tr></table></figure>

<p>修改配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim cerebro-0.9.2&#x2F;conf&#x2F;application.conf</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>basePath</strong>: 定义访问路径 默认为/</li>
<li><strong>pidfile.path</strong>: pid路径</li>
<li><strong>data.path</strong>: 数据存放位置</li>
<li><strong>server.http.port</strong>: 访问端口 默认为9000</li>
<li><strong>network.host</strong>: 绑定地址</li>
<li><strong>username</strong>: 登录用户名</li>
<li><strong>password</strong>: 登录密码</li>
<li><strong>host</strong>: es集群地址</li>
<li><strong>name</strong>: 标识 一般用ES的cluster_name</li>
</ul>
<p>示例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"># Secret will be used to sign session cookies, CSRF tokens and for other encryption utilities.</span><br><span class="line"># It is highly recommended to change this value before running cerebro in production.</span><br><span class="line">secret &#x3D; &quot;ki:s:[[@&#x3D;Ag?QI&#96;W2jMwkY:eqvrJ]JqoJyi2axj3ZvOv^&#x2F;KavOT4ViJSv?6YY4[N&quot;</span><br><span class="line"></span><br><span class="line"># Application base path</span><br><span class="line">basePath &#x3D; &quot;&#x2F;cerebro&#x2F;&quot;</span><br><span class="line"></span><br><span class="line"># Defaults to RUNNING_PID at the root directory of the app.</span><br><span class="line"># To avoid creating a PID file set this value to &#x2F;dev&#x2F;null</span><br><span class="line">#pidfile.path &#x3D; &quot;&#x2F;var&#x2F;run&#x2F;cerebro.pid&quot;</span><br><span class="line">pidfile.path&#x3D;&#x2F;dev&#x2F;null</span><br><span class="line"></span><br><span class="line"># Rest request history max size per user</span><br><span class="line">rest.history.size &#x3D; 50 &#x2F;&#x2F; defaults to 50 if not specified</span><br><span class="line"></span><br><span class="line"># Path of local database file</span><br><span class="line">#data.path: &quot;&#x2F;var&#x2F;lib&#x2F;cerebro&#x2F;cerebro.db&quot;</span><br><span class="line">data.path &#x3D; &quot;.&#x2F;cerebro.db&quot;</span><br><span class="line"></span><br><span class="line">play &#123;</span><br><span class="line">  # Cerebro port, by default it&#39;s 9000 (play&#39;s default)</span><br><span class="line">  server.http.port &#x3D; $&#123;?CEREBRO_PORT&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">es &#x3D; &#123;</span><br><span class="line">  gzip &#x3D; true</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Authentication</span><br><span class="line">auth &#x3D; &#123;</span><br><span class="line">  # either basic or ldap</span><br><span class="line">  type: basic</span><br><span class="line">  settings: &#123;</span><br><span class="line">    # Basic auth</span><br><span class="line">    username &#x3D; &quot;gzlp&quot;</span><br><span class="line">    password &#x3D; &quot;gzlplink&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># A list of known hosts</span><br><span class="line">hosts &#x3D; [</span><br><span class="line">					&#123; </span><br><span class="line">							host &#x3D; &quot;http:&#x2F;&#x2F;172.17.53.225:9100&quot;</span><br><span class="line">							name &#x3D; &quot;gzlp-elasticsearch&quot;</span><br><span class="line">		&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>启动cerebro</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#后台启动</span><br><span class="line">nohup .&#x2F;bin&#x2F;cerebro &amp;</span><br></pre></td></tr></table></figure>

<h5 id="安装Logstash"><a href="#安装Logstash" class="headerlink" title="安装Logstash"></a>安装Logstash</h5><p>下载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;mirrors.huaweicloud.com&#x2F;logstash&#x2F;7.8.0&#x2F;logstash-7.8.0.tar.gz</span><br></pre></td></tr></table></figure>

<p>解压</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf logstash-7.8.0.tar.gz</span><br></pre></td></tr></table></figure>

<p>配置logstash.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http.host: &quot;192.168.30.129&quot;</span><br><span class="line">http.port: 9600</span><br></pre></td></tr></table></figure>

<p>在bin目录下创建logstash.conf配置索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line">#&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; input &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">input &#123;</span><br><span class="line"> beats &#123;</span><br><span class="line">   port &#x3D;&gt; 5044</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; output &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">output &#123;</span><br><span class="line">  if [fields][docType] &#x3D;&#x3D; &quot;sys-log&quot; &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts &#x3D;&gt; [ &quot;172.17.53.226:9101&quot; ]</span><br><span class="line">          ###每天自动创建sys-log-年月日的索引，匹配到的模板是sys-log-*</span><br><span class="line">      index &#x3D;&gt; &quot;sys-log-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if [fields][docType] &#x3D;&#x3D; &quot;point-log&quot; &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts &#x3D;&gt; [ &quot;172.17.53.226:9101&quot; ]</span><br><span class="line">      ###每天自动创建point-log-年月日的索引，匹配到的模板是point-log-*</span><br><span class="line">          index &#x3D;&gt; &quot;point-log-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">      routing &#x3D;&gt; &quot;%&#123;type&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if [fields][docType] &#x3D;&#x3D; &quot;mysqlslowlogs&quot; &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts &#x3D;&gt; [ &quot;172.17.53.226:9101&quot; ]</span><br><span class="line">          ###每天自动创建mysql-slowlog-年月日的索引，匹配到的模板是mysql-slowlog-*</span><br><span class="line">      index &#x3D;&gt; &quot;mysql-slowlog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">      manage_template &#x3D;&gt; false</span><br><span class="line">      document_type &#x3D;&gt; &quot;%&#123;[@metadata][type]&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  if [fields][docType] &#x3D;&#x3D; &quot;audit-log&quot; &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts &#x3D;&gt; [&quot;172.17.53.226:9101&quot;]</span><br><span class="line">      manage_template &#x3D;&gt; false</span><br><span class="line">      index &#x3D;&gt; &quot;audit-log-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">      document_type &#x3D;&gt; &quot;%&#123;[@metadata][type]&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; filter &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">filter &#123;</span><br><span class="line">  if [type] &#x3D;&#x3D; &quot;syslog&quot; &#123;</span><br><span class="line">        ##%&#123;语法：语义&#125;</span><br><span class="line">    grok &#123;</span><br><span class="line">      match &#x3D;&gt; &#123; &quot;message&quot; &#x3D;&gt; &quot;%&#123;SYSLOGTIMESTAMP:syslog_timestamp&#125; %&#123;SYSLOGHOST:syslog_hostname&#125; %&#123;DATA:syslog_program&#125;(?:\[%&#123;POSINT:syslog_pid&#125;\])?: %&#123;GREEDYDATA:syslog_message&#125;&quot; &#125;</span><br><span class="line">      add_field &#x3D;&gt; [ &quot;received_at&quot;, &quot;%&#123;@timestamp&#125;&quot; ]</span><br><span class="line">      add_field &#x3D;&gt; [ &quot;received_from&quot;, &quot;%&#123;host&#125;&quot; ]</span><br><span class="line">    &#125;</span><br><span class="line">    syslog_pri &#123; &#125;</span><br><span class="line">    date &#123;</span><br><span class="line">      match &#x3D;&gt; [ &quot;syslog_timestamp&quot;, &quot;MMM  d HH:mm:ss&quot;, &quot;MMM dd HH:mm:ss&quot; ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if [fields][docType] &#x3D;&#x3D; &quot;sys-log&quot; &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">      patterns_dir &#x3D;&gt; [&quot;&#x2F;home&#x2F;logstash-7.8.0&#x2F;config&#x2F;patterns&quot;]</span><br><span class="line">      match &#x3D;&gt; &#123; &quot;message&quot; &#x3D;&gt; &quot;\[%&#123;NOTSPACE:appName&#125;:%&#123;NOTSPACE:serverIp&#125;:%&#123;NOTSPACE:serverPort&#125;\] %&#123;TIMESTAMP_ISO8601:logTime&#125; %&#123;LOGLEVEL:logLevel&#125; %&#123;WORD:pid&#125; \[%&#123;MYAPPNAME:traceId&#125;\] \[%&#123;MYTHREADNAME:threadName&#125;\] %&#123;NOTSPACE:classname&#125; %&#123;GREEDYDATA:message&#125;&quot; &#125;</span><br><span class="line">      overwrite &#x3D;&gt; [&quot;message&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">    date &#123;</span><br><span class="line">      match &#x3D;&gt; [&quot;logTime&quot;,&quot;yyyy-MM-dd HH:mm:ss.SSS Z&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">    date &#123;</span><br><span class="line">      match &#x3D;&gt; [&quot;logTime&quot;,&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;]</span><br><span class="line">      target &#x3D;&gt; &quot;timestamp&quot;</span><br><span class="line">      locale &#x3D;&gt; &quot;en&quot;</span><br><span class="line">      timezone &#x3D;&gt; &quot;+08:00&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    mutate &#123;</span><br><span class="line">      remove_field &#x3D;&gt; &quot;logTime&quot;</span><br><span class="line">      remove_field &#x3D;&gt; &quot;@version&quot;</span><br><span class="line">      remove_field &#x3D;&gt; &quot;host&quot;</span><br><span class="line">      remove_field &#x3D;&gt; &quot;offset&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  if [fields][docType] &#x3D;&#x3D; &quot;point-log&quot; &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">      patterns_dir &#x3D;&gt; [&quot;&#x2F;home&#x2F;logstash-7.8.0&#x2F;config&#x2F;patterns&quot;] </span><br><span class="line">        match &#x3D;&gt; &#123;</span><br><span class="line">        &quot;message&quot; &#x3D;&gt; &quot;%&#123;TIMESTAMP_ISO8601:logTime&#125;\|%&#123;MYAPPNAME:appName&#125;\|%&#123;WORD:resouceid&#125;\|%&#123;MYAPPNAME:type&#125;\|%&#123;GREEDYDATA:object&#125;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    kv &#123;</span><br><span class="line">        source &#x3D;&gt; &quot;object&quot;</span><br><span class="line">        field_split &#x3D;&gt; &quot;&amp;&quot;</span><br><span class="line">        value_split &#x3D;&gt; &quot;&#x3D;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    date &#123;</span><br><span class="line">      match &#x3D;&gt; [&quot;logTime&quot;,&quot;yyyy-MM-dd HH:mm:ss.SSS Z&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">    date &#123;</span><br><span class="line">      match &#x3D;&gt; [&quot;logTime&quot;,&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;]</span><br><span class="line">      target &#x3D;&gt; &quot;timestamp&quot;</span><br><span class="line">      locale &#x3D;&gt; &quot;en&quot;</span><br><span class="line">      timezone &#x3D;&gt; &quot;+08:00&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    mutate &#123;</span><br><span class="line">      remove_field &#x3D;&gt; &quot;message&quot;</span><br><span class="line">      remove_field &#x3D;&gt; &quot;logTime&quot;</span><br><span class="line">      remove_field &#x3D;&gt; &quot;@version&quot;</span><br><span class="line">      remove_field &#x3D;&gt; &quot;host&quot;</span><br><span class="line">      remove_field &#x3D;&gt; &quot;offset&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  ##mysqlslowlogs</span><br><span class="line">  if [fields][docType] &#x3D;&#x3D; &quot;mysqlslowlogs&quot; &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">        match &#x3D;&gt; [</span><br><span class="line">          &quot;message&quot;, &quot;^#\s+User@Host:\s+%&#123;USER:user&#125;\[[^\]]+\]\s+@\s+(?:(?&lt;clienthost&gt;\S*) )?\[(?:%&#123;IP:clientip&#125;)?\]\s+Id:\s+%&#123;NUMBER:id&#125;\n# Query_time: %&#123;NUMBER:query_time&#125;\s+Lock_time: %&#123;NUMBER:lock_time&#125;\s+Rows_sent: %&#123;NUMBER:rows_sent&#125;\s+Rows_examined: %&#123;NUMBER:rows_examined&#125;\nuse\s(?&lt;dbname&gt;\w+);\nSET\s+timestamp&#x3D;%&#123;NUMBER:timestamp_mysql&#125;;\n(?&lt;query_str&gt;[\s\S]*)&quot;,</span><br><span class="line">          &quot;message&quot;, &quot;^#\s+User@Host:\s+%&#123;USER:user&#125;\[[^\]]+\]\s+@\s+(?:(?&lt;clienthost&gt;\S*) )?\[(?:%&#123;IP:clientip&#125;)?\]\s+Id:\s+%&#123;NUMBER:id&#125;\n# Query_time: %&#123;NUMBER:query_time&#125;\s+Lock_time: %&#123;NUMBER:lock_time&#125;\s+Rows_sent: %&#123;NUMBER:rows_sent&#125;\s+Rows_examined: %&#123;NUMBER:rows_examined&#125;\nSET\s+timestamp&#x3D;%&#123;NUMBER:timestamp_mysql&#125;;\n(?&lt;query_str&gt;[\s\S]*)&quot;,</span><br><span class="line">          &quot;message&quot;, &quot;^#\s+User@Host:\s+%&#123;USER:user&#125;\[[^\]]+\]\s+@\s+(?:(?&lt;clienthost&gt;\S*) )?\[(?:%&#123;IP:clientip&#125;)?\]\n# Query_time: %&#123;NUMBER:query_time&#125;\s+Lock_time: %&#123;NUMBER:lock_time&#125;\s+Rows_sent: %&#123;NUMBER:rows_sent&#125;\s+Rows_examined: %&#123;NUMBER:rows_examined&#125;\nuse\s(?&lt;dbname&gt;\w+);\nSET\s+timestamp&#x3D;%&#123;NUMBER:timestamp_mysql&#125;;\n(?&lt;query_str&gt;[\s\S]*)&quot;,</span><br><span class="line">          &quot;message&quot;, &quot;^#\s+User@Host:\s+%&#123;USER:user&#125;\[[^\]]+\]\s+@\s+(?:(?&lt;clienthost&gt;\S*) )?\[(?:%&#123;IP:clientip&#125;)?\]\n# Query_time: %&#123;NUMBER:query_time&#125;\s+Lock_time: %&#123;NUMBER:lock_time&#125;\s+Rows_sent: %&#123;NUMBER:rows_sent&#125;\s+Rows_examined: %&#123;NUMBER:rows_examined&#125;\nSET\s+timestamp&#x3D;%&#123;NUMBER:timestamp_mysql&#125;;\n(?&lt;query_str&gt;[\s\S]*)&quot;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">    date &#123;</span><br><span class="line">      match &#x3D;&gt; [&quot;timestamp_mysql&quot;,&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;,&quot;UNIX&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">    date &#123;</span><br><span class="line">      match &#x3D;&gt; [&quot;timestamp_mysql&quot;,&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;,&quot;UNIX&quot;]</span><br><span class="line">      target &#x3D;&gt; &quot;timestamp&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    mutate &#123;</span><br><span class="line">      convert &#x3D;&gt; [&quot;query_time&quot;, &quot;float&quot;]</span><br><span class="line">      convert &#x3D;&gt; [&quot;lock_time&quot;, &quot;float&quot;]</span><br><span class="line">      convert &#x3D;&gt; [&quot;rows_sent&quot;, &quot;integer&quot;]</span><br><span class="line">      convert &#x3D;&gt; [&quot;rows_examined&quot;, &quot;integer&quot;]</span><br><span class="line">      remove_field &#x3D;&gt; &quot;message&quot;</span><br><span class="line">      remove_field &#x3D;&gt; &quot;timestamp_mysql&quot;</span><br><span class="line">      remove_field &#x3D;&gt; &quot;@version&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  ####audit-log</span><br><span class="line">  if [fields][docType] &#x3D;&#x3D; &quot;audit-log&quot; &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">      patterns_dir &#x3D;&gt; [&quot;&#x2F;home&#x2F;logstash-7.8.0&#x2F;config&#x2F;patterns&quot;]</span><br><span class="line">      match &#x3D;&gt; &#123;</span><br><span class="line">        &quot;message&quot; &#x3D;&gt; &quot;%&#123;TIMESTAMP_ISO8601:logTime&#125;\|%&#123;MYAPPNAME:appName&#125;\|%&#123;MYTHREADNAME:className&#125;\|%&#123;WORD:methodName&#125;\|%&#123;MYAPPNAME:userId&#125;\|%&#123;MYAPPNAME:userName&#125;\|%&#123;MYAPPNAME:clientId&#125;\|%&#123;GREEDYDATA:operation&#125;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    date &#123;</span><br><span class="line">      match &#x3D;&gt; [&quot;logTime&quot;,&quot;yyyy-MM-dd HH:mm:ss.SSS Z&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">    date &#123;</span><br><span class="line">      match &#x3D;&gt; [&quot;logTime&quot;,&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;]</span><br><span class="line">      target &#x3D;&gt; &quot;timestamp&quot;</span><br><span class="line">      locale &#x3D;&gt; &quot;en&quot;</span><br><span class="line">      timezone &#x3D;&gt; &quot;+08:00&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    mutate &#123;</span><br><span class="line">      remove_field &#x3D;&gt; &quot;message&quot;</span><br><span class="line">      remove_field &#x3D;&gt; &quot;logTime&quot;</span><br><span class="line">      remove_field &#x3D;&gt; &quot;@version&quot;</span><br><span class="line">      remove_field &#x3D;&gt; &quot;host&quot;</span><br><span class="line">      remove_field &#x3D;&gt; &quot;offset&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试标准输入输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;bin&#x2F;logstash -e &#39;input &#123; stdin &#123;&#125; &#125; output &#123; stdout &#123; codec &#x3D;&gt; rubydebug&#125; &#125;&#39;</span><br><span class="line"></span><br><span class="line">#输入</span><br><span class="line">hellword</span><br><span class="line"></span><br><span class="line">#输出结果</span><br><span class="line">&#123;</span><br><span class="line">      &quot;@version&quot; &#x3D;&gt; &quot;1&quot;,</span><br><span class="line">          &quot;host&quot; &#x3D;&gt; &quot;iZ2zehsi01vpevu3usi6etZ&quot;,</span><br><span class="line">    &quot;@timestamp&quot; &#x3D;&gt; 2020-07-09T02:49:10.957Z,</span><br><span class="line">       &quot;message&quot; &#x3D;&gt; &quot;helloword&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试输出到文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;bin&#x2F;logstash -e &#39;input &#123; stdin&#123;&#125; &#125; output &#123; file &#123; path &#x3D;&gt; &quot;&#x2F;tmp&#x2F;log-%&#123;+YYYY.MM.dd&#125;messages.gz&quot;&#125;&#125;&#39;</span><br><span class="line"></span><br><span class="line">#输入</span><br><span class="line">hellword</span><br><span class="line"></span><br><span class="line">#输出结果</span><br><span class="line">tail &#x2F;tmp&#x2F;log-2020.07.09messages.gz </span><br><span class="line"></span><br><span class="line">&#123;&quot;host&quot;:&quot;iZ2zehsi01vpevu3usi6etZ&quot;,&quot;message&quot;:&quot;helloword&quot;,&quot;@version&quot;:&quot;1&quot;,&quot;@timestamp&quot;:&quot;2020-07-09T02:50:01.682Z&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>测试输出到elasticsearch</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;bin&#x2F;logstash -e &#39;input &#123;  stdin&#123;&#125; &#125; output &#123; elasticsearch &#123;hosts &#x3D;&gt; [&quot;172.17.53.225:9100&quot;] index &#x3D;&gt; &quot;mytest-%&#123;+YYYY.MM.dd&#125;&quot; &#125;&#125;&#39;</span><br><span class="line"></span><br><span class="line">#在es服务目录查看</span><br><span class="line">ll &#x2F;home&#x2F;elasticsearch&#x2F;data&#x2F;nodes&#x2F;0&#x2F;indices&#x2F;</span><br><span class="line">total 4</span><br><span class="line">drwxr-xr-x 4 es es 4096 Jul  9 10:55 mKYuiHd9Tj-qIH_h1sda9A</span><br></pre></td></tr></table></figure>

<p>创建模版</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT http:&#x2F;&#x2F;172.17.53.226:9101&#x2F;_template&#x2F;template_sys_log -d &#39;</span><br><span class="line">&#123;</span><br><span class="line">&quot;index_patterns&quot; : [&quot;sys-log-*&quot;],</span><br><span class="line">&quot;order&quot; : 0,</span><br><span class="line">&quot;settings&quot; : &#123;</span><br><span class="line">&quot;number_of_replicas&quot; : 0</span><br><span class="line">&#125;,</span><br><span class="line">&quot;mappings&quot;: &#123;</span><br><span class="line">&quot;properties&quot;: &#123;</span><br><span class="line">&quot;message&quot;: &#123;</span><br><span class="line">&quot;type&quot;: &quot;text&quot;,</span><br><span class="line">&quot;fields&quot;: &#123;</span><br><span class="line">&quot;keyword&quot;: &#123;</span><br><span class="line">&quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">&quot;ignore_above&quot;: 256</span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;analyzer&quot;: &quot;ik_max_word&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;pid&quot;: &#123;</span><br><span class="line">&quot;type&quot;: &quot;text&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;serverPort&quot;: &#123;</span><br><span class="line">&quot;type&quot;: &quot;text&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;logLevel&quot;: &#123;</span><br><span class="line">&quot;type&quot;: &quot;text&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;traceId&quot;: &#123;</span><br><span class="line">&quot;type&quot;: &quot;text&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;&#39; --header &quot;Content-Type: application&#x2F;json&quot;</span><br><span class="line"></span><br><span class="line">curl -XPUT http:&#x2F;&#x2F;172.17.53.226:9101&#x2F;_template&#x2F;template_point_log -d &#39;</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&quot;index_patterns&quot; : [&quot;point-log-*&quot;],</span><br><span class="line"></span><br><span class="line">&quot;order&quot; : 0,</span><br><span class="line"></span><br><span class="line">&quot;settings&quot; : &#123;</span><br><span class="line"></span><br><span class="line">&quot;number_of_replicas&quot; : 0</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;&#39; --header &quot;Content-Type: application&#x2F;json&quot;</span><br></pre></td></tr></table></figure>

<p>在config目录下创建patterns目录,在目录下创建mepattern.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># user-center</span><br><span class="line">MYAPPNAME ([0-9a-zA-Z_-]*)</span><br><span class="line"># RMI TCP Connection(2)-127.0.0.1</span><br><span class="line">MYTHREADNAME ([0-9a-zA-Z._-]|\(|\)|\s)*</span><br></pre></td></tr></table></figure>

<p>在bin目录下启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;logstash -f logstash.conf</span><br></pre></td></tr></table></figure>

<p>安装filebeat</p>
<p>下载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;mirrors.huaweicloud.com&#x2F;filebeat&#x2F;7.8.0&#x2F;filebeat-7.8.0-x86_64.rpm</span><br></pre></td></tr></table></figure>

<p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -Uvh filebeat-7.8.0-x86_64.rpm</span><br></pre></td></tr></table></figure>

<p>配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;etc&#x2F;filebeat&#x2F;filebeat.yml</span><br><span class="line"></span><br><span class="line">filebeat.inputs:</span><br><span class="line"></span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  # 检查文件更新的频率，默认是 10s</span><br><span class="line">  scan_frequency: 10s</span><br><span class="line">  #忽略过去 ignore_older 时间没有修改的文件,0(禁用),2h(2小时),5m(5分钟),168h(1周)</span><br><span class="line">  ignore_older: 0</span><br><span class="line">  # 关闭过去 close_inactive 时间非活动状态的文件的 harvester</span><br><span class="line">  close_inactive: 2m</span><br><span class="line">  #单文件最大收集的字节数,超过将被丢弃，默认10MB&#x3D;10485760，60MB&#x3D;62914560,必须大于单文件最大大小</span><br><span class="line">  max_bytes: 62914560</span><br><span class="line">  #每个harvester在获取文件时使用的缓冲区大小字节数，默认值是16384,1MB&#x3D;1048576‬</span><br><span class="line">  harvester_buffer_size: 1048576‬</span><br><span class="line">  paths:</span><br><span class="line">    - &#x2F;var&#x2F;log&#x2F;java&#x2F;*&#x2F;app.*log</span><br><span class="line">  #exclude_lines: [&#39;\s^DEBUG\s\d&#39;]</span><br><span class="line">  #fields_under_root: true</span><br><span class="line">  fields:</span><br><span class="line">    docType: sys-log</span><br><span class="line">    project: microservices-platform</span><br><span class="line">  multiline:</span><br><span class="line">    #pattern: &#39;^\[\S+:\S+:\d&#123;2,&#125;] &#39;</span><br><span class="line">    pattern: &#39;^\[&#39;</span><br><span class="line">    negate: true</span><br><span class="line">    match: after</span><br><span class="line">    </span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  # 检查文件更新的频率，默认是 10s</span><br><span class="line">  scan_frequency: 15s</span><br><span class="line">  #忽略过去 ignore_older 时间没有修改的文件,0(禁用),2h(2小时),5m(5分钟),168h(1周)</span><br><span class="line">  ignore_older: 0</span><br><span class="line">  # 关闭过去 close_inactive 时间非活动状态的文件的 harvester</span><br><span class="line">  close_inactive: 2m</span><br><span class="line">  #单文件最大收集的字节数,超过将被丢弃，默认10MB&#x3D;10485760，60MB&#x3D;62914560,必须大于单文件最大大小</span><br><span class="line">  max_bytes: 62914560</span><br><span class="line">  #每个harvester在获取文件时使用的缓冲区大小字节数，默认值是16384,1MB&#x3D;1048576‬</span><br><span class="line">  harvester_buffer_size: 1048576‬</span><br><span class="line">  paths:</span><br><span class="line">    - &#x2F;var&#x2F;log&#x2F;java&#x2F;*&#x2F;point.*log</span><br><span class="line">  #fields_under_root: true</span><br><span class="line">  fields:</span><br><span class="line">    docType: point-log</span><br><span class="line">    project: microservices-platform</span><br><span class="line">    </span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  # 检查文件更新的频率，默认是 10s</span><br><span class="line">  scan_frequency: 20s</span><br><span class="line">  #忽略过去 ignore_older 时间没有修改的文件,0(禁用),2h(2小时),5m(5分钟),168h(1周)</span><br><span class="line">  ignore_older: 0</span><br><span class="line">  # 关闭过去 close_inactive 时间非活动状态的文件的 harvester</span><br><span class="line">  close_inactive: 2m</span><br><span class="line">  #单文件最大收集的字节数,超过将被丢弃，默认10MB&#x3D;10485760，60MB&#x3D;62914560,必须大于单文件最大大小</span><br><span class="line">  max_bytes: 62914560</span><br><span class="line">  #每个harvester在获取文件时使用的缓冲区大小字节数，默认值是16384,1MB&#x3D;1048576‬</span><br><span class="line">  harvester_buffer_size: 1048576‬</span><br><span class="line">  paths:</span><br><span class="line">    - &#x2F;var&#x2F;log&#x2F;java&#x2F;*&#x2F;audit.*log</span><br><span class="line">  #fields_under_root: true</span><br><span class="line">  fields:</span><br><span class="line">    docType: audit-log</span><br><span class="line">    project: microservices-platform</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">#filebeat全局配置</span><br><span class="line">max_procs: 1</span><br><span class="line">queue.mem:</span><br><span class="line">  #事件容量</span><br><span class="line">  events: 4096</span><br><span class="line">  #一次发送最小event数</span><br><span class="line">  flush.min_events: 512</span><br><span class="line">  #一次发送最大min_events等待时间</span><br><span class="line">  flush.timeout: 5s</span><br><span class="line"></span><br><span class="line">output.logstash:</span><br><span class="line">  enabled: true</span><br><span class="line">  # The Logstash hosts</span><br><span class="line">  hosts: [&quot;172.17.53.226:5044&quot;]</span><br><span class="line">  bulk_max_size: 2048</span><br><span class="line">  </span><br><span class="line">processors:</span><br><span class="line">  - add_host_metadata: ~</span><br><span class="line">  - add_cloud_metadata: ~</span><br><span class="line">  - add_docker_metadata: ~</span><br><span class="line">  - add_kubernetes_metadata:</span><br><span class="line">      default_indexers.enabled: false</span><br><span class="line">      default_matchers.enabled: false</span><br></pre></td></tr></table></figure>

<p>启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">filebeat -c &#x2F;etc&#x2F;filebeat&#x2F;filebeat.yml -e</span><br><span class="line"></span><br><span class="line">后台启动</span><br><span class="line">nohup filebeat -c &#x2F;etc&#x2F;filebeat&#x2F;filebeat.yml -e &gt;filebeat.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>


        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>nmk</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://nmk0718.github.io/2020/07/30/elasticsearch/">http://nmk0718.github.io/2020/07/30/elasticsearch/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2020 <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tag/elasticsearch/"># elasticsearch</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2020/07/30/%E5%AE%B9%E5%99%A8%E7%BB%B4%E6%8A%A4/">容器维护</a>
            
            
            <a class="next" rel="next" href="/2020/07/16/nginx/">nginx</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© nmk | Powered by <a href="https://hexo.io" target="_blank">Hexo</a></span>
	</div>
</footer>

    </div>
</body>
</html>
