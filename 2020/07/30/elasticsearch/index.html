<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">



<title>elasticsearch | K&#39;s Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">kk&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">kk&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">elasticsearch</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">nmk</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2020-7-30&nbsp;&nbsp;22:55:00</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <h3 id="elasticsearch集群搭建"><a href="#elasticsearch集群搭建" class="headerlink" title="elasticsearch集群搭建"></a>elasticsearch集群搭建</h3><h4 id="elasticsearch"><a href="#elasticsearch" class="headerlink" title="elasticsearch"></a>elasticsearch</h4><h5 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h5><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//</span>artifacts.elastic.co<span class="regexp">/downloads/</span>elasticsearch<span class="regexp">/elasticsearch-oss-7.8.0-linux-x86_64.tar.gz</span></span><br></pre></td></tr></table></figure>

<p>注意下载带oss的开源版本</p>
<h5 id="拷贝到安装目录"><a href="#拷贝到安装目录" class="headerlink" title="拷贝到安装目录"></a>拷贝到安装目录</h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp elasticsearch-<span class="number">7.8</span>.<span class="number">0</span>-linux-x86_64<span class="selector-class">.tar</span><span class="selector-class">.gz</span> /opt/es</span><br></pre></td></tr></table></figure>

<h5 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/es</span><br><span class="line">tar -zxvf elasticsearch-<span class="number">7.8</span>.<span class="number">0</span>-linux-x86_64<span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br></pre></td></tr></table></figure>

<h5 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h5><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim elasticsearch<span class="number">-7.8</span><span class="number">.0</span>/config/elasticsearch.yml</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>cluster.name</strong>: 集群名称,集群名称用于跟其他相同名字的节点构成整个集群.</li>
<li><strong>node.name</strong>: 节点名称, 是该elasticsearch实例的唯一标识</li>
<li><strong>path.data</strong>: 数据路径,指定文档，索引存放的位置。</li>
<li><strong>path.logs</strong>:日志路径，指定运行日志的存放目录</li>
<li><strong>network.host</strong>: 绑定地址</li>
<li><strong>http.port</strong>: http端口,默认9200</li>
<li><strong>discovery.seed_hosts</strong>: 集群主机列表</li>
<li><strong>cluster.initial_master_nodes</strong>: 初始化一个新的集群时选举master(第一个启动为master)</li>
<li><strong>http.cors.enabled</strong>: 是否支持跨域,是：true，在使用head插件时需要此配置</li>
<li><strong>node.master</strong>: 是否是master节点</li>
</ul>
<p>配置如下</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># ======================== Elasticsearch Configuration =========================</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># NOTE: Elasticsearch comes with reasonable defaults for most settings.</span></span><br><span class="line"><span class="meta">#       Before you set out to tweak and tune the configuration, make sure you</span></span><br><span class="line"><span class="meta">#       understand what are you trying to accomplish and the consequences.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># The primary way of configuring a node is via this file. This template lists</span></span><br><span class="line"><span class="meta"># the most important settings you may want to configure for a production cluster.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># Please consult the documentation for further information on configuration options:</span></span><br><span class="line"><span class="meta"># https://www.elastic.co/guide/en/elasticsearch/reference/index.html</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># ---------------------------------- Cluster -----------------------------------</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># Use a descriptive name for your cluster:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line">cluster.name: gzlp-elasticsearch</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># ------------------------------------ Node ------------------------------------</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># Use a descriptive name for the node:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line">node.name: node<span class="number">-100</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># Add custom attributes to the node:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#node.attr.rack: r1</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># ----------------------------------- Paths ------------------------------------</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># Path to directory where to store the data (separate multiple locations by comma):</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line">path.data: /home/elasticsearch/data</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># Path to log files:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line">path.logs: /home/elasticsearch/logs</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># ----------------------------------- Memory -----------------------------------</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># Lock the memory on startup:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#bootstrap.memory_lock: true</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># Make sure that the heap size is set to about half the memory available</span></span><br><span class="line"><span class="meta"># on the system and that the owner of the process is allowed to use this</span></span><br><span class="line"><span class="meta"># limit.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># Elasticsearch performs poorly when the system is swapping the memory.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># ---------------------------------- Network -----------------------------------</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># Set the bind address to a specific IP (IPv4 or IPv6):</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line">network.host: <span class="number">172.17</span><span class="number">.53</span><span class="number">.225</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># Set a custom port for HTTP:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line">http.port: <span class="number">9100</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># For more information, consult the network module documentation.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># --------------------------------- Discovery ----------------------------------</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># Pass an initial list of hosts to perform discovery when this node is started:</span></span><br><span class="line"><span class="meta"># The default list of hosts is ["127.0.0.1", "[::1]"]</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line">discovery.seed_hosts: [<span class="string">"172.17.53.225:9300"</span>,<span class="string">"172.17.53.226:9300"</span>,<span class="string">"172.17.53.227:9300"</span>]</span><br><span class="line"><span class="meta">#ES7.x前使用discovery.zen.ping.unicast.hosts: ["192.168.1.130", "192.168.1.134"] </span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># Bootstrap the cluster using an initial set of master-eligible nodes:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line">cluster.initial_master_nodes: [<span class="string">"node-100"</span>, <span class="string">"node-101"</span>,<span class="string">"node-102"</span>]</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># For more information, consult the discovery and cluster formation module documentation.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># ---------------------------------- Gateway -----------------------------------</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># Block initial recovery after a full cluster restart until N nodes are started:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#gateway.recover_after_nodes: 3</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># For more information, consult the gateway module documentation.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># ---------------------------------- Various -----------------------------------</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># Require explicit names when deleting indices:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#action.destructive_requires_name: true</span></span><br><span class="line">http.cors.enabled: <span class="literal">true</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line">node.master: <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>⚠️注意discovery.seed_hosts处为集群交互端口,默认为9300,如需更改请把下面参数加入配置</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#TCP</span>的默认监听端口，默认 9300</span><br><span class="line"><span class="selector-tag">transport</span><span class="selector-class">.tcp</span><span class="selector-class">.port</span>: 9300</span><br></pre></td></tr></table></figure>

<p>配置完成后，将整个文件copy到另外两个机器</p>
<p>Elasticsearch不允许使用root账号启动，因此需要建一个专用的账号。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adduser <span class="built_in">es</span></span><br><span class="line">passwd gzlp</span><br><span class="line">chown -R <span class="built_in">es</span> ./elasticsearch-<span class="number">7.8</span><span class="meta">.0</span></span><br></pre></td></tr></table></figure>

<p>修改数据路径和日志路径的权限:</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chown -R es /<span class="built_in">home</span>/elasticsearch/data</span><br><span class="line">chown -R es /<span class="built_in">home</span>/elasticsearch/logs</span><br></pre></td></tr></table></figure>

<p>增加插件</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">https:</span>/<span class="regexp">/github.com/medcl</span><span class="regexp">/elasticsearch-analysis-ik/releases</span></span><br><span class="line"><span class="symbol">https:</span>/<span class="regexp">/github.com/medcl</span><span class="regexp">/elasticsearch-analysis-pinyin/releases</span></span><br><span class="line"><span class="symbol">https:</span>/<span class="regexp">/github.com/medcl</span><span class="regexp">/elasticsearch-analysis-stconvert/releases</span></span><br><span class="line">下载es版本一致的包,解压.移动到elasticsearch-<span class="number">7.8</span>.<span class="number">0</span>/plugins里</span><br><span class="line">重命名elasticsearch-analysis-ik为ik</span><br><span class="line">重命名elasticsearch-analysis-pinyin为pinyin</span><br><span class="line">重命名elasticsearch-analysis-stconvert为stconvert</span><br></pre></td></tr></table></figure>

<p>修改配置sysctl.conf</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> /etc/sysctl.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>

<p>添加配置</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">vm.max_map_count</span>=<span class="number">262144</span></span><br></pre></td></tr></table></figure>

<p>执行命令</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sysctl -p</span></span><br></pre></td></tr></table></figure>

<p>启动elasticsearch</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#后台启动</span></span><br><span class="line"><span class="string">./elasticsearch</span> -d</span><br></pre></td></tr></table></figure>

<p>验证是否启动成功</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//172.17.53.255:9100</span></span><br></pre></td></tr></table></figure>

<p>验证是否为集群</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//172.17.53.255:9100/_cluster/stats?pretty</span></span><br></pre></td></tr></table></figure>

<p>验证是否为主节点</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">172.17</span>.<span class="number">53.226</span>:<span class="number">9200</span>/_cat/nodes?v</span><br><span class="line"></span><br><span class="line"><span class="comment">#带*星号表明该节点是主节点。带-表明该节点是从节点。</span></span><br><span class="line"><span class="comment">#另外还是heap.percent堆内存使用情况，ram.percent运行内存使用情况，cpu使用情况。</span></span><br><span class="line"></span><br><span class="line">ip            heap.percent ram.percent cpu load_1m load_5m load_15m <span class="keyword">node</span>.<span class="title">role</span> <span class="keyword">master</span> <span class="title">name</span></span><br><span class="line"><span class="number">172.17</span>.<span class="number">53.227</span>           <span class="number">61</span>          <span class="number">78</span>   <span class="number">0</span>    <span class="number">0.04</span>    <span class="number">0.30</span>     <span class="number">0.38</span> dimr      *      <span class="keyword">node</span><span class="title">-3</span></span><br><span class="line"><span class="number">172.17</span>.<span class="number">53.226</span>           <span class="number">69</span>          <span class="number">90</span>   <span class="number">1</span>    <span class="number">0.21</span>    <span class="number">0.84</span>     <span class="number">1.03</span> dimr      -      <span class="keyword">node</span><span class="title">-2</span></span><br><span class="line"><span class="number">172.17</span>.<span class="number">53.225</span>           <span class="number">34</span>          <span class="number">92</span>   <span class="number">1</span>    <span class="number">0.20</span>    <span class="number">0.32</span>     <span class="number">0.18</span> dimr      -      <span class="keyword">node</span><span class="title">-1</span></span><br></pre></td></tr></table></figure>

<h5 id="开机自启"><a href="#开机自启" class="headerlink" title="开机自启"></a>开机自启</h5><ul>
<li>在/etc/init.d目录下新建文件elasticsearch</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">一般的服务器在<span class="selector-tag">init</span><span class="selector-class">.d</span>这个目录下面好像都有没有<span class="selector-tag">elasticsearch</span>这个文件，所以需要自己创建一个</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<ul>
<li>在文件里面写入shell脚本</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"><span class="comment">#chkconfig: 2345 80 05</span></span><br><span class="line"><span class="comment">#description: elasticsearch</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Java Env</span></span><br><span class="line">export JAVA_HOME=/usr/java</span><br><span class="line">export CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/lib/dt.jar:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</span><br><span class="line">export PATH=<span class="variable">$PATH:</span><span class="variable">$JAVA_HOME</span>/bin</span><br><span class="line"> </span><br><span class="line">case <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">    su es&lt;&lt;!</span><br><span class="line">    cd /opt/es</span><br><span class="line">    ./bin/elasticsearch -d</span><br><span class="line">!</span><br><span class="line">    echo <span class="string">"elasticsearch startup"</span></span><br><span class="line">    ;;  </span><br><span class="line">stop)</span><br><span class="line">    es_pid=`ps aux|grep elasticsearch | grep -v <span class="string">'grep elasticsearch'</span> | awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line">    kill -<span class="number">9</span> <span class="variable">$es_pid</span></span><br><span class="line">    echo <span class="string">"elasticsearch stopped"</span></span><br><span class="line">    ;;  </span><br><span class="line">restart)</span><br><span class="line">    es_pid=`ps aux|grep elasticsearch | grep -v <span class="string">'grep elasticsearch'</span> | awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line">    kill -<span class="number">9</span> <span class="variable">$es_pid</span></span><br><span class="line">    echo <span class="string">"elasticsearch stopped"</span></span><br><span class="line">    su es&lt;&lt;!</span><br><span class="line">    cd /opt/es</span><br><span class="line">    ./bin/elasticsearch -d</span><br><span class="line">!</span><br><span class="line">    echo <span class="string">"elasticsearch startup"</span></span><br><span class="line">    ;;  </span><br><span class="line">*)</span><br><span class="line">    echo <span class="string">"start|stop|restart"</span></span><br><span class="line">    ;;  </span><br><span class="line">esac</span><br><span class="line"> </span><br><span class="line"><span class="keyword">exit</span> $?</span><br></pre></td></tr></table></figure>

<p>代码中的JAVA_HOME和JAVA_BIN路径需要根据自己的实际情况填写，su es这个要换成自己的服务器用户名，cd /usr/local/elasticsearch-7.7.1需要换成自己es的实际安装地址</p>
<ul>
<li>在/etc/init.d/下面给elasticsearch赋予执行权限</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x elasticsearch</span><br></pre></td></tr></table></figure>

<ul>
<li>将elasticsearch添加到开机启动</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --add elasticsearch</span><br></pre></td></tr></table></figure>

<ul>
<li>重启服务器在浏览器中输入<a href="http://X.X.X.X:9200/就可以了" target="_blank" rel="noopener">http://X.X.X.X:9200/就可以了</a></li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure>

<p>将脚本加在 /etc/rc.local的后面</p>
<h5 id="遇到的报错"><a href="#遇到的报错" class="headerlink" title="遇到的报错"></a>遇到的报错</h5><p><strong>错误信息：</strong> [1]: max file descriptors [4096] for elasticsearch process is too low, increase to at least [65535]</p>
<p>ERROR: [5] bootstrap checks failed</p>
<p>[1]: max file descriptors [4096] for elasticsearch process is too low, increase to at least [65535]</p>
<p>[2]: max number of threads [1024] for user [es] is too low, increase to at least [4096]</p>
<p>[3]: max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]</p>
<p>修改配置limits.conf</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> /etc/security/limits.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>

<p>添加配置</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">* </span>soft nofile 65536</span><br><span class="line"><span class="bullet">* </span>hard nofile 65536</span><br><span class="line"></span><br><span class="line"><span class="bullet">* </span>soft nproc 4096</span><br><span class="line"><span class="bullet">* </span>hard nproc 4096</span><br><span class="line"><span class="section">#保存后需重新连接服务器</span></span><br></pre></td></tr></table></figure>

<h4 id="ElasticHD"><a href="#ElasticHD" class="headerlink" title="ElasticHD"></a>ElasticHD</h4><h5 id="下载-1"><a href="#下载-1" class="headerlink" title="下载"></a>下载</h5><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/360EntSecGroup-Skylar/</span>ElasticHD<span class="regexp">/releases</span></span><br></pre></td></tr></table></figure>

<h5 id="解压-1"><a href="#解压-1" class="headerlink" title="解压"></a>解压</h5><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">unzip</span> <span class="selector-tag">elasticHD_linux_amd64</span><span class="selector-class">.zip</span></span><br></pre></td></tr></table></figure>

<h5 id="进入目录"><a href="#进入目录" class="headerlink" title="进入目录"></a>进入目录</h5><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv ElasticHD <span class="string">/opt/</span></span><br><span class="line"><span class="keyword">cd</span> <span class="string">/opt/</span></span><br></pre></td></tr></table></figure>

<h5 id="后台启动"><a href="#后台启动" class="headerlink" title="后台启动"></a>后台启动</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">nohup</span> ./ElasticHD -p <span class="number">192.168.50.60:9800</span> &amp;</span><br></pre></td></tr></table></figure>

<h4 id="Cerebro"><a href="#Cerebro" class="headerlink" title="Cerebro"></a>Cerebro</h4><h5 id="下载-2"><a href="#下载-2" class="headerlink" title="下载"></a>下载</h5><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="regexp">//gi</span>thub.com<span class="regexp">/lmenezes/</span>cerebro<span class="regexp">/releases/</span>download<span class="regexp">/v0.9.2/</span>cerebro-<span class="number">0.9</span>.<span class="number">2</span>.tgz</span><br></pre></td></tr></table></figure>

<h5 id="解压-2"><a href="#解压-2" class="headerlink" title="解压"></a>解压</h5><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">tar</span> <span class="selector-tag">zxvf</span> <span class="selector-tag">cerebro-0</span><span class="selector-class">.9</span><span class="selector-class">.2</span><span class="selector-class">.tgz</span></span><br></pre></td></tr></table></figure>

<h5 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h5><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vim</span> cerebro-<span class="number">0.9</span>.<span class="number">2</span>/<span class="keyword">conf</span>/application.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>basePath</strong>: 定义访问路径 默认为/</li>
<li><strong>pidfile.path</strong>: pid路径</li>
<li><strong>data.path</strong>: 数据存放位置</li>
<li><strong>server.http.port</strong>: 访问端口 默认为9000</li>
<li><strong>network.host</strong>: 绑定地址</li>
<li><strong>username</strong>: 登录用户名</li>
<li><strong>password</strong>: 登录密码</li>
<li><strong>host</strong>: es集群地址</li>
<li><strong>name</strong>: 标识 一般用ES的cluster_name</li>
</ul>
<p>示例</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Secret will be used to sign session cookies, CSRF tokens and for other encryption utilities.</span></span><br><span class="line"><span class="comment"># It is highly recommended to change this value before running cerebro in production.</span></span><br><span class="line"><span class="attr">secret</span> = <span class="string">"ki:s:[[@=Ag?QI`W2jMwkY:eqvrJ]JqoJyi2axj3ZvOv^/KavOT4ViJSv?6YY4[N"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Application base path</span></span><br><span class="line"><span class="attr">basePath</span> = <span class="string">"/cerebro/"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Defaults to RUNNING_PID at the root directory of the app.</span></span><br><span class="line"><span class="comment"># To avoid creating a PID file set this value to /dev/null</span></span><br><span class="line"><span class="comment">#pidfile.path = "/var/run/cerebro.pid"</span></span><br><span class="line">pidfile.<span class="attr">path=/dev/null</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Rest request history max size per user</span></span><br><span class="line">rest.history.<span class="attr">size</span> = <span class="number">50</span> // defaults to <span class="number">50</span> <span class="keyword">if</span> not specified</span><br><span class="line"></span><br><span class="line"><span class="comment"># Path of local database file</span></span><br><span class="line"><span class="comment">#data.path: "/var/lib/cerebro/cerebro.db"</span></span><br><span class="line">data.<span class="attr">path</span> = <span class="string">"./cerebro.db"</span></span><br><span class="line"></span><br><span class="line">play &#123;</span><br><span class="line">  <span class="comment"># Cerebro port, by default it's 9000 (play's default)</span></span><br><span class="line">  server.http.<span class="attr">port</span> = $&#123;?CEREBRO_PORT&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attr">es</span> = &#123;</span><br><span class="line">  <span class="attr">gzip</span> = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Authentication</span></span><br><span class="line"><span class="attr">auth</span> = &#123;</span><br><span class="line">  <span class="comment"># either basic or ldap</span></span><br><span class="line">  type: basic</span><br><span class="line">  settings: &#123;</span><br><span class="line">    <span class="comment"># Basic auth</span></span><br><span class="line">    <span class="attr">username</span> = <span class="string">"gzlp"</span></span><br><span class="line">    <span class="attr">password</span> = <span class="string">"gzlplink"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># A list of known hosts</span></span><br><span class="line"><span class="attr">hosts</span> = [</span><br><span class="line">					&#123; </span><br><span class="line">							<span class="attr">host</span> = <span class="string">"http://172.17.53.225:9100"</span></span><br><span class="line">							<span class="attr">name</span> = <span class="string">"gzlp-elasticsearch"</span></span><br><span class="line">		&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h5 id="后台启动-1"><a href="#后台启动-1" class="headerlink" title="后台启动"></a>后台启动</h5><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#后台启动</span></span><br><span class="line">nohup ./bin/cerebro <span class="meta">&amp;</span></span><br></pre></td></tr></table></figure>

<h4 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a>Logstash</h4><h5 id="采集日志"><a href="#采集日志" class="headerlink" title="采集日志"></a>采集日志</h5><h6 id="下载-3"><a href="#下载-3" class="headerlink" title="下载"></a>下载</h6><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="regexp">//</span>artifacts.elastic.co<span class="regexp">/downloads/</span>logstash<span class="regexp">/logstash-oss-7.8.0.tar.gz</span></span><br></pre></td></tr></table></figure>

<h6 id="解压-3"><a href="#解压-3" class="headerlink" title="解压"></a>解压</h6><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">tar</span> <span class="selector-tag">zxvf</span> <span class="selector-tag">logstash-oss-7</span><span class="selector-class">.8</span><span class="selector-class">.0</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br></pre></td></tr></table></figure>

<h6 id="配置logstash-yml"><a href="#配置logstash-yml" class="headerlink" title="配置logstash.yml"></a>配置logstash.yml</h6><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">http</span><span class="selector-class">.host</span>: "192<span class="selector-class">.168</span><span class="selector-class">.30</span><span class="selector-class">.129</span>"</span><br><span class="line"><span class="selector-tag">http</span><span class="selector-class">.port</span>: 9600</span><br></pre></td></tr></table></figure>

<p>在bin目录下创建logstash.conf配置索引</p>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#================================ input =====================================</span></span><br><span class="line"><span class="keyword">input</span> &#123;</span><br><span class="line"> beats &#123;</span><br><span class="line">   <span class="attr">port</span> =&gt; <span class="number">5044</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#================================ output =====================================</span></span><br><span class="line"><span class="keyword">output</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> [fields][docType] == <span class="string">"sys-log"</span> &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      <span class="attr">hosts</span> =&gt; [ <span class="string">"172.17.53.226:9101"</span> ]</span><br><span class="line">          <span class="comment">###每天自动创建sys-log-年月日的索引，匹配到的模板是sys-log-*</span></span><br><span class="line">      <span class="attr">index</span> =&gt; <span class="string">"sys-log-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if [fields][docType] == <span class="string">"point-log"</span> &#123;</span><br><span class="line">    <span class="keyword">elasticsearch</span> &#123;</span><br><span class="line">      <span class="attr">hosts</span> =&gt; [ <span class="string">"172.17.53.226:9101"</span> ]</span><br><span class="line">      <span class="comment">###每天自动创建point-log-年月日的索引，匹配到的模板是point-log-*</span></span><br><span class="line">          <span class="attr">index</span> =&gt; <span class="string">"point-log-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">      <span class="attr">routing</span> =&gt; <span class="string">"%&#123;type&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if [fields][docType] == <span class="string">"mysqlslowlogs"</span> &#123;</span><br><span class="line">    <span class="keyword">elasticsearch</span> &#123;</span><br><span class="line">      <span class="attr">hosts</span> =&gt; [ <span class="string">"172.17.53.226:9101"</span> ]</span><br><span class="line">          <span class="comment">###每天自动创建mysql-slowlog-年月日的索引，匹配到的模板是mysql-slowlog-*</span></span><br><span class="line">      <span class="attr">index</span> =&gt; <span class="string">"mysql-slowlog-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">      <span class="attr">manage_template</span> =&gt; <span class="keyword">false</span></span><br><span class="line">      <span class="attr">document_type</span> =&gt; <span class="string">"%&#123;[@metadata][type]&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  if [fields][docType] == <span class="string">"audit-log"</span> &#123;</span><br><span class="line">    <span class="keyword">elasticsearch</span> &#123;</span><br><span class="line">      <span class="attr">hosts</span> =&gt; [<span class="string">"172.17.53.226:9101"</span>]</span><br><span class="line">      <span class="attr">manage_template</span> =&gt; <span class="keyword">false</span></span><br><span class="line">      <span class="attr">index</span> =&gt; <span class="string">"audit-log-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">      <span class="attr">document_type</span> =&gt; <span class="string">"%&#123;[@metadata][type]&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#================================ filter =====================================</span></span><br><span class="line"><span class="keyword">filter</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"syslog"</span> &#123;</span><br><span class="line">        <span class="comment">##%&#123;语法：语义&#125;</span></span><br><span class="line">    grok &#123;</span><br><span class="line">      <span class="attr">match</span> =&gt; &#123; <span class="string">"message"</span> =&gt; <span class="string">"%&#123;SYSLOGTIMESTAMP:syslog_timestamp&#125; %&#123;SYSLOGHOST:syslog_hostname&#125; %&#123;DATA:syslog_program&#125;(?:\[%&#123;POSINT:syslog_pid&#125;\])?: %&#123;GREEDYDATA:syslog_message&#125;"</span> &#125;</span><br><span class="line">      <span class="keyword">add_field</span> =&gt; [ <span class="string">"received_at"</span>, <span class="string">"%&#123;@timestamp&#125;"</span> ]</span><br><span class="line">      add_field =&gt; [ <span class="string">"received_from"</span>, <span class="string">"%&#123;host&#125;"</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">syslog_pri</span> &#123; &#125;</span><br><span class="line">    <span class="keyword">date</span> &#123;</span><br><span class="line">      <span class="attr">match</span> =&gt; [ <span class="string">"syslog_timestamp"</span>, <span class="string">"MMM  d HH:mm:ss"</span>, <span class="string">"MMM dd HH:mm:ss"</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if [fields][docType] == <span class="string">"sys-log"</span> &#123;</span><br><span class="line">    <span class="keyword">grok</span> &#123;</span><br><span class="line">      <span class="attr">patterns_dir</span> =&gt; [<span class="string">"/home/logstash-7.8.0/config/patterns"</span>]</span><br><span class="line">      <span class="attr">match</span> =&gt; &#123; <span class="string">"message"</span> =&gt; <span class="string">"\[%&#123;NOTSPACE:appName&#125;:%&#123;NOTSPACE:serverIp&#125;:%&#123;NOTSPACE:serverPort&#125;\] %&#123;TIMESTAMP_ISO8601:logTime&#125; %&#123;LOGLEVEL:logLevel&#125; %&#123;WORD:pid&#125; \[%&#123;MYAPPNAME:traceId&#125;\] \[%&#123;MYTHREADNAME:threadName&#125;\] %&#123;NOTSPACE:classname&#125; %&#123;GREEDYDATA:message&#125;"</span> &#125;</span><br><span class="line">      <span class="keyword">overwrite</span> =&gt; [<span class="string">"message"</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">date</span> &#123;</span><br><span class="line">      <span class="attr">match</span> =&gt; [<span class="string">"logTime"</span>,<span class="string">"yyyy-MM-dd HH:mm:ss.SSS Z"</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">date</span> &#123;</span><br><span class="line">      <span class="attr">match</span> =&gt; [<span class="string">"logTime"</span>,<span class="string">"yyyy-MM-dd HH:mm:ss.SSS"</span>]</span><br><span class="line">      <span class="attr">target</span> =&gt; <span class="string">"timestamp"</span></span><br><span class="line">      <span class="attr">locale</span> =&gt; <span class="string">"en"</span></span><br><span class="line">      <span class="attr">timezone</span> =&gt; <span class="string">"+08:00"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">mutate</span> &#123;</span><br><span class="line">      <span class="attr">remove_field</span> =&gt; <span class="string">"logTime"</span></span><br><span class="line">      <span class="attr">remove_field</span> =&gt; <span class="string">"@version"</span></span><br><span class="line">      <span class="attr">remove_field</span> =&gt; <span class="string">"host"</span></span><br><span class="line">      <span class="attr">remove_field</span> =&gt; <span class="string">"offset"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  if [fields][docType] == <span class="string">"point-log"</span> &#123;</span><br><span class="line">    <span class="keyword">grok</span> &#123;</span><br><span class="line">      <span class="attr">patterns_dir</span> =&gt; [<span class="string">"/home/logstash-7.8.0/config/patterns"</span>] </span><br><span class="line">        <span class="attr">match</span> =&gt; &#123;</span><br><span class="line">        <span class="string">"message"</span> =&gt; <span class="string">"%&#123;TIMESTAMP_ISO8601:logTime&#125;\|%&#123;MYAPPNAME:appName&#125;\|%&#123;WORD:resouceid&#125;\|%&#123;MYAPPNAME:type&#125;\|%&#123;GREEDYDATA:object&#125;"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">kv</span> &#123;</span><br><span class="line">        <span class="attr">source</span> =&gt; <span class="string">"object"</span></span><br><span class="line">        <span class="attr">field_split</span> =&gt; <span class="string">"&amp;"</span></span><br><span class="line">        <span class="attr">value_split</span> =&gt; <span class="string">"="</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">date</span> &#123;</span><br><span class="line">      <span class="attr">match</span> =&gt; [<span class="string">"logTime"</span>,<span class="string">"yyyy-MM-dd HH:mm:ss.SSS Z"</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">date</span> &#123;</span><br><span class="line">      <span class="attr">match</span> =&gt; [<span class="string">"logTime"</span>,<span class="string">"yyyy-MM-dd HH:mm:ss.SSS"</span>]</span><br><span class="line">      <span class="attr">target</span> =&gt; <span class="string">"timestamp"</span></span><br><span class="line">      <span class="attr">locale</span> =&gt; <span class="string">"en"</span></span><br><span class="line">      <span class="attr">timezone</span> =&gt; <span class="string">"+08:00"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">mutate</span> &#123;</span><br><span class="line">      <span class="attr">remove_field</span> =&gt; <span class="string">"message"</span></span><br><span class="line">      <span class="attr">remove_field</span> =&gt; <span class="string">"logTime"</span></span><br><span class="line">      <span class="attr">remove_field</span> =&gt; <span class="string">"@version"</span></span><br><span class="line">      <span class="attr">remove_field</span> =&gt; <span class="string">"host"</span></span><br><span class="line">      <span class="attr">remove_field</span> =&gt; <span class="string">"offset"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">##mysqlslowlogs</span></span><br><span class="line">  if [fields][docType] == <span class="string">"mysqlslowlogs"</span> &#123;</span><br><span class="line">    <span class="keyword">grok</span> &#123;</span><br><span class="line">        <span class="attr">match</span> =&gt; [</span><br><span class="line">          <span class="string">"message"</span>, <span class="string">"^#\s+User@Host:\s+%&#123;USER:user&#125;\[[^\]]+\]\s+@\s+(?:(?&lt;clienthost&gt;\S*) )?\[(?:%&#123;IP:clientip&#125;)?\]\s+Id:\s+%&#123;NUMBER:id&#125;\n# Query_time: %&#123;NUMBER:query_time&#125;\s+Lock_time: %&#123;NUMBER:lock_time&#125;\s+Rows_sent: %&#123;NUMBER:rows_sent&#125;\s+Rows_examined: %&#123;NUMBER:rows_examined&#125;\nuse\s(?&lt;dbname&gt;\w+);\nSET\s+timestamp=%&#123;NUMBER:timestamp_mysql&#125;;\n(?&lt;query_str&gt;[\s\S]*)"</span>,</span><br><span class="line">          <span class="string">"message"</span>, <span class="string">"^#\s+User@Host:\s+%&#123;USER:user&#125;\[[^\]]+\]\s+@\s+(?:(?&lt;clienthost&gt;\S*) )?\[(?:%&#123;IP:clientip&#125;)?\]\s+Id:\s+%&#123;NUMBER:id&#125;\n# Query_time: %&#123;NUMBER:query_time&#125;\s+Lock_time: %&#123;NUMBER:lock_time&#125;\s+Rows_sent: %&#123;NUMBER:rows_sent&#125;\s+Rows_examined: %&#123;NUMBER:rows_examined&#125;\nSET\s+timestamp=%&#123;NUMBER:timestamp_mysql&#125;;\n(?&lt;query_str&gt;[\s\S]*)"</span>,</span><br><span class="line">          <span class="string">"message"</span>, <span class="string">"^#\s+User@Host:\s+%&#123;USER:user&#125;\[[^\]]+\]\s+@\s+(?:(?&lt;clienthost&gt;\S*) )?\[(?:%&#123;IP:clientip&#125;)?\]\n# Query_time: %&#123;NUMBER:query_time&#125;\s+Lock_time: %&#123;NUMBER:lock_time&#125;\s+Rows_sent: %&#123;NUMBER:rows_sent&#125;\s+Rows_examined: %&#123;NUMBER:rows_examined&#125;\nuse\s(?&lt;dbname&gt;\w+);\nSET\s+timestamp=%&#123;NUMBER:timestamp_mysql&#125;;\n(?&lt;query_str&gt;[\s\S]*)"</span>,</span><br><span class="line">          <span class="string">"message"</span>, <span class="string">"^#\s+User@Host:\s+%&#123;USER:user&#125;\[[^\]]+\]\s+@\s+(?:(?&lt;clienthost&gt;\S*) )?\[(?:%&#123;IP:clientip&#125;)?\]\n# Query_time: %&#123;NUMBER:query_time&#125;\s+Lock_time: %&#123;NUMBER:lock_time&#125;\s+Rows_sent: %&#123;NUMBER:rows_sent&#125;\s+Rows_examined: %&#123;NUMBER:rows_examined&#125;\nSET\s+timestamp=%&#123;NUMBER:timestamp_mysql&#125;;\n(?&lt;query_str&gt;[\s\S]*)"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">date</span> &#123;</span><br><span class="line">      <span class="attr">match</span> =&gt; [<span class="string">"timestamp_mysql"</span>,<span class="string">"yyyy-MM-dd HH:mm:ss.SSS"</span>,<span class="string">"UNIX"</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">date</span> &#123;</span><br><span class="line">      <span class="attr">match</span> =&gt; [<span class="string">"timestamp_mysql"</span>,<span class="string">"yyyy-MM-dd HH:mm:ss.SSS"</span>,<span class="string">"UNIX"</span>]</span><br><span class="line">      <span class="attr">target</span> =&gt; <span class="string">"timestamp"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">mutate</span> &#123;</span><br><span class="line">      <span class="attr">convert</span> =&gt; [<span class="string">"query_time"</span>, <span class="string">"float"</span>]</span><br><span class="line">      <span class="attr">convert</span> =&gt; [<span class="string">"lock_time"</span>, <span class="string">"float"</span>]</span><br><span class="line">      <span class="attr">convert</span> =&gt; [<span class="string">"rows_sent"</span>, <span class="string">"integer"</span>]</span><br><span class="line">      <span class="attr">convert</span> =&gt; [<span class="string">"rows_examined"</span>, <span class="string">"integer"</span>]</span><br><span class="line">      <span class="attr">remove_field</span> =&gt; <span class="string">"message"</span></span><br><span class="line">      <span class="attr">remove_field</span> =&gt; <span class="string">"timestamp_mysql"</span></span><br><span class="line">      <span class="attr">remove_field</span> =&gt; <span class="string">"@version"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">####audit-log</span></span><br><span class="line">  if [fields][docType] == <span class="string">"audit-log"</span> &#123;</span><br><span class="line">    <span class="keyword">grok</span> &#123;</span><br><span class="line">      <span class="attr">patterns_dir</span> =&gt; [<span class="string">"/home/logstash-7.8.0/config/patterns"</span>]</span><br><span class="line">      <span class="attr">match</span> =&gt; &#123;</span><br><span class="line">        <span class="string">"message"</span> =&gt; <span class="string">"%&#123;TIMESTAMP_ISO8601:logTime&#125;\|%&#123;MYAPPNAME:appName&#125;\|%&#123;MYTHREADNAME:className&#125;\|%&#123;WORD:methodName&#125;\|%&#123;MYAPPNAME:userId&#125;\|%&#123;MYAPPNAME:userName&#125;\|%&#123;MYAPPNAME:clientId&#125;\|%&#123;GREEDYDATA:operation&#125;"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">date</span> &#123;</span><br><span class="line">      <span class="attr">match</span> =&gt; [<span class="string">"logTime"</span>,<span class="string">"yyyy-MM-dd HH:mm:ss.SSS Z"</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">date</span> &#123;</span><br><span class="line">      <span class="attr">match</span> =&gt; [<span class="string">"logTime"</span>,<span class="string">"yyyy-MM-dd HH:mm:ss.SSS"</span>]</span><br><span class="line">      <span class="attr">target</span> =&gt; <span class="string">"timestamp"</span></span><br><span class="line">      <span class="attr">locale</span> =&gt; <span class="string">"en"</span></span><br><span class="line">      <span class="attr">timezone</span> =&gt; <span class="string">"+08:00"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">mutate</span> &#123;</span><br><span class="line">      <span class="attr">remove_field</span> =&gt; <span class="string">"message"</span></span><br><span class="line">      <span class="attr">remove_field</span> =&gt; <span class="string">"logTime"</span></span><br><span class="line">      <span class="attr">remove_field</span> =&gt; <span class="string">"@version"</span></span><br><span class="line">      <span class="attr">remove_field</span> =&gt; <span class="string">"host"</span></span><br><span class="line">      <span class="attr">remove_field</span> =&gt; <span class="string">"offset"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试标准输入输出</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">./bin/logstash -e <span class="string">'input &#123; stdin &#123;&#125; &#125; output &#123; stdout &#123; codec =&gt; rubydebug&#125; &#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#输入</span></span><br><span class="line">hellword</span><br><span class="line"></span><br><span class="line"><span class="comment">#输出结果</span></span><br><span class="line">&#123;</span><br><span class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</span><br><span class="line">          <span class="string">"host"</span> =&gt; <span class="string">"iZ2zehsi01vpevu3usi6etZ"</span>,</span><br><span class="line">    <span class="string">"@timestamp"</span> =&gt; <span class="number">2020</span><span class="number">-07</span><span class="number">-09</span>T02:<span class="number">49</span>:<span class="number">10.957</span>Z,</span><br><span class="line">       <span class="string">"message"</span> =&gt; <span class="string">"helloword"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试输出到文件</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">./bin/logstash -e <span class="string">'input &#123; stdin&#123;&#125; &#125; output &#123; file &#123; path =&gt; "/tmp/log-%&#123;+YYYY.MM.dd&#125;messages.gz"&#125;&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#输入</span></span><br><span class="line">hellword</span><br><span class="line"></span><br><span class="line"><span class="comment">#输出结果</span></span><br><span class="line">tail /tmp/<span class="keyword">log</span>-<span class="number">2020.07</span>.09messages.gz </span><br><span class="line"></span><br><span class="line">&#123;<span class="string">"host"</span>:<span class="string">"iZ2zehsi01vpevu3usi6etZ"</span>,<span class="string">"message"</span>:<span class="string">"helloword"</span>,<span class="string">"@version"</span>:<span class="string">"1"</span>,<span class="string">"@timestamp"</span>:<span class="string">"2020-07-09T02:50:01.682Z"</span>&#125;</span><br></pre></td></tr></table></figure>

<p>测试输出到elasticsearch</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./bin/logstash -e 'input &#123;  stdin&#123;&#125; &#125; output &#123; elasticsearch &#123;hosts =&gt; [<span class="string">"172.17.53.225:9100"</span>] index =&gt; <span class="string">"mytest-%&#123;+YYYY.MM.dd&#125;"</span> &#125;&#125;'</span><br><span class="line"></span><br><span class="line"><span class="meta">#在es服务目录查看</span></span><br><span class="line"><span class="title">ll</span> /home/elasticsearch/<span class="class"><span class="keyword">data</span>/nodes/0/indices/</span></span><br><span class="line"><span class="title">total</span> <span class="number">4</span></span><br><span class="line"><span class="title">drwxr</span>-xr-x <span class="number">4</span> es es <span class="number">4096</span> <span class="type">Jul</span>  <span class="number">9</span> <span class="number">10</span>:<span class="number">55</span> mKYuiHd9Tj-qIH_h1sda9A</span><br></pre></td></tr></table></figure>

<p>创建模版</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT http://<span class="number">172.17</span>.<span class="number">53.226</span>:<span class="number">9101</span>/_template/template_sys_log -d '</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"index_patterns"</span> : ["<span class="type">sys</span>-log-*<span class="string">"],</span></span><br><span class="line"><span class="string">"</span>order<span class="string">" : 0,</span></span><br><span class="line"><span class="string">"</span>settings<span class="string">" : &#123;</span></span><br><span class="line"><span class="string">"</span>number_of_replicas<span class="string">" : 0</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"</span>mappings<span class="string">": &#123;</span></span><br><span class="line"><span class="string">"</span>properties<span class="string">": &#123;</span></span><br><span class="line"><span class="string">"</span>message<span class="string">": &#123;</span></span><br><span class="line"><span class="string">"</span><span class="keyword">type</span><span class="string">": "</span>text<span class="string">",</span></span><br><span class="line"><span class="string">"</span>fields<span class="string">": &#123;</span></span><br><span class="line"><span class="string">"</span>keyword<span class="string">": &#123;</span></span><br><span class="line"><span class="string">"</span><span class="keyword">type</span><span class="string">": "</span>keyword<span class="string">",</span></span><br><span class="line"><span class="string">"</span>ignore_above<span class="string">": 256</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"</span>analyzer<span class="string">": "</span>ik_max_word<span class="string">"</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"</span>pid<span class="string">": &#123;</span></span><br><span class="line"><span class="string">"</span><span class="keyword">type</span><span class="string">": "</span>text<span class="string">"</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"</span>serverPort<span class="string">": &#123;</span></span><br><span class="line"><span class="string">"</span><span class="keyword">type</span><span class="string">": "</span>text<span class="string">"</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"</span>logLevel<span class="string">": &#123;</span></span><br><span class="line"><span class="string">"</span><span class="keyword">type</span><span class="string">": "</span>text<span class="string">"</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"</span>traceId<span class="string">": &#123;</span></span><br><span class="line"><span class="string">"</span><span class="keyword">type</span><span class="string">": "</span>text<span class="string">"</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;' --header "</span>Content-<span class="keyword">Type</span>: application/json<span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">curl -XPUT http://172.17.53.226:9101/_template/template_point_log -d '</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"</span>index_patterns<span class="string">" : ["</span>point-log-*<span class="string">"],</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"</span>order<span class="string">" : 0,</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"</span>settings<span class="string">" : &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"</span>number_of_replicas<span class="string">" : 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125;' --header "</span>Content-<span class="keyword">Type</span>: application/json<span class="string">"</span></span><br></pre></td></tr></table></figure>

<p>在config目录下创建patterns目录,在目录下创建mepattern.txt</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># user-center</span><br><span class="line">MYAPPNAME ([<span class="number">0</span><span class="number">-9</span>a-zA-Z_-]*)</span><br><span class="line"># RMI TCP Connection(<span class="number">2</span>)<span class="number">-127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">MYTHREADNAME ([<span class="number">0</span><span class="number">-9</span>a-zA-Z._-]|\(|\)|\s)*</span><br></pre></td></tr></table></figure>

<p>在bin目录下启动</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">./logstash</span> -f logstash.conf</span><br></pre></td></tr></table></figure>

<h5 id="同步mysql"><a href="#同步mysql" class="headerlink" title="同步mysql"></a>同步mysql</h5><p>需要依赖mysql-connector-java-5.1.49.jar</p>
<p>在bin目录下创建jdbc.conf配置索引</p>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 输入部分</span></span><br><span class="line"><span class="keyword">input</span> &#123;</span><br><span class="line">  stdin &#123;&#125;</span><br><span class="line">  <span class="keyword">jdbc</span> &#123;</span><br><span class="line">    <span class="attr">jdbc_default_timezone</span> =&gt;<span class="string">"Asia/Shanghai"</span> </span><br><span class="line">   </span><br><span class="line">    <span class="comment"># mysql数据库驱动</span></span><br><span class="line">    <span class="attr">jdbc_driver_library</span> =&gt; <span class="string">"//root/mysql-connector-java-5.1.49.jar"</span></span><br><span class="line">    <span class="attr">jdbc_driver_class</span> =&gt; <span class="string">"com.mysql.jdbc.Driver"</span></span><br><span class="line">    <span class="comment"># mysql数据库链接，数据库名</span></span><br><span class="line">    <span class="attr">jdbc_connection_string</span> =&gt; <span class="string">"jdbc:mysql://219.128.77.86:7000/nethospital"</span></span><br><span class="line">    <span class="comment"># mysql数据库用户名，密码</span></span><br><span class="line">    <span class="attr">jdbc_user</span> =&gt; <span class="string">"hospitalTest"</span></span><br><span class="line">    <span class="attr">jdbc_password</span> =&gt; <span class="string">"Liangjian123360@8899"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置监听间隔  各字段含义（分、时、天、月、年），全部为*默认含义为每分钟更新一次</span></span><br><span class="line">    <span class="attr">schedule</span> =&gt; <span class="string">"* * * * *"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 分页</span></span><br><span class="line">    <span class="attr">jdbc_paging_enabled</span> =&gt; <span class="string">"true"</span></span><br><span class="line">    <span class="comment"># 分页大小</span></span><br><span class="line">    <span class="attr">jdbc_page_size</span> =&gt; <span class="string">"50000"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># sql语句执行文件，也可直接使用sql</span></span><br><span class="line">        <span class="attr">statement</span> =&gt; <span class="string">'select id,name,level,hospital_phone,update_time from h_hospital_outer WHERE update_time&gt;=:sql_last_value order by update_time asc'</span></span><br><span class="line">    <span class="comment"># statement_filepath =&gt; "/usr/local/logstash-6.4.2/config/jdbc.sql"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># elasticsearch索引类型名</span></span><br><span class="line">    <span class="attr">type</span> =&gt; <span class="string">"hospital_outer_index"</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 是否记录上次执行结果，true表示会将上次执行结果的tracking_column字段的值保存到last_run_metadata_path指定的文件中；</span></span><br><span class="line">        <span class="attr">record_last_run</span> =&gt; <span class="keyword">true</span></span><br><span class="line">        <span class="comment"># 需要记录查询结果某字段的值时，此字段为true。</span></span><br><span class="line">        <span class="attr">use_column_value</span> =&gt; <span class="keyword">true</span></span><br><span class="line">        <span class="comment"># 需要记录的字段，用于增量同步，需是数据库字段</span></span><br><span class="line">        <span class="attr">tracking_column</span> =&gt; <span class="string">"update_time"</span></span><br><span class="line">        <span class="comment"># 递增字段的类型，numeric 表示数值类型, timestamp 表示时间戳类型</span></span><br><span class="line">        <span class="attr">tracking_column_type</span> =&gt; timestamp</span><br><span class="line">        <span class="comment"># 同步点文件，这个文件记录了上次的同步点，重启时会读取这个文件，这个文件可以手动修改</span></span><br><span class="line">        <span class="attr">last_run_metadata_path</span> =&gt; <span class="string">"/opt/logstash-7.8.0/config/hospital_outer_index_id"</span></span><br><span class="line">        <span class="comment"># 是否清除last_run_metadata_path的记录，需要增量同步时此字段必须为false；</span></span><br><span class="line">        <span class="attr">clean_run</span> =&gt; <span class="keyword">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">input</span> &#123;</span><br><span class="line">  stdin &#123;&#125;</span><br><span class="line">  <span class="keyword">jdbc</span> &#123;</span><br><span class="line">    <span class="attr">jdbc_default_timezone</span> =&gt;<span class="string">"Asia/Shanghai"</span> </span><br><span class="line">          </span><br><span class="line">    <span class="comment"># mysql数据库驱动</span></span><br><span class="line">    <span class="attr">jdbc_driver_library</span> =&gt; <span class="string">"//root/mysql-connector-java-5.1.49.jar"</span></span><br><span class="line">    <span class="attr">jdbc_driver_class</span> =&gt; <span class="string">"com.mysql.jdbc.Driver"</span></span><br><span class="line">    <span class="comment"># mysql数据库链接，数据库名</span></span><br><span class="line">    <span class="attr">jdbc_connection_string</span> =&gt; <span class="string">"jdbc:mysql://219.128.77.86:7000/nethospital"</span></span><br><span class="line">    <span class="comment"># mysql数据库用户名，密码</span></span><br><span class="line">    <span class="attr">jdbc_user</span> =&gt; <span class="string">"hospitalTest"</span></span><br><span class="line">    <span class="attr">jdbc_password</span> =&gt; <span class="string">"Liangjian123360@8899"</span></span><br><span class="line">    <span class="comment"># 设置监听间隔  各字段含义（分、时、天、月、年），全部为*默认含义为每分钟更新一次</span></span><br><span class="line">    <span class="attr">schedule</span> =&gt; <span class="string">"0 2 * * *"</span></span><br><span class="line">    <span class="comment"># 分页</span></span><br><span class="line">    <span class="attr">jdbc_paging_enabled</span> =&gt; <span class="string">"true"</span></span><br><span class="line">    <span class="comment"># 分页大小</span></span><br><span class="line">    <span class="attr">jdbc_page_size</span> =&gt; <span class="string">"50000"</span></span><br><span class="line">    <span class="comment"># sql语句执行文件，也可直接使用 statement =&gt; 'select * from h_hospital_outer'</span></span><br><span class="line">        <span class="attr">statement</span> =&gt; <span class="string">'select id,name,level,hospital_phone from h_hospital_outer'</span></span><br><span class="line">    <span class="comment"># statement_filepath =&gt; "/usr/local/logstash-6.4.2/config/jdbc.sql"</span></span><br><span class="line">    <span class="comment"># elasticsearch索引类型名</span></span><br><span class="line">    <span class="attr">type</span> =&gt; <span class="string">"hospital_outer_index"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 过滤部分(不是必须项）</span></span><br><span class="line"><span class="keyword">filter</span> &#123;</span><br><span class="line">    ruby &#123; </span><br><span class="line">                <span class="attr">code</span> =&gt; <span class="string">"event.set('timestamp', event.get('@timestamp').time.localtime + 8*60*60)"</span> </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">ruby</span> &#123;</span><br><span class="line">                <span class="attr">code</span> =&gt; <span class="string">"event.set('@timestamp',event.get('timestamp'))"</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">ruby</span> &#123;</span><br><span class="line">                <span class="attr">code</span> =&gt; <span class="string">"event.set('update_time',event.get('timestamp'))"</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">ruby</span> &#123;</span><br><span class="line">                <span class="attr">code</span> =&gt; <span class="string">"event.set('create_time',event.get('timestamp'))"</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">mutate</span> &#123;</span><br><span class="line">                <span class="attr">remove_field</span> =&gt; [<span class="string">"timestamp"</span>]</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出部分</span></span><br><span class="line"><span class="keyword">output</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>  [<span class="built_in">type</span>] == <span class="string">"hospital_outer_index"</span> &#123;</span><br><span class="line">                elasticsearch &#123;</span><br><span class="line">                        <span class="comment"># elasticsearch索引名</span></span><br><span class="line">                        <span class="attr">index</span> =&gt; <span class="string">"hospital_outer_index"</span></span><br><span class="line">                        <span class="comment"># 使用input中的type作为elasticsearch索引下的类型名</span></span><br><span class="line">                        <span class="attr">document_type</span> =&gt; <span class="string">"%&#123;type&#125;"</span>   <span class="comment"># &lt;- use the type from each input</span></span><br><span class="line">                        <span class="comment"># elasticsearch的ip和端口号</span></span><br><span class="line">                        <span class="attr">hosts</span> =&gt; <span class="string">"192.168.50.60:9000"</span></span><br><span class="line">                        <span class="comment"># 同步mysql中数据id作为elasticsearch中文档id</span></span><br><span class="line">                        <span class="attr">document_id</span> =&gt; <span class="string">"%&#123;id&#125;"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">stdout</span> &#123;</span><br><span class="line">                <span class="attr">codec</span> =&gt; json_lines</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在bin目录下启动</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">./logstash</span> -f jdbc.conf</span><br></pre></td></tr></table></figure>

<h5 id="遇到的报错-1"><a href="#遇到的报错-1" class="headerlink" title="遇到的报错"></a>遇到的报错</h5><p>Error: Bad file descriptor - Bad file descriptor Exception错误</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">查看data下的是否有.lock文件</span><br><span class="line">[root@es-1 ~]<span class="comment"># ls -all /opt/logstash-7.8.0/data/</span></span><br><span class="line">total 4</span><br><span class="line">drwxr-xr-x. <span class="number"> 4 </span><span class="number"> 631 </span><span class="number"> 503 </span><span class="number"> 69 </span>Nov<span class="number"> 13 </span>12:58 .</span><br><span class="line">drwxr-xr-x.<span class="number"> 12 </span><span class="number"> 631 </span><span class="number"> 503 </span>253 Nov<span class="number"> 12 </span>17:31 ..</span><br><span class="line">drwxr-xr-x. <span class="number"> 2 </span>root root  <span class="number"> 6 </span>Nov<span class="number"> 12 </span>17:31 dead_letter_queue</span><br><span class="line">-rw-r--r--. <span class="number"> 1 </span>root root  <span class="number"> 0 </span>Nov<span class="number"> 13 </span>12:58 .lock</span><br><span class="line">drwxr-xr-x. <span class="number"> 2 </span>root root  <span class="number"> 6 </span>Nov<span class="number"> 12 </span>17:31 queue</span><br><span class="line">-rw-r--r--. <span class="number"> 1 </span>root root <span class="number"> 36 </span>Nov<span class="number"> 12 </span>17:31 uuid</span><br><span class="line"></span><br><span class="line">删除.lock文件重新启动即可</span><br></pre></td></tr></table></figure>

<p>日志出现报错:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[logstash<span class="selector-class">.outputs</span><span class="selector-class">.elasticsearch</span>] retrying failed action with response <span class="selector-tag">code</span>: <span class="number">403</span> (&#123;<span class="string">"type"</span>=&gt;<span class="string">"cluster_block_exception"</span>, <span class="string">"reason"</span>=&gt;<span class="string">"blocked by: [FORBIDDEN/12/index read-only / allow delete (api)];"</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>ES说明文档:当ES数据所在目录磁盘空间使用率超过90%后，ES将修改为只读状态，所以初步判断是磁盘空间不足导致ES不允许写入。</p>
<p>解决:</p>
<p>服务器磁盘空间导致,清理服务器磁盘空间还是出现该报错问题</p>
<p>怀疑为es索引导致的不能同步数据</p>
<p><strong>解决办法1 在kibana开发控制台执行下面语句即可</strong></p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PUT</span> _settings</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="string">"index"</span>: &#123;</span><br><span class="line">    <span class="string">"blocks"</span>: &#123;</span><br><span class="line">    <span class="string">"read_only_allow_delete"</span>: <span class="string">"false"</span></span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>解决方法2</strong></p>
<p>如果kibana无法执行命令，可以使用下面命令解决</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT -H <span class="string">"Content-Type: application/json"</span> http:<span class="regexp">//</span>localhost:<span class="number">9200</span><span class="regexp">/_all/</span>_settings -d <span class="string">'&#123;"index.blocks.read_only_allow_delete": null&#125;'</span></span><br></pre></td></tr></table></figure>

<p>查看索引</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl http://192.168.50.70:9200/_cat/indices?v</span><br><span class="line">health status index                uuid                   pri rep docs.count docs.deleted store.size pri.store.size</span><br><span class="line">yellow open   h_hospital_outer     N4hbdo5TQnSazNx58_a5Qg  <span class="number"> 5 </span> <span class="number"> 1 </span>   <span class="number"> 433934 </span>     <span class="number"> 126728 </span>   161.3mb        161.3mb</span><br><span class="line">yellow open   m_medicine_info      swwieAn-TNG3FTTvpOlxwg  <span class="number"> 5 </span> <span class="number"> 1 </span>    <span class="number"> 36556 </span>       <span class="number"> 1699 </span>    41.3mb         41.3mb</span><br><span class="line">green  open   .kibana_1            OQh5HFwsRDSG0QAPKasZyg  <span class="number"> 1 </span> <span class="number"> 0 </span>        <span class="number"> 1 </span>          <span class="number"> 0 </span>     3.7kb          3.7kb</span><br><span class="line">yellow open   recommend_doctor_rsp vpIMBifjSySYU6h0j9nM-A  <span class="number"> 5 </span> <span class="number"> 1 </span>      <span class="number"> 609 </span>          <span class="number"> 1 </span>   983.8kb        983.8kb</span><br></pre></td></tr></table></figure>

<p>删除索引</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -XDELETE <span class="string">localhost:</span><span class="number">9200</span>/索引名</span><br><span class="line">例如:</span><br><span class="line">curl -XDELETE <span class="string">http:</span><span class="comment">//192.168.50.70:9200/m_medicine_info</span></span><br><span class="line">curl -XDELETE <span class="string">http:</span><span class="comment">//192.168.50.70:9200/h_hospital_outer</span></span><br><span class="line">curl -XDELETE <span class="string">http:</span><span class="comment">//192.168.50.70:9200/recommend_doctor_rsp</span></span><br><span class="line">curl -XDELETE <span class="string">http:</span><span class="comment">//192.168.50.70:9200/.kibana_1</span></span><br></pre></td></tr></table></figure>

<p>再次启动logstash,无报错,跟生产索引进行对比发现,有缺少,使用接口进行触发</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">es服务</span><br><span class="line">医生模板生成接口：<span class="regexp">/api/</span>es<span class="regexp">/doctor/</span>refreshIndexAndDate</span><br><span class="line">视频<span class="regexp">/文章模板生成接口：/</span>app<span class="regexp">/video/</span>article/refreshIndexAndDate</span><br><span class="line">视频模板生成接口(已未使用):<span class="regexp">/app/</span>video/refreshIndexAndDate</span><br><span class="line"></span><br><span class="line">请求示例:</span><br><span class="line">curl <span class="string">http:</span><span class="comment">//127.0.0.1:8908/app/video/article/refreshIndexAndDate</span></span><br><span class="line"></span><br><span class="line">job服务</span><br><span class="line">医生es全量同步:<span class="regexp">/job/</span>doctor/synAllDoctorDates</span><br><span class="line">视频<span class="regexp">/文章全量同步:/</span>job<span class="regexp">/video/</span>article/synAll</span><br><span class="line">视频全量同步: <span class="regexp">/job/</span>ljVideo/synAllVideo</span><br><span class="line"></span><br><span class="line">请求示例:</span><br><span class="line">curl <span class="string">http:</span><span class="comment">//127.0.0.1:8092/job/doctor/synAllDoctorDates</span></span><br></pre></td></tr></table></figure>

<p>在容器的终端进行触发时,出现错误</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Elasticsearch：None <span class="keyword">of</span> the configured nodes are available:[&#123;#transport#<span class="number">-1</span>&#125;</span><br></pre></td></tr></table></figure>

<p>排查问题发现,通过nginx外放的端口映射为192.168.50.70:9200.</p>
<p>9200 是ES节点与外部通讯使用的端口。它是http协议的RESTful接口,各种CRUD操作都是走的该端口</p>
<p>9300是ES节点之间通讯使用的端口。它是tcp通讯端口，集群间和TCPclient都走的它。java程序中使用ES时，在配置文件中要配置该端口</p>
<p>更改nginx的端口映射为9300</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">stream &#123;</span><br><span class="line">    upstream es &#123;</span><br><span class="line">      <span class="built_in"> server </span>192.168.50.70:9300 <span class="attribute">weight</span>=1 <span class="attribute">max_fails</span>=2 <span class="attribute">fail_timeout</span>=120s;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="built_in"> server </span>&#123;</span><br><span class="line">        listen  3304;</span><br><span class="line">        proxy_connect_timeout 10s;</span><br><span class="line">        proxy_timeout 300s;#设置客户端和代理服务之间的超时时间，如果5分钟内没操作将自动断开。</span><br><span class="line">        proxy_pass es;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后端再次请求接口同步数据正常</p>
<p>再次查看索引,索引都已经正常创建</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@monitor ~]<span class="comment"># curl http://192.168.50.70:9200/_cat/indices?v</span></span><br><span class="line">health status index                uuid                   pri rep docs.count docs.deleted store.size pri.store.size</span><br><span class="line">yellow open   app_video_article    -tQTMGs4SCKoLtNMJf-Aqw  <span class="number"> 5 </span> <span class="number"> 1 </span>     <span class="number"> 2282 </span>          <span class="number"> 0 </span>     2.2mb          2.2mb</span><br><span class="line">yellow open   h_hospital_outer     N4hbdo5TQnSazNx58_a5Qg  <span class="number"> 5 </span> <span class="number"> 1 </span>   <span class="number"> 433934 </span>     <span class="number"> 126728 </span>   161.3mb        161.3mb</span><br><span class="line">yellow open   m_medicine_info      swwieAn-TNG3FTTvpOlxwg  <span class="number"> 5 </span> <span class="number"> 1 </span>    <span class="number"> 36556 </span>       <span class="number"> 1699 </span>    41.3mb         41.3mb</span><br><span class="line">green  open   .kibana_1            OQh5HFwsRDSG0QAPKasZyg  <span class="number"> 1 </span> <span class="number"> 0 </span>        <span class="number"> 1 </span>          <span class="number"> 0 </span>     3.7kb          3.7kb</span><br><span class="line">yellow open   recommend_doctor_rsp vpIMBifjSySYU6h0j9nM-A  <span class="number"> 5 </span> <span class="number"> 1 </span>      <span class="number"> 609 </span>          <span class="number"> 1 </span>   983.8kb        983.8kb</span><br><span class="line">yellow open   mini_doctor_list     q0DGDN1_SZeIXyAeTNu8Dw  <span class="number"> 5 </span> <span class="number"> 1 </span>        <span class="number"> 0 </span>          <span class="number"> 0 </span>     1.2kb          1.2kb</span><br></pre></td></tr></table></figure>

<h4 id="filebeat"><a href="#filebeat" class="headerlink" title="filebeat"></a>filebeat</h4><h5 id="下载-4"><a href="#下载-4" class="headerlink" title="下载"></a>下载</h5><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="regexp">//mi</span>rrors.huaweicloud.com<span class="regexp">/filebeat/</span><span class="number">7.8</span>.<span class="number">0</span><span class="regexp">/filebeat-7.8.0-x86_64.rpm</span></span><br></pre></td></tr></table></figure>

<h5 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h5><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">rpm</span> <span class="selector-tag">-Uvh</span> <span class="selector-tag">filebeat-7</span><span class="selector-class">.8</span><span class="selector-class">.0-x86_64</span><span class="selector-class">.rpm</span></span><br></pre></td></tr></table></figure>

<p>配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vi</span> <span class="string">/etc/filebeat/filebeat.yml</span></span><br><span class="line"></span><br><span class="line"><span class="string">filebeat.inputs:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- type:</span> <span class="string">log</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 检查文件更新的频率，默认是 10s</span></span><br><span class="line"><span class="attr">  scan_frequency:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line">  <span class="comment">#忽略过去 ignore_older 时间没有修改的文件,0(禁用),2h(2小时),5m(5分钟),168h(1周)</span></span><br><span class="line"><span class="attr">  ignore_older:</span> <span class="number">0</span></span><br><span class="line">  <span class="comment"># 关闭过去 close_inactive 时间非活动状态的文件的 harvester</span></span><br><span class="line"><span class="attr">  close_inactive:</span> <span class="number">2</span><span class="string">m</span></span><br><span class="line">  <span class="comment">#单文件最大收集的字节数,超过将被丢弃，默认10MB=10485760，60MB=62914560,必须大于单文件最大大小</span></span><br><span class="line"><span class="attr">  max_bytes:</span> <span class="number">62914560</span></span><br><span class="line">  <span class="comment">#每个harvester在获取文件时使用的缓冲区大小字节数，默认值是16384,1MB=1048576‬</span></span><br><span class="line"><span class="attr">  harvester_buffer_size:</span> <span class="number">1048576</span><span class="string">‬</span></span><br><span class="line"><span class="attr">  paths:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/var/log/java/*/app.*log</span></span><br><span class="line">  <span class="comment">#exclude_lines: ['\s^DEBUG\s\d']</span></span><br><span class="line">  <span class="comment">#fields_under_root: true</span></span><br><span class="line"><span class="attr">  fields:</span></span><br><span class="line"><span class="attr">    docType:</span> <span class="string">sys-log</span></span><br><span class="line"><span class="attr">    project:</span> <span class="string">microservices-platform</span></span><br><span class="line"><span class="attr">  multiline:</span></span><br><span class="line">    <span class="comment">#pattern: '^\[\S+:\S+:\d&#123;2,&#125;] '</span></span><br><span class="line"><span class="attr">    pattern:</span> <span class="string">'^\['</span></span><br><span class="line"><span class="attr">    negate:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    match:</span> <span class="string">after</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">- type:</span> <span class="string">log</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 检查文件更新的频率，默认是 10s</span></span><br><span class="line"><span class="attr">  scan_frequency:</span> <span class="number">15</span><span class="string">s</span></span><br><span class="line">  <span class="comment">#忽略过去 ignore_older 时间没有修改的文件,0(禁用),2h(2小时),5m(5分钟),168h(1周)</span></span><br><span class="line"><span class="attr">  ignore_older:</span> <span class="number">0</span></span><br><span class="line">  <span class="comment"># 关闭过去 close_inactive 时间非活动状态的文件的 harvester</span></span><br><span class="line"><span class="attr">  close_inactive:</span> <span class="number">2</span><span class="string">m</span></span><br><span class="line">  <span class="comment">#单文件最大收集的字节数,超过将被丢弃，默认10MB=10485760，60MB=62914560,必须大于单文件最大大小</span></span><br><span class="line"><span class="attr">  max_bytes:</span> <span class="number">62914560</span></span><br><span class="line">  <span class="comment">#每个harvester在获取文件时使用的缓冲区大小字节数，默认值是16384,1MB=1048576‬</span></span><br><span class="line"><span class="attr">  harvester_buffer_size:</span> <span class="number">1048576</span><span class="string">‬</span></span><br><span class="line"><span class="attr">  paths:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/var/log/java/*/point.*log</span></span><br><span class="line">  <span class="comment">#fields_under_root: true</span></span><br><span class="line"><span class="attr">  fields:</span></span><br><span class="line"><span class="attr">    docType:</span> <span class="string">point-log</span></span><br><span class="line"><span class="attr">    project:</span> <span class="string">microservices-platform</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">- type:</span> <span class="string">log</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 检查文件更新的频率，默认是 10s</span></span><br><span class="line"><span class="attr">  scan_frequency:</span> <span class="number">20</span><span class="string">s</span></span><br><span class="line">  <span class="comment">#忽略过去 ignore_older 时间没有修改的文件,0(禁用),2h(2小时),5m(5分钟),168h(1周)</span></span><br><span class="line"><span class="attr">  ignore_older:</span> <span class="number">0</span></span><br><span class="line">  <span class="comment"># 关闭过去 close_inactive 时间非活动状态的文件的 harvester</span></span><br><span class="line"><span class="attr">  close_inactive:</span> <span class="number">2</span><span class="string">m</span></span><br><span class="line">  <span class="comment">#单文件最大收集的字节数,超过将被丢弃，默认10MB=10485760，60MB=62914560,必须大于单文件最大大小</span></span><br><span class="line"><span class="attr">  max_bytes:</span> <span class="number">62914560</span></span><br><span class="line">  <span class="comment">#每个harvester在获取文件时使用的缓冲区大小字节数，默认值是16384,1MB=1048576‬</span></span><br><span class="line"><span class="attr">  harvester_buffer_size:</span> <span class="number">1048576</span><span class="string">‬</span></span><br><span class="line"><span class="attr">  paths:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/var/log/java/*/audit.*log</span></span><br><span class="line">  <span class="comment">#fields_under_root: true</span></span><br><span class="line"><span class="attr">  fields:</span></span><br><span class="line"><span class="attr">    docType:</span> <span class="string">audit-log</span></span><br><span class="line"><span class="attr">    project:</span> <span class="string">microservices-platform</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">#filebeat全局配置</span></span><br><span class="line"><span class="attr">max_procs:</span> <span class="number">1</span></span><br><span class="line"><span class="string">queue.mem:</span></span><br><span class="line">  <span class="comment">#事件容量</span></span><br><span class="line"><span class="attr">  events:</span> <span class="number">4096</span></span><br><span class="line">  <span class="comment">#一次发送最小event数</span></span><br><span class="line">  <span class="string">flush.min_events:</span> <span class="number">512</span></span><br><span class="line">  <span class="comment">#一次发送最大min_events等待时间</span></span><br><span class="line">  <span class="string">flush.timeout:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"></span><br><span class="line"><span class="string">output.logstash:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># The Logstash hosts</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">["172.17.53.226:5044"]</span></span><br><span class="line"><span class="attr">  bulk_max_size:</span> <span class="number">2048</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line"><span class="attr">  - add_host_metadata:</span> <span class="string">~</span></span><br><span class="line"><span class="attr">  - add_cloud_metadata:</span> <span class="string">~</span></span><br><span class="line"><span class="attr">  - add_docker_metadata:</span> <span class="string">~</span></span><br><span class="line"><span class="attr">  - add_kubernetes_metadata:</span></span><br><span class="line">      <span class="string">default_indexers.enabled:</span> <span class="literal">false</span></span><br><span class="line">      <span class="string">default_matchers.enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h5 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">filebeat -c /etc/filebeat/filebeat<span class="selector-class">.yml</span> -e</span><br><span class="line"></span><br><span class="line">后台启动</span><br><span class="line">nohup filebeat -c /etc/filebeat/filebeat<span class="selector-class">.yml</span> -e &gt;filebeat<span class="selector-class">.log</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br></pre></td></tr></table></figure>

<h4 id="kibana"><a href="#kibana" class="headerlink" title="kibana"></a>kibana</h4><p>下载地址:<a href="https://www.elastic.co/cn/downloads/kibana-oss" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/kibana-oss</a><br>解压</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">tar</span> <span class="selector-tag">zxvf</span> <span class="selector-tag">kibana-oss-7</span><span class="selector-class">.8</span><span class="selector-class">.0-linux-x86_64</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br></pre></td></tr></table></figure>

<h5 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim kibana-oss-<span class="number">7.8</span>.<span class="number">0</span>-linux-x86_64/config/kibana<span class="selector-class">.ymlserver</span><span class="selector-class">.port</span>: <span class="number">5600</span>    #监听端口server<span class="selector-class">.host</span>: <span class="string">"172.17.53.226"</span>    #监听地址elasticsearch<span class="selector-class">.hosts</span>: [<span class="string">"http://172.17.53.225:9200"</span>,<span class="string">"http://172.17.53.226:9200"</span>] #elasticsearch服务器地址</span><br></pre></td></tr></table></figure>

<h5 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h5><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">./bin/kibana</span> <span class="params">--allow-root</span></span><br></pre></td></tr></table></figure>

<p><strong>Kibana是一个开源的分析和可视化平台，设计用于和Elasticsearch一起工作。</strong></p>
<ul>
<li>你用Kibana来搜索，查看，并和存储在Elasticsearch索引中的数据进行交互。</li>
<li>你可以轻松地执行高级数据分析，并且以各种图标、表格和地图的形式可视化数据。</li>
<li>Kibana使得理解大量数据变得很容易。它简单的、基于浏览器的界面使你能够快速创建和共享动态仪表板，实时显示Elasticsearch查询的变化。</li>
</ul>
<p><strong>Kibana可视化管理页面详细使用说明</strong></p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Discover：日志管理视图 </span>主要进行搜索和查询Visualize：统计视图 构建可视化的图表Dashboard：仪表视图 将构建的图表组合形成图表盘Dev Tools： 开发者命令视图 开发工具Management：管理视图 管理工具</span><br></pre></td></tr></table></figure>

<p><strong>简单查询</strong><br>点击discover，则会显示默认索引的空间，显示的数据默认是15分钟，你可以自己调整时间段后refresh刷新查询到你想要的数据。<br><img src="\image\5f16b919cf571.png"><br>默认情况下,列表会显示所有字段,在左侧的Available fields下方的字段选中add添加,则只显示你所选中的字段到列表中。<br><img src="\image\5f16b9c6b79d3.png"><br>save保存搜索条件<br><img src="\image\5f17b28256ac4.png"><br>open打开保存的搜索条件<br><img src="\image\5f17b26c3780b.png"><br><strong>自定义索引</strong><br>创建索引<br><img src="\image\5f16bd2e3b622.png"><br>输入日志名称(可通过正则匹配)<br><img src="\image\5f16bd669d4ac.png"><br><img src="\image\5f16bd9a241ec.png"><br>可查看所有字段<br><img src="\image\5f16bdc9b995c.png"><br>点击Discover可查看到新添加的索引<br><img src="\image\5f16bdf66aab1.png"><br>Visualize 创建可视化图表<br><img src="\image\5f16bfd8e2c2f.png"><br>Kibana自带有上10种图表,这里选择直方图📊<br><img src="\image\5f16c0138f4c3.png"><br>选择数据来源<br><img src="\image\5f16c7d5b235b.png"><br>默认已经有一个Y轴了，统计的是数量，我们添加一个X轴，点击Buckets下的Add<br><img src="\image\5f16c8377e70b.png"><br>我选择了<a href="https://github.com/timestamp" target="_blank" rel="noopener">@timestamp</a>字段作为x轴 然后Update<br><img src="\image\5f16c8c18cf67.png"><br>保存<br><img src="\image\5f16c8fe1622e.png"><br><strong>仪表盘</strong> 展示保存的可视化结果集合<br>创建一个Dashboard,展示上面定义好的图表<br><img src="\image\5f17af8cbf6d4.png"><br>添加已经存在的图表<br><img src="\image\5f17afa79b0a6.png"><br>添加完后保存即可<br><img src="\image\5f17aff2b7ccd.png"><br><strong>Dev Tools</strong> 可以看到Console命令行直接可以执行ES的REST风格API，右侧是查询的返回结果<br><img src="\image\5f16bad4c39a6.png"><br><strong>Management</strong><br>可对视图或搜索等删除和导入导出<br><img src="\image\5f17b36c51b37.png"><br>kibana可视化操作: <a href="https://www.cnblogs.com/ygunoil/p/13279514.html" target="_blank" rel="noopener">https://www.cnblogs.com/ygunoil/p/13279514.html</a><br>查询语法: <a href="https://www.cnblogs.com/chenqionghe/p/12501218.html" target="_blank" rel="noopener">https://www.cnblogs.com/chenqionghe/p/12501218.html</a></p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>nmk</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://nmk0718.github.io/2020/07/30/elasticsearch/">http://nmk0718.github.io/2020/07/30/elasticsearch/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2020 <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tag/elasticsearch/"># elasticsearch</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2020/07/30/运维架构/">运维架构</a>
            
            
            <a class="next" rel="next" href="/2020/07/16/nginx/">nginx</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© nmk | Powered by <a href="https://hexo.io" target="_blank">Hexo</a></span>
	</div>
</footer>

    </div>
</body>
</html>
