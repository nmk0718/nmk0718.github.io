<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">



<title>Docker | K&#39;s Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">kk&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">kk&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">Docker</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">nmk</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2020-3-31&nbsp;&nbsp;17:00:00</a>
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h4 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install docker</span><br></pre></td></tr></table></figure>

<h4 id="查看docker容器版本"><a href="#查看docker容器版本" class="headerlink" title="查看docker容器版本"></a>查看docker容器版本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker version</span><br></pre></td></tr></table></figure>

<h4 id="查看docker容器信息"><a href="#查看docker容器信息" class="headerlink" title="查看docker容器信息"></a>查看docker容器信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker info</span><br></pre></td></tr></table></figure>

<h4 id="修改存储路径"><a href="#修改存储路径" class="headerlink" title="修改存储路径"></a>修改存储路径</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#Docker的镜像需在大量的存储空间，默认的存储路径在 /var/lib/docker, 可以按实际需求修改存储路径。</span><br><span class="line">#停止docker</span><br><span class="line">service docker stop</span><br><span class="line">#创建目录</span><br><span class="line">mkdir -p /data/docker</span><br><span class="line">#移动目录到新路径</span><br><span class="line">mv /var/lib/docker /data/docker</span><br><span class="line">#做个软链接</span><br><span class="line">ln -s /data/docker /var/lib/docker </span><br><span class="line">#启动docker</span><br><span class="line">service docker start</span><br></pre></td></tr></table></figure>

<h4 id="下载镜像"><a href="#下载镜像" class="headerlink" title="下载镜像"></a>下载镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull tomcat</span><br><span class="line">#相当于 docker pull centos:latest 最新版本,可以手动指定版本</span><br></pre></td></tr></table></figure>

<h4 id="查看容器的所有镜像"><a href="#查看容器的所有镜像" class="headerlink" title="查看容器的所有镜像"></a>查看容器的所有镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure>

<h4 id="查看容器的运行状态"><a href="#查看容器的运行状态" class="headerlink" title="查看容器的运行状态"></a>查看容器的运行状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stats</span><br></pre></td></tr></table></figure>

<h4 id="查看容器运行的镜像"><a href="#查看容器运行的镜像" class="headerlink" title="查看容器运行的镜像"></a>查看容器运行的镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br><span class="line">#可以使用grep过滤镜像</span><br><span class="line">docker ps |grep tomcat</span><br></pre></td></tr></table></figure>

<h4 id="查看容器历史运行过的镜像"><a href="#查看容器历史运行过的镜像" class="headerlink" title="查看容器历史运行过的镜像"></a>查看容器历史运行过的镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a</span><br></pre></td></tr></table></figure>

<h4 id="显示运行容器总文件大小"><a href="#显示运行容器总文件大小" class="headerlink" title="显示运行容器总文件大小"></a>显示运行容器总文件大小</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -s</span><br></pre></td></tr></table></figure>

<h4 id="镜像启动"><a href="#镜像启动" class="headerlink" title="镜像启动"></a>镜像启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 8080:8080 -v /data:/data --name=mytomcat tomcat </span><br><span class="line">#-d: 后台运行容器，并返回容器ID；</span><br><span class="line">#-i: 以交互模式运行容器，通常与 -t 同时使用；</span><br><span class="line">#-t: 为容器重新分配一个伪输入终端，通常与 -i 同时使用；</span><br><span class="line">#-p：前者是外围访问端口：后者是容器内部端口</span><br><span class="line">#--volume,-v: 宿主机的目录/data映射到容器的/data</span><br><span class="line">#--name=&quot;nginx-lb&quot;: 为容器指定一个名称；</span><br></pre></td></tr></table></figure>

<h4 id="进入容器"><a href="#进入容器" class="headerlink" title="进入容器"></a>进入容器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it [CONTAINER ID] /bin/bash</span><br></pre></td></tr></table></figure>

<h4 id="删除镜像"><a href="#删除镜像" class="headerlink" title="删除镜像"></a>删除镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker rmi [CONTAINER ID]</span><br><span class="line"></span><br><span class="line">如果出现应用出错：Error response from daemon: conflict: unable to delete CONTAINER ID(cannot be forced) - image has dependent child images</span><br><span class="line">docker rmi REPOSITORY:TAG</span><br></pre></td></tr></table></figure>

<h4 id="删除运行失败的镜像"><a href="#删除运行失败的镜像" class="headerlink" title="删除运行失败的镜像"></a>删除运行失败的镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker rm [CONTAINER ID]</span><br><span class="line">#删除运行中的镜像需要先停止该容器,然后使用上述命令。使用-f可强制删除</span><br></pre></td></tr></table></figure>

<h4 id="删除所有none镜像"><a href="#删除所有none镜像" class="headerlink" title="删除所有none镜像"></a>删除所有none镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi `docker images | grep  &quot;&lt;none&gt;&quot; | awk &apos;&#123;print $3&#125;&apos;`</span><br></pre></td></tr></table></figure>

<h4 id="删除不是latest的镜像"><a href="#删除不是latest的镜像" class="headerlink" title="删除不是latest的镜像"></a>删除不是latest的镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi `docker images|grep -v latest |awk &apos;&#123;print $3&#125;&apos;`</span><br></pre></td></tr></table></figure>

<h4 id="删除Exited状态的容器"><a href="#删除Exited状态的容器" class="headerlink" title="删除Exited状态的容器"></a>删除Exited状态的容器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm `docker ps -a|grep Exited|awk &apos;&#123;print $1&#125;&apos;`</span><br></pre></td></tr></table></figure>

<h4 id="根据镜像名删除镜像"><a href="#根据镜像名删除镜像" class="headerlink" title="根据镜像名删除镜像"></a>根据镜像名删除镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images | grep wecloud | awk &apos;&#123;print $1&quot;:&quot;$2&#125;&apos; | xargs docker rmi</span><br></pre></td></tr></table></figure>

<h4 id="删除一周之前的镜像-一个月内"><a href="#删除一周之前的镜像-一个月内" class="headerlink" title="删除一周之前的镜像(一个月内)"></a>删除一周之前的镜像(一个月内)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images | grep weeks | awk &apos;&#123;print $3&#125;&apos;|xargs docker rmi</span><br></pre></td></tr></table></figure>

<h4 id="删除一周之前的所有镜像"><a href="#删除一周之前的所有镜像" class="headerlink" title="删除一周之前的所有镜像"></a>删除一周之前的所有镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;&quot;weeks&quot;,&quot;months&quot;&#125;;</span><br><span class="line">	docker images | grep $i | awk &apos;&#123;print $3&#125;&apos;|xargs docker rmi</span><br><span class="line">	docker images | grep $i | awk &apos;&#123;print $3&#125;&apos;|xargs docker rmi</span><br><span class="line">;done</span><br></pre></td></tr></table></figure>

<h4 id="创建dockerfile"><a href="#创建dockerfile" class="headerlink" title="创建dockerfile"></a>创建dockerfile</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from tomcat #tomcat的镜像</span><br><span class="line">MAINTAINER nmk #作者</span><br><span class="line">RUN rm -rf /usr/local/tomcat/webapps/*  #运行的命令</span><br><span class="line">COPY nmk.war /usr/local/tomcat/webapps #复制war包到tomcat的webapps目录下</span><br><span class="line">EXPOSE 8080  #开放端口</span><br></pre></td></tr></table></figure>

<h4 id="镜像构建"><a href="#镜像构建" class="headerlink" title="镜像构建"></a>镜像构建</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker build -f /data/docker/dockerfile -t mytomcat:1.1</span><br><span class="line">#-f :指定要使用的Dockerfile路径；</span><br><span class="line">#--tag, -t: 镜像的名字及标签，通常 name:tag 或者 name 格式；</span><br></pre></td></tr></table></figure>

<h4 id="推送到阿里云镜像仓库"><a href="#推送到阿里云镜像仓库" class="headerlink" title="推送到阿里云镜像仓库"></a>推送到阿里云镜像仓库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#登录阿里云Docker Registry</span><br><span class="line">docker login --username=aliyunaccount registry.cn-beijing.aliyuncs.com</span><br><span class="line">#镜像打tag</span><br><span class="line">docker tag [ImageId] registry.cn-beijing.aliyuncs.com/nmk/tomcat:[镜像版本号]</span><br><span class="line">#推送到阿里云</span><br><span class="line">docker push registry.cn-beijing.aliyuncs.com/nmk/tomcat:[镜像版本号]</span><br><span class="line">#拉取阿里云镜像</span><br><span class="line">docker pull registry.cn-beijing.aliyuncs.com/lepeng/tomcat:[镜像版本号]</span><br></pre></td></tr></table></figure>

<h4 id="从宿主机拷贝到容器"><a href="#从宿主机拷贝到容器" class="headerlink" title="从宿主机拷贝到容器"></a>从宿主机拷贝到容器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp files.txt [CONTAINER ID或NAMES]:/home</span><br></pre></td></tr></table></figure>

<h4 id="从容器拷贝到宿主机"><a href="#从容器拷贝到宿主机" class="headerlink" title="从容器拷贝到宿主机"></a>从容器拷贝到宿主机</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp [CONTAINER ID或NAMES]:/home/files.txt  /home/</span><br></pre></td></tr></table></figure>

<h4 id="镜像导入导出有两种方法"><a href="#镜像导入导出有两种方法" class="headerlink" title="镜像导入导出有两种方法"></a>镜像导入导出有两种方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#指定镜像保存成tar归档文件</span><br><span class="line">docker save -o files.tar tomcat:7.5</span><br><span class="line">#载入打包的镜像</span><br><span class="line">docker load -i files.tar</span><br><span class="line">#指定镜像保存成tar归档文件</span><br><span class="line">docker export -o tomcat.tar [CONTAINER ID]</span><br><span class="line">#载入打包的镜像</span><br><span class="line">docker import tomcat.tar tomcat:latest</span><br><span class="line"></span><br><span class="line">#总结一下docker save和docker export的区别：</span><br><span class="line">	1.docker save保存的是镜像（image），docker export保存的是容器（container）；</span><br><span class="line">	2.docker load用来载入镜像包，docker import用来载入容器包，但两者都会恢复为镜像；</span><br><span class="line">	3.docker load不能对载入的镜像重命名，而docker import可以为镜像指定新名称。</span><br><span class="line">#注:docker save保存的镜像docker load不能载入,docker export保存的镜像,docker import不能载入</span><br><span class="line">#详解请看:https://blog.csdn.net/liukuan73/article/details/78089138</span><br></pre></td></tr></table></figure>

<h4 id="删除repo不none空tag为none的镜像"><a href="#删除repo不none空tag为none的镜像" class="headerlink" title="删除repo不none空tag为none的镜像"></a>删除repo不none空tag为none的镜像</h4><p>在docker中，一个镜像的所有标记（TAG）都被删除，而镜像仍然还在时，我们称之为dangling状态。这种镜像，在通过docker images（或者docker image ls）时，会表现为REPOSITORY和TAG都是<none>，但是IMAGE ID有效。要删除这种镜像很简单，直接执行docker image prune即可清除。</none></p>
<p>还有另外一种状态的镜像，就是其REPOSITORY是有效的，但是其TAG是<none>，这个时候这种镜像既无法通过prune清除，也无法通过常规的docker image rm来删除。</none></p>
<p>在docker images查看镜像列表时，默认是不会显示镜像的digest的。需要手动加上–digests=true参数，才能看到形如“sha256:xxxxx”的digest信息。这个时候，用镜像的REPOSITORY➕@➕digest即可精确引用到该镜像，从而删除。</p>
<p>比如，通过docker images –digests=true看到如下镜像：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY TAG DIGEST IMAGE ID CREATED SIZE</span><br><span class="line">node &lt;none&gt; sha256:016052a6780d578fff9ac8822e66dd483db6ffb94573028b36cdd6ea48e98082 993f38da6c6c 11 days ago 677MB</span><br></pre></td></tr></table></figure>

<p>可以看到，这个node镜像，他的TAG是none，DIGEST是sha256:016052a6780d578fff9ac8822e66dd483db6ffb94573028b36cdd6ea48e98082。这个镜像无法通过docker rmi node或者docker rmi node:<none>删除。如果要删除它，需要执行</none></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi node@sha256:016052a6780d578fff9ac8822e66dd483db6ffb94573028b36cdd6ea48e98082</span><br></pre></td></tr></table></figure>

<h4 id="清理overlay2"><a href="#清理overlay2" class="headerlink" title="清理overlay2"></a>清理overlay2</h4><h5 id="查看Docker的磁盘使用情况"><a href="#查看Docker的磁盘使用情况" class="headerlink" title="查看Docker的磁盘使用情况"></a>查看Docker的磁盘使用情况</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost docker]# docker system df</span><br><span class="line">TYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLE</span><br><span class="line">Images              70                  70                  9.231GB             1.601GB (17%)</span><br><span class="line">Containers          200                 138                 4.292GB             0B (0%)</span><br><span class="line">Local Volumes       0                   0                   0B                  0B</span><br><span class="line">Build Cache         0                   0                   0B                  0B</span><br></pre></td></tr></table></figure>

<h5 id="查看当前目录最大的文件或目录的前五个"><a href="#查看当前目录最大的文件或目录的前五个" class="headerlink" title="查看当前目录最大的文件或目录的前五个"></a>查看当前目录最大的文件或目录的前五个</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /var/lib/docker/containers/</span><br><span class="line">du -h --max-depth=1 |sort -rn |head -n 5</span><br></pre></td></tr></table></figure>

<h5 id="可清理容器的启动日志"><a href="#可清理容器的启动日志" class="headerlink" title="可清理容器的启动日志"></a>可清理容器的启动日志</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls -lh #查看占用最大的文件为id-json.log</span><br><span class="line">cat /dev/null &gt; *-json.log</span><br></pre></td></tr></table></figure>

<h5 id="自动清理磁盘"><a href="#自动清理磁盘" class="headerlink" title="自动清理磁盘"></a>自动清理磁盘</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker system prune</span><br><span class="line">	该指令默认会清除所有如下资源：</span><br><span class="line">	已停止的容器（container）</span><br><span class="line">	未被任何容器所使用的卷（volume）</span><br><span class="line">	未被任何容器所关联的网络（network）</span><br><span class="line">	所有悬空镜像（image）</span><br><span class="line">该指令默认只会清除悬空镜像，未被使用的镜像不会被删除。</span><br><span class="line">添加 -a 或 --all 参数后，可以一并清除所有未使用的镜像和悬空镜像。</span><br><span class="line">可以添加 -f 或 --force 参数用以忽略相关告警确认信息</span><br><span class="line"></span><br><span class="line">注意:docker system prune -a命令清理得更加彻底，可以将没有容器使用Docker镜像都删掉。注意，这两个命令会把你暂时关闭的容器，以及暂时没有用到的Docker镜像都删掉了，所以使用之前一定要想清楚。</span><br></pre></td></tr></table></figure>

<h5 id="删除所有退出状态的容器"><a href="#删除所有退出状态的容器" class="headerlink" title="删除所有退出状态的容器"></a>删除所有退出状态的容器</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container prune</span><br></pre></td></tr></table></figure>

<h5 id="删除未被使用的数据卷"><a href="#删除未被使用的数据卷" class="headerlink" title="删除未被使用的数据卷"></a>删除未被使用的数据卷</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume prune</span><br></pre></td></tr></table></figure>

<h5 id="删除-dangling-或所有未被使用的镜像-镜像ID和标签都已被删除，并以none-关键字表示-。称为-虚悬镜像dangling-image"><a href="#删除-dangling-或所有未被使用的镜像-镜像ID和标签都已被删除，并以none-关键字表示-。称为-虚悬镜像dangling-image" class="headerlink" title="删除 dangling 或所有未被使用的镜像(镜像ID和标签都已被删除，并以none 关键字表示 。称为 虚悬镜像dangling image)"></a>删除 dangling 或所有未被使用的镜像(镜像ID和标签都已被删除，并以none 关键字表示 。称为 虚悬镜像dangling image)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image prune #</span><br></pre></td></tr></table></figure>

<h5 id="查看僵尸目录"><a href="#查看僵尸目录" class="headerlink" title="查看僵尸目录"></a>查看僵尸目录</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume ls -qf dangling=true</span><br></pre></td></tr></table></figure>

<h5 id="删除僵尸目录"><a href="#删除僵尸目录" class="headerlink" title="删除僵尸目录"></a>删除僵尸目录</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume rm $(docker volume ls -qf dangling=true</span><br></pre></td></tr></table></figure>

<h5 id="查看容器的logs大小进行清理"><a href="#查看容器的logs大小进行清理" class="headerlink" title="查看容器的logs大小进行清理"></a>查看容器的logs大小进行清理</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ll /var/lib/docker/overlay2/197c3988758a714fd0affa0dbbc9137f74e92d5e249f58c29f75cf6dcb1f8bb2/diff/workspace/logs</span><br></pre></td></tr></table></figure>

<h5 id="通过目录名id查看对应的pod"><a href="#通过目录名id查看对应的pod" class="headerlink" title="通过目录名id查看对应的pod"></a>通过目录名id查看对应的pod</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -q | xargs docker inspect --format &apos;&#123;&#123;.State.Pid&#125;&#125;, &#123;&#123;.Id&#125;&#125;, &#123;&#123;.Name&#125;&#125;, &#123;&#123;.GraphDriver.Data.WorkDir&#125;&#125;&apos; | egrep 8f06b3a04cedc6717e7d3b639d2be75006e6f897d75cc17fbf09f11a39b5d633</span><br></pre></td></tr></table></figure>

<h4 id="docker-build-命令行交互"><a href="#docker-build-命令行交互" class="headerlink" title="docker build 命令行交互"></a>docker build 命令行交互</h4><p>构建elasticsearch，想一起把 ik分词器整合进去，发现构建失败</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu:~/docker/elasticsearch-ik$ docker build -t elastic-ik . --no-cache</span><br><span class="line">Sending build context to Docker daemon  4.507MB</span><br><span class="line">Step 1/3 : FROM docker.elastic.co/elasticsearch/elasticsearch:6.5.4</span><br><span class="line"> ---&gt; 93109ce1d590</span><br><span class="line">Step 2/3 : ENV VERSION=6.5.4</span><br><span class="line"> ---&gt; Running in 520c5b73edc8</span><br><span class="line">Removing intermediate container 520c5b73edc8</span><br><span class="line"> ---&gt; 96e96aa28b66</span><br><span class="line">Step 3/3 : RUN /usr/share/elasticsearch/bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v$&#123;VERSION&#125;/elasticsearch-analysis-ik-$VERSION.zip</span><br><span class="line"> ---&gt; Running in 5fd671edd1eb</span><br><span class="line">-&gt; Downloading https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.5.4/elasticsearch-analysis-ik-6.5.4.zip</span><br><span class="line">[=================================================] 100%?? </span><br><span class="line">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class="line">@     WARNING: plugin requires additional permissions     @</span><br><span class="line">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class="line">* java.net.SocketPermission * connect,resolve</span><br><span class="line">See Permissions in the JDK</span><br><span class="line">for descriptions of what these permissions allow and the associated risks.</span><br><span class="line"></span><br><span class="line">Exception in thread &quot;main&quot; java.lang.IllegalStateException: unable to read from standard input; is standard input open and a tty attached?</span><br><span class="line">	at org.elasticsearch.cli.Terminal$SystemTerminal.readText(Terminal.java:173)</span><br><span class="line">	at org.elasticsearch.plugins.PluginSecurity.prompt(PluginSecurity.java:74)</span><br><span class="line">	at org.elasticsearch.plugins.PluginSecurity.confirmPolicyExceptions(PluginSecurity.java:67)</span><br><span class="line">	at org.elasticsearch.plugins.InstallPluginCommand.installPlugin(InstallPluginCommand.java:801)</span><br><span class="line">	at org.elasticsearch.plugins.InstallPluginCommand.install(InstallPluginCommand.java:775)</span><br><span class="line">	at org.elasticsearch.plugins.InstallPluginCommand.execute(InstallPluginCommand.java:231)</span><br><span class="line">	at org.elasticsearch.plugins.InstallPluginCommand.execute(InstallPluginCommand.java:216)</span><br><span class="line">	at org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:86)</span><br><span class="line">	at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:124)</span><br><span class="line">	at org.elasticsearch.cli.MultiCommand.execute(MultiCommand.java:77)</span><br><span class="line">	at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:124)</span><br><span class="line">	at org.elasticsearch.cli.Command.main(Command.java:90)</span><br><span class="line">	at org.elasticsearch.plugins.PluginCli.main(PluginCli.java:47)</span><br><span class="line">The command &apos;/bin/sh -c /usr/share/elasticsearch/bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v$&#123;VERSION&#125;/elasticsearch-analysis-ik-$VERSION.zip&apos; returned a non-zero code: 1</span><br></pre></td></tr></table></figure>

<p>根据命令行提示可以看到， 再第三步的时候，也就是安装 ik分词器的时候，提示需要额外的权限 <code>WARNING: plugin requires additional permissions</code></p>
<p>然后进入到 第二步的镜像中查看原因 <code>docker run -it 96e96aa28b66 /bin/bash</code></p>
<p>安装 ik 分词器的时候需要一次确认交互</p>
<p>Dockerfile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM docker.elastic.co/elasticsearch/elasticsearch:6.5.4</span><br><span class="line"></span><br><span class="line">ENV VERSION=6.5.4</span><br><span class="line"></span><br><span class="line">#COPY elasticsearch-analysis-ik-$VERSION.zip /tmp/</span><br><span class="line"></span><br><span class="line">RUN sh -c &apos;/bin/echo -e &quot;y&quot; | /usr/share/elasticsearch/bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v$&#123;VERSION&#125;/elasticsearch-analysis-ik-$VERSION.zip&apos;</span><br></pre></td></tr></table></figure>


        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>nmk</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://nmk0718.github.io/2020/03/31/docker/">http://nmk0718.github.io/2020/03/31/docker/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2020 <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tag/docker/"># docker</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2020/04/02/easyimage/">easyimage</a>
            
            
            <a class="next" rel="next" href="/2020/03/27/shadowsocks/">shadowsocks</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© nmk | Powered by <a href="https://hexo.io" target="_blank">Hexo</a></span>
	</div>
</footer>

    </div>
</body>
</html>
