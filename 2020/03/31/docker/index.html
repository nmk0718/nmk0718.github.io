<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">



<title>Docker | K&#39;s Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">kk&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">kk&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">Docker</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">nmk</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2020-3-31&nbsp;&nbsp;17:00:00</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <h4 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y <span class="keyword">install</span> docker</span><br></pre></td></tr></table></figure>

<h4 id="查看docker容器版本"><a href="#查看docker容器版本" class="headerlink" title="查看docker容器版本"></a>查看docker容器版本</h4><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">version</span></span><br></pre></td></tr></table></figure>

<h4 id="查看docker容器信息"><a href="#查看docker容器信息" class="headerlink" title="查看docker容器信息"></a>查看docker容器信息</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker</span> <span class="literal">info</span></span><br></pre></td></tr></table></figure>

<h4 id="修改存储路径"><a href="#修改存储路径" class="headerlink" title="修改存储路径"></a>修改存储路径</h4><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Docker的镜像需在大量的存储空间，默认的存储路径在 /var/lib/docker, 可以按实际需求修改存储路径。</span></span><br><span class="line"><span class="comment">#停止docker</span></span><br><span class="line">service docker stop</span><br><span class="line"><span class="comment">#创建目录</span></span><br><span class="line">mkdir -p /data/docker</span><br><span class="line"><span class="comment">#移动目录到新路径</span></span><br><span class="line">mv /var/<span class="class"><span class="keyword">lib</span>/<span class="title">docker</span> /<span class="title">data</span>/<span class="title">docker</span></span></span><br><span class="line"><span class="comment">#做个软链接</span></span><br><span class="line">ln -s /data/docker /var/<span class="class"><span class="keyword">lib</span>/<span class="title">docker</span> </span></span><br><span class="line"><span class="comment">#启动docker</span></span><br><span class="line">service docker start</span><br></pre></td></tr></table></figure>

<h4 id="下载镜像"><a href="#下载镜像" class="headerlink" title="下载镜像"></a>下载镜像</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker</span> pull tomcat</span><br><span class="line"><span class="comment">#相当于 docker pull centos:latest 最新版本,可以手动指定版本</span></span><br></pre></td></tr></table></figure>

<h4 id="查看容器的所有镜像"><a href="#查看容器的所有镜像" class="headerlink" title="查看容器的所有镜像"></a>查看容器的所有镜像</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker images</span></span><br></pre></td></tr></table></figure>

<h4 id="查看容器运行的镜像"><a href="#查看容器运行的镜像" class="headerlink" title="查看容器运行的镜像"></a>查看容器运行的镜像</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">ps</span></span><br><span class="line">#可以使用<span class="keyword">grep</span>过滤镜像</span><br><span class="line">docker <span class="keyword">ps</span> |<span class="keyword">grep</span> tomcat</span><br></pre></td></tr></table></figure>

<h4 id="查看容器历史运行过的镜像"><a href="#查看容器历史运行过的镜像" class="headerlink" title="查看容器历史运行过的镜像"></a>查看容器历史运行过的镜像</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker ps -a</span></span><br></pre></td></tr></table></figure>

<h4 id="显示运行容器总文件大小"><a href="#显示运行容器总文件大小" class="headerlink" title="显示运行容器总文件大小"></a>显示运行容器总文件大小</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker ps -s</span></span><br></pre></td></tr></table></figure>

<h4 id="镜像启动"><a href="#镜像启动" class="headerlink" title="镜像启动"></a>镜像启动</h4><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p <span class="number">8080</span>:<span class="number">8080</span> -v /data:/data --name=mytomcat tomcat </span><br><span class="line"><span class="meta">#-d: 后台运行容器，并返回容器ID；</span></span><br><span class="line"><span class="meta">#-i: 以交互模式运行容器，通常与 -t 同时使用；</span></span><br><span class="line"><span class="meta">#-t: 为容器重新分配一个伪输入终端，通常与 -i 同时使用；</span></span><br><span class="line"><span class="meta">#-p：前者是外围访问端口：后者是容器内部端口</span></span><br><span class="line"><span class="meta">#--volume,-v: 宿主机的目录/data映射到容器的/data</span></span><br><span class="line"><span class="meta">#--name="nginx-lb": 为容器指定一个名称；</span></span><br></pre></td></tr></table></figure>

<h4 id="进入容器"><a href="#进入容器" class="headerlink" title="进入容器"></a>进入容器</h4><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it <span class="string">[CONTAINER ID]</span> /bin/bash</span><br></pre></td></tr></table></figure>

<h4 id="删除镜像"><a href="#删除镜像" class="headerlink" title="删除镜像"></a>删除镜像</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker rmi [CONTAINER ID]</span><br><span class="line"></span><br><span class="line">如果出现应用出错：Error response from daemon: conflic<span class="variable">t:</span> unable <span class="keyword">to</span> <span class="keyword">delete</span> CONTAINER ID(cannot <span class="keyword">be</span> forced) - image <span class="built_in">has</span> dependent child images</span><br><span class="line">docker rmi REPOSITORY:TAG</span><br></pre></td></tr></table></figure>

<h4 id="删除运行失败的镜像"><a href="#删除运行失败的镜像" class="headerlink" title="删除运行失败的镜像"></a>删除运行失败的镜像</h4><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker</span> rm<span class="meta"> [CONTAINER ID]</span></span><br><span class="line"><span class="comment">#删除运行中的镜像需要先停止该容器,然后使用上述命令。使用-f可强制删除</span></span><br></pre></td></tr></table></figure>

<h4 id="删除所有none镜像"><a href="#删除所有none镜像" class="headerlink" title="删除所有none镜像"></a>删除所有none镜像</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker</span> rmi `docker images | grep  <span class="string">"&lt;none&gt;"</span> | awk <span class="string">'&#123;print <span class="variable">$3</span>&#125;'</span>`</span><br></pre></td></tr></table></figure>

<h4 id="删除不是latest的镜像"><a href="#删除不是latest的镜像" class="headerlink" title="删除不是latest的镜像"></a>删除不是latest的镜像</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker</span> rmi `docker images|grep -v latest |awk <span class="string">'&#123;print <span class="variable">$3</span>&#125;'</span>`</span><br></pre></td></tr></table></figure>

<h4 id="删除Exited状态的容器"><a href="#删除Exited状态的容器" class="headerlink" title="删除Exited状态的容器"></a>删除Exited状态的容器</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker</span> rm `docker ps -a|grep Exited|awk <span class="string">'&#123;print <span class="variable">$1</span>&#125;'</span>`</span><br></pre></td></tr></table></figure>

<h4 id="根据镜像名删除镜像"><a href="#根据镜像名删除镜像" class="headerlink" title="根据镜像名删除镜像"></a>根据镜像名删除镜像</h4><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images | <span class="type">grep</span> wecloud | <span class="type">awk</span> '&#123;print $<span class="number">1</span><span class="string">":"</span>$<span class="number">2</span>&#125;' | <span class="type">xargs</span> docker rmi</span><br></pre></td></tr></table></figure>

<h4 id="删除一周之前的镜像-一个月内"><a href="#删除一周之前的镜像-一个月内" class="headerlink" title="删除一周之前的镜像(一个月内)"></a>删除一周之前的镜像(一个月内)</h4><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images | <span class="type">grep</span> weeks | <span class="type">awk</span> '&#123;print $<span class="number">3</span>&#125;'|<span class="type">xargs</span> docker rmi</span><br></pre></td></tr></table></figure>

<h4 id="删除一周之前的所有镜像"><a href="#删除一周之前的所有镜像" class="headerlink" title="删除一周之前的所有镜像"></a>删除一周之前的所有镜像</h4><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="built_in">in</span> &#123;<span class="string">"weeks"</span>,<span class="string">"months"</span>&#125;;</span><br><span class="line">	docker images | <span class="type">grep</span> $i | <span class="type">awk</span> '&#123;print $<span class="number">3</span>&#125;'|<span class="type">xargs</span> docker rmi</span><br><span class="line">	docker images | <span class="type">grep</span> $i | <span class="type">awk</span> '&#123;print $<span class="number">3</span>&#125;'|<span class="type">xargs</span> docker rmi</span><br><span class="line">;done</span><br></pre></td></tr></table></figure>

<h4 id="创建dockerfile"><a href="#创建dockerfile" class="headerlink" title="创建dockerfile"></a>创建dockerfile</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tomcat <span class="comment">#tomcat的镜像</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> nmk <span class="comment">#作者</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> rm -rf /usr/<span class="built_in">local</span>/tomcat/webapps/*  <span class="comment">#运行的命令</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> nmk.war /usr/<span class="built_in">local</span>/tomcat/webapps <span class="comment">#复制war包到tomcat的webapps目录下</span></span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span>  <span class="comment">#开放端口</span></span><br></pre></td></tr></table></figure>

<h4 id="镜像构建"><a href="#镜像构建" class="headerlink" title="镜像构建"></a>镜像构建</h4><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">docker</span> build -f /<span class="class"><span class="keyword">data</span>/docker/dockerfile -t mytomcat:1.1</span></span><br><span class="line"><span class="meta">#-f :指定要使用的Dockerfile路径；</span></span><br><span class="line"><span class="meta">#--tag, -t: 镜像的名字及标签，通常 name:tag 或者 name 格式；</span></span><br></pre></td></tr></table></figure>

<h4 id="推送到阿里云镜像仓库"><a href="#推送到阿里云镜像仓库" class="headerlink" title="推送到阿里云镜像仓库"></a>推送到阿里云镜像仓库</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#登录阿里云Docker Registry</span><br><span class="line">docker login --username=aliyunaccount registry<span class="selector-class">.cn-beijing</span><span class="selector-class">.aliyuncs</span><span class="selector-class">.com</span></span><br><span class="line">#镜像打tag</span><br><span class="line">docker tag [ImageId] registry<span class="selector-class">.cn-beijing</span><span class="selector-class">.aliyuncs</span><span class="selector-class">.com</span>/nmk/tomcat:[镜像版本号]</span><br><span class="line">#推送到阿里云</span><br><span class="line">docker push registry<span class="selector-class">.cn-beijing</span><span class="selector-class">.aliyuncs</span><span class="selector-class">.com</span>/nmk/tomcat:[镜像版本号]</span><br><span class="line">#拉取阿里云镜像</span><br><span class="line">docker pull registry<span class="selector-class">.cn-beijing</span><span class="selector-class">.aliyuncs</span><span class="selector-class">.com</span>/lepeng/tomcat:[镜像版本号]</span><br></pre></td></tr></table></figure>

<h4 id="从宿主机拷贝到容器"><a href="#从宿主机拷贝到容器" class="headerlink" title="从宿主机拷贝到容器"></a>从宿主机拷贝到容器</h4><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp files.txt [CONTAINER ID或NAMES]<span class="symbol">:/home</span></span><br></pre></td></tr></table></figure>

<h4 id="从容器拷贝到宿主机"><a href="#从容器拷贝到宿主机" class="headerlink" title="从容器拷贝到宿主机"></a>从容器拷贝到宿主机</h4><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp [CONTAINER ID或NAMES]<span class="symbol">:/home/files</span>.txt  /home/</span><br></pre></td></tr></table></figure>

<h4 id="镜像导入导出有两种方法"><a href="#镜像导入导出有两种方法" class="headerlink" title="镜像导入导出有两种方法"></a>镜像导入导出有两种方法</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#指定镜像保存成tar归档文件</span></span><br><span class="line">docker save -o files.tar tomcat:7.5</span><br><span class="line"><span class="comment">#载入打包的镜像</span></span><br><span class="line">docker <span class="keyword">load</span> -i files.tar</span><br><span class="line"><span class="comment">#指定镜像保存成tar归档文件</span></span><br><span class="line">docker <span class="keyword">export</span> -o tomcat.tar [<span class="keyword">CONTAINER</span> <span class="keyword">ID</span>]</span><br><span class="line"><span class="comment">#载入打包的镜像</span></span><br><span class="line">docker <span class="keyword">import</span> tomcat.tar tomcat:latest</span><br><span class="line"></span><br><span class="line"><span class="comment">#总结一下docker save和docker export的区别：</span></span><br><span class="line">	<span class="number">1.</span>docker <span class="keyword">save</span>保存的是镜像（image），docker <span class="keyword">export</span>保存的是容器（<span class="keyword">container</span>）；</span><br><span class="line">	<span class="number">2.</span>docker <span class="keyword">load</span>用来载入镜像包，docker <span class="keyword">import</span>用来载入容器包，但两者都会恢复为镜像；</span><br><span class="line">	<span class="number">3.</span>docker <span class="keyword">load</span>不能对载入的镜像重命名，而docker <span class="keyword">import</span>可以为镜像指定新名称。</span><br><span class="line"><span class="comment">#注:docker save保存的镜像docker load不能载入,docker export保存的镜像,docker import不能载入</span></span><br><span class="line"><span class="comment">#详解请看:https://blog.csdn.net/liukuan73/article/details/78089138</span></span><br></pre></td></tr></table></figure>

<h4 id="删除repo不none空tag为none的镜像"><a href="#删除repo不none空tag为none的镜像" class="headerlink" title="删除repo不none空tag为none的镜像"></a>删除repo不none空tag为none的镜像</h4><p>在docker中，一个镜像的所有标记（TAG）都被删除，而镜像仍然还在时，我们称之为dangling状态。这种镜像，在通过docker images（或者docker image ls）时，会表现为REPOSITORY和TAG都是<none>，但是IMAGE ID有效。要删除这种镜像很简单，直接执行docker image prune即可清除。</none></p>
<p>还有另外一种状态的镜像，就是其REPOSITORY是有效的，但是其TAG是<none>，这个时候这种镜像既无法通过prune清除，也无法通过常规的docker image rm来删除。</none></p>
<p>在docker images查看镜像列表时，默认是不会显示镜像的digest的。需要手动加上–digests=true参数，才能看到形如“sha256:xxxxx”的digest信息。这个时候，用镜像的REPOSITORY➕@➕digest即可精确引用到该镜像，从而删除。</p>
<p>比如，通过docker images –digests=true看到如下镜像：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY <span class="keyword">TAG</span> <span class="title">DIGEST</span> IMAGE ID CREATED SIZE</span><br><span class="line"><span class="keyword">node</span> <span class="title">&lt;none</span>&gt; sha256:<span class="number">016052</span>a6780d578fff9ac8822e66dd483db6ffb94573028b36cdd6ea48e98082 <span class="number">993</span>f38da6c6c <span class="number">11</span> days ago <span class="number">677M</span>B</span><br></pre></td></tr></table></figure>

<p>可以看到，这个node镜像，他的TAG是none，DIGEST是sha256:016052a6780d578fff9ac8822e66dd483db6ffb94573028b36cdd6ea48e98082。这个镜像无法通过docker rmi node或者docker rmi node:<none>删除。如果要删除它，需要执行</none></p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi <span class="keyword">node</span><span class="title">@sha256</span>:<span class="number">016052</span>a6780d578fff9ac8822e66dd483db6ffb94573028b36cdd6ea48e98082</span><br></pre></td></tr></table></figure>

<h4 id="清理overlay2"><a href="#清理overlay2" class="headerlink" title="清理overlay2"></a>清理overlay2</h4><h5 id="查看Docker的磁盘使用情况"><a href="#查看Docker的磁盘使用情况" class="headerlink" title="查看Docker的磁盘使用情况"></a>查看Docker的磁盘使用情况</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost docker]# docker<span class="built_in"> system </span>df</span><br><span class="line">TYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLE</span><br><span class="line">Images              70                  70                  9.231GB             1.601GB (17%)</span><br><span class="line">Containers          200                 138                 4.292GB             0B (0%)</span><br><span class="line">Local Volumes       0                   0                   0B                  0B</span><br><span class="line">Build Cache         0                   0                   0B                  0B</span><br></pre></td></tr></table></figure>

<h5 id="查看当前目录最大的文件或目录的前五个"><a href="#查看当前目录最大的文件或目录的前五个" class="headerlink" title="查看当前目录最大的文件或目录的前五个"></a>查看当前目录最大的文件或目录的前五个</h5><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /var/<span class="class"><span class="keyword">lib</span>/<span class="title">docker</span>/<span class="title">containers</span>/</span></span><br><span class="line">du -h --max-depth=<span class="number">1</span> |sort -rn |head -n <span class="number">5</span></span><br></pre></td></tr></table></figure>

<h5 id="可清理容器的启动日志"><a href="#可清理容器的启动日志" class="headerlink" title="可清理容器的启动日志"></a>可清理容器的启动日志</h5><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ls</span> -<span class="keyword">lh</span> #查看占用最大的文件为id-json.<span class="built_in">log</span></span><br><span class="line"><span class="keyword">cat</span> /dev/null &gt; *-json.<span class="built_in">log</span></span><br></pre></td></tr></table></figure>

<h5 id="自动清理磁盘"><a href="#自动清理磁盘" class="headerlink" title="自动清理磁盘"></a>自动清理磁盘</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker<span class="built_in"> system </span>prune</span><br><span class="line">	该指令默认会清除所有如下资源：</span><br><span class="line">	已停止的容器（container）</span><br><span class="line">	未被任何容器所使用的卷（volume）</span><br><span class="line">	未被任何容器所关联的网络（network）</span><br><span class="line">	所有悬空镜像（image）</span><br><span class="line">该指令默认只会清除悬空镜像，未被使用的镜像不会被删除。</span><br><span class="line">添加 -a 或 --all 参数后，可以一并清除所有未使用的镜像和悬空镜像。</span><br><span class="line">可以添加 -f 或 --force 参数用以忽略相关告警确认信息</span><br><span class="line"></span><br><span class="line">注意:docker<span class="built_in"> system </span>prune -a命令清理得更加彻底，可以将没有容器使用Docker镜像都删掉。注意，这两个命令会把你暂时关闭的容器，以及暂时没有用到的Docker镜像都删掉了，所以使用之前一定要想清楚。</span><br></pre></td></tr></table></figure>

<h5 id="删除所有退出状态的容器"><a href="#删除所有退出状态的容器" class="headerlink" title="删除所有退出状态的容器"></a>删除所有退出状态的容器</h5><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">container</span> prune</span><br></pre></td></tr></table></figure>

<h5 id="删除未被使用的数据卷"><a href="#删除未被使用的数据卷" class="headerlink" title="删除未被使用的数据卷"></a>删除未被使用的数据卷</h5><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">volume</span><span class="bash"> prune</span></span><br></pre></td></tr></table></figure>

<h5 id="删除-dangling-或所有未被使用的镜像-镜像ID和标签都已被删除，并以none-关键字表示-。称为-虚悬镜像dangling-image"><a href="#删除-dangling-或所有未被使用的镜像-镜像ID和标签都已被删除，并以none-关键字表示-。称为-虚悬镜像dangling-image" class="headerlink" title="删除 dangling 或所有未被使用的镜像(镜像ID和标签都已被删除，并以none 关键字表示 。称为 虚悬镜像dangling image)"></a>删除 dangling 或所有未被使用的镜像(镜像ID和标签都已被删除，并以none 关键字表示 。称为 虚悬镜像dangling image)</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker</span> image prune <span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h5 id="查看僵尸目录"><a href="#查看僵尸目录" class="headerlink" title="查看僵尸目录"></a>查看僵尸目录</h5><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">volume</span><span class="bash"> ls -qf dangling=<span class="literal">true</span></span></span><br></pre></td></tr></table></figure>

<h5 id="删除僵尸目录"><a href="#删除僵尸目录" class="headerlink" title="删除僵尸目录"></a>删除僵尸目录</h5><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">volume</span><span class="bash"> rm $(docker volume ls -qf dangling=<span class="literal">true</span></span></span><br></pre></td></tr></table></figure>

<h5 id="查看容器的logs大小进行清理"><a href="#查看容器的logs大小进行清理" class="headerlink" title="查看容器的logs大小进行清理"></a>查看容器的logs大小进行清理</h5><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ll /var/<span class="class"><span class="keyword">lib</span>/<span class="title">docker</span>/<span class="title">overlay2</span>/197<span class="title">c3988758a714fd0affa0dbbc9137f74e92d5e249f58c29f75cf6dcb1f8bb2</span>/<span class="title">diff</span>/<span class="title">workspace</span>/<span class="title">logs</span></span></span><br></pre></td></tr></table></figure>

<h5 id="通过目录名id查看对应的pod"><a href="#通过目录名id查看对应的pod" class="headerlink" title="通过目录名id查看对应的pod"></a>通过目录名id查看对应的pod</h5><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -q | xargs docker inspect <span class="params">--format</span> '&#123;&#123;<span class="string">.State.Pid</span>&#125;&#125;, &#123;&#123;<span class="string">.Id</span>&#125;&#125;, &#123;&#123;<span class="string">.Name</span>&#125;&#125;, &#123;&#123;<span class="string">.GraphDriver.Data.WorkDir</span>&#125;&#125;' | egrep 8f06b3a04cedc6717e7d3b639d2be75006e6f897d75cc17fbf09f11a39b5d633</span><br></pre></td></tr></table></figure>

<h4 id="docker-build-命令行交互"><a href="#docker-build-命令行交互" class="headerlink" title="docker build 命令行交互"></a>docker build 命令行交互</h4><p>构建elasticsearch，想一起把 ik分词器整合进去，发现构建失败</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu:~/docker/elasticsearch-ik$ docker build -t elastic-ik . --no-cache</span><br><span class="line">Sending build context to Docker daemon  <span class="number">4.507</span>MB</span><br><span class="line">Step <span class="number">1</span>/<span class="number">3</span> : FROM docker.elastic.co/elasticsearch/elasticsearch:<span class="number">6.5</span><span class="number">.4</span></span><br><span class="line"> ---&gt; <span class="number">93109</span>ce1d590</span><br><span class="line">Step <span class="number">2</span>/<span class="number">3</span> : ENV VERSION=<span class="number">6.5</span><span class="number">.4</span></span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> <span class="number">520</span>c5b73edc8</span><br><span class="line">Removing intermediate <span class="keyword">container</span> <span class="number">520</span>c5b73edc8</span><br><span class="line"> ---&gt; <span class="number">96e96</span>aa28b66</span><br><span class="line">Step <span class="number">3</span>/<span class="number">3</span> : RUN /usr/share/elasticsearch/bin/elasticsearch-plugin install https:<span class="comment">//github.com/medcl/elasticsearch-analysis-ik/releases/download/v$&#123;VERSION&#125;/elasticsearch-analysis-ik-$VERSION.zip</span></span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> <span class="number">5</span>fd671edd1eb</span><br><span class="line">-&gt; Downloading https:<span class="comment">//github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.5.4/elasticsearch-analysis-ik-6.5.4.zip</span></span><br><span class="line">[=================================================] <span class="number">100</span>%?? </span><br><span class="line">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class="line">@     WARNING: plugin <span class="keyword">requires</span> additional permissions     @</span><br><span class="line">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class="line">* java.net.SocketPermission * connect,resolve</span><br><span class="line">See Permissions <span class="keyword">in</span> the JDK</span><br><span class="line"><span class="keyword">for</span> descriptions of what these permissions allow and the associated risks.</span><br><span class="line"></span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java.lang.IllegalStateException: unable to read from standard input; is standard input open and a tty attached?</span><br><span class="line">	at org.elasticsearch.cli.Terminal$SystemTerminal.readText(Terminal.java:<span class="number">173</span>)</span><br><span class="line">	at org.elasticsearch.plugins.PluginSecurity.prompt(PluginSecurity.java:<span class="number">74</span>)</span><br><span class="line">	at org.elasticsearch.plugins.PluginSecurity.confirmPolicyExceptions(PluginSecurity.java:<span class="number">67</span>)</span><br><span class="line">	at org.elasticsearch.plugins.InstallPluginCommand.installPlugin(InstallPluginCommand.java:<span class="number">801</span>)</span><br><span class="line">	at org.elasticsearch.plugins.InstallPluginCommand.install(InstallPluginCommand.java:<span class="number">775</span>)</span><br><span class="line">	at org.elasticsearch.plugins.InstallPluginCommand.execute(InstallPluginCommand.java:<span class="number">231</span>)</span><br><span class="line">	at org.elasticsearch.plugins.InstallPluginCommand.execute(InstallPluginCommand.java:<span class="number">216</span>)</span><br><span class="line">	at org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:<span class="number">86</span>)</span><br><span class="line">	at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:<span class="number">124</span>)</span><br><span class="line">	at org.elasticsearch.cli.MultiCommand.execute(MultiCommand.java:<span class="number">77</span>)</span><br><span class="line">	at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:<span class="number">124</span>)</span><br><span class="line">	at org.elasticsearch.cli.Command.main(Command.java:<span class="number">90</span>)</span><br><span class="line">	at org.elasticsearch.plugins.PluginCli.main(PluginCli.java:<span class="number">47</span>)</span><br><span class="line">The command <span class="string">'/bin/sh -c /usr/share/elasticsearch/bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v$&#123;VERSION&#125;/elasticsearch-analysis-ik-$VERSION.zip'</span> returned a non-zero code: <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>根据命令行提示可以看到， 再第三步的时候，也就是安装 ik分词器的时候，提示需要额外的权限 <code>WARNING: plugin requires additional permissions</code></p>
<p>然后进入到 第二步的镜像中查看原因 <code>docker run -it 96e96aa28b66 /bin/bash</code></p>
<p>安装 ik 分词器的时候需要一次确认交互</p>
<p>Dockerfile</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM docker.elastic.co/elasticsearch/elasticsearch:6.5.4</span><br><span class="line"></span><br><span class="line">ENV <span class="keyword">VERSION</span>=6.5.4</span><br><span class="line"></span><br><span class="line">#<span class="keyword">COPY</span> elasticsearch-analysis-ik-<span class="variable">$VERSION</span>.<span class="keyword">zip</span> /tmp/</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span> <span class="keyword">sh</span> -c '/bin/echo -<span class="keyword">e</span> <span class="string">"y"</span> | /usr/share/elasticsearch/bin/elasticsearch-<span class="keyword">plugin</span> install https:<span class="comment">//github.com/medcl/elasticsearch-analysis-ik/releases/download/v$&#123;VERSION&#125;/elasticsearch-analysis-ik-$VERSION.zip'</span></span><br></pre></td></tr></table></figure>


        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>nmk</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://nmk0718.github.io/2020/03/31/docker/">http://nmk0718.github.io/2020/03/31/docker/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2020 <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tag/docker/"># docker</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2020/04/02/easyimage/">easyimage</a>
            
            
            <a class="next" rel="next" href="/2020/03/27/shadowsocks/">shadowsocks</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© nmk | Powered by <a href="https://hexo.io" target="_blank">Hexo</a></span>
	</div>
</footer>

    </div>
</body>
</html>
