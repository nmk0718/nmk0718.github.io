<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">



<title>expect | K&#39;s Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">kk&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">kk&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">expect</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">nmk</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2020-5-21&nbsp;&nbsp;22:20:00</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <h3 id="expect-安装"><a href="#expect-安装" class="headerlink" title="expect 安装"></a>expect 安装</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> -y expect</span><br></pre></td></tr></table></figure>

<h3 id="expect工作原理"><a href="#expect工作原理" class="headerlink" title="expect工作原理"></a>expect工作原理</h3><p>​    从最简单的层次来说，Expect的工作方式象一个通用化的Chat脚本工具。Chat脚本最早用于UUCP网络内，以用来实现计算机之间需要建立连接时进行特定的登录会话的自动化。</p>
<p>​    Chat脚本由一系列expect-send对组成：expect等待输出中输出特定的字符，通常是一个提示符，然后发送特定的响应。例如下面的 Chat脚本实现等待标准输出出现Login:字符串，然后发送somebody作为用户名；然后等待Password:提示符，并发出响应 sillyme。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Login:</span> somebody <span class="string">Password:</span> sillyme</span><br></pre></td></tr></table></figure>

<p>Expect最简单的脚本操作模式本质上和Chat脚本工作模式是一样的。</p>
<h3 id="expect简单例子"><a href="#expect简单例子" class="headerlink" title="expect简单例子"></a>expect简单例子</h3><p>为了更好理解except脚本几个简单参数，我们再举一个简单的例子： </p>
<figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/expect   </span></span><br><span class="line">set timeout <span class="number">30</span>   </span><br><span class="line">spawn ssh -l username <span class="number">192.168</span>.1.1   </span><br><span class="line">expect <span class="string">"password:"</span>   </span><br><span class="line">send <span class="string">"ispass\r"</span>   </span><br><span class="line">interact</span><br></pre></td></tr></table></figure>

<p>说明:</p>
<p>1.[#!/usr/bin/expect]</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这一行告诉操作系统脚本里的代码使用那一个<span class="keyword">shell</span><span class="bash">来执行。这里的expect其实和linux下的bash、windows下的cmd是	一类东西。注意：这一行需要在脚本的第一行。</span></span><br></pre></td></tr></table></figure>

<p>2.[set timeout 30]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">设置超时时间，计时单位是：秒</span><br></pre></td></tr></table></figure>

<p>3.[spawn ssh -l username 192.168.1.1]</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spawn是进入expect环境后才可以执行的expect内部命令，如果没有装expect或者直接在默认的<span class="keyword">SHELL</span>下执行是找不到spawn命令的。所以不要用 “<span class="keyword">which</span> spawn“之类的命令去找spawn命令。好比windows里的<span class="keyword">dir</span>就是一个内部命令，这个命令由<span class="keyword">shell</span>自带，你无法找到一个<span class="keyword">dir</span>.com 或 <span class="keyword">dir</span>.exe 的可执行文件。它主要的功能是给ssh运行进程加个壳，用来传递交互指令。</span><br></pre></td></tr></table></figure>

<p>4.[expect “password:”]</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这里的<span class="keyword">expect</span>也是<span class="keyword">expect</span>的一个内部命令，有点晕吧，<span class="keyword">expect</span>的shell命令和内部命令是一样的，但不是一个功能，习惯就好了。这个命令的意思是判断上次输出结果里是否包含“password:”的字符串，如果有则立即返回，否则就等待一段时间后返回，这里等待时长就是前面设置的<span class="number">30</span>秒</span><br></pre></td></tr></table></figure>

<p>5.[send “ispass\r”]</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">这里就是执行交互动作，与手工输入密码的动作等效。  </span><br><span class="line">温馨提示： 命令字符串结尾别忘记加上 “<span class="string">\r”，如果出现异常等待的状态可以核查一下。</span></span><br></pre></td></tr></table></figure>

<p>6.[interact］  </p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">执行完成后保持交互状态，把控制权交给控制台，这个时候就可以手工操作了。如果没有这一句登录完成后会退出，而不是留在远程终端上。如果你只是登录过去执行一段命令就退出，可改为［expect <span class="built_in">eof</span>］</span><br></pre></td></tr></table></figure>

<h3 id="expect实用案例"><a href="#expect实用案例" class="headerlink" title="expect实用案例"></a>expect实用案例</h3><h4 id="远程登录到linux-并且执行命令-执行完后并退出"><a href="#远程登录到linux-并且执行命令-执行完后并退出" class="headerlink" title="远程登录到linux,并且执行命令,执行完后并退出"></a>远程登录到linux,并且执行命令,执行完后并退出</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/expect -f </span></span><br><span class="line"><span class="builtin-name">set</span><span class="built_in"> ip </span>192.168.1.130 </span><br><span class="line"><span class="builtin-name">set</span> password admin </span><br><span class="line"><span class="builtin-name">set</span> timeout 10 </span><br><span class="line">spawn ssh root@<span class="variable">$ip</span> </span><br><span class="line">expect &#123; </span><br><span class="line"><span class="string">"*yes/no"</span> &#123; send <span class="string">"yes\r"</span>; exp_continue&#125; </span><br><span class="line"><span class="string">"*password:"</span> &#123; send <span class="string">"<span class="variable">$password</span>\r"</span> &#125; </span><br><span class="line">&#125; </span><br><span class="line">expect <span class="string">"#*"</span> </span><br><span class="line">send <span class="string">"pwd\r"</span> </span><br><span class="line">send <span class="string">"exit\r"</span> </span><br><span class="line">expect eof</span><br></pre></td></tr></table></figure>

<p>运行结果如下:</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1. </span>root@nmk# ./test.exp </span><br><span class="line"><span class="bullet">2. </span>spawn ssh root@192.168.1.130 </span><br><span class="line"><span class="bullet">3. </span>root@192.168.1.130's password: </span><br><span class="line"><span class="bullet">4. </span>Last login: Fri Sep 7 14:05:07 2012 from 116.246.27.90 </span><br><span class="line"><span class="bullet">5. </span>[root@localhost ~]# pwd </span><br><span class="line"><span class="bullet">6. </span>/root </span><br><span class="line"><span class="bullet">7. </span>[root@localhost ~]# exit </span><br><span class="line"><span class="bullet">8. </span>logout </span><br><span class="line"><span class="bullet">9. </span>Connection to 192.168.1.130 closed.</span><br></pre></td></tr></table></figure>

<p>linux下匹配 #,windows下匹配 &gt;</p>
<h4 id="远程登录到ftp-并且下载文件"><a href="#远程登录到ftp-并且下载文件" class="headerlink" title="远程登录到ftp,并且下载文件"></a>远程登录到ftp,并且下载文件</h4><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> \#!/usr/bin/expect -f </span><br><span class="line"><span class="number">2.</span>  <span class="keyword">set</span> ip [<span class="keyword">lindex</span> $argv <span class="number">0</span> ] </span><br><span class="line"><span class="number">3.</span>  <span class="keyword">set</span> dir [<span class="keyword">lindex</span> $argv <span class="number">1</span> ] </span><br><span class="line"><span class="number">4.</span>  <span class="keyword">set</span> <span class="keyword">file</span> [<span class="keyword">lindex</span> $argv <span class="number">2</span> ] </span><br><span class="line"><span class="number">5.</span>  <span class="keyword">set</span> timeout <span class="number">10</span> </span><br><span class="line"><span class="number">6.</span>  spawn ftp $ip </span><br><span class="line"><span class="number">7.</span>  expect <span class="string">"Name*"</span> </span><br><span class="line"><span class="number">8.</span>  send <span class="string">"zwh\r"</span> </span><br><span class="line"><span class="number">9.</span>  expect <span class="string">"Password:*"</span> </span><br><span class="line"><span class="number">10.</span>  send <span class="string">"zwh\r"</span> </span><br><span class="line"><span class="number">11.</span>  expect <span class="string">"ftp&gt;*"</span> </span><br><span class="line"><span class="number">12.</span>  send <span class="string">"lcd $dir\r"</span> </span><br><span class="line"><span class="number">13.</span>  expect &#123; </span><br><span class="line"><span class="number">14.</span>  <span class="string">"*file"</span> &#123; send_user <span class="string">"local $_dir No such file or directory"</span>;send <span class="string">"quit\r"</span> &#125; </span><br><span class="line"><span class="number">15.</span>  <span class="string">"*now*"</span> &#123; send <span class="string">"get $dir/$file $dir/$file\r"</span>&#125; </span><br><span class="line"><span class="number">16.</span>  &#125; </span><br><span class="line"><span class="number">17.</span>  expect &#123; </span><br><span class="line"><span class="number">18.</span>  <span class="string">"*Failed"</span> &#123; send_user <span class="string">"remote $file No such file"</span>;send <span class="string">"quit\r"</span> &#125; </span><br><span class="line"><span class="number">19.</span>  <span class="string">"*OK"</span>   &#123; send_user <span class="string">"$file has been download\r"</span>;send <span class="string">"quit\r"</span>&#125; </span><br><span class="line"><span class="number">20.</span>  &#125; </span><br><span class="line"><span class="number">21.</span>  expect <span class="keyword">eof</span></span><br></pre></td></tr></table></figure>

<p>运行结果如下: </p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">1. root@nmk# ./test2.exp 192.168.1.130 /var/www/www aaa.html </span><br><span class="line">2. spawn ftp 192.168.1.130 </span><br><span class="line">3. Connected <span class="keyword">to</span> 192.168.1.130. </span><br><span class="line">4. 220 (vsFTPd 2.0.5) </span><br><span class="line">5. Name (192.168.1.130:root): zwh </span><br><span class="line">6. 331 Please specify the password. </span><br><span class="line">7. Password: </span><br><span class="line">8. 230 Login successful. </span><br><span class="line">9. Remote<span class="built_in"> system type </span>is UNIX. </span><br><span class="line">10. Using binary mode <span class="keyword">to</span> transfer files. </span><br><span class="line">11. ftp&gt;<span class="built_in"> lcd </span>/var/www/www </span><br><span class="line">12. Local directory now /var/www/www </span><br><span class="line">13. ftp&gt; <span class="builtin-name">get</span> /var/www/www/aaa.html /var/www/www/aaa.html </span><br><span class="line">14. local: /var/www/www/aaa.html remote: /var/www/www/aaa.html </span><br><span class="line">15. 200<span class="built_in"> PORT </span>command successful. Consider using PASV. </span><br><span class="line">16. 150 Opening BINARY mode data<span class="built_in"> connection </span><span class="keyword">for</span> /var/www/www/aaa.html (66 bytes). </span><br><span class="line">17. 226 File send OK. </span><br><span class="line">18. 66 bytes received <span class="keyword">in</span> 0.00 secs (515.6 kB/s) </span><br><span class="line">19. quit aaa.html has been download </span><br><span class="line">20. 221 Goodbye.</span><br></pre></td></tr></table></figure>

<h4 id="单台服务器scp"><a href="#单台服务器scp" class="headerlink" title="单台服务器scp"></a>单台服务器scp</h4><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/expect </span></span><br><span class="line"><span class="keyword">if</span> &#123;$argc &lt; <span class="number">2</span>&#125; &#123;</span><br><span class="line">    send_user <span class="string">"usage: $argv0 src_file username ip dest_file password\n"</span></span><br><span class="line"><span class="keyword">exit</span></span><br><span class="line"><span class="keyword">set</span> timeout <span class="number">10</span> </span><br><span class="line"><span class="keyword">set</span> host [<span class="keyword">lindex</span> $argv <span class="number">0</span>] </span><br><span class="line"><span class="keyword">set</span> username [<span class="keyword">lindex</span> $argv <span class="number">1</span>] </span><br><span class="line"><span class="keyword">set</span> password [<span class="keyword">lindex</span> $argv <span class="number">2</span>] </span><br><span class="line"><span class="keyword">set</span> src_file [<span class="keyword">lindex</span> $argv <span class="number">3</span>] </span><br><span class="line"><span class="keyword">set</span> dest_file [<span class="keyword">lindex</span> $argv <span class="number">4</span>] </span><br><span class="line">spawn scp $src_file $username@$host:$dest_file </span><br><span class="line">expect &#123; </span><br><span class="line"><span class="string">"(yes/no)?"</span> </span><br><span class="line">&#123; </span><br><span class="line">send <span class="string">"yes\n"</span> </span><br><span class="line">expect <span class="string">"*assword:"</span> &#123; send <span class="string">"$password\n"</span>&#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="string">"*assword:"</span> </span><br><span class="line">&#123; </span><br><span class="line">send <span class="string">"$password\n"</span> </span><br><span class="line">&#125; </span><br><span class="line">&#125; </span><br><span class="line">expect <span class="string">"100%"</span> </span><br><span class="line">expect <span class="keyword">eof</span></span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>（1）注意代码刚开始的第一行，指定了expect的路径，与shell脚本相同，这一句指定了程序在执行时到哪里去寻找相应的启动程序。代码刚开始还设定了timeout的时间为10秒，如果在执行scp任务时遇到了代码中没有指定的异常，则在等待10秒后该脚本的执行会自动终止。</p>
<p>（2）这个脚本设置了5个需要手动输入的参数，分别为：目标主机的IP、用户名、密码、本地文件路径、目标主机中的文件路径。如果将以上脚本保存为expect_scp文件，则在shell下执行时需要按以下的规范来输入命令：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./expect_scp <span class="number">192.168</span><span class="number">.75</span><span class="number">.130</span> root <span class="number">123456</span> /root/src_file /root/dest_file</span><br></pre></td></tr></table></figure>

<p>以上的命令执行后，将把本地/root目录下的src_file文件拷贝到用户名为root，密码为123456的主机192.168.75.130中的/root下，同时还将这个源文件重命名为dest_file。</p>
<p>（3）spawn代表在本地终端执行的语句，在该语句开始执行后，expect开始捕获终端的输出信息，然后做出对应的操作。expect代码中的捕获的(yes/no)内容用于完成第一次访问目标主机时保存密钥的操作。有了这一句，scp的任务减少了中断的情况。代码结尾的expect eof与spawn对应，表示捕获终端输出信息的终止。</p>
<h4 id="多台传输脚本"><a href="#多台传输脚本" class="headerlink" title="多台传输脚本"></a><strong>多台传输脚本</strong></h4><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cat</span> mainscp.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">host_list=<span class="string">"server_list.conf"</span></span><br><span class="line">cat <span class="variable">$host_list</span> | <span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"> host_ip=`<span class="built_in">echo</span> <span class="variable">$line</span>|awk <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line"> username=`<span class="built_in">echo</span> <span class="variable">$line</span>|awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line"> password=`<span class="built_in">echo</span> <span class="variable">$line</span>|awk <span class="string">'&#123;print $3&#125;'</span>`</span><br><span class="line"> src_file=`<span class="built_in">echo</span> <span class="variable">$line</span>|awk <span class="string">'&#123;print $4&#125;'</span>`</span><br><span class="line"> dest_file=`<span class="built_in">echo</span> <span class="variable">$line</span>|awk <span class="string">'&#123;print $5&#125;'</span>`</span><br><span class="line"> <span class="comment">##key=`echo $line|awk '&#123;print $6&#125;'`</span></span><br><span class="line"> <span class="comment">##./allscp.sh $key $src_file $username $host_ip $dest_file $password</span></span><br><span class="line"> ./allscp.sh <span class="variable">$src_file</span> <span class="variable">$username</span> <span class="variable">$host_ip</span> <span class="variable">$dest_file</span> <span class="variable">$password</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p><strong>3.服务器信息文件</strong></p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cat</span> server_list.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>

<p>格式为:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ip</span> 用户名 密码 源文件 目标文件地址</span><br></pre></td></tr></table></figure>

<p>通过jenkins加expect部署新项目或增加节点</p>
<p>update.sh</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/expect</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> &#123;$argc &lt; <span class="number">3</span>&#125; &#123;</span><br><span class="line">        send_user <span class="string">"请按照格式输入: $argv0 host_ip username password local_file remote_file project port\n"</span></span><br><span class="line"><span class="keyword">exit</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#接收输入的参数定义为变量</span></span><br><span class="line"><span class="keyword">set</span> host_ip [<span class="keyword">lindex</span> $argv <span class="number">0</span>]</span><br><span class="line"><span class="keyword">set</span> username [<span class="keyword">lindex</span> $argv <span class="number">1</span>]</span><br><span class="line"><span class="keyword">set</span> password [<span class="keyword">lindex</span> $argv <span class="number">2</span>]</span><br><span class="line"><span class="keyword">set</span> local_file [<span class="keyword">lindex</span> $argv <span class="number">3</span>]</span><br><span class="line"><span class="keyword">set</span> remote_file [<span class="keyword">lindex</span> $argv <span class="number">4</span>]</span><br><span class="line"><span class="keyword">set</span> project [<span class="keyword">lindex</span> $argv <span class="number">5</span>]</span><br><span class="line"><span class="keyword">set</span> port [<span class="keyword">lindex</span> $argv <span class="number">6</span>]</span><br><span class="line"></span><br><span class="line">spawn scp <span class="keyword">package</span>/$project.war $username@$host_ip:$remote_file</span><br><span class="line"></span><br><span class="line">expect &#123;</span><br><span class="line"><span class="string">"*password:"</span></span><br><span class="line">        &#123;send <span class="string">"$password\r"</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line">expect <span class="string">"100%"</span></span><br><span class="line">expect <span class="keyword">eof</span></span><br><span class="line">spawn ssh $username@$host_ip</span><br><span class="line"></span><br><span class="line">expect &#123; </span><br><span class="line"><span class="string">"(yes/no)?"</span></span><br><span class="line">	&#123;send <span class="string">"yes\r"</span>&#125;</span><br><span class="line"><span class="string">"*password:"</span></span><br><span class="line">	&#123;send <span class="string">"$password\r"</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line">expect <span class="string">"$"</span></span><br><span class="line">send <span class="string">"cd $remote_file\r"</span></span><br><span class="line">expect <span class="string">"$"</span></span><br><span class="line">send <span class="string">"./killport.sh $port\r"</span></span><br><span class="line">expect <span class="string">"$"</span></span><br><span class="line">send <span class="string">"cd /home/tomcat/tomcat_$port/webapps\r"</span></span><br><span class="line">expect <span class="string">"$"</span></span><br><span class="line">send <span class="string">"tar czvf $project`date +%Y%m%d%H%M%S`.bak.tar $project\r"</span></span><br><span class="line">expect <span class="string">"$"</span></span><br><span class="line">send <span class="string">"rm -r $project.war\r"</span></span><br><span class="line">expect <span class="string">"(yes/no)?"</span></span><br><span class="line">send <span class="string">"yes\r"</span></span><br><span class="line">send <span class="string">"rm -rf $project\r"</span></span><br><span class="line">expect <span class="string">"$"</span></span><br><span class="line">send <span class="string">"mv *.bak.tar backup\r"</span></span><br><span class="line">expect <span class="string">"$"</span></span><br><span class="line">send <span class="string">"mv $remote_file/$project.war /home/tomcat/tomcat_$port/webapps\r"</span></span><br><span class="line">expect <span class="string">"$"</span></span><br><span class="line">send <span class="string">"cd /home/tomcat/tomcat_$port/bin\r"</span></span><br><span class="line">expect <span class="string">"$"</span></span><br><span class="line">send <span class="string">"./startup.sh\r"</span></span><br><span class="line">expect <span class="keyword">eof</span></span><br></pre></td></tr></table></figure>

<p>Release.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">project=<span class="variable">$2</span></span><br><span class="line">host_ip=<span class="variable">$4</span></span><br><span class="line">port=<span class="variable">$6</span></span><br><span class="line"></span><br><span class="line">line1=`ls package|grep <span class="variable">$project</span>`</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$project</span>.war"</span> != <span class="string">"<span class="variable">$line1</span>"</span> ] ; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"请先去jenkins打包,不存在<span class="variable">$project</span>的war包.\n请检查拼写格式:\n</span></span><br><span class="line"><span class="string">        	-P(project name)\n</span></span><br><span class="line"><span class="string">        	-H(host ip)\n</span></span><br><span class="line"><span class="string">        	-Port(tomcat port)\n</span></span><br><span class="line"><span class="string">        	例如:./release.sh -P mfapi -H 192.168.1.1 -Port 8080"</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">line2=`cat files/server_list.conf|grep <span class="variable">$host_ip</span>|awk <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$host_ip</span>"</span> != <span class="string">"<span class="variable">$line2</span>"</span> ] ; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"服务器列表不存在<span class="variable">$host_ip</span>.\n请检查拼写格式:\n</span></span><br><span class="line"><span class="string">        -P(project name)\n</span></span><br><span class="line"><span class="string">        -H(host ip)\n</span></span><br><span class="line"><span class="string">        -Port(tomcat port)\n</span></span><br><span class="line"><span class="string">        例如:./release.sh -P mfapi -H 192.168.1.1 -Port 8080"</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#line3=`ls tomcat/conf|grep $port`</span></span><br><span class="line"><span class="keyword">if</span> [ ! -n <span class="string">"<span class="variable">$port</span>"</span> ] ; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"tomcat中不存在端口为<span class="variable">$port</span>的配置,如有需要请添加.\n请检查拼写格式:\n</span></span><br><span class="line"><span class="string">        -P(project name)\n</span></span><br><span class="line"><span class="string">        -H(host ip)\n</span></span><br><span class="line"><span class="string">        -Port(tomcat port)\n</span></span><br><span class="line"><span class="string">        例如:./release.sh -P mfapi -H 192.168.1.1 -Port 8080"</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>  [ <span class="string">"<span class="variable">$1</span>"</span>a == <span class="string">"-P"</span>a ] &amp;&amp; [ <span class="string">"<span class="variable">$3</span>"</span>c == <span class="string">"-H"</span>c ] &amp;&amp; [ <span class="string">"<span class="variable">$5</span>"</span>e == <span class="string">"-Port"</span>e ] ; <span class="keyword">then</span></span><br><span class="line">	line=`cat files/server_list.conf |grep <span class="variable">$host_ip</span>`</span><br><span class="line">        ip=`<span class="built_in">echo</span> <span class="variable">$line</span>|awk <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line">	username=`<span class="built_in">echo</span> <span class="variable">$line</span>|awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line">	password=`<span class="built_in">echo</span> <span class="variable">$line</span>|awk <span class="string">'&#123;print $3&#125;'</span>`</span><br><span class="line">	local_file=`<span class="built_in">echo</span> <span class="variable">$line</span>|awk <span class="string">'&#123;print $4&#125;'</span>`</span><br><span class="line">	remote_file=`<span class="built_in">echo</span> <span class="variable">$line</span>|awk <span class="string">'&#123;print $5&#125;'</span>`</span><br><span class="line">  ./deploy.sh <span class="variable">$host_ip</span> <span class="variable">$username</span> <span class="variable">$password</span> <span class="variable">$local_file</span> <span class="variable">$remote_file</span> <span class="variable">$project</span> <span class="variable">$port</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"请检查拼写格式:\n</span></span><br><span class="line"><span class="string">        -P(project name)\n</span></span><br><span class="line"><span class="string">        -H(host ip)\n</span></span><br><span class="line"><span class="string">        -Port(tomcat port)\n</span></span><br><span class="line"><span class="string">	例如:./release.sh -P mfapi -H 192.168.1.1 -Port 8080"</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>Deploy.sh</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/expect</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> &#123;$argc &lt; <span class="number">3</span>&#125; &#123;</span><br><span class="line">        send_user <span class="string">"请按照格式输入: $argv0 host_ip username password local_file remote_file project port\n"</span></span><br><span class="line"><span class="keyword">exit</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#接收输入的参数定义为变量</span></span><br><span class="line"><span class="keyword">set</span> host_ip [<span class="keyword">lindex</span> $argv <span class="number">0</span>]</span><br><span class="line"><span class="keyword">set</span> username [<span class="keyword">lindex</span> $argv <span class="number">1</span>]</span><br><span class="line"><span class="keyword">set</span> password [<span class="keyword">lindex</span> $argv <span class="number">2</span>]</span><br><span class="line"><span class="keyword">set</span> local_file [<span class="keyword">lindex</span> $argv <span class="number">3</span>]</span><br><span class="line"><span class="keyword">set</span> remote_file [<span class="keyword">lindex</span> $argv <span class="number">4</span>]</span><br><span class="line"><span class="keyword">set</span> project [<span class="keyword">lindex</span> $argv <span class="number">5</span>]</span><br><span class="line"><span class="keyword">set</span> port [<span class="keyword">lindex</span> $argv <span class="number">6</span>]</span><br><span class="line"></span><br><span class="line">spawn cp files/tomcat.tar.gz .</span><br><span class="line">expect <span class="keyword">eof</span></span><br><span class="line">spawn tar zvxf tomcat.tar.gz</span><br><span class="line">expect <span class="keyword">eof</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#判断项目---------------------------</span></span><br><span class="line"><span class="keyword">if</span> &#123; <span class="string">"$project"</span> != <span class="string">""</span> &#125; &#123;</span><br><span class="line">spawn cp /home/jenkins/nmk/<span class="keyword">package</span>/$project.war /home/jenkins/nmk/tomcat/webapps/</span><br><span class="line">expect <span class="keyword">eof</span></span><br><span class="line">&#125; else &#123;</span><br><span class="line">spawn echo <span class="string">"请输入项目名"</span></span><br><span class="line"><span class="keyword">exit</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#-----------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#判断端口---------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> &#123; <span class="string">"$port"</span> != <span class="string">""</span> &#125; &#123;</span><br><span class="line">spawn rm -r /home/jenkins/nmk/tomcat/conf/server.xml</span><br><span class="line">spawn cp /home/jenkins/nmk/tomcat/conf/server_$port.xml /home/jenkins/nmk/tomcat/conf/server.xml</span><br><span class="line">expect <span class="keyword">eof</span></span><br><span class="line">&#125; else &#123;</span><br><span class="line">spawn echo <span class="string">"请输入端口"</span></span><br><span class="line"><span class="keyword">exit</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#-----------------------------------</span></span><br><span class="line">spawn rm -r tomcat.tar.gz</span><br><span class="line">expect <span class="keyword">eof</span></span><br><span class="line">spawn mv tomcat tomcat_$port</span><br><span class="line">expect <span class="keyword">eof</span></span><br><span class="line">spawn tar zcvf tomcat_$port.tar.gz tomcat_$port</span><br><span class="line">expect <span class="keyword">eof</span></span><br><span class="line">spawn scp $local_file/tomcat_$port.tar.gz $username@$host_ip:$remote_file</span><br><span class="line"></span><br><span class="line">expect &#123; </span><br><span class="line"><span class="string">"(yes/no)?"</span></span><br><span class="line">        &#123;send <span class="string">"yes\r"</span>&#125;</span><br><span class="line"><span class="string">"*password:"</span></span><br><span class="line">        &#123;send <span class="string">"$password\r"</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line">expect <span class="string">"100%"</span></span><br><span class="line">expect <span class="keyword">eof</span></span><br><span class="line">spawn rm -r tomcat_$port.tar.gz</span><br><span class="line">expect <span class="keyword">eof</span></span><br><span class="line">spawn rm -r tomcat_$port</span><br><span class="line">expect <span class="keyword">eof</span></span><br><span class="line">spawn ssh $username@$host_ip</span><br><span class="line"></span><br><span class="line">expect &#123; </span><br><span class="line"><span class="string">"(yes/no)?"</span></span><br><span class="line">	&#123;send <span class="string">"yes\r"</span>&#125;</span><br><span class="line"><span class="string">"*password:"</span></span><br><span class="line">	&#123;send <span class="string">"$password\r"</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line">expect <span class="string">"$"</span></span><br><span class="line">send <span class="string">"cd $remote_file\r"</span></span><br><span class="line">expect <span class="string">"$"</span></span><br><span class="line">send <span class="string">"tar zvxf tomcat_$port.tar.gz\r"</span></span><br><span class="line">expect <span class="string">"$"</span></span><br><span class="line">send <span class="string">"rm -r tomcat_$port.tar.gz\r"</span></span><br><span class="line">expect <span class="string">"(yes/no)?"</span></span><br><span class="line">send <span class="string">"yes\r"</span></span><br><span class="line">expect <span class="string">"$"</span></span><br><span class="line">send <span class="string">"cd tomcat_$port\r"</span></span><br><span class="line">expect <span class="string">"$"</span></span><br><span class="line">send <span class="string">"./bin/startup.sh\r"</span></span><br><span class="line">expect <span class="keyword">eof</span></span><br></pre></td></tr></table></figure>

<p>Files/server_list.conf</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Hostile username password srcfile distfile</span></span><br></pre></td></tr></table></figure>

<p>更多expect的详细命令</p>
<p><a href="https://www.cnblogs.com/lixigang/articles/4849527.html" target="_blank" rel="noopener">https://www.cnblogs.com/lixigang/articles/4849527.html</a></p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>nmk</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://nmk0718.github.io/2020/05/21/expect/">http://nmk0718.github.io/2020/05/21/expect/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2020 <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tag/expect/"># expect</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2020/05/21/Mac/">Mac</a>
            
            
            <a class="next" rel="next" href="/2020/05/21/https丢失/">https转发时丢失</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© nmk | Powered by <a href="https://hexo.io" target="_blank">Hexo</a></span>
	</div>
</footer>

    </div>
</body>
</html>
