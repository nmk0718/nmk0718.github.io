<!DOCTYPE html>
<html lang>
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="kk">





<title>mysql</title>



    <link rel="icon" href="/favicon.png">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    

<link rel="alternate" href="/atom.xml" title="kk's Blog" type="application/atom+xml">
</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">kk&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/moments">Moments</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">kk&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/app">App</a>
                
                    <a class="menu-item" href="/moments">Moments</a>
                
                    <a class="menu-item" href="/map">Map</a>
                
                    <a class="menu-item" href="/game">Game</a>
                
                    <a class="menu-item" href="/media">Media</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">mysql</h1>
            
                <div class="post-meta">
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2020-04-09&nbsp;&nbsp;00:20</a>
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h3 id="安装mysql"><a href="#安装mysql" class="headerlink" title="安装mysql"></a>安装mysql</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#此次安装为mysql5.7版本,使用yum install mysql默认安装为mariadb</span><br><span class="line"></span><br><span class="line">wget https://repo.mysql.com/mysql80-community-release-el7-3.noarch.rpm</span><br><span class="line">#下载rpm包</span><br><span class="line">rpm -ivh mysql80-community-release-el7-3.noarch.rpm</span><br><span class="line">#安装rpm包</span><br><span class="line">yum repolist all | grep mysql </span><br><span class="line">#查看包版本</span><br><span class="line">yum-config-manager --disable mysql80-community</span><br><span class="line">#取消mysql80-community的默认安装</span><br><span class="line">yum-config-manager --enable mysql57-community</span><br><span class="line">#更改为mysql57-community默认安装版本</span><br><span class="line">#如不能使用使用yum-config-manager请使用yum -y install yum-utils</span><br><span class="line">yum install mysql-community-server</span><br><span class="line">yum -y install mysql-devel</span><br><span class="line">#安装完毕</span><br></pre></td></tr></table></figure>

<h3 id="mysql使用"><a href="#mysql使用" class="headerlink" title="mysql使用"></a>mysql使用</h3><h4 id="mysql服务"><a href="#mysql服务" class="headerlink" title="mysql服务"></a>mysql服务</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CentOS 7之前</span><br><span class="line">service mysqld start 			 ——启动mysql服务</span><br><span class="line">service mysqld stop              ——停止mysql服务</span><br><span class="line">service mysqld restart  		 ——重启mysql服务</span><br><span class="line">service mysqld status			 ——查看mysql服务</span><br><span class="line">CentOS 7.x开始，CentOS开始使用systemd服务来代替daemon</span><br><span class="line">systemctl start mysqld.service 	 ——启动mysql服务</span><br><span class="line">systemctl stop mysqld.service 	 ——停止mysql服务</span><br><span class="line">systemctl restart mysqld.service ——重启mysql服务</span><br><span class="line">systemctl status mysqld.service  ——查看mysql状态</span><br><span class="line">mysql -V --查看mysql版本</span><br></pre></td></tr></table></figure>

<h4 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line">#本地登陆</span><br><span class="line"></span><br><span class="line">mysql -h主机地址 -P端口 -u用户名 －p用户密码</span><br><span class="line">#远程登陆</span><br><span class="line"></span><br><span class="line">grep &quot;temporary password&quot; /var/log/mysqld.log</span><br><span class="line">#获取临时密码</span><br></pre></td></tr></table></figure>

<h4 id="修改默认密码"><a href="#修改默认密码" class="headerlink" title="修改默认密码"></a>修改默认密码</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; ALTER USER USER() IDENTIFIED BY &apos;nmk0718&apos;;</span><br><span class="line">#如需弱密码请使用一下命令</span><br><span class="line">mysql&gt; set global validate_password_policy=LOW;</span><br><span class="line">mysql&gt; set global validate_password_length=6;</span><br></pre></td></tr></table></figure>

<h4 id="开启远程连接"><a href="#开启远程连接" class="headerlink" title="开启远程连接"></a>开启远程连接</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; grant all privileges on *.* to &apos;root&apos;@&apos;%&apos; identified by &apos;nmk0718&apos;;</span><br><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure>

<h4 id="退出mysql"><a href="#退出mysql" class="headerlink" title="退出mysql"></a>退出mysql</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; exit/quit;</span><br></pre></td></tr></table></figure>

<h4 id="忘记密码"><a href="#忘记密码" class="headerlink" title="忘记密码"></a>忘记密码</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl stop mysqld.service</span><br><span class="line">#停止服务</span><br><span class="line"></span><br><span class="line">vi /etc/my.cnf</span><br><span class="line">#编辑配置文件在socket=/var/lib/mysql/mysql.sock下一行加入skip-grant-tables</span><br><span class="line">#作用为跳过密码验证</span><br><span class="line"></span><br><span class="line">systemctl start mysqld.service</span><br><span class="line">#启动服务</span><br><span class="line"></span><br><span class="line">mysql -u root</span><br><span class="line">mysql&gt;update mysql.user set authentication_string=password(&apos;nmk0718&apos;) where user=&apos;root&apos;;</span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">mysql&gt; exit</span><br><span class="line">#进入mysql修改密码</span><br><span class="line"></span><br><span class="line">systemctl stop mysqld.service</span><br><span class="line"></span><br><span class="line">vi /etc/my.cnf</span><br><span class="line">#删除加入的skip-grant-tables</span><br><span class="line"></span><br><span class="line">systemctl start mysqld.service</span><br></pre></td></tr></table></figure>

<h4 id="查看密码策略"><a href="#查看密码策略" class="headerlink" title="查看密码策略"></a>查看密码策略</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#查看密码策略</span><br><span class="line">mysql&gt; show variables like &apos;%validate_password_policy%&apos;;</span><br><span class="line">+--------------------------+--------+</span><br><span class="line">| Variable_name            | Value  |</span><br><span class="line">+--------------------------+--------+</span><br><span class="line">| validate_password_policy | MEDIUM |</span><br><span class="line">+--------------------------+--------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show variables like &apos;%validate_password_length%&apos;;</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">| Variable_name            | Value |</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">| validate_password_length | 8     |</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">#修改密码策略</span><br><span class="line">set global validate_password_policy=0;</span><br><span class="line">set global validate_password_length=1;</span><br></pre></td></tr></table></figure>

<p>validate_password.policy（校验规则），取值范围[0,1,2]，默认值1。0（LOW）：只校验长度；1（MEDIUM）：校验长度、大小写和特殊字符；2（STRONG）：校验长度、大小写、特殊字符和dictionary_file</p>
<p>密码策略的所有参数：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; SHOW VARIABLES LIKE &apos;validate_password%&apos;;</span><br><span class="line">+--------------------------------------+-------+</span><br><span class="line">| Variable_name                        | Value |</span><br><span class="line">+--------------------------------------+-------+</span><br><span class="line">| validate_password_check_user_name    | OFF   |</span><br><span class="line">| validate_password_dictionary_file    |       |</span><br><span class="line">| validate_password_length             | 4     |</span><br><span class="line">| validate_password_mixed_case_count   | 1     |</span><br><span class="line">| validate_password_number_count       | 1     |</span><br><span class="line">| validate_password_policy             | LOW   |</span><br><span class="line">| validate_password_special_char_count | 1     |</span><br><span class="line">+--------------------------------------+-------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="mysql常用命令"><a href="#mysql常用命令" class="headerlink" title="mysql常用命令"></a>mysql常用命令</h3><h4 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; create database &lt;数据库名&gt; default character set &lt;编码格式&gt; collate &lt;校验集&gt;;</span><br></pre></td></tr></table></figure>

<h4 id="显示所有数据库"><a href="#显示所有数据库" class="headerlink" title="显示所有数据库"></a>显示所有数据库</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; show databases;</span><br></pre></td></tr></table></figure>

<h4 id="删除数据库"><a href="#删除数据库" class="headerlink" title="删除数据库"></a>删除数据库</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; drop database &lt;数据库名&gt;;</span><br></pre></td></tr></table></figure>

<h4 id="选择数据库"><a href="#选择数据库" class="headerlink" title="选择数据库"></a>选择数据库</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; use &lt;数据库名&gt;;</span><br></pre></td></tr></table></figure>

<h4 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; create table &lt;表名&gt; (&lt;字段名1&gt; &lt;类型1&gt; [,..&lt;字段名n&gt; &lt;类型n&gt;]);</span><br></pre></td></tr></table></figure>

<h4 id="显示表"><a href="#显示表" class="headerlink" title="显示表"></a>显示表</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; show tables;</span><br></pre></td></tr></table></figure>

<h4 id="显示表结构"><a href="#显示表结构" class="headerlink" title="显示表结构"></a>显示表结构</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; desc &lt;表名&gt;；或者show columns from 表名;</span><br></pre></td></tr></table></figure>

<h4 id="删除表"><a href="#删除表" class="headerlink" title="删除表"></a>删除表</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; drop table &lt;表名&gt;；</span><br></pre></td></tr></table></figure>

<h4 id="插入表数据"><a href="#插入表数据" class="headerlink" title="插入表数据"></a>插入表数据</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; insert into &lt;表名&gt; [( &lt;字段名1&gt;[,..&lt;字段名n &gt; ])] values ( 值1 )[, ( 值n )]</span><br></pre></td></tr></table></figure>

<h4 id="查询表数据"><a href="#查询表数据" class="headerlink" title="查询表数据"></a>查询表数据</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select &lt;目标列表表达式列表&gt; </span><br><span class="line">			 from &lt; 表名或视图名 &gt; </span><br><span class="line">			 where &lt; 条件 &gt; </span><br><span class="line">			 group by &lt;分组表达式&gt;</span><br><span class="line">			 having &lt;条件&gt;</span><br><span class="line">			 order by &lt;排序表达式&gt;[ASC|DESC]</span><br></pre></td></tr></table></figure>

<h4 id="删除表数据"><a href="#删除表数据" class="headerlink" title="删除表数据"></a>删除表数据</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; delete from 表名 where 表达式;</span><br></pre></td></tr></table></figure>

<h4 id="修改表数据"><a href="#修改表数据" class="headerlink" title="修改表数据"></a>修改表数据</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; update 表名 set 字段=新值,… where 条件;</span><br></pre></td></tr></table></figure>

<h4 id="修改表名"><a href="#修改表名" class="headerlink" title="修改表名"></a>修改表名</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; rename table 原表名 to 新表名;</span><br></pre></td></tr></table></figure>

<h4 id="增加表字段"><a href="#增加表字段" class="headerlink" title="增加表字段"></a>增加表字段</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; alter table 表名 add 字段 类型 其他;</span><br></pre></td></tr></table></figure>

<h4 id="修改字段类型"><a href="#修改字段类型" class="headerlink" title="修改字段类型"></a>修改字段类型</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; alter table 表名 modify 字段 旧类型 新类型;</span><br></pre></td></tr></table></figure>

<h4 id="删除字段"><a href="#删除字段" class="headerlink" title="删除字段"></a>删除字段</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; alter table 表名 drop 字段;</span><br></pre></td></tr></table></figure>

<h4 id="修改字段的注释"><a href="#修改字段的注释" class="headerlink" title="修改字段的注释"></a>修改字段的注释</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; alter table `表名` modify column `id` comment &apos;学号&apos;;</span><br></pre></td></tr></table></figure>

<h4 id="加索引"><a href="#加索引" class="headerlink" title="加索引"></a>加索引</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; alter table 表名 add index 索引名 (字段名1[，字段名2 …]);</span><br></pre></td></tr></table></figure>

<h4 id="加主关键字的索引"><a href="#加主关键字的索引" class="headerlink" title="加主关键字的索引"></a>加主关键字的索引</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; alter table 表名 add primary key (字段名);</span><br></pre></td></tr></table></figure>

<h4 id="加唯一限制条件的索引"><a href="#加唯一限制条件的索引" class="headerlink" title="加唯一限制条件的索引"></a>加唯一限制条件的索引</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; alter table 表名 add unique 索引名 (字段名);</span><br></pre></td></tr></table></figure>

<h4 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; alter table 表名 drop index 索引名;</span><br></pre></td></tr></table></figure>

<h4 id="备份数据库"><a href="#备份数据库" class="headerlink" title="备份数据库"></a>备份数据库</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#mysqldump 在windows下进行备份需要cmd的管理员身份</span><br><span class="line">mysqldump -h主机名(ip) -P端口 -u 用户名 -p密码 数据库名1 数据库名2 &gt; 文件名.sql</span><br></pre></td></tr></table></figure>

<h4 id="备份数据库的某张表"><a href="#备份数据库的某张表" class="headerlink" title="备份数据库的某张表"></a>备份数据库的某张表</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysqldump -h主机名(ip) -u 用户名 -p 数据库名 表1 表2 表3 &gt; 文件名.sql</span><br></pre></td></tr></table></figure>

<h4 id="备份所有数据库"><a href="#备份所有数据库" class="headerlink" title="备份所有数据库"></a>备份所有数据库</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysqldump -uroot -p --all-databases &gt; 文件名.sql</span><br></pre></td></tr></table></figure>

<h4 id="还原数据库"><a href="#还原数据库" class="headerlink" title="还原数据库"></a>还原数据库</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysqldump -uroot -p 数据库名 &lt; 文件名.sql</span><br></pre></td></tr></table></figure>

<h4 id="删除数据库-1"><a href="#删除数据库-1" class="headerlink" title="删除数据库"></a>删除数据库</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; drop database 数据库名</span><br></pre></td></tr></table></figure>

<h4 id="恢复数据库"><a href="#恢复数据库" class="headerlink" title="恢复数据库"></a>恢复数据库</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#先创建同名数据库</span><br><span class="line">CREATE DATABASE 数据库名;</span><br><span class="line">use 数据库名;</span><br><span class="line">source 备份文件的路径 文件名.sql</span><br></pre></td></tr></table></figure>

<h3 id="mysql开启binlog"><a href="#mysql开启binlog" class="headerlink" title="mysql开启binlog"></a>mysql开启binlog</h3><h4 id="查看binlog日志的状态"><a href="#查看binlog日志的状态" class="headerlink" title="查看binlog日志的状态"></a>查看binlog日志的状态</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like &apos;%log_bin%&apos;;</span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">| Variable_name                   | Value |</span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">| log_bin                         | OFF   |</span><br><span class="line">| log_bin_basename                |       |</span><br><span class="line">| log_bin_index                   |       |</span><br><span class="line">| log_bin_trust_function_creators | OFF   |</span><br><span class="line">| log_bin_use_v1_row_events       | OFF   |</span><br><span class="line">| sql_log_bin                     | ON    |</span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line">得知 log_bin为OFF</span><br></pre></td></tr></table></figure>

<p>退出mysql,修改my.cnf</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server-id=1</span><br><span class="line">log-bin=/var/lib/mysql/mysql-bin</span><br><span class="line"># server-id表示单个结点的id，这里由于只有一个结点，所以可以把id随机指定为一个数，这里将id设置成1。若集群中有个	结点，则id不能相同</span><br><span class="line"># 第二句是指定binlog日志文件的名字为mysql-bin，以及其存储路径</span><br></pre></td></tr></table></figure>

<h4 id="重启myql"><a href="#重启myql" class="headerlink" title="重启myql"></a>重启myql</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>

<p>进入mysql,查看binlog日志的状态</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt;  show variables like &apos;%log_bin%&apos;;</span><br><span class="line">+---------------------------------+--------------------------------+</span><br><span class="line">| Variable_name                   | Value                          |</span><br><span class="line">+---------------------------------+--------------------------------+</span><br><span class="line">| log_bin                         | ON                             |</span><br><span class="line">| log_bin_basename                | /var/lib/mysql/mysql-bin       |</span><br><span class="line">| log_bin_index                   | /var/lib/mysql/mysql-bin.index |</span><br><span class="line">| log_bin_trust_function_creators | OFF                            |</span><br><span class="line">| log_bin_use_v1_row_events       | OFF                            |</span><br><span class="line">| sql_log_bin                     | ON                             |</span><br><span class="line">+---------------------------------+--------------------------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="MySQL数据库-Too-many-connections"><a href="#MySQL数据库-Too-many-connections" class="headerlink" title="MySQL数据库 Too many connections"></a>MySQL数据库 Too many connections</h3><p>从官方文档知道Linux上面编译安装的mysql默认的连接为100个</p>
<p>文档：<a href="http://dev.mysql.com/doc/refman/5.0/en/too-many-connections.html" target="_blank" rel="noopener">http://dev.mysql.com/doc/refman/5.0/en/too-many-connections.html</a></p>
<p>mysql官方告诉我们需要修改max_connections的值,那么我们怎么去修改呢？有两种方法</p>
<p><strong>1、修改配置文件文件</strong></p>
<p>修改/etc/my.cnf这个文件，在[mysqld] 中新增max_connections=N，如果你没有这个文件请从编译源码中的support-files文件夹中复制你所需要的*.cnf文件为到 /etc/my.cnf。我使用的是my-medium.cnf,中型服务器配置。例如我的[mysqld]的内容如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[mysqld]` `port = 3306` `socket = ``/tmp/mysql``.sock` `skip-locking` `key_buffer = 160M` `max_allowed_packet = 1M` `table_cache = 64` `sort_buffer_size = 512K` `net_buffer_length = 8K` `read_buffer_size = 256K` `read_rnd_buffer_size = 512K` `myisam_sort_buffer_size = 8M` `max_connections=1000</span><br></pre></td></tr></table></figure>

<p>由于对mysql还不是很熟悉，所以很多参数没有修改。哈哈。。</p>
<p><strong>2、非使用mysqld脚本自动启动的用户。</strong></p>
<p>修改MYSQLHOME/bin/mysqldsafe文件例如：/usr/local/mysql/bin/mysqldsafe这个文件grep−n‘maxconnection′</p>
<p>MYSQLHOME/bin/mysqldsafe文件例如：/usr/local/mysql/bin/mysqldsafe这个文件grep−n‘maxconnection′MYSQL_HOME/bin/mysqld_safe</p>
<p>修改对应行号的max_connections参数值</p>
<p><strong>3、服务器登录mysql ： mysql -u root -p</strong></p>
<p>百分之九十进不去，进不去的执行重启命令 ：/etc/init.d/mysql restart（centos系统）</p>
<p>此时重启mysql就能连接mysql了，如果还有时间，可以继续下一步，治病要治本</p>
<p>打开配置文件 添加一下配置 vi /etc/my.cnf</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wait_timeout = 600` `interactive_timeout = 600</span><br></pre></td></tr></table></figure>

<p>再次重启mysql即可</p>
<p><strong>原理解答</strong></p>
<p>mysql 默认100 连接数，超过则连不上，实际工作的连接数远远没有100，大部分在sleep</p>
<p>所以要么增大连接数，要么杀掉无用连接，推荐后者。</p>
<p>使用Navicat工具连接&gt;服务器监控&gt;查看进程数,杀掉进程数到100以内即可</p>
<h3 id="Linux下配置mysql允许指定IP远程访问"><a href="#Linux下配置mysql允许指定IP远程访问" class="headerlink" title="Linux下配置mysql允许指定IP远程访问"></a>Linux下配置mysql允许指定IP远程访问</h3><h4 id="登录数据库"><a href="#登录数据库" class="headerlink" title="登录数据库"></a>登录数据库</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@dev-database ~]# mysql -uroot -p</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 10511</span><br><span class="line">Server version: 5.7.32 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br></pre></td></tr></table></figure>

<h4 id="查看用户表"><a href="#查看用户表" class="headerlink" title="查看用户表"></a>查看用户表</h4><p>进入mysql数据库,查看用户表</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; use mysql;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql&gt;  select Host,User from user;</span><br><span class="line">+-----------+---------------+</span><br><span class="line">| Host      | User          |</span><br><span class="line">+-----------+---------------+</span><br><span class="line">| localhost | root          |</span><br><span class="line">| localhost | exporter      |</span><br><span class="line">| localhost | mysql.session |</span><br><span class="line">| localhost | mysql.sys     |</span><br><span class="line">| localhost | root          |</span><br><span class="line">+-----------+---------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="更新-授权用户表"><a href="#更新-授权用户表" class="headerlink" title="更新/授权用户表"></a>更新/授权用户表</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//更新用户表</span><br><span class="line">mysql&gt; update user  set Host = &apos;%&apos; where Host = &apos;localhost&apos; and user = &apos;root&apos;; </span><br><span class="line">或</span><br><span class="line">mysql&gt; UPDATE `user` SET `Host` = &apos;192.168.50.*&apos; where `Host` = &apos;localhost&apos; and user = &apos;root&apos;;</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">192.168.50.*是允许远程访问的IP的值,root是账户名 </span><br><span class="line">即，允许来自10.42.*.*的连接并使用root账户进行访问。 </span><br><span class="line">而IP这里，可以使用%来表示所有IP。</span><br><span class="line">第二行是使设置立刻生效。</span><br></pre></td></tr></table></figure>

<h4 id="mysql-创建只读账户"><a href="#mysql-创建只读账户" class="headerlink" title="mysql 创建只读账户"></a>mysql 创建只读账户</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1、创建账户 并授权SELECT查询权限。 dbname可使用*代替所有数据库</span><br><span class="line"></span><br><span class="line">&gt; GRANT SELECT ON dbname.* TO &apos;onlyread&apos;@&apos;%&apos; IDENTIFIED BY &quot;password&quot;;</span><br><span class="line"></span><br><span class="line">2.刷新mysql权限，使用户创建、授权生效。</span><br><span class="line"></span><br><span class="line">&gt; FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>

<h3 id="性能测试-——-MySQL-基准测试"><a href="#性能测试-——-MySQL-基准测试" class="headerlink" title="性能测试 —— MySQL 基准测试"></a>性能测试 —— MySQL 基准测试</h3><p>主要是 4 个指标：</p>
<ul>
<li>TPS ：Transactions Per Second ，即数据库每秒执行的事务数，以 commit 成功次数为准。</li>
<li>QPS ：Queries Per Second ，即数据库每秒执行的 SQL 数（含 insert、select、update、delete 等）。</li>
<li>RT ：Response Time ，响应时间。包括平均响应时间、最小响应时间、最大响应时间、每个响应时间的查询占比。比较需要重点关注的是，前 95-99% 的最大响应时间。因为它决定了大多数情况下的短板。</li>
<li>Concurrency Threads ：并发量，每秒可处理的查询请求的数量。</li>
</ul>
<h4 id="sysbench"><a href="#sysbench" class="headerlink" title="sysbench"></a>sysbench</h4><blockquote>
<p>sysbench 是一个模块化的、跨平台、多线程基准测试工具，主要用于评估测试各种不同系统参数下的数据库负载情况。它主要包括以下几种方式的测试：</p>
</blockquote>
<ul>
<li>CPU 性能</li>
<li>磁盘 IO 性能</li>
<li>调度程序性能</li>
<li>内存分配及传输速度</li>
<li>POSIX 线程性能</li>
<li>数据库性能(OLTP 基准测试)</li>
</ul>
<p>目前 sysbench 主要支持 MySQL、PgSQL、Oracle 这 3 种数据库。</p>
<h5 id="安装工具"><a href="#安装工具" class="headerlink" title="安装工具"></a>安装工具</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl -s https://packagecloud.io/install/repositories/akopytov/sysbench/script.rpm.sh | sudo bash</span><br><span class="line">sudo yum -y install sysbench</span><br></pre></td></tr></table></figure>

<p>查看版本号</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sysbench --version</span><br><span class="line"></span><br><span class="line">sysbench 1.0.20</span><br></pre></td></tr></table></figure>

<h5 id="准备数据"><a href="#准备数据" class="headerlink" title="准备数据"></a>准备数据</h5><p>需要先创建数据库sbtest</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /usr/share/sysbench/</span><br><span class="line">sysbench oltp_common.lua --time=300 --mysql-host=127.0.0.1 --mysql-port=3306 --mysql-user=root --mysql-password=nmk@0718 --mysql-db=sbtest --table-size=1000000 --tables=10 --threads=32 --events=999999999 prepare</span><br></pre></td></tr></table></figure>

<p><code>oltp_common.lua</code> ：执行的测试脚本。 <code>/usr/share/sysbench/</code> 目录下，可看到 sysbench 自带的 lua 测试脚本。</p>
<p><code>--time</code> ：最大的总执行时间，以秒为单位，默认为 10 秒。</p>
<p><code>--events</code> ：最大允许的事件个数，默认为 0 个。<br> 应该和 <code>--time</code> 互相形成最大的执行时间与次数。</p>
<p><code>--mysql-host</code> ：MySQL server host 。</p>
<p><code>--mysql-port</code> ：MySQL server port 。</p>
<p><code>--mysql-user</code> ：MySQL server 账号。</p>
<p><code>--mysql-password</code> ：MySQL server 密码。</p>
<p><code>--mysql-db</code> ：MySQL Server 数据库名。</p>
<p><code>--table-size</code> ：表记录条数。</p>
<p><code>--tables</code> ：表名。</p>
<p><code>--threads</code> ：要使用的线程数，默认 1 个。</p>
<p><code>--report-interval</code> ：以秒为单位定期报告具有指定间隔的中间统计信息，默认为 0 ，表示禁用中间报告。</p>
<p><code>prepare</code> ：执行准备数据。</p>
<p>执行命令后，会自动生成数据库的表、和数据。如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sysbench oltp_common.lua --time=300 --mysql-host=127.0.0.1 --mysql-port=3306 --mysql-user=root --mysql-password=nmk@0718 --mysql-db=sbtest --table-size=1000000 --tables=10 --threads=32 --events=999999999 prepare</span><br><span class="line">sysbench 1.0.20 (using bundled LuaJIT 2.1.0-beta2)</span><br><span class="line"></span><br><span class="line">Initializing worker threads...</span><br><span class="line"></span><br><span class="line">Creating table 'sbtest10'...</span><br><span class="line">Creating table 'sbtest9'...</span><br><span class="line">Creating table 'sbtest1'...</span><br><span class="line">Creating table 'sbtest4'...</span><br><span class="line">Creating table 'sbtest7'...</span><br><span class="line">Creating table 'sbtest3'...</span><br><span class="line">Creating table 'sbtest8'...</span><br><span class="line">Creating table 'sbtest5'...</span><br><span class="line">Creating table 'sbtest6'...</span><br><span class="line">Creating table 'sbtest2'...</span><br><span class="line">Inserting 1000000 records into 'sbtest1'</span><br><span class="line">Inserting 1000000 records into 'sbtest4'</span><br><span class="line">Inserting 1000000 records into 'sbtest8'</span><br><span class="line">Inserting 1000000 records into 'sbtest10'</span><br><span class="line">Inserting 1000000 records into 'sbtest6'</span><br><span class="line">Inserting 1000000 records into 'sbtest9'</span><br><span class="line">Inserting 1000000 records into 'sbtest2'</span><br><span class="line">Inserting 1000000 records into 'sbtest3'</span><br><span class="line">Inserting 1000000 records into 'sbtest7'</span><br><span class="line">Inserting 1000000 records into 'sbtest5'</span><br><span class="line">Creating a secondary index on 'sbtest8'...</span><br><span class="line">Creating a secondary index on 'sbtest10'...</span><br><span class="line">Creating a secondary index on 'sbtest7'...</span><br><span class="line">Creating a secondary index on 'sbtest1'...</span><br><span class="line">Creating a secondary index on 'sbtest5'...</span><br><span class="line">Creating a secondary index on 'sbtest2'...</span><br><span class="line">Creating a secondary index on 'sbtest6'...</span><br><span class="line">Creating a secondary index on 'sbtest3'...</span><br><span class="line">Creating a secondary index on 'sbtest4'...</span><br><span class="line">Creating a secondary index on 'sbtest9'...</span><br></pre></td></tr></table></figure>

<h5 id="执行测试"><a href="#执行测试" class="headerlink" title="执行测试"></a>执行测试</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sysbench oltp_read_write.lua --time=300 --mysql-host=127.0.0.1 --mysql-port=3306 --mysql-user=root --mysql-password=nmk@0718 --mysql-db=sbtest --table-size=1000000 --tables=10 --threads=16 --events=999999999  --report-interval=10  run</span><br></pre></td></tr></table></figure>

<p><code>oltp_read_write.lua</code> ：执行的测试脚本。此时，我们在 <code>/usr/share/sysbench/</code> 下，寻找我们想要测试的场景。<br> <code>oltp_read_write.lua</code> ，表示混合读写，在一个事务中，默认比例是：<code>select:update_key:update_non_key:delete:insert = 14:1:1:1:1</code> 。这也是为什么，我们测试出来的 TPS 和 QPS 的比例，大概在 1:18~20 左右。相当于说，一个事务中，有 18 个读写操作。</p>
<p><code>run</code> ：执行测试。</p>
<p>执行后，效果如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sysbench 1.0.20 (using bundled LuaJIT 2.1.0-beta2)</span><br><span class="line"></span><br><span class="line">Running the test with following options:</span><br><span class="line">Number of threads: 16</span><br><span class="line">Report intermediate results every 10 second(s)</span><br><span class="line">Initializing random number generator from current time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Initializing worker threads...</span><br><span class="line"></span><br><span class="line">Threads started!</span><br><span class="line"></span><br><span class="line">[ 10s ] thds: 16 tps: 84.35 qps: 1712.07 (r/w/o: 1199.55/342.21/170.31) lat (ms,95%): 493.24 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 20s ] thds: 16 tps: 81.80 qps: 1636.72 (r/w/o: 1147.52/325.60/163.60) lat (ms,95%): 484.44 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 30s ] thds: 16 tps: 67.11 qps: 1323.22 (r/w/o: 923.59/265.42/134.21) lat (ms,95%): 484.44 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 40s ] thds: 16 tps: 69.40 qps: 1390.70 (r/w/o: 974.00/277.90/138.80) lat (ms,95%): 484.44 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 50s ] thds: 16 tps: 64.80 qps: 1296.69 (r/w/o: 907.10/260.00/129.60) lat (ms,95%): 520.62 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 60s ] thds: 16 tps: 57.20 qps: 1162.30 (r/w/o: 815.80/232.10/114.40) lat (ms,95%): 467.30 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 70s ] thds: 16 tps: 67.50 qps: 1332.64 (r/w/o: 932.26/265.39/134.99) lat (ms,95%): 458.96 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 80s ] thds: 16 tps: 75.90 qps: 1531.58 (r/w/o: 1073.65/306.12/151.81) lat (ms,95%): 493.24 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 90s ] thds: 16 tps: 66.60 qps: 1314.38 (r/w/o: 917.29/263.90/133.20) lat (ms,95%): 511.33 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 100s ] thds: 16 tps: 66.70 qps: 1346.71 (r/w/o: 944.91/268.40/133.40) lat (ms,95%): 442.73 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 110s ] thds: 16 tps: 78.30 qps: 1555.41 (r/w/o: 1086.40/312.40/156.60) lat (ms,95%): 442.73 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 120s ] thds: 16 tps: 67.00 qps: 1335.70 (r/w/o: 934.50/267.20/134.00) lat (ms,95%): 484.44 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 130s ] thds: 16 tps: 79.90 qps: 1602.00 (r/w/o: 1121.60/320.60/159.80) lat (ms,95%): 442.73 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 140s ] thds: 16 tps: 74.50 qps: 1492.78 (r/w/o: 1046.49/297.30/149.00) lat (ms,95%): 493.24 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 150s ] thds: 16 tps: 66.40 qps: 1320.31 (r/w/o: 922.11/265.40/132.80) lat (ms,95%): 502.20 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 160s ] thds: 16 tps: 72.40 qps: 1448.70 (r/w/o: 1014.20/289.70/144.80) lat (ms,95%): 493.24 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 170s ] thds: 16 tps: 61.20 qps: 1228.50 (r/w/o: 860.80/245.30/122.40) lat (ms,95%): 539.71 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 180s ] thds: 16 tps: 71.10 qps: 1421.40 (r/w/o: 994.90/284.30/142.20) lat (ms,95%): 493.24 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 190s ] thds: 16 tps: 85.50 qps: 1728.80 (r/w/o: 1211.20/346.60/171.00) lat (ms,95%): 475.79 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 200s ] thds: 16 tps: 83.10 qps: 1642.10 (r/w/o: 1148.00/327.90/166.20) lat (ms,95%): 484.44 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 210s ] thds: 16 tps: 73.40 qps: 1481.79 (r/w/o: 1040.30/294.70/146.80) lat (ms,95%): 530.08 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 220s ] thds: 16 tps: 66.00 qps: 1302.51 (r/w/o: 908.31/262.20/132.00) lat (ms,95%): 484.44 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 230s ] thds: 16 tps: 78.00 qps: 1560.70 (r/w/o: 1092.70/312.00/156.00) lat (ms,95%): 442.73 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 240s ] thds: 16 tps: 80.20 qps: 1624.76 (r/w/o: 1139.97/324.39/160.40) lat (ms,95%): 493.24 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 250s ] thds: 16 tps: 85.50 qps: 1692.85 (r/w/o: 1183.14/338.71/171.01) lat (ms,95%): 502.20 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 260s ] thds: 16 tps: 81.50 qps: 1627.90 (r/w/o: 1139.10/325.80/163.00) lat (ms,95%): 511.33 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 270s ] thds: 16 tps: 79.00 qps: 1579.80 (r/w/o: 1105.20/316.60/158.00) lat (ms,95%): 502.20 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 280s ] thds: 16 tps: 83.38 qps: 1688.98 (r/w/o: 1185.67/336.54/166.77) lat (ms,95%): 475.79 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 290s ] thds: 16 tps: 71.51 qps: 1412.67 (r/w/o: 986.29/283.35/143.03) lat (ms,95%): 467.30 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[ 300s ] thds: 16 tps: 87.60 qps: 1759.34 (r/w/o: 1234.26/350.19/174.89) lat (ms,95%): 493.24 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">SQL statistics:</span><br><span class="line">    queries performed:</span><br><span class="line">        read:                            311990</span><br><span class="line">        write:                           89140</span><br><span class="line">        other:                           44570</span><br><span class="line">        total:                           445700</span><br><span class="line">    transactions:                        22285  (74.27 per sec.)</span><br><span class="line">    queries:                             445700 (1485.31 per sec.)</span><br><span class="line">    ignored errors:                      0      (0.00 per sec.)</span><br><span class="line">    reconnects:                          0      (0.00 per sec.)</span><br><span class="line"></span><br><span class="line">General statistics:</span><br><span class="line">    total time:                          300.0677s</span><br><span class="line">    total number of events:              22285</span><br><span class="line"></span><br><span class="line">Latency (ms):</span><br><span class="line">         min:                                    8.23</span><br><span class="line">         avg:                                  215.40</span><br><span class="line">         max:                                 1186.15</span><br><span class="line">         95th percentile:                      493.24</span><br><span class="line">         sum:                              4800079.56</span><br><span class="line"></span><br><span class="line">Threads fairness:</span><br><span class="line">    events (avg/stddev):           1392.8125/8.30</span><br><span class="line">    execution time (avg/stddev):   300.0050/0.01</span><br></pre></td></tr></table></figure>

<p>机械盘16 线程 + 每个表 100w 数据：74TPS+1485QPS+215ms延迟</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SQL statistics:</span><br><span class="line">    queries performed:</span><br><span class="line">        read:                            1076334</span><br><span class="line">        write:                           307524</span><br><span class="line">        other:                           153762</span><br><span class="line">        total:                           1537620</span><br><span class="line">    transactions:                        76881  (256.22 per sec.)</span><br><span class="line">    queries:                             1537620 (5124.31 per sec.)</span><br><span class="line">    ignored errors:                      0      (0.00 per sec.)</span><br><span class="line">    reconnects:                          0      (0.00 per sec.)</span><br><span class="line"></span><br><span class="line">General statistics:</span><br><span class="line">    total time:                          300.0601s</span><br><span class="line">    total number of events:              76881</span><br><span class="line"></span><br><span class="line">Latency (ms):</span><br><span class="line">         min:                                   12.82</span><br><span class="line">         avg:                                   62.43</span><br><span class="line">         max:                                  316.03</span><br><span class="line">         95th percentile:                      125.52</span><br><span class="line">         sum:                              4799650.04</span><br><span class="line"></span><br><span class="line">Threads fairness:</span><br><span class="line">    events (avg/stddev):           4805.0625/25.22</span><br><span class="line">    execution time (avg/stddev):   299.9781/0.01</span><br></pre></td></tr></table></figure>

<p>SSD盘16 线程 + 每个表 100w 数据：256TPS+5124QPS+62ms延迟</p>
<h5 id="清理数据"><a href="#清理数据" class="headerlink" title="清理数据"></a>清理数据</h5><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">sysbench oltp_read_write.lua --time=<span class="number">300</span> --mysql-host=<span class="number">127.0</span>.<span class="number">0.1</span> --mysql-port=<span class="number">3306</span> --mysql-user=root --mysql-password=<span class="type">MyNewPass4!</span> --mysql-db=sbtest --table-size=<span class="number">1000000</span> --tables=<span class="number">10</span> --threads=<span class="number">16</span> --events=<span class="number">999999999</span>  --report-interval=<span class="number">10</span>  cleanup</span><br></pre></td></tr></table></figure>

<ul>
<li><code>cleanup</code> ：执行清理数据。</li>
</ul>
<p>效果如下：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">root@iZuf6hci646px19gg3hpuwZ sysbench</span>]<span class="meta"># sysbench oltp_read_write.lua --time=300 --mysql-host=127.0.0.1 --mysql-port=3306 --mysql-user=root --mysql-password=MyNewPass4! --mysql-db=sbtest --table-size=1000000 --tables=10 --threads=16 --events=999999999 --rate=0 --histogram=on  --report-interval=10  runC^C</span></span><br><span class="line">[<span class="meta">root@iZuf6hci646px19gg3hpuwZ sysbench</span>]<span class="meta"># sysbench oltp_read_write.lua --time=300 --mysql-host=127.0.0.1 --mysql-port=3306 --mysql-user=root --mysql-password=MyNewPass4! --mysql-db=sbtest --table-size=1000000 --tables=10 --threads=16 --events=999999999  --report-interval=10  cleanup</span></span><br><span class="line">sysbench <span class="number">1.0</span><span class="number">.17</span> (<span class="keyword">using</span> system LuaJIT <span class="number">2.0</span><span class="number">.4</span>)</span><br><span class="line"></span><br><span class="line">Dropping table <span class="string">'sbtest1'</span>...</span><br><span class="line">Dropping table <span class="string">'sbtest2'</span>...</span><br><span class="line">Dropping table <span class="string">'sbtest3'</span>...</span><br><span class="line">Dropping table <span class="string">'sbtest4'</span>...</span><br><span class="line">Dropping table <span class="string">'sbtest5'</span>...</span><br><span class="line">Dropping table <span class="string">'sbtest6'</span>...</span><br><span class="line">Dropping table <span class="string">'sbtest7'</span>...</span><br><span class="line">Dropping table <span class="string">'sbtest8'</span>...</span><br><span class="line">Dropping table <span class="string">'sbtest9'</span>...</span><br><span class="line">Dropping table <span class="string">'sbtest10'</span>...</span><br></pre></td></tr></table></figure>

<h5 id="其他参数"><a href="#其他参数" class="headerlink" title="其他参数"></a>其他参数</h5><ul>
<li><code>--warmup_time</code> ：预热时间，预防冷数据对测试结果的影响。</li>
<li>这个参数加下也是有必要的，因为线上的数据，实际是一直在跑的，不会处于冷数据的状态。</li>
<li><code>-rate</code> ：指定数量多少事件(事务)平均每秒钟应该执行的所有线程。0(默认)意味着无限的速率，即事件尽快执行。</li>
<li>不是很理解这个参数，不过确实增加了这个参数，QPS 和 TPS 都有一定的提升。</li>
<li><code>-histogram</code> ：输出测试过程中系统响应时间的分布。</li>
<li>增加该参数，执行结果会多一个柱状图结果。</li>
<li><code>percentile</code> ：在延迟统计数据中计算的百分点 (1-100)，使用特殊值 0 来禁用百分比计算，默认为 95 。</li>
</ul>
<h5 id="mysqlslap"><a href="#mysqlslap" class="headerlink" title="mysqlslap"></a>mysqlslap</h5><blockquote>
<p> mysqlslap 是一个 MySQL 官方提供的压力测试工具。</p>
</blockquote>
<p>比较大的优势，在于 mysqlslap 是 MySQL 官方所提供，并且提供多种引擎的性能测试。</p>
<h5 id="测试过程"><a href="#测试过程" class="headerlink" title="测试过程"></a>测试过程</h5><p>相比 sysbench 来说，mysqlslap 的测试过程还是比较简洁的，一个命令，即可完成整个过程。如下：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">mysqlslap --concurrency=<span class="number">16</span>,<span class="number">32</span> --iterations=<span class="number">3</span> --number-<span class="keyword">int</span>-cols=<span class="number">1</span> --number-<span class="keyword">char</span>-cols=<span class="number">2</span> --<span class="keyword">auto</span>-generate-sql --<span class="keyword">auto</span>-generate-sql-add-autoincrement --engine=innodb --number-of-queries=<span class="number">10000</span> --create-schema=sbtest2 -uroot -pMyNewPass4!</span><br></pre></td></tr></table></figure>

<ul>
<li><code>--concurrency</code> ：并发量，也就是模拟多少个客户端同时执行命令。可指定多个值，以逗号或者 <code>–delimiter</code> 参数指定的值做为分隔符</li>
<li><code>--iterations</code> ：测试执行的迭代次数。</li>
<li><code>--number-int-cols</code> ：自动生成的测试表中包含多少个数字类型的列，默认 1 。此处设置为 1 的原因是，因为我们上面 sysbench 我们生成了一个 int 类型的字段。</li>
<li><code>--number-char-cols</code> ：自动生成的测试表中包含多少个字符类型的列，默认 1 。此处设置为 2 的原因是，因为我们上面 sysbench 我们生成了一个 char 类型的字段。</li>
<li><code>--auto-generate-sql</code> ：自动生成测试表和数据。这个命令，带来的效果，就类似 sysbench 命令的 prepare 指令。</li>
<li><code>--auto-generate-sql-add-autoincrement</code> ：增加 auto_increment 一列。</li>
<li>如果想看，生成的具体脚本，可以用 <code>–only-print</code> 指令，只打印测试语句而不实际执行。</li>
<li><code>--engine</code> ：创建测试表所使用的存储引擎，可指定多个。</li>
<li><code>--number-of-queries</code> ：总的测试查询次数(并发客户数×每客户查询次数)。</li>
<li><code>--create-schema</code> ：测试的 schema ，MySQL中 schema 也就是 database 数据库名。</li>
<li><code>-uroot -pMyNewPass4!</code> ：设置 MySQL 账号和密码。</li>
</ul>
<p>执行命令后，效果如下图：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@iZuf6hci646px19gg3hpuwZ sysbench]# mysqlslap --concurrency=16,32 --iterations=3 --number-int-cols=1 --number-char-cols=2 --auto-generate-sql --auto-generate-sql-add-autoincrement --engine=innodb --number-of-queries=10000 --create-schema=sbtest2 -uroot -pMyNewPass4!</span><br><span class="line">mysqlslap: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Benchmark</span><br><span class="line">    Running for engine innodb</span><br><span class="line">    Average number of seconds to run all queries: 0.489 seconds</span><br><span class="line">    Minimum number of seconds to run all queries: 0.486 seconds</span><br><span class="line">    Maximum number of seconds to run all queries: 0.496 seconds</span><br><span class="line">    Number of clients running queries: 16</span><br><span class="line">    Average number of queries per client: 625</span><br><span class="line"></span><br><span class="line">Benchmark</span><br><span class="line">    Running for engine innodb</span><br><span class="line">    Average number of seconds to run all queries: 0.379 seconds</span><br><span class="line">    Minimum number of seconds to run all queries: 0.377 seconds</span><br><span class="line">    Maximum number of seconds to run all queries: 0.382 seconds</span><br><span class="line">    Number of clients running queries: 32</span><br><span class="line">    Average number of queries per client: 312</span><br></pre></td></tr></table></figure>

<ul>
<li>第一个，使用 16 个线程（客户端），平均延迟在 0.489 秒。</li>
<li>第二个，使用 32 个线程（客户端），平均延迟在 0.379 秒。</li>
</ul>
<p>参考文档<br><a href="https://www.jianshu.com/p/d464e51aa026" target="_blank" rel="noopener">https://www.jianshu.com/p/d464e51aa026</a></p>

        </div>

        
            <section class="post-copyright">
                
                
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tag/database/"># database</a>
                    
                        <a href="/tag/mysql/"># mysql</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">Back</a>
                <span>· </span>
                <a href="/">Home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2020/04/14/Nexus/">nexus</a>
            
            
            <a class="next" rel="next" href="/2020/04/08/Tomcat实现redis共享/">redis</a>
            
        </section>

        <script src="https://giscus.app/client.js" data-repo="nmk0718/nmk0718.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkyMTE0NDU3NDY=" data-category="Announcements" data-category-id="DIC_kwDODJpn8s4Clzt8" data-mapping="title" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="noborder_light" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async>
</script>
<script src="/js/clipboard.min.js"></script>
<script>
    // 更新 giscus 主题
    function updateGiscusTheme() {
        // 添加短暂延时，确保在主题切换后执行
        setTimeout(() => {
            const isDark = document.body.classList.contains('dark-theme');
            const theme = isDark ? 'noborder_dark' : 'noborder_light';
            const iframe = document.querySelector('.giscus-frame');
            
            if (iframe) {
                iframe.contentWindow.postMessage(
                    { giscus: { setConfig: { theme: theme } } },
                    'https://giscus.app'
                );
            }
        }, 100);  // 100ms 延时
    }

    // 监听主题变化
    const toggleBtn = document.getElementsByClassName('toggleBtn')[0];
    if (toggleBtn) {
        toggleBtn.addEventListener('click', updateGiscusTheme);
    }

    // 移动端主题切换监听
    const mobileToggle = document.getElementById('mobile-toggle-theme');
    if (mobileToggle) {
        mobileToggle.addEventListener('click', updateGiscusTheme);
    }

    // 初始化主题
    document.addEventListener('DOMContentLoaded', updateGiscusTheme);

    document.addEventListener('DOMContentLoaded', function () {
        var codeBlocks = document.querySelectorAll('article .code pre');

        codeBlocks.forEach(function (codeBlock) {
            var copyButton = document.createElement('button');
            copyButton.className = 'copy-button';

            // Check if the code block is in the article content
            if (codeBlock.closest('article')) {
                codeBlock.parentNode.parentNode.style.position = 'relative'; // Update this line to select parent of span (pre)
                codeBlock.parentNode.parentNode.appendChild(copyButton); // Update this line to select parent of span (pre) 

                var isCopying = false;

                copyButton.addEventListener('click', function () {
                    if (!isCopying) {
                        var codeText = codeBlock.innerText;
                        navigator.clipboard.writeText(codeText).then(function () {
                            isCopying = true;
                            setTimeout(function () {
                                isCopying = false;
                            }, 1500);
                        }).catch(function (err) {
                            console.error('Copy failed', err);
                        });
                    }
                });
            }
        });
    });
</script>
    </article>
</div>


        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© kk | Powered by <a href="https://hexo.io" target="_blank">Hexo</a></span>
    </div>
</footer>

    </div>

        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z\d\-\.\+]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(t.test(e.href)||r.test(e.href))&&(e.href=a.dataset.original)})});</script><script>(r=>{r.imageLazyLoadSetting.processImages=t;var a=r.imageLazyLoadSetting.isSPA,o=r.imageLazyLoadSetting.preloadRatio||1,d=i();function i(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(t){(a||t)&&(d=i());for(var e,n=0;n<d.length;n++)0<=(e=(e=d[n]).getBoundingClientRect()).bottom&&0<=e.left&&e.top<=(r.innerHeight*o||document.documentElement.clientHeight*o)&&(()=>{var t,e,a,o,i=d[n];e=function(){d=d.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).dataset.loaded||(t.hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(a=new Image,o=t.getAttribute("data-original"),a.onload=function(){t.src=o,t.removeAttribute("data-original"),t.setAttribute("data-loaded",!0),e&&e()},a.onerror=function(){t.removeAttribute("data-original"),t.setAttribute("data-loaded",!1),t.src=o},t.src!==o&&(a.src=o)))})()}function e(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",e),r.addEventListener("resize",e),r.addEventListener("orientationchange",e)})(this);</script></body>
</html>
